@using LrmCloud.Web.Models
@using LrmCloud.Web.Services
@using LrmCloud.Shared.DTOs.TranslationMemory
@inject TranslationMemoryService TmService
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService
@inject IJSRuntime JS

<RadzenStack Gap="1rem">
    @* Key Type Toggle *@
    @if (SupportsPluralKeys)
    {
        <RadzenCard>
            <RadzenStack Gap="0.5rem">
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                    <RadzenText TextStyle="TextStyle.Body2">Key Type</RadzenText>
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.25rem">
                        <RadzenButton Text="Single" Size="ButtonSize.Small"
                                      ButtonStyle="@(!_displayIsPlural ? ButtonStyle.Primary : ButtonStyle.Light)"
                                      Variant="@(!_displayIsPlural ? Radzen.Variant.Filled : Radzen.Variant.Outlined)"
                                      Click="@(() => OnKeyTypeToggled(false))" />
                        <RadzenButton Text="Plural" Size="ButtonSize.Small"
                                      ButtonStyle="@(_displayIsPlural ? ButtonStyle.Primary : ButtonStyle.Light)"
                                      Variant="@(_displayIsPlural ? Radzen.Variant.Filled : Radzen.Variant.Outlined)"
                                      Click="@(() => OnKeyTypeToggled(true))" />
                    </RadzenStack>
                </RadzenStack>

                @if (_showConversionConfirm)
                {
                    <RadzenAlert AlertStyle="@(_pendingIsPlural ? AlertStyle.Info : AlertStyle.Warning)" Shade="Shade.Lighter" AllowClose="false" Size="AlertSize.Small">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                            <RadzenText TextStyle="TextStyle.Body2">
                                @if (_pendingIsPlural)
                                {
                                    <span>Convert to plural? Current value becomes "other" form.</span>
                                }
                                else
                                {
                                    <span>Convert to single? Only "other" form will be kept.</span>
                                }
                            </RadzenText>
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.25rem">
                                <RadzenButton Size="ButtonSize.Small" Variant="Radzen.Variant.Text" Text="Cancel" Click="CancelConversion" />
                                <RadzenButton Size="ButtonSize.Small" ButtonStyle="@(_pendingIsPlural ? ButtonStyle.Primary : ButtonStyle.Warning)"
                                              Text="Convert" Click="ConfirmConversion" />
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenAlert>
                }
            </RadzenStack>
        </RadzenCard>
    }

    @* Comment Field *@
    <RadzenFormField Text="Comment (for translators)" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
        <ChildContent>
            <RadzenTextArea Value="@Row.Comment" Change="@OnCommentChanged" Rows="2"
                            Placeholder="Description to help translators" Style="width: 100%;" MaxLength="1000" />
        </ChildContent>
        <Helper>
            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">@($"{Row.Comment?.Length ?? 0}/1000 characters")</RadzenText>
        </Helper>
    </RadzenFormField>

    @* Translations Section Header *@
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
        <RadzenText TextStyle="TextStyle.H6">Translations</RadzenText>
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
            @if (Row.IsPlural)
            {
                var availableForms = GetAvailablePluralForms().ToList();
                @if (availableForms.Any())
                {
                    <RadzenDropDown @bind-Value="_selectedPluralForm" Placeholder="+ Add Form" Style="width: 120px;"
                                    Data="@availableForms" Change="@OnPluralFormSelected" />
                }
            }
            <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small"
                          Icon="memory" Text="Check TM" Click="CheckTmForAllLanguages" Disabled="@(!HasAnySourceText())" />
            <RadzenButton ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small"
                          Icon="translate" Text="Translate" Click="HandleTranslate"
                          Disabled="@(!HasAnySourceText() || _isTranslating)" IsBusy="@_isTranslating" />
        </RadzenStack>
    </RadzenStack>

    @* Translations DataGrid *@
    <RadzenDataGrid @ref="_grid" TItem="EditableTranslationRow"
                    Data="@_editableRows"
                    Density="Density.Compact"
                    AllowSorting="false"
                    AllowPaging="false"
                    Style="max-height: 400px; overflow-y: auto;">
        <Columns>
            @* Language Column *@
            <RadzenDataGridColumn TItem="EditableTranslationRow" Title="Lang" Width="70px" Frozen="true">
                <Template Context="row">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.25rem" AlignItems="Radzen.AlignItems.Center">
                        <RadzenText TextStyle="TextStyle.Body2" Style="font-weight: 600;">@row.LanguageCode.ToUpperInvariant()</RadzenText>
                        @if (row.IsDefault)
                        {
                            <RadzenIcon Icon="star" Style="font-size: 0.9rem; color: var(--rz-warning);" />
                        }
                    </RadzenStack>
                </Template>
            </RadzenDataGridColumn>

            @* Plural Form Column (only for plural keys) *@
            @if (Row.IsPlural)
            {
                <RadzenDataGridColumn TItem="EditableTranslationRow" Title="Form" Width="75px">
                    <Template Context="row">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0">
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">@row.PluralForm</RadzenText>
                            @if (row.PluralForm != PluralForms.Other && row.IsDefault)
                            {
                                <RadzenButton Icon="close" Variant="Radzen.Variant.Text" Size="ButtonSize.Small"
                                              ButtonStyle="ButtonStyle.Danger" Click="@(() => RemovePluralForm(row.PluralForm!))" />
                            }
                        </RadzenStack>
                    </Template>
                </RadzenDataGridColumn>
            }

            @* Value Column *@
            <RadzenDataGridColumn TItem="EditableTranslationRow" Title="Value">
                <Template Context="row">
                    <RadzenStack Gap="0.25rem" Style="@(row.IsDirty ? "background-color: var(--rz-warning-lighter); padding: 4px; border-radius: 4px;" : "")">
                        @if (row.TmSuggestion != null)
                        {
                            <RadzenCard Style="background-color: var(--rz-success-lighter); padding: 0.5rem;">
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Start" Gap="0.5rem">
                                    <RadzenText TextStyle="TextStyle.Caption" Style="font-style: italic; word-break: break-word;">
                                        "@row.TmSuggestion.TranslatedText"
                                    </RadzenText>
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0" Style="flex-shrink: 0;">
                                        <RadzenButton Icon="check" Variant="Radzen.Variant.Text" Size="ButtonSize.Small"
                                                      ButtonStyle="ButtonStyle.Success" Click="@(() => ApplyTmSuggestion(row))" />
                                        <RadzenButton Icon="close" Variant="Radzen.Variant.Text" Size="ButtonSize.Small"
                                                      Click="@(() => DismissTmSuggestion(row))" />
                                    </RadzenStack>
                                </RadzenStack>
                            </RadzenCard>
                        }
                        <RadzenTextArea @bind-Value="row.Value" Rows="2"
                                        Placeholder="@GetPlaceholder(row)" Style="width: 100%;"
                                        Change="@(() => OnRowValueChanged(row))" />
                    </RadzenStack>
                </Template>
            </RadzenDataGridColumn>

            @* TM Column *@
            <RadzenDataGridColumn TItem="EditableTranslationRow" Title="TM" Width="50px" TextAlign="TextAlign.Center">
                <Template Context="row">
                    @if (!row.IsDefault)
                    {
                        @if (row.TmSuggestion != null)
                        {
                            <RadzenIcon Icon="memory" Style="font-size: 1rem; color: var(--rz-success);" />
                        }
                        else
                        {
                            <RadzenButton Icon="memory" Variant="Radzen.Variant.Text" Size="ButtonSize.Small"
                                          Click="@(() => CheckTmForRow(row))" Disabled="@(!HasSourceTextForRow(row))" />
                        }
                    }
                </Template>
            </RadzenDataGridColumn>

            @* Status Column *@
            <RadzenDataGridColumn TItem="EditableTranslationRow" Width="50px" TextAlign="TextAlign.Center">
                <Template Context="row">
                    @if (row.IsDefault)
                    {
                        <RadzenIcon Icon="edit" Style="font-size: 1rem; color: var(--rz-text-secondary-color);" />
                    }
                    else if (!string.IsNullOrEmpty(row.Value))
                    {
                        <RadzenIcon Icon="check_circle" Style="font-size: 1rem; color: var(--rz-success);" />
                    }
                    else
                    {
                        <RadzenIcon Icon="error" Style="font-size: 1rem; color: var(--rz-danger);" />
                    }
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>

    @if (HasChanges)
    {
        <RadzenAlert AlertStyle="AlertStyle.Warning" Shade="Shade.Lighter" AllowClose="false" Size="AlertSize.Small">
            You have unsaved changes
        </RadzenAlert>
    }

    @* Dialog Actions *@
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem">
        <RadzenButton Variant="Radzen.Variant.Text" Text="Cancel" Click="Cancel" Disabled="@_isSaving" />
        <RadzenButton ButtonStyle="ButtonStyle.Primary" Text="Save Changes"
                      Click="Save" Disabled="@(!HasChanges || _isSaving)" IsBusy="@_isSaving" />
    </RadzenStack>
</RadzenStack>

@code {
    [Parameter]
    public required TranslationGridRow Row { get; set; }

    [Parameter]
    public List<string> Languages { get; set; } = new();

    [Parameter]
    public string DefaultLanguage { get; set; } = "en";

    [Parameter]
    public string ProjectFormat { get; set; } = "json";

    [Parameter]
    public bool SupportsPluralKeys { get; set; } = true;

    [Parameter]
    public EventCallback<TranslationGridRow> OnTranslate { get; set; }

    private RadzenDataGrid<EditableTranslationRow>? _grid;
    private List<EditableTranslationRow> _editableRows = new();
    private bool _isSaving;
    private bool _isTranslating;
    private bool _showConversionConfirm;
    private bool _pendingIsPlural;
    private bool _displayIsPlural;
    private string? _selectedPluralForm;
    private HashSet<string> _activePluralForms = new();

    protected override void OnParametersSet()
    {
        _displayIsPlural = Row.IsPlural;
        RefreshActivePluralForms();
        BuildEditableRows();
    }

    private bool HasChanges => _editableRows.Any(r => r.IsDirty) || Row.IsKeyMetadataDirty;

    #region Editable Row Model

    private class EditableTranslationRow
    {
        public string LanguageCode { get; set; } = "";
        public string? PluralForm { get; set; }
        public string? Value { get; set; }
        public string? OriginalValue { get; set; }
        public bool IsDefault { get; set; }
        public bool IsDirty => Value != OriginalValue;
        public TmMatchDto? TmSuggestion { get; set; }
        public TranslationCell? SourceCell { get; set; }
    }

    private void BuildEditableRows()
    {
        _editableRows.Clear();

        foreach (var lang in Languages)
        {
            var isDefault = lang == DefaultLanguage;

            if (Row.IsPlural)
            {
                foreach (var pluralForm in GetActivePluralForms())
                {
                    var key = TranslationGridRow.GetKey(lang, pluralForm);
                    var cell = Row.Translations.GetValueOrDefault(key);

                    _editableRows.Add(new EditableTranslationRow
                    {
                        LanguageCode = lang,
                        PluralForm = pluralForm,
                        Value = cell?.Value,
                        OriginalValue = cell?.OriginalValue,
                        IsDefault = isDefault,
                        SourceCell = cell
                    });
                }
            }
            else
            {
                var cell = Row.Translations.GetValueOrDefault(lang);

                _editableRows.Add(new EditableTranslationRow
                {
                    LanguageCode = lang,
                    PluralForm = null,
                    Value = cell?.Value,
                    OriginalValue = cell?.OriginalValue,
                    IsDefault = isDefault,
                    SourceCell = cell
                });
            }
        }
    }

    private void SyncRowsBackToTranslations()
    {
        foreach (var editRow in _editableRows)
        {
            if (editRow.SourceCell != null)
            {
                editRow.SourceCell.Value = editRow.Value;
                editRow.SourceCell.IsDirty = editRow.IsDirty;
            }
        }
    }

    private void OnRowValueChanged(EditableTranslationRow row)
    {
        if (row.SourceCell != null)
        {
            row.SourceCell.Value = row.Value;
            row.SourceCell.IsDirty = row.IsDirty;
        }
        StateHasChanged();
    }

    private string GetPlaceholder(EditableTranslationRow row)
    {
        if (row.IsDefault)
        {
            if (Row.IsPlural && row.PluralForm != null)
                return GetPluralPlaceholder(row.PluralForm, true);
            return "Enter source text";
        }

        if (Row.IsPlural && row.PluralForm != null)
            return GetPluralPlaceholder(row.PluralForm, false);
        return "Enter translation";
    }

    #endregion

    #region Plural Form Management

    private void RefreshActivePluralForms()
    {
        _activePluralForms = GetExistingPluralForms();
        if (Row.IsPlural && !_activePluralForms.Contains(PluralForms.Other))
            _activePluralForms.Add(PluralForms.Other);
        if (Row.IsPlural && _activePluralForms.Count == 1)
            _activePluralForms.Add(PluralForms.One);
    }

    private HashSet<string> GetExistingPluralForms()
    {
        if (!Row.IsPlural) return new HashSet<string>();
        return Row.Translations.Values
            .Where(t => !string.IsNullOrEmpty(t.PluralForm))
            .Select(t => t.PluralForm)
            .ToHashSet();
    }

    private IEnumerable<string> GetActivePluralForms() =>
        PluralForms.All.Where(pf => _activePluralForms.Contains(pf));

    private IEnumerable<string> GetAvailablePluralForms() =>
        PluralForms.All.Where(pf => !_activePluralForms.Contains(pf));

    private void OnPluralFormSelected(object value)
    {
        if (value is string form && !string.IsNullOrEmpty(form))
        {
            AddPluralForm(form);
            _selectedPluralForm = null;
        }
    }

    private void AddPluralForm(string pluralForm)
    {
        _activePluralForms.Add(pluralForm);
        foreach (var lang in Languages)
        {
            var key = TranslationGridRow.GetKey(lang, pluralForm);
            if (!Row.Translations.ContainsKey(key))
            {
                Row.Translations[key] = new TranslationCell
                {
                    LanguageCode = lang,
                    PluralForm = pluralForm,
                    Value = null,
                    OriginalValue = null,
                    IsDirty = true
                };
            }
        }
        BuildEditableRows();
        NotificationService.Notify(NotificationSeverity.Info, "Added", $"Added '{pluralForm}' plural form");
    }

    private void RemovePluralForm(string pluralForm)
    {
        if (pluralForm == PluralForms.Other)
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Warning", "Cannot remove 'other' form - it's required");
            return;
        }

        _activePluralForms.Remove(pluralForm);
        foreach (var lang in Languages)
        {
            var key = TranslationGridRow.GetKey(lang, pluralForm);
            if (Row.Translations.TryGetValue(key, out var cell))
            {
                cell.Value = null;
                cell.IsDirty = true;
            }
        }
        BuildEditableRows();
        NotificationService.Notify(NotificationSeverity.Info, "Removed", $"Removed '{pluralForm}' plural form");
    }

    private static string GetPluralPlaceholder(string pluralForm, bool isDefault) => pluralForm switch
    {
        "one" => isDefault ? "Singular (1 item)" : "Translate singular",
        "other" => isDefault ? "Plural (2+ items)" : "Translate plural",
        "zero" => isDefault ? "Zero (0 items)" : "Translate zero",
        "two" => isDefault ? "Dual (exactly 2)" : "Translate dual",
        "few" => isDefault ? "Few (2-4 items)" : "Translate few",
        "many" => isDefault ? "Many (5+ items)" : "Translate many",
        _ => isDefault ? $"Enter {pluralForm}" : $"Translate {pluralForm}"
    };

    #endregion

    #region Type Conversion

    private void OnKeyTypeToggled(bool isPlural)
    {
        if (isPlural == Row.IsPlural)
        {
            _showConversionConfirm = false;
            _displayIsPlural = Row.IsPlural;
            return;
        }

        _pendingIsPlural = isPlural;
        _displayIsPlural = isPlural;
        _showConversionConfirm = true;
    }

    private void CancelConversion()
    {
        _showConversionConfirm = false;
        _displayIsPlural = Row.IsPlural;
    }

    private void ConfirmConversion()
    {
        _showConversionConfirm = false;

        if (_pendingIsPlural)
        {
            var keysToMove = Row.Translations.Keys.ToList();
            foreach (var oldKey in keysToMove)
            {
                var cell = Row.Translations[oldKey];
                if (string.IsNullOrEmpty(cell.PluralForm))
                {
                    var newKey = TranslationGridRow.GetKey(cell.LanguageCode, PluralForms.Other);
                    Row.Translations.Remove(oldKey);
                    cell.PluralForm = PluralForms.Other;
                    cell.IsDirty = true;
                    Row.Translations[newKey] = cell;
                }
            }

            _activePluralForms = new HashSet<string> { PluralForms.One, PluralForms.Other };

            foreach (var lang in Languages)
            {
                var oneKey = TranslationGridRow.GetKey(lang, PluralForms.One);
                if (!Row.Translations.ContainsKey(oneKey))
                {
                    Row.Translations[oneKey] = new TranslationCell
                    {
                        LanguageCode = lang,
                        PluralForm = PluralForms.One,
                        Value = null,
                        OriginalValue = null,
                        IsDirty = true
                    };
                }

                var otherKey = TranslationGridRow.GetKey(lang, PluralForms.Other);
                if (!Row.Translations.ContainsKey(otherKey))
                {
                    Row.Translations[otherKey] = new TranslationCell
                    {
                        LanguageCode = lang,
                        PluralForm = PluralForms.Other,
                        Value = null,
                        OriginalValue = null,
                        IsDirty = true
                    };
                }
            }
        }
        else
        {
            var keysToProcess = Row.Translations.Keys.ToList();
            foreach (var oldKey in keysToProcess)
            {
                var cell = Row.Translations[oldKey];
                if (cell.PluralForm == PluralForms.Other)
                {
                    Row.Translations.Remove(oldKey);
                    cell.PluralForm = "";
                    cell.IsDirty = true;
                    Row.Translations[cell.LanguageCode] = cell;
                }
                else if (!string.IsNullOrEmpty(cell.PluralForm))
                {
                    Row.Translations.Remove(oldKey);
                }
            }
            _activePluralForms.Clear();
        }

        Row.IsPlural = _pendingIsPlural;
        BuildEditableRows();
        NotificationService.Notify(NotificationSeverity.Success, "Converted", $"Converted to {(_pendingIsPlural ? "plural" : "single")} key");
    }

    #endregion

    #region Value Changes

    private void OnCommentChanged(string? value)
    {
        Row.Comment = value;
    }

    #endregion

    #region TM Integration

    private string? GetSourceText(string? pluralForm = null)
    {
        if (Row.IsPlural)
        {
            var pf = !string.IsNullOrEmpty(pluralForm) ? pluralForm : PluralForms.Other;
            var key = TranslationGridRow.GetKey(DefaultLanguage, pf);
            return Row.Translations.GetValueOrDefault(key)?.Value;
        }
        return Row.Translations.GetValueOrDefault(DefaultLanguage)?.Value;
    }

    private bool HasAnySourceText()
    {
        if (Row.IsPlural)
        {
            return GetActivePluralForms().Any(pf =>
            {
                var key = TranslationGridRow.GetKey(DefaultLanguage, pf);
                var cell = Row.Translations.GetValueOrDefault(key);
                return !string.IsNullOrEmpty(cell?.Value);
            });
        }
        return !string.IsNullOrEmpty(Row.Translations.GetValueOrDefault(DefaultLanguage)?.Value);
    }

    private bool HasSourceTextForRow(EditableTranslationRow row)
    {
        return !string.IsNullOrEmpty(GetSourceText(row.PluralForm));
    }

    private async Task CheckTmForRow(EditableTranslationRow row)
    {
        var sourceText = GetSourceText(row.PluralForm);
        if (string.IsNullOrEmpty(sourceText)) return;

        var request = new TmLookupRequest
        {
            SourceText = sourceText,
            SourceLanguage = DefaultLanguage,
            TargetLanguage = row.LanguageCode,
            MinMatchPercent = 70,
            MaxResults = 1
        };

        var result = await TmService.LookupAsync(request);

        if (result.IsSuccess && result.Data?.Matches.Any() == true)
        {
            row.TmSuggestion = result.Data.Matches.First();
        }

        StateHasChanged();
    }

    private async Task CheckTmForAllLanguages()
    {
        var foundCount = 0;

        foreach (var row in _editableRows.Where(r => !r.IsDefault))
        {
            var sourceText = GetSourceText(row.PluralForm);
            if (string.IsNullOrEmpty(sourceText)) continue;

            var request = new TmLookupRequest
            {
                SourceText = sourceText,
                SourceLanguage = DefaultLanguage,
                TargetLanguage = row.LanguageCode,
                MinMatchPercent = 70,
                MaxResults = 1
            };

            var result = await TmService.LookupAsync(request);
            if (result.IsSuccess && result.Data?.Matches.Any() == true)
            {
                row.TmSuggestion = result.Data.Matches.First();
                foundCount++;
            }
        }

        if (foundCount > 0)
            NotificationService.Notify(NotificationSeverity.Success, "TM", $"Found {foundCount} TM match(es)");
        else
            NotificationService.Notify(NotificationSeverity.Info, "TM", "No TM matches found");

        StateHasChanged();
    }

    private void ApplyTmSuggestion(EditableTranslationRow row)
    {
        if (row.TmSuggestion != null)
        {
            row.Value = row.TmSuggestion.TranslatedText;
            OnRowValueChanged(row);
            _ = TmService.IncrementUseCountAsync(row.TmSuggestion.Id);
            NotificationService.Notify(NotificationSeverity.Success, "Applied", "TM suggestion applied");
            row.TmSuggestion = null;
        }
        StateHasChanged();
    }

    private void DismissTmSuggestion(EditableTranslationRow row)
    {
        row.TmSuggestion = null;
        StateHasChanged();
    }

    #endregion

    #region Actions

    private async Task HandleTranslate()
    {
        if (!OnTranslate.HasDelegate) return;

        _isTranslating = true;
        StateHasChanged();

        try
        {
            SyncRowsBackToTranslations();
            await OnTranslate.InvokeAsync(Row);
            BuildEditableRows(); // Refresh after translation
        }
        finally
        {
            _isTranslating = false;
            StateHasChanged();
        }
    }

    private void Cancel()
    {
        DialogService.Close(null);
    }

    private void Save()
    {
        _isSaving = true;
        SyncRowsBackToTranslations();
        DialogService.Close(Row);
    }

    #endregion
}
