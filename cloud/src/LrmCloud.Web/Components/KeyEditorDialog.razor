@using LrmCloud.Web.Models
@using LrmCloud.Web.Services
@using LrmCloud.Shared.DTOs.TranslationMemory
@inject TranslationMemoryService TmService
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService
@inject IJSRuntime JS

<RadzenStack Gap="1rem">
    @* Key Type Toggle *@
    @if (SupportsPluralKeys)
    {
        <RadzenCard>
            <RadzenStack Gap="0.5rem">
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                    <RadzenText TextStyle="TextStyle.Body2">Key Type</RadzenText>
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.25rem">
                        <RadzenButton Text="Single" Size="ButtonSize.Small"
                                      ButtonStyle="@(!_displayIsPlural ? ButtonStyle.Primary : ButtonStyle.Light)"
                                      Variant="@(!_displayIsPlural ? Radzen.Variant.Filled : Radzen.Variant.Outlined)"
                                      Click="@(() => OnKeyTypeToggled(false))" />
                        <RadzenButton Text="Plural" Size="ButtonSize.Small"
                                      ButtonStyle="@(_displayIsPlural ? ButtonStyle.Primary : ButtonStyle.Light)"
                                      Variant="@(_displayIsPlural ? Radzen.Variant.Filled : Radzen.Variant.Outlined)"
                                      Click="@(() => OnKeyTypeToggled(true))" />
                    </RadzenStack>
                </RadzenStack>

                @if (_showConversionConfirm)
                {
                    <RadzenAlert AlertStyle="@(_pendingIsPlural ? AlertStyle.Info : AlertStyle.Warning)" Shade="Shade.Lighter" AllowClose="false" Size="AlertSize.Small">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                            <RadzenText TextStyle="TextStyle.Body2">
                                @if (_pendingIsPlural)
                                {
                                    <span>Convert to plural? Current value becomes "other" form.</span>
                                }
                                else
                                {
                                    <span>Convert to single? Only "other" form will be kept.</span>
                                }
                            </RadzenText>
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.25rem">
                                <RadzenButton Size="ButtonSize.Small" Variant="Radzen.Variant.Text" Text="Cancel" Click="CancelConversion" />
                                <RadzenButton Size="ButtonSize.Small" ButtonStyle="@(_pendingIsPlural ? ButtonStyle.Primary : ButtonStyle.Warning)"
                                              Text="Convert" Click="ConfirmConversion" />
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenAlert>
                }
            </RadzenStack>
        </RadzenCard>
    }

    @* Comment Field *@
    <RadzenFormField Text="Comment (for translators)" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
        <ChildContent>
            <RadzenTextArea Value="@Row.Comment" Change="@OnCommentChanged" Rows="2"
                            Placeholder="Description to help translators" Style="width: 100%;" MaxLength="1000" />
        </ChildContent>
        <Helper>
            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">@($"{Row.Comment?.Length ?? 0}/1000 characters")</RadzenText>
        </Helper>
    </RadzenFormField>

    @* Translations Section *@
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
        <RadzenText TextStyle="TextStyle.H6">Translations</RadzenText>
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
            @if (Row.IsPlural)
            {
                var availableForms = GetAvailablePluralForms().ToList();
                @if (availableForms.Any())
                {
                    <RadzenDropDown @bind-Value="_selectedPluralForm" Placeholder="+ Add Form" Style="width: 120px;"
                                    Data="@availableForms" Change="@OnPluralFormSelected" />
                }
            }
            <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small"
                          Icon="memory" Text="Check TM" Click="CheckTmForAllLanguages" Disabled="@(!HasAnySourceText())" />
            <RadzenButton ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small"
                          Icon="translate" Text="Translate" Click="HandleTranslate"
                          Disabled="@(!HasAnySourceText() || _isTranslating)" IsBusy="@_isTranslating" />
        </RadzenStack>
    </RadzenStack>

    @* Translations Table *@
    <RadzenCard Style="padding: 0; overflow-x: auto;">
        <table class="rz-data-grid" style="width: 100%; table-layout: fixed;">
            <thead>
                <tr>
                    <th style="width: 70px;">Lang</th>
                    @if (Row.IsPlural)
                    {
                        @foreach (var form in GetActivePluralForms())
                        {
                            <th style="width: auto;">
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0">
                                    <span>@form</span>
                                    @if (form != PluralForms.Other)
                                    {
                                        <RadzenButton Icon="close" Variant="Radzen.Variant.Text" Size="ButtonSize.Small"
                                                      ButtonStyle="ButtonStyle.Danger" Click="@(() => RemovePluralForm(form))" />
                                    }
                                </RadzenStack>
                            </th>
                        }
                    }
                    else
                    {
                        <th style="width: auto;">Value</th>
                    }
                    <th style="width: 50px; text-align: center;">TM</th>
                    <th style="width: 50px; text-align: center;">Status</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var lang in Languages)
                {
                    var isDefault = lang == DefaultLanguage;
                    var langStatus = GetLanguageStatus(lang);

                    <tr>
                        <td>
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.25rem" AlignItems="Radzen.AlignItems.Center">
                                <RadzenText TextStyle="TextStyle.Body2" Style="font-weight: 500;">@lang.ToUpperInvariant()</RadzenText>
                                @if (isDefault)
                                {
                                    <RadzenIcon Icon="star" Style="font-size: 1rem; color: var(--rz-warning);" />
                                }
                            </RadzenStack>
                        </td>

                        @if (Row.IsPlural)
                        {
                            @foreach (var pluralForm in GetActivePluralForms())
                            {
                                var pf = pluralForm;
                                var key = TranslationGridRow.GetKey(lang, pf);
                                var cell = Row.Translations.GetValueOrDefault(key);
                                var isDirty = cell?.IsDirty ?? false;
                                var tmMatch = _tmSuggestions.GetValueOrDefault(key);

                                <td style="@(isDirty ? "background-color: rgba(255, 193, 7, 0.1);" : "")">
                                    <RadzenStack Gap="0.25rem">
                                        @if (tmMatch != null)
                                        {
                                            <RadzenCard Style="background-color: rgba(76, 175, 80, 0.1); padding: 0.5rem;">
                                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Start">
                                                    <RadzenText TextStyle="TextStyle.Caption" Style="font-style: italic; max-width: 150px; overflow: hidden; text-overflow: ellipsis;">
                                                        "@tmMatch.TranslatedText"
                                                    </RadzenText>
                                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0">
                                                        <RadzenButton Icon="check" Variant="Radzen.Variant.Text" Size="ButtonSize.Small"
                                                                      ButtonStyle="ButtonStyle.Success" Click="@(() => ApplyTmSuggestion(key, tmMatch))" />
                                                        <RadzenButton Icon="close" Variant="Radzen.Variant.Text" Size="ButtonSize.Small"
                                                                      Click="@(() => DismissTmSuggestion(key))" />
                                                    </RadzenStack>
                                                </RadzenStack>
                                            </RadzenCard>
                                        }
                                        @if (cell != null)
                                        {
                                            <RadzenTextArea Value="@cell.Value" Change="@(args => OnValueChanged(cell, args))"
                                                            Rows="2" Placeholder="@GetPluralPlaceholder(pf, isDefault)" Style="width: 100%;" />
                                        }
                                    </RadzenStack>
                                </td>
                            }
                        }
                        else
                        {
                            var cell = Row.Translations.GetValueOrDefault(lang);
                            var isDirty = cell?.IsDirty ?? false;
                            var tmMatch = _tmSuggestions.GetValueOrDefault(lang);

                            <td style="@(isDirty ? "background-color: rgba(255, 193, 7, 0.1);" : "")">
                                <RadzenStack Gap="0.25rem">
                                    @if (tmMatch != null)
                                    {
                                        <RadzenCard Style="background-color: rgba(76, 175, 80, 0.1); padding: 0.5rem;">
                                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Start">
                                                <RadzenText TextStyle="TextStyle.Caption" Style="font-style: italic; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                                                    "@tmMatch.TranslatedText"
                                                </RadzenText>
                                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0">
                                                    <RadzenButton Icon="check" Variant="Radzen.Variant.Text" Size="ButtonSize.Small"
                                                                  ButtonStyle="ButtonStyle.Success" Click="@(() => ApplyTmSuggestion(lang, tmMatch))" />
                                                    <RadzenButton Icon="close" Variant="Radzen.Variant.Text" Size="ButtonSize.Small"
                                                                  Click="@(() => DismissTmSuggestion(lang))" />
                                                </RadzenStack>
                                            </RadzenStack>
                                        </RadzenCard>
                                    }
                                    @if (cell != null)
                                    {
                                        <RadzenTextArea Value="@cell.Value" Change="@(args => OnValueChanged(cell, args))"
                                                        Rows="2" Placeholder="@(isDefault ? "Enter source text" : "Enter translation")" Style="width: 100%;" />
                                    }
                                </RadzenStack>
                            </td>
                        }

                        <td style="text-align: center;">
                            @if (!isDefault)
                            {
                                var hasTm = HasTmForLanguage(lang);
                                @if (hasTm)
                                {
                                    <RadzenIcon Icon="memory" Style="font-size: 1rem; color: var(--rz-success);" />
                                }
                                else
                                {
                                    <RadzenButton Icon="memory" Variant="Radzen.Variant.Text" Size="ButtonSize.Small"
                                                  Click="@(() => CheckTmForLanguage(lang))" Disabled="@(!HasAnySourceText())" />
                                }
                            }
                        </td>

                        <td style="text-align: center;">
                            @switch (langStatus)
                            {
                                case TranslationStatus.Complete:
                                    <RadzenIcon Icon="check_circle" Style="font-size: 1rem; color: var(--rz-success);" />
                                    break;
                                case TranslationStatus.Partial:
                                    <RadzenIcon Icon="warning" Style="font-size: 1rem; color: var(--rz-warning);" />
                                    break;
                                case TranslationStatus.Missing:
                                    <RadzenIcon Icon="error" Style="font-size: 1rem; color: var(--rz-danger);" />
                                    break;
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </RadzenCard>

    @if (HasChanges)
    {
        <RadzenAlert AlertStyle="AlertStyle.Warning" Shade="Shade.Lighter" AllowClose="false" Size="AlertSize.Small">
            You have unsaved changes
        </RadzenAlert>
    }

    @* Dialog Actions *@
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem">
        <RadzenButton Variant="Radzen.Variant.Text" Text="Cancel" Click="Cancel" Disabled="@_isSaving" />
        <RadzenButton ButtonStyle="ButtonStyle.Primary" Text="Save Changes"
                      Click="Save" Disabled="@(!HasChanges || _isSaving)" IsBusy="@_isSaving" />
    </RadzenStack>
</RadzenStack>

@code {
    [Parameter]
    public required TranslationGridRow Row { get; set; }

    [Parameter]
    public List<string> Languages { get; set; } = new();

    [Parameter]
    public string DefaultLanguage { get; set; } = "en";

    [Parameter]
    public string ProjectFormat { get; set; } = "json";

    [Parameter]
    public bool SupportsPluralKeys { get; set; } = true;

    [Parameter]
    public EventCallback<TranslationGridRow> OnTranslate { get; set; }

    private bool _isSaving;
    private bool _isTranslating;
    private bool _showConversionConfirm;
    private bool _pendingIsPlural;
    private bool _displayIsPlural;
    private string? _selectedPluralForm;
    private HashSet<string> _activePluralForms = new();
    private Dictionary<string, TmMatchDto> _tmSuggestions = new();

    protected override void OnParametersSet()
    {
        _displayIsPlural = Row.IsPlural;
        RefreshActivePluralForms();
    }

    private bool HasChanges => Row.Translations.Values.Any(t => t.IsDirty) || Row.IsKeyMetadataDirty;

    #region Plural Form Management

    private void RefreshActivePluralForms()
    {
        _activePluralForms = GetExistingPluralForms();
        if (Row.IsPlural && !_activePluralForms.Contains(PluralForms.Other))
            _activePluralForms.Add(PluralForms.Other);
        if (Row.IsPlural && _activePluralForms.Count == 1)
            _activePluralForms.Add(PluralForms.One);
    }

    private HashSet<string> GetExistingPluralForms()
    {
        if (!Row.IsPlural) return new HashSet<string>();
        return Row.Translations.Values
            .Where(t => !string.IsNullOrEmpty(t.PluralForm))
            .Select(t => t.PluralForm)
            .ToHashSet();
    }

    private IEnumerable<string> GetActivePluralForms() =>
        PluralForms.All.Where(pf => _activePluralForms.Contains(pf));

    private IEnumerable<string> GetAvailablePluralForms() =>
        PluralForms.All.Where(pf => !_activePluralForms.Contains(pf));

    private void OnPluralFormSelected(object value)
    {
        if (value is string form && !string.IsNullOrEmpty(form))
        {
            AddPluralForm(form);
            _selectedPluralForm = null;
        }
    }

    private void AddPluralForm(string pluralForm)
    {
        _activePluralForms.Add(pluralForm);
        foreach (var lang in Languages)
        {
            var key = TranslationGridRow.GetKey(lang, pluralForm);
            if (!Row.Translations.ContainsKey(key))
            {
                Row.Translations[key] = new TranslationCell
                {
                    LanguageCode = lang,
                    PluralForm = pluralForm,
                    Value = null,
                    OriginalValue = null,
                    IsDirty = true
                };
            }
        }
        NotificationService.Notify(NotificationSeverity.Info, "Added", $"Added '{pluralForm}' plural form");
    }

    private void RemovePluralForm(string pluralForm)
    {
        if (pluralForm == PluralForms.Other)
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Warning", "Cannot remove 'other' form - it's required");
            return;
        }

        _activePluralForms.Remove(pluralForm);
        foreach (var lang in Languages)
        {
            var key = TranslationGridRow.GetKey(lang, pluralForm);
            if (Row.Translations.TryGetValue(key, out var cell))
            {
                cell.Value = null;
                cell.IsDirty = true;
            }
        }
        NotificationService.Notify(NotificationSeverity.Info, "Removed", $"Removed '{pluralForm}' plural form");
    }

    private static string GetPluralPlaceholder(string pluralForm, bool isDefault) => pluralForm switch
    {
        "one" => isDefault ? "Singular (1 item)" : "Translate singular",
        "other" => isDefault ? "Plural (2+ items)" : "Translate plural",
        "zero" => isDefault ? "Zero (0 items)" : "Translate zero",
        "two" => isDefault ? "Dual (exactly 2)" : "Translate dual",
        "few" => isDefault ? "Few (2-4 items)" : "Translate few",
        "many" => isDefault ? "Many (5+ items)" : "Translate many",
        _ => isDefault ? $"Enter {pluralForm}" : $"Translate {pluralForm}"
    };

    #endregion

    #region Type Conversion

    private void OnKeyTypeToggled(bool isPlural)
    {
        if (isPlural == Row.IsPlural)
        {
            _showConversionConfirm = false;
            _displayIsPlural = Row.IsPlural;
            return;
        }

        _pendingIsPlural = isPlural;
        _displayIsPlural = isPlural;
        _showConversionConfirm = true;
    }

    private void CancelConversion()
    {
        _showConversionConfirm = false;
        _displayIsPlural = Row.IsPlural;
    }

    private void ConfirmConversion()
    {
        _showConversionConfirm = false;

        if (_pendingIsPlural)
        {
            var keysToMove = Row.Translations.Keys.ToList();
            foreach (var oldKey in keysToMove)
            {
                var cell = Row.Translations[oldKey];
                if (string.IsNullOrEmpty(cell.PluralForm))
                {
                    var newKey = TranslationGridRow.GetKey(cell.LanguageCode, PluralForms.Other);
                    Row.Translations.Remove(oldKey);
                    cell.PluralForm = PluralForms.Other;
                    cell.IsDirty = true;
                    Row.Translations[newKey] = cell;
                }
            }

            _activePluralForms = new HashSet<string> { PluralForms.One, PluralForms.Other };

            foreach (var lang in Languages)
            {
                var oneKey = TranslationGridRow.GetKey(lang, PluralForms.One);
                if (!Row.Translations.ContainsKey(oneKey))
                {
                    Row.Translations[oneKey] = new TranslationCell
                    {
                        LanguageCode = lang,
                        PluralForm = PluralForms.One,
                        Value = null,
                        OriginalValue = null,
                        IsDirty = true
                    };
                }

                var otherKey = TranslationGridRow.GetKey(lang, PluralForms.Other);
                if (!Row.Translations.ContainsKey(otherKey))
                {
                    Row.Translations[otherKey] = new TranslationCell
                    {
                        LanguageCode = lang,
                        PluralForm = PluralForms.Other,
                        Value = null,
                        OriginalValue = null,
                        IsDirty = true
                    };
                }
            }
        }
        else
        {
            var keysToProcess = Row.Translations.Keys.ToList();
            foreach (var oldKey in keysToProcess)
            {
                var cell = Row.Translations[oldKey];
                if (cell.PluralForm == PluralForms.Other)
                {
                    Row.Translations.Remove(oldKey);
                    cell.PluralForm = "";
                    cell.IsDirty = true;
                    Row.Translations[cell.LanguageCode] = cell;
                }
                else if (!string.IsNullOrEmpty(cell.PluralForm))
                {
                    Row.Translations.Remove(oldKey);
                }
            }
            _activePluralForms.Clear();
        }

        Row.IsPlural = _pendingIsPlural;
        NotificationService.Notify(NotificationSeverity.Success, "Converted", $"Converted to {(_pendingIsPlural ? "plural" : "single")} key");
    }

    #endregion

    #region Value Changes

    private void OnValueChanged(TranslationCell cell, string? value)
    {
        cell.Value = value;
        cell.IsDirty = cell.Value != cell.OriginalValue;
    }

    private void OnCommentChanged(string? value)
    {
        Row.Comment = value;
    }

    #endregion

    #region TM Integration

    private string? GetSourceText(string? pluralForm = null)
    {
        if (Row.IsPlural)
        {
            var pf = !string.IsNullOrEmpty(pluralForm) ? pluralForm : PluralForms.Other;
            var key = TranslationGridRow.GetKey(DefaultLanguage, pf);
            return Row.Translations.GetValueOrDefault(key)?.Value;
        }
        return Row.Translations.GetValueOrDefault(DefaultLanguage)?.Value;
    }

    private bool HasAnySourceText()
    {
        if (Row.IsPlural)
        {
            return GetActivePluralForms().Any(pf =>
            {
                var key = TranslationGridRow.GetKey(DefaultLanguage, pf);
                var cell = Row.Translations.GetValueOrDefault(key);
                return !string.IsNullOrEmpty(cell?.Value);
            });
        }
        return !string.IsNullOrEmpty(Row.Translations.GetValueOrDefault(DefaultLanguage)?.Value);
    }

    private bool HasTmForLanguage(string lang)
    {
        if (Row.IsPlural)
            return GetActivePluralForms().Any(pf => _tmSuggestions.ContainsKey(TranslationGridRow.GetKey(lang, pf)));
        return _tmSuggestions.ContainsKey(lang);
    }

    private async Task CheckTmForLanguage(string targetLanguage)
    {
        if (Row.IsPlural)
        {
            foreach (var pf in GetActivePluralForms())
                await CheckTmForLanguageAndForm(targetLanguage, pf);
        }
        else
        {
            await CheckTmForLanguageAndForm(targetLanguage, null);
        }
    }

    private async Task CheckTmForLanguageAndForm(string targetLanguage, string? pluralForm)
    {
        var sourceText = GetSourceText(pluralForm);
        if (string.IsNullOrEmpty(sourceText)) return;

        var request = new TmLookupRequest
        {
            SourceText = sourceText,
            SourceLanguage = DefaultLanguage,
            TargetLanguage = targetLanguage,
            MinMatchPercent = 70,
            MaxResults = 1
        };

        var result = await TmService.LookupAsync(request);

        if (result.IsSuccess && result.Data?.Matches.Any() == true)
        {
            var match = result.Data.Matches.First();
            var key = string.IsNullOrEmpty(pluralForm) ? targetLanguage : TranslationGridRow.GetKey(targetLanguage, pluralForm);
            _tmSuggestions[key] = match;
        }

        StateHasChanged();
    }

    private async Task CheckTmForAllLanguages()
    {
        var foundCount = 0;

        foreach (var lang in Languages.Where(l => l != DefaultLanguage))
        {
            if (Row.IsPlural)
            {
                foreach (var pf in GetActivePluralForms())
                {
                    var sourceText = GetSourceText(pf);
                    if (string.IsNullOrEmpty(sourceText)) continue;

                    var request = new TmLookupRequest
                    {
                        SourceText = sourceText,
                        SourceLanguage = DefaultLanguage,
                        TargetLanguage = lang,
                        MinMatchPercent = 70,
                        MaxResults = 1
                    };

                    var result = await TmService.LookupAsync(request);
                    if (result.IsSuccess && result.Data?.Matches.Any() == true)
                    {
                        var key = TranslationGridRow.GetKey(lang, pf);
                        _tmSuggestions[key] = result.Data.Matches.First();
                        foundCount++;
                    }
                }
            }
            else
            {
                var sourceText = GetSourceText();
                if (string.IsNullOrEmpty(sourceText)) continue;

                var request = new TmLookupRequest
                {
                    SourceText = sourceText,
                    SourceLanguage = DefaultLanguage,
                    TargetLanguage = lang,
                    MinMatchPercent = 70,
                    MaxResults = 1
                };

                var result = await TmService.LookupAsync(request);
                if (result.IsSuccess && result.Data?.Matches.Any() == true)
                {
                    _tmSuggestions[lang] = result.Data.Matches.First();
                    foundCount++;
                }
            }
        }

        if (foundCount > 0)
            NotificationService.Notify(NotificationSeverity.Success, "TM", $"Found {foundCount} TM match(es)");
        else
            NotificationService.Notify(NotificationSeverity.Info, "TM", "No TM matches found");

        StateHasChanged();
    }

    private void ApplyTmSuggestion(string key, TmMatchDto suggestion)
    {
        if (Row.Translations.TryGetValue(key, out var cell))
        {
            cell.Value = suggestion.TranslatedText;
            cell.IsDirty = true;
            _ = TmService.IncrementUseCountAsync(suggestion.Id);
            NotificationService.Notify(NotificationSeverity.Success, "Applied", "TM suggestion applied");
        }

        _tmSuggestions.Remove(key);
        StateHasChanged();
    }

    private void DismissTmSuggestion(string key)
    {
        _tmSuggestions.Remove(key);
        StateHasChanged();
    }

    #endregion

    #region Status Helpers

    private TranslationStatus GetLanguageStatus(string lang)
    {
        if (lang == DefaultLanguage) return TranslationStatus.Complete;

        if (Row.IsPlural)
        {
            var forms = GetActivePluralForms().ToList();
            var hasAny = forms.Any(pf =>
            {
                var key = TranslationGridRow.GetKey(lang, pf);
                var cell = Row.Translations.GetValueOrDefault(key);
                return !string.IsNullOrEmpty(cell?.Value);
            });

            var hasAll = forms.All(pf =>
            {
                var key = TranslationGridRow.GetKey(lang, pf);
                var cell = Row.Translations.GetValueOrDefault(key);
                return !string.IsNullOrEmpty(cell?.Value);
            });

            if (hasAll) return TranslationStatus.Complete;
            if (hasAny) return TranslationStatus.Partial;
            return TranslationStatus.Missing;
        }
        else
        {
            var cell = Row.Translations.GetValueOrDefault(lang);
            return string.IsNullOrEmpty(cell?.Value) ? TranslationStatus.Missing : TranslationStatus.Complete;
        }
    }

    #endregion

    #region Actions

    private async Task HandleTranslate()
    {
        if (!OnTranslate.HasDelegate) return;

        _isTranslating = true;
        StateHasChanged();

        try
        {
            await OnTranslate.InvokeAsync(Row);
        }
        finally
        {
            _isTranslating = false;
            StateHasChanged();
        }
    }

    private void Cancel()
    {
        DialogService.Close(null);
    }

    private void Save()
    {
        _isSaving = true;
        DialogService.Close(Row);
    }

    #endregion
}
