@using LrmCloud.Web.Models
@using MudBlazor
@inject ISnackbar Snackbar

<MudDataGrid @ref="_dataGrid"
             T="TranslationGridRow"
             ServerData="@ServerDataFunc"
             Dense="true"
             Hover="true"
             Bordered="true"
             Striped="true"
             FixedHeader="true"
             Height="calc(100vh - 300px)"
             RowClick="@OnRowClick"
             SelectedItemsChanged="@OnSelectedItemsChanged"
             MultiSelection="true"
             SelectOnRowClick="false"
             ReadOnly="false"
             EditMode="DataGridEditMode.Cell"
             EditTrigger="DataGridEditTrigger.OnRowClick"
             CommittedItemChanges="@OnCellCommitted"
             Class="translation-grid">

    <ToolBarContent>
        <MudTextField T="string"
                      Value="@_searchText"
                      ValueChanged="@OnSearchChanged"
                      Placeholder="Search keys..."
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      IconSize="Size.Small"
                      Immediate="true"
                      DebounceInterval="500"
                      Class="mt-0"
                      Style="max-width: 300px;" />

        <MudSelect T="TranslationStatus?" @bind-Value="_statusFilter"
                   Label="Status"
                   Variant="Variant.Outlined"
                   Dense="true"
                   Margin="Margin.Dense"
                   Class="ml-4"
                   Style="max-width: 150px;">
            <MudSelectItem T="TranslationStatus?" Value="@((TranslationStatus?)null)">All</MudSelectItem>
            <MudSelectItem T="TranslationStatus?" Value="@TranslationStatus.Complete">Complete</MudSelectItem>
            <MudSelectItem T="TranslationStatus?" Value="@TranslationStatus.Partial">Partial</MudSelectItem>
            <MudSelectItem T="TranslationStatus?" Value="@TranslationStatus.Missing">Missing</MudSelectItem>
        </MudSelect>

        @if (WorkflowEnabled)
        {
            <MudSelect T="string?" @bind-Value="_workflowStatusFilter"
                       Label="Workflow"
                       Variant="Variant.Outlined"
                       Dense="true"
                       Margin="Margin.Dense"
                       Class="ml-2"
                       Style="max-width: 150px;">
                <MudSelectItem T="string?" Value="@((string?)null)">All States</MudSelectItem>
                <MudSelectItem T="string?" Value="@("pending")">Pending</MudSelectItem>
                <MudSelectItem T="string?" Value="@("translated")">Translated</MudSelectItem>
                <MudSelectItem T="string?" Value="@("reviewed")">Reviewed</MudSelectItem>
                <MudSelectItem T="string?" Value="@("approved")">Approved</MudSelectItem>
            </MudSelect>
        }

        <MudMenu Icon="@Icons.Material.Filled.ViewColumn"
                 Label="Columns"
                 Variant="Variant.Outlined"
                 Dense="true"
                 Class="ml-4"
                 AnchorOrigin="Origin.BottomLeft">
            @foreach (var lang in Languages)
            {
                var langCode = lang;
                var isVisible = !_hiddenLanguages.Contains(langCode);
                <MudMenuItem OnClick="@(() => ToggleLanguageVisibility(langCode))">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudCheckBox T="bool" Value="@isVisible" Size="Size.Small" ReadOnly="true" />
                        <MudText>@langCode.ToUpperInvariant()</MudText>
                        @if (langCode == DefaultLanguage)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">(default)</MudText>
                        }
                    </MudStack>
                </MudMenuItem>
            }
        </MudMenu>

        <MudSpacer />

        @if (SelectedItems.Any())
        {
            <MudChip T="string" Color="Color.Primary" Size="Size.Small" Class="mr-2">
                @SelectedItems.Count() selected
            </MudChip>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Primary"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Translate"
                       OnClick="@OnTranslateSelected"
                       Class="mr-2">
                Translate
            </MudButton>
            @if (WorkflowEnabled && CanReview)
            {
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Info"
                           Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.RateReview"
                           OnClick="@OnReviewSelected"
                           Class="mr-2">
                    Review
                </MudButton>
            }
            @if (WorkflowEnabled && CanApprove)
            {
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Success"
                           Size="Size.Small"
                           StartIcon="@Icons.Material.Filled.CheckCircle"
                           OnClick="@OnApproveSelected"
                           Class="mr-2">
                    Approve
                </MudButton>
            }
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Error"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Delete"
                       OnClick="@OnDeleteSelected">
                Delete
            </MudButton>
        }
        else
        {
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="@OnAddKey">
                Add Key
            </MudButton>
        }
    </ToolBarContent>

    <Columns>
        <SelectColumn T="TranslationGridRow" ShowInFooter="false" />

        <PropertyColumn Property="x => x.Status" Title="" Sortable="false" Filterable="false" CellStyle="width: 40px;">
            <CellTemplate>
                @switch (context.Item.Status)
                {
                    case TranslationStatus.Complete:
                        <MudTooltip Text="All translations complete">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                        </MudTooltip>
                        break;
                    case TranslationStatus.Partial:
                        <MudTooltip Text="Some translations missing">
                            <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Warning" Size="Size.Small" />
                        </MudTooltip>
                        break;
                    case TranslationStatus.Missing:
                        <MudTooltip Text="No translations">
                            <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" Size="Size.Small" />
                        </MudTooltip>
                        break;
                }
            </CellTemplate>
        </PropertyColumn>

        <PropertyColumn Property="x => x.KeyName" Title="Key" StickyLeft="true">
            <CellTemplate>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudText Typo="Typo.body2">@context.Item.KeyName</MudText>
                    @if (context.Item.IsPlural)
                    {
                        <MudTooltip Text="Plural key">
                            <MudChip T="string" Size="Size.Small" Color="Color.Info">P</MudChip>
                        </MudTooltip>
                    }
                    @if (!string.IsNullOrEmpty(context.Item.Comment))
                    {
                        <MudTooltip Text="@context.Item.Comment">
                            <MudIcon Icon="@Icons.Material.Filled.Comment" Size="Size.Small" Color="Color.Secondary" />
                        </MudTooltip>
                    }
                </MudStack>
            </CellTemplate>
        </PropertyColumn>

        @foreach (var lang in VisibleLanguages)
        {
            var langCode = lang;
            <TemplateColumn T="TranslationGridRow" Title="@GetLanguageTitle(lang)" CellStyle="min-width: 200px;">
                <CellTemplate>
                    @{
                        // For plural keys, show "other" form; for non-plural, show direct value
                        var cell = context.Item.IsPlural
                            ? context.Item.GetCell(langCode, PluralForms.Other)
                            : context.Item.Translations.GetValueOrDefault(langCode);
                        var value = cell?.Value ?? "";
                        var isDirty = context.Item.IsPlural
                            ? context.Item.GetTranslationsForLanguage(langCode).Any(c => c.IsDirty)
                            : (cell?.IsDirty ?? false);

                        // For plural keys, show summary of all forms
                        var pluralSummary = context.Item.IsPlural
                            ? GetPluralSummary(context.Item, langCode)
                            : null;
                    }
                    <MudStack Row="true" AlignItems="AlignItems.Center" Class="@(isDirty ? "dirty-cell" : "")">
                        @if (context.Item.IsPlural && pluralSummary != null)
                        {
                            <MudTooltip Text="@pluralSummary">
                                @if (string.IsNullOrEmpty(value))
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="font-italic">
                                        (empty)
                                    </MudText>
                                }
                                else
                                {
                                    <MudText Typo="Typo.body2" Style="@(value.Length > 50 ? "overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 300px;" : "")">
                                        @value
                                    </MudText>
                                }
                            </MudTooltip>
                        }
                        else if (string.IsNullOrEmpty(value))
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="font-italic">
                                (empty)
                            </MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Style="@(value.Length > 50 ? "overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 300px;" : "")">
                                @value
                            </MudText>
                        }
                    </MudStack>
                </CellTemplate>
                <EditTemplate>
                    @{
                        // For plural keys, edit "other" form in grid; use drawer for all forms
                        var cell = context.Item.IsPlural
                            ? context.Item.GetCell(langCode, PluralForms.Other)
                            : context.Item.Translations.GetValueOrDefault(langCode);
                        var currentValue = cell?.Value ?? "";
                    }
                    @if (context.Item.IsPlural)
                    {
                        <MudStack>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">other:</MudText>
                            <MudTextField T="string"
                                          Value="@currentValue"
                                          ValueChanged="@(v => OnCellValueChanged(context.Item, langCode, v, PluralForms.Other))"
                                          Variant="Variant.Outlined"
                                          Margin="Margin.Dense"
                                          FullWidth="true"
                                          AutoFocus="true"
                                          HelperText="Click row to edit all plural forms" />
                        </MudStack>
                    }
                    else
                    {
                        <MudTextField T="string"
                                      Value="@currentValue"
                                      ValueChanged="@(v => OnCellValueChanged(context.Item, langCode, v, null))"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      FullWidth="true"
                                      AutoFocus="true" />
                    }
                </EditTemplate>
            </TemplateColumn>
        }
    </Columns>

    <NoRecordsContent>
        <MudStack AlignItems="AlignItems.Center" Class="py-8">
            <MudIcon Icon="@Icons.Material.Filled.Translate" Size="Size.Large" Color="Color.Secondary" />
            <MudText Typo="Typo.subtitle1" Color="Color.Secondary">No translation keys found</MudText>
            @if (!string.IsNullOrEmpty(_searchText) || _statusFilter.HasValue)
            {
                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(async () => await ClearFilters())">
                    Clear Filters
                </MudButton>
            }
            else
            {
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@OnAddKey">
                    Add Your First Key
                </MudButton>
            }
        </MudStack>
    </NoRecordsContent>

    <LoadingContent>
        <MudStack AlignItems="AlignItems.Center" Class="py-8">
            <MudProgressCircular Indeterminate="true" />
            <MudText Typo="Typo.subtitle1" Color="Color.Secondary">Loading translations...</MudText>
        </MudStack>
    </LoadingContent>

    <PagerContent>
        <MudDataGridPager T="TranslationGridRow" />
    </PagerContent>
</MudDataGrid>

<style>
    .translation-grid .mud-table-cell {
        padding: 4px 8px !important;
    }

    .dirty-cell {
        background-color: rgba(255, 193, 7, 0.1);
    }

    .translation-grid .mud-table-row:hover {
        cursor: pointer;
    }
</style>

@code {
    private MudDataGrid<TranslationGridRow>? _dataGrid;

    [Parameter]
    public Func<GridState<TranslationGridRow>, Task<GridData<TranslationGridRow>>>? ServerDataFunc { get; set; }

    [Parameter]
    public List<string> Languages { get; set; } = new();

    [Parameter]
    public string DefaultLanguage { get; set; } = "en";

    [Parameter]
    public EventCallback<TranslationGridRow> OnRowSelected { get; set; }

    [Parameter]
    public EventCallback OnAddKeyClicked { get; set; }

    [Parameter]
    public EventCallback<IEnumerable<TranslationGridRow>> OnTranslateClicked { get; set; }

    [Parameter]
    public EventCallback<IEnumerable<TranslationGridRow>> OnDeleteClicked { get; set; }

    [Parameter]
    public EventCallback<(TranslationGridRow Row, string LanguageCode, string Value)> OnCellChanged { get; set; }

    [Parameter]
    public EventCallback<string> OnSearchTextChanged { get; set; }

    [Parameter]
    public bool WorkflowEnabled { get; set; }

    [Parameter]
    public bool CanReview { get; set; }

    [Parameter]
    public bool CanApprove { get; set; }

    [Parameter]
    public EventCallback<IEnumerable<TranslationGridRow>> OnReviewClicked { get; set; }

    [Parameter]
    public EventCallback<IEnumerable<TranslationGridRow>> OnApproveClicked { get; set; }

    private string _searchText = string.Empty;
    private TranslationStatus? _statusFilter;
    private string? _workflowStatusFilter;
    private HashSet<TranslationGridRow> _selectedItems = new();
    private HashSet<string> _hiddenLanguages = new();

    public string SearchText => _searchText;

    private IEnumerable<string> VisibleLanguages => Languages.Where(l => !_hiddenLanguages.Contains(l));

    private IEnumerable<TranslationGridRow> SelectedItems => _selectedItems;

    private string GetLanguageTitle(string langCode)
    {
        var title = langCode.ToUpperInvariant();
        if (langCode == DefaultLanguage)
            title += " (default)";
        return title;
    }

    private async Task OnSearchChanged(string value)
    {
        _searchText = value;
        await OnSearchTextChanged.InvokeAsync(value);
        if (_dataGrid != null)
        {
            await _dataGrid.ReloadServerData();
        }
    }

    private async Task ClearFilters()
    {
        _searchText = string.Empty;
        _statusFilter = null;
        _hiddenLanguages.Clear();
        await OnSearchTextChanged.InvokeAsync(string.Empty);
        if (_dataGrid != null)
        {
            await _dataGrid.ReloadServerData();
        }
    }

    private void ToggleLanguageVisibility(string langCode)
    {
        if (_hiddenLanguages.Contains(langCode))
            _hiddenLanguages.Remove(langCode);
        else
            _hiddenLanguages.Add(langCode);
    }

    private void OnRowClick(DataGridRowClickEventArgs<TranslationGridRow> args)
    {
        OnRowSelected.InvokeAsync(args.Item);
    }

    private void OnSelectedItemsChanged(HashSet<TranslationGridRow> items)
    {
        _selectedItems = items;
    }

    private void OnCellValueChanged(TranslationGridRow row, string languageCode, string value, string? pluralForm)
    {
        row.SetTranslation(languageCode, value, null, pluralForm);
        OnCellChanged.InvokeAsync((row, languageCode, value));
    }

    private static string GetPluralSummary(TranslationGridRow row, string langCode)
    {
        var parts = new List<string>();
        foreach (var pf in PluralForms.Common)
        {
            var cell = row.GetCell(langCode, pf);
            var val = cell?.Value;
            if (!string.IsNullOrEmpty(val))
            {
                var display = val.Length > 20 ? val[..20] + "..." : val;
                parts.Add($"{pf}: {display}");
            }
        }
        return parts.Count > 0 ? string.Join("\n", parts) : "No plural forms set";
    }

    private void OnCellCommitted(TranslationGridRow row)
    {
        // Cell editing committed
    }

    private void OnAddKey()
    {
        OnAddKeyClicked.InvokeAsync();
    }

    private void OnTranslateSelected()
    {
        OnTranslateClicked.InvokeAsync(_selectedItems);
    }

    private void OnDeleteSelected()
    {
        OnDeleteClicked.InvokeAsync(_selectedItems);
    }

    private void OnReviewSelected()
    {
        OnReviewClicked.InvokeAsync(_selectedItems);
    }

    private void OnApproveSelected()
    {
        OnApproveClicked.InvokeAsync(_selectedItems);
    }

    /// <summary>
    /// Reloads the grid data from the server.
    /// </summary>
    public async Task ReloadAsync()
    {
        if (_dataGrid != null)
        {
            await _dataGrid.ReloadServerData();
        }
    }
}
