@using LrmCloud.Web.Models
@inject NotificationService NotificationService

@* Toolbar *@
<RadzenCard class="rz-mb-2 rz-p-2">
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" Wrap="FlexWrap.Wrap">
        <RadzenFormField Variant="Radzen.Variant.Outlined" Style="width: 250px;">
            <Start>
                <RadzenIcon Icon="search" />
            </Start>
            <ChildContent>
                <RadzenTextBox @bind-Value="_searchText" Placeholder="Search keys..." Change="@OnSearchChanged" />
            </ChildContent>
        </RadzenFormField>

        <RadzenFormField Text="Status" Variant="Radzen.Variant.Outlined" Style="width: 150px;">
            <ChildContent>
                <RadzenDropDown TValue="TranslationStatus?" @bind-Value="_statusFilter" Change="@OnStatusFilterChanged"
                                Data="@_statusOptions" TextProperty="Text" ValueProperty="Value"
                                AllowClear="true" Placeholder="All" Style="width: 100%;" />
            </ChildContent>
        </RadzenFormField>

        @if (WorkflowEnabled)
        {
            <RadzenFormField Text="Workflow" Variant="Radzen.Variant.Outlined" Style="width: 150px;">
                <ChildContent>
                    <RadzenDropDown TValue="string?" @bind-Value="_workflowStatusFilter" Change="@OnWorkflowFilterChanged"
                                    Data="@_workflowOptions" TextProperty="Text" ValueProperty="Value"
                                    AllowClear="true" Placeholder="All States" Style="width: 100%;" />
                </ChildContent>
            </RadzenFormField>
        }

        <RadzenSplitButton Text="Columns" Icon="view_column" Variant="Radzen.Variant.Outlined" Size="ButtonSize.Small"
                           Click="@(args => { })" Style="margin-top: auto;">
            <ChildContent>
                @foreach (var lang in Languages)
                {
                    var langCode = lang;
                    var isVisible = !_hiddenLanguages.Contains(langCode);
                    <RadzenSplitButtonItem Text="@GetLanguageLabel(langCode)" Value="@langCode"
                                           Icon="@(isVisible ? "check_box" : "check_box_outline_blank")" />
                }
            </ChildContent>
        </RadzenSplitButton>

        <div style="flex-grow: 1;"></div>

        @if (_selectedItems.Any())
        {
            <RadzenBadge BadgeStyle="BadgeStyle.Primary" Text="@($"{_selectedItems.Count} selected")" class="rz-mr-2" />
            <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small"
                          Icon="translate" Text="Translate" Click="@OnTranslateSelected" class="rz-mr-1" />
            @if (WorkflowEnabled && CanReview)
            {
                <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Small"
                              Icon="rate_review" Text="Review" Click="@OnReviewSelected" class="rz-mr-1" />
            }
            @if (WorkflowEnabled && CanApprove)
            {
                <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small"
                              Icon="check_circle" Text="Approve" Click="@OnApproveSelected" class="rz-mr-1" />
            }
            <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small"
                          Icon="delete" Text="Delete" Click="@OnDeleteSelected" />
        }
        else
        {
            <RadzenButton ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small"
                          Icon="add" Text="Add Key" Click="@OnAddKey" />
        }
    </RadzenStack>
</RadzenCard>

@* Data Grid *@
<RadzenDataGrid @ref="_dataGrid"
                TItem="TranslationGridRow"
                Data="@_data"
                Count="@_count"
                LoadData="@LoadData"
                IsLoading="@_isLoading"
                AllowFiltering="false"
                AllowSorting="true"
                AllowPaging="true"
                PageSize="50"
                PagerHorizontalAlign="HorizontalAlign.Right"
                ShowPagingSummary="true"
                PagingSummaryFormat="Showing {0} to {1} of {2} items"
                Density="Density.Compact"
                SelectionMode="DataGridSelectionMode.Multiple"
                AllowRowSelectOnRowClick="false"
                RowClick="@OnRowClick"
                @bind-Value="_selectedItems"
                EditMode="Radzen.DataGridEditMode.Single"
                Style="height: calc(100vh - 320px);"
                RowStyle="cursor: pointer;">

    <EmptyTemplate>
        <RadzenStack AlignItems="Radzen.AlignItems.Center" JustifyContent="JustifyContent.Center" Gap="0.5rem" class="rz-p-8">
            <RadzenIcon Icon="translate" Style="font-size: 3rem; color: var(--rz-text-disabled-color);" />
            <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-color-secondary">No translation keys found</RadzenText>
            @if (!string.IsNullOrEmpty(_searchText) || _statusFilter.HasValue)
            {
                <RadzenButton Variant="Radzen.Variant.Text" ButtonStyle="ButtonStyle.Primary" Text="Clear Filters" Click="@ClearFilters" />
            }
            else
            {
                <RadzenButton ButtonStyle="ButtonStyle.Primary" Text="Add Your First Key" Click="@OnAddKey" />
            }
        </RadzenStack>
    </EmptyTemplate>

    <Columns>
        @* Selection checkbox *@
        <RadzenDataGridColumn TItem="TranslationGridRow" Width="40px" Sortable="false" Filterable="false" TextAlign="TextAlign.Center">
            <HeaderTemplate>
                <RadzenCheckBox TValue="bool" Value="@_selectAll" Change="@OnSelectAllChanged" />
            </HeaderTemplate>
            <Template Context="row">
                <RadzenCheckBox TValue="bool" Value="@_selectedItems.Contains(row)"
                                Change="@(args => OnRowSelectionChanged(row, args))" />
            </Template>
        </RadzenDataGridColumn>

        @* Status icon *@
        <RadzenDataGridColumn TItem="TranslationGridRow" Title="" Width="40px" Sortable="false" Filterable="false">
            <Template Context="row">
                @switch (row.Status)
                {
                    case TranslationStatus.Complete:
                        <span title="All translations complete">
                            <RadzenIcon Icon="check_circle" Style="color: var(--rz-success);" />
                        </span>
                        break;
                    case TranslationStatus.Partial:
                        <span title="Some translations missing">
                            <RadzenIcon Icon="warning" Style="color: var(--rz-warning);" />
                        </span>
                        break;
                    case TranslationStatus.Missing:
                        <span title="No translations">
                            <RadzenIcon Icon="error" Style="color: var(--rz-danger);" />
                        </span>
                        break;
                }
            </Template>
        </RadzenDataGridColumn>

        @* Key name *@
        <RadzenDataGridColumn TItem="TranslationGridRow" Property="KeyName" Title="Key" Width="220px" Frozen="true">
            <Template Context="row">
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                    <RadzenText TextStyle="TextStyle.Body2" Style="flex: 1;">@row.KeyName</RadzenText>
                    @if (row.IsPlural)
                    {
                        <span title="Plural key">
                            <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="P" Style="font-size: 0.65rem;" />
                        </span>
                    }
                    @if (!string.IsNullOrEmpty(row.Comment))
                    {
                        <span title="@row.Comment">
                            <RadzenIcon Icon="comment" Style="font-size: 0.875rem; color: var(--rz-text-secondary-color);" />
                        </span>
                    }
                </RadzenStack>
            </Template>
        </RadzenDataGridColumn>

        @* Language columns *@
        @foreach (var lang in VisibleLanguages)
        {
            var langCode = lang;
            <RadzenDataGridColumn TItem="TranslationGridRow" Title="@GetLanguageTitle(lang)" MinWidth="200px" Sortable="false">
                <Template Context="row">
                    @{
                        var cell = row.IsPlural
                            ? row.GetCell(langCode, PluralForms.Other)
                            : row.Translations.GetValueOrDefault(langCode);
                        var value = cell?.Value ?? "";
                        var isDirty = row.IsPlural
                            ? row.GetTranslationsForLanguage(langCode).Any(c => c.IsDirty)
                            : (cell?.IsDirty ?? false);
                        var pluralSummary = row.IsPlural ? GetPluralSummary(row, langCode) : null;
                    }
                    <div style="@(isDirty ? "background-color: rgba(255, 193, 7, 0.1); padding: 2px 4px; border-radius: 2px;" : "")"
                         title="@pluralSummary">
                        @if (string.IsNullOrEmpty(value))
                        {
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="font-style: italic;">
                                (empty)
                            </RadzenText>
                        }
                        else
                        {
                            <RadzenText TextStyle="TextStyle.Body2" Style="@GetCellStyle(value)">
                                @value
                            </RadzenText>
                        }
                    </div>
                </Template>
                <EditTemplate Context="row">
                    @{
                        var cell = row.IsPlural
                            ? row.GetCell(langCode, PluralForms.Other)
                            : row.Translations.GetValueOrDefault(langCode);
                        var currentValue = cell?.Value ?? "";
                    }
                    @if (row.IsPlural)
                    {
                        <RadzenStack Gap="0.25rem">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">other:</RadzenText>
                            <RadzenTextBox Value="@currentValue"
                                           ValueChanged="@(v => OnCellValueChanged(row, langCode, v, PluralForms.Other))"
                                           Style="width: 100%;" />
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                Click row to edit all plural forms
                            </RadzenText>
                        </RadzenStack>
                    }
                    else
                    {
                        <RadzenTextBox Value="@currentValue"
                                       ValueChanged="@(v => OnCellValueChanged(row, langCode, v, null))"
                                       Style="width: 100%;" />
                    }
                </EditTemplate>
            </RadzenDataGridColumn>
        }
    </Columns>
</RadzenDataGrid>

@code {
    private RadzenDataGrid<TranslationGridRow>? _dataGrid;

    [Parameter]
    public Func<Models.GridState<TranslationGridRow>, Task<Models.GridData<TranslationGridRow>>>? ServerDataFunc { get; set; }

    [Parameter]
    public List<string> Languages { get; set; } = new();

    [Parameter]
    public string DefaultLanguage { get; set; } = "en";

    [Parameter]
    public EventCallback<TranslationGridRow> OnRowSelected { get; set; }

    [Parameter]
    public EventCallback OnAddKeyClicked { get; set; }

    [Parameter]
    public EventCallback<IEnumerable<TranslationGridRow>> OnTranslateClicked { get; set; }

    [Parameter]
    public EventCallback<IEnumerable<TranslationGridRow>> OnDeleteClicked { get; set; }

    [Parameter]
    public EventCallback<(TranslationGridRow Row, string LanguageCode, string Value)> OnCellChanged { get; set; }

    [Parameter]
    public EventCallback<string> OnSearchTextChanged { get; set; }

    [Parameter]
    public bool WorkflowEnabled { get; set; }

    [Parameter]
    public bool CanReview { get; set; }

    [Parameter]
    public bool CanApprove { get; set; }

    [Parameter]
    public EventCallback<IEnumerable<TranslationGridRow>> OnReviewClicked { get; set; }

    [Parameter]
    public EventCallback<IEnumerable<TranslationGridRow>> OnApproveClicked { get; set; }

    private string _searchText = string.Empty;
    private TranslationStatus? _statusFilter;
    private string? _workflowStatusFilter;
    private IList<TranslationGridRow> _selectedItems = new List<TranslationGridRow>();
    private HashSet<string> _hiddenLanguages = new();
    private bool _selectAll;
    private bool _isLoading;
    private IEnumerable<TranslationGridRow> _data = Enumerable.Empty<TranslationGridRow>();
    private int _count;

    private readonly List<object> _statusOptions = new()
    {
        new { Value = TranslationStatus.Complete, Text = "Complete" },
        new { Value = TranslationStatus.Partial, Text = "Partial" },
        new { Value = TranslationStatus.Missing, Text = "Missing" }
    };

    private readonly List<object> _workflowOptions = new()
    {
        new { Value = "pending", Text = "Pending" },
        new { Value = "translated", Text = "Translated" },
        new { Value = "reviewed", Text = "Reviewed" },
        new { Value = "approved", Text = "Approved" }
    };

    public string SearchText => _searchText;

    private IEnumerable<string> VisibleLanguages => Languages.Where(l => !_hiddenLanguages.Contains(l));

    private bool _initialized;

    private void OnRowClick(DataGridRowMouseEventArgs<TranslationGridRow> args)
    {
        OnRowSelected.InvokeAsync(args.Data);
    }

    protected override async Task OnParametersSetAsync()
    {
        // Trigger initial load when ServerDataFunc becomes available
        if (!_initialized && ServerDataFunc != null && _dataGrid != null)
        {
            _initialized = true;
            await _dataGrid.Reload();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Trigger initial load after first render if not yet loaded
        if (firstRender && ServerDataFunc != null && _dataGrid != null && !_initialized)
        {
            _initialized = true;
            await _dataGrid.Reload();
        }
    }

    private string GetLanguageTitle(string langCode)
    {
        var title = langCode.ToUpperInvariant();
        if (langCode == DefaultLanguage)
            title += " (default)";
        return title;
    }

    private string GetLanguageLabel(string langCode)
    {
        var label = langCode.ToUpperInvariant();
        if (langCode == DefaultLanguage)
            label += " (default)";
        return label;
    }

    private static string GetCellStyle(string value)
    {
        if (value.Length > 50)
            return "overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 300px; display: block;";
        return "";
    }

    private async Task LoadData(LoadDataArgs args)
    {
        if (ServerDataFunc == null)
        {
            _data = Enumerable.Empty<TranslationGridRow>();
            _count = 0;
            return;
        }

        _isLoading = true;
        StateHasChanged();

        try
        {
            // Convert Radzen LoadDataArgs to GridState for compatibility
            var state = new Models.GridState<TranslationGridRow>
            {
                Page = (args.Skip ?? 0) / (args.Top ?? 50),
                PageSize = args.Top ?? 50
            };

            var result = await ServerDataFunc(state);
            _data = result.Items ?? Enumerable.Empty<TranslationGridRow>();
            _count = result.TotalItems;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load data: {ex.Message}");
            _data = Enumerable.Empty<TranslationGridRow>();
            _count = 0;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnSearchChanged(string value)
    {
        _searchText = value;
        await OnSearchTextChanged.InvokeAsync(value);
        await ReloadAsync();
    }

    private async Task OnStatusFilterChanged(object? value)
    {
        await ReloadAsync();
    }

    private async Task OnWorkflowFilterChanged(object? value)
    {
        await ReloadAsync();
    }

    private async Task ClearFilters()
    {
        _searchText = string.Empty;
        _statusFilter = null;
        _workflowStatusFilter = null;
        _hiddenLanguages.Clear();
        await OnSearchTextChanged.InvokeAsync(string.Empty);
        await ReloadAsync();
    }

    private void ToggleLanguageVisibility(string langCode)
    {
        if (_hiddenLanguages.Contains(langCode))
            _hiddenLanguages.Remove(langCode);
        else
            _hiddenLanguages.Add(langCode);
        StateHasChanged();
    }

    private void OnSelectAllChanged(bool value)
    {
        _selectAll = value;
        if (value)
        {
            _selectedItems = _data.ToList();
        }
        else
        {
            _selectedItems.Clear();
        }
    }

    private void OnRowSelectionChanged(TranslationGridRow row, bool selected)
    {
        if (selected)
        {
            if (!_selectedItems.Contains(row))
                _selectedItems.Add(row);
        }
        else
        {
            _selectedItems.Remove(row);
        }
        _selectAll = _selectedItems.Count == _data.Count() && _data.Any();
    }

    private void OnCellValueChanged(TranslationGridRow row, string languageCode, string value, string? pluralForm)
    {
        row.SetTranslation(languageCode, value, null, pluralForm);
        OnCellChanged.InvokeAsync((row, languageCode, value));
    }

    private static string? GetPluralSummary(TranslationGridRow row, string langCode)
    {
        var parts = new List<string>();
        foreach (var pf in PluralForms.Common)
        {
            var cell = row.GetCell(langCode, pf);
            var val = cell?.Value;
            if (!string.IsNullOrEmpty(val))
            {
                var display = val.Length > 20 ? val[..20] + "..." : val;
                parts.Add($"{pf}: {display}");
            }
        }
        return parts.Count > 0 ? string.Join("\n", parts) : null;
    }

    private void OnAddKey()
    {
        OnAddKeyClicked.InvokeAsync();
    }

    private void OnTranslateSelected()
    {
        OnTranslateClicked.InvokeAsync(_selectedItems);
    }

    private void OnDeleteSelected()
    {
        OnDeleteClicked.InvokeAsync(_selectedItems);
    }

    private void OnReviewSelected()
    {
        OnReviewClicked.InvokeAsync(_selectedItems);
    }

    private void OnApproveSelected()
    {
        OnApproveClicked.InvokeAsync(_selectedItems);
    }

    /// <summary>
    /// Reloads the grid data from the server.
    /// </summary>
    public async Task ReloadAsync()
    {
        if (_dataGrid != null)
        {
            await _dataGrid.Reload();
        }
    }
}
