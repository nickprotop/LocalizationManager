@inject ResourceService ResourceService
@inject ISnackbar Snackbar

<MudDialog @bind-Visible="_visible" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Add" Class="mr-2" />
            Add New Key
        </MudText>
    </TitleContent>
    <DialogContent>
        <EditForm Model="_model" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />
            <MudStack Spacing="3">
                <MudTextField @bind-Value="_model.KeyName"
                              Label="Key Name"
                              Variant="Variant.Outlined"
                              For="@(() => _model.KeyName)"
                              Disabled="_isSubmitting"
                              Required="true"
                              HelperText="e.g., WelcomeMessage, Error.NotFound, Button.Save" />

                <MudTextField @bind-Value="_model.Comment"
                              Label="Comment (optional)"
                              Variant="Variant.Outlined"
                              Lines="2"
                              For="@(() => _model.Comment)"
                              Disabled="_isSubmitting"
                              HelperText="Description to help translators" />

                <MudSwitch @bind-Value="_model.IsPlural"
                           Label="Plural key"
                           Color="Color.Primary"
                           Disabled="_isSubmitting" />

                @if (_model.IsPlural)
                {
                    <MudAlert Severity="Severity.Info" Dense="true">
                        Plural keys support different forms for quantities (zero, one, few, many, other).
                    </MudAlert>
                }

                <MudTextField @bind-Value="_defaultValue"
                              Label="Default Value"
                              Variant="Variant.Outlined"
                              Lines="2"
                              Disabled="_isSubmitting"
                              HelperText="Value for the default language" />

                @if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Dense="true">@_errorMessage</MudAlert>
                }
            </MudStack>
        </EditForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close" Disabled="_isSubmitting">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="HandleSubmit" Disabled="_isSubmitting">
            @if (_isSubmitting)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                <MudText Class="ms-2">Creating...</MudText>
            }
            else
            {
                <MudText>Add Key</MudText>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter]
    public int ProjectId { get; set; }

    [Parameter]
    public EventCallback<ResourceKeyDto> OnKeyAdded { get; set; }

    private bool _visible;
    private bool _isSubmitting;
    private string? _errorMessage;
    private string _defaultValue = string.Empty;
    private CreateResourceKeyRequest _model = new() { KeyName = "" };

    private readonly DialogOptions _dialogOptions = new()
    {
        MaxWidth = MaxWidth.Small,
        FullWidth = true,
        CloseOnEscapeKey = true
    };

    public void Open()
    {
        _model = new CreateResourceKeyRequest { KeyName = "" };
        _defaultValue = string.Empty;
        _errorMessage = null;
        _visible = true;
        StateHasChanged();
    }

    private void Close()
    {
        _visible = false;
    }

    private async Task HandleSubmit()
    {
        if (string.IsNullOrWhiteSpace(_model.KeyName))
        {
            _errorMessage = "Key name is required";
            return;
        }

        _isSubmitting = true;
        _errorMessage = null;

        try
        {
            // Set default value if provided
            if (!string.IsNullOrEmpty(_defaultValue))
            {
                _model.DefaultLanguageValue = _defaultValue;
            }

            var result = await ResourceService.CreateResourceKeyAsync(ProjectId, _model);

            if (result.IsSuccess && result.Data != null)
            {
                Snackbar.Add($"Key '{result.Data.KeyName}' created successfully!", Severity.Success);
                await OnKeyAdded.InvokeAsync(result.Data);
                Close();
            }
            else
            {
                _errorMessage = result.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isSubmitting = false;
        }
    }
}
