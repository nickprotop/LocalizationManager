@inject ResourceService ResourceService
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService

<RadzenStack Gap="1rem">
    <RadzenTemplateForm TItem="CreateResourceKeyRequest" Data="_model" Submit="HandleSubmit">
        <RadzenStack Gap="1rem">
            <RadzenFormField Text="Key Name" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                <ChildContent>
                    <RadzenTextBox @bind-Value="_model.KeyName" Placeholder="e.g., WelcomeMessage, Error.NotFound, Button.Save"
                                   Disabled="@_isSubmitting" Style="width: 100%;" Name="KeyName" />
                </ChildContent>
                <Helper>
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">e.g., WelcomeMessage, Error.NotFound, Button.Save</RadzenText>
                </Helper>
            </RadzenFormField>

            <RadzenFormField Text="Comment (optional)" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                <ChildContent>
                    <RadzenTextArea @bind-Value="_model.Comment" Placeholder="Description to help translators"
                                    Rows="2" Disabled="@_isSubmitting" Style="width: 100%;" />
                </ChildContent>
                <Helper>
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Description to help translators</RadzenText>
                </Helper>
            </RadzenFormField>

            <RadzenSwitch @bind-Value="_model.IsPlural" Disabled="@_isSubmitting">
                <Template>
                    <RadzenText>Plural key</RadzenText>
                </Template>
            </RadzenSwitch>

            @if (_model.IsPlural)
            {
                <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false" Size="AlertSize.Small">
                    Plural keys support different forms for quantities (zero, one, few, many, other).
                </RadzenAlert>
            }

            <RadzenFormField Text="Default Value" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                <ChildContent>
                    <RadzenTextArea @bind-Value="_defaultValue" Placeholder="Value for the default language"
                                    Rows="2" Disabled="@_isSubmitting" Style="width: 100%;" />
                </ChildContent>
                <Helper>
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Value for the default language</RadzenText>
                </Helper>
            </RadzenFormField>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <RadzenAlert AlertStyle="AlertStyle.Danger" Shade="Shade.Lighter" AllowClose="false" Size="AlertSize.Small">
                    @_errorMessage
                </RadzenAlert>
            }
        </RadzenStack>
    </RadzenTemplateForm>

    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem">
        <RadzenButton Variant="Radzen.Variant.Text" Text="Cancel" Click="@Close" Disabled="@_isSubmitting" />
        <RadzenButton ButtonStyle="ButtonStyle.Primary" Text="@(_isSubmitting ? "Creating..." : "Add Key")"
                      Click="@HandleSubmit" Disabled="@_isSubmitting" IsBusy="@_isSubmitting" />
    </RadzenStack>
</RadzenStack>

@code {
    [Parameter]
    public int ProjectId { get; set; }

    [Parameter]
    public EventCallback<ResourceKeyDto> OnKeyAdded { get; set; }

    private bool _isSubmitting;
    private string? _errorMessage;
    private string _defaultValue = string.Empty;
    private CreateResourceKeyRequest _model = new() { KeyName = "" };

    private void Close()
    {
        DialogService.Close(null);
    }

    private async Task HandleSubmit()
    {
        if (string.IsNullOrWhiteSpace(_model.KeyName))
        {
            _errorMessage = "Key name is required";
            return;
        }

        _isSubmitting = true;
        _errorMessage = null;

        try
        {
            // Set default value if provided
            if (!string.IsNullOrEmpty(_defaultValue))
            {
                _model.DefaultLanguageValue = _defaultValue;
            }

            var result = await ResourceService.CreateResourceKeyAsync(ProjectId, _model);

            if (result.IsSuccess && result.Data != null)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", $"Key '{result.Data.KeyName}' created successfully!");
                await OnKeyAdded.InvokeAsync(result.Data);
                DialogService.Close(result.Data);
            }
            else
            {
                _errorMessage = result.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isSubmitting = false;
        }
    }
}
