@using LrmCloud.Shared.DTOs.Projects
@using LrmCloud.Shared.DTOs.Sync
@using LrmCloud.Web.Services
@inject ProjectService ProjectService
@inject NotificationService NotificationService
@inject NavigationManager Navigation
@inject Radzen.DialogService DialogService

<RadzenStack Gap="1rem">
    <RadzenTabs @bind-SelectedIndex="_currentStep" RenderMode="TabRenderMode.Client">
        <Tabs>
            <RadzenTabsItem Text="1. Upload" Disabled="@(_currentStep > 0)">
                <RadzenStack Gap="1rem" Style="padding: 1rem;">
                    <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
                        Upload your localization files to create a new project. Supported formats:
                    </RadzenText>
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" Wrap="FlexWrap.Wrap">
                        <RadzenBadge BadgeStyle="BadgeStyle.Primary" Text=".resx" />
                        <RadzenBadge BadgeStyle="BadgeStyle.Info" Text=".json" />
                        <RadzenBadge BadgeStyle="BadgeStyle.Success" Text=".xml (Android)" />
                        <RadzenBadge BadgeStyle="BadgeStyle.Warning" Text=".strings (iOS)" />
                    </RadzenStack>

                    <RadzenCard Style="border: 2px dashed var(--rz-base); padding: 2rem; text-align: center; cursor: pointer;">
                        <InputFile OnChange="OnFilesChanged" multiple accept=".resx,.json,.xml,.strings,.stringsdict"
                                   style="position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer;" />
                        <RadzenStack AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                            <RadzenIcon Icon="cloud_upload" Style="font-size: 3rem; color: var(--rz-secondary);" />
                            <RadzenText TextStyle="TextStyle.Body1">Drop files here or click to browse</RadzenText>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                .resx, .json, .xml (Android), .strings (iOS) files (max 50 files)
                            </RadzenText>
                        </RadzenStack>
                    </RadzenCard>

                    @if (_uploadedFiles.Any())
                    {
                        <RadzenText TextStyle="TextStyle.Subtitle2">Selected Files (@_uploadedFiles.Count)</RadzenText>
                        <RadzenDataGrid TItem="IBrowserFile" Data="@_uploadedFiles" Density="Density.Compact" AllowSorting="false">
                            <Columns>
                                <RadzenDataGridColumn TItem="IBrowserFile" Title="File">
                                    <Template Context="file">
                                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                                            <RadzenIcon Icon="@GetFileIcon(file.Name)" />
                                            <RadzenText TextStyle="TextStyle.Body2">@file.Name</RadzenText>
                                        </RadzenStack>
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="IBrowserFile" Title="Size" Width="80px">
                                    <Template Context="file">
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">@FormatFileSize(file.Size)</RadzenText>
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="IBrowserFile" Width="40px">
                                    <Template Context="file">
                                        <RadzenButton Icon="close" Variant="Radzen.Variant.Text" Size="ButtonSize.Small"
                                                      Click="@(() => RemoveFile(file))" />
                                    </Template>
                                </RadzenDataGridColumn>
                            </Columns>
                        </RadzenDataGrid>

                        <RadzenButton ButtonStyle="ButtonStyle.Primary" Text="Next: Configure"
                                      Click="@(() => _currentStep = 1)" />
                    }
                </RadzenStack>
            </RadzenTabsItem>

            <RadzenTabsItem Text="2. Configure" Disabled="@(_currentStep < 1)">
                <RadzenStack Gap="1rem" Style="padding: 1rem;">
                    <RadzenFormField Text="Project ID" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenTextBox @bind-Value="_projectSlug" Style="width: 100%;" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">URL-friendly ID (lowercase, no spaces, e.g., my-project)</RadzenText>
                        </Helper>
                    </RadzenFormField>

                    <RadzenFormField Text="Display Name" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenTextBox @bind-Value="_projectName" Style="width: 100%;" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Human-readable name for display</RadzenText>
                        </Helper>
                    </RadzenFormField>

                    <RadzenFormField Text="Description (optional)" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenTextArea @bind-Value="_projectDescription" Rows="2" Style="width: 100%;" />
                        </ChildContent>
                    </RadzenFormField>

                    <RadzenFormField Text="Format" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenDropDown @bind-Value="_detectedFormat" Style="width: 100%;"
                                            Data="@_formatOptions" TextProperty="Text" ValueProperty="Value" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Auto-detected from files</RadzenText>
                        </Helper>
                    </RadzenFormField>

                    <RadzenFormField Text="Default Language" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenTextBox @bind-Value="_defaultLanguage" Style="width: 100%;" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">e.g., en, en-US (auto-detected)</RadzenText>
                        </Helper>
                    </RadzenFormField>

                    @if (_detectedLanguages.Any())
                    {
                        <RadzenStack Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Subtitle2">Detected Languages</RadzenText>
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" Wrap="FlexWrap.Wrap">
                                @foreach (var lang in _detectedLanguages)
                                {
                                    <RadzenBadge BadgeStyle="@(lang == _defaultLanguage ? BadgeStyle.Primary : BadgeStyle.Light)"
                                                 Text="@(lang == _defaultLanguage ? $"{lang} (default)" : lang)" />
                                }
                            </RadzenStack>
                        </RadzenStack>
                    }

                    @if (_parseErrors.Any())
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Warning" Shade="Shade.Lighter" AllowClose="false" Size="AlertSize.Small">
                            <RadzenText TextStyle="TextStyle.Body2">Some files had issues:</RadzenText>
                            <ul style="margin: 0; padding-left: 1.5rem;">
                                @foreach (var error in _parseErrors.Take(5))
                                {
                                    <li>@error</li>
                                }
                                @if (_parseErrors.Count > 5)
                                {
                                    <li>...and @(_parseErrors.Count - 5) more</li>
                                }
                            </ul>
                        </RadzenAlert>
                    }

                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
                        <RadzenButton Variant="Radzen.Variant.Outlined" Text="Back" Click="@(() => _currentStep = 0)" />
                        <RadzenButton ButtonStyle="ButtonStyle.Primary" Text="Next: Review"
                                      Disabled="@(string.IsNullOrWhiteSpace(_projectName))"
                                      Click="@(() => _currentStep = 2)" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenTabsItem>

            <RadzenTabsItem Text="3. Import" Disabled="@(_currentStep < 2)">
                <RadzenStack Gap="1rem" Style="padding: 1rem;">
                    @if (_isImporting)
                    {
                        <RadzenStack AlignItems="Radzen.AlignItems.Center" Gap="1rem">
                            <RadzenProgressBarCircular Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
                            <RadzenText TextStyle="TextStyle.H6">Importing project...</RadzenText>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                Processing @_uploadedFiles.Count files
                            </RadzenText>
                        </RadzenStack>
                    }
                    else if (_importComplete)
                    {
                        <RadzenStack AlignItems="Radzen.AlignItems.Center" Gap="1rem">
                            <RadzenIcon Icon="check_circle" Style="font-size: 4rem; color: var(--rz-success);" />
                            <RadzenText TextStyle="TextStyle.H6">Import Complete!</RadzenText>
                            <RadzenText class="rz-color-secondary">
                                Created project "@_projectName" with @_importedKeyCount keys
                                in @_detectedLanguages.Count languages.
                            </RadzenText>

                            <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false" Size="AlertSize.Small">
                                <RadzenText TextStyle="TextStyle.Body2">
                                    <strong>Sync with CLI:</strong> Use this command to keep your local files in sync:
                                </RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="font-family: monospace; margin-top: 0.5rem;">
                                    lrm cloud sync --project @_createdProject?.Id
                                </RadzenText>
                            </RadzenAlert>
                        </RadzenStack>
                    }
                    else
                    {
                        <RadzenStack AlignItems="Radzen.AlignItems.Center" Gap="1rem">
                            <RadzenText TextStyle="TextStyle.Body1">Ready to import:</RadzenText>
                            <RadzenDataGrid TItem="KeyValuePair<string, string>" Data="@GetSummaryItems()"
                                            Density="Density.Compact" AllowSorting="false">
                                <Columns>
                                    <RadzenDataGridColumn TItem="KeyValuePair<string, string>" Property="Key" Title="Property" />
                                    <RadzenDataGridColumn TItem="KeyValuePair<string, string>" Property="Value" Title="Value" />
                                </Columns>
                            </RadzenDataGrid>
                        </RadzenStack>
                    }
                </RadzenStack>
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Shade="Shade.Lighter" AllowClose="false" Size="AlertSize.Small">
            @_errorMessage
        </RadzenAlert>
    }

    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem">
        @if (_importComplete)
        {
            <RadzenButton Variant="Radzen.Variant.Text" Text="Close" Click="@Close" />
            <RadzenButton ButtonStyle="ButtonStyle.Primary" Text="Open Project"
                          Click="@(() => GoToProject(_createdProject?.Id ?? 0))" />
        }
        else
        {
            <RadzenButton Variant="Radzen.Variant.Text" Text="Cancel" Click="@Close" Disabled="@_isImporting" />
            @if (_currentStep == 2)
            {
                <RadzenButton ButtonStyle="ButtonStyle.Primary" Text="@(_isImporting ? "Importing..." : "Import")"
                              Click="@ImportProject" Disabled="@_isImporting" IsBusy="@_isImporting" />
            }
        }
    </RadzenStack>
</RadzenStack>

@code {
    [Parameter]
    public EventCallback<ProjectDto> OnProjectImported { get; set; }

    [Parameter]
    public int? OrganizationId { get; set; }

    private int _currentStep = 0;

    // Step 1: File upload
    private List<IBrowserFile> _uploadedFiles = new();

    // Step 2: Configuration
    private string _projectSlug = "";
    private string _projectName = "";
    private string _projectDescription = "";
    private string _detectedFormat = "resx";
    private string _defaultLanguage = "en";
    private List<string> _detectedLanguages = new();
    private List<string> _parseErrors = new();

    // Step 3: Import
    private bool _isImporting;
    private bool _importComplete;
    private int _importedKeyCount;
    private ProjectDto? _createdProject;
    private string? _errorMessage;

    private readonly List<object> _formatOptions = new()
    {
        new { Value = "resx", Text = ".resx (C#/.NET)" },
        new { Value = "json", Text = "JSON Localization" },
        new { Value = "i18next", Text = "i18next (JS/React)" },
        new { Value = "android", Text = "Android strings.xml" },
        new { Value = "ios", Text = "iOS .strings/.stringsdict" }
    };

    private void Close()
    {
        DialogService.Close(null);
    }

    private void OnFilesChanged(InputFileChangeEventArgs e)
    {
        _uploadedFiles = e.GetMultipleFiles(50).ToList();
        AnalyzeFiles();
        StateHasChanged();
    }

    private void RemoveFile(IBrowserFile file)
    {
        _uploadedFiles.Remove(file);
        AnalyzeFiles();
    }

    private void AnalyzeFiles()
    {
        _detectedLanguages.Clear();
        _parseErrors.Clear();

        if (!_uploadedFiles.Any()) return;

        var hasResx = _uploadedFiles.Any(f => f.Name.EndsWith(".resx", StringComparison.OrdinalIgnoreCase));
        var hasJson = _uploadedFiles.Any(f => f.Name.EndsWith(".json", StringComparison.OrdinalIgnoreCase));

        if (hasResx && !hasJson)
        {
            _detectedFormat = "resx";
            AnalyzeResxFiles();
        }
        else if (hasJson && !hasResx)
        {
            _detectedFormat = "json";
            AnalyzeJsonFiles();
        }
        else if (hasResx && hasJson)
        {
            _parseErrors.Add("Mixed file types detected. Please upload only .resx OR .json files.");
        }

        if (string.IsNullOrEmpty(_projectName) && _uploadedFiles.Any())
        {
            var firstFile = _uploadedFiles.First().Name;
            var baseName = System.IO.Path.GetFileNameWithoutExtension(firstFile);
            var dotIndex = baseName.LastIndexOf('.');
            if (dotIndex > 0)
            {
                var possibleLang = baseName[(dotIndex + 1)..];
                if (possibleLang.Length <= 5)
                {
                    baseName = baseName[..dotIndex];
                }
            }
            _projectName = baseName;
        }
    }

    private void AnalyzeResxFiles()
    {
        foreach (var file in _uploadedFiles)
        {
            var fileName = System.IO.Path.GetFileNameWithoutExtension(file.Name);
            var parts = fileName.Split('.');
            if (parts.Length >= 2)
            {
                var lang = parts[^1];
                if (lang.Length <= 5 && !lang.Equals("resx", StringComparison.OrdinalIgnoreCase))
                {
                    if (!_detectedLanguages.Contains(lang))
                        _detectedLanguages.Add(lang);
                }
            }
            else
            {
                if (!_detectedLanguages.Contains(_defaultLanguage))
                    _detectedLanguages.Insert(0, _defaultLanguage);
            }
        }

        if (!_detectedLanguages.Any())
            _detectedLanguages.Add(_defaultLanguage);
    }

    private void AnalyzeJsonFiles()
    {
        foreach (var file in _uploadedFiles)
        {
            var fileName = System.IO.Path.GetFileNameWithoutExtension(file.Name);

            if (fileName.Length <= 5)
            {
                if (!_detectedLanguages.Contains(fileName))
                    _detectedLanguages.Add(fileName);
            }
            else
            {
                var parts = fileName.Split('.');
                if (parts.Length >= 2)
                {
                    var lang = parts[^1];
                    if (lang.Length <= 5)
                    {
                        if (!_detectedLanguages.Contains(lang))
                            _detectedLanguages.Add(lang);
                    }
                }
            }
        }

        if (!_detectedLanguages.Any())
            _detectedLanguages.Add(_defaultLanguage);

        if (_detectedLanguages.Any())
            _defaultLanguage = _detectedLanguages.First();
    }

    private async Task ImportProject()
    {
        if (string.IsNullOrWhiteSpace(_projectName)) return;

        _isImporting = true;
        _errorMessage = null;

        try
        {
            var createRequest = new CreateProjectRequest
            {
                Slug = _projectSlug.Trim().ToLowerInvariant(),
                Name = _projectName.Trim(),
                Description = _projectDescription?.Trim(),
                DefaultLanguage = _defaultLanguage,
                OrganizationId = OrganizationId
            };

            var createResult = await ProjectService.CreateProjectAsync(createRequest);
            if (!createResult.IsSuccess || createResult.Data == null)
            {
                _errorMessage = createResult.ErrorMessage ?? "Failed to create project";
                return;
            }

            _createdProject = createResult.Data;

            var fileDtos = new List<FileDto>();
            foreach (var file in _uploadedFiles)
            {
                try
                {
                    await using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
                    using var reader = new StreamReader(stream);
                    var content = await reader.ReadToEndAsync();

                    fileDtos.Add(new FileDto
                    {
                        Path = file.Name,
                        Content = content
                    });
                }
                catch (Exception ex)
                {
                    _parseErrors.Add($"Failed to read {file.Name}: {ex.Message}");
                }
            }

            if (fileDtos.Count > 0)
            {
                var importResult = await ProjectService.ImportFilesAsync(_createdProject.Id, fileDtos);
                if (!importResult.IsSuccess)
                {
                    _parseErrors.Add($"Import warning: {importResult.ErrorMessage}");
                }
                else
                {
                    _importedKeyCount = importResult.Data?.KeyCount ?? 0;
                }
            }

            var updatedProject = await ProjectService.GetProjectAsync(_createdProject.Id);
            if (updatedProject != null)
            {
                _createdProject = updatedProject;
                _importedKeyCount = updatedProject.KeyCount;
            }

            _importComplete = true;

            await OnProjectImported.InvokeAsync(_createdProject);
            NotificationService.Notify(NotificationSeverity.Success, "Success", $"Project '{_projectName}' created with {_importedKeyCount} keys!");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Import failed: {ex.Message}";
        }
        finally
        {
            _isImporting = false;
        }
    }

    private void GoToProject(int projectId)
    {
        DialogService.Close(true);
        Navigation.NavigateTo($"projects/{projectId}");
    }

    private static string GetFileIcon(string fileName) =>
        fileName.EndsWith(".resx", StringComparison.OrdinalIgnoreCase)
            ? "code"
            : "data_object";

    private static string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024):F1} MB";
    }

    private List<KeyValuePair<string, string>> GetSummaryItems() => new()
    {
        new("Project Name", _projectName),
        new("Format", _detectedFormat),
        new("Files", _uploadedFiles.Count.ToString()),
        new("Languages", string.Join(", ", _detectedLanguages))
    };
}
