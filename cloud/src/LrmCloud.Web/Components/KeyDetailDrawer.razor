@using LrmCloud.Web.Models

<RadzenStack Gap="1rem">
    @* Key Name *@
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Start">
        <RadzenStack Gap="0">
            <RadzenText TextStyle="TextStyle.Overline" class="rz-color-secondary">Key Name</RadzenText>
            <RadzenText TextStyle="TextStyle.H6" Style="word-break: break-all;">@Row.KeyName</RadzenText>
        </RadzenStack>
        <RadzenButton Icon="content_copy" Variant="Radzen.Variant.Text" Size="ButtonSize.Small" Click="@CopyKeyName" />
    </RadzenStack>

    @* Status & Type *@
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
        <RadzenBadge BadgeStyle="@GetStatusBadgeStyle(Row.Status)" Text="@Row.Status.ToString()" />
        @if (Row.IsPlural)
        {
            <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@($"Plural ({GetPluralFormCount()} forms)")" />
        }
    </RadzenStack>

    @* Comment Preview *@
    @if (!string.IsNullOrEmpty(Row.Comment))
    {
        <RadzenStack Gap="0">
            <RadzenText TextStyle="TextStyle.Overline" class="rz-color-secondary">Comment</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" Style="font-style: italic;">
                @Row.Comment
            </RadzenText>
        </RadzenStack>
    }

    <hr />

    @* Translations Preview *@
    <RadzenText TextStyle="TextStyle.Subtitle2">Translations</RadzenText>

    <RadzenDataGrid TItem="TranslationPreviewRow" Data="@GetTranslationPreviewRows()" Density="Density.Compact" AllowSorting="false">
        <Columns>
            <RadzenDataGridColumn TItem="TranslationPreviewRow" Title="Lang" Width="70px">
                <Template Context="row">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Body2" Style="font-weight: 500;">@row.Language.ToUpperInvariant()</RadzenText>
                        @if (row.IsDefault)
                        {
                            <RadzenIcon Icon="star" Style="font-size: 1rem; color: var(--rz-warning);" />
                        }
                    </RadzenStack>
                </Template>
            </RadzenDataGridColumn>
            @if (Row.IsPlural)
            {
                <RadzenDataGridColumn TItem="TranslationPreviewRow" Title="Form" Width="50px">
                    <Template Context="row">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">@row.PluralForm</RadzenText>
                    </Template>
                </RadzenDataGridColumn>
            }
            <RadzenDataGridColumn TItem="TranslationPreviewRow" Title="Value">
                <Template Context="row">
                    @if (string.IsNullOrEmpty(row.Value))
                    {
                        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="font-style: italic;">(empty)</RadzenText>
                    }
                    else
                    {
                        <RadzenText TextStyle="TextStyle.Body2" Style="word-break: break-word;">@TruncateText(row.Value, 80)</RadzenText>
                    }
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="TranslationPreviewRow" Width="30px">
                <Template Context="row">
                    @if (row.ShowStatus)
                    {
                        @switch (row.Status)
                        {
                            case TranslationStatus.Complete:
                                <RadzenIcon Icon="check_circle" Style="font-size: 1rem; color: var(--rz-success);" />
                                break;
                            case TranslationStatus.Partial:
                                <RadzenIcon Icon="warning" Style="font-size: 1rem; color: var(--rz-warning);" />
                                break;
                            case TranslationStatus.Missing:
                                <RadzenIcon Icon="error" Style="font-size: 1rem; color: var(--rz-danger);" />
                                break;
                        }
                    }
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>

    <hr />

    @* Actions *@
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
        <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Danger"
                      Size="ButtonSize.Small" Icon="delete" Text="Delete" Click="@HandleDelete" />
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
            <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Primary"
                          Size="ButtonSize.Small" Icon="translate" Text="Translate" Click="@HandleTranslateAll" />
            <RadzenButton ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small"
                          Icon="edit" Text="Edit" Click="@HandleEdit" />
        </RadzenStack>
    </RadzenStack>
</RadzenStack>

@code {
    [Parameter]
    public required TranslationGridRow Row { get; set; }

    [Parameter]
    public List<string> Languages { get; set; } = new();

    [Parameter]
    public string DefaultLanguage { get; set; } = "en";

    [Parameter]
    public EventCallback<TranslationGridRow> OnEdit { get; set; }

    [Parameter]
    public EventCallback<TranslationGridRow> OnTranslate { get; set; }

    [Parameter]
    public EventCallback<TranslationGridRow> OnDelete { get; set; }

    [Inject]
    private NotificationService NotificationService { get; set; } = default!;

    [Inject]
    private IJSRuntime JS { get; set; } = default!;

    private int GetPluralFormCount()
    {
        if (!Row.IsPlural) return 0;

        return Row.Translations.Values
            .Where(t => !string.IsNullOrEmpty(t.PluralForm))
            .Select(t => t.PluralForm)
            .Distinct()
            .Count();
    }

    private List<TranslationPreviewRow> GetTranslationPreviewRows()
    {
        var rows = new List<TranslationPreviewRow>();

        foreach (var lang in Languages)
        {
            var isDefault = lang == DefaultLanguage;
            var status = GetLanguageStatus(lang);

            if (Row.IsPlural)
            {
                var pluralForms = GetPluralFormsForLanguage(lang);
                var isFirst = true;
                foreach (var (form, value) in pluralForms)
                {
                    rows.Add(new TranslationPreviewRow
                    {
                        Language = isFirst ? lang : "",
                        PluralForm = form,
                        Value = value,
                        IsDefault = isDefault && isFirst,
                        Status = status,
                        ShowStatus = isFirst
                    });
                    isFirst = false;
                }
            }
            else
            {
                var value = Row.Translations.GetValueOrDefault(lang)?.Value;
                rows.Add(new TranslationPreviewRow
                {
                    Language = lang,
                    PluralForm = "",
                    Value = value,
                    IsDefault = isDefault,
                    Status = status,
                    ShowStatus = true
                });
            }
        }

        return rows;
    }

    private List<(string Form, string? Value)> GetPluralFormsForLanguage(string lang)
    {
        var result = new List<(string Form, string? Value)>();

        foreach (var form in PluralForms.All)
        {
            var key = TranslationGridRow.GetKey(lang, form);
            if (Row.Translations.TryGetValue(key, out var cell))
            {
                result.Add((form, cell.Value));
            }
        }

        if (result.Count == 0)
        {
            result.Add((PluralForms.Other, null));
        }

        return result;
    }

    private TranslationStatus GetLanguageStatus(string lang)
    {
        if (lang == DefaultLanguage) return TranslationStatus.Complete;

        if (Row.IsPlural)
        {
            var langCells = Row.Translations.Values
                .Where(t => t.LanguageCode == lang && !string.IsNullOrEmpty(t.PluralForm))
                .ToList();

            if (!langCells.Any()) return TranslationStatus.Missing;

            var hasAll = langCells.All(c => !string.IsNullOrEmpty(c.Value));
            var hasAny = langCells.Any(c => !string.IsNullOrEmpty(c.Value));

            if (hasAll) return TranslationStatus.Complete;
            if (hasAny) return TranslationStatus.Partial;
            return TranslationStatus.Missing;
        }
        else
        {
            var cell = Row.Translations.GetValueOrDefault(lang);
            return string.IsNullOrEmpty(cell?.Value) ? TranslationStatus.Missing : TranslationStatus.Complete;
        }
    }

    private static string TruncateText(string text, int maxLength)
    {
        if (string.IsNullOrEmpty(text) || text.Length <= maxLength)
            return text;
        return text[..maxLength] + "...";
    }

    private static BadgeStyle GetStatusBadgeStyle(TranslationStatus status) => status switch
    {
        TranslationStatus.Complete => BadgeStyle.Success,
        TranslationStatus.Partial => BadgeStyle.Warning,
        TranslationStatus.Missing => BadgeStyle.Danger,
        _ => BadgeStyle.Light
    };

    private async Task CopyKeyName()
    {
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", Row.KeyName);
        NotificationService.Notify(NotificationSeverity.Success, "Copied", "Key name copied!");
    }

    private async Task HandleEdit()
    {
        await OnEdit.InvokeAsync(Row);
    }

    private async Task HandleTranslateAll()
    {
        await OnTranslate.InvokeAsync(Row);
    }

    private async Task HandleDelete()
    {
        await OnDelete.InvokeAsync(Row);
    }

    private class TranslationPreviewRow
    {
        public string Language { get; set; } = "";
        public string PluralForm { get; set; } = "";
        public string? Value { get; set; }
        public bool IsDefault { get; set; }
        public TranslationStatus Status { get; set; }
        public bool ShowStatus { get; set; }
    }
}
