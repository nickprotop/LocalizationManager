@using LrmCloud.Web.Models

<MudStack Spacing="3">
    @* Key Name *@
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
        <MudStack Spacing="0">
            <MudText Typo="Typo.overline" Color="Color.Secondary">Key Name</MudText>
            <MudText Typo="Typo.h6" Style="word-break: break-all;">@Row.KeyName</MudText>
        </MudStack>
        <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                       Size="Size.Small"
                       OnClick="@CopyKeyName" />
    </MudStack>

    @* Status & Type *@
    <MudStack Row="true" Spacing="2">
        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(Row.Status)">
            @Row.Status
        </MudChip>
        @if (Row.IsPlural)
        {
            <MudChip T="string" Size="Size.Small" Color="Color.Info">
                Plural (@GetPluralFormCount() forms)
            </MudChip>
        }
    </MudStack>

    @* Comment Preview *@
    @if (!string.IsNullOrEmpty(Row.Comment))
    {
        <MudStack Spacing="0">
            <MudText Typo="Typo.overline" Color="Color.Secondary">Comment</MudText>
            <MudText Typo="Typo.body2" Style="font-style: italic;">
                @Row.Comment
            </MudText>
        </MudStack>
    }

    <MudDivider />

    @* Translations Preview *@
    <MudText Typo="Typo.subtitle2">Translations</MudText>

    <MudSimpleTable Dense="true" Hover="true" Style="background: transparent;">
        <tbody>
            @foreach (var lang in Languages)
            {
                var isDefault = lang == DefaultLanguage;
                var status = GetLanguageStatus(lang);

                @if (Row.IsPlural)
                {
                    @* For plural keys, show each form *@
                    var pluralForms = GetPluralFormsForLanguage(lang);
                    var isFirst = true;
                    @foreach (var (form, value) in pluralForms)
                    {
                        <tr>
                            <td style="width: 70px; vertical-align: top; padding: 8px 4px;">
                                @if (isFirst)
                                {
                                    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                        <MudText Typo="Typo.body2" Style="font-weight: 500;">
                                            @lang.ToUpperInvariant()
                                        </MudText>
                                        @if (isDefault)
                                        {
                                            <MudIcon Icon="@Icons.Material.Filled.Star" Size="Size.Small" Color="Color.Warning" />
                                        }
                                    </MudStack>
                                    isFirst = false;
                                }
                            </td>
                            <td style="width: 50px; vertical-align: top; padding: 8px 4px;">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@form</MudText>
                            </td>
                            <td style="vertical-align: top; padding: 8px 4px;">
                                @if (string.IsNullOrEmpty(value))
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Secondary" Style="font-style: italic;">
                                        (empty)
                                    </MudText>
                                }
                                else
                                {
                                    <MudText Typo="Typo.body2" Style="word-break: break-word;">
                                        @TruncateText(value, 80)
                                    </MudText>
                                }
                            </td>
                            <td style="width: 30px; text-align: center; vertical-align: top; padding: 8px 4px;">
                                @if (isFirst || pluralForms.Count == 1)
                                {
                                    @switch (status)
                                    {
                                        case TranslationStatus.Complete:
                                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Color="Color.Success" />
                                            break;
                                        case TranslationStatus.Partial:
                                            <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Small" Color="Color.Warning" />
                                            break;
                                        case TranslationStatus.Missing:
                                            <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Small" Color="Color.Error" />
                                            break;
                                    }
                                }
                            </td>
                        </tr>
                    }
                }
                else
                {
                    @* For single keys, show one row *@
                    var value = GetTranslationPreview(lang);
                    <tr>
                        <td style="width: 70px; vertical-align: top; padding: 8px 4px;">
                            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.body2" Style="font-weight: 500;">
                                    @lang.ToUpperInvariant()
                                </MudText>
                                @if (isDefault)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.Star" Size="Size.Small" Color="Color.Warning" />
                                }
                            </MudStack>
                        </td>
                        <td style="vertical-align: top; padding: 8px 4px;" colspan="2">
                            @if (string.IsNullOrEmpty(value))
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Style="font-style: italic;">
                                    (empty)
                                </MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Style="word-break: break-word;">
                                    @TruncateText(value, 100)
                                </MudText>
                            }
                        </td>
                        <td style="width: 30px; text-align: center; vertical-align: top; padding: 8px 4px;">
                            @switch (status)
                            {
                                case TranslationStatus.Complete:
                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Color="Color.Success" />
                                    break;
                                case TranslationStatus.Partial:
                                    <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Small" Color="Color.Warning" />
                                    break;
                                case TranslationStatus.Missing:
                                    <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Small" Color="Color.Error" />
                                    break;
                            }
                        </td>
                    </tr>
                }
            }
        </tbody>
    </MudSimpleTable>

    <MudDivider Class="my-2" />

    @* Actions *@
    <MudStack Row="true" Justify="Justify.SpaceBetween">
        <MudButton Variant="Variant.Outlined"
                   Color="Color.Error"
                   Size="Size.Small"
                   StartIcon="@Icons.Material.Filled.Delete"
                   OnClick="@HandleDelete">
            Delete
        </MudButton>
        <MudStack Row="true" Spacing="2">
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Primary"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Translate"
                       OnClick="@HandleTranslateAll">
                Translate
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Edit"
                       OnClick="@HandleEdit">
                Edit
            </MudButton>
        </MudStack>
    </MudStack>
</MudStack>

@code {
    [Parameter]
    public required TranslationGridRow Row { get; set; }

    [Parameter]
    public List<string> Languages { get; set; } = new();

    [Parameter]
    public string DefaultLanguage { get; set; } = "en";

    [Parameter]
    public EventCallback<TranslationGridRow> OnEdit { get; set; }

    [Parameter]
    public EventCallback<TranslationGridRow> OnTranslate { get; set; }

    [Parameter]
    public EventCallback<TranslationGridRow> OnDelete { get; set; }

    [Inject]
    private ISnackbar Snackbar { get; set; } = default!;

    [Inject]
    private IJSRuntime JS { get; set; } = default!;

    private int GetPluralFormCount()
    {
        if (!Row.IsPlural) return 0;

        return Row.Translations.Values
            .Where(t => !string.IsNullOrEmpty(t.PluralForm))
            .Select(t => t.PluralForm)
            .Distinct()
            .Count();
    }

    private string? GetTranslationPreview(string lang)
    {
        if (Row.IsPlural)
        {
            // For plural keys, show the "other" form or first available
            var otherKey = TranslationGridRow.GetKey(lang, PluralForms.Other);
            var otherCell = Row.Translations.GetValueOrDefault(otherKey);
            if (!string.IsNullOrEmpty(otherCell?.Value))
                return otherCell.Value;

            // Fall back to any plural form with a value
            return Row.Translations.Values
                .Where(t => t.LanguageCode == lang && !string.IsNullOrEmpty(t.Value))
                .Select(t => t.Value)
                .FirstOrDefault();
        }
        else
        {
            return Row.Translations.GetValueOrDefault(lang)?.Value;
        }
    }

    /// <summary>
    /// Gets all plural forms with their values for a language.
    /// Returns forms in standard order (one, other, zero, two, few, many).
    /// </summary>
    private List<(string Form, string? Value)> GetPluralFormsForLanguage(string lang)
    {
        var result = new List<(string Form, string? Value)>();

        foreach (var form in PluralForms.All)
        {
            var key = TranslationGridRow.GetKey(lang, form);
            if (Row.Translations.TryGetValue(key, out var cell))
            {
                result.Add((form, cell.Value));
            }
        }

        // If no forms found, return at least "other" as empty
        if (result.Count == 0)
        {
            result.Add((PluralForms.Other, null));
        }

        return result;
    }

    private TranslationStatus GetLanguageStatus(string lang)
    {
        if (lang == DefaultLanguage) return TranslationStatus.Complete;

        if (Row.IsPlural)
        {
            var langCells = Row.Translations.Values
                .Where(t => t.LanguageCode == lang && !string.IsNullOrEmpty(t.PluralForm))
                .ToList();

            if (!langCells.Any()) return TranslationStatus.Missing;

            var hasAll = langCells.All(c => !string.IsNullOrEmpty(c.Value));
            var hasAny = langCells.Any(c => !string.IsNullOrEmpty(c.Value));

            if (hasAll) return TranslationStatus.Complete;
            if (hasAny) return TranslationStatus.Partial;
            return TranslationStatus.Missing;
        }
        else
        {
            var cell = Row.Translations.GetValueOrDefault(lang);
            return string.IsNullOrEmpty(cell?.Value) ? TranslationStatus.Missing : TranslationStatus.Complete;
        }
    }

    private static string TruncateText(string text, int maxLength)
    {
        if (string.IsNullOrEmpty(text) || text.Length <= maxLength)
            return text;
        return text[..maxLength] + "...";
    }

    private static Color GetStatusColor(TranslationStatus status) => status switch
    {
        TranslationStatus.Complete => Color.Success,
        TranslationStatus.Partial => Color.Warning,
        TranslationStatus.Missing => Color.Error,
        _ => Color.Default
    };

    private async Task CopyKeyName()
    {
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", Row.KeyName);
        Snackbar.Add("Key name copied!", Severity.Success);
    }

    private async Task HandleEdit()
    {
        await OnEdit.InvokeAsync(Row);
    }

    private async Task HandleTranslateAll()
    {
        await OnTranslate.InvokeAsync(Row);
    }

    private async Task HandleDelete()
    {
        await OnDelete.InvokeAsync(Row);
    }
}
