@* Update available banner - shows when a new version is ready *@
@inject IJSRuntime JS
@implements IAsyncDisposable

@if (_updateAvailable)
{
    <div style="background: var(--rz-info-lighter); border: 1px solid var(--rz-info); border-radius: 4px; padding: 0.75rem 1rem; margin-bottom: 1rem;">
        <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <RadzenIcon Icon="system_update" Style="color: var(--rz-info);" />
                <span style="font-weight: 500;">A new version is available!</span>
            </div>
            <button type="button" @onclick="ApplyUpdate" disabled="@_updating"
                    style="background: var(--rz-primary); color: white; border: none; border-radius: 4px; padding: 0.5rem 1rem; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                @if (_updating)
                {
                    <span>Updating...</span>
                }
                else
                {
                    <RadzenIcon Icon="refresh" Style="font-size: 1rem;" />
                    <span>Refresh Now</span>
                }
            </button>
        </div>
    </div>
}

@code {
    private bool _updateAvailable;
    private bool _updating;
    private DotNetObjectReference<UpdateAvailableBanner>? _dotNetRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("lrmServiceWorker.init", _dotNetRef);
        }
    }

    [JSInvokable]
    public void OnUpdateAvailable()
    {
        _updateAvailable = true;
        StateHasChanged();
    }

    private async Task ApplyUpdate()
    {
        _updating = true;
        StateHasChanged();
        await JS.InvokeVoidAsync("lrmServiceWorker.applyUpdate");
        // Page reloads automatically via controllerchange event
    }

    public async ValueTask DisposeAsync()
    {
        if (_dotNetRef != null)
        {
            try
            {
                await JS.InvokeVoidAsync("lrmServiceWorker.dispose");
            }
            catch
            {
                // Ignore errors during disposal
            }
            _dotNetRef.Dispose();
        }
    }
}
