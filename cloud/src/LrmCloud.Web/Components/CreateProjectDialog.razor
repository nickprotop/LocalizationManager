@inject ProjectService ProjectService
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService

<RadzenStack Gap="1rem">
    <RadzenTemplateForm TItem="CreateProjectRequest" Data="_model" Submit="HandleSubmit">
        <RadzenStack Gap="1rem">
            <RadzenFormField Text="Project ID" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                <ChildContent>
                    <RadzenTextBox @bind-Value="_model.Slug" Placeholder="my-project"
                                   Disabled="@_isSubmitting" Style="width: 100%;" />
                </ChildContent>
                <Helper>
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">URL-friendly ID (lowercase, no spaces, e.g., my-project)</RadzenText>
                </Helper>
            </RadzenFormField>

            <RadzenFormField Text="Display Name" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                <ChildContent>
                    <RadzenTextBox @bind-Value="_model.Name" Placeholder="My Project"
                                   Disabled="@_isSubmitting" Style="width: 100%;" />
                </ChildContent>
                <Helper>
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Human-readable name for display</RadzenText>
                </Helper>
            </RadzenFormField>

            <RadzenFormField Text="Description" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                <ChildContent>
                    <RadzenTextArea @bind-Value="_model.Description" Rows="2"
                                    Disabled="@_isSubmitting" Style="width: 100%;" />
                </ChildContent>
            </RadzenFormField>

            <RadzenFormField Text="Default Language" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                <ChildContent>
                    <RadzenTextBox @bind-Value="_model.DefaultLanguage" Placeholder="en"
                                   Disabled="@_isSubmitting" Style="width: 100%;" />
                </ChildContent>
                <Helper>
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Source language for translations (e.g., en, en-US). Cannot be changed after creation.</RadzenText>
                </Helper>
            </RadzenFormField>

            <details>
                <summary style="cursor: pointer; font-weight: 500; margin-bottom: 0.5rem;">GitHub Integration (Optional)</summary>
                <RadzenStack Gap="1rem" Style="margin-top: 0.5rem;">
                    <RadzenFormField Text="GitHub Repository" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenTextBox @bind-Value="_model.GitHubRepo" Placeholder="owner/repo"
                                           Disabled="@_isSubmitting" Style="width: 100%;" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">e.g., owner/repo</RadzenText>
                        </Helper>
                    </RadzenFormField>

                    <RadzenFormField Text="Default Branch" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenTextBox @bind-Value="_model.GitHubDefaultBranch" Placeholder="main"
                                           Disabled="@_isSubmitting" Style="width: 100%;" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">e.g., main</RadzenText>
                        </Helper>
                    </RadzenFormField>

                    <RadzenFormField Text="Localization Path" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenTextBox @bind-Value="_model.GitHubBasePath" Placeholder="."
                                           Disabled="@_isSubmitting" Style="width: 100%;" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Path in repo where localization files are located (e.g., src/locales)</RadzenText>
                        </Helper>
                    </RadzenFormField>

                    <RadzenFormField Text="Format" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenDropDown @bind-Value="_model.GitHubFormat" Style="width: 100%;"
                                            Data="@_formatDropdownOptions" TextProperty="Text" ValueProperty="Value"
                                            Disabled="@_isSubmitting" AllowClear="true" Placeholder="Auto-detect" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Leave empty to auto-detect from existing files</RadzenText>
                        </Helper>
                    </RadzenFormField>
                </RadzenStack>
            </details>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <RadzenAlert AlertStyle="AlertStyle.Danger" Shade="Shade.Lighter" AllowClose="false" Size="AlertSize.Small">
                    @_errorMessage
                </RadzenAlert>
            }
        </RadzenStack>
    </RadzenTemplateForm>

    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem">
        <RadzenButton Variant="Radzen.Variant.Text" Text="Cancel" Click="@Close" Disabled="@_isSubmitting" />
        <RadzenButton ButtonStyle="ButtonStyle.Primary" Text="@(_isSubmitting ? "Creating..." : "Create Project")"
                      Click="@HandleSubmit" Disabled="@_isSubmitting" IsBusy="@_isSubmitting" />
    </RadzenStack>
</RadzenStack>

@code {
    [Parameter]
    public EventCallback<ProjectDto> OnProjectCreated { get; set; }

    private bool _isSubmitting;
    private string? _errorMessage;
    private CreateProjectRequest _model = new() { Slug = "", Name = "", DefaultLanguage = "en" };

    private readonly List<object> _formatDropdownOptions = new()
    {
        new { Value = "resx", Text = ".resx (C#/.NET)" },
        new { Value = "json", Text = "JSON Localization" },
        new { Value = "i18next", Text = "i18next (JS/React)" },
        new { Value = "android", Text = "Android strings.xml" },
        new { Value = "ios", Text = "iOS .strings/.stringsdict" },
        new { Value = "po", Text = "GNU gettext (.po/.pot)" },
        new { Value = "xliff", Text = "XLIFF (.xliff/.xlf)" }
    };

    private void Close()
    {
        DialogService.Close(null);
    }

    private async Task HandleSubmit()
    {
        _isSubmitting = true;
        _errorMessage = null;

        try
        {
            var result = await ProjectService.CreateProjectAsync(_model);

            if (result.IsSuccess && result.Data != null)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", $"Project '{result.Data.Name}' created successfully!");
                await OnProjectCreated.InvokeAsync(result.Data);
                DialogService.Close(result.Data);
            }
            else
            {
                _errorMessage = result.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isSubmitting = false;
        }
    }
}
