@inject ProjectService ProjectService
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService

<RadzenStack Gap="1rem">
    <RadzenTemplateForm TItem="CreateProjectRequest" Data="_model" Submit="HandleSubmit">
        <RadzenStack Gap="1rem">
            <RadzenFormField Text="Project ID" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                <ChildContent>
                    <RadzenTextBox @bind-Value="_model.Slug" Placeholder="my-project"
                                   Disabled="@_isSubmitting" Style="width: 100%;" />
                </ChildContent>
                <Helper>
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">URL-friendly ID (lowercase, no spaces, e.g., my-project)</RadzenText>
                </Helper>
            </RadzenFormField>

            <RadzenFormField Text="Display Name" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                <ChildContent>
                    <RadzenTextBox @bind-Value="_model.Name" Placeholder="My Project"
                                   Disabled="@_isSubmitting" Style="width: 100%;" />
                </ChildContent>
                <Helper>
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Human-readable name for display</RadzenText>
                </Helper>
            </RadzenFormField>

            <RadzenFormField Text="Description" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                <ChildContent>
                    <RadzenTextArea @bind-Value="_model.Description" Rows="2"
                                    Disabled="@_isSubmitting" Style="width: 100%;" />
                </ChildContent>
            </RadzenFormField>

            <RadzenFormField Text="Format" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                <ChildContent>
                    <RadzenDropDown @bind-Value="_model.Format" Style="width: 100%;"
                                    Data="@_formatDropdownOptions" TextProperty="Text" ValueProperty="Value"
                                    Disabled="@_isSubmitting" Change="@OnFormatChanged" />
                </ChildContent>
            </RadzenFormField>

            <RadzenFormField Text="Default Language" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                <ChildContent>
                    <RadzenTextBox @bind-Value="_model.DefaultLanguage" Placeholder="en"
                                   Disabled="@_isSubmitting" Style="width: 100%;" />
                </ChildContent>
                <Helper>
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">e.g., en, en-US</RadzenText>
                </Helper>
            </RadzenFormField>

            <RadzenFormField Text="Localization Path" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                <ChildContent>
                    <RadzenTextBox @bind-Value="_model.LocalizationPath" Placeholder="."
                                   Disabled="@_isSubmitting" Style="width: 100%;" />
                </ChildContent>
                <Helper>
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Relative path to localization files</RadzenText>
                </Helper>
            </RadzenFormField>

            @* Format-specific options *@
            @if (HasFormatOptions)
            {
                <details open="@_formatOptionsOpen">
                    <summary style="cursor: pointer; font-weight: 500; margin-bottom: 0.5rem;" @onclick="() => _formatOptionsOpen = !_formatOptionsOpen">Format Options</summary>
                    <RadzenStack Gap="0.75rem" Style="margin-top: 0.5rem;">
                        @switch (_model.Format)
                        {
                            case "po":
                                <RadzenFormField Text="Domain" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                                    <ChildContent>
                                        <RadzenTextBox @bind-Value="_formatOptions.PoDomain" Placeholder="messages"
                                                       Disabled="@_isSubmitting" Style="width: 100%;" />
                                    </ChildContent>
                                    <Helper>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">PO file domain name (e.g., messages, django)</RadzenText>
                                    </Helper>
                                </RadzenFormField>
                                <RadzenFormField Text="Folder Structure" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                                    <ChildContent>
                                        <RadzenDropDown @bind-Value="_formatOptions.PoFolderStructure" Style="width: 100%;"
                                                        Data="@_poFolderOptions" TextProperty="Text" ValueProperty="Value"
                                                        Disabled="@_isSubmitting" />
                                    </ChildContent>
                                    <Helper>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">GNU: locale/{'{'}lang{'}'}/LC_MESSAGES/, Flat: po/{'{'}lang{'}'}.po</RadzenText>
                                    </Helper>
                                </RadzenFormField>
                                <RadzenFormField Text="Key Strategy" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                                    <ChildContent>
                                        <RadzenDropDown @bind-Value="_formatOptions.PoKeyStrategy" Style="width: 100%;"
                                                        Data="@_poKeyStrategyOptions" TextProperty="Text" ValueProperty="Value"
                                                        Disabled="@_isSubmitting" />
                                    </ChildContent>
                                    <Helper>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">How to derive keys from PO entries</RadzenText>
                                    </Helper>
                                </RadzenFormField>
                                break;

                            case "xliff":
                                <RadzenFormField Text="XLIFF Version" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                                    <ChildContent>
                                        <RadzenDropDown @bind-Value="_formatOptions.XliffVersion" Style="width: 100%;"
                                                        Data="@_xliffVersionOptions" TextProperty="Text" ValueProperty="Value"
                                                        Disabled="@_isSubmitting" />
                                    </ChildContent>
                                </RadzenFormField>
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                    <RadzenCheckBox @bind-Value="_formatOptions.XliffBilingual" Disabled="@_isSubmitting" />
                                    <RadzenText>Bilingual files (include source text in all files)</RadzenText>
                                </RadzenStack>
                                break;

                            case "json":
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                    <RadzenCheckBox @bind-Value="_formatOptions.JsonNestedKeys" Disabled="@_isSubmitting" />
                                    <RadzenText>Use nested keys (e.g., common.buttons.save)</RadzenText>
                                </RadzenStack>
                                break;

                            case "resx":
                            case "android":
                            case "ios":
                                <RadzenFormField Text="Base Filename" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                                    <ChildContent>
                                        <RadzenTextBox @bind-Value="_formatOptions.BaseName" Placeholder="@GetDefaultBaseName()"
                                                       Disabled="@_isSubmitting" Style="width: 100%;" />
                                    </ChildContent>
                                    <Helper>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">@GetBaseNameHelp()</RadzenText>
                                    </Helper>
                                </RadzenFormField>
                                break;
                        }
                    </RadzenStack>
                </details>
            }

            <details>
                <summary style="cursor: pointer; font-weight: 500; margin-bottom: 0.5rem;">GitHub Integration (Optional)</summary>
                <RadzenStack Gap="1rem" Style="margin-top: 0.5rem;">
                    <RadzenFormField Text="GitHub Repository" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenTextBox @bind-Value="_model.GitHubRepo" Placeholder="owner/repo"
                                           Disabled="@_isSubmitting" Style="width: 100%;" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">e.g., owner/repo</RadzenText>
                        </Helper>
                    </RadzenFormField>

                    <RadzenFormField Text="Default Branch" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenTextBox @bind-Value="_model.GitHubDefaultBranch" Placeholder="main"
                                           Disabled="@_isSubmitting" Style="width: 100%;" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">e.g., main</RadzenText>
                        </Helper>
                    </RadzenFormField>
                </RadzenStack>
            </details>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <RadzenAlert AlertStyle="AlertStyle.Danger" Shade="Shade.Lighter" AllowClose="false" Size="AlertSize.Small">
                    @_errorMessage
                </RadzenAlert>
            }
        </RadzenStack>
    </RadzenTemplateForm>

    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem">
        <RadzenButton Variant="Radzen.Variant.Text" Text="Cancel" Click="@Close" Disabled="@_isSubmitting" />
        <RadzenButton ButtonStyle="ButtonStyle.Primary" Text="@(_isSubmitting ? "Creating..." : "Create Project")"
                      Click="@HandleSubmit" Disabled="@_isSubmitting" IsBusy="@_isSubmitting" />
    </RadzenStack>
</RadzenStack>

@code {
    [Parameter]
    public EventCallback<ProjectDto> OnProjectCreated { get; set; }

    private bool _isSubmitting;
    private bool _formatOptionsOpen = true;
    private string? _errorMessage;
    private CreateProjectRequest _model = new() { Slug = "", Name = "", Format = "resx", DefaultLanguage = "en", LocalizationPath = "." };
    private FormatOptionsDto _formatOptions = new();

    private readonly List<object> _formatDropdownOptions = new()
    {
        new { Value = "resx", Text = ".resx (C#/.NET)" },
        new { Value = "json", Text = "JSON Localization" },
        new { Value = "i18next", Text = "i18next (JS/React)" },
        new { Value = "android", Text = "Android strings.xml" },
        new { Value = "ios", Text = "iOS .strings/.stringsdict" },
        new { Value = "po", Text = "GNU gettext (.po/.pot)" },
        new { Value = "xliff", Text = "XLIFF (.xliff/.xlf)" }
    };

    private readonly List<object> _poFolderOptions = new()
    {
        new { Value = "gnu", Text = "GNU (locale/{lang}/LC_MESSAGES/)" },
        new { Value = "flat", Text = "Flat (po/{lang}.po)" }
    };

    private readonly List<object> _poKeyStrategyOptions = new()
    {
        new { Value = "auto", Text = "Auto (context if available, else msgid)" },
        new { Value = "msgid", Text = "Use msgid (source text as key)" },
        new { Value = "context", Text = "Use msgctxt (context as key)" }
    };

    private readonly List<object> _xliffVersionOptions = new()
    {
        new { Value = "2.0", Text = "XLIFF 2.0 (Recommended)" },
        new { Value = "1.2", Text = "XLIFF 1.2 (Legacy)" }
    };

    private bool HasFormatOptions => _model.Format is "po" or "xliff" or "json" or "resx" or "android" or "ios";

    private void OnFormatChanged(object value)
    {
        // Reset format options when format changes
        _formatOptions = new FormatOptionsDto
        {
            PoFolderStructure = "gnu",
            PoKeyStrategy = "auto",
            XliffVersion = "2.0"
        };
        StateHasChanged();
    }

    private string GetDefaultBaseName() => _model.Format switch
    {
        "resx" => "SharedResource",
        "android" => "strings",
        "ios" => "Localizable",
        _ => ""
    };

    private string GetBaseNameHelp() => _model.Format switch
    {
        "resx" => "e.g., SharedResource, Resources, Strings",
        "android" => "e.g., strings, messages",
        "ios" => "e.g., Localizable, InfoPlist",
        _ => ""
    };

    private void Close()
    {
        DialogService.Close(null);
    }

    private async Task HandleSubmit()
    {
        _isSubmitting = true;
        _errorMessage = null;

        try
        {
            // Attach format options to the model
            _model.FormatOptions = _formatOptions;
            var result = await ProjectService.CreateProjectAsync(_model);

            if (result.IsSuccess && result.Data != null)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", $"Project '{result.Data.Name}' created successfully!");
                await OnProjectCreated.InvokeAsync(result.Data);
                DialogService.Close(result.Data);
            }
            else
            {
                _errorMessage = result.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isSubmitting = false;
        }
    }
}
