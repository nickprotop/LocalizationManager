@using LrmCloud.Shared.DTOs.Billing
@using LrmCloud.Web.Helpers

<RadzenDataGrid TItem="PlanFeature" Data="@GetFeatures()" Density="Density.Compact" AllowSorting="false" AllowPaging="false">
    <Columns>
        <RadzenDataGridColumn TItem="PlanFeature" Property="Feature" Title="Feature" Width="200px" />
        <RadzenDataGridColumn TItem="PlanFeature" Title="Free" TextAlign="TextAlign.Center">
            <HeaderTemplate>
                <RadzenStack AlignItems="Radzen.AlignItems.Center">
                    <RadzenText>Free</RadzenText>
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">$@((Limits?.Free.Price ?? 0).ToString("0"))/mo</RadzenText>
                    @if (CurrentPlan?.ToLower() == "free")
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Primary" Text="Current" />
                    }
                </RadzenStack>
            </HeaderTemplate>
            <Template Context="feature">
                @if (feature.FreeValue == "check")
                {
                    <RadzenIcon Icon="check" Style="color: var(--rz-success);" />
                }
                else if (feature.FreeValue == "close")
                {
                    <RadzenIcon Icon="close" class="rz-color-secondary" />
                }
                else
                {
                    @feature.FreeValue
                }
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="PlanFeature" Title="Team" TextAlign="TextAlign.Center">
            <HeaderTemplate>
                <RadzenStack AlignItems="Radzen.AlignItems.Center">
                    <RadzenText>Team</RadzenText>
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">$@((Limits?.Team.Price ?? 9).ToString("0"))/mo</RadzenText>
                    @if (CurrentPlan?.ToLower() == "team")
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text="Current" />
                    }
                </RadzenStack>
            </HeaderTemplate>
            <Template Context="feature">
                @if (feature.TeamValue == "check")
                {
                    <RadzenIcon Icon="check" Style="color: var(--rz-success);" />
                }
                else if (feature.TeamValue == "close")
                {
                    <RadzenIcon Icon="close" class="rz-color-secondary" />
                }
                else
                {
                    @feature.TeamValue
                }
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="PlanFeature" Title="Enterprise" TextAlign="TextAlign.Center">
            <HeaderTemplate>
                <RadzenStack AlignItems="Radzen.AlignItems.Center">
                    <RadzenText>Enterprise</RadzenText>
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">$@((Limits?.Enterprise.Price ?? 29).ToString("0"))/mo</RadzenText>
                    @if (CurrentPlan?.ToLower() == "enterprise")
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Current" />
                    }
                </RadzenStack>
            </HeaderTemplate>
            <Template Context="feature">
                @if (feature.EnterpriseValue == "check")
                {
                    <RadzenIcon Icon="check" Style="color: var(--rz-success);" />
                }
                else if (feature.EnterpriseValue == "close")
                {
                    <RadzenIcon Icon="close" class="rz-color-secondary" />
                }
                else
                {
                    @feature.EnterpriseValue
                }
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@if (ShowUpgradeButtons && CurrentPlan?.ToLower() != "enterprise")
{
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.Center" Gap="0.5rem" class="rz-mt-4">
        @if (CurrentPlan?.ToLower() == "free")
        {
            <RadzenButton Variant="Radzen.Variant.Filled" ButtonStyle="ButtonStyle.Primary"
                          Click="@(() => OnUpgradeClick.InvokeAsync("team"))"
                          Text="@($"Upgrade to Team - ${(Limits?.Team.Price ?? 9).ToString("0")}/mo")" />
            <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Primary"
                          Click="@(() => OnUpgradeClick.InvokeAsync("enterprise"))"
                          Text="@($"Upgrade to Enterprise - ${(Limits?.Enterprise.Price ?? 29).ToString("0")}/mo")" />
        }
        else if (CurrentPlan?.ToLower() == "team")
        {
            <RadzenButton Variant="Radzen.Variant.Filled" ButtonStyle="ButtonStyle.Primary"
                          Click="@(() => OnUpgradeClick.InvokeAsync("enterprise"))"
                          Text="@($"Upgrade to Enterprise - ${(Limits?.Enterprise.Price ?? 29).ToString("0")}/mo")" />
        }
    </RadzenStack>
}

@code {
    [Parameter]
    public PlanLimitsDto? Limits { get; set; }

    [Parameter]
    public string? CurrentPlan { get; set; }

    [Parameter]
    public bool Dense { get; set; } = true;

    [Parameter]
    public bool ShowUpgradeButtons { get; set; } = false;

    [Parameter]
    public EventCallback<string> OnUpgradeClick { get; set; }

    private class PlanFeature
    {
        public string Feature { get; set; } = "";
        public string FreeValue { get; set; } = "";
        public string TeamValue { get; set; } = "";
        public string EnterpriseValue { get; set; } = "";
    }

    private List<PlanFeature> GetFeatures()
    {
        return new List<PlanFeature>
        {
            new() { Feature = "LRM Translation", FreeValue = $"{FormatChars(Limits?.Free.TranslationChars ?? 5000)}/mo", TeamValue = $"{FormatChars(Limits?.Team.TranslationChars ?? 50000)}/mo", EnterpriseValue = $"{FormatChars(Limits?.Enterprise.TranslationChars ?? 500000)}/mo" },
            new() { Feature = "BYOK Providers", FreeValue = $"{FormatChars(Limits?.Free.OtherChars ?? 25000)}/mo", TeamValue = $"{FormatChars(Limits?.Team.OtherChars ?? 250000)}/mo", EnterpriseValue = $"{FormatChars(Limits?.Enterprise.OtherChars ?? 2500000)}/mo" },
            new() { Feature = "Projects", FreeValue = FormatLimit(Limits?.Free.MaxProjects ?? 3), TeamValue = FormatLimit(Limits?.Team.MaxProjects ?? int.MaxValue), EnterpriseValue = FormatLimit(Limits?.Enterprise.MaxProjects ?? int.MaxValue) },
            new() { Feature = "Team Members", FreeValue = FormatLimit(Limits?.Free.MaxTeamMembers ?? 0), TeamValue = FormatLimit(Limits?.Team.MaxTeamMembers ?? 10), EnterpriseValue = FormatLimit(Limits?.Enterprise.MaxTeamMembers ?? int.MaxValue) },
            new() { Feature = "Cloud Storage", FreeValue = UiHelpers.FormatBytes(Limits?.Free.MaxStorageBytes ?? 26_214_400), TeamValue = UiHelpers.FormatBytes(Limits?.Team.MaxStorageBytes ?? 262_144_000), EnterpriseValue = UiHelpers.FormatBytes(Limits?.Enterprise.MaxStorageBytes ?? 524_288_000) },
            new() { Feature = "Max File Size", FreeValue = UiHelpers.FormatBytes(Limits?.Free.MaxFileSizeBytes ?? 1_048_576), TeamValue = UiHelpers.FormatBytes(Limits?.Team.MaxFileSizeBytes ?? 2_097_152), EnterpriseValue = UiHelpers.FormatBytes(Limits?.Enterprise.MaxFileSizeBytes ?? 5_242_880) },
            new() { Feature = "Snapshots (per project)", FreeValue = (Limits?.Free.MaxSnapshots ?? 3).ToString(), TeamValue = (Limits?.Team.MaxSnapshots ?? 10).ToString(), EnterpriseValue = (Limits?.Enterprise.MaxSnapshots ?? 30).ToString() },
            new() { Feature = "Snapshot Retention", FreeValue = $"{Limits?.Free.SnapshotRetentionDays ?? 7} days", TeamValue = $"{Limits?.Team.SnapshotRetentionDays ?? 30} days", EnterpriseValue = $"{Limits?.Enterprise.SnapshotRetentionDays ?? 90} days" },
            new() { Feature = "Translation Providers", FreeValue = "All", TeamValue = "All", EnterpriseValue = "All" },
            new() { Feature = "API Access", FreeValue = "check", TeamValue = "check", EnterpriseValue = "check" },
            new() { Feature = "Priority Support", FreeValue = "close", TeamValue = "check", EnterpriseValue = "check" }
        };
    }

    private static string FormatChars(long chars) => chars.ToString("N0");

    private static string FormatLimit(int limit) => limit switch
    {
        0 => "-",
        int.MaxValue => "Unlimited",
        _ => limit.ToString("N0")
    };
}
