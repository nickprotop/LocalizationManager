@using LrmCloud.Shared.DTOs.Organizations
@using LrmCloud.Web.Services
@inject OrganizationService OrganizationService
@inject OrganizationContextService OrgContext
@inject NavigationManager Navigation
@implements IDisposable

<AuthorizeView>
    <Authorized>
        @if (_organizations.Any() || _selectedOrgId == null)
        {
            <RadzenDropDown TValue="int?"
                            Value="@_selectedOrgId"
                            ValueChanged="@OnOrganizationChanged"
                            Data="@_dropdownItems"
                            TextProperty="Name"
                            ValueProperty="Id"
                            Placeholder="Personal"
                            Style="min-width: 150px;" />
        }
    </Authorized>
</AuthorizeView>

@code {
    private List<OrganizationDto> _organizations = new();
    private List<OrgDropdownItem> _dropdownItems = new();
    private int? _selectedOrgId;

    private class OrgDropdownItem
    {
        public int? Id { get; set; }
        public string Name { get; set; } = "";
    }

    protected override async Task OnInitializedAsync()
    {
        await OrgContext.InitializeAsync();
        _selectedOrgId = OrgContext.SelectedOrganizationId;

        await LoadOrganizations();
        BuildDropdownItems();
    }

    private async Task LoadOrganizations()
    {
        try
        {
            _organizations = await OrganizationService.GetOrganizationsAsync();
        }
        catch
        {
            _organizations = new List<OrganizationDto>();
        }
    }

    private void BuildDropdownItems()
    {
        _dropdownItems = new List<OrgDropdownItem>
        {
            new OrgDropdownItem { Id = null, Name = "Personal" }
        };

        foreach (var org in _organizations)
        {
            _dropdownItems.Add(new OrgDropdownItem { Id = org.Id, Name = org.Name });
        }
    }

    private async Task OnOrganizationChanged(int? orgId)
    {
        _selectedOrgId = orgId;
        await OrgContext.SetOrganizationAsync(orgId);
    }

    public void Dispose()
    {
        // No event subscriptions to clean up in this component
    }
}
