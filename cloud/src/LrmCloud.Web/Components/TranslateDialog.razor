@using LrmCloud.Shared.DTOs.Translation
@using LrmCloud.Shared.DTOs.TranslationMemory
@using LrmCloud.Shared.DTOs.Glossary
@using LrmCloud.Web.Services
@using System.Globalization
@inject TranslationService TranslationService
@inject TranslationMemoryService TmService
@inject GlossaryService GlossaryService
@inject LimitsService LimitsService
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService
@inject IJSRuntime JSRuntime

<RadzenStack Gap="1rem">
    @if (_isLoadingProviders)
    {
        <RadzenStack AlignItems="Radzen.AlignItems.Center" Gap="1rem" Style="padding: 2rem;">
            <RadzenProgressBarCircular Mode="ProgressBarMode.Indeterminate" />
            <RadzenText>Loading providers...</RadzenText>
        </RadzenStack>
    }
    else if (_currentStep == DialogStep.TmPreview)
    {
        @* TM Preview Step *@
        <RadzenStack Gap="1rem">
            @if (_isCheckingTm)
            {
                <RadzenStack AlignItems="Radzen.AlignItems.Center" Gap="1rem" Style="padding: 1rem;">
                    <RadzenProgressBarCircular Mode="ProgressBarMode.Indeterminate" />
                    <RadzenText>Checking Translation Memory...</RadzenText>
                </RadzenStack>
            }
            else
            {
                <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false" Size="AlertSize.Small">
                    Found <strong>@_tmMatches.Count</strong> TM matches.
                    Accept matches to use them (free), or skip to translate via provider.
                </RadzenAlert>

                @if (_tmMatches.Any())
                {
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenButton Variant="Radzen.Variant.Text" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small"
                                      Icon="check_circle" Text="@($"Accept All ({_tmMatches.Count(m => m.Value.IsAccepted ?? true)})")"
                                      Click="AcceptAllTmMatches" />
                        <RadzenButton Variant="Radzen.Variant.Text" Size="ButtonSize.Small"
                                      Icon="cancel" Text="Reject All" Click="RejectAllTmMatches" />
                    </RadzenStack>

                    <RadzenCard Style="max-height: 400px; overflow-y: auto; padding: 0;">
                        @foreach (var match in _tmMatches)
                        {
                            var key = match.Key;
                            var tmMatch = match.Value;
                            var isAccepted = tmMatch.IsAccepted ?? true;

                            <RadzenStack Gap="0.5rem" Style="padding: 0.5rem; border-bottom: 1px solid var(--rz-base-300);">
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" AlignItems="Radzen.AlignItems.Center">
                                        <RadzenCheckBox TValue="bool" Value="@isAccepted"
                                                        Change="@(v => ToggleTmMatch(key, v))" />
                                        <RadzenText TextStyle="TextStyle.Body2">
                                            <strong>@tmMatch.KeyName</strong>
                                            <span class="rz-color-secondary"> â†’ @tmMatch.TargetLanguage.ToUpperInvariant()</span>
                                        </RadzenText>
                                    </RadzenStack>
                                    <RadzenBadge BadgeStyle="@(tmMatch.Match.MatchPercent == 100 ? BadgeStyle.Success : BadgeStyle.Warning)"
                                                 Text="@($"{tmMatch.Match.MatchPercent}%")" />
                                </RadzenStack>

                                <RadzenStack Gap="0" Style="margin-left: 2rem;">
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                        Source: "@tmMatch.Match.SourceText"
                                    </RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" Style="@(isAccepted ? "color: var(--rz-success);" : "")">
                                        Translation: "@tmMatch.Match.TranslatedText"
                                    </RadzenText>
                                </RadzenStack>
                            </RadzenStack>
                        }
                    </RadzenCard>
                }

                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenText TextStyle="TextStyle.Body2">
                        <RadzenIcon Icon="memory" Style="font-size: 1rem; color: var(--rz-success);" />
                        <strong>@AcceptedTmCount</strong> from TM (free)
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2">
                        <RadzenIcon Icon="translate" Style="font-size: 1rem; color: var(--rz-primary);" />
                        <strong>@RemainingToTranslate</strong> via provider
                    </RadzenText>
                </RadzenStack>
            }
        </RadzenStack>
    }
    else if (_isTranslating)
    {
        <RadzenStack AlignItems="Radzen.AlignItems.Center" Gap="1rem" Style="padding: 2rem;">
            <RadzenProgressBarCircular Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
            <RadzenText TextStyle="TextStyle.H6">Translating...</RadzenText>
            <RadzenText class="rz-color-secondary">
                To @string.Join(", ", _selectedLanguages.Select(GetLanguageDisplayName))
            </RadzenText>
            <RadzenText class="rz-color-secondary">
                @RemainingToTranslate translations via @_selectedProvider
            </RadzenText>
            @if (_translationResult != null)
            {
                <RadzenText Style="color: var(--rz-info);">
                    @_translationResult.TranslatedCount translated, @_translationResult.FailedCount failed
                </RadzenText>
            }
        </RadzenStack>
    }
    else if (_translationResult != null)
    {
        <TranslationResultSummary Result="_translationResult" OnClose="CloseResult" />
    }
    else
    {
        @* Configuration Step *@
        <RadzenStack Gap="1rem">
            @if (!_providers.Any())
            {
                <RadzenAlert AlertStyle="AlertStyle.Warning" Shade="Shade.Lighter" AllowClose="false">
                    No translation providers configured. Please add an API key in Settings.
                </RadzenAlert>
            }
            else
            {
                @if (_usageWarning != null)
                {
                    <RadzenAlert AlertStyle="@(_usageBlocked ? AlertStyle.Danger : AlertStyle.Warning)" Shade="Shade.Lighter" AllowClose="false" Size="AlertSize.Small">
                        @_usageWarning
                        @if (_usageBlocked)
                        {
                            <a href="settings" style="margin-left: 0.5rem;">Upgrade Plan</a>
                        }
                    </RadzenAlert>
                }

                <RadzenStack Gap="0.25rem">
                    <RadzenText TextStyle="TextStyle.Subtitle1">
                        Translate @(_keysToTranslate.Count > 0 ? $"{_keysToTranslate.Count} keys" : "all keys")
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
                        From: <strong>@GetLanguageDisplayName(SourceLanguage)</strong> (@SourceLanguage.ToUpperInvariant())
                    </RadzenText>
                    @if (_selectedLanguages.Any())
                    {
                        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
                            To: @string.Join(", ", _selectedLanguages.Select(GetLanguageDisplayName))
                        </RadzenText>
                    }
                    @if (EstimatedCharacters > 0)
                    {
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                            ~@EstimatedCharacters.ToString("N0") characters
                        </RadzenText>
                    }
                </RadzenStack>

                <RadzenFormField Text="Translation Provider" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenDropDown @bind-Value="_selectedProvider" Style="width: 100%;"
                                        Data="@_providers.Where(p => p.IsConfigured)"
                                        TextProperty="DisplayName" ValueProperty="Name">
                            <Template Context="provider">
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                                    <RadzenIcon Icon="@GetProviderIcon(provider.Name)" Style="font-size: 1rem;" />
                                    <span>@provider.DisplayName</span>
                                    @if (provider.IsManagedProvider)
                                    {
                                        <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="Managed" />
                                    }
                                    else if (!provider.RequiresApiKey)
                                    {
                                        <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Free" />
                                    }
                                    @if (provider.ApiKeySource != null && !provider.IsManagedProvider)
                                    {
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">(@provider.ApiKeySource)</RadzenText>
                                    }
                                </RadzenStack>
                            </Template>
                        </RadzenDropDown>
                    </ChildContent>
                </RadzenFormField>

                <RadzenText TextStyle="TextStyle.Subtitle2">Target Languages</RadzenText>
                <RadzenStack Gap="0.5rem">
                    @foreach (var lang in AvailableLanguages.Where(l => l != SourceLanguage))
                    {
                        var langCode = lang;
                        var isSelected = _selectedLanguages.Contains(langCode);
                        var displayName = GetLanguageDisplayName(langCode);
                        var labelText = displayName != langCode.ToUpperInvariant()
                            ? $"{displayName} ({langCode.ToUpperInvariant()})"
                            : langCode.ToUpperInvariant();
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                            <RadzenCheckBox TValue="bool" Value="@isSelected" Change="@(v => ToggleLanguage(langCode))" />
                            <RadzenText TextStyle="TextStyle.Body2">@labelText</RadzenText>
                        </RadzenStack>
                    }
                </RadzenStack>

                @if (!_selectedLanguages.Any())
                {
                    <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false" Size="AlertSize.Small">
                        Select at least one target language
                    </RadzenAlert>
                }

                <hr />

                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                    <RadzenSwitch @bind-Value="_onlyMissing" />
                    <RadzenText TextStyle="TextStyle.Body2">Only translate missing translations</RadzenText>
                </RadzenStack>

                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                    <RadzenSwitch @bind-Value="_overwrite" Disabled="@_onlyMissing" />
                    <RadzenText TextStyle="TextStyle.Body2">Overwrite existing translations</RadzenText>
                </RadzenStack>

                <RadzenFormField Text="Context (optional)" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenTextArea @bind-Value="_context" Rows="2" Style="width: 100%;"
                                        Placeholder="Provide context for better AI translations..." />
                    </ChildContent>
                    <Helper>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Context helps AI providers produce more accurate translations</RadzenText>
                    </Helper>
                </RadzenFormField>

                <details>
                    <summary style="cursor: pointer; font-weight: 500;">Translation Memory Options</summary>
                    <RadzenStack Gap="0.75rem" Style="margin-top: 0.5rem;">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                            <RadzenSwitch @bind-Value="_useTm" />
                            <RadzenText TextStyle="TextStyle.Body2">Use Translation Memory</RadzenText>
                        </RadzenStack>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin-left: 2.5rem;">
                            Check TM for existing translations before calling the provider
                        </RadzenText>

                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                            <RadzenSwitch @bind-Value="_storeInTm" />
                            <RadzenText TextStyle="TextStyle.Body2">Store translations in TM</RadzenText>
                        </RadzenStack>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin-left: 2.5rem;">
                            Save new translations to TM for future reuse
                        </RadzenText>

                        <RadzenStack Gap="0.25rem">
                            <RadzenText TextStyle="TextStyle.Body2">
                                Minimum match: @_minMatchPercent%
                                @if (_minMatchPercent == 100) { <span>(exact only)</span> }
                                else { <span>(fuzzy)</span> }
                            </RadzenText>
                            <RadzenSlider @bind-Value="_minMatchPercent" Min="70" Max="100" Step="5"
                                          Disabled="@(!_useTm)" Style="width: 100%;" />
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                Lower values allow fuzzy matches (similar but not exact)
                            </RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                </details>

                @* Glossary Preview *@
                @if (_glossaryTerms.Any())
                {
                    <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false" Size="AlertSize.Small">
                        <strong>@_glossaryTerms.Count</strong> glossary terms will be applied automatically
                        @if (_glossaryTerms.Count <= 5)
                        {
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" Wrap="FlexWrap.Wrap" Style="margin-top: 0.5rem;">
                                @foreach (var term in _glossaryTerms.Take(5))
                                {
                                    <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="@term.SourceTerm" />
                                }
                            </RadzenStack>
                        }
                    </RadzenAlert>
                }
            }
        </RadzenStack>
    }

    @* Dialog Actions *@
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem">
        @if (_translationResult != null)
        {
            <RadzenButton Variant="Radzen.Variant.Text" Text="Translate More" Click="CloseResult" />
            <RadzenButton ButtonStyle="ButtonStyle.Primary" Text="Apply to Editor" Click="ApplyAndClose" />
        }
        else if (_currentStep == DialogStep.TmPreview)
        {
            <RadzenButton Variant="Radzen.Variant.Text" Text="Back" Click="BackToConfig" />
            <RadzenButton ButtonStyle="ButtonStyle.Primary" Disabled="@_isCheckingTm"
                          Text="@(RemainingToTranslate > 0 ? $"Translate {RemainingToTranslate} Remaining" : "Apply TM Matches")"
                          Click="ProceedWithTranslation" />
        }
        else
        {
            <RadzenButton Variant="Radzen.Variant.Text" Text="Cancel" Click="Cancel" />
            @if (_useTm)
            {
                <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Success"
                              Disabled="@(!CanTranslate)" Icon="memory" Text="Check TM First"
                              Click="CheckTmFirst" />
            }
            <RadzenButton ButtonStyle="ButtonStyle.Primary" Disabled="@(!CanTranslate)"
                          Text="Translate All" IsBusy="@_isTranslating" Click="StartTranslation" />
        }
    </RadzenStack>
</RadzenStack>

@code {
    [Parameter]
    public int ProjectId { get; set; }

    [Parameter]
    public string SourceLanguage { get; set; } = "en";

    [Parameter]
    public List<string> AvailableLanguages { get; set; } = new();

    [Parameter]
    public List<string> KeysToTranslate { get; set; } = new();

    [Parameter]
    public Dictionary<string, string>? SourceTexts { get; set; }

    [Parameter]
    public Dictionary<string, KeyTranslationMetadata>? KeyMetadata { get; set; }

    /// <summary>
    /// If true, translations are saved directly to database. If false, results are returned to caller.
    /// </summary>
    [Parameter]
    public bool SaveToDatabase { get; set; } = false;

    private enum DialogStep { Config, TmPreview, Translating, Results }
    private DialogStep _currentStep = DialogStep.Config;

    private List<TranslationProviderDto> _providers = new();
    private string? _selectedProvider;
    private HashSet<string> _selectedLanguages = new();
    private List<string> _keysToTranslate = new();
    private bool _onlyMissing = true;
    private bool _overwrite = false;
    private string? _context;
    private bool _isLoadingProviders = true;
    private bool _isTranslating = false;
    private bool _isCheckingTm = false;
    private TranslateResponseDto? _translationResult;
    private string? _usageWarning;
    private bool _usageBlocked;

    private bool _useTm = true;
    private bool _storeInTm = true;
    private int _minMatchPercent = 100;

    private Dictionary<string, TmPreviewMatch> _tmMatches = new();
    private List<TranslationResultDto> _acceptedTmResults = new();
    private List<GlossaryTermDto> _glossaryTerms = new();

    private const string ProviderStorageKey = "lrm_translate_provider";

    private bool CanTranslate => !_isLoadingProviders && !_isTranslating &&
                                  !string.IsNullOrEmpty(_selectedProvider) &&
                                  _selectedLanguages.Any() && !_usageBlocked;

    private int AcceptedTmCount => _tmMatches.Count(m => m.Value.IsAccepted ?? true);
    private int RemainingToTranslate => (_keysToTranslate.Count * _selectedLanguages.Count) - AcceptedTmCount;

    protected override async Task OnInitializedAsync()
    {
        _keysToTranslate = KeysToTranslate;
        _selectedLanguages = AvailableLanguages.Where(l => l != SourceLanguage).ToHashSet();
        await Task.WhenAll(LoadProvidersAsync(), CheckUsageLimitsAsync(), LoadGlossaryAsync());
    }

    private async Task CheckUsageLimitsAsync()
    {
        var (isWarning, isBlocked, message) = await LimitsService.GetTranslationUsageWarningAsync();
        if (isWarning)
        {
            _usageWarning = message;
            _usageBlocked = isBlocked;
        }
    }

    private async Task LoadGlossaryAsync()
    {
        try
        {
            var response = await GlossaryService.GetProjectGlossaryAsync(ProjectId, includeInherited: true);
            if (response?.Terms != null)
            {
                _glossaryTerms = response.Terms
                    .Where(t => t.SourceLanguage.Equals(SourceLanguage, StringComparison.OrdinalIgnoreCase))
                    .ToList();
            }
        }
        catch { }
    }

    private async Task LoadProvidersAsync()
    {
        _isLoadingProviders = true;
        try
        {
            _providers = await TranslationService.GetProvidersAsync(ProjectId);

            string? savedProvider = null;
            try { savedProvider = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", ProviderStorageKey); }
            catch { }

            var configuredProviders = _providers.Where(p => p.IsConfigured).ToList();
            if (!string.IsNullOrEmpty(savedProvider) && configuredProviders.Any(p => p.Name == savedProvider))
                _selectedProvider = savedProvider;
            else
                _selectedProvider = configuredProviders.FirstOrDefault()?.Name;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load providers: {ex.Message}");
        }
        finally
        {
            _isLoadingProviders = false;
        }
    }

    private void ToggleLanguage(string lang)
    {
        if (_selectedLanguages.Contains(lang)) _selectedLanguages.Remove(lang);
        else _selectedLanguages.Add(lang);
    }

    private async Task CheckTmFirst()
    {
        _currentStep = DialogStep.TmPreview;
        _isCheckingTm = true;
        _tmMatches.Clear();

        try
        {
            foreach (var keyName in _keysToTranslate)
            {
                string? sourceText = null;
                if (SourceTexts?.TryGetValue(keyName, out var provided) == true)
                    sourceText = provided;

                if (string.IsNullOrEmpty(sourceText)) continue;

                foreach (var targetLang in _selectedLanguages)
                {
                    var request = new TmLookupRequest
                    {
                        SourceText = sourceText,
                        SourceLanguage = SourceLanguage,
                        TargetLanguage = targetLang,
                        MinMatchPercent = _minMatchPercent,
                        MaxResults = 1
                    };

                    var result = await TmService.LookupAsync(request);
                    if (result.IsSuccess && result.Data?.Matches.Any() == true)
                    {
                        var match = result.Data.Matches.First();
                        var matchKey = $"{keyName}:{targetLang}";
                        _tmMatches[matchKey] = new TmPreviewMatch
                        {
                            KeyName = keyName,
                            TargetLanguage = targetLang,
                            Match = match,
                            IsAccepted = true
                        };
                    }
                }
            }

            if (_tmMatches.Any())
                NotificationService.Notify(NotificationSeverity.Success, "TM", $"Found {_tmMatches.Count} TM matches");
            else
                NotificationService.Notify(NotificationSeverity.Info, "TM", "No TM matches found");
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"TM check failed: {ex.Message}");
        }
        finally
        {
            _isCheckingTm = false;
        }
    }

    private void ToggleTmMatch(string key, bool accepted)
    {
        if (_tmMatches.TryGetValue(key, out var match))
            match.IsAccepted = accepted;
    }

    private void AcceptAllTmMatches()
    {
        foreach (var match in _tmMatches.Values) match.IsAccepted = true;
    }

    private void RejectAllTmMatches()
    {
        foreach (var match in _tmMatches.Values) match.IsAccepted = false;
    }

    private void BackToConfig()
    {
        _currentStep = DialogStep.Config;
        _tmMatches.Clear();
    }

    private async Task ProceedWithTranslation()
    {
        _acceptedTmResults.Clear();
        foreach (var (key, match) in _tmMatches.Where(m => m.Value.IsAccepted == true))
        {
            _acceptedTmResults.Add(new TranslationResultDto
            {
                Key = match.KeyName,
                TargetLanguage = match.TargetLanguage,
                SourceText = match.Match.SourceText,
                TranslatedText = match.Match.TranslatedText,
                Success = true,
                FromTm = true
            });
            _ = TmService.IncrementUseCountAsync(match.Match.Id);
        }

        var keysNeedingTranslation = new HashSet<string>();
        var languagesNeedingTranslation = new Dictionary<string, HashSet<string>>();

        foreach (var keyName in _keysToTranslate)
        {
            foreach (var targetLang in _selectedLanguages)
            {
                var matchKey = $"{keyName}:{targetLang}";
                var hasAcceptedTm = _tmMatches.TryGetValue(matchKey, out var match) && match.IsAccepted == true;

                if (!hasAcceptedTm)
                {
                    keysNeedingTranslation.Add(keyName);
                    if (!languagesNeedingTranslation.ContainsKey(keyName))
                        languagesNeedingTranslation[keyName] = new HashSet<string>();
                    languagesNeedingTranslation[keyName].Add(targetLang);
                }
            }
        }

        if (!keysNeedingTranslation.Any())
        {
            _translationResult = new TranslateResponseDto
            {
                Success = true,
                TranslatedCount = _acceptedTmResults.Count,
                TmCount = _acceptedTmResults.Count,
                Results = _acceptedTmResults,
                Provider = "Translation Memory"
            };
            _currentStep = DialogStep.Results;
            return;
        }

        _isTranslating = true;
        _currentStep = DialogStep.Translating;

        try
        {
            if (!string.IsNullOrEmpty(_selectedProvider))
            {
                try { await JSRuntime.InvokeVoidAsync("localStorage.setItem", ProviderStorageKey, _selectedProvider); }
                catch { }
            }

            var request = new TranslateRequestDto
            {
                Keys = keysNeedingTranslation.ToList(),
                TargetLanguages = _selectedLanguages.ToList(),
                SourceLanguage = SourceLanguage,
                Provider = _selectedProvider,
                OnlyMissing = _onlyMissing,
                Overwrite = _overwrite,
                Context = _context,
                SaveToDatabase = SaveToDatabase,
                SourceTexts = SourceTexts,
                KeyMetadata = KeyMetadata,
                TranslationMemory = new TmOptions
                {
                    UseTm = false,
                    StoreInTm = _storeInTm,
                    MinMatchPercent = _minMatchPercent
                }
            };

            _translationResult = await TranslationService.TranslateKeysAsync(ProjectId, request);
            _translationResult.Results.AddRange(_acceptedTmResults);
            _translationResult.TranslatedCount += _acceptedTmResults.Count;
            _translationResult.TmCount += _acceptedTmResults.Count;

            if (_translationResult.Success)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", $"Translated {_translationResult.TranslatedCount} keys");
                LimitsService.InvalidateCache();
                await CheckUsageLimitsAsync();
            }
            else if (_translationResult.Errors.Any())
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", _translationResult.Errors.First());
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Translation failed: {ex.Message}");
            _translationResult = new TranslateResponseDto
            {
                Success = _acceptedTmResults.Count > 0,
                Errors = [ex.Message],
                Results = _acceptedTmResults,
                TranslatedCount = _acceptedTmResults.Count,
                TmCount = _acceptedTmResults.Count
            };
        }
        finally
        {
            _isTranslating = false;
            _currentStep = DialogStep.Results;
        }
    }

    private async Task StartTranslation()
    {
        _isTranslating = true;
        _translationResult = null;

        try
        {
            if (!string.IsNullOrEmpty(_selectedProvider))
            {
                try { await JSRuntime.InvokeVoidAsync("localStorage.setItem", ProviderStorageKey, _selectedProvider); }
                catch { }
            }

            var request = new TranslateRequestDto
            {
                Keys = _keysToTranslate,
                TargetLanguages = _selectedLanguages.ToList(),
                SourceLanguage = SourceLanguage,
                Provider = _selectedProvider,
                OnlyMissing = _onlyMissing,
                Overwrite = _overwrite,
                Context = _context,
                SaveToDatabase = SaveToDatabase,
                SourceTexts = SourceTexts,
                KeyMetadata = KeyMetadata,
                TranslationMemory = new TmOptions
                {
                    UseTm = _useTm,
                    StoreInTm = _storeInTm,
                    MinMatchPercent = _minMatchPercent
                }
            };

            _translationResult = await TranslationService.TranslateKeysAsync(ProjectId, request);

            if (_translationResult.Success)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", $"Translated {_translationResult.TranslatedCount} keys");
                LimitsService.InvalidateCache();
                await CheckUsageLimitsAsync();
            }
            else if (_translationResult.Errors.Any())
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", _translationResult.Errors.First());
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Translation failed: {ex.Message}");
            _translationResult = new TranslateResponseDto { Success = false, Errors = [ex.Message] };
        }
        finally
        {
            _isTranslating = false;
        }
    }

    private void CloseResult()
    {
        _translationResult = null;
        _currentStep = DialogStep.Config;
        _tmMatches.Clear();
        _acceptedTmResults.Clear();
    }

    private void ApplyAndClose()
    {
        DialogService.Close(_translationResult);
    }

    private void Cancel()
    {
        DialogService.Close(null);
    }

    private static string GetProviderIcon(string provider) => provider switch
    {
        "google" => "language",
        "deepl" => "language",
        "openai" => "psychology",
        "claude" => "auto_awesome",
        "azuretranslator" or "azureopenai" => "cloud",
        "lingva" => "public",
        "mymemory" => "memory",
        "ollama" => "computer",
        "libretranslate" => "code",
        _ => "translate"
    };

    private class TmPreviewMatch
    {
        public required string KeyName { get; set; }
        public required string TargetLanguage { get; set; }
        public required TmMatchDto Match { get; set; }
        public bool? IsAccepted { get; set; } = true;
    }

    private int EstimatedCharacters => SourceTexts?
        .Where(kv => _keysToTranslate.Count == 0 || _keysToTranslate.Contains(kv.Key))
        .Sum(kv => (kv.Value?.Length ?? 0) * _selectedLanguages.Count) ?? 0;

    private static string GetLanguageDisplayName(string code)
    {
        if (string.IsNullOrWhiteSpace(code))
            return code;

        try
        {
            var culture = new CultureInfo(code);
            var name = culture.EnglishName;

            // Check for invalid/unknown cultures
            if (string.IsNullOrEmpty(name) || name.StartsWith("Unknown", StringComparison.OrdinalIgnoreCase))
                return code.ToUpperInvariant();

            // Get first word (e.g., "French" from "French (France)")
            var firstWord = name.Split(' ')[0];
            return string.IsNullOrEmpty(firstWord) ? code.ToUpperInvariant() : firstWord;
        }
        catch
        {
            return code.ToUpperInvariant();
        }
    }
}
