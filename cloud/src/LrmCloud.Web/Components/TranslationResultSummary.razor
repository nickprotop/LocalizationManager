@using LrmCloud.Shared.DTOs.Translation

<RadzenStack Gap="1rem">
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" JustifyContent="JustifyContent.Center">
        @if (Result.Success)
        {
            <RadzenIcon Icon="check_circle" Style="font-size: 2rem; color: var(--rz-success);" />
            <RadzenText TextStyle="TextStyle.H6" Style="color: var(--rz-success);">Translation Complete</RadzenText>
        }
        else
        {
            <RadzenIcon Icon="warning" Style="font-size: 2rem; color: var(--rz-warning);" />
            <RadzenText TextStyle="TextStyle.H6" Style="color: var(--rz-warning);">Translation Completed with Issues</RadzenText>
        }
    </RadzenStack>

    <hr />

    <RadzenRow Gap="0.5rem">
        <RadzenColumn Size="3">
            <RadzenCard Style="text-align: center; background: var(--rz-success-lighter);">
                <RadzenText TextStyle="TextStyle.H5" Style="color: var(--rz-success);">@Result.TranslatedCount</RadzenText>
                <RadzenText TextStyle="TextStyle.Caption">Translated</RadzenText>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="3">
            <RadzenCard Style="text-align: center; background: var(--rz-success-lighter);">
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.Center" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                    <RadzenIcon Icon="memory" Style="font-size: 1rem; color: var(--rz-success);" />
                    <RadzenText TextStyle="TextStyle.H5" Style="color: var(--rz-success);">@TmCount</RadzenText>
                </RadzenStack>
                <RadzenText TextStyle="TextStyle.Caption">From TM</RadzenText>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="3">
            <RadzenCard Style="text-align: center; background: var(--rz-warning-lighter);">
                <RadzenText TextStyle="TextStyle.H5" Style="color: var(--rz-warning);">@Result.SkippedCount</RadzenText>
                <RadzenText TextStyle="TextStyle.Caption">Skipped</RadzenText>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="3">
            <RadzenCard Style="text-align: center; background: var(--rz-danger-lighter);">
                <RadzenText TextStyle="TextStyle.H5" Style="color: var(--rz-danger);">@Result.FailedCount</RadzenText>
                <RadzenText TextStyle="TextStyle.Caption">Failed</RadzenText>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    @if (TmCount > 0)
    {
        <RadzenAlert AlertStyle="AlertStyle.Success" Shade="Shade.Lighter" AllowClose="false" Size="AlertSize.Small">
            @TmCount translation(s) reused from Translation Memory (no API cost)
        </RadzenAlert>
    }

    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" class="rz-mt-2">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" AlignItems="Radzen.AlignItems.Center">
            <RadzenIcon Icon="timer" Style="font-size: 1rem;" />
            <RadzenText TextStyle="TextStyle.Body2">@FormatElapsedTime(Result.ElapsedMs)</RadzenText>
        </RadzenStack>
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" AlignItems="Radzen.AlignItems.Center">
            <RadzenIcon Icon="text_fields" Style="font-size: 1rem;" />
            <RadzenText TextStyle="TextStyle.Body2">@Result.CharactersTranslated.ToString("N0") characters</RadzenText>
        </RadzenStack>
        <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text="@Result.Provider" />
    </RadzenStack>

    @if (Result.Errors.Any())
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Shade="Shade.Lighter" AllowClose="false" Size="AlertSize.Small">
            <RadzenText TextStyle="TextStyle.Body2">@string.Join(", ", Result.Errors.Take(3))</RadzenText>
            @if (Result.Errors.Count > 3)
            {
                <RadzenText TextStyle="TextStyle.Caption">...and @(Result.Errors.Count - 3) more errors</RadzenText>
            }
        </RadzenAlert>
    }

    @if (Result.Results.Any(r => !r.Success))
    {
        <details>
            <summary style="cursor: pointer; font-weight: 500;">Failed Translations (@Result.Results.Count(r => !r.Success))</summary>
            <RadzenDataGrid TItem="TranslationResultDto" Data="@Result.Results.Where(r => !r.Success).Take(10)"
                            Density="Density.Compact" Style="max-height: 200px; margin-top: 0.5rem;">
                <Columns>
                    <RadzenDataGridColumn TItem="TranslationResultDto" Property="Key" Title="Key" Width="120px" />
                    <RadzenDataGridColumn TItem="TranslationResultDto" Property="TargetLanguage" Title="Language" Width="80px" />
                    <RadzenDataGridColumn TItem="TranslationResultDto" Title="Error">
                        <Template Context="failed">
                            <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-danger);">@failed.Error</RadzenText>
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        </details>
    }
</RadzenStack>

@code {
    [Parameter, EditorRequired]
    public TranslateResponseDto Result { get; set; } = null!;

    [Parameter]
    public EventCallback OnClose { get; set; }

    /// <summary>
    /// Gets TM count from either DTO property or by counting results.
    /// Supports both server-returned TmCount and client-side merged results.
    /// </summary>
    private int TmCount => Result.TmCount > 0
        ? Result.TmCount
        : Result.Results.Count(r => r.FromTm);

    private static string FormatElapsedTime(long ms)
    {
        if (ms < 1000)
            return $"{ms}ms";
        if (ms < 60000)
            return $"{ms / 1000.0:F1}s";
        return $"{ms / 60000}m {(ms % 60000) / 1000}s";
    }
}
