@using LrmCloud.Shared.DTOs.Translation
@using LrmCloud.Web.Services
@inject TranslationService TranslationService
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService

<RadzenStack Gap="1rem">
    @if (!string.IsNullOrEmpty(Provider.Description))
    {
        <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false" Size="AlertSize.Small">
            @Provider.Description
        </RadzenAlert>
    }

    @if (_isLoading)
    {
        <RadzenProgressBar Value="100" Mode="ProgressBarMode.Indeterminate" ShowValue="false" Style="height: 200px;" />
    }
    else
    {
        @* API Key Section *@
        @if (Provider.RequiresApiKey || ShowApiKeyField)
        {
            <RadzenStack Gap="0.5rem">
                @if (_inheritedKeySource != null)
                {
                    <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false" Size="AlertSize.Small">
                        Using API key from <strong>@_inheritedKeySource</strong>
                    </RadzenAlert>
                }

                <RadzenFormField Text="@(Level == "user" && _inheritedKeySource != null ? "Override API Key (optional)" : "API Key")"
                                 Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.25rem" Style="width: 100%;">
                            <RadzenTextBox @bind-Value="_apiKey" Style="width: 100%;"
                                           Placeholder="@GetApiKeyPlaceholder()"
                                           type="@(_showKey ? "text" : "password")" />
                            <RadzenButton Icon="@(_showKey ? "visibility_off" : "visibility")"
                                          Variant="Radzen.Variant.Text" Click="@(() => _showKey = !_showKey)" />
                        </RadzenStack>
                    </ChildContent>
                    <Helper>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">@GetApiKeyHelpText(Provider.Name)</RadzenText>
                    </Helper>
                </RadzenFormField>

                @if (_existingConfig?.HasApiKey == true)
                {
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                        Current (this level): @_existingConfig.MaskedApiKey
                    </RadzenText>
                }
            </RadzenStack>
        }

        @* Provider-Specific Configuration *@
        @switch (Provider.Name.ToLowerInvariant())
        {
            case "ollama":
                <hr />
                <RadzenText TextStyle="TextStyle.Subtitle2" Style="color: var(--rz-primary);">Ollama Configuration</RadzenText>

                <RadzenFormField Text="API URL" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenTextBox @bind-Value="_ollamaApiUrl" Placeholder="http://localhost:11434" Style="width: 100%;" />
                    </ChildContent>
                    <Helper>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Ollama server URL. Default: http://localhost:11434</RadzenText>
                    </Helper>
                </RadzenFormField>

                <RadzenFormField Text="Model" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenTextBox @bind-Value="_ollamaModel" Placeholder="llama3.2" Style="width: 100%;" />
                    </ChildContent>
                    <Helper>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Model to use (e.g., llama3.2, mistral, qwen2.5)</RadzenText>
                    </Helper>
                </RadzenFormField>

                <RadzenFormField Text="Custom System Prompt" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenTextArea @bind-Value="_customSystemPrompt" Rows="3" Placeholder="Optional: Custom translation instructions..."
                                        Style="width: 100%;" />
                    </ChildContent>
                    <Helper>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Override the default translation prompt (optional)</RadzenText>
                    </Helper>
                </RadzenFormField>
                break;

            case "openai":
                <hr />
                <RadzenText TextStyle="TextStyle.Subtitle2" Style="color: var(--rz-primary);">OpenAI Configuration</RadzenText>

                <RadzenFormField Text="Model" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenDropDown @bind-Value="_openaiModel" Style="width: 100%;" Data="@_openaiModelOptions"
                                        TextProperty="Text" ValueProperty="Value" />
                    </ChildContent>
                    <Helper>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Select the GPT model to use</RadzenText>
                    </Helper>
                </RadzenFormField>

                <RadzenFormField Text="Custom System Prompt" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenTextArea @bind-Value="_customSystemPrompt" Rows="3" Placeholder="Optional: Custom translation instructions..."
                                        Style="width: 100%;" />
                    </ChildContent>
                    <Helper>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Override the default translation prompt (optional)</RadzenText>
                    </Helper>
                </RadzenFormField>
                break;

            case "claude":
                <hr />
                <RadzenText TextStyle="TextStyle.Subtitle2" Style="color: var(--rz-primary);">Claude Configuration</RadzenText>

                <RadzenFormField Text="Model" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenDropDown @bind-Value="_claudeModel" Style="width: 100%;" Data="@_claudeModelOptions"
                                        TextProperty="Text" ValueProperty="Value" />
                    </ChildContent>
                    <Helper>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Select the Claude model to use</RadzenText>
                    </Helper>
                </RadzenFormField>

                <RadzenFormField Text="Custom System Prompt" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenTextArea @bind-Value="_customSystemPrompt" Rows="3" Placeholder="Optional: Custom translation instructions..."
                                        Style="width: 100%;" />
                    </ChildContent>
                </RadzenFormField>
                break;

            case "azureopenai":
                <hr />
                <RadzenText TextStyle="TextStyle.Subtitle2" Style="color: var(--rz-primary);">Azure OpenAI Configuration</RadzenText>

                <RadzenFormField Text="Endpoint URL" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenTextBox @bind-Value="_azureEndpoint" Placeholder="https://your-resource.openai.azure.com"
                                       Style="width: 100%;" />
                    </ChildContent>
                    <Helper>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Your Azure OpenAI resource endpoint</RadzenText>
                    </Helper>
                </RadzenFormField>

                <RadzenFormField Text="Deployment Name" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenTextBox @bind-Value="_azureDeploymentName" Placeholder="gpt-4" Style="width: 100%;" />
                    </ChildContent>
                    <Helper>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">The deployment name in Azure OpenAI Studio</RadzenText>
                    </Helper>
                </RadzenFormField>

                <RadzenFormField Text="Custom System Prompt" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenTextArea @bind-Value="_customSystemPrompt" Rows="3" Placeholder="Optional: Custom translation instructions..."
                                        Style="width: 100%;" />
                    </ChildContent>
                </RadzenFormField>
                break;

            case "azuretranslator":
                <hr />
                <RadzenText TextStyle="TextStyle.Subtitle2" Style="color: var(--rz-primary);">Azure Translator Configuration</RadzenText>

                <RadzenFormField Text="Region" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenTextBox @bind-Value="_azureRegion" Placeholder="eastus" Style="width: 100%;" />
                    </ChildContent>
                    <Helper>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Azure region (e.g., eastus, westeurope). Required for regional resources.</RadzenText>
                    </Helper>
                </RadzenFormField>

                <RadzenFormField Text="Custom Endpoint" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenTextBox @bind-Value="_azureEndpoint" Placeholder="https://api.cognitive.microsofttranslator.com"
                                       Style="width: 100%;" />
                    </ChildContent>
                    <Helper>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Optional: Custom endpoint URL (uses default if not set)</RadzenText>
                    </Helper>
                </RadzenFormField>
                break;

            case "lingva":
                <hr />
                <RadzenText TextStyle="TextStyle.Subtitle2" Style="color: var(--rz-primary);">Lingva Configuration</RadzenText>

                <RadzenFormField Text="Instance URL" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenTextBox @bind-Value="_lingvaInstanceUrl" Placeholder="https://lingva.ml" Style="width: 100%;" />
                    </ChildContent>
                    <Helper>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Lingva instance URL. Default: https://lingva.ml</RadzenText>
                    </Helper>
                </RadzenFormField>

                <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false" Size="AlertSize.Small">
                    Lingva is a free, privacy-respecting Google Translate frontend. No API key required.
                </RadzenAlert>
                break;

            case "libretranslate":
                <hr />
                <RadzenText TextStyle="TextStyle.Subtitle2" Style="color: var(--rz-primary);">LibreTranslate Configuration</RadzenText>

                <RadzenFormField Text="API URL" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenTextBox @bind-Value="_libreApiUrl" Placeholder="https://libretranslate.com" Style="width: 100%;" />
                    </ChildContent>
                    <Helper>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">LibreTranslate instance URL. API key may be optional for public instances.</RadzenText>
                    </Helper>
                </RadzenFormField>
                break;

            case "mymemory":
                <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false" Size="AlertSize.Small">
                    MyMemory is a free translation service. No configuration required.
                    Rate limited to ~5000 characters/day for anonymous usage.
                </RadzenAlert>
                break;
        }

        @* Rate Limit *@
        @if (HasConfigOptions(Provider.Name))
        {
            <hr />
            <RadzenFormField Text="Rate Limit (requests/minute)" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                <ChildContent>
                    <RadzenNumeric @bind-Value="_rateLimitPerMinute" Min="1" Max="1000" Style="width: 100%;" />
                </ChildContent>
                <Helper>
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Optional: Limit API calls per minute</RadzenText>
                </Helper>
            </RadzenFormField>
        }

        @* Test Result *@
        @if (_testResult != null)
        {
            <RadzenAlert AlertStyle="@(_testResult.IsValid ? AlertStyle.Success : AlertStyle.Danger)" Shade="Shade.Lighter" AllowClose="false" Size="AlertSize.Small">
                @if (_testResult.IsValid)
                {
                    @(_testResult.ProviderMessage ?? "Configuration is valid!")
                }
                else
                {
                    @(_testResult.Error ?? "Invalid configuration")
                }
            </RadzenAlert>
        }
    }

    @* Dialog Actions *@
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem">
        <RadzenButton Variant="Radzen.Variant.Text" Text="Cancel" Click="Cancel" Disabled="@_isSaving" />
        @if (Provider.RequiresApiKey)
        {
            <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Secondary" Text="Test"
                          Disabled="@(string.IsNullOrEmpty(_apiKey) && _existingConfig?.HasApiKey != true || _isTesting || _isSaving)"
                          IsBusy="@_isTesting" Click="TestConfiguration" />
        }
        <RadzenButton ButtonStyle="ButtonStyle.Primary" Text="Save" Disabled="@(!IsValid() || _isSaving)"
                      IsBusy="@_isSaving" Click="Save" />
    </RadzenStack>
</RadzenStack>

@code {
    [Parameter, EditorRequired]
    public TranslationProviderDto Provider { get; set; } = null!;

    [Parameter]
    public string Level { get; set; } = "user";

    [Parameter]
    public int? EntityId { get; set; }

    [Parameter]
    public bool ShowApiKeyField { get; set; } = false;

    private string _apiKey = string.Empty;
    private bool _showKey = false;
    private int? _rateLimitPerMinute;
    private string? _customSystemPrompt;

    private string? _ollamaApiUrl;
    private string? _ollamaModel;
    private string? _openaiModel;
    private string? _claudeModel;
    private string? _azureEndpoint;
    private string? _azureDeploymentName;
    private string? _azureRegion;
    private string? _lingvaInstanceUrl;
    private string? _libreApiUrl;

    private bool _isLoading = true;
    private bool _isTesting = false;
    private bool _isSaving = false;
    private TestApiKeyResponse? _testResult;
    private ProviderConfigDto? _existingConfig;
    private string? _inheritedKeySource;

    private readonly List<object> _openaiModelOptions = new()
    {
        new { Value = "gpt-4o-mini", Text = "GPT-4o Mini (Recommended)" },
        new { Value = "gpt-4o", Text = "GPT-4o" },
        new { Value = "gpt-4-turbo", Text = "GPT-4 Turbo" },
        new { Value = "gpt-3.5-turbo", Text = "GPT-3.5 Turbo" }
    };

    private readonly List<object> _claudeModelOptions = new()
    {
        new { Value = "claude-3-5-sonnet-20241022", Text = "Claude 3.5 Sonnet (Recommended)" },
        new { Value = "claude-3-5-haiku-20241022", Text = "Claude 3.5 Haiku (Fast)" },
        new { Value = "claude-3-opus-20240229", Text = "Claude 3 Opus" }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadExistingConfigAsync();
    }

    private async Task LoadExistingConfigAsync()
    {
        _isLoading = true;
        try
        {
            _existingConfig = Level.ToLowerInvariant() switch
            {
                "user" => await TranslationService.GetUserProviderConfigAsync(Provider.Name),
                "organization" when EntityId.HasValue =>
                    await TranslationService.GetOrganizationProviderConfigAsync(EntityId.Value, Provider.Name),
                "project" when EntityId.HasValue =>
                    await TranslationService.GetProjectProviderConfigAsync(EntityId.Value, Provider.Name),
                _ => null
            };

            if (_existingConfig?.Config != null)
                PopulateFieldsFromConfig(_existingConfig.Config);

            if (_existingConfig?.HasApiKey != true && Provider.RequiresApiKey)
            {
                if (!string.IsNullOrEmpty(Provider.ApiKeySource))
                    _inheritedKeySource = Provider.ApiKeySource;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"No existing config: {ex.Message}");
            if (Provider.RequiresApiKey && !string.IsNullOrEmpty(Provider.ApiKeySource))
                _inheritedKeySource = Provider.ApiKeySource;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void PopulateFieldsFromConfig(Dictionary<string, object?> config)
    {
        _rateLimitPerMinute = GetIntValue(config, "rateLimitPerMinute");
        _customSystemPrompt = GetStringValue(config, "customSystemPrompt");
        _ollamaApiUrl = GetStringValue(config, "apiUrl");
        _ollamaModel = GetStringValue(config, "model");
        _openaiModel = GetStringValue(config, "model");
        _claudeModel = GetStringValue(config, "model");
        _azureEndpoint = GetStringValue(config, "endpoint");
        _azureDeploymentName = GetStringValue(config, "deploymentName");
        _azureRegion = GetStringValue(config, "region");
        _lingvaInstanceUrl = GetStringValue(config, "instanceUrl");
        _libreApiUrl = GetStringValue(config, "apiUrl");
    }

    private Dictionary<string, object?> BuildConfigDictionary()
    {
        var config = new Dictionary<string, object?>();

        if (_rateLimitPerMinute.HasValue)
            config["rateLimitPerMinute"] = _rateLimitPerMinute.Value;
        if (!string.IsNullOrWhiteSpace(_customSystemPrompt))
            config["customSystemPrompt"] = _customSystemPrompt;

        switch (Provider.Name.ToLowerInvariant())
        {
            case "ollama":
                if (!string.IsNullOrWhiteSpace(_ollamaApiUrl)) config["apiUrl"] = _ollamaApiUrl;
                if (!string.IsNullOrWhiteSpace(_ollamaModel)) config["model"] = _ollamaModel;
                break;
            case "openai":
                if (!string.IsNullOrWhiteSpace(_openaiModel)) config["model"] = _openaiModel;
                break;
            case "claude":
                if (!string.IsNullOrWhiteSpace(_claudeModel)) config["model"] = _claudeModel;
                break;
            case "azureopenai":
                if (!string.IsNullOrWhiteSpace(_azureEndpoint)) config["endpoint"] = _azureEndpoint;
                if (!string.IsNullOrWhiteSpace(_azureDeploymentName)) config["deploymentName"] = _azureDeploymentName;
                break;
            case "azuretranslator":
                if (!string.IsNullOrWhiteSpace(_azureRegion)) config["region"] = _azureRegion;
                if (!string.IsNullOrWhiteSpace(_azureEndpoint)) config["endpoint"] = _azureEndpoint;
                break;
            case "lingva":
                if (!string.IsNullOrWhiteSpace(_lingvaInstanceUrl)) config["instanceUrl"] = _lingvaInstanceUrl;
                break;
            case "libretranslate":
                if (!string.IsNullOrWhiteSpace(_libreApiUrl)) config["apiUrl"] = _libreApiUrl;
                break;
        }

        return config;
    }

    private async Task TestConfiguration()
    {
        _isTesting = true;
        _testResult = null;

        try
        {
            var request = new TestApiKeyRequest
            {
                ProviderName = Provider.Name,
                ApiKey = !string.IsNullOrEmpty(_apiKey) ? _apiKey : null!
            };
            _testResult = await TranslationService.TestApiKeyAsync(request);
        }
        catch (Exception ex)
        {
            _testResult = new TestApiKeyResponse { IsValid = false, Error = ex.Message };
        }
        finally
        {
            _isTesting = false;
        }
    }

    private async Task Save()
    {
        _isSaving = true;

        try
        {
            var config = BuildConfigDictionary();
            var request = new SetProviderConfigRequest
            {
                Provider = Provider.Name,
                ApiKey = !string.IsNullOrEmpty(_apiKey) ? _apiKey : null,
                Config = config.Count > 0 ? config : null
            };

            ServiceResult result;
            switch (Level.ToLowerInvariant())
            {
                case "user":
                    result = await TranslationService.SetUserProviderConfigAsync(Provider.Name, request);
                    break;
                case "organization" when EntityId.HasValue:
                    result = await TranslationService.SetOrganizationProviderConfigAsync(EntityId.Value, Provider.Name, request);
                    break;
                case "project" when EntityId.HasValue:
                    result = await TranslationService.SetProjectProviderConfigAsync(EntityId.Value, Provider.Name, request);
                    break;
                default:
                    result = ServiceResult.Failure("Invalid configuration level");
                    break;
            }

            if (result.IsSuccess)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Saved", $"{Provider.DisplayName} configuration saved");
                DialogService.Close(true);
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", result.ErrorMessage ?? "Failed to save");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to save: {ex.Message}");
        }
        finally
        {
            _isSaving = false;
        }
    }

    private void Cancel()
    {
        DialogService.Close(null);
    }

    private bool IsValid()
    {
        if (Provider.RequiresApiKey)
        {
            var hasKeyAtThisLevel = !string.IsNullOrEmpty(_apiKey) || _existingConfig?.HasApiKey == true;
            var hasInheritedKey = _inheritedKeySource != null;
            if (!hasKeyAtThisLevel && !hasInheritedKey) return false;
        }

        return Provider.Name.ToLowerInvariant() switch
        {
            "azureopenai" when !string.IsNullOrEmpty(_apiKey) =>
                !string.IsNullOrWhiteSpace(_azureEndpoint) && !string.IsNullOrWhiteSpace(_azureDeploymentName),
            _ => true
        };
    }

    private static bool HasConfigOptions(string provider) => provider.ToLowerInvariant() switch
    {
        "ollama" or "openai" or "claude" or "azureopenai" or "azuretranslator" or "lingva" or "libretranslate" => true,
        _ => false
    };

    private static BadgeStyle GetLevelBadgeStyle(string level) => level.ToLowerInvariant() switch
    {
        "user" => BadgeStyle.Primary,
        "organization" => BadgeStyle.Secondary,
        "project" => BadgeStyle.Success,
        _ => BadgeStyle.Light
    };

    private static string GetLevelDisplayName(string level) => level.ToLowerInvariant() switch
    {
        "user" => "User Level",
        "organization" => "Organization Level",
        "project" => "Project Level",
        _ => level
    };

    private string GetApiKeyPlaceholder()
    {
        if (_existingConfig?.HasApiKey == true) return "(leave blank to keep current)";
        if (_inheritedKeySource != null) return $"(optional - using {_inheritedKeySource} key)";
        return "Enter your API key...";
    }

    private static string GetApiKeyHelpText(string provider) => provider.ToLowerInvariant() switch
    {
        "google" => "Get your API key from Google Cloud Console -> APIs & Services -> Credentials",
        "deepl" => "Get your API key from DeepL Pro account -> Account -> Authentication Key",
        "openai" => "Get your API key from OpenAI Platform -> API Keys",
        "claude" => "Get your API key from Anthropic Console -> API Keys",
        "azuretranslator" => "Get your key from Azure Portal -> Cognitive Services -> Translator",
        "azureopenai" => "Get your key from Azure Portal -> Azure OpenAI Service -> Keys",
        "libretranslate" => "API key is optional for public instances. Required for private instances.",
        _ => "Enter your API key for this provider"
    };

    private static string? GetStringValue(Dictionary<string, object?> config, string key)
    {
        if (config.TryGetValue(key, out var value) && value != null)
            return value.ToString();
        return null;
    }

    private static int? GetIntValue(Dictionary<string, object?> config, string key)
    {
        var str = GetStringValue(config, key);
        if (str != null && int.TryParse(str, out var val)) return val;
        return null;
    }
}
