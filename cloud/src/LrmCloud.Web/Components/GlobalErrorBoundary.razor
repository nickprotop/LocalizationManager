@* Global error boundary component - catches and displays unhandled errors gracefully *@
@inherits ErrorBoundary
@implements IDisposable
@inject NotificationService NotificationService
@inject ILogger<GlobalErrorBoundary> Logger

@if (CurrentException != null)
{
    <div style="display: flex; justify-content: center; padding: 2rem;">
        <RadzenCard Style="max-width: 500px; width: 100%;">
            <RadzenStack AlignItems="Radzen.AlignItems.Center" Gap="1rem">
                <RadzenIcon Icon="error" Style="font-size: 5rem; color: var(--rz-danger);" />

                <RadzenText TextStyle="TextStyle.H5" TextAlign="TextAlign.Center">
                    Something went wrong
                </RadzenText>

                <RadzenText TextStyle="TextStyle.Body1" class="rz-color-secondary" TextAlign="TextAlign.Center">
                    We're sorry, but an unexpected error occurred. Please try again.
                </RadzenText>

                @if (ShowDetails)
                {
                    <details style="width: 100%; margin-top: 1rem;">
                        <summary style="cursor: pointer; font-weight: 500;">Error Details</summary>
                        <RadzenCard Style="margin-top: 0.5rem; background: var(--rz-base-200);">
                            <RadzenText TextStyle="TextStyle.Body2" Style="font-family: monospace; white-space: pre-wrap; word-break: break-word;">
                                @CurrentException.Message
                            </RadzenText>
                            @if (CurrentException.InnerException != null)
                            {
                                <hr style="margin: 0.5rem 0;" />
                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Inner Exception:</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" Style="font-family: monospace; white-space: pre-wrap; word-break: break-word;">
                                    @CurrentException.InnerException.Message
                                </RadzenText>
                            }
                        </RadzenCard>
                    </details>
                }

                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" Style="margin-top: 1rem;">
                    <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Primary"
                                  Icon="refresh" Text="Try Again" Click="@Recover" />
                    <RadzenButton ButtonStyle="ButtonStyle.Primary"
                                  Icon="home" Text="Go to Dashboard" Click="@(() => NavigateHome())" />
                </RadzenStack>
            </RadzenStack>
        </RadzenCard>
    </div>
}
else
{
    @ChildContent
}

@code {
    [Parameter]
    public bool ShowDetails { get; set; }

    [Inject]
    private NavigationManager Navigation { get; set; } = null!;

    protected override void OnInitialized()
    {
        Navigation.LocationChanged += OnLocationChanged;
#if DEBUG
        ShowDetails = true;
#endif
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        if (CurrentException != null)
        {
            Recover();
            StateHasChanged();
        }
    }

    protected override Task OnErrorAsync(Exception exception)
    {
        Logger.LogError(exception, "Unhandled error caught by GlobalErrorBoundary");
        NotificationService.Notify(NotificationSeverity.Error, "Error", "An unexpected error occurred");
        return Task.CompletedTask;
    }

    private void NavigateHome()
    {
        Recover();
        Navigation.NavigateTo("");
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}
