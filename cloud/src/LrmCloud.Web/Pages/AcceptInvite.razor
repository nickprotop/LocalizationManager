@page "/invite/{Token}"
@using LrmCloud.Web.Services
@inject OrganizationService OrganizationService
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject NotificationService NotificationService

<PageTitle>Accept Invitation - LRM Cloud</PageTitle>

<div style="min-height: 80vh; display: flex; align-items: center; justify-content: center;">
    <RadzenCard Style="width: 100%; max-width: 500px; padding: 2rem;">
        @if (_isProcessing)
        {
            <RadzenStack AlignItems="Radzen.AlignItems.Center" Gap="1rem">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
                <RadzenText TextStyle="TextStyle.H6">Processing invitation...</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Please wait while we process your invitation.</RadzenText>
            </RadzenStack>
        }
        else if (_isSuccess)
        {
            <RadzenStack AlignItems="Radzen.AlignItems.Center" Gap="1rem">
                <RadzenIcon Icon="check_circle" Style="font-size: 5rem; color: var(--rz-success);" />
                <RadzenText TextStyle="TextStyle.H5" TextAlign="TextAlign.Center">Invitation Accepted!</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1" class="rz-color-secondary" TextAlign="TextAlign.Center">
                    You've successfully joined the organization.
                </RadzenText>
                <RadzenButton Variant="Radzen.Variant.Filled" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Large"
                              Text="Go to Organizations" Click="@(() => Navigation.NavigateTo("organizations"))" class="rz-mt-4" />
            </RadzenStack>
        }
        else if (_requiresLogin)
        {
            <RadzenStack AlignItems="Radzen.AlignItems.Center" Gap="1rem">
                <RadzenIcon Icon="email" Style="font-size: 5rem; color: var(--rz-primary);" />
                <RadzenText TextStyle="TextStyle.H5" TextAlign="TextAlign.Center">You've Been Invited!</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1" class="rz-color-secondary" TextAlign="TextAlign.Center">
                    Please log in or create an account to accept this invitation.
                </RadzenText>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" class="rz-mt-4">
                    <RadzenButton Variant="Radzen.Variant.Filled" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Large"
                                  Text="Log In" Click="@(() => Navigation.NavigateTo($"login?returnUrl=invite/{Token}"))" />
                    <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Large"
                                  Text="Create Account" Click="@(() => Navigation.NavigateTo($"register?returnUrl=invite/{Token}"))" />
                </RadzenStack>
            </RadzenStack>
        }
        else if (_showDeclineConfirm)
        {
            <RadzenStack AlignItems="Radzen.AlignItems.Center" Gap="1rem">
                <RadzenIcon Icon="warning" Style="font-size: 5rem; color: var(--rz-warning);" />
                <RadzenText TextStyle="TextStyle.H5" TextAlign="TextAlign.Center">Decline Invitation?</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1" class="rz-color-secondary" TextAlign="TextAlign.Center">
                    Are you sure you want to decline this invitation? You'll need to be invited again to join.
                </RadzenText>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" class="rz-mt-4">
                    <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Large"
                                  Text="Cancel" Click="@CancelDecline" />
                    <RadzenButton Variant="Radzen.Variant.Filled" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Large"
                                  Text="Decline Invitation" Click="@ConfirmDecline" Disabled="@_isProcessing" IsBusy="@_isProcessing" />
                </RadzenStack>
            </RadzenStack>
        }
        else if (_isDeclined)
        {
            <RadzenStack AlignItems="Radzen.AlignItems.Center" Gap="1rem">
                <RadzenIcon Icon="cancel" Style="font-size: 5rem; color: var(--rz-text-secondary-color);" />
                <RadzenText TextStyle="TextStyle.H5" TextAlign="TextAlign.Center">Invitation Declined</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1" class="rz-color-secondary" TextAlign="TextAlign.Center">
                    You've declined this invitation.
                </RadzenText>
                <RadzenButton Variant="Radzen.Variant.Filled" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Large"
                              Text="Go to Dashboard" Click="@(() => Navigation.NavigateTo(""))" class="rz-mt-4" />
            </RadzenStack>
        }
        else if (_showAcceptConfirm)
        {
            <RadzenStack AlignItems="Radzen.AlignItems.Center" Gap="1rem">
                <RadzenIcon Icon="email" Style="font-size: 5rem; color: var(--rz-primary);" />
                <RadzenText TextStyle="TextStyle.H5" TextAlign="TextAlign.Center">Organization Invitation</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1" class="rz-color-secondary" TextAlign="TextAlign.Center">
                    What would you like to do with this invitation?
                </RadzenText>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" class="rz-mt-4">
                    <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Secondary" Size="ButtonSize.Large"
                                  Text="Decline" Click="@ShowDeclineConfirm" />
                    <RadzenButton Variant="Radzen.Variant.Filled" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Large"
                                  Text="Accept" Click="@ProcessInvitation" Disabled="@_isProcessing" IsBusy="@_isProcessing" />
                </RadzenStack>
            </RadzenStack>
        }
        else
        {
            <RadzenStack AlignItems="Radzen.AlignItems.Center" Gap="1rem">
                <RadzenIcon Icon="error" Style="font-size: 5rem; color: var(--rz-danger);" />
                <RadzenText TextStyle="TextStyle.H5" TextAlign="TextAlign.Center">Invitation Failed</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1" class="rz-color-secondary" TextAlign="TextAlign.Center">
                    @_errorMessage
                </RadzenText>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" class="rz-mt-4">
                    <RadzenButton Variant="Radzen.Variant.Filled" ButtonStyle="ButtonStyle.Primary"
                                  Text="Go to Dashboard" Click="@(() => Navigation.NavigateTo(""))" />
                    <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Primary"
                                  Text="Try Again" Click="@RetryAcceptInvitation" />
                </RadzenStack>
            </RadzenStack>
        }
    </RadzenCard>
</div>

@code {
    [Parameter]
    public string Token { get; set; } = "";

    private bool _isProcessing = true;
    private bool _isSuccess;
    private bool _isDeclined;
    private bool _requiresLogin;
    private bool _showAcceptConfirm;
    private bool _showDeclineConfirm;
    private string _errorMessage = "The invitation link is invalid or has expired.";

    protected override async Task OnInitializedAsync()
    {
        await CheckAuthentication();
    }

    private async Task CheckAuthentication()
    {
        _isProcessing = true;

        // Check if user is authenticated
        var isAuthenticated = await AuthService.IsAuthenticatedAsync();

        if (!isAuthenticated)
        {
            _requiresLogin = true;
            _isProcessing = false;
            return;
        }

        // User is authenticated - show accept/decline options
        _showAcceptConfirm = true;
        _isProcessing = false;
    }

    private async Task ProcessInvitation()
    {
        _isProcessing = true;
        _showAcceptConfirm = false;

        // Try to accept the invitation
        var (success, error) = await OrganizationService.AcceptInvitationAsync(Token);

        if (success)
        {
            _isSuccess = true;
            NotificationService.Notify(NotificationSeverity.Success, "Success", "Invitation accepted successfully!");
        }
        else
        {
            _errorMessage = error ?? "The invitation link is invalid or has expired.";
        }

        _isProcessing = false;
    }

    private void ShowDeclineConfirm()
    {
        _showAcceptConfirm = false;
        _showDeclineConfirm = true;
    }

    private void CancelDecline()
    {
        _showDeclineConfirm = false;
        _showAcceptConfirm = true;
    }

    private async Task ConfirmDecline()
    {
        _isProcessing = true;
        _showDeclineConfirm = false;

        // Note: This uses the token from email, which requires bcrypt verification
        // For now, we show declined state - the invitation will expire naturally
        // A proper implementation would need a decline endpoint that works with email tokens
        _isDeclined = true;
        _isProcessing = false;
        NotificationService.Notify(NotificationSeverity.Info, "Info", "Invitation declined");
    }

    private void RetryAcceptInvitation()
    {
        _showAcceptConfirm = true;
        _isProcessing = false;
    }
}
