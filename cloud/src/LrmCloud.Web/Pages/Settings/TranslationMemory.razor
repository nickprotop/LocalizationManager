@page "/settings/translation-memory"
@using LrmCloud.Shared.DTOs.TranslationMemory
@using LrmCloud.Web.Services
@inject TranslationMemoryService TmService
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService
@attribute [Authorize]

<PageTitle>Translation Memory - LRM Cloud</PageTitle>

<RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-2">
    <RadzenIcon Icon="memory" />
    <RadzenText TextStyle="TextStyle.H4">Translation Memory</RadzenText>
</RadzenStack>
<RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary rz-mb-4">
    Your personal translation memory stores past translations for reuse. Get exact and fuzzy matches automatically.
</RadzenText>

@if (_isLoading)
{
    <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Style="height: 4px;" />
}
else if (_stats == null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" Shade="Shade.Lighter" AllowClose="false">Failed to load Translation Memory statistics.</RadzenAlert>
}
else
{
    <RadzenRow Gap="1rem">
        @* Stats Overview *@
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenCard class="rz-p-4">
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-4">
                    <RadzenIcon Icon="analytics" />
                    <RadzenText TextStyle="TextStyle.H6">Statistics</RadzenText>
                </RadzenStack>

                <RadzenStack Gap="1rem">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenText>Total Entries</RadzenText>
                        <RadzenText TextStyle="TextStyle.H6">@_stats.TotalEntries.ToString("N0")</RadzenText>
                    </RadzenStack>

                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenText>Total Uses</RadzenText>
                        <RadzenText TextStyle="TextStyle.H6" Style="color: var(--rz-success);">@_stats.TotalUseCount.ToString("N0")</RadzenText>
                    </RadzenStack>

                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenText>Language Pairs</RadzenText>
                        <RadzenText TextStyle="TextStyle.H6">@_stats.LanguagePairs.Count</RadzenText>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>

        @* Actions *@
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenCard class="rz-p-4">
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-4">
                    <RadzenIcon Icon="settings" />
                    <RadzenText TextStyle="TextStyle.H6">Actions</RadzenText>
                </RadzenStack>

                <RadzenStack Gap="0.5rem">
                    <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false" class="rz-mb-2">
                        Translation Memory automatically stores translations as you work.
                        Suggestions appear when you translate similar content.
                    </RadzenAlert>

                    <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Danger" Icon="delete_forever" Text="Clear All TM Data" Click="@ConfirmClearAll" Disabled="@(_stats.TotalEntries == 0)" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>

        @* Language Pairs *@
        @if (_stats.LanguagePairs.Any())
        {
            <RadzenColumn Size="12">
                <RadzenCard class="rz-p-4">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-4">
                        <RadzenIcon Icon="language" />
                        <RadzenText TextStyle="TextStyle.H6">Language Pairs</RadzenText>
                    </RadzenStack>

                    <RadzenDataGrid TItem="TmLanguagePairStats" Data="@_stats.LanguagePairs" Density="Density.Compact" AllowSorting="false" AllowPaging="false">
                        <Columns>
                            <RadzenDataGridColumn TItem="TmLanguagePairStats" Property="SourceLanguage" Title="Source">
                                <Template Context="pair">
                                    <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="@pair.SourceLanguage.ToUpperInvariant()" />
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="TmLanguagePairStats" Property="TargetLanguage" Title="Target">
                                <Template Context="pair">
                                    <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="@pair.TargetLanguage.ToUpperInvariant()" />
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="TmLanguagePairStats" Property="EntryCount" Title="Entries" TextAlign="TextAlign.Right">
                                <Template Context="pair">
                                    @pair.EntryCount.ToString("N0")
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="TmLanguagePairStats" Property="UseCount" Title="Uses" TextAlign="TextAlign.Right">
                                <Template Context="pair">
                                    @pair.UseCount.ToString("N0")
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="TmLanguagePairStats" Title="Actions" Width="80px">
                                <Template Context="pair">
                                    <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Variant="Radzen.Variant.Text" Size="ButtonSize.Small" Click="@(() => ConfirmClearPair(pair))" />
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                </RadzenCard>
            </RadzenColumn>
        }
    </RadzenRow>
}

@code {
    private TmStatsDto? _stats;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadStatsAsync();
    }

    private async Task LoadStatsAsync()
    {
        _isLoading = true;
        try
        {
            var result = await TmService.GetStatsAsync();
            if (result.IsSuccess)
            {
                _stats = result.Data;
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", result.ErrorMessage ?? "Failed to load TM stats");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ConfirmClearAll()
    {
        var confirmed = await DialogService.Confirm(
            "Are you sure you want to delete all Translation Memory entries? This cannot be undone.",
            "Clear Translation Memory",
            new ConfirmOptions { OkButtonText = "Delete All", CancelButtonText = "Cancel" });

        if (confirmed == true)
        {
            await ClearAllAsync();
        }
    }

    private async Task ClearAllAsync()
    {
        var result = await TmService.ClearAsync();
        if (result.IsSuccess)
        {
            NotificationService.Notify(NotificationSeverity.Success, "Success", $"Cleared {result.Data} TM entries");
            await LoadStatsAsync();
        }
        else
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", result.ErrorMessage ?? "Failed to clear TM");
        }
    }

    private async Task ConfirmClearPair(TmLanguagePairStats pair)
    {
        var confirmed = await DialogService.Confirm(
            $"Delete all {pair.EntryCount} entries for {pair.SourceLanguage.ToUpperInvariant()} -> {pair.TargetLanguage.ToUpperInvariant()}?",
            "Clear Language Pair",
            new ConfirmOptions { OkButtonText = "Delete", CancelButtonText = "Cancel" });

        if (confirmed == true)
        {
            await ClearPairAsync(pair);
        }
    }

    private async Task ClearPairAsync(TmLanguagePairStats pair)
    {
        var result = await TmService.ClearAsync(pair.SourceLanguage, pair.TargetLanguage);
        if (result.IsSuccess)
        {
            NotificationService.Notify(NotificationSeverity.Success, "Success", $"Cleared {result.Data} entries for {pair.SourceLanguage} -> {pair.TargetLanguage}");
            await LoadStatsAsync();
        }
        else
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", result.ErrorMessage ?? "Failed to clear language pair");
        }
    }
}
