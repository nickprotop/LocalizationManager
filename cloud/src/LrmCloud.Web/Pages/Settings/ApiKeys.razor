@page "/settings/api-keys"
@using LrmCloud.Shared.DTOs.Auth
@using LrmCloud.Shared.DTOs.Projects
@using LrmCloud.Web.Services
@inject CliApiKeyService ApiKeyService
@inject ProjectService ProjectService
@inject LimitsService LimitsService
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService
@inject IJSRuntime JSRuntime
@attribute [Authorize]

<PageTitle>CLI API Keys - LRM Cloud</PageTitle>

<RadzenText TextStyle="TextStyle.H4" class="rz-mb-2">CLI API Keys</RadzenText>
<RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary rz-mb-4">
    API keys allow the LRM CLI to authenticate with your cloud account for syncing resources.
</RadzenText>

<RadzenCard class="rz-mb-4">
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-4">
        <RadzenText TextStyle="TextStyle.H6">Your API Keys</RadzenText>
        <RadzenButton Variant="Radzen.Variant.Filled" ButtonStyle="ButtonStyle.Primary" Icon="add"
                      Text="Create New Key" Click="@OpenCreateDialog" Disabled="@(!_canCreateKey)"
                      title="@(_canCreateKey ? "" : _limitMessage)" />
    </RadzenStack>

    @if (_isLoading)
    {
        <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Style="height: 4px;" />
    }
    else if (_keys.Count == 0)
    {
        <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false">
            You don't have any API keys yet. Create one to start syncing with the CLI.
        </RadzenAlert>
    }
    else
    {
        <RadzenDataGrid TItem="CliApiKeyDto" Data="@_keys" AllowSorting="false" AllowPaging="false" Density="Density.Compact">
            <Columns>
                <RadzenDataGridColumn TItem="CliApiKeyDto" Property="Name" Title="Name" />
                <RadzenDataGridColumn TItem="CliApiKeyDto" Property="KeyPrefix" Title="Key Prefix">
                    <Template Context="key">
                        <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="@($"{key.KeyPrefix}...")" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="CliApiKeyDto" Property="Scopes" Title="Scopes">
                    <Template Context="key">
                        @foreach (var scope in key.Scopes.Split(','))
                        {
                            <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@scope.Trim()" class="rz-mr-1" />
                        }
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="CliApiKeyDto" Property="ProjectName" Title="Project">
                    <Template Context="key">
                        @if (!string.IsNullOrEmpty(key.ProjectName))
                        {
                            <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text="@key.ProjectName" />
                        }
                        else
                        {
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">All projects</RadzenText>
                        }
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="CliApiKeyDto" Title="Last Used">
                    <Template Context="key">
                        @if (key.LastUsedAt.HasValue)
                        {
                            @key.LastUsedAt.Value.ToString("g")
                        }
                        else
                        {
                            <RadzenText class="rz-color-secondary">Never</RadzenText>
                        }
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="CliApiKeyDto" Title="Expires">
                    <Template Context="key">
                        @if (key.ExpiresAt.HasValue)
                        {
                            @if (key.IsExpired)
                            {
                                <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Expired" />
                            }
                            else
                            {
                                @key.ExpiresAt.Value.ToString("d")
                            }
                        }
                        else
                        {
                            <RadzenText class="rz-color-secondary">Never</RadzenText>
                        }
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="CliApiKeyDto" Title="Actions" Width="100px" TextAlign="TextAlign.Center">
                    <Template Context="key">
                        <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Variant="Radzen.Variant.Text" Size="ButtonSize.Small" Click="@(() => ConfirmDeleteKey(key))" />
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    }
</RadzenCard>

<RadzenCard>
    <RadzenText TextStyle="TextStyle.H6" class="rz-mb-2">Using API Keys</RadzenText>
    <RadzenText TextStyle="TextStyle.Body2" class="rz-mb-3">
        Configure your API key in the LRM CLI to sync resources with the cloud:
    </RadzenText>
    <RadzenCard Variant="Radzen.Variant.Text" class="rz-mb-3" Style="background-color: var(--rz-base-100);">
        <code>lrm cloud set-api-key --key YOUR_API_KEY</code>
    </RadzenCard>
    <RadzenText TextStyle="TextStyle.Body2" class="rz-mb-3">
        Or set the environment variable for CI/CD pipelines:
    </RadzenText>
    <RadzenCard Variant="Radzen.Variant.Text" class="rz-mb-3" Style="background-color: var(--rz-base-100);">
        <code>export LRM_CLOUD_API_KEY=YOUR_API_KEY</code>
    </RadzenCard>
    <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
        API keys take priority over JWT tokens when both are configured.
    </RadzenText>
</RadzenCard>

@code {
    private List<CliApiKeyDto> _keys = new();
    private List<ProjectDto> _projects = new();
    private bool _isLoading = true;
    private bool _canCreateKey = true;
    private string? _limitMessage;

    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(LoadKeys(), LoadProjects(), CheckLimitsAsync());
    }

    private async Task CheckLimitsAsync()
    {
        var (canCreate, reason) = await LimitsService.CanCreateApiKeyAsync();
        _canCreateKey = canCreate;
        _limitMessage = reason;
    }

    private async Task LoadKeys()
    {
        _isLoading = true;
        try
        {
            _keys = await ApiKeyService.GetKeysAsync();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadProjects()
    {
        try
        {
            _projects = await ProjectService.GetProjectsAsync();
        }
        catch
        {
            _projects = new List<ProjectDto>();
        }
    }

    private async Task OpenCreateDialog()
    {
        var result = await DialogService.OpenAsync<CreateCliApiKeyDialog>(
            "Create New API Key",
            new Dictionary<string, object> { { "Projects", _projects } },
            new Radzen.DialogOptions { Width = "500px" });

        if (result is string apiKey && !string.IsNullOrEmpty(apiKey))
        {
            await ShowNewKeyDialog(apiKey);
            LimitsService.InvalidateCache();
            await Task.WhenAll(LoadKeys(), CheckLimitsAsync());
        }
    }

    private async Task ShowNewKeyDialog(string apiKey)
    {
        await DialogService.OpenAsync<ShowApiKeyDialog>(
            "API Key Created",
            new Dictionary<string, object> { { "ApiKey", apiKey } },
            new Radzen.DialogOptions { Width = "500px", CloseDialogOnEsc = false, CloseDialogOnOverlayClick = false });
    }

    private async Task ConfirmDeleteKey(CliApiKeyDto key)
    {
        var confirmed = await DialogService.Confirm(
            $"Are you sure you want to delete the key \"{key.Name}\"? Any CLI instances using this key will no longer be able to authenticate.",
            "Delete API Key?",
            new ConfirmOptions { OkButtonText = "Delete", CancelButtonText = "Cancel" });

        if (confirmed == true)
        {
            var success = await ApiKeyService.DeleteKeyAsync(key.Id);

            if (success)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", "API key deleted");
                LimitsService.InvalidateCache();
                await Task.WhenAll(LoadKeys(), CheckLimitsAsync());
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to delete API key");
            }
        }
    }
}
