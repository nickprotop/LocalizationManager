@page "/settings/billing"
@using LrmCloud.Shared.DTOs.Billing
@using LrmCloud.Shared.DTOs.Usage
@using LrmCloud.Web.Services
@using LrmCloud.Web.Helpers
@inject BillingService BillingService
@inject UsageService UsageService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService
@attribute [Authorize]

<PageTitle>Billing - LRM Cloud</PageTitle>

<RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-2">
    <RadzenIcon Icon="credit_card" />
    <RadzenText TextStyle="TextStyle.H4">Billing & Subscription</RadzenText>
</RadzenStack>
<RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary rz-mb-4">
    Manage your subscription, view usage, and upgrade your plan.
</RadzenText>

@if (_isLoading)
{
    <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Style="height: 4px;" />
}
else
{
    <RadzenRow Gap="1rem">
        @* Current Subscription Card *@
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenCard class="rz-p-4">
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-3">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="card_membership" />
                        <RadzenText TextStyle="TextStyle.H6">Current Plan</RadzenText>
                    </RadzenStack>
                    <RadzenBadge BadgeStyle="@UiHelpers.GetPlanBadgeStyle(_subscription?.Plan ?? "free")" Text="@((_subscription?.Plan ?? "Free").ToUpperInvariant())" />
                </RadzenStack>

                <hr class="rz-mb-3" />

                @if (_subscription?.BillingEnabled == true)
                {
                    <RadzenStack Gap="0.5rem">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                            <RadzenText>Status</RadzenText>
                            <RadzenBadge BadgeStyle="@GetStatusBadgeStyle(_subscription.Status)" Text="@GetStatusText(_subscription.Status)" />
                        </RadzenStack>
                        @if (_subscription.CurrentPeriodEnd.HasValue)
                        {
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenText>@(_subscription.CancelAtPeriodEnd ? "Access Until" : "Next Billing")</RadzenText>
                                <RadzenText class="rz-color-secondary">@_subscription.CurrentPeriodEnd.Value.ToString("MMM d, yyyy")</RadzenText>
                            </RadzenStack>
                        }
                        @if (_subscription.Status?.ToLower() == "incomplete")
                        {
                            <RadzenAlert AlertStyle="AlertStyle.Warning" Shade="Shade.Lighter" AllowClose="false" class="rz-mt-2">
                                Your payment is pending. Please complete the payment to activate your subscription.
                                <RadzenButton Variant="Radzen.Variant.Text" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Text="Cancel Upgrade" Click="@CancelIncompleteSubscription" Disabled="@_isProcessing" class="rz-ms-2" />
                            </RadzenAlert>
                        }
                        else if (_subscription.CancelAtPeriodEnd)
                        {
                            <RadzenAlert AlertStyle="AlertStyle.Warning" Shade="Shade.Lighter" AllowClose="false" class="rz-mt-2">
                                Your subscription will cancel at the end of the billing period.
                            </RadzenAlert>
                        }
                    </RadzenStack>

                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" class="rz-mt-4">
                        @if (_subscription.Plan.ToLower() == "free")
                        {
                            <RadzenButton ButtonStyle="ButtonStyle.Primary" Icon="upgrade" Text="Upgrade to Team" Click="@(() => ShowUpgradeDialog("team"))" />
                        }
                        else if (_subscription.Plan.ToLower() == "team")
                        {
                            <RadzenButton ButtonStyle="ButtonStyle.Primary" Icon="upgrade" Text="Upgrade to Enterprise" Click="@(() => ShowUpgradeDialog("enterprise"))" />
                        }

                        @if (!string.IsNullOrEmpty(_subscription.PaymentSubscriptionId))
                        {
                            @if (_subscription.PaymentProvider == "paypal")
                            {
                                <a href="https://www.paypal.com/myaccount/autopay" target="_blank" style="text-decoration: none;">
                                    <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Primary" Icon="open_in_new" Text="Manage on PayPal" />
                                </a>
                            }
                            else
                            {
                                <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Primary" Icon="settings" Text="Manage Subscription" Click="@OpenPortal" />
                            }
                        }
                    </RadzenStack>

                    @if (_subscription.CancelAtPeriodEnd && !string.IsNullOrEmpty(_subscription.PaymentSubscriptionId))
                    {
                        <RadzenButton Variant="Radzen.Variant.Text" ButtonStyle="ButtonStyle.Success" Icon="refresh" Text="Reactivate Subscription" Click="@ReactivateSubscription" class="rz-mt-2" />
                    }
                    else if (!_subscription.CancelAtPeriodEnd && !string.IsNullOrEmpty(_subscription.PaymentSubscriptionId) && _subscription.Status?.ToLower() != "incomplete")
                    {
                        @* Hide Cancel Subscription when incomplete - PaymentSubscriptionId points to pending upgrade, not current subscription *@
                        <RadzenButton Variant="Radzen.Variant.Text" ButtonStyle="ButtonStyle.Danger" Icon="cancel" Text="Cancel Subscription" Click="@ShowCancelDialog" class="rz-mt-2" />
                    }
                }
                else
                {
                    <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false" class="rz-mb-3">
                        Billing is not yet enabled for this instance.
                    </RadzenAlert>
                    <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
                        You're currently on the Free plan. Contact your administrator to enable billing.
                    </RadzenText>
                }
            </RadzenCard>
        </RadzenColumn>

        @* Usage Summary Card *@
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenCard class="rz-p-4">
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-3">
                    <RadzenIcon Icon="bar_chart" />
                    <RadzenText TextStyle="TextStyle.H6">This Month's Usage</RadzenText>
                </RadzenStack>

                <hr class="rz-mb-3" />

                @if (_stats != null)
                {
                    <RadzenStack Gap="1rem">
                        <RadzenStack Gap="0.25rem">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenText TextStyle="TextStyle.Body2">LRM Translation</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
                                    @_stats.TranslationCharsUsed.ToString("N0") / @_stats.TranslationCharsLimit.ToString("N0")
                                </RadzenText>
                            </RadzenStack>
                            <RadzenProgressBar Value="@_stats.TranslationUsagePercent" ProgressBarStyle="@UiHelpers.GetUsageProgressBarStyle(_stats.TranslationUsagePercent)" ShowValue="false" Style="height: 8px;" />
                        </RadzenStack>

                        <RadzenStack Gap="0.25rem">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenText TextStyle="TextStyle.Body2">BYOK Providers</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
                                    @_stats.OtherCharsUsed.ToString("N0") / @_stats.OtherCharsLimit.ToString("N0")
                                </RadzenText>
                            </RadzenStack>
                            <RadzenProgressBar Value="@_stats.OtherUsagePercent" ProgressBarStyle="@UiHelpers.GetUsageProgressBarStyle(_stats.OtherUsagePercent)" ShowValue="false" Style="height: 8px;" />
                        </RadzenStack>
                    </RadzenStack>

                    <RadzenButton Variant="Radzen.Variant.Text" ButtonStyle="ButtonStyle.Primary" Text="View Full Usage Dashboard" Click="@(() => Navigation.NavigateTo("settings/usage"))" class="rz-mt-3" Style="width: 100%;" />
                }
                else
                {
                    <RadzenText class="rz-color-secondary">Unable to load usage statistics.</RadzenText>
                }
            </RadzenCard>
        </RadzenColumn>

        @* Payment Method Card *@
        @if (_paymentMethod != null)
        {
            <RadzenColumn Size="12" SizeMD="6">
                <RadzenCard class="rz-p-4">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-3">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                            <RadzenIcon Icon="payment" />
                            <RadzenText TextStyle="TextStyle.H6">Payment Method</RadzenText>
                        </RadzenStack>
                        <RadzenButton Variant="Radzen.Variant.Outlined" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Primary" Text="Update" Click="@UpdatePaymentMethod" Disabled="@_isProcessing" />
                    </RadzenStack>

                    <hr class="rz-mb-3" />

                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.75rem">
                        <RadzenIcon Icon="@GetPaymentMethodIcon(_paymentMethod.Type)" Style="font-size: 2rem;" />
                        <RadzenStack Gap="0">
                            <RadzenText>@_paymentMethod.DisplayString</RadzenText>
                            @if (_paymentMethod.Type == "card" && _paymentMethod.CardExpMonth.HasValue)
                            {
                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                    Expires @_paymentMethod.CardExpMonth/@_paymentMethod.CardExpYear
                                </RadzenText>
                            }
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
        }

        @* Invoice History Card *@
        @if (_invoices.Count > 0)
        {
            <RadzenColumn Size="12" SizeMD="@(_paymentMethod != null ? 6 : 12)">
                <RadzenCard class="rz-p-4">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-3">
                        <RadzenIcon Icon="receipt" />
                        <RadzenText TextStyle="TextStyle.H6">Recent Invoices</RadzenText>
                    </RadzenStack>

                    <hr class="rz-mb-3" />

                    <RadzenDataGrid TItem="InvoiceDto" Data="@_invoices" Density="Density.Compact" AllowSorting="false" AllowPaging="false">
                        <Columns>
                            <RadzenDataGridColumn TItem="InvoiceDto" Property="CreatedAt" Title="Date">
                                <Template Context="invoice">
                                    @invoice.CreatedAt.ToString("MMM d, yyyy")
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="InvoiceDto" Property="InvoiceNumber" Title="Invoice">
                                <Template Context="invoice">
                                    @(invoice.InvoiceNumber ?? invoice.InvoiceId[..Math.Min(8, invoice.InvoiceId.Length)])
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="InvoiceDto" Title="Amount" TextAlign="TextAlign.Right">
                                <Template Context="invoice">
                                    @FormatAmount(invoice.AmountTotal, invoice.Currency)
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="InvoiceDto" Property="Status" Title="Status" TextAlign="TextAlign.Center">
                                <Template Context="invoice">
                                    <RadzenBadge BadgeStyle="@GetInvoiceStatusBadgeStyle(invoice.Status)" Text="@(char.ToUpper(invoice.Status[0]) + invoice.Status[1..])" />
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="InvoiceDto" Title="" Width="80px">
                                <Template Context="invoice">
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.25rem">
                                        @if (!string.IsNullOrEmpty(invoice.PdfUrl))
                                        {
                                            <a href="@invoice.PdfUrl" target="_blank"><RadzenButton Icon="download" Variant="Radzen.Variant.Text" Size="ButtonSize.Small" /></a>
                                        }
                                        @if (!string.IsNullOrEmpty(invoice.HostedUrl))
                                        {
                                            <a href="@invoice.HostedUrl" target="_blank"><RadzenButton Icon="open_in_new" Variant="Radzen.Variant.Text" Size="ButtonSize.Small" /></a>
                                        }
                                    </RadzenStack>
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                </RadzenCard>
            </RadzenColumn>
        }

        @* Plan Comparison *@
        <RadzenColumn Size="12">
            <RadzenCard class="rz-p-4">
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-3">
                    <RadzenIcon Icon="compare" />
                    <RadzenText TextStyle="TextStyle.H6">Compare Plans</RadzenText>
                </RadzenStack>

                <hr class="rz-mb-3" />

                <PlanComparisonTable
                    Limits="@_subscription?.PlanLimits"
                    CurrentPlan="@_subscription?.Plan"
                    ShowUpgradeButtons="@(_subscription?.BillingEnabled == true)"
                    OnUpgradeClick="@ShowUpgradeDialog" />
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>
}

@code {
    private SubscriptionDto? _subscription;
    private UsageStatsDto? _stats;
    private PaymentMethodDto? _paymentMethod;
    private List<InvoiceDto> _invoices = new();
    private bool _isLoading = true;
    private bool _isProcessing;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            var subscriptionTask = BillingService.GetSubscriptionAsync();
            var statsTask = UsageService.GetStatsAsync();
            var paymentMethodTask = BillingService.GetPaymentMethodAsync();
            var invoicesTask = BillingService.GetInvoicesAsync(5);

            await Task.WhenAll(subscriptionTask, statsTask, paymentMethodTask, invoicesTask);

            _subscription = await subscriptionTask;
            _stats = await statsTask;
            _paymentMethod = await paymentMethodTask;
            _invoices = await invoicesTask;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load billing data: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ShowUpgradeDialog(string plan)
    {
        var result = await DialogService.OpenAsync<UpgradePlanDialog>(
            $"Upgrade to {plan.ToUpperInvariant()}",
            new Dictionary<string, object>
            {
                { "OrganizationId", 0 },
                { "SelectedPlan", plan },
                { "Subscription", _subscription! }
            },
            new Radzen.DialogOptions { Width = "500px" });

        if (result == true)
        {
            await LoadDataAsync();
        }
    }

    private async Task ShowCancelDialog()
    {
        var confirmed = await DialogService.Confirm(
            "Your subscription will remain active until the end of your current billing period. After cancellation, you'll be downgraded to the Free plan with reduced limits.",
            "Cancel Subscription?",
            new ConfirmOptions { OkButtonText = "Cancel Subscription", CancelButtonText = "Keep Subscription" });

        if (confirmed == true)
        {
            await CancelSubscription();
        }
    }

    private async Task OpenPortal()
    {
        _isProcessing = true;
        try
        {
            var baseUrl = Navigation.BaseUri.TrimEnd('/');
            var result = await BillingService.CreatePortalAsync($"{baseUrl}/settings/billing");

            if (result?.PortalUrl != null)
            {
                await JS.InvokeVoidAsync("open", result.PortalUrl, "_self");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to open billing portal");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private async Task CancelSubscription()
    {
        _isProcessing = true;
        try
        {
            var success = await BillingService.CancelSubscriptionAsync();
            if (success)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Subscription will be canceled at the end of your billing period");
                await LoadDataAsync();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to cancel subscription");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private async Task ReactivateSubscription()
    {
        _isProcessing = true;
        try
        {
            var success = await BillingService.ReactivateSubscriptionAsync();
            if (success)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Subscription reactivated successfully");
                await LoadDataAsync();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to reactivate subscription");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private async Task CancelIncompleteSubscription()
    {
        _isProcessing = true;
        try
        {
            var success = await BillingService.CancelSubscriptionAsync();
            if (success)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Cancelled", "Upgrade cancelled successfully");
                await LoadDataAsync();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to cancel upgrade");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private async Task UpdatePaymentMethod()
    {
        _isProcessing = true;
        try
        {
            var returnUrl = Navigation.Uri;
            var url = await BillingService.GetUpdatePaymentUrlAsync(returnUrl);
            if (!string.IsNullOrEmpty(url))
            {
                await JS.InvokeVoidAsync("open", url, "_self");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to get payment update URL");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private static BadgeStyle GetStatusBadgeStyle(string? status) => status?.ToLower() switch
    {
        "active" => BadgeStyle.Success,
        "past_due" => BadgeStyle.Warning,
        "canceled" => BadgeStyle.Danger,
        "incomplete" => BadgeStyle.Warning,
        _ => BadgeStyle.Light
    };

    private static string GetStatusText(string? status) => status?.ToLower() switch
    {
        "active" => "Active",
        "past_due" => "Past Due",
        "canceled" => "Canceled",
        "incomplete" => "Incomplete",
        "none" => "No Subscription",
        _ => status ?? "Unknown"
    };

    private static string FormatAmount(long amountCents, string currency)
    {
        var amount = amountCents / 100.0m;
        return currency.ToUpperInvariant() switch
        {
            "USD" => amount.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("en-US")),
            "EUR" => amount.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("de-DE")),
            "GBP" => amount.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("en-GB")),
            _ => $"{amount:F2} {currency.ToUpperInvariant()}"
        };
    }

    private static string GetPaymentMethodIcon(string? type) => type?.ToLowerInvariant() switch
    {
        "card" => "credit_card",
        "paypal" => "payment",
        "bank_account" => "account_balance",
        _ => "wallet"
    };

    private static BadgeStyle GetInvoiceStatusBadgeStyle(string? status) => status?.ToLowerInvariant() switch
    {
        "paid" => BadgeStyle.Success,
        "open" => BadgeStyle.Warning,
        "void" => BadgeStyle.Light,
        "uncollectible" => BadgeStyle.Danger,
        _ => BadgeStyle.Info
    };
}
