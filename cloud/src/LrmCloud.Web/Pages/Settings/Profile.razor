@page "/settings/profile"
@attribute [Authorize]
@using LrmCloud.Shared.DTOs.Auth
@using LrmCloud.Shared.DTOs.GitHub
@using LrmCloud.Web.Services
@inject AuthService AuthService
@inject GitHubIntegrationService GitHubService
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@inject Radzen.DialogService DialogService

<PageTitle>Profile Settings - LRM Cloud</PageTitle>

<RadzenText TextStyle="TextStyle.H4" class="rz-mb-4">Profile Settings</RadzenText>

@if (_isLoading)
{
    <RadzenStack Gap="1rem">
        <RadzenCard Style="height: 200px;"><RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" /></RadzenCard>
        <RadzenCard Style="height: 150px;"><RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" /></RadzenCard>
    </RadzenStack>
}
else if (_profile == null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" Shade="Shade.Lighter" AllowClose="false">Failed to load profile</RadzenAlert>
}
else
{
    <!-- Profile Information Card -->
    <RadzenCard class="rz-mb-4">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-4">
            <RadzenIcon Icon="person" />
            <RadzenText TextStyle="TextStyle.H6">Profile Information</RadzenText>
        </RadzenStack>

        <RadzenTemplateForm TItem="object" Data="@(new object())" Submit="@SaveProfileAsync">
            <RadzenRow Gap="1rem">
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenFormField Text="Username" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenTextBox @bind-Value="_username" Name="Username" Style="width: 100%;" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">3-50 characters, letters, numbers, underscores, and hyphens</RadzenText>
                            <RadzenRequiredValidator Component="Username" Text="Username is required" />
                            <RadzenLengthValidator Component="Username" Min="3" Max="50" Text="Username must be 3-50 characters" />
                        </Helper>
                    </RadzenFormField>
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenFormField Text="Display Name" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenTextBox @bind-Value="_displayName" Style="width: 100%;" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Optional - how you appear to others</RadzenText>
                        </Helper>
                    </RadzenFormField>
                </RadzenColumn>
                <RadzenColumn Size="12">
                    <RadzenFormField Text="Email" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenTextBox Value="@_profile.Email" ReadOnly="true" Style="width: 100%;" />
                        </ChildContent>
                        <End>
                            @if (_profile.EmailVerified)
                            {
                                <RadzenIcon Icon="verified" Style="color: var(--rz-success);" />
                            }
                            else
                            {
                                <RadzenIcon Icon="warning" Style="color: var(--rz-warning);" />
                            }
                        </End>
                    </RadzenFormField>
                </RadzenColumn>
                <RadzenColumn Size="12">
                    <RadzenFormField Text="Avatar URL" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenTextBox @bind-Value="_avatarUrl" Style="width: 100%;" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">URL to your avatar image</RadzenText>
                        </Helper>
                    </RadzenFormField>
                </RadzenColumn>
                @if (!string.IsNullOrEmpty(_avatarUrl))
                {
                    <RadzenColumn Size="12">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary rz-mb-2">Preview:</RadzenText>
                        <RadzenImage Path="@_avatarUrl" Style="width: 64px; height: 64px; border-radius: 50%; object-fit: cover;" AlternateText="Avatar preview" />
                    </RadzenColumn>
                }
            </RadzenRow>
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" class="rz-mt-4">
                <RadzenButton ButtonType="Radzen.ButtonType.Submit" ButtonStyle="ButtonStyle.Primary" Text="Save Changes" Disabled="@_isSaving" IsBusy="@_isSaving" />
            </RadzenStack>
        </RadzenTemplateForm>
    </RadzenCard>

    <!-- Account Information Card -->
    <RadzenCard class="rz-mb-4">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-4">
            <RadzenIcon Icon="info" />
            <RadzenText TextStyle="TextStyle.H6">Account Information</RadzenText>
        </RadzenStack>

        <RadzenDataGrid TItem="AccountInfo" Data="@GetAccountInfo()" AllowSorting="false" AllowPaging="false" Density="Density.Compact">
            <Columns>
                <RadzenDataGridColumn TItem="AccountInfo" Property="Label" Title="" Width="200px">
                    <Template Context="item">
                        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">@item.Label</RadzenText>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="AccountInfo" Property="Value" Title="">
                    <Template Context="item">
                        @if (item.Label == "Auth Method")
                        {
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                                @if (_profile!.AuthType == "github")
                                {
                                    <RadzenIcon Icon="code" Style="font-size: 1rem;" />
                                    <RadzenText>GitHub</RadzenText>
                                }
                                else
                                {
                                    <RadzenIcon Icon="email" Style="font-size: 1rem;" />
                                    <RadzenText>Email</RadzenText>
                                }
                            </RadzenStack>
                        }
                        else if (item.Label == "Plan")
                        {
                            <RadzenBadge BadgeStyle="@GetPlanBadgeStyle(_profile!.Plan)" Text="@_profile.Plan.ToUpperInvariant()" />
                        }
                        else
                        {
                            <RadzenText>@item.Value</RadzenText>
                        }
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    </RadzenCard>

    <!-- GitHub Account Card -->
    <RadzenCard class="rz-mb-4">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-4">
            <RadzenIcon Icon="code" />
            <RadzenText TextStyle="TextStyle.H6">GitHub Account</RadzenText>
        </RadzenStack>

        @if (_isLoadingGitHub)
        {
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Small" />
        }
        else if (_gitHubStatus?.Connected == true)
        {
            <RadzenAlert AlertStyle="AlertStyle.Success" AllowClose="false" Shade="Shade.Lighter" class="rz-mb-4">
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                    <RadzenIcon Icon="check_circle" />
                    <RadzenText TextStyle="TextStyle.Body1" class="rz-mb-0">
                        Connected
                        @if (!string.IsNullOrEmpty(_gitHubStatus.GitHubLogin))
                        {
                            <text> as <strong>@@@_gitHubStatus.GitHubLogin</strong></text>
                        }
                    </RadzenText>
                </RadzenStack>
            </RadzenAlert>

            <RadzenRow Gap="1rem" class="rz-mb-4">
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Repository Access</RadzenText>
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                            @if (_gitHubStatus.HasRepoScope)
                            {
                                <RadzenIcon Icon="check" Style="color: var(--rz-success); font-size: 1rem;" />
                                <RadzenText>Full repository access</RadzenText>
                            }
                            else
                            {
                                <RadzenIcon Icon="warning" Style="color: var(--rz-warning); font-size: 1rem;" />
                                <RadzenText>Limited access</RadzenText>
                            }
                        </RadzenStack>
                    </RadzenStack>
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Projects Using Token</RadzenText>
                        <RadzenText>@_gitHubStatus.ProjectsUsingToken project(s)</RadzenText>
                    </RadzenStack>
                </RadzenColumn>
            </RadzenRow>

            @if (_gitHubStatus.ProjectsUsingToken > 0)
            {
                <RadzenAlert AlertStyle="AlertStyle.Warning" AllowClose="false" Shade="Shade.Lighter" class="rz-mb-4">
                    <RadzenText TextStyle="TextStyle.Body2" class="rz-mb-0">
                        @_gitHubStatus.ProjectsUsingToken project(s) are using your GitHub token.
                        You must reconfigure those projects before disconnecting.
                    </RadzenText>
                </RadzenAlert>
            }

            <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Danger"
                          Text="Disconnect GitHub" Icon="link_off"
                          Click="@DisconnectGitHubAsync"
                          Disabled="@(_isDisconnectingGitHub || _gitHubStatus.ProjectsUsingToken > 0)"
                          IsBusy="@_isDisconnectingGitHub" />
        }
        else
        {
            <RadzenAlert AlertStyle="AlertStyle.Info" AllowClose="false" Shade="Shade.Lighter" class="rz-mb-4">
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Body1" class="rz-mb-0">
                        <strong>GitHub not connected</strong>
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2">
                        Connect your GitHub account to enable repository sync for your projects without entering Personal Access Tokens.
                    </RadzenText>
                </RadzenStack>
            </RadzenAlert>

            <RadzenButton Variant="Radzen.Variant.Filled" ButtonStyle="ButtonStyle.Primary"
                          Text="Connect GitHub Account" Icon="link"
                          Click="@ConnectGitHubAsync" />
        }
    </RadzenCard>

    <!-- Change Password Card (only for email auth) -->
    @if (_profile.AuthType == "email")
    {
        <RadzenCard class="rz-mb-4">
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-4">
                <RadzenIcon Icon="lock" />
                <RadzenText TextStyle="TextStyle.H6">Change Password</RadzenText>
            </RadzenStack>

            <RadzenTemplateForm TItem="object" Data="@(new object())" Submit="@ChangePasswordAsync">
                <RadzenRow Gap="1rem">
                    <RadzenColumn Size="12">
                        <RadzenFormField Text="Current Password" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                            <ChildContent>
                                <RadzenPassword @bind-Value="_currentPassword" Name="CurrentPassword" Style="width: 100%;" autocomplete="current-password" />
                            </ChildContent>
                            <Helper>
                                <RadzenRequiredValidator Component="CurrentPassword" Text="Current password is required" />
                            </Helper>
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenFormField Text="New Password" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                            <ChildContent>
                                <RadzenPassword @bind-Value="_newPassword" Name="NewPassword" Style="width: 100%;" autocomplete="new-password" />
                            </ChildContent>
                            <Helper>
                                <RadzenRequiredValidator Component="NewPassword" Text="New password is required" />
                                <RadzenLengthValidator Component="NewPassword" Min="12" Text="Password must be at least 12 characters" />
                            </Helper>
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenFormField Text="Confirm New Password" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                            <ChildContent>
                                <RadzenPassword @bind-Value="_confirmPassword" Name="ConfirmPassword" Style="width: 100%;" autocomplete="new-password" />
                            </ChildContent>
                            <Helper>
                                <RadzenRequiredValidator Component="ConfirmPassword" Text="Please confirm your password" />
                                <RadzenCompareValidator Component="ConfirmPassword" Value="@_newPassword" Text="Passwords do not match" />
                            </Helper>
                        </RadzenFormField>
                    </RadzenColumn>
                </RadzenRow>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" class="rz-mt-4">
                    <RadzenButton ButtonType="Radzen.ButtonType.Submit" ButtonStyle="ButtonStyle.Primary" Text="Change Password" Disabled="@_isChangingPassword" IsBusy="@_isChangingPassword" />
                </RadzenStack>
            </RadzenTemplateForm>
        </RadzenCard>
    }

    <!-- Danger Zone Card -->
    <RadzenCard>
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-4">
            <RadzenIcon Icon="warning" Style="color: var(--rz-danger);" />
            <RadzenText TextStyle="TextStyle.H6" Style="color: var(--rz-danger);">Danger Zone</RadzenText>
        </RadzenStack>

        <RadzenAlert AlertStyle="AlertStyle.Warning" Shade="Shade.Lighter" AllowClose="false" class="rz-mb-4">
            Deleting your account is permanent and cannot be undone. All your projects, translations, and settings will be permanently deleted.
        </RadzenAlert>

        <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Danger" Text="Delete Account" Click="@OpenDeleteDialog" />
    </RadzenCard>
}

@code {
    private UserProfileDto? _profile;
    private bool _isLoading = true;
    private bool _isSaving;
    private bool _isChangingPassword;

    // Profile form
    private string _username = string.Empty;
    private string _displayName = string.Empty;
    private string _avatarUrl = string.Empty;

    // Password form
    private string _currentPassword = string.Empty;
    private string _newPassword = string.Empty;
    private string _confirmPassword = string.Empty;

    // GitHub
    private UserGitHubStatus? _gitHubStatus;
    private bool _isLoadingGitHub;
    private bool _isDisconnectingGitHub;

    // Helper class for account info display
    private class AccountInfo
    {
        public string Label { get; set; } = "";
        public string Value { get; set; } = "";
    }

    protected override async Task OnInitializedAsync()
    {
        // Load profile and GitHub status in parallel
        var profileTask = LoadProfileAsync();
        var githubTask = LoadGitHubStatusAsync();
        await Task.WhenAll(profileTask, githubTask);
    }

    private IEnumerable<AccountInfo> GetAccountInfo()
    {
        if (_profile == null) yield break;

        yield return new AccountInfo { Label = "Auth Method", Value = _profile.AuthType };
        yield return new AccountInfo { Label = "Plan", Value = _profile.Plan };
        yield return new AccountInfo { Label = "Account Created", Value = _profile.CreatedAt.ToString("MMMM d, yyyy") };
        if (_profile.LastLoginAt.HasValue)
        {
            yield return new AccountInfo { Label = "Last Login", Value = _profile.LastLoginAt.Value.ToString("g") };
        }
    }

    private async Task LoadProfileAsync()
    {
        _isLoading = true;
        var result = await AuthService.GetProfileAsync();

        if (result.IsSuccess && result.Profile != null)
        {
            _profile = result.Profile;
            _username = _profile.Username;
            _displayName = _profile.DisplayName ?? string.Empty;
            _avatarUrl = _profile.AvatarUrl ?? string.Empty;
        }
        else
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", result.ErrorMessage ?? "Failed to load profile");
        }

        _isLoading = false;
    }

    private async Task SaveProfileAsync()
    {
        _isSaving = true;

        var request = new UpdateProfileRequest
        {
            Username = _username,
            DisplayName = string.IsNullOrWhiteSpace(_displayName) ? null : _displayName,
            AvatarUrl = string.IsNullOrWhiteSpace(_avatarUrl) ? null : _avatarUrl
        };

        var result = await AuthService.UpdateProfileAsync(request);

        if (result.IsSuccess)
        {
            _profile = result.Profile;
            NotificationService.Notify(NotificationSeverity.Success, "Success", result.SuccessMessage ?? "Profile updated");
        }
        else
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", result.ErrorMessage ?? "Failed to update profile");
        }

        _isSaving = false;
    }

    private async Task ChangePasswordAsync()
    {
        if (_newPassword != _confirmPassword)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Passwords do not match");
            return;
        }

        _isChangingPassword = true;

        var request = new ChangePasswordRequest
        {
            CurrentPassword = _currentPassword,
            NewPassword = _newPassword
        };

        var result = await AuthService.ChangePasswordAsync(request);

        if (result.IsSuccess)
        {
            NotificationService.Notify(NotificationSeverity.Success, "Success", result.SuccessMessage ?? "Password changed");
            _currentPassword = string.Empty;
            _newPassword = string.Empty;
            _confirmPassword = string.Empty;
        }
        else
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", result.ErrorMessage ?? "Failed to change password");
        }

        _isChangingPassword = false;
    }

    private async Task OpenDeleteDialog()
    {
        var result = await DialogService.OpenAsync<DeleteAccountDialog>(
            "Delete Account",
            new Dictionary<string, object>(),
            new Radzen.DialogOptions { Width = "500px" });

        if (result == true)
        {
            NavigationManager.NavigateTo("/app");
        }
    }

    private static BadgeStyle GetPlanBadgeStyle(string plan) => plan.ToLowerInvariant() switch
    {
        "pro" => BadgeStyle.Primary,
        "team" => BadgeStyle.Secondary,
        _ => BadgeStyle.Light
    };

    // GitHub methods
    private async Task LoadGitHubStatusAsync()
    {
        _isLoadingGitHub = true;
        try
        {
            _gitHubStatus = await GitHubService.GetUserGitHubStatusAsync();
        }
        catch
        {
            // Ignore errors - just show not connected
            _gitHubStatus = null;
        }
        _isLoadingGitHub = false;
    }

    private async Task ConnectGitHubAsync()
    {
        // First, initiate the link to get a short-lived code
        var (success, code, error) = await AuthService.InitiateGitHubLinkAsync();

        if (!success || string.IsNullOrEmpty(code))
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", error ?? "Failed to initiate GitHub linking");
            return;
        }

        // Then redirect to the link endpoint with the code
        NavigationManager.NavigateTo($"/api/auth/github/link?code={code}", forceLoad: true);
    }

    private async Task DisconnectGitHubAsync()
    {
        // Double-check projects aren't using the token
        if (_gitHubStatus?.ProjectsUsingToken > 0)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Cannot Disconnect",
                $"{_gitHubStatus.ProjectsUsingToken} project(s) are using your GitHub token. Reconfigure them first.");
            return;
        }

        var confirmed = await DialogService.Confirm(
            "Are you sure you want to disconnect your GitHub account? Projects using your token will need to be reconfigured.",
            "Disconnect GitHub",
            new Radzen.ConfirmOptions { OkButtonText = "Disconnect", CancelButtonText = "Cancel" });

        if (confirmed != true)
            return;

        _isDisconnectingGitHub = true;
        try
        {
            var result = await AuthService.UnlinkGitHubAsync();
            if (result.IsSuccess)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", "GitHub account disconnected");
                _gitHubStatus = null;
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", result.ErrorMessage ?? "Failed to disconnect GitHub");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
        _isDisconnectingGitHub = false;
    }
}
