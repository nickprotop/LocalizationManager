@page "/settings/translation"
@attribute [Authorize]
@using LrmCloud.Shared.DTOs.Translation
@using LrmCloud.Web.Services
@using LrmCloud.Web.Helpers
@inject TranslationService TranslationService
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService
@inject NavigationManager Navigation

<PageTitle>Translation Providers - LRM Cloud</PageTitle>

<RadzenStack Gap="1rem">
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
        <RadzenText TextStyle="TextStyle.H5">Translation Providers</RadzenText>
        <RadzenButton Variant="Radzen.Variant.Outlined" Icon="refresh" Text="Refresh" Click="@LoadProvidersAsync" Disabled="@_isLoading" />
    </RadzenStack>

    <!-- User Level Indicator -->
    <RadzenCard Variant="Radzen.Variant.Text" Style="border-left: 4px solid var(--rz-primary);">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Start" Gap="1rem">
            <RadzenIcon Icon="person" Style="color: var(--rz-primary);" />
            <RadzenStack Gap="0.25rem">
                <RadzenText TextStyle="TextStyle.Subtitle1"><strong>Your Personal Settings</strong> (User Level)</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
                    Configure your personal API keys and provider options. These settings apply to all your projects
                    unless overridden at the project level.
                </RadzenText>
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>

    <!-- Hierarchy Explanation -->
    <RadzenAccordion>
        <Items>
            <RadzenAccordionItem Text="How do translation providers work?">
                <RadzenStack Gap="1rem">
                    <RadzenText TextStyle="TextStyle.Body2">
                        LRM Cloud offers two types of translation providers:
                    </RadzenText>

                    <RadzenDataGrid TItem="ProviderTypeInfo" Data="@_providerTypeInfo" AllowSorting="false" AllowPaging="false" Density="Density.Compact">
                        <Columns>
                            <RadzenDataGridColumn TItem="ProviderTypeInfo" Property="Type" Title="Provider Type">
                                <Template Context="info">
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                                        <RadzenIcon Icon="@info.Icon" Style="@($"color: {info.Color}; font-size: 1rem;")" />
                                        <strong>@info.Type</strong>
                                    </RadzenStack>
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="ProviderTypeInfo" Property="Description" Title="Description" />
                            <RadzenDataGridColumn TItem="ProviderTypeInfo" Property="Limits" Title="Limits" />
                        </Columns>
                    </RadzenDataGrid>

                    <hr />

                    <RadzenText TextStyle="TextStyle.Subtitle2">API Key Configuration Hierarchy</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2">
                        For BYOK providers, API keys can be configured at multiple levels. Higher priority overrides lower priority:
                    </RadzenText>

                    <RadzenStack Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary"><strong>Personal Projects:</strong></RadzenText>
                        <RadzenCard Variant="Radzen.Variant.Text" Style="text-align: center;">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" JustifyContent="JustifyContent.Center">
                                <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Project" />
                                <RadzenIcon Icon="arrow_back" Style="font-size: 1rem;" />
                                <RadzenBadge BadgeStyle="BadgeStyle.Primary" Text="User (You)" />
                            </RadzenStack>
                        </RadzenCard>

                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary"><strong>Organization Projects:</strong></RadzenText>
                        <RadzenCard Variant="Radzen.Variant.Text" Style="text-align: center;">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" JustifyContent="JustifyContent.Center">
                                <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Project" />
                                <RadzenIcon Icon="arrow_back" Style="font-size: 1rem;" />
                                <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text="Organization" />
                            </RadzenStack>
                        </RadzenCard>
                    </RadzenStack>

                    <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false">
                        Your personal API keys are only used for your personal projects.
                        Organization projects use organization-level keys to ensure consistent billing.
                    </RadzenAlert>
                </RadzenStack>
            </RadzenAccordionItem>
        </Items>
    </RadzenAccordion>

    @if (_isLoading)
    {
        <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Style="height: 4px;" />
    }
    else
    {
        @* LRM Managed Translation Service *@
        @if (LrmProvider != null)
        {
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mt-4">
                <RadzenIcon Icon="star" Style="color: var(--rz-warning);" />
                <RadzenText TextStyle="TextStyle.H6">LRM Managed Translation</RadzenText>
            </RadzenStack>
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary rz-mb-2">
                Our managed translation service. Free tier: 10,000 characters/month. No API key required - we handle everything.
            </RadzenText>

            <RadzenRow Gap="1rem">
                <RadzenColumn Size="12" SizeSM="6">
                    <ProviderCard Provider="LrmProvider" OnConfigure="OpenConfigureDialog" />
                </RadzenColumn>
            </RadzenRow>

            <hr class="rz-my-4" />
        }

        @* Free Community Providers *@
        <RadzenText TextStyle="TextStyle.H6">Free Community Providers</RadzenText>
        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary rz-mb-2">
            Open source and community-powered providers. No API key required, but may have rate limits.
        </RadzenText>

        <RadzenRow Gap="1rem">
            @foreach (var provider in _providers.Where(p => !p.RequiresApiKey && !p.IsManagedProvider))
            {
                <RadzenColumn Size="12" SizeSM="6">
                    <ProviderCard Provider="provider" OnConfigure="OpenConfigureDialog" />
                </RadzenColumn>
            }
        </RadzenRow>

        <hr class="rz-my-4" />

        @* BYOK Providers *@
        <RadzenText TextStyle="TextStyle.H6">Bring Your Own Key (BYOK)</RadzenText>
        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary rz-mb-2">
            Add your own API keys for premium providers. You pay the provider directly for usage.
        </RadzenText>

        <RadzenRow Gap="1rem">
            @foreach (var provider in _providers.Where(p => p.RequiresApiKey))
            {
                <RadzenColumn Size="12" SizeSM="6">
                    <ProviderCard Provider="provider" OnConfigure="OpenConfigureDialog" OnRemove="RemoveApiKey" />
                </RadzenColumn>
            }
        </RadzenRow>
    }

    <hr class="rz-my-4" />

    <RadzenText TextStyle="TextStyle.H6">Your Usage This Month</RadzenText>
    @if (_usage != null)
    {
        <RadzenCard class="rz-p-4">
            <RadzenStack Gap="1rem">
                <!-- LRM Translation Usage -->
                <RadzenStack Gap="0.25rem">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                            <RadzenIcon Icon="star" Style="color: var(--rz-warning); font-size: 1rem;" />
                            <RadzenText TextStyle="TextStyle.Body1"><strong>LRM Translation</strong></RadzenText>
                        </RadzenStack>
                        @if (_usage.CharacterLimit.HasValue)
                        {
                            <RadzenText TextStyle="TextStyle.Body2">@_usage.CharactersUsed.ToString("N0") / @_usage.CharacterLimit.Value.ToString("N0") chars</RadzenText>
                        }
                    </RadzenStack>
                    @if (_usage.CharacterLimit.HasValue)
                    {
                        <RadzenProgressBar Value="@_usage.UsagePercentage" ProgressBarStyle="@UiHelpers.GetUsageProgressBarStyle(_usage.UsagePercentage)" ShowValue="false" />
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                            Managed translation service - counts against your @_usage.Plan plan
                        </RadzenText>
                    }
                </RadzenStack>

                <!-- Other Providers Usage -->
                <hr />
                <RadzenStack Gap="0.25rem">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                            <RadzenIcon Icon="cloud_queue" class="rz-color-secondary" Style="font-size: 1rem;" />
                            <RadzenText TextStyle="TextStyle.Body1"><strong>Other Providers</strong></RadzenText>
                        </RadzenStack>
                        @if (_usage.OtherCharacterLimit.HasValue)
                        {
                            <RadzenText TextStyle="TextStyle.Body2">@_usage.OtherCharactersUsed.ToString("N0") / @_usage.OtherCharacterLimit.Value.ToString("N0") chars</RadzenText>
                        }
                        else
                        {
                            <RadzenText TextStyle="TextStyle.Body2">@_usage.OtherCharactersUsed.ToString("N0") chars</RadzenText>
                        }
                    </RadzenStack>
                    @if (_usage.OtherCharacterLimit.HasValue)
                    {
                        <RadzenProgressBar Value="@_usage.OtherUsagePercentage" ProgressBarStyle="@UiHelpers.GetUsageProgressBarStyle(_usage.OtherUsagePercentage)" ShowValue="false" />
                    }
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                        BYOK + free community providers (MyMemory, Lingva)
                    </RadzenText>
                </RadzenStack>

                <!-- Reset Date -->
                @if (_usage.ResetsAt.HasValue)
                {
                    <hr />
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                        <RadzenIcon Icon="schedule" Style="font-size: 1rem; vertical-align: middle;" />
                        Usage resets: @_usage.ResetsAt.Value.ToString("MMMM d, yyyy")
                    </RadzenText>
                }
            </RadzenStack>
        </RadzenCard>
    }
    else
    {
        <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Style="height: 4px;" />
    }

    <!-- Quick Links -->
    <RadzenCard Variant="Radzen.Variant.Text" Style="border: 1px dashed var(--rz-base-400);">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
            <RadzenIcon Icon="lightbulb" Style="color: var(--rz-warning);" />
            <RadzenStack Gap="0">
                <RadzenText TextStyle="TextStyle.Body2">
                    <strong>Tip:</strong> Configure shared API keys for your organization in
                    <RadzenLink Path="organizations" Text="Organization Settings" />.
                    Override specific projects in Project Settings.
                </RadzenText>
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>
</RadzenStack>

@code {
    private List<TranslationProviderDto> _providers = new();
    private TranslationUsageDto? _usage;
    private bool _isLoading = true;

    // Computed property for the LRM managed provider
    private TranslationProviderDto? LrmProvider => _providers.FirstOrDefault(p => p.IsManagedProvider);

    // Helper class for provider type info
    private class ProviderTypeInfo
    {
        public string Type { get; set; } = "";
        public string Description { get; set; } = "";
        public string Limits { get; set; } = "";
        public string Icon { get; set; } = "";
        public string Color { get; set; } = "";
    }

    private readonly List<ProviderTypeInfo> _providerTypeInfo = new()
    {
        new() { Type = "LRM Translation", Description = "Our managed translation service. No API key needed - we handle everything.", Limits = "Free: 10K/mo, Team: 100K/mo, Enterprise: Unlimited", Icon = "star", Color = "var(--rz-warning)" },
        new() { Type = "Other Providers", Description = "BYOK (your own API keys) + free community providers (MyMemory, Lingva).", Limits = "Free: 50K/mo, Team: 500K/mo, Enterprise: Unlimited", Icon = "cloud_queue", Color = "var(--rz-text-secondary-color)" }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadProvidersAsync();
        await LoadUsageAsync();
    }

    private async Task LoadProvidersAsync()
    {
        _isLoading = true;
        try
        {
            _providers = await TranslationService.GetProvidersAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load providers: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadUsageAsync()
    {
        try
        {
            _usage = await TranslationService.GetUsageAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load usage: {ex.Message}");
        }
    }

    private async Task OpenConfigureDialog(TranslationProviderDto provider)
    {
        var result = await DialogService.OpenAsync<ConfigureProviderDialog>(
            $"Configure {provider.DisplayName}",
            new Dictionary<string, object> { { "Provider", provider } },
            new Radzen.DialogOptions { Width = "500px" });

        if (result == true)
        {
            await LoadProvidersAsync();
        }
    }

    private async Task RemoveApiKey(TranslationProviderDto provider)
    {
        var confirmed = await DialogService.Confirm(
            $"Are you sure you want to remove the API key for {provider.DisplayName}?",
            "Remove API Key",
            new ConfirmOptions { OkButtonText = "Remove", CancelButtonText = "Cancel" });

        if (confirmed == true)
        {
            var result = await TranslationService.RemoveUserApiKeyAsync(provider.Name);
            if (result.IsSuccess)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", "API key removed");
                await LoadProvidersAsync();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", result.ErrorMessage ?? "Failed to remove API key");
            }
        }
    }
}
