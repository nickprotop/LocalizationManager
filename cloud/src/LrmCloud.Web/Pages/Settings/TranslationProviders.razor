@page "/settings/translation"
@attribute [Authorize]
@using LrmCloud.Shared.DTOs.Translation
@using LrmCloud.Web.Services
@using LrmCloud.Web.Helpers
@inject TranslationService TranslationService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Navigation

<PageTitle>Translation Providers - LRM Cloud</PageTitle>

<MudStack Spacing="4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.h5">Translation Providers</MudText>
            <MudButton Variant="Variant.Outlined"
                       StartIcon="@Icons.Material.Filled.Refresh"
                       OnClick="LoadProvidersAsync"
                       Disabled="_isLoading">
                Refresh
            </MudButton>
        </MudStack>

        <!-- User Level Indicator -->
        <MudPaper Class="pa-4" Elevation="0" Style="background-color: var(--mud-palette-background-grey); border-left: 4px solid var(--mud-palette-primary);">
            <MudStack Row="true" AlignItems="AlignItems.Start" Spacing="3">
                <MudIcon Icon="@Icons.Material.Filled.Person" Color="Color.Primary" />
                <MudStack Spacing="1">
                    <MudText Typo="Typo.subtitle1">
                        <strong>Your Personal Settings</strong> (User Level)
                    </MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Configure your personal API keys and provider options. These settings apply to all your projects
                        unless overridden at the project level.
                    </MudText>
                </MudStack>
            </MudStack>
        </MudPaper>

        <!-- Hierarchy Explanation -->
        <MudExpansionPanels>
            <MudExpansionPanel Text="How do translation providers work?">
                <MudStack Spacing="3">
                    <MudText Typo="Typo.body2">
                        LRM Cloud offers two types of translation providers:
                    </MudText>

                    <MudSimpleTable Dense="true" Hover="true">
                        <thead>
                            <tr>
                                <th>Provider Type</th>
                                <th>Description</th>
                                <th>Limits</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="background-color: var(--mud-palette-warning-lighten);">
                                <td>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        <MudIcon Icon="@Icons.Material.Filled.Star" Size="Size.Small" Color="Color.Warning" />
                                        <strong>LRM Translation</strong>
                                    </MudStack>
                                </td>
                                <td>Our managed translation service. No API key needed - we handle everything.</td>
                                <td>Free: 10K/mo, Team: 100K/mo, Enterprise: Unlimited</td>
                            </tr>
                            <tr>
                                <td>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        <MudIcon Icon="@Icons.Material.Filled.CloudQueue" Size="Size.Small" Color="Color.Secondary" />
                                        <strong>Other Providers</strong>
                                    </MudStack>
                                </td>
                                <td>BYOK (your own API keys) + free community providers (MyMemory, Lingva).</td>
                                <td>Free: 50K/mo, Team: 500K/mo, Enterprise: Unlimited</td>
                            </tr>
                        </tbody>
                    </MudSimpleTable>

                    <MudDivider />

                    <MudText Typo="Typo.subtitle2">API Key Configuration Hierarchy</MudText>
                    <MudText Typo="Typo.body2">
                        For BYOK providers, API keys can be configured at multiple levels. Higher priority overrides lower priority:
                    </MudText>

                    <MudStack Spacing="2">
                        <MudText Typo="Typo.caption" Color="Color.Secondary"><strong>Personal Projects:</strong></MudText>
                        <MudPaper Class="pa-3" Elevation="0" Style="background-color: var(--mud-palette-background-grey);">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Justify="Justify.Center">
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="Color.Success">Project</MudChip>
                                <MudIcon Icon="@Icons.Material.Filled.ArrowBack" Size="Size.Small" />
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="Color.Primary">User (You)</MudChip>
                            </MudStack>
                        </MudPaper>

                        <MudText Typo="Typo.caption" Color="Color.Secondary"><strong>Organization Projects:</strong></MudText>
                        <MudPaper Class="pa-3" Elevation="0" Style="background-color: var(--mud-palette-background-grey);">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Justify="Justify.Center">
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="Color.Success">Project</MudChip>
                                <MudIcon Icon="@Icons.Material.Filled.ArrowBack" Size="Size.Small" />
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="Color.Secondary">Organization</MudChip>
                            </MudStack>
                        </MudPaper>
                    </MudStack>

                    <MudAlert Severity="Severity.Info" Dense="true">
                        Your personal API keys are only used for your personal projects.
                        Organization projects use organization-level keys to ensure consistent billing.
                    </MudAlert>

                    <MudSimpleTable Dense="true" Hover="true">
                        <thead>
                            <tr>
                                <th>Level</th>
                                <th>Where to Configure</th>
                                <th>Used For</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="background-color: var(--mud-palette-primary-lighten);">
                                <td><MudChip T="string" Size="Size.Small" Color="Color.Primary">User</MudChip></td>
                                <td><strong>This page</strong></td>
                                <td>Your personal projects only</td>
                            </tr>
                            <tr>
                                <td><MudChip T="string" Size="Size.Small" Color="Color.Secondary">Organization</MudChip></td>
                                <td>
                                    <MudLink Href="/app/organizations">Organizations</MudLink> &rarr; API Keys
                                </td>
                                <td>All projects in the organization</td>
                            </tr>
                            <tr>
                                <td><MudChip T="string" Size="Size.Small" Color="Color.Success">Project</MudChip></td>
                                <td>Projects &rarr; [Project] &rarr; Settings</td>
                                <td>Overrides user/org keys for that project</td>
                            </tr>
                        </tbody>
                    </MudSimpleTable>
                </MudStack>
            </MudExpansionPanel>
        </MudExpansionPanels>

        @if (_isLoading)
        {
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="200px" />
        }
        else
        {
            @* LRM Managed Translation Service *@
            @if (LrmProvider != null)
            {
                <MudText Typo="Typo.h6" Class="mt-4">
                    <MudIcon Icon="@Icons.Material.Filled.Star" Color="Color.Warning" Size="Size.Small" Style="vertical-align: middle;" />
                    LRM Managed Translation
                </MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                    Our managed translation service. Free tier: 10,000 characters/month. No API key required - we handle everything.
                </MudText>

                <MudGrid Spacing="2">
                    <MudItem xs="12" sm="6">
                        <ProviderCard Provider="LrmProvider" OnConfigure="OpenConfigureDialog" />
                    </MudItem>
                </MudGrid>

                <MudDivider Class="my-4" />
            }

            @* Free Community Providers *@
            <MudText Typo="Typo.h6">Free Community Providers</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                Open source and community-powered providers. No API key required, but may have rate limits.
            </MudText>

            <MudGrid Spacing="2">
                @foreach (var provider in _providers.Where(p => !p.RequiresApiKey && !p.IsManagedProvider))
                {
                    <MudItem xs="12" sm="6">
                        <ProviderCard Provider="provider" OnConfigure="OpenConfigureDialog" />
                    </MudItem>
                }
            </MudGrid>

            <MudDivider Class="my-4" />

            @* BYOK Providers *@
            <MudText Typo="Typo.h6">Bring Your Own Key (BYOK)</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                Add your own API keys for premium providers. You pay the provider directly for usage.
            </MudText>

            <MudGrid Spacing="2">
                @foreach (var provider in _providers.Where(p => p.RequiresApiKey))
                {
                    <MudItem xs="12" sm="6">
                        <ProviderCard Provider="provider" OnConfigure="OpenConfigureDialog" OnRemove="RemoveApiKey" />
                    </MudItem>
                }
            </MudGrid>
        }

        <MudDivider Class="my-4" />

        <MudText Typo="Typo.h6">Your Usage This Month</MudText>
        @if (_usage != null)
        {
            <MudPaper Class="pa-4" Elevation="0" Style="background-color: var(--mud-palette-background-grey);">
                <MudStack Spacing="3">
                    <!-- LRM Translation Usage -->
                    <MudStack Spacing="1">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Star" Color="Color.Warning" Size="Size.Small" />
                                <MudText Typo="Typo.body1">
                                    <strong>LRM Translation</strong>
                                </MudText>
                            </MudStack>
                            @if (_usage.CharacterLimit.HasValue)
                            {
                                <MudText Typo="Typo.body2">
                                    @_usage.CharactersUsed.ToString("N0") / @_usage.CharacterLimit.Value.ToString("N0") chars
                                </MudText>
                            }
                        </MudStack>
                        @if (_usage.CharacterLimit.HasValue)
                        {
                            <MudProgressLinear Value="@_usage.UsagePercentage"
                                               Color="@UiHelpers.GetUsageColor(_usage.UsagePercentage)"
                                               Rounded="true"
                                               Size="Size.Medium" />
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                Managed translation service - counts against your @_usage.Plan plan
                            </MudText>
                        }
                    </MudStack>

                    <!-- Other Providers Usage -->
                    <MudDivider />
                    <MudStack Spacing="1">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.CloudQueue" Color="Color.Secondary" Size="Size.Small" />
                                <MudText Typo="Typo.body1">
                                    <strong>Other Providers</strong>
                                </MudText>
                            </MudStack>
                            @if (_usage.OtherCharacterLimit.HasValue)
                            {
                                <MudText Typo="Typo.body2">
                                    @_usage.OtherCharactersUsed.ToString("N0") / @_usage.OtherCharacterLimit.Value.ToString("N0") chars
                                </MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2">
                                    @_usage.OtherCharactersUsed.ToString("N0") chars
                                </MudText>
                            }
                        </MudStack>
                        @if (_usage.OtherCharacterLimit.HasValue)
                        {
                            <MudProgressLinear Value="@_usage.OtherUsagePercentage"
                                               Color="@UiHelpers.GetUsageColor(_usage.OtherUsagePercentage)"
                                               Rounded="true"
                                               Size="Size.Medium" />
                        }
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            BYOK + free community providers (MyMemory, Lingva)
                        </MudText>
                    </MudStack>

                    <!-- Reset Date -->
                    @if (_usage.ResetsAt.HasValue)
                    {
                        <MudDivider />
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" Style="vertical-align: middle;" />
                            Usage resets: @_usage.ResetsAt.Value.ToString("MMMM d, yyyy")
                        </MudText>
                    }
                </MudStack>
            </MudPaper>
        }
        else
        {
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="120px" />
        }

        <!-- Quick Links -->
        <MudPaper Class="pa-4 mt-4" Elevation="0" Style="border: 1px dashed var(--mud-palette-lines-default);">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Lightbulb" Color="Color.Warning" />
                <MudStack Spacing="0">
                    <MudText Typo="Typo.body2">
                        <strong>Tip:</strong> Configure shared API keys for your organization in
                        <MudLink Href="/app/organizations">Organization Settings</MudLink>.
                        Override specific projects in Project Settings.
                    </MudText>
                </MudStack>
            </MudStack>
        </MudPaper>
</MudStack>

@code {
    private List<TranslationProviderDto> _providers = new();
    private TranslationUsageDto? _usage;
    private bool _isLoading = true;

    // Computed property for the LRM managed provider
    private TranslationProviderDto? LrmProvider => _providers.FirstOrDefault(p => p.IsManagedProvider);

    protected override async Task OnInitializedAsync()
    {
        await LoadProvidersAsync();
        await LoadUsageAsync();
    }

    private async Task LoadProvidersAsync()
    {
        _isLoading = true;
        try
        {
            _providers = await TranslationService.GetProvidersAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load providers: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadUsageAsync()
    {
        try
        {
            _usage = await TranslationService.GetUsageAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load usage: {ex.Message}", Severity.Error);
        }
    }

    private async Task OpenConfigureDialog(TranslationProviderDto provider)
    {
        var parameters = new DialogParameters
        {
            { nameof(ConfigureProviderDialog.Provider), provider }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<ConfigureProviderDialog>($"Configure {provider.DisplayName}", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            await LoadProvidersAsync();
        }
    }

    private async Task RemoveApiKey(TranslationProviderDto provider)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Remove API Key",
            $"Are you sure you want to remove the API key for {provider.DisplayName}?",
            yesText: "Remove",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            var result = await TranslationService.RemoveUserApiKeyAsync(provider.Name);
            if (result.IsSuccess)
            {
                Snackbar.Add("API key removed", Severity.Success);
                await LoadProvidersAsync();
            }
            else
            {
                Snackbar.Add(result.ErrorMessage ?? "Failed to remove API key", Severity.Error);
            }
        }
    }
}
