@page "/settings/translation"
@attribute [Authorize]
@using LrmCloud.Shared.DTOs.Translation
@using LrmCloud.Web.Services
@inject TranslationService TranslationService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Navigation

<PageTitle>Translation Providers - LRM Cloud</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="py-4">
    <MudStack Spacing="4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.h5">Translation Providers</MudText>
            <MudButton Variant="Variant.Outlined"
                       StartIcon="@Icons.Material.Filled.Refresh"
                       OnClick="LoadProvidersAsync"
                       Disabled="_isLoading">
                Refresh
            </MudButton>
        </MudStack>

        <!-- User Level Indicator -->
        <MudPaper Class="pa-4" Elevation="0" Style="background-color: var(--mud-palette-background-grey); border-left: 4px solid var(--mud-palette-primary);">
            <MudStack Row="true" AlignItems="AlignItems.Start" Spacing="3">
                <MudIcon Icon="@Icons.Material.Filled.Person" Color="Color.Primary" />
                <MudStack Spacing="1">
                    <MudText Typo="Typo.subtitle1">
                        <strong>Your Personal Settings</strong> (User Level)
                    </MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Configure your personal API keys and provider options. These settings apply to all your projects
                        unless overridden at the project level.
                    </MudText>
                </MudStack>
            </MudStack>
        </MudPaper>

        <!-- Hierarchy Explanation -->
        <MudExpansionPanels>
            <MudExpansionPanel Text="How does configuration hierarchy work?">
                <MudStack Spacing="3">
                    <MudText Typo="Typo.body2">
                        LRM Cloud supports configuration at multiple levels. Higher levels override lower levels:
                    </MudText>

                    <MudPaper Class="pa-3" Elevation="0" Style="background-color: var(--mud-palette-background-grey);">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Justify="Justify.Center">
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="Color.Default">Platform</MudChip>
                            <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" />
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="Color.Secondary">Organization</MudChip>
                            <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" />
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="Color.Primary">User (You)</MudChip>
                            <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" />
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="Color.Success">Project</MudChip>
                        </MudStack>
                    </MudPaper>

                    <MudSimpleTable Dense="true" Hover="true">
                        <thead>
                            <tr>
                                <th>Level</th>
                                <th>Where to Configure</th>
                                <th>Who Can Configure</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><MudChip T="string" Size="Size.Small" Color="Color.Default">Platform</MudChip></td>
                                <td>Server configuration</td>
                                <td>System administrator</td>
                            </tr>
                            <tr>
                                <td><MudChip T="string" Size="Size.Small" Color="Color.Secondary">Organization</MudChip></td>
                                <td>
                                    <MudLink Href="organizations">Organizations</MudLink> &rarr; Settings
                                </td>
                                <td>Organization admin/owner</td>
                            </tr>
                            <tr style="background-color: var(--mud-palette-primary-lighten);">
                                <td><MudChip T="string" Size="Size.Small" Color="Color.Primary">User</MudChip></td>
                                <td><strong>This page</strong></td>
                                <td>You</td>
                            </tr>
                            <tr>
                                <td><MudChip T="string" Size="Size.Small" Color="Color.Success">Project</MudChip></td>
                                <td>Projects &rarr; [Project] &rarr; Translation</td>
                                <td>Project owner</td>
                            </tr>
                        </tbody>
                    </MudSimpleTable>
                </MudStack>
            </MudExpansionPanel>
        </MudExpansionPanels>

        @if (_isLoading)
        {
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="200px" />
        }
        else
        {
            <MudText Typo="Typo.h6" Class="mt-4">Free Providers</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                These providers work without an API key. Some have optional configuration options.
            </MudText>

            <MudGrid Spacing="2">
                @foreach (var provider in _providers.Where(p => !p.RequiresApiKey))
                {
                    <MudItem xs="12" sm="6">
                        <ProviderCard Provider="provider" OnConfigure="OpenConfigureDialog" />
                    </MudItem>
                }
            </MudGrid>

            <MudDivider Class="my-4" />

            <MudText Typo="Typo.h6">API Key Required</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                Add your own API keys for these premium providers. Bring Your Own Key (BYOK) - you only pay for what you use.
            </MudText>

            <MudGrid Spacing="2">
                @foreach (var provider in _providers.Where(p => p.RequiresApiKey))
                {
                    <MudItem xs="12" sm="6">
                        <ProviderCard Provider="provider" OnConfigure="OpenConfigureDialog" OnRemove="RemoveApiKey" />
                    </MudItem>
                }
            </MudGrid>
        }

        <MudDivider Class="my-4" />

        <MudText Typo="Typo.h6">Usage</MudText>
        @if (_usage != null)
        {
            <MudPaper Class="pa-4" Elevation="0" Style="background-color: var(--mud-palette-background-grey);">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudStack>
                        <MudText Typo="Typo.body1">
                            <strong>@_usage.CharactersUsed.ToString("N0")</strong> characters translated
                        </MudText>
                        @if (_usage.CharacterLimit.HasValue)
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                @_usage.CharacterLimit.Value.ToString("N0") limit (@_usage.Plan plan)
                            </MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Unlimited (BYOK)
                            </MudText>
                        }
                    </MudStack>
                    @if (_usage.CharacterLimit.HasValue)
                    {
                        <MudProgressLinear Value="@_usage.UsagePercentage"
                                           Color="@GetUsageColor(_usage.UsagePercentage)"
                                           Style="width: 200px;" />
                    }
                </MudStack>
            </MudPaper>
        }
        else
        {
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="80px" />
        }

        <!-- Quick Links -->
        <MudPaper Class="pa-4 mt-4" Elevation="0" Style="border: 1px dashed var(--mud-palette-lines-default);">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Lightbulb" Color="Color.Warning" />
                <MudStack Spacing="0">
                    <MudText Typo="Typo.body2">
                        <strong>Tip:</strong> Configure shared API keys for your organization in
                        <MudLink Href="organizations">Organization Settings</MudLink>.
                        Override specific projects in Project Settings.
                    </MudText>
                </MudStack>
            </MudStack>
        </MudPaper>
    </MudStack>
</MudContainer>

@code {
    private List<TranslationProviderDto> _providers = new();
    private TranslationUsageDto? _usage;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadProvidersAsync();
        await LoadUsageAsync();
    }

    private async Task LoadProvidersAsync()
    {
        _isLoading = true;
        try
        {
            _providers = await TranslationService.GetProvidersAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load providers: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadUsageAsync()
    {
        try
        {
            _usage = await TranslationService.GetUsageAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load usage: {ex.Message}", Severity.Error);
        }
    }

    private async Task OpenConfigureDialog(TranslationProviderDto provider)
    {
        var parameters = new DialogParameters
        {
            { nameof(ConfigureProviderDialog.Provider), provider }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<ConfigureProviderDialog>($"Configure {provider.DisplayName}", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            await LoadProvidersAsync();
        }
    }

    private async Task RemoveApiKey(TranslationProviderDto provider)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Remove API Key",
            $"Are you sure you want to remove the API key for {provider.DisplayName}?",
            yesText: "Remove",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            var result = await TranslationService.RemoveUserApiKeyAsync(provider.Name);
            if (result.IsSuccess)
            {
                Snackbar.Add("API key removed", Severity.Success);
                await LoadProvidersAsync();
            }
            else
            {
                Snackbar.Add(result.ErrorMessage ?? "Failed to remove API key", Severity.Error);
            }
        }
    }

    private static Color GetUsageColor(double percentage) => percentage switch
    {
        >= 90 => Color.Error,
        >= 70 => Color.Warning,
        _ => Color.Primary
    };
}
