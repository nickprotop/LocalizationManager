@page "/settings/glossary"
@using LrmCloud.Shared.DTOs.Glossary
@using LrmCloud.Web.Services
@inject GlossaryService GlossaryService
@inject OrganizationContextService OrgContext
@inject OrganizationService OrganizationService
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService
@attribute [Authorize]

<PageTitle>Organization Glossary - LRM Cloud</PageTitle>

<RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" class="rz-mb-4">
    <RadzenStack Gap="0.25rem">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
            <RadzenIcon Icon="book" />
            <RadzenText TextStyle="TextStyle.H4">Organization Glossary</RadzenText>
        </RadzenStack>
        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
            Terms shared across ALL projects in your organization. Individual projects can override these.
        </RadzenText>
    </RadzenStack>
    @if (_canManage)
    {
        <RadzenButton Variant="Radzen.Variant.Filled" ButtonStyle="ButtonStyle.Primary" Icon="add" Text="Add Term" Click="@OpenAddDialog" Disabled="@(_organizationId == null)" />
    }
</RadzenStack>

@if (_organizationId == null)
{
    <RadzenAlert AlertStyle="AlertStyle.Warning" Shade="Shade.Lighter" AllowClose="false">
        No organization selected. Please select an organization to manage its glossary.
    </RadzenAlert>
}
else if (_isLoading)
{
    <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Style="height: 4px;" />
}
else if (_glossary == null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" Shade="Shade.Lighter" AllowClose="false">Failed to load glossary.</RadzenAlert>
}
else
{
    <RadzenRow Gap="1rem">
        @* Stats *@
        <RadzenColumn Size="12" SizeMD="4">
            <RadzenCard class="rz-p-4">
                <RadzenStack Gap="0.5rem">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenText>Total Terms</RadzenText>
                        <RadzenText TextStyle="TextStyle.H6">@_glossary.TotalCount</RadzenText>
                    </RadzenStack>
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenText>Languages</RadzenText>
                        <RadzenText TextStyle="TextStyle.H6">@_glossary.Languages.Count</RadzenText>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>

        @* Filter *@
        <RadzenColumn Size="12" SizeMD="8">
            <RadzenCard class="rz-p-4">
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" AlignItems="Radzen.AlignItems.Center">
                    <RadzenTextBox @bind-Value="_searchTerm" Placeholder="Search terms..." Style="max-width: 300px;">
                        <RadzenIcon Icon="search" />
                    </RadzenTextBox>

                    @if (_glossary.Languages.Count > 0)
                    {
                        <RadzenDropDown @bind-Value="_languageFilter" Data="@GetLanguageOptions()" TextProperty="Text" ValueProperty="Value" Placeholder="All Languages" Style="max-width: 150px;" AllowClear="true" />
                    }
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>

        @* Terms Table *@
        <RadzenColumn Size="12">
            <RadzenCard>
                @if (FilteredTerms.Count == 0)
                {
                    <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false" class="rz-m-4">
                        @if (_glossary.TotalCount == 0)
                        {
                            <span>No glossary terms defined yet. Click "Add Term" to create one.</span>
                        }
                        else
                        {
                            <span>No terms match your filters.</span>
                        }
                    </RadzenAlert>
                }
                else
                {
                    <RadzenDataGrid TItem="GlossaryTermDto" Data="@FilteredTerms" Density="Density.Compact" AllowSorting="false" AllowPaging="true" PageSize="20">
                        <Columns>
                            <RadzenDataGridColumn TItem="GlossaryTermDto" Property="SourceTerm" Title="Term">
                                <Template Context="term">
                                    <RadzenStack Gap="0">
                                        <RadzenText Style="font-weight: 500;">@term.SourceTerm</RadzenText>
                                        @if (!string.IsNullOrEmpty(term.Description))
                                        {
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">@term.Description</RadzenText>
                                        }
                                    </RadzenStack>
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="GlossaryTermDto" Property="SourceLanguage" Title="Source">
                                <Template Context="term">
                                    <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="@term.SourceLanguage.ToUpperInvariant()" />
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="GlossaryTermDto" Title="Translations">
                                <Template Context="term">
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.25rem" Wrap="FlexWrap.Wrap">
                                        @foreach (var (lang, translation) in term.Translations.Take(4))
                                        {
                                            <RadzenBadge BadgeStyle="BadgeStyle.Light" Variant="Radzen.Variant.Outlined" title="@translation" Text="@($"{lang.ToUpperInvariant()}: {TruncateText(translation, 20)}")" />
                                        }
                                        @if (term.Translations.Count > 4)
                                        {
                                            <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@($"+{term.Translations.Count - 4}")" />
                                        }
                                    </RadzenStack>
                                </Template>
                            </RadzenDataGridColumn>
                            @if (_canManage)
                            {
                                <RadzenDataGridColumn TItem="GlossaryTermDto" Title="Actions" Width="100px">
                                    <Template Context="term">
                                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.25rem">
                                            <RadzenButton Icon="edit" Variant="Radzen.Variant.Text" Size="ButtonSize.Small" Click="@(() => OpenEditDialog(term))" />
                                            <RadzenButton Icon="delete" Variant="Radzen.Variant.Text" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Click="@(() => ConfirmDelete(term))" />
                                        </RadzenStack>
                                    </Template>
                                </RadzenDataGridColumn>
                            }
                        </Columns>
                    </RadzenDataGrid>
                }
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    @* Info Alert *@
    <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false" class="rz-mt-4">
        Organization glossary terms are inherited by all projects. Projects can define their own terms which will override organization terms for the same source term and language.
    </RadzenAlert>
}

@code {
    private int? _organizationId;
    private GlossaryListResponse? _glossary;
    private bool _isLoading = true;
    private bool _canManage = false;
    private string _searchTerm = "";
    private string? _languageFilter;

    private List<string> _availableLanguages = new() { "en", "fr", "de", "es", "it", "el", "pt", "nl", "pl", "ru", "ja", "zh", "ko" };

    private List<GlossaryTermDto> FilteredTerms => _glossary?.Terms
        .Where(t => string.IsNullOrEmpty(_searchTerm) ||
                    t.SourceTerm.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    t.Description?.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) == true ||
                    t.Translations.Values.Any(v => v.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase)))
        .Where(t => string.IsNullOrEmpty(_languageFilter) ||
                    t.SourceLanguage == _languageFilter ||
                    t.Translations.ContainsKey(_languageFilter))
        .ToList() ?? new();

    private List<object> GetLanguageOptions()
    {
        var options = new List<object> { new { Text = "All Languages", Value = (string?)null } };
        options.AddRange(_glossary?.Languages.Select(l => new { Text = l.ToUpperInvariant(), Value = (string?)l } as object) ?? Array.Empty<object>());
        return options;
    }

    protected override async Task OnInitializedAsync()
    {
        await OrgContext.InitializeAsync();
        _organizationId = OrgContext.SelectedOrganizationId;

        if (_organizationId.HasValue)
        {
            await CheckPermissionsAsync();
            await LoadGlossaryAsync();
        }
        else
        {
            _isLoading = false;
        }

        OrgContext.OnOrganizationChanged += OnOrgChanged;
    }

    private async void OnOrgChanged()
    {
        _organizationId = OrgContext.SelectedOrganizationId;
        if (_organizationId.HasValue)
        {
            await CheckPermissionsAsync();
            await LoadGlossaryAsync();
        }
        else
        {
            _glossary = null;
            _isLoading = false;
        }
        await InvokeAsync(StateHasChanged);
    }

    private async Task CheckPermissionsAsync()
    {
        if (!_organizationId.HasValue)
        {
            _canManage = false;
            return;
        }

        try
        {
            var orgs = await OrganizationService.GetOrganizationsAsync();
            var org = orgs?.FirstOrDefault(o => o.Id == _organizationId.Value);
            _canManage = org?.UserRole is "owner" or "admin";
        }
        catch
        {
            _canManage = false;
        }
    }

    private async Task LoadGlossaryAsync()
    {
        if (!_organizationId.HasValue) return;

        _isLoading = true;
        try
        {
            _glossary = await GlossaryService.GetOrganizationGlossaryAsync(_organizationId.Value);

            // Update available languages based on glossary
            if (_glossary?.Languages.Count > 0)
            {
                _availableLanguages = _glossary.Languages
                    .Union(_availableLanguages)
                    .Distinct()
                    .OrderBy(l => l)
                    .ToList();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error loading glossary: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OpenAddDialog()
    {
        var result = await DialogService.OpenAsync<GlossaryTermDialog>(
            "Add Glossary Term",
            new Dictionary<string, object>
            {
                { "OrganizationId", _organizationId!.Value },
                { "AvailableLanguages", _availableLanguages }
            },
            new Radzen.DialogOptions { Width = "600px" });

        if (result == true)
        {
            await LoadGlossaryAsync();
        }
    }

    private async Task OpenEditDialog(GlossaryTermDto term)
    {
        var result = await DialogService.OpenAsync<GlossaryTermDialog>(
            "Edit Glossary Term",
            new Dictionary<string, object>
            {
                { "OrganizationId", _organizationId!.Value },
                { "AvailableLanguages", _availableLanguages },
                { "EditingTerm", term }
            },
            new Radzen.DialogOptions { Width = "600px" });

        if (result == true)
        {
            await LoadGlossaryAsync();
        }
    }

    private async Task ConfirmDelete(GlossaryTermDto term)
    {
        var confirmed = await DialogService.Confirm(
            $"Are you sure you want to delete the term \"{term.SourceTerm}\"? This will affect all projects that inherit this term.",
            "Delete Term",
            new ConfirmOptions { OkButtonText = "Delete", CancelButtonText = "Cancel" });

        if (confirmed == true && _organizationId.HasValue)
        {
            try
            {
                await GlossaryService.DeleteOrganizationTermAsync(_organizationId.Value, term.Id);
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Term deleted");
                await LoadGlossaryAsync();
            }
            catch (Exception ex)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
            }
        }
    }

    private static string TruncateText(string text, int maxLength)
    {
        if (string.IsNullOrEmpty(text) || text.Length <= maxLength)
            return text;
        return text[..maxLength] + "...";
    }

    public void Dispose()
    {
        OrgContext.OnOrganizationChanged -= OnOrgChanged;
    }
}
