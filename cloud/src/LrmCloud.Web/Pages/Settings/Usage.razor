@page "/settings/usage"
@using LrmCloud.Shared.DTOs.Usage
@using LrmCloud.Web.Services
@using LrmCloud.Web.Helpers
@inject UsageService UsageService
@attribute [Authorize]

<PageTitle>Usage Dashboard - LRM Cloud</PageTitle>

<MudText Typo="Typo.h4" Class="mb-2">
    <MudIcon Icon="@Icons.Material.Filled.BarChart" Class="mr-2" Style="vertical-align: middle;" />
    Usage Dashboard
</MudText>
<MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
    Track your translation usage, resource limits, and account activity.
</MudText>

@if (_isLoading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
}
else if (_stats == null)
{
    <MudAlert Severity="Severity.Error">Failed to load usage statistics.</MudAlert>
}
else
{
    <MudGrid>
        @* Section 1: Resource Usage *@
        <MudItem xs="12">
            <MudPaper Class="pa-4" Elevation="2">
                <div class="d-flex justify-space-between align-center mb-4">
                    <MudText Typo="Typo.h6">
                        <MudIcon Icon="@Icons.Material.Filled.DataUsage" Class="mr-2" Style="vertical-align: middle;" />
                        Resource Usage
                    </MudText>
                    <MudChip T="string" Size="Size.Small" Color="@UiHelpers.GetPlanColor(_stats.Plan)">@_stats.Plan.ToUpper()</MudChip>
                </div>

                <MudGrid>
                    @* LRM Translation *@
                    <MudItem xs="12" md="4">
                        <div class="mb-1 d-flex justify-space-between align-center">
                            <MudText Typo="Typo.body2">
                                <MudIcon Icon="@Icons.Material.Filled.Star" Size="Size.Small" Color="Color.Warning" Style="vertical-align: middle;" Class="mr-1" />
                                LRM Translation
                            </MudText>
                            <MudText Typo="Typo.body2" Color="@UiHelpers.GetUsageColor(_stats.TranslationUsagePercent)">
                                @_stats.TranslationUsagePercent%
                            </MudText>
                        </div>
                        <MudProgressLinear Value="@_stats.TranslationUsagePercent"
                                          Color="@UiHelpers.GetUsageColor(_stats.TranslationUsagePercent)"
                                          Size="Size.Medium" Rounded="true" Class="mb-1" />
                        <MudText Typo="Typo.caption">
                            <strong>@_stats.TranslationCharsUsed.ToString("N0")</strong> / @_stats.TranslationCharsLimit.ToString("N0")
                        </MudText>
                        @if (_stats.TranslationCharsResetAt.HasValue)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                Resets @_stats.TranslationCharsResetAt.Value.ToString("MMM d")
                            </MudText>
                        }
                    </MudItem>

                    @* Other Providers *@
                    <MudItem xs="12" md="4">
                        <div class="mb-1 d-flex justify-space-between align-center">
                            <MudText Typo="Typo.body2">
                                <MudIcon Icon="@Icons.Material.Filled.CloudQueue" Size="Size.Small" Color="Color.Secondary" Style="vertical-align: middle;" Class="mr-1" />
                                Other Providers
                            </MudText>
                            <MudText Typo="Typo.body2" Color="@UiHelpers.GetUsageColor(_stats.OtherUsagePercent)">
                                @_stats.OtherUsagePercent%
                            </MudText>
                        </div>
                        <MudProgressLinear Value="@_stats.OtherUsagePercent"
                                          Color="@UiHelpers.GetUsageColor(_stats.OtherUsagePercent)"
                                          Size="Size.Medium" Rounded="true" Class="mb-1" />
                        <MudText Typo="Typo.caption">
                            <strong>@_stats.OtherCharsUsed.ToString("N0")</strong> / @_stats.OtherCharsLimit.ToString("N0")
                        </MudText>
                        @if (_stats.OtherCharsResetAt.HasValue)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                Resets @_stats.OtherCharsResetAt.Value.ToString("MMM d")
                            </MudText>
                        }
                    </MudItem>

                    @* Cloud Storage *@
                    <MudItem xs="12" md="4">
                        <div class="mb-1 d-flex justify-space-between align-center">
                            <MudText Typo="Typo.body2">
                                <MudIcon Icon="@Icons.Material.Filled.Storage" Size="Size.Small" Color="Color.Info" Style="vertical-align: middle;" Class="mr-1" />
                                Cloud Storage
                            </MudText>
                            <MudText Typo="Typo.body2" Color="@UiHelpers.GetUsageColor(_stats.StorageUsagePercent)">
                                @_stats.StorageUsagePercent.ToString("F1")%
                            </MudText>
                        </div>
                        <MudProgressLinear Value="@_stats.StorageUsagePercent"
                                          Color="@UiHelpers.GetUsageColor(_stats.StorageUsagePercent)"
                                          Size="Size.Medium" Rounded="true" Class="mb-1" />
                        <MudText Typo="Typo.caption">
                            <strong>@UiHelpers.FormatBytes(_stats.StorageBytesUsed)</strong> / @UiHelpers.FormatBytes(_stats.StorageBytesLimit)
                        </MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            Max file: @UiHelpers.FormatBytes(_stats.MaxFileSizeBytes)
                        </MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        @* Section 2: Quick Stats Row *@
        <MudItem xs="6" sm="4" md="2">
            <MudPaper Class="pa-3 text-center" Elevation="2">
                <MudIcon Icon="@Icons.Material.Filled.Folder" Size="Size.Medium" Color="Color.Primary" />
                <MudText Typo="Typo.h5" Class="mt-1">@_stats.ProjectCount</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Projects</MudText>
                @if (_stats.MaxProjects != int.MaxValue)
                {
                    <MudText Typo="Typo.caption" Color="Color.Secondary">/ @_stats.MaxProjects max</MudText>
                }
            </MudPaper>
        </MudItem>

        <MudItem xs="6" sm="4" md="2">
            <MudPaper Class="pa-3 text-center" Elevation="2">
                <MudIcon Icon="@Icons.Material.Filled.InsertDriveFile" Size="Size.Medium" Color="Color.Secondary" />
                <MudText Typo="Typo.h5" Class="mt-1">@_stats.ResourceFileCount</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Resource Files</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="6" sm="4" md="2">
            <MudPaper Class="pa-3 text-center" Elevation="2">
                <MudIcon Icon="@Icons.Material.Filled.VpnKey" Size="Size.Medium" Color="Color.Info" />
                <MudText Typo="Typo.h5" Class="mt-1">@_stats.TotalKeyCount</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Localization Keys</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="6" sm="4" md="2">
            <MudPaper Class="pa-3 text-center" Elevation="2">
                <MudIcon Icon="@Icons.Material.Filled.Key" Size="Size.Medium" Color="Color.Success" />
                <MudText Typo="Typo.h5" Class="mt-1">@_stats.ActiveApiKeyCount / @_stats.ApiKeyCount</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">API Keys</MudText>
                @if (_stats.MaxApiKeys != int.MaxValue)
                {
                    <MudText Typo="Typo.caption" Color="Color.Secondary">/ @_stats.MaxApiKeys max</MudText>
                }
            </MudPaper>
        </MudItem>

        <MudItem xs="6" sm="4" md="2">
            <MudPaper Class="pa-3 text-center" Elevation="2">
                <MudIcon Icon="@Icons.Material.Filled.History" Size="Size.Medium" Color="Color.Warning" />
                <MudText Typo="Typo.h5" Class="mt-1">@_stats.TotalSnapshotCount</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Snapshots</MudText>
            </MudPaper>
        </MudItem>

        @* Section 3: Account & Plan *@
        <MudItem xs="12">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Person" Class="mr-2" Style="vertical-align: middle;" />
                    Account & Plan
                </MudText>

                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudList T="string" Dense="true">
                            <MudListItem>
                                <div class="d-flex justify-space-between w-100">
                                    <MudText>Plan</MudText>
                                    <MudChip T="string" Size="Size.Small" Color="@UiHelpers.GetPlanColor(_stats.Plan)">@_stats.Plan.ToUpper()</MudChip>
                                </div>
                            </MudListItem>
                            <MudListItem>
                                <div class="d-flex justify-space-between w-100">
                                    <MudText>Member since</MudText>
                                    <MudText Color="Color.Secondary">@_stats.MemberSince.ToString("MMM d, yyyy")</MudText>
                                </div>
                            </MudListItem>
                        </MudList>
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudText Typo="Typo.subtitle2" Class="mb-2">Plan Limits</MudText>
                        <MudList T="string" Dense="true">
                            <MudListItem>
                                <div class="d-flex justify-space-between w-100">
                                    <MudText Typo="Typo.body2">Max Snapshots</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">@_stats.MaxSnapshots per project</MudText>
                                </div>
                            </MudListItem>
                            <MudListItem>
                                <div class="d-flex justify-space-between w-100">
                                    <MudText Typo="Typo.body2">Snapshot Retention</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">@_stats.SnapshotRetentionDays days</MudText>
                                </div>
                            </MudListItem>
                            <MudListItem>
                                <div class="d-flex justify-space-between w-100">
                                    <MudText Typo="Typo.body2">Max File Size</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">@UiHelpers.FormatBytes(_stats.MaxFileSizeBytes)</MudText>
                                </div>
                            </MudListItem>
                        </MudList>
                    </MudItem>

                    <MudItem xs="12">
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true" Class="mt-2" Disabled="true">
                            Upgrade Plan (Coming Soon)
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>
    </MudGrid>
}

@code {
    private UsageStatsDto? _stats;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadStats();
    }

    private async Task LoadStats()
    {
        _isLoading = true;
        try
        {
            _stats = await UsageService.GetStatsAsync();
        }
        finally
        {
            _isLoading = false;
        }
    }
}
