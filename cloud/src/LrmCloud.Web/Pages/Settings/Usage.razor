@page "/settings/usage"
@using LrmCloud.Shared.DTOs.Usage
@using LrmCloud.Web.Services
@using LrmCloud.Web.Helpers
@inject UsageService UsageService
@attribute [Authorize]

<PageTitle>Usage Dashboard - LRM Cloud</PageTitle>

<RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-2">
    <RadzenIcon Icon="bar_chart" />
    <RadzenText TextStyle="TextStyle.H4">Usage Dashboard</RadzenText>
</RadzenStack>
<RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary rz-mb-4">
    Track your translation usage, resource limits, and account activity.
</RadzenText>

@if (_isLoading)
{
    <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Style="height: 4px;" />
}
else if (_stats == null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" Shade="Shade.Lighter" AllowClose="false">Failed to load usage statistics.</RadzenAlert>
}
else
{
    <RadzenRow Gap="1rem">
        @* Section 1: Resource Usage *@
        <RadzenColumn Size="12">
            <RadzenCard class="rz-p-4">
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-4">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="data_usage" />
                        <RadzenText TextStyle="TextStyle.H6">Resource Usage</RadzenText>
                    </RadzenStack>
                    <RadzenBadge BadgeStyle="@UiHelpers.GetPlanBadgeStyle(_stats.Plan)" Text="@_stats.Plan.ToUpper()" />
                </RadzenStack>

                <RadzenRow Gap="1rem">
                    @* LRM Translation *@
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenStack Gap="0.25rem">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                                    <RadzenIcon Icon="star" Style="color: var(--rz-warning); font-size: 1rem;" />
                                    <RadzenText TextStyle="TextStyle.Body2">LRM Translation</RadzenText>
                                </RadzenStack>
                                <RadzenText TextStyle="TextStyle.Body2" Style="@($"color: {UiHelpers.GetUsageColorValue(_stats.TranslationUsagePercent)};")">
                                    @_stats.TranslationUsagePercent%
                                </RadzenText>
                            </RadzenStack>
                            <RadzenProgressBar Value="@_stats.TranslationUsagePercent" ProgressBarStyle="@UiHelpers.GetUsageProgressBarStyle(_stats.TranslationUsagePercent)" ShowValue="false" />
                            <RadzenText TextStyle="TextStyle.Caption">
                                <strong>@_stats.TranslationCharsUsed.ToString("N0")</strong> / @_stats.TranslationCharsLimit.ToString("N0")
                            </RadzenText>
                            @if (_stats.TranslationCharsResetAt.HasValue)
                            {
                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                    Resets @_stats.TranslationCharsResetAt.Value.ToString("MMM d")
                                </RadzenText>
                            }
                        </RadzenStack>
                    </RadzenColumn>

                    @* Other Providers *@
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenStack Gap="0.25rem">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                                    <RadzenIcon Icon="cloud_queue" class="rz-color-secondary" Style="font-size: 1rem;" />
                                    <RadzenText TextStyle="TextStyle.Body2">Other Providers</RadzenText>
                                </RadzenStack>
                                <RadzenText TextStyle="TextStyle.Body2" Style="@($"color: {UiHelpers.GetUsageColorValue(_stats.OtherUsagePercent)};")">
                                    @_stats.OtherUsagePercent%
                                </RadzenText>
                            </RadzenStack>
                            <RadzenProgressBar Value="@_stats.OtherUsagePercent" ProgressBarStyle="@UiHelpers.GetUsageProgressBarStyle(_stats.OtherUsagePercent)" ShowValue="false" />
                            <RadzenText TextStyle="TextStyle.Caption">
                                <strong>@_stats.OtherCharsUsed.ToString("N0")</strong> / @_stats.OtherCharsLimit.ToString("N0")
                            </RadzenText>
                            @if (_stats.OtherCharsResetAt.HasValue)
                            {
                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                    Resets @_stats.OtherCharsResetAt.Value.ToString("MMM d")
                                </RadzenText>
                            }
                        </RadzenStack>
                    </RadzenColumn>

                    @* Cloud Storage *@
                    <RadzenColumn Size="12" SizeMD="4">
                        <RadzenStack Gap="0.25rem">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                                    <RadzenIcon Icon="storage" Style="color: var(--rz-info); font-size: 1rem;" />
                                    <RadzenText TextStyle="TextStyle.Body2">Cloud Storage</RadzenText>
                                </RadzenStack>
                                <RadzenText TextStyle="TextStyle.Body2" Style="@($"color: {UiHelpers.GetUsageColorValue(_stats.StorageUsagePercent)};")">
                                    @_stats.StorageUsagePercent.ToString("F1")%
                                </RadzenText>
                            </RadzenStack>
                            <RadzenProgressBar Value="@_stats.StorageUsagePercent" ProgressBarStyle="@UiHelpers.GetUsageProgressBarStyle(_stats.StorageUsagePercent)" ShowValue="false" />
                            <RadzenText TextStyle="TextStyle.Caption">
                                <strong>@UiHelpers.FormatBytes(_stats.StorageBytesUsed)</strong> / @UiHelpers.FormatBytes(_stats.StorageBytesLimit)
                            </RadzenText>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                Max file: @UiHelpers.FormatBytes(_stats.MaxFileSizeBytes)
                            </RadzenText>
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenCard>
        </RadzenColumn>

        @* Section 2: Quick Stats Row *@
        <RadzenColumn Size="6" SizeSM="4" SizeMD="2">
            <RadzenCard class="rz-p-3" Style="text-align: center;">
                <RadzenIcon Icon="folder" Style="font-size: 1.5rem; color: var(--rz-primary);" />
                <RadzenText TextStyle="TextStyle.H5" class="rz-mt-1">@_stats.ProjectCount</RadzenText>
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Projects</RadzenText>
                @if (_stats.MaxProjects != int.MaxValue)
                {
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">/ @_stats.MaxProjects max</RadzenText>
                }
            </RadzenCard>
        </RadzenColumn>

        <RadzenColumn Size="6" SizeSM="4" SizeMD="2">
            <RadzenCard class="rz-p-3" Style="text-align: center;">
                <RadzenIcon Icon="insert_drive_file" Style="font-size: 1.5rem;" class="rz-color-secondary" />
                <RadzenText TextStyle="TextStyle.H5" class="rz-mt-1">@_stats.ResourceFileCount</RadzenText>
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Resource Files</RadzenText>
            </RadzenCard>
        </RadzenColumn>

        <RadzenColumn Size="6" SizeSM="4" SizeMD="2">
            <RadzenCard class="rz-p-3" Style="text-align: center;">
                <RadzenIcon Icon="vpn_key" Style="font-size: 1.5rem; color: var(--rz-info);" />
                <RadzenText TextStyle="TextStyle.H5" class="rz-mt-1">@_stats.TotalKeyCount</RadzenText>
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Localization Keys</RadzenText>
            </RadzenCard>
        </RadzenColumn>

        <RadzenColumn Size="6" SizeSM="4" SizeMD="2">
            <RadzenCard class="rz-p-3" Style="text-align: center;">
                <RadzenIcon Icon="key" Style="font-size: 1.5rem; color: var(--rz-success);" />
                <RadzenText TextStyle="TextStyle.H5" class="rz-mt-1">@_stats.ActiveApiKeyCount / @_stats.ApiKeyCount</RadzenText>
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">API Keys</RadzenText>
                @if (_stats.MaxApiKeys != int.MaxValue)
                {
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">/ @_stats.MaxApiKeys max</RadzenText>
                }
            </RadzenCard>
        </RadzenColumn>

        <RadzenColumn Size="6" SizeSM="4" SizeMD="2">
            <RadzenCard class="rz-p-3" Style="text-align: center;">
                <RadzenIcon Icon="history" Style="font-size: 1.5rem; color: var(--rz-warning);" />
                <RadzenText TextStyle="TextStyle.H5" class="rz-mt-1">@_stats.TotalSnapshotCount</RadzenText>
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Snapshots</RadzenText>
            </RadzenCard>
        </RadzenColumn>

        @* Section 3: Account & Plan *@
        <RadzenColumn Size="12">
            <RadzenCard class="rz-p-4">
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-3">
                    <RadzenIcon Icon="person" />
                    <RadzenText TextStyle="TextStyle.H6">Account & Plan</RadzenText>
                </RadzenStack>

                <RadzenRow Gap="1rem">
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenStack Gap="0.5rem">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenText>Plan</RadzenText>
                                <RadzenBadge BadgeStyle="@UiHelpers.GetPlanBadgeStyle(_stats.Plan)" Text="@_stats.Plan.ToUpper()" />
                            </RadzenStack>
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenText>Member since</RadzenText>
                                <RadzenText class="rz-color-secondary">@_stats.MemberSince.ToString("MMM d, yyyy")</RadzenText>
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenColumn>

                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-2">Plan Limits</RadzenText>
                        <RadzenStack Gap="0.5rem">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenText TextStyle="TextStyle.Body2">Max Snapshots</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">@_stats.MaxSnapshots per project</RadzenText>
                            </RadzenStack>
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenText TextStyle="TextStyle.Body2">Snapshot Retention</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">@_stats.SnapshotRetentionDays days</RadzenText>
                            </RadzenStack>
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenText TextStyle="TextStyle.Body2">Max File Size</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">@UiHelpers.FormatBytes(_stats.MaxFileSizeBytes)</RadzenText>
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenColumn>

                    <RadzenColumn Size="12">
                        <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Primary" Text="Upgrade Plan (Coming Soon)" Disabled="true" Style="width: 100%;" class="rz-mt-2" />
                    </RadzenColumn>
                </RadzenRow>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>
}

@code {
    private UsageStatsDto? _stats;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadStats();
    }

    private async Task LoadStats()
    {
        _isLoading = true;
        try
        {
            _stats = await UsageService.GetStatsAsync();
        }
        finally
        {
            _isLoading = false;
        }
    }
}
