@page "/reset-password"
@layout AuthLayout
@inject AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Reset Password - LRM Cloud</PageTitle>

<RadzenStack Gap="1rem">
    <div style="text-align: center;">
        <RadzenIcon Icon="lock_reset" Style="font-size: 3rem; color: var(--rz-primary);" />
        <RadzenText TextStyle="TextStyle.H5" class="rz-mt-2">Set New Password</RadzenText>
        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Enter your new password</RadzenText>
    </div>

    @if (string.IsNullOrEmpty(Token) || string.IsNullOrEmpty(Email))
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Shade="Shade.Lighter" AllowClose="false">
            Invalid or missing reset link.
            <br />
            <RadzenLink Path="forgot-password" Text="Request a new reset link" />
        </RadzenAlert>
    }
    else if (_successMessage != null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Success" Shade="Shade.Lighter" AllowClose="false">
            @_successMessage
        </RadzenAlert>
        <RadzenButton ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Large" class="rz-w-100">
            <RadzenLink Path="login" Text="Go to Login" Style="text-decoration: none; color: inherit;" />
        </RadzenButton>
    }
    else
    {
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <RadzenAlert AlertStyle="AlertStyle.Danger" Shade="Shade.Lighter" AllowClose="false" class="rz-mb-2">
                @_errorMessage
            </RadzenAlert>
        }

        <RadzenTemplateForm TItem="ResetPasswordModel" Data="@_model" Submit="@HandleSubmit">
            <RadzenStack Gap="1rem">
                <RadzenFormField Text="New Password" Variant="Radzen.Variant.Outlined">
                    <ChildContent>
                        <RadzenPassword @bind-Value="_model.NewPassword" Name="NewPassword" autocomplete="new-password" Disabled="@_isLoading" />
                    </ChildContent>
                    <Helper>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Minimum 12 characters</RadzenText>
                        <RadzenRequiredValidator Component="NewPassword" Text="Password is required" />
                        <RadzenLengthValidator Component="NewPassword" Min="12" Text="Password must be at least 12 characters" />
                    </Helper>
                </RadzenFormField>

                <RadzenFormField Text="Confirm Password" Variant="Radzen.Variant.Outlined">
                    <ChildContent>
                        <RadzenPassword @bind-Value="_confirmPassword" Name="ConfirmPassword" autocomplete="new-password" Disabled="@_isLoading" />
                    </ChildContent>
                    <Helper>
                        <RadzenCompareValidator Component="ConfirmPassword" Value="@_model.NewPassword" Text="Passwords do not match" />
                    </Helper>
                </RadzenFormField>

                <RadzenButton ButtonType="Radzen.ButtonType.Submit" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Large" class="rz-w-100 rz-mt-4" Disabled="@(_isLoading || _confirmPassword != _model.NewPassword)">
                    @if (_isLoading)
                    {
                        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.ExtraSmall" class="rz-me-2" />
                        <span>Resetting...</span>
                    }
                    else
                    {
                        <span>Reset Password</span>
                    }
                </RadzenButton>
            </RadzenStack>
        </RadzenTemplateForm>
    }
</RadzenStack>

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "token")]
    public string? Token { get; set; }

    [Parameter]
    [SupplyParameterFromQuery(Name = "email")]
    public string? Email { get; set; }

    private readonly ResetPasswordModel _model = new();
    private string _confirmPassword = string.Empty;
    private bool _isLoading;
    private string? _errorMessage;
    private string? _successMessage;

    private class ResetPasswordModel
    {
        public string NewPassword { get; set; } = string.Empty;
    }

    private async Task HandleSubmit()
    {
        if (_confirmPassword != _model.NewPassword)
        {
            _errorMessage = "Passwords do not match";
            return;
        }

        if (string.IsNullOrEmpty(Token) || string.IsNullOrEmpty(Email))
        {
            _errorMessage = "Missing reset link parameters";
            return;
        }

        _isLoading = true;
        _errorMessage = null;

        try
        {
            var request = new LrmCloud.Shared.DTOs.Auth.ResetPasswordRequest
            {
                Email = Email,
                Token = Token,
                NewPassword = _model.NewPassword
            };

            var result = await AuthService.ResetPasswordAsync(request);

            if (result.IsSuccess)
            {
                _successMessage = result.SuccessMessage ?? "Password reset successful!";
            }
            else
            {
                _errorMessage = result.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }
}
