@page "/login"
@layout AuthLayout
@inject AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Login - LRM Cloud</PageTitle>

<RadzenStack Gap="1rem">
    <div style="text-align: center;">
        <RadzenIcon Icon="language" Style="font-size: 3rem; color: var(--rz-primary);" />
        <RadzenText TextStyle="TextStyle.H4" class="rz-mt-2">LRM Cloud</RadzenText>
        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Sign in to your account</RadzenText>
    </div>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Shade="Shade.Lighter" AllowClose="false">
            @_errorMessage
        </RadzenAlert>
    }

    <RadzenTemplateForm TItem="LoginRequest" Data="@_model" Submit="@HandleLogin">
        <RadzenStack Gap="1rem">
            <RadzenFormField Text="Email" Variant="Radzen.Variant.Outlined">
                <ChildContent>
                    <RadzenTextBox @bind-Value="_model.Email" Name="Email" autocomplete="username" Disabled="@_isLoading" />
                </ChildContent>
                <Helper>
                    <RadzenRequiredValidator Component="Email" Text="Email is required" />
                    <RadzenEmailValidator Component="Email" Text="Invalid email format" />
                </Helper>
            </RadzenFormField>

            <RadzenFormField Text="Password" Variant="Radzen.Variant.Outlined">
                <ChildContent>
                    <RadzenPassword @bind-Value="_model.Password" Name="Password" autocomplete="current-password" Disabled="@_isLoading" />
                </ChildContent>
                <Helper>
                    <RadzenRequiredValidator Component="Password" Text="Password is required" />
                </Helper>
            </RadzenFormField>

            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                <RadzenLink Path="forgot-password" Text="Forgot password?" />
            </RadzenStack>

            <RadzenButton ButtonType="Radzen.ButtonType.Submit" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Large" class="rz-w-100" Disabled="@_isLoading">
                @if (_isLoading)
                {
                    <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.ExtraSmall" class="rz-me-2" />
                    <span>Signing in...</span>
                }
                else
                {
                    <span>Sign In</span>
                }
            </RadzenButton>
        </RadzenStack>
    </RadzenTemplateForm>

    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="1rem">
        <hr style="flex: 1;" />
        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">or</RadzenText>
        <hr style="flex: 1;" />
    </RadzenStack>

    <RadzenButton Variant="Radzen.Variant.Outlined" Size="ButtonSize.Large" class="rz-w-100" Icon="login" Disabled="@_isLoading">
        <a href="/api/auth/github" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 0.5rem;">
            <RadzenIcon Icon="code" /> Continue with GitHub
        </a>
    </RadzenButton>

    <RadzenText TextStyle="TextStyle.Body2" Style="text-align: center;" class="rz-mt-4">
        Don't have an account? <RadzenLink Path="register" Text="Sign up" />
    </RadzenText>
</RadzenStack>

@code {
    private readonly LoginRequest _model = new();
    private bool _isLoading;
    private string? _errorMessage;

    [Parameter]
    [SupplyParameterFromQuery(Name = "returnUrl")]
    public string? ReturnUrl { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (await AuthService.IsAuthenticatedAsync())
        {
            Navigation.NavigateTo(ReturnUrl ?? "", forceLoad: false);
        }
    }

    private async Task HandleLogin()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            var result = await AuthService.LoginAsync(_model);

            if (result.IsSuccess)
            {
                // Don't use forceLoad: true - causes race condition with localStorage persistence
                Navigation.NavigateTo(ReturnUrl ?? "");
            }
            else
            {
                _errorMessage = result.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }
}
