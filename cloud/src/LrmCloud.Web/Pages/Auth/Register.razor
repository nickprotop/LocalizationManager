@page "/register"
@layout AuthLayout
@inject AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Register - LRM Cloud</PageTitle>

<RadzenStack Gap="1rem">
    <div style="text-align: center;">
        <RadzenIcon Icon="language" Style="font-size: 3rem; color: var(--rz-primary);" />
        <RadzenText TextStyle="TextStyle.H4" class="rz-mt-2">LRM Cloud</RadzenText>
        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Create your account</RadzenText>
    </div>

    @if (_successMessage != null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Success" Shade="Shade.Lighter" AllowClose="false">
            @_successMessage
            <br />
            <RadzenLink Path="login" Text="Go to login" />
        </RadzenAlert>
    }
    else
    {
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <RadzenAlert AlertStyle="AlertStyle.Danger" Shade="Shade.Lighter" AllowClose="false" class="rz-mb-2">
                @_errorMessage
            </RadzenAlert>
        }

        <RadzenTemplateForm TItem="RegisterRequest" Data="@_model" Submit="@HandleRegister">
            <RadzenStack Gap="1rem">
                <RadzenFormField Text="Email" Variant="Radzen.Variant.Outlined">
                    <ChildContent>
                        <RadzenTextBox @bind-Value="_model.Email" Name="Email" autocomplete="email" Disabled="@_isLoading" />
                    </ChildContent>
                    <Helper>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">We'll send a verification email</RadzenText>
                        <RadzenRequiredValidator Component="Email" Text="Email is required" />
                        <RadzenEmailValidator Component="Email" Text="Invalid email format" />
                    </Helper>
                </RadzenFormField>

                <RadzenFormField Text="Username" Variant="Radzen.Variant.Outlined">
                    <ChildContent>
                        <RadzenTextBox @bind-Value="_model.Username" Name="Username" autocomplete="username" Disabled="@_isLoading" />
                    </ChildContent>
                    <Helper>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">3-50 characters, letters, numbers, - and _</RadzenText>
                        <RadzenRequiredValidator Component="Username" Text="Username is required" />
                        <RadzenLengthValidator Component="Username" Min="3" Max="50" Text="Username must be 3-50 characters" />
                    </Helper>
                </RadzenFormField>

                <RadzenFormField Text="Password" Variant="Radzen.Variant.Outlined">
                    <ChildContent>
                        <RadzenPassword @bind-Value="_model.Password" Name="Password" autocomplete="new-password" Disabled="@_isLoading" />
                    </ChildContent>
                    <Helper>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Minimum 12 characters</RadzenText>
                        <RadzenRequiredValidator Component="Password" Text="Password is required" />
                        <RadzenLengthValidator Component="Password" Min="12" Text="Password must be at least 12 characters" />
                    </Helper>
                </RadzenFormField>

                <RadzenFormField Text="Confirm Password" Variant="Radzen.Variant.Outlined">
                    <ChildContent>
                        <RadzenPassword @bind-Value="_confirmPassword" Name="ConfirmPassword" autocomplete="new-password" Disabled="@_isLoading" />
                    </ChildContent>
                    <Helper>
                        <RadzenCompareValidator Component="ConfirmPassword" Value="@_model.Password" Text="Passwords do not match" />
                    </Helper>
                </RadzenFormField>

                <RadzenButton ButtonType="Radzen.ButtonType.Submit" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Large" class="rz-w-100 rz-mt-4" Disabled="@(_isLoading || _confirmPassword != _model.Password)">
                    @if (_isLoading)
                    {
                        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.ExtraSmall" class="rz-me-2" />
                        <span>Creating account...</span>
                    }
                    else
                    {
                        <span>Create Account</span>
                    }
                </RadzenButton>
            </RadzenStack>
        </RadzenTemplateForm>

        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="1rem" class="rz-my-2">
            <hr style="flex: 1;" />
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">or</RadzenText>
            <hr style="flex: 1;" />
        </RadzenStack>

        <RadzenButton Variant="Radzen.Variant.Outlined" Size="ButtonSize.Large" class="rz-w-100" Disabled="@_isLoading">
            <a href="/api/auth/github" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 0.5rem;">
                <RadzenIcon Icon="code" /> Continue with GitHub
            </a>
        </RadzenButton>

        <RadzenText TextStyle="TextStyle.Body2" Style="text-align: center;" class="rz-mt-4">
            Already have an account? <RadzenLink Path="login" Text="Sign in" />
        </RadzenText>
    }
</RadzenStack>

@code {
    private readonly RegisterRequest _model = new();
    private string _confirmPassword = string.Empty;
    private bool _isLoading;
    private string? _errorMessage;
    private string? _successMessage;

    protected override async Task OnInitializedAsync()
    {
        if (await AuthService.IsAuthenticatedAsync())
        {
            Navigation.NavigateTo("", forceLoad: false);
        }
    }

    private async Task HandleRegister()
    {
        if (_confirmPassword != _model.Password)
        {
            _errorMessage = "Passwords do not match";
            return;
        }

        _isLoading = true;
        _errorMessage = null;

        try
        {
            var result = await AuthService.RegisterAsync(_model);

            if (result.IsSuccess)
            {
                _successMessage = result.SuccessMessage ?? "Registration successful! Please check your email to verify your account.";
            }
            else
            {
                _errorMessage = result.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }
}
