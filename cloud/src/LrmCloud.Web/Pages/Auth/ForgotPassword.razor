@page "/forgot-password"
@layout AuthLayout
@inject AuthService AuthService

<PageTitle>Forgot Password - LRM Cloud</PageTitle>

<RadzenStack Gap="1rem">
    <div style="text-align: center;">
        <RadzenIcon Icon="lock_reset" Style="font-size: 3rem; color: var(--rz-primary);" />
        <RadzenText TextStyle="TextStyle.H5" class="rz-mt-2">Reset Password</RadzenText>
        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Enter your email to receive a reset link</RadzenText>
    </div>

    @if (_successMessage != null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Success" Shade="Shade.Lighter" AllowClose="false">
            @_successMessage
        </RadzenAlert>
        <RadzenButton Variant="Radzen.Variant.Text" ButtonStyle="ButtonStyle.Primary" class="rz-w-100">
            <RadzenLink Path="login" Text="Back to Login" Style="text-decoration: none; color: inherit;" />
        </RadzenButton>
    }
    else
    {
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <RadzenAlert AlertStyle="AlertStyle.Danger" Shade="Shade.Lighter" AllowClose="false" class="rz-mb-2">
                @_errorMessage
            </RadzenAlert>
        }

        <RadzenTemplateForm TItem="EmailModel" Data="@_model" Submit="@HandleSubmit">
            <RadzenStack Gap="1rem">
                <RadzenFormField Text="Email" Variant="Radzen.Variant.Outlined">
                    <ChildContent>
                        <RadzenTextBox @bind-Value="_model.Email" Name="Email" Disabled="@_isLoading" />
                    </ChildContent>
                    <Helper>
                        <RadzenRequiredValidator Component="Email" Text="Email is required" />
                        <RadzenEmailValidator Component="Email" Text="Invalid email format" />
                    </Helper>
                </RadzenFormField>

                <RadzenButton ButtonType="Radzen.ButtonType.Submit" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Large" class="rz-w-100 rz-mt-4" Disabled="@_isLoading">
                    @if (_isLoading)
                    {
                        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.ExtraSmall" class="rz-me-2" />
                        <span>Sending...</span>
                    }
                    else
                    {
                        <span>Send Reset Link</span>
                    }
                </RadzenButton>
            </RadzenStack>
        </RadzenTemplateForm>

        <RadzenText TextStyle="TextStyle.Body2" Style="text-align: center;" class="rz-mt-4">
            Remember your password? <RadzenLink Path="login" Text="Sign in" />
        </RadzenText>
    }
</RadzenStack>

@code {
    private readonly EmailModel _model = new();
    private bool _isLoading;
    private string? _errorMessage;
    private string? _successMessage;

    private class EmailModel
    {
        public string Email { get; set; } = string.Empty;
    }

    private async Task HandleSubmit()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            var result = await AuthService.ForgotPasswordAsync(_model.Email);

            if (result.IsSuccess)
            {
                _successMessage = result.SuccessMessage ?? "If an account exists with this email, a password reset link has been sent.";
            }
            else
            {
                _errorMessage = result.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }
}
