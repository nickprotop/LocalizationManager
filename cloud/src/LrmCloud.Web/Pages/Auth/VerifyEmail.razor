@page "/verify-email"
@layout AuthLayout
@inject AuthService AuthService

<PageTitle>Verify Email - LRM Cloud</PageTitle>

<MudPaper Class="pa-8" Elevation="3" Style="max-width: 400px; margin: auto;">
    <MudStack Spacing="4" AlignItems="AlignItems.Center">
        @if (_isLoading)
        {
            <MudProgressCircular Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.h6">Verifying your email...</MudText>
        }
        else if (_isSuccess)
        {
            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" Color="Color.Success" />
            <MudText Typo="Typo.h5">Email Verified!</MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary" Align="Align.Center">
                Your email has been verified successfully. You can now log in to your account.
            </MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/login" FullWidth="true">
                Go to Login
            </MudButton>
        }
        else
        {
            <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Large" Color="Color.Error" />
            <MudText Typo="Typo.h5">Verification Failed</MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary" Align="Align.Center">
                @_errorMessage
            </MudText>
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Href="/login" FullWidth="true">
                Go to Login
            </MudButton>
        }
    </MudStack>
</MudPaper>

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "token")]
    public string? Token { get; set; }

    private bool _isLoading = true;
    private bool _isSuccess;
    private string? _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(Token))
        {
            _isLoading = false;
            _errorMessage = "Invalid or missing verification token.";
            return;
        }

        try
        {
            var result = await AuthService.VerifyEmailAsync(Token);
            _isSuccess = result.IsSuccess;
            _errorMessage = result.ErrorMessage ?? "Unable to verify email. The link may have expired.";
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }
}
