@page "/verify-email"
@layout AuthLayout
@inject AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Verify Email - LRM Cloud</PageTitle>

<RadzenCard Style="max-width: 400px; margin: auto; padding: 2rem;">
    <RadzenStack AlignItems="Radzen.AlignItems.Center" Gap="1rem">
        @if (_isLoading)
        {
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
            <RadzenText TextStyle="TextStyle.H6">Verifying your email...</RadzenText>
        }
        else if (_isSuccess)
        {
            <RadzenIcon Icon="check_circle" Style="font-size: 4rem; color: var(--rz-success);" />
            <RadzenText TextStyle="TextStyle.H5">Email Verified!</RadzenText>
            <RadzenText TextStyle="TextStyle.Body1" class="rz-color-secondary" TextAlign="TextAlign.Center">
                Your email has been verified successfully. You can now log in to your account.
            </RadzenText>
            <RadzenButton Variant="Radzen.Variant.Filled" ButtonStyle="ButtonStyle.Primary" Text="Go to Login"
                          Style="width: 100%;" Click="@(() => Navigation.NavigateTo("login"))" />
        }
        else
        {
            <RadzenIcon Icon="error" Style="font-size: 4rem; color: var(--rz-danger);" />
            <RadzenText TextStyle="TextStyle.H5">Verification Failed</RadzenText>
            <RadzenText TextStyle="TextStyle.Body1" class="rz-color-secondary" TextAlign="TextAlign.Center">
                @_errorMessage
            </RadzenText>
            <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Primary" Text="Go to Login"
                          Style="width: 100%;" Click="@(() => Navigation.NavigateTo("login"))" />
        }
    </RadzenStack>
</RadzenCard>

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "token")]
    public string? Token { get; set; }

    [Parameter]
    [SupplyParameterFromQuery(Name = "email")]
    public string? Email { get; set; }

    private bool _isLoading = true;
    private bool _isSuccess;
    private string? _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(Token) || string.IsNullOrEmpty(Email))
        {
            _isLoading = false;
            _errorMessage = "Invalid or missing verification link.";
            return;
        }

        try
        {
            var result = await AuthService.VerifyEmailAsync(Email, Token);
            _isSuccess = result.IsSuccess;
            _errorMessage = result.ErrorMessage ?? "Unable to verify email. The link may have expired.";
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }
}
