@page "/organizations/{OrganizationId:int}/settings"
@attribute [Authorize]
@using LrmCloud.Shared.Constants
@using LrmCloud.Shared.DTOs.Organizations
@using LrmCloud.Shared.DTOs.GitHub
@using LrmCloud.Web.Services
@using LrmCloud.Web.Components
@using LrmCloud.Web.Models
@using LrmCloud.Web.Helpers
@inject OrganizationService OrganizationService
@inject GitHubIntegrationService GitHubService
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService

<PageTitle>Settings - @(_organization?.Name ?? "Organization") - LRM Cloud</PageTitle>

@if (_isLoading)
{
    <RadzenStack Gap="1rem">
        <div style="background: var(--rz-base-light); width: 300px; height: 40px; border-radius: 4px;"></div>
        <LoadingSkeleton Type="LoadingSkeletonType.Form" Rows="4" />
    </RadzenStack>
}
else if (_organization == null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" Shade="Shade.Lighter" AllowClose="false">
        Organization not found or you don't have access to it.
        <RadzenLink Path="organizations" Text="Back to Organizations" class="rz-ms-2" />
    </RadzenAlert>
}
else if (!OrganizationRole.IsAdminOrOwner(_organization.UserRole))
{
    <RadzenAlert AlertStyle="AlertStyle.Warning" Shade="Shade.Lighter" AllowClose="false">
        You don't have permission to access organization settings.
        <RadzenLink Path="@($"organizations/{OrganizationId}")" Text="Back to Organization" class="rz-ms-2" />
    </RadzenAlert>
}
else
{
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-2">
        <RadzenButton Variant="Radzen.Variant.Text" Icon="arrow_back" Click="@(() => Navigation.NavigateTo($"organizations/{OrganizationId}"))" Size="ButtonSize.Small" />
        <RadzenBreadCrumb>
            <RadzenBreadCrumbItem Path="organizations" Text="Organizations" />
            <RadzenBreadCrumbItem Path="@($"organizations/{OrganizationId}")" Text="@_organization.Name" />
            <RadzenBreadCrumbItem Text="Settings" />
        </RadzenBreadCrumb>
    </RadzenStack>

    <RadzenText TextStyle="TextStyle.H5" class="rz-mb-4">Organization Settings</RadzenText>

    <!-- General Settings Card -->
    <RadzenCard class="rz-mb-4">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-4">
            <RadzenIcon Icon="settings" />
            <RadzenText TextStyle="TextStyle.H6">General Settings</RadzenText>
        </RadzenStack>

        <RadzenTemplateForm TItem="UpdateOrganizationRequest" Data="@_updateRequest" Submit="@SaveSettings">
            <RadzenRow Gap="1rem">
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenFormField Text="Organization Name" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenTextBox @bind-Value="_updateRequest.Name" Name="Name" MaxLength="255" Style="width: 100%;" />
                        </ChildContent>
                        <Helper>
                            <RadzenRequiredValidator Component="Name" Text="Name is required" />
                        </Helper>
                    </RadzenFormField>
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenFormField Text="URL Slug" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenTextBox Value="@_organization.Slug" ReadOnly="true" Style="width: 100%;" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Slug cannot be changed</RadzenText>
                        </Helper>
                    </RadzenFormField>
                </RadzenColumn>
                <RadzenColumn Size="12">
                    <RadzenFormField Text="Description" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenTextArea @bind-Value="_updateRequest.Description" Rows="3" MaxLength="1000" Style="width: 100%;" />
                        </ChildContent>
                    </RadzenFormField>
                </RadzenColumn>
            </RadzenRow>

            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" class="rz-mt-4">
                <RadzenButton ButtonType="Radzen.ButtonType.Submit" ButtonStyle="ButtonStyle.Primary" Text="Save Changes" IsBusy="@_isSaving" />
            </RadzenStack>
        </RadzenTemplateForm>
    </RadzenCard>

    <!-- Organization Info Card -->
    <RadzenCard class="rz-mb-4">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-4">
            <RadzenIcon Icon="info" />
            <RadzenText TextStyle="TextStyle.H6">Organization Information</RadzenText>
        </RadzenStack>

        <RadzenStack Gap="0.75rem">
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem">
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="width: 150px;">Organization ID</RadzenText>
                <RadzenText>@_organization.Id</RadzenText>
            </RadzenStack>
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" AlignItems="Radzen.AlignItems.Center">
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="width: 150px;">Plan</RadzenText>
                <RadzenBadge BadgeStyle="@UiHelpers.GetPlanBadgeStyle(_organization.Plan)" Text="@_organization.Plan.ToUpperInvariant()" />
            </RadzenStack>
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" AlignItems="Radzen.AlignItems.Center">
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="width: 150px;">Members</RadzenText>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                    <RadzenText>@_organization.MemberCount</RadzenText>
                    <RadzenButton Variant="Radzen.Variant.Text" Size="ButtonSize.Small" Text="Manage" Click="@(() => Navigation.NavigateTo($"organizations/{OrganizationId}/members"))" />
                </RadzenStack>
            </RadzenStack>
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" AlignItems="Radzen.AlignItems.Center">
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="width: 150px;">Your Role</RadzenText>
                <RadzenBadge BadgeStyle="@UiHelpers.GetRoleBadgeStyle(_organization.UserRole)" Text="@_organization.UserRole" />
            </RadzenStack>
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem">
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="width: 150px;">Created</RadzenText>
                <RadzenText>@_organization.CreatedAt.ToString("MMMM d, yyyy")</RadzenText>
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>

    <!-- GitHub Integration Card -->
    <RadzenCard class="rz-mb-4">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-4">
            <RadzenIcon Icon="code" />
            <RadzenText TextStyle="TextStyle.H6">GitHub Integration</RadzenText>
        </RadzenStack>

        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary rz-mb-4">
            Connect a GitHub account to provide repository access for all projects in this organization.
            Projects can use this shared token instead of individual Personal Access Tokens.
        </RadzenText>

        @if (_isLoadingGitHub)
        {
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Small" />
        }
        else if (_orgGitHubStatus?.Connected == true)
        {
            <RadzenAlert AlertStyle="AlertStyle.Success" AllowClose="false" Shade="Shade.Lighter" class="rz-mb-4">
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                    <RadzenIcon Icon="check_circle" />
                    <RadzenText TextStyle="TextStyle.Body1" class="rz-mb-0">
                        GitHub connected
                        @if (!string.IsNullOrEmpty(_orgGitHubStatus.ConnectedByUsername))
                        {
                            <text> by <strong>@@@_orgGitHubStatus.ConnectedByUsername</strong></text>
                        }
                    </RadzenText>
                </RadzenStack>
            </RadzenAlert>

            <RadzenRow Gap="1rem" class="rz-mb-4">
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Connected</RadzenText>
                        <RadzenText>@(_orgGitHubStatus.ConnectedAt?.ToString("MMMM d, yyyy") ?? "Unknown")</RadzenText>
                    </RadzenStack>
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Projects Using Token</RadzenText>
                        <RadzenText>@_orgGitHubStatus.ProjectsUsingToken project(s)</RadzenText>
                    </RadzenStack>
                </RadzenColumn>
            </RadzenRow>

            @if (_orgGitHubStatus.ProjectsUsingToken > 0)
            {
                <RadzenAlert AlertStyle="AlertStyle.Warning" AllowClose="false" Shade="Shade.Lighter" class="rz-mb-4">
                    <RadzenText TextStyle="TextStyle.Body2" class="rz-mb-0">
                        @_orgGitHubStatus.ProjectsUsingToken project(s) are using this organization's GitHub token.
                        You must reconfigure those projects before disconnecting.
                    </RadzenText>
                </RadzenAlert>
            }

            <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Danger"
                          Text="Disconnect GitHub" Icon="link_off"
                          Click="@DisconnectOrgGitHubAsync"
                          Disabled="@(_isDisconnectingGitHub || _orgGitHubStatus.ProjectsUsingToken > 0)"
                          IsBusy="@_isDisconnectingGitHub" />
        }
        else
        {
            <RadzenAlert AlertStyle="AlertStyle.Info" AllowClose="false" Shade="Shade.Lighter" class="rz-mb-4">
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Body1" class="rz-mb-0">
                        <strong>GitHub not connected</strong>
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2">
                        Connect your personal GitHub account to enable this organization's projects to use it for repository sync.
                    </RadzenText>
                </RadzenStack>
            </RadzenAlert>

            <RadzenStack Gap="0.5rem">
                @if (!_hasUserGitHubToken)
                {
                    <RadzenAlert AlertStyle="AlertStyle.Warning" AllowClose="false" Shade="Shade.Lighter">
                        <RadzenText TextStyle="TextStyle.Body2" class="rz-mb-0">
                            You need to connect your personal GitHub account first.
                            <RadzenLink Path="settings/profile" Text="Go to Profile Settings" class="rz-ms-1" />
                        </RadzenText>
                    </RadzenAlert>
                }
                else
                {
                    <RadzenButton Variant="Radzen.Variant.Filled" ButtonStyle="ButtonStyle.Primary"
                                  Text="Connect Organization GitHub" Icon="link"
                                  Click="@ConnectOrgGitHubAsync"
                                  IsBusy="@_isConnectingGitHub" />
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                        This will share your personal GitHub token with this organization.
                    </RadzenText>
                }
            </RadzenStack>
        }
    </RadzenCard>

    <!-- Danger Zone (Owner Only) -->
    @if (OrganizationRole.IsOwner(_organization.UserRole))
    {
        <RadzenCard>
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-4">
                <RadzenIcon Icon="warning" Style="color: var(--rz-danger);" />
                <RadzenText TextStyle="TextStyle.H6" Style="color: var(--rz-danger);">Danger Zone</RadzenText>
            </RadzenStack>

            <RadzenStack Gap="1rem">
                <!-- Transfer Ownership -->
                <RadzenCard Style="border: 1px solid var(--rz-base);">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" Wrap="FlexWrap.Wrap" Gap="1rem">
                        <RadzenStack Gap="0.25rem">
                            <RadzenText TextStyle="TextStyle.Subtitle1">Transfer Ownership</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
                                Transfer this organization to another member. You will become an admin.
                            </RadzenText>
                        </RadzenStack>
                        <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Warning" Text="Transfer" Click="@OpenTransferDialog" />
                    </RadzenStack>
                </RadzenCard>

                <!-- Delete Organization -->
                <RadzenCard Style="border: 1px solid var(--rz-danger);">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" Wrap="FlexWrap.Wrap" Gap="1rem">
                        <RadzenStack Gap="0.25rem">
                            <RadzenText TextStyle="TextStyle.Subtitle1" Style="color: var(--rz-danger);">Delete Organization</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
                                Permanently delete this organization and all its data. This cannot be undone.
                            </RadzenText>
                        </RadzenStack>
                        <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Danger" Text="Delete" Click="@OpenDeleteDialog" />
                    </RadzenStack>
                </RadzenCard>
            </RadzenStack>
        </RadzenCard>
    }
}

@code {
    [Parameter]
    public int OrganizationId { get; set; }

    private OrganizationDto? _organization;
    private UpdateOrganizationRequest _updateRequest = new() { Name = "" };
    private bool _isLoading = true;
    private bool _isSaving;

    // GitHub
    private OrganizationGitHubStatus? _orgGitHubStatus;
    private bool _isLoadingGitHub;
    private bool _isConnectingGitHub;
    private bool _isDisconnectingGitHub;
    private bool _hasUserGitHubToken;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            _organization = await OrganizationService.GetOrganizationAsync(OrganizationId);
            if (_organization != null)
            {
                _updateRequest = new UpdateOrganizationRequest
                {
                    Name = _organization.Name,
                    Description = _organization.Description
                };

                // Load GitHub status after main data
                _ = LoadGitHubStatusAsync();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load organization: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SaveSettings()
    {
        _isSaving = true;
        try
        {
            var (success, org, error) = await OrganizationService.UpdateOrganizationAsync(OrganizationId, _updateRequest);

            if (success && org != null)
            {
                _organization = org;
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Settings saved successfully");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", error ?? "Failed to save settings");
            }
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task OpenDeleteDialog()
    {
        var result = await DialogService.OpenAsync<DeleteOrganizationDialog>("Delete Organization",
            new Dictionary<string, object>
            {
                { "OrganizationId", OrganizationId },
                { "OrganizationName", _organization!.Name }
            },
            new Radzen.DialogOptions { Width = "450px" });

        if (result == true)
        {
            Navigation.NavigateTo("organizations");
        }
    }

    private async Task OpenTransferDialog()
    {
        var result = await DialogService.OpenAsync<TransferOwnershipDialog>("Transfer Ownership",
            new Dictionary<string, object> { { "OrganizationId", OrganizationId } },
            new Radzen.DialogOptions { Width = "450px" });

        if (result == true)
        {
            await LoadDataAsync();
        }
    }

    // GitHub methods
    private async Task LoadGitHubStatusAsync()
    {
        _isLoadingGitHub = true;
        StateHasChanged();

        try
        {
            // Load org GitHub status and user token status in parallel
            var orgStatusTask = GitHubService.GetOrganizationGitHubStatusAsync(OrganizationId);
            var userStatusTask = GitHubService.GetUserGitHubStatusAsync();

            await Task.WhenAll(orgStatusTask, userStatusTask);

            _orgGitHubStatus = orgStatusTask.Result;
            _hasUserGitHubToken = userStatusTask.Result?.Connected == true;
        }
        catch
        {
            _orgGitHubStatus = null;
            _hasUserGitHubToken = false;
        }

        _isLoadingGitHub = false;
        StateHasChanged();
    }

    private async Task ConnectOrgGitHubAsync()
    {
        _isConnectingGitHub = true;
        try
        {
            var (success, error) = await GitHubService.ConnectOrganizationGitHubAsync(OrganizationId);
            if (success)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Organization GitHub connected");
                await LoadGitHubStatusAsync();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", error ?? "Failed to connect GitHub");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
        _isConnectingGitHub = false;
    }

    private async Task DisconnectOrgGitHubAsync()
    {
        // Double-check projects aren't using the token
        if (_orgGitHubStatus?.ProjectsUsingToken > 0)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Cannot Disconnect",
                $"{_orgGitHubStatus.ProjectsUsingToken} project(s) are using this organization's GitHub token. Reconfigure them first.");
            return;
        }

        var confirmed = await DialogService.Confirm(
            "Are you sure you want to disconnect the organization's GitHub account? Projects using this token will need to be reconfigured.",
            "Disconnect GitHub",
            new Radzen.ConfirmOptions { OkButtonText = "Disconnect", CancelButtonText = "Cancel" });

        if (confirmed != true)
            return;

        _isDisconnectingGitHub = true;
        try
        {
            var (success, error) = await GitHubService.DisconnectOrganizationGitHubAsync(OrganizationId);
            if (success)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Organization GitHub disconnected");
                _orgGitHubStatus = null;
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", error ?? "Failed to disconnect GitHub");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
        _isDisconnectingGitHub = false;
    }
}
