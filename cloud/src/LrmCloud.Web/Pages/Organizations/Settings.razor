@page "/organizations/{OrganizationId:int}/settings"
@attribute [Authorize]
@using LrmCloud.Shared.Constants
@using LrmCloud.Shared.DTOs.Organizations
@using LrmCloud.Web.Services
@using LrmCloud.Web.Components
@using LrmCloud.Web.Models
@inject OrganizationService OrganizationService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Settings - @(_organization?.Name ?? "Organization") - LRM Cloud</PageTitle>

@if (_isLoading)
{
    <MudStack>
        <MudSkeleton Width="300px" Height="40px" />
        <LoadingSkeleton Type="LoadingSkeletonType.Form" Rows="4" />
    </MudStack>
}
else if (_organization == null)
{
    <MudAlert Severity="Severity.Error">
        Organization not found or you don't have access to it.
        <MudButton Variant="Variant.Text" Color="Color.Primary" Href="organizations">Back to Organizations</MudButton>
    </MudAlert>
}
else if (!OrganizationRole.IsAdminOrOwner(_organization.UserRole))
{
    <MudAlert Severity="Severity.Warning">
        You don't have permission to access organization settings.
        <MudButton Variant="Variant.Text" Color="Color.Primary" Href="@($"/organizations/{OrganizationId}")">Back to Organization</MudButton>
    </MudAlert>
}
else
{
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                       OnClick="@(() => Navigation.NavigateTo($"organizations/{OrganizationId}"))"
                       Size="Size.Small" />
        <MudBreadcrumbs Items="_breadcrumbs" />
    </MudStack>

    <MudText Typo="Typo.h5" Class="mb-4">Organization Settings</MudText>

        <!-- General Settings Card -->
        <MudCard Class="mb-6">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Settings" />
                        <MudText Typo="Typo.h6">General Settings</MudText>
                    </MudStack>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudForm @ref="_settingsForm" @bind-IsValid="_settingsFormValid">
                    <MudGrid Spacing="3">
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="_updateRequest.Name"
                                          Label="Organization Name"
                                          Variant="Variant.Outlined"
                                          Required="true"
                                          RequiredError="Name is required"
                                          MaxLength="255" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField Value="@_organization.Slug"
                                          Label="URL Slug"
                                          Variant="Variant.Outlined"
                                          ReadOnly="true"
                                          HelperText="Slug cannot be changed" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField @bind-Value="_updateRequest.Description"
                                          Label="Description"
                                          Variant="Variant.Outlined"
                                          MaxLength="1000"
                                          Lines="3"
                                          Counter="1000" />
                        </MudItem>
                    </MudGrid>
                </MudForm>
            </MudCardContent>
            <MudCardActions Class="pa-4">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="@SaveSettings"
                           Disabled="@(!_settingsFormValid || _isSaving)">
                    @if (_isSaving)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    Save Changes
                </MudButton>
            </MudCardActions>
        </MudCard>

        <!-- Organization Info Card -->
        <MudCard Class="mb-6">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Info" />
                        <MudText Typo="Typo.h6">Organization Information</MudText>
                    </MudStack>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudSimpleTable Dense="true" Hover="true" Bordered="false" Striped="false" Class="rounded-lg">
                    <tbody>
                        <tr>
                            <td style="width: 200px;"><MudText Typo="Typo.body2" Color="Color.Secondary">Organization ID</MudText></td>
                            <td><MudText>@_organization.Id</MudText></td>
                        </tr>
                        <tr>
                            <td><MudText Typo="Typo.body2" Color="Color.Secondary">Plan</MudText></td>
                            <td>
                                <MudChip T="string" Color="@GetPlanColor(_organization.Plan)" Size="Size.Small">
                                    @_organization.Plan.ToUpperInvariant()
                                </MudChip>
                            </td>
                        </tr>
                        <tr>
                            <td><MudText Typo="Typo.body2" Color="Color.Secondary">Members</MudText></td>
                            <td>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudText>@_organization.MemberCount</MudText>
                                    <MudButton Variant="Variant.Text"
                                               Color="Color.Primary"
                                               Size="Size.Small"
                                               Href="@($"/organizations/{OrganizationId}/members")">
                                        Manage
                                    </MudButton>
                                </MudStack>
                            </td>
                        </tr>
                        <tr>
                            <td><MudText Typo="Typo.body2" Color="Color.Secondary">Your Role</MudText></td>
                            <td>
                                <MudChip T="string" Color="@GetRoleColor(_organization.UserRole)" Size="Size.Small">
                                    @_organization.UserRole
                                </MudChip>
                            </td>
                        </tr>
                        <tr>
                            <td><MudText Typo="Typo.body2" Color="Color.Secondary">Created</MudText></td>
                            <td><MudText>@_organization.CreatedAt.ToString("MMMM d, yyyy")</MudText></td>
                        </tr>
                    </tbody>
                </MudSimpleTable>
            </MudCardContent>
        </MudCard>

        <!-- Danger Zone (Owner Only) -->
        @if (OrganizationRole.IsOwner(_organization.UserRole))
        {
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Error" />
                            <MudText Typo="Typo.h6" Color="Color.Error">Danger Zone</MudText>
                        </MudStack>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack Spacing="4">
                        <!-- Transfer Ownership -->
                        <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid var(--mud-palette-lines-default);">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <div>
                                    <MudText Typo="Typo.subtitle1">Transfer Ownership</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                        Transfer this organization to another member. You will become an admin.
                                    </MudText>
                                </div>
                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Warning"
                                           OnClick="@OpenTransferDialog">
                                    Transfer
                                </MudButton>
                            </MudStack>
                        </MudPaper>

                        <!-- Delete Organization -->
                        <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid var(--mud-palette-error);">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <div>
                                    <MudText Typo="Typo.subtitle1" Color="Color.Error">Delete Organization</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                        Permanently delete this organization and all its data. This cannot be undone.
                                    </MudText>
                                </div>
                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Error"
                                           OnClick="@OpenDeleteDialog">
                                    Delete
                                </MudButton>
                            </MudStack>
                        </MudPaper>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        }
}

<!-- Transfer Ownership Dialog -->
<MudDialog @bind-Visible="_transferDialogVisible" Options="@(new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.SwapHoriz" Color="Color.Warning" />
            <MudText Typo="Typo.h6">Transfer Ownership</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        @if (_isLoadingMembers)
        {
            <MudStack AlignItems="AlignItems.Center" Class="py-4">
                <MudProgressCircular Indeterminate="true" />
                <MudText>Loading members...</MudText>
            </MudStack>
        }
        else if (!_eligibleMembers.Any())
        {
            <MudAlert Severity="Severity.Info">
                There are no other members in this organization. Invite someone first before transferring ownership.
            </MudAlert>
        }
        else
        {
            <MudText Class="mb-4">
                Select a member to transfer ownership to. You will become an admin after the transfer.
            </MudText>
            <MudSelect T="int?" @bind-Value="_selectedNewOwnerId"
                       Label="New Owner"
                       Variant="Variant.Outlined"
                       AnchorOrigin="Origin.BottomCenter">
                @foreach (var member in _eligibleMembers)
                {
                    <MudSelectItem T="int?" Value="@member.UserId">
                        @member.Email (@member.Role)
                    </MudSelectItem>
                }
            </MudSelect>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@CloseTransferDialog">Cancel</MudButton>
        <MudButton Color="Color.Warning"
                   Variant="Variant.Filled"
                   OnClick="@TransferOwnership"
                   Disabled="@(!_selectedNewOwnerId.HasValue || _isTransferring)">
            @if (_isTransferring)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Transfer Ownership
        </MudButton>
    </DialogActions>
</MudDialog>

<!-- Delete Organization Dialog -->
<MudDialog @bind-Visible="_deleteDialogVisible" Options="@(new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Error" />
            <MudText Typo="Typo.h6">Delete Organization</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudText Class="mb-4">
            This action is <strong>permanent</strong> and cannot be undone. Type <code>@_organization?.Name</code> to confirm.
        </MudText>
        <MudTextField @bind-Value="_deleteConfirmation"
                      Label="Organization Name"
                      Variant="Variant.Outlined"
                      Placeholder="@_organization?.Name" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@CloseDeleteDialog">Cancel</MudButton>
        <MudButton Color="Color.Error"
                   Variant="Variant.Filled"
                   OnClick="@DeleteOrganization"
                   Disabled="@(_deleteConfirmation != _organization?.Name || _isDeleting)">
            @if (_isDeleting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Delete Organization
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter]
    public int OrganizationId { get; set; }

    private OrganizationDto? _organization;
    private UpdateOrganizationRequest _updateRequest = new() { Name = "" };
    private bool _isLoading = true;
    private List<BreadcrumbItem> _breadcrumbs = new();

    // Settings form
    private MudForm? _settingsForm;
    private bool _settingsFormValid;
    private bool _isSaving;

    // Delete dialog
    private bool _deleteDialogVisible;
    private bool _isDeleting;
    private string _deleteConfirmation = "";

    // Transfer dialog
    private bool _transferDialogVisible;
    private bool _isTransferring;
    private bool _isLoadingMembers;
    private int? _selectedNewOwnerId;
    private List<OrganizationMemberDto> _eligibleMembers = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            _organization = await OrganizationService.GetOrganizationAsync(OrganizationId);
            if (_organization != null)
            {
                _updateRequest = new UpdateOrganizationRequest
                {
                    Name = _organization.Name,
                    Description = _organization.Description
                };

                _breadcrumbs = new List<BreadcrumbItem>
                {
                    new("Organizations", "/organizations"),
                    new(_organization.Name, $"/organizations/{OrganizationId}"),
                    new("Settings", null, disabled: true)
                };
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load organization: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SaveSettings()
    {
        if (_settingsForm != null)
            await _settingsForm.Validate();

        if (!_settingsFormValid) return;

        _isSaving = true;
        try
        {
            var (success, org, error) = await OrganizationService.UpdateOrganizationAsync(OrganizationId, _updateRequest);

            if (success && org != null)
            {
                _organization = org;
                Snackbar.Add("Settings saved successfully", Severity.Success);
            }
            else
            {
                Snackbar.Add(error ?? "Failed to save settings", Severity.Error);
            }
        }
        finally
        {
            _isSaving = false;
        }
    }

    private void OpenDeleteDialog()
    {
        _deleteConfirmation = "";
        _deleteDialogVisible = true;
    }

    private void CloseDeleteDialog()
    {
        _deleteDialogVisible = false;
    }

    private async Task DeleteOrganization()
    {
        if (_deleteConfirmation != _organization?.Name) return;

        _isDeleting = true;
        try
        {
            var (success, error) = await OrganizationService.DeleteOrganizationAsync(OrganizationId);

            if (success)
            {
                Snackbar.Add("Organization deleted successfully", Severity.Success);
                Navigation.NavigateTo("organizations");
            }
            else
            {
                Snackbar.Add(error ?? "Failed to delete organization", Severity.Error);
            }
        }
        finally
        {
            _isDeleting = false;
            _deleteDialogVisible = false;
        }
    }

    private async Task OpenTransferDialog()
    {
        _selectedNewOwnerId = null;
        _transferDialogVisible = true;
        _isLoadingMembers = true;

        try
        {
            var members = await OrganizationService.GetMembersAsync(OrganizationId);
            // Filter out the current owner - only show non-owners
            _eligibleMembers = members.Where(m => m.Role != OrganizationRole.Owner).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load members: {ex.Message}", Severity.Error);
            _eligibleMembers = new();
        }
        finally
        {
            _isLoadingMembers = false;
        }
    }

    private void CloseTransferDialog()
    {
        _transferDialogVisible = false;
    }

    private async Task TransferOwnership()
    {
        if (!_selectedNewOwnerId.HasValue) return;

        _isTransferring = true;
        try
        {
            var (success, error) = await OrganizationService.TransferOwnershipAsync(OrganizationId, _selectedNewOwnerId.Value);

            if (success)
            {
                Snackbar.Add("Ownership transferred successfully. You are now an admin.", Severity.Success);
                _transferDialogVisible = false;
                // Reload data to reflect the role change
                await LoadDataAsync();
            }
            else
            {
                Snackbar.Add(error ?? "Failed to transfer ownership", Severity.Error);
            }
        }
        finally
        {
            _isTransferring = false;
        }
    }

    private static Color GetPlanColor(string plan) => plan.ToLowerInvariant() switch
    {
        "team" => Color.Secondary,
        "enterprise" => Color.Primary,
        _ => Color.Default
    };

    private static Color GetRoleColor(string role) => role switch
    {
        OrganizationRole.Owner => Color.Error,
        OrganizationRole.Admin => Color.Warning,
        OrganizationRole.Member => Color.Primary,
        OrganizationRole.Viewer => Color.Default,
        _ => Color.Default
    };
}
