@page "/organizations/{OrganizationId:int}/members"
@attribute [Authorize]
@using LrmCloud.Shared.Constants
@using LrmCloud.Shared.DTOs.Organizations
@using LrmCloud.Web.Services
@using LrmCloud.Web.Components
@using LrmCloud.Web.Models
@using LrmCloud.Web.Helpers
@inject OrganizationService OrganizationService
@inject LimitsService LimitsService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Members - @(_organization?.Name ?? "Organization") - LRM Cloud</PageTitle>

@if (_isLoading)
{
    <MudStack>
        <MudSkeleton Width="300px" Height="40px" />
        <LoadingSkeleton Type="LoadingSkeletonType.Table" Rows="5" />
    </MudStack>
}
else if (_organization == null)
{
    <MudAlert Severity="Severity.Error">
        Organization not found or you don't have access to it.
        <MudButton Variant="Variant.Text" Color="Color.Primary" Href="/app/organizations">Back to Organizations</MudButton>
    </MudAlert>
}
else
{
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                       OnClick="@(() => Navigation.NavigateTo($"/app/organizations/{OrganizationId}"))"
                       Size="Size.Small" />
        <MudBreadcrumbs Items="_breadcrumbs" />
    </MudStack>

    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudText Typo="Typo.h5">Team Members</MudText>
        @if (_canInvite)
        {
            <MudTooltip Text="@_memberLimitMessage" Disabled="@_canInviteMember">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.PersonAdd"
                           OnClick="@OpenInviteDialog"
                           Disabled="@(!_canInviteMember)">
                    Invite Member
                </MudButton>
            </MudTooltip>
        }
    </MudStack>

    <MudPaper Elevation="2">
        <MudDataGrid Items="@_members"
                     Dense="true"
                     Hover="true"
                     Striped="true"
                     Filterable="false"
                     SortMode="SortMode.Single">
            <Columns>
                <PropertyColumn Property="x => x.Email" Title="Member">
                    <CellTemplate>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudAvatar Size="Size.Small">
                                @if (!string.IsNullOrEmpty(context.Item.AvatarUrl))
                                {
                                    <MudImage Src="@context.Item.AvatarUrl" Alt="@context.Item.DisplayName" />
                                }
                                else
                                {
                                    @GetMemberInitials(context.Item)
                                }
                            </MudAvatar>
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.body2">
                                    @(context.Item.DisplayName ?? context.Item.Username ?? context.Item.Email)
                                </MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Item.Email</MudText>
                            </MudStack>
                        </MudStack>
                    </CellTemplate>
                </PropertyColumn>

                <PropertyColumn Property="x => x.Role" Title="Role">
                    <CellTemplate>
                        <MudChip T="string" Size="Size.Small" Color="@UiHelpers.GetRoleColor(context.Item.Role)">
                            @context.Item.Role
                        </MudChip>
                    </CellTemplate>
                </PropertyColumn>

                <PropertyColumn Property="x => x.JoinedAt" Title="Joined">
                    <CellTemplate>
                        @if (context.Item.JoinedAt.HasValue)
                        {
                            <MudText Typo="Typo.body2">@context.Item.JoinedAt.Value.ToString("MMM d, yyyy")</MudText>
                        }
                        else
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Outlined">Pending</MudChip>
                        }
                    </CellTemplate>
                </PropertyColumn>

                <TemplateColumn Title="Actions" Sortable="false">
                    <CellTemplate>
                        @if (_canManageMembers && context.Item.Role != OrganizationRole.Owner)
                        {
                            <MudStack Row="true" Spacing="1">
                                @if (_isOwner)
                                {
                                    <MudTooltip Text="Change Role">
                                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                       Size="Size.Small"
                                                       Color="Color.Primary"
                                                       OnClick="@(() => OpenChangeRoleDialog(context.Item))" />
                                    </MudTooltip>
                                }
                                <MudTooltip Text="Remove Member">
                                    <MudIconButton Icon="@Icons.Material.Filled.PersonRemove"
                                                   Size="Size.Small"
                                                   Color="Color.Error"
                                                   OnClick="@(() => OpenRemoveDialog(context.Item))" />
                                </MudTooltip>
                            </MudStack>
                        }
                    </CellTemplate>
                </TemplateColumn>
            </Columns>

            <NoRecordsContent>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="pa-4">
                    No members found. Invite team members to get started.
                </MudText>
            </NoRecordsContent>
        </MudDataGrid>
    </MudPaper>
}

<!-- Invite Member Dialog -->
<MudDialog @bind-Visible="_inviteDialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.PersonAdd" />
            <MudText Typo="Typo.h6">Invite Team Member</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="_inviteForm" @bind-IsValid="_inviteFormValid">
            <MudStack Spacing="3">
                <MudTextField @bind-Value="_inviteRequest.Email"
                              Label="Email Address"
                              Variant="Variant.Outlined"
                              Required="true"
                              RequiredError="Email is required"
                              Validation="@(new Func<string, IEnumerable<string>>(ValidateEmail))"
                              InputType="InputType.Email"
                              HelperText="The person will receive an invitation email" />

                <MudSelect @bind-Value="_inviteRequest.Role"
                           Label="Role"
                           Variant="Variant.Outlined"
                           Required="true"
                           HelperText="@GetRoleDescription(_inviteRequest.Role)">
                    <MudSelectItem Value="@OrganizationRole.Admin">Admin</MudSelectItem>
                    <MudSelectItem Value="@OrganizationRole.Member">Member</MudSelectItem>
                    <MudSelectItem Value="@OrganizationRole.Viewer">Viewer</MudSelectItem>
                </MudSelect>

                <MudAlert Severity="Severity.Info" Dense="true">
                    <MudText Typo="Typo.body2">
                        An email invitation will be sent. The invitation expires in 7 days.
                    </MudText>
                </MudAlert>
            </MudStack>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@CloseInviteDialog">Cancel</MudButton>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   OnClick="@InviteMember"
                   Disabled="@(!_inviteFormValid || _isInviting)">
            @if (_isInviting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Send Invitation
        </MudButton>
    </DialogActions>
</MudDialog>

<!-- Change Role Dialog -->
<MudDialog @bind-Visible="_changeRoleDialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.ExtraSmall, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">Change Role</MudText>
    </TitleContent>
    <DialogContent>
        <MudText Class="mb-4">
            Change role for <strong>@(_selectedMember?.DisplayName ?? _selectedMember?.Email)</strong>
        </MudText>
        <MudSelect @bind-Value="_newRole"
                   Label="Role"
                   Variant="Variant.Outlined"
                   HelperText="@GetRoleDescription(_newRole)">
            <MudSelectItem Value="@OrganizationRole.Admin">Admin</MudSelectItem>
            <MudSelectItem Value="@OrganizationRole.Member">Member</MudSelectItem>
            <MudSelectItem Value="@OrganizationRole.Viewer">Viewer</MudSelectItem>
        </MudSelect>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@CloseChangeRoleDialog">Cancel</MudButton>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   OnClick="@ChangeRole"
                   Disabled="@(_isChangingRole || _newRole == _selectedMember?.Role)">
            @if (_isChangingRole)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Update Role
        </MudButton>
    </DialogActions>
</MudDialog>

<!-- Remove Member Dialog -->
<MudDialog @bind-Visible="_removeDialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.ExtraSmall, FullWidth = true })">
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Error" />
            <MudText Typo="Typo.h6">Remove Member</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudText>
            Are you sure you want to remove <strong>@(_selectedMember?.DisplayName ?? _selectedMember?.Email)</strong> from this organization?
        </MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
            They will lose access to all organization projects immediately.
        </MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@CloseRemoveDialog">Cancel</MudButton>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Error"
                   OnClick="@RemoveMember"
                   Disabled="_isRemoving">
            @if (_isRemoving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Remove
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter]
    public int OrganizationId { get; set; }

    private OrganizationDto? _organization;
    private List<OrganizationMemberDto> _members = new();
    private bool _isLoading = true;
    private bool _canInvite;
    private bool _canManageMembers;
    private bool _isOwner;
    private bool _canInviteMember = true;
    private string? _memberLimitMessage;
    private List<BreadcrumbItem> _breadcrumbs = new();

    // Invite dialog
    private bool _inviteDialogVisible;
    private bool _inviteFormValid;
    private bool _isInviting;
    private MudForm? _inviteForm;
    private InviteMemberRequest _inviteRequest = new() { Email = "", Role = OrganizationRole.Member };

    // Change role dialog
    private bool _changeRoleDialogVisible;
    private bool _isChangingRole;
    private OrganizationMemberDto? _selectedMember;
    private string _newRole = OrganizationRole.Member;

    // Remove dialog
    private bool _removeDialogVisible;
    private bool _isRemoving;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task CheckMemberLimitAsync()
    {
        var (canInvite, reason) = await LimitsService.CanInviteMemberAsync(_members.Count);
        _canInviteMember = canInvite;
        _memberLimitMessage = reason;
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            _organization = await OrganizationService.GetOrganizationAsync(OrganizationId);
            if (_organization != null)
            {
                _members = await OrganizationService.GetMembersAsync(OrganizationId);
                _isOwner = OrganizationRole.IsOwner(_organization.UserRole);
                _canManageMembers = OrganizationRole.IsAdminOrOwner(_organization.UserRole);
                _canInvite = _canManageMembers;

                // Check member limit
                await CheckMemberLimitAsync();

                _breadcrumbs = new List<BreadcrumbItem>
                {
                    new("Organizations", "/organizations"),
                    new(_organization.Name, $"/organizations/{OrganizationId}"),
                    new("Members", null, disabled: true)
                };
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load organization: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    // ============================================================
    // Invite Member
    // ============================================================

    private void OpenInviteDialog()
    {
        _inviteRequest = new InviteMemberRequest { Email = "", Role = OrganizationRole.Member };
        _inviteDialogVisible = true;
    }

    private void CloseInviteDialog()
    {
        _inviteDialogVisible = false;
    }

    private async Task InviteMember()
    {
        if (_inviteForm != null)
            await _inviteForm.Validate();

        if (!_inviteFormValid) return;

        _isInviting = true;
        try
        {
            var (success, error) = await OrganizationService.InviteMemberAsync(OrganizationId, _inviteRequest);

            if (success)
            {
                Snackbar.Add("Invitation sent successfully", Severity.Success);
                CloseInviteDialog();
                LimitsService.InvalidateCache();
                await LoadDataAsync();
            }
            else
            {
                Snackbar.Add(error ?? "Failed to send invitation", Severity.Error);
            }
        }
        finally
        {
            _isInviting = false;
        }
    }

    // ============================================================
    // Change Role
    // ============================================================

    private void OpenChangeRoleDialog(OrganizationMemberDto member)
    {
        _selectedMember = member;
        _newRole = member.Role;
        _changeRoleDialogVisible = true;
    }

    private void CloseChangeRoleDialog()
    {
        _changeRoleDialogVisible = false;
        _selectedMember = null;
    }

    private async Task ChangeRole()
    {
        if (_selectedMember == null) return;

        _isChangingRole = true;
        try
        {
            var (success, error) = await OrganizationService.UpdateMemberRoleAsync(
                OrganizationId, _selectedMember.UserId, _newRole);

            if (success)
            {
                _selectedMember.Role = _newRole;
                Snackbar.Add("Role updated successfully", Severity.Success);
                CloseChangeRoleDialog();
            }
            else
            {
                Snackbar.Add(error ?? "Failed to update role", Severity.Error);
            }
        }
        finally
        {
            _isChangingRole = false;
        }
    }

    // ============================================================
    // Remove Member
    // ============================================================

    private void OpenRemoveDialog(OrganizationMemberDto member)
    {
        _selectedMember = member;
        _removeDialogVisible = true;
    }

    private void CloseRemoveDialog()
    {
        _removeDialogVisible = false;
        _selectedMember = null;
    }

    private async Task RemoveMember()
    {
        if (_selectedMember == null) return;

        _isRemoving = true;
        try
        {
            var (success, error) = await OrganizationService.RemoveMemberAsync(
                OrganizationId, _selectedMember.UserId);

            if (success)
            {
                _members.RemoveAll(m => m.UserId == _selectedMember.UserId);
                Snackbar.Add("Member removed successfully", Severity.Success);
                CloseRemoveDialog();
                LimitsService.InvalidateCache();
                await CheckMemberLimitAsync();
            }
            else
            {
                Snackbar.Add(error ?? "Failed to remove member", Severity.Error);
            }
        }
        finally
        {
            _isRemoving = false;
        }
    }

    // ============================================================
    // Helpers
    // ============================================================

    private IEnumerable<string> ValidateEmail(string email)
    {
        if (string.IsNullOrWhiteSpace(email))
            yield return "Email is required";
        else if (!email.Contains('@') || !email.Contains('.'))
            yield return "Invalid email format";
    }

    private static string GetMemberInitials(OrganizationMemberDto member)
    {
        var name = member.DisplayName ?? member.Username ?? member.Email;
        if (name.Contains('@'))
            name = name.Split('@')[0];

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();

        return name.Length >= 2 ? name[..2].ToUpper() : name.ToUpper();
    }

    private static string GetRoleDescription(string role) => role switch
    {
        OrganizationRole.Admin => "Can manage members, projects, and settings",
        OrganizationRole.Member => "Can view and edit projects",
        OrganizationRole.Viewer => "Read-only access to projects",
        _ => ""
    };
}
