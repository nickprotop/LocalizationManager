@page "/organizations/{OrganizationId:int}/members"
@attribute [Authorize]
@using LrmCloud.Shared.Constants
@using LrmCloud.Shared.DTOs.Organizations
@using LrmCloud.Web.Services
@using LrmCloud.Web.Components
@using LrmCloud.Web.Models
@using LrmCloud.Web.Helpers
@inject OrganizationService OrganizationService
@inject LimitsService LimitsService
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService

<PageTitle>Members - @(_organization?.Name ?? "Organization") - LRM Cloud</PageTitle>

@if (_isLoading)
{
    <RadzenStack Gap="1rem">
        <div style="background: var(--rz-base-light); width: 300px; height: 40px; border-radius: 4px;"></div>
        <LoadingSkeleton Type="LoadingSkeletonType.Table" Rows="5" />
    </RadzenStack>
}
else if (_organization == null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" Shade="Shade.Lighter" AllowClose="false">
        Organization not found or you don't have access to it.
        <RadzenLink Path="organizations" Text="Back to Organizations" class="rz-ms-2" />
    </RadzenAlert>
}
else
{
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-2">
        <RadzenButton Variant="Radzen.Variant.Text" Icon="arrow_back" Click="@(() => Navigation.NavigateTo($"organizations/{OrganizationId}"))" Size="ButtonSize.Small" />
        <RadzenBreadCrumb>
            <RadzenBreadCrumbItem Path="organizations" Text="Organizations" />
            <RadzenBreadCrumbItem Path="@($"organizations/{OrganizationId}")" Text="@_organization.Name" />
            <RadzenBreadCrumbItem Text="Members" />
        </RadzenBreadCrumb>
    </RadzenStack>

    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-4">
        <RadzenText TextStyle="TextStyle.H5">Team Members</RadzenText>
        @if (_canInvite)
        {
            <RadzenButton Variant="Radzen.Variant.Filled"
                          ButtonStyle="ButtonStyle.Primary"
                          Icon="person_add"
                          Text="Invite Member"
                          Click="@OpenInviteDialog"
                          Disabled="@(!_canInviteMember)"
                          title="@_memberLimitMessage" />
        }
    </RadzenStack>

    <RadzenCard>
        <RadzenDataGrid TItem="OrganizationMemberDto"
                        Data="@_members"
                        AllowSorting="true"
                        AllowFiltering="false"
                        Density="Density.Compact"
                        GridLines="DataGridGridLines.Horizontal">
            <Columns>
                <RadzenDataGridColumn TItem="OrganizationMemberDto" Title="Member" Width="auto">
                    <Template Context="member">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                            <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--rz-primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 500; font-size: 0.75rem;">
                                @GetMemberInitials(member)
                            </div>
                            <RadzenStack Gap="0">
                                <RadzenText TextStyle="TextStyle.Body2">
                                    @(member.DisplayName ?? member.Username ?? member.Email)
                                </RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">@member.Email</RadzenText>
                            </RadzenStack>
                        </RadzenStack>
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="OrganizationMemberDto" Property="Role" Title="Role" Width="120px">
                    <Template Context="member">
                        <RadzenBadge BadgeStyle="@UiHelpers.GetRoleBadgeStyle(member.Role)" Text="@member.Role" />
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="OrganizationMemberDto" Title="Joined" Width="140px">
                    <Template Context="member">
                        @if (member.JoinedAt.HasValue)
                        {
                            <RadzenText TextStyle="TextStyle.Body2">@member.JoinedAt.Value.ToString("MMM d, yyyy")</RadzenText>
                        }
                        else
                        {
                            <RadzenBadge BadgeStyle="BadgeStyle.Warning" Variant="Radzen.Variant.Outlined" Text="Pending" />
                        }
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="OrganizationMemberDto" Title="Actions" Width="100px" Sortable="false" Filterable="false">
                    <Template Context="member">
                        @if (_canManageMembers && !OrganizationRole.IsOwner(member.Role))
                        {
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.25rem">
                                @if (_isOwner)
                                {
                                    <RadzenButton Icon="edit" Size="ButtonSize.Small" Variant="Radzen.Variant.Text" Click="@(() => OpenChangeRoleDialog(member))" title="Change Role" />
                                }
                                <RadzenButton Icon="person_remove" Size="ButtonSize.Small" Variant="Radzen.Variant.Text" ButtonStyle="ButtonStyle.Danger" Click="@(() => OpenRemoveDialog(member))" title="Remove Member" />
                            </RadzenStack>
                        }
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
            <EmptyTemplate>
                <RadzenStack AlignItems="Radzen.AlignItems.Center" JustifyContent="JustifyContent.Center" class="rz-py-4">
                    <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
                        No members found. Invite team members to get started.
                    </RadzenText>
                </RadzenStack>
            </EmptyTemplate>
        </RadzenDataGrid>
    </RadzenCard>
}

@code {
    [Parameter]
    public int OrganizationId { get; set; }

    private OrganizationDto? _organization;
    private List<OrganizationMemberDto> _members = new();
    private bool _isLoading = true;
    private bool _canInvite;
    private bool _canManageMembers;
    private bool _isOwner;
    private bool _canInviteMember = true;
    private string? _memberLimitMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task CheckMemberLimitAsync()
    {
        var (canInvite, reason) = await LimitsService.CanInviteMemberAsync(_members.Count);
        _canInviteMember = canInvite;
        _memberLimitMessage = reason;
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            _organization = await OrganizationService.GetOrganizationAsync(OrganizationId);
            if (_organization != null)
            {
                _members = await OrganizationService.GetMembersAsync(OrganizationId);
                _isOwner = OrganizationRole.IsOwner(_organization.UserRole);
                _canManageMembers = OrganizationRole.IsAdminOrOwner(_organization.UserRole);
                _canInvite = _canManageMembers;
                await CheckMemberLimitAsync();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load organization: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    // ============================================================
    // Invite Member
    // ============================================================

    private async Task OpenInviteDialog()
    {
        var result = await DialogService.OpenAsync<InviteMemberDialog>("Invite Team Member",
            new Dictionary<string, object> { { "OrganizationId", OrganizationId } },
            new Radzen.DialogOptions { Width = "450px" });

        if (result == true)
        {
            LimitsService.InvalidateCache();
            await LoadDataAsync();
        }
    }

    // ============================================================
    // Change Role
    // ============================================================

    private async Task OpenChangeRoleDialog(OrganizationMemberDto member)
    {
        var result = await DialogService.OpenAsync<ChangeRoleDialog>("Change Role",
            new Dictionary<string, object>
            {
                { "OrganizationId", OrganizationId },
                { "Member", member }
            },
            new Radzen.DialogOptions { Width = "400px" });

        if (result is string newRole)
        {
            member.Role = newRole;
            StateHasChanged();
        }
    }

    // ============================================================
    // Remove Member
    // ============================================================

    private async Task OpenRemoveDialog(OrganizationMemberDto member)
    {
        var confirmed = await DialogService.Confirm(
            $"Are you sure you want to remove {member.DisplayName ?? member.Email} from this organization? They will lose access to all organization projects immediately.",
            "Remove Member",
            new ConfirmOptions { OkButtonText = "Remove", CancelButtonText = "Cancel" });

        if (confirmed == true)
        {
            await RemoveMember(member);
        }
    }

    private async Task RemoveMember(OrganizationMemberDto member)
    {
        var (success, error) = await OrganizationService.RemoveMemberAsync(OrganizationId, member.UserId);

        if (success)
        {
            _members.RemoveAll(m => m.UserId == member.UserId);
            NotificationService.Notify(NotificationSeverity.Success, "Success", "Member removed successfully");
            LimitsService.InvalidateCache();
            await CheckMemberLimitAsync();
        }
        else
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", error ?? "Failed to remove member");
        }
    }

    // ============================================================
    // Helpers
    // ============================================================

    private static string GetMemberInitials(OrganizationMemberDto member)
    {
        var name = member.DisplayName ?? member.Username ?? member.Email;
        if (name.Contains('@'))
            name = name.Split('@')[0];

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();

        return name.Length >= 2 ? name[..2].ToUpper() : name.ToUpper();
    }
}
