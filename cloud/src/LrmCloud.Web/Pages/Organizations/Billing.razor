@page "/organizations/{OrganizationId:int}/billing"
@attribute [Authorize]
@using LrmCloud.Shared.Constants
@using LrmCloud.Shared.DTOs.Organizations
@using LrmCloud.Web.Services
@using LrmCloud.Web.Components
@inject OrganizationService OrganizationService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Billing - @(_organization?.Name ?? "Organization") - LRM Cloud</PageTitle>

@if (_isLoading)
{
    <MudStack>
        <MudSkeleton Width="300px" Height="40px" />
        <MudGrid>
            @for (int i = 0; i < 3; i++)
            {
                <MudItem xs="12" sm="4">
                    <LoadingSkeleton Type="LoadingSkeletonType.Card" />
                </MudItem>
            }
        </MudGrid>
    </MudStack>
}
else if (_organization == null)
{
    <MudAlert Severity="Severity.Error">
        Organization not found or you don't have access to it.
        <MudButton Variant="Variant.Text" Color="Color.Primary" Href="organizations">Back to Organizations</MudButton>
    </MudAlert>
}
else if (!OrganizationRole.IsAdminOrOwner(_organization.UserRole))
{
    <MudAlert Severity="Severity.Warning">
        You don't have permission to access billing information.
        <MudButton Variant="Variant.Text" Color="Color.Primary" Href="@($"/organizations/{OrganizationId}")">Back to Organization</MudButton>
    </MudAlert>
}
else
{
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                       OnClick="@(() => Navigation.NavigateTo($"organizations/{OrganizationId}"))"
                       Size="Size.Small" />
        <MudBreadcrumbs Items="_breadcrumbs" />
    </MudStack>

    <MudText Typo="Typo.h5" Class="mb-4">Billing & Usage</MudText>

    <MudContainer MaxWidth="MaxWidth.Large" Class="px-0">
        <!-- Current Plan Card -->
        <MudCard Class="mb-6">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.CreditCard" />
                        <MudText Typo="Typo.h6">Current Plan</MudText>
                    </MudStack>
                </CardHeaderContent>
                <CardHeaderActions>
                    <MudChip T="string" Color="@GetPlanColor(_organization.Plan)" Size="Size.Medium">
                        @_organization.Plan.ToUpperInvariant()
                    </MudChip>
                </CardHeaderActions>
            </MudCardHeader>
            <MudCardContent>
                <MudGrid>
                    <MudItem xs="12" md="8">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle1">@GetPlanDescription(_organization.Plan)</MudText>
                            <MudStack Row="true" Spacing="4">
                                <div>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Members</MudText>
                                    <MudText Typo="Typo.body1">@_organization.MemberCount / @GetMemberLimit(_organization.Plan)</MudText>
                                </div>
                                <div>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Projects</MudText>
                                    <MudText Typo="Typo.body1">Unlimited</MudText>
                                </div>
                                <div>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Translation Characters</MudText>
                                    <MudText Typo="Typo.body1">@GetCharacterLimit(_organization.Plan)</MudText>
                                </div>
                            </MudStack>
                        </MudStack>
                    </MudItem>
                    <MudItem xs="12" md="4" Class="d-flex align-center justify-end">
                        @if (_organization.Plan.ToLower() != "enterprise")
                        {
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Upgrade"
                                       OnClick="@ShowUpgradeDialog">
                                Upgrade Plan
                            </MudButton>
                        }
                    </MudItem>
                </MudGrid>
            </MudCardContent>
        </MudCard>

        <!-- Usage Statistics -->
        <MudCard Class="mb-6">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Analytics" />
                        <MudText Typo="Typo.h6">This Month's Usage</MudText>
                    </MudStack>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudGrid>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid var(--mud-palette-lines-default);">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">TRANSLATION CHARACTERS</MudText>
                                <MudText Typo="Typo.h5">@FormatNumber(_usageStats.CharsUsed)</MudText>
                                <MudProgressLinear Value="@GetUsagePercentage(_usageStats.CharsUsed, _usageStats.CharsLimit)"
                                                   Color="@GetUsageColor(_usageStats.CharsUsed, _usageStats.CharsLimit)"
                                                   Class="mt-2" />
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    of @FormatNumber(_usageStats.CharsLimit) limit
                                </MudText>
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid var(--mud-palette-lines-default);">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">API CALLS</MudText>
                                <MudText Typo="Typo.h5">@FormatNumber(_usageStats.ApiCalls)</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                                    This billing period
                                </MudText>
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid var(--mud-palette-lines-default);">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">STORAGE</MudText>
                                <MudText Typo="Typo.h5">@FormatBytes(_usageStats.StorageBytes)</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                                    Resource files
                                </MudText>
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid var(--mud-palette-lines-default);">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">BILLING CYCLE</MudText>
                                <MudText Typo="Typo.h5">@_usageStats.DaysRemaining days</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                                    Until reset
                                </MudText>
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </MudCardContent>
        </MudCard>

        <!-- Plan Comparison -->
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Compare" />
                        <MudText Typo="Typo.h6">Compare Plans</MudText>
                    </MudStack>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudSimpleTable Dense="true" Hover="true" Class="rounded-lg">
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>
                                <MudStack AlignItems="AlignItems.Center">
                                    <MudText>Free</MudText>
                                    @if (_organization.Plan.ToLower() == "free")
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Primary">Current</MudChip>
                                    }
                                </MudStack>
                            </th>
                            <th>
                                <MudStack AlignItems="AlignItems.Center">
                                    <MudText>Team</MudText>
                                    @if (_organization.Plan.ToLower() == "team")
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Secondary">Current</MudChip>
                                    }
                                </MudStack>
                            </th>
                            <th>
                                <MudStack AlignItems="AlignItems.Center">
                                    <MudText>Enterprise</MudText>
                                    @if (_organization.Plan.ToLower() == "enterprise")
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Primary">Current</MudChip>
                                    }
                                </MudStack>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Team Members</td>
                            <td>Up to 3</td>
                            <td>Up to 20</td>
                            <td>Unlimited</td>
                        </tr>
                        <tr>
                            <td>Translation Characters/month</td>
                            <td>10,000</td>
                            <td>100,000</td>
                            <td>Unlimited</td>
                        </tr>
                        <tr>
                            <td>Projects</td>
                            <td>Unlimited</td>
                            <td>Unlimited</td>
                            <td>Unlimited</td>
                        </tr>
                        <tr>
                            <td>Translation Providers</td>
                            <td>2</td>
                            <td>All</td>
                            <td>All + Custom</td>
                        </tr>
                        <tr>
                            <td>API Access</td>
                            <td><MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" /></td>
                            <td><MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" /></td>
                            <td><MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" /></td>
                        </tr>
                        <tr>
                            <td>Priority Support</td>
                            <td><MudIcon Icon="@Icons.Material.Filled.Close" Color="Color.Default" Size="Size.Small" /></td>
                            <td><MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" /></td>
                            <td><MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" /></td>
                        </tr>
                        <tr>
                            <td>SSO/SAML</td>
                            <td><MudIcon Icon="@Icons.Material.Filled.Close" Color="Color.Default" Size="Size.Small" /></td>
                            <td><MudIcon Icon="@Icons.Material.Filled.Close" Color="Color.Default" Size="Size.Small" /></td>
                            <td><MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" /></td>
                        </tr>
                        <tr>
                            <td><strong>Price</strong></td>
                            <td><strong>Free</strong></td>
                            <td><strong>$29/month</strong></td>
                            <td><strong>Contact us</strong></td>
                        </tr>
                    </tbody>
                </MudSimpleTable>
            </MudCardContent>
        </MudCard>
    </MudContainer>
}

<!-- Upgrade Dialog -->
<MudDialog @bind-Visible="_upgradeDialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.Upgrade" Color="Color.Primary" />
            <MudText Typo="Typo.h6">Upgrade Plan</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudAlert Severity="Severity.Info" Class="mb-4">
            Billing integration coming soon! Contact us to upgrade your plan.
        </MudAlert>
        <MudText Typo="Typo.body1">
            For now, please contact our sales team to upgrade your organization's plan.
        </MudText>
        <MudStack Class="mt-4" Spacing="2">
            <MudTextField Value="@("sales@lrmcloud.com")" Label="Email" ReadOnly="true" Variant="Variant.Outlined" />
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@CloseUpgradeDialog">Close</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="mailto:sales@lrmcloud.com?subject=LRM Cloud Plan Upgrade">
            Contact Sales
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter]
    public int OrganizationId { get; set; }

    private OrganizationDto? _organization;
    private UsageStats _usageStats = new();
    private bool _isLoading = true;
    private bool _upgradeDialogVisible;
    private List<BreadcrumbItem> _breadcrumbs = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            _organization = await OrganizationService.GetOrganizationAsync(OrganizationId);
            if (_organization != null)
            {
                _breadcrumbs = new List<BreadcrumbItem>
                {
                    new("Organizations", "/organizations"),
                    new(_organization.Name, $"/organizations/{OrganizationId}"),
                    new("Billing", null, disabled: true)
                };

                // TODO: Load actual usage stats from API
                _usageStats = new UsageStats
                {
                    CharsUsed = 5432,
                    CharsLimit = GetCharacterLimitNumber(_organization.Plan),
                    ApiCalls = 127,
                    StorageBytes = 1024 * 1024 * 2, // 2 MB
                    DaysRemaining = 15
                };
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load billing info: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ShowUpgradeDialog()
    {
        _upgradeDialogVisible = true;
    }

    private void CloseUpgradeDialog()
    {
        _upgradeDialogVisible = false;
    }

    private static string GetPlanDescription(string plan) => plan.ToLower() switch
    {
        "free" => "Perfect for individuals and small teams getting started",
        "team" => "For growing teams with higher volume translation needs",
        "enterprise" => "Full-featured plan with unlimited resources and dedicated support",
        _ => "Standard plan"
    };

    private static string GetMemberLimit(string plan) => plan.ToLower() switch
    {
        "free" => "3",
        "team" => "20",
        "enterprise" => "Unlimited",
        _ => "3"
    };

    private static string GetCharacterLimit(string plan) => plan.ToLower() switch
    {
        "free" => "10,000/month",
        "team" => "100,000/month",
        "enterprise" => "Unlimited",
        _ => "10,000/month"
    };

    private static int GetCharacterLimitNumber(string plan) => plan.ToLower() switch
    {
        "free" => 10000,
        "team" => 100000,
        "enterprise" => int.MaxValue,
        _ => 10000
    };

    private static Color GetPlanColor(string plan) => plan.ToLower() switch
    {
        "free" => Color.Default,
        "team" => Color.Secondary,
        "enterprise" => Color.Primary,
        _ => Color.Default
    };

    private static double GetUsagePercentage(long used, long limit) =>
        limit > 0 ? Math.Min(100, (double)used / limit * 100) : 0;

    private static Color GetUsageColor(long used, long limit)
    {
        var percentage = GetUsagePercentage(used, limit);
        return percentage switch
        {
            >= 90 => Color.Error,
            >= 70 => Color.Warning,
            _ => Color.Success
        };
    }

    private static string FormatNumber(long number)
    {
        if (number >= 1_000_000)
            return $"{number / 1_000_000.0:F1}M";
        if (number >= 1_000)
            return $"{number / 1_000.0:F1}K";
        return number.ToString("N0");
    }

    private static string FormatBytes(long bytes)
    {
        if (bytes >= 1_073_741_824)
            return $"{bytes / 1_073_741_824.0:F1} GB";
        if (bytes >= 1_048_576)
            return $"{bytes / 1_048_576.0:F1} MB";
        if (bytes >= 1_024)
            return $"{bytes / 1_024.0:F1} KB";
        return $"{bytes} B";
    }

    private class UsageStats
    {
        public long CharsUsed { get; set; }
        public long CharsLimit { get; set; }
        public int ApiCalls { get; set; }
        public long StorageBytes { get; set; }
        public int DaysRemaining { get; set; }
    }
}
