@page "/organizations/{OrganizationId:int}/billing"
@attribute [Authorize]
@using LrmCloud.Shared.Constants
@using LrmCloud.Shared.DTOs.Organizations
@using LrmCloud.Shared.DTOs.Billing
@using LrmCloud.Shared.DTOs.Usage
@using LrmCloud.Web.Services
@using LrmCloud.Web.Components
@using LrmCloud.Web.Helpers
@inject OrganizationService OrganizationService
@inject BillingService BillingService
@inject UsageService UsageService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService

<PageTitle>Billing - @(_organization?.Name ?? "Organization") - LRM Cloud</PageTitle>

@if (_isLoading)
{
    <RadzenStack Gap="1rem">
        <div style="background: var(--rz-base-300); width: 300px; height: 40px; border-radius: 4px;"></div>
        <RadzenRow Gap="1rem">
            @for (int i = 0; i < 3; i++)
            {
                <RadzenColumn Size="12" SizeSM="4">
                    <LoadingSkeleton Type="LoadingSkeletonType.Card" />
                </RadzenColumn>
            }
        </RadzenRow>
    </RadzenStack>
}
else if (_organization == null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" Shade="Shade.Lighter" AllowClose="false">
        Organization not found or you don't have access to it.
        <RadzenLink Path="organizations" Text="Back to Organizations" class="rz-ms-2" />
    </RadzenAlert>
}
else if (!OrganizationRole.IsAdminOrOwner(_organization.UserRole))
{
    <RadzenAlert AlertStyle="AlertStyle.Warning" Shade="Shade.Lighter" AllowClose="false">
        You don't have permission to access billing information.
        <RadzenLink Path="@($"organizations/{OrganizationId}")" Text="Back to Organization" class="rz-ms-2" />
    </RadzenAlert>
}
else
{
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-2">
        <RadzenButton Variant="Radzen.Variant.Text" Icon="arrow_back" Click="@(() => Navigation.NavigateTo($"organizations/{OrganizationId}"))" Size="ButtonSize.Small" />
        <RadzenBreadCrumb>
            <RadzenBreadCrumbItem Path="organizations" Text="Organizations" />
            <RadzenBreadCrumbItem Path="@($"organizations/{OrganizationId}")" Text="@_organization.Name" />
            <RadzenBreadCrumbItem Text="Billing" />
        </RadzenBreadCrumb>
    </RadzenStack>

    <RadzenText TextStyle="TextStyle.H5" class="rz-mb-4">Billing & Usage</RadzenText>

    <!-- Shared Quota Info -->
    <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false" class="rz-mb-4">
        Organization usage counts against the owner's plan quota. All translation activity (LRM and BYOK) within organization projects is billed to the organization owner.
    </RadzenAlert>

    <!-- Current Plan Card -->
    <RadzenCard class="rz-mb-4">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" Wrap="FlexWrap.Wrap" class="rz-mb-4">
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                <RadzenIcon Icon="credit_card" />
                <RadzenText TextStyle="TextStyle.H6">Current Plan</RadzenText>
            </RadzenStack>
            <RadzenBadge BadgeStyle="@UiHelpers.GetPlanBadgeStyle(_organization.Plan)" Text="@_organization.Plan.ToUpperInvariant()" />
        </RadzenStack>

        <RadzenRow Gap="1rem" AlignItems="Radzen.AlignItems.Center">
            <RadzenColumn Size="12" SizeMD="8">
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Subtitle1">@GetPlanDescription(_organization.Plan)</RadzenText>
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="2rem" Wrap="FlexWrap.Wrap">
                        <RadzenStack Gap="0.25rem">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Members</RadzenText>
                            <RadzenText>@_organization.MemberCount / @FormatLimit(_usageStats?.MaxMembers ?? 0)</RadzenText>
                        </RadzenStack>
                        <RadzenStack Gap="0.25rem">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Projects</RadzenText>
                            <RadzenText>Unlimited</RadzenText>
                        </RadzenStack>
                        <RadzenStack Gap="0.25rem">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">LRM Translation</RadzenText>
                            <RadzenText>@UiHelpers.FormatNumber(_usageStats?.LrmCharsLimit ?? 0)/month</RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                </RadzenStack>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End">
                    @if (_organization.Plan.ToLower() != "enterprise")
                    {
                        <RadzenButton ButtonStyle="ButtonStyle.Primary"
                                      Icon="upgrade"
                                      Text="Upgrade Plan"
                                      Click="@(() => ShowUpgradeDialog(_organization.Plan.ToLower() == "team" ? "enterprise" : "team"))" />
                    }
                </RadzenStack>
            </RadzenColumn>
        </RadzenRow>
    </RadzenCard>

    <!-- Usage Statistics -->
    <RadzenCard class="rz-mb-4">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-4">
            <RadzenIcon Icon="analytics" />
            <RadzenText TextStyle="TextStyle.H6">This Month's Usage</RadzenText>
        </RadzenStack>

        <RadzenRow Gap="1rem">
            <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
                <RadzenCard Style="border: 1px solid var(--rz-base-400);">
                    <RadzenStack Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">LRM TRANSLATION</RadzenText>
                        <RadzenText TextStyle="TextStyle.H5">@UiHelpers.FormatNumber(_usageStats?.LrmCharsUsed ?? 0)</RadzenText>
                        <RadzenProgressBar Value="@UiHelpers.GetUsagePercentage(_usageStats?.LrmCharsUsed ?? 0, _usageStats?.LrmCharsLimit ?? 1)"
                                           ProgressBarStyle="@UiHelpers.GetUsageProgressStyle(UiHelpers.GetUsagePercentage(_usageStats?.LrmCharsUsed ?? 0, _usageStats?.LrmCharsLimit ?? 1))"
                                           ShowValue="false" Style="height: 6px;" />
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                            of @UiHelpers.FormatNumber(_usageStats?.LrmCharsLimit ?? 0) limit
                        </RadzenText>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
                <RadzenCard Style="border: 1px solid var(--rz-base-400);">
                    <RadzenStack Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">BYOK PROVIDERS</RadzenText>
                        <RadzenText TextStyle="TextStyle.H5">@UiHelpers.FormatNumber(_usageStats?.OtherCharsUsed ?? 0)</RadzenText>
                        <RadzenProgressBar Value="@UiHelpers.GetUsagePercentage(_usageStats?.OtherCharsUsed ?? 0, _usageStats?.OtherCharsLimit ?? 1)"
                                           ProgressBarStyle="@UiHelpers.GetUsageProgressStyle(UiHelpers.GetUsagePercentage(_usageStats?.OtherCharsUsed ?? 0, _usageStats?.OtherCharsLimit ?? 1))"
                                           ShowValue="false" Style="height: 6px;" />
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                            of @UiHelpers.FormatNumber(_usageStats?.OtherCharsLimit ?? 0) limit
                        </RadzenText>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeSM="6" SizeMD="2">
                <RadzenCard Style="border: 1px solid var(--rz-base-400);">
                    <RadzenStack Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">PROJECTS</RadzenText>
                        <RadzenText TextStyle="TextStyle.H5">@(_usageStats?.ProjectCount ?? 0)</RadzenText>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">In this organization</RadzenText>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeSM="6" SizeMD="2">
                <RadzenCard Style="border: 1px solid var(--rz-base-400);">
                    <RadzenStack Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">TEAM MEMBERS</RadzenText>
                        <RadzenText TextStyle="TextStyle.H5">@(_usageStats?.MemberCount ?? 0) / @(_usageStats?.MaxMembers == int.MaxValue ? "âˆž" : _usageStats?.MaxMembers.ToString() ?? "0")</RadzenText>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Active members</RadzenText>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeSM="6" SizeMD="2">
                <RadzenCard Style="border: 1px solid var(--rz-base-400);">
                    <RadzenStack Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">BILLING CYCLE</RadzenText>
                        <RadzenText TextStyle="TextStyle.H5">@(_usageStats?.DaysRemaining ?? 0) days</RadzenText>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Until reset</RadzenText>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>
    </RadzenCard>

    <!-- Member Usage Breakdown -->
    @if (_memberUsage != null && _memberUsage.Any())
    {
        <RadzenCard class="rz-mb-4">
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-4">
                <RadzenIcon Icon="people" />
                <RadzenText TextStyle="TextStyle.H6">Usage by Member</RadzenText>
            </RadzenStack>

            <RadzenDataGrid TItem="OrgMemberUsageDto" Data="@_memberUsage" Density="Density.Compact" AllowSorting="true">
                <Columns>
                    <RadzenDataGridColumn TItem="OrgMemberUsageDto" Title="Member" Width="auto">
                        <Template Context="member">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                                <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--rz-primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 500; font-size: 0.75rem;">
                                    @UiHelpers.GetInitials(member.UserName)
                                </div>
                                <RadzenStack Gap="0">
                                    <RadzenText TextStyle="TextStyle.Body2">@member.UserName</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">@member.Email</RadzenText>
                                </RadzenStack>
                            </RadzenStack>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="OrgMemberUsageDto" Property="LrmCharsUsed" Title="LRM Chars" Width="120px" TextAlign="TextAlign.End">
                        <Template Context="member">@UiHelpers.FormatNumber(member.LrmCharsUsed)</Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="OrgMemberUsageDto" Property="ByokCharsUsed" Title="BYOK Chars" Width="120px" TextAlign="TextAlign.End">
                        <Template Context="member">@UiHelpers.FormatNumber(member.ByokCharsUsed)</Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="OrgMemberUsageDto" Property="TotalCharsUsed" Title="Total" Width="120px" TextAlign="TextAlign.End">
                        <Template Context="member"><strong>@UiHelpers.FormatNumber(member.TotalCharsUsed)</strong></Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        </RadzenCard>
    }

    <!-- Plan Comparison -->
    <RadzenCard>
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-4">
            <RadzenIcon Icon="compare" />
            <RadzenText TextStyle="TextStyle.H6">Compare Plans</RadzenText>
        </RadzenStack>

        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--rz-base-400);">
                        <th style="text-align: left; padding: 0.75rem;">Feature</th>
                        <th style="text-align: center; padding: 0.75rem;">
                            <RadzenStack AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                                <span>Free</span>
                                @if (_organization.Plan.ToLower() == "free")
                                {
                                    <RadzenBadge BadgeStyle="BadgeStyle.Primary" Text="Current" />
                                }
                            </RadzenStack>
                        </th>
                        <th style="text-align: center; padding: 0.75rem;">
                            <RadzenStack AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                                <span>Team</span>
                                @if (_organization.Plan.ToLower() == "team")
                                {
                                    <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text="Current" />
                                }
                            </RadzenStack>
                        </th>
                        <th style="text-align: center; padding: 0.75rem;">
                            <RadzenStack AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                                <span>Enterprise</span>
                                @if (_organization.Plan.ToLower() == "enterprise")
                                {
                                    <RadzenBadge BadgeStyle="BadgeStyle.Primary" Text="Current" />
                                }
                            </RadzenStack>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="border-bottom: 1px solid var(--rz-base-300);">
                        <td style="padding: 0.75rem;">Team Members</td>
                        <td style="text-align: center; padding: 0.75rem;"><RadzenIcon Icon="close" Style="color: var(--rz-text-secondary-color);" /></td>
                        <td style="text-align: center; padding: 0.75rem;">@FormatLimit(_subscription?.PlanLimits?.Team.MaxTeamMembers ?? 10)</td>
                        <td style="text-align: center; padding: 0.75rem;">@FormatLimit(_subscription?.PlanLimits?.Enterprise.MaxTeamMembers ?? int.MaxValue)</td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--rz-base-300);">
                        <td style="padding: 0.75rem;">LRM Translation/month</td>
                        <td style="text-align: center; padding: 0.75rem;">@UiHelpers.FormatNumber(_subscription?.PlanLimits?.Free.TranslationChars ?? 5000)</td>
                        <td style="text-align: center; padding: 0.75rem;">@UiHelpers.FormatNumber(_subscription?.PlanLimits?.Team.TranslationChars ?? 50000)</td>
                        <td style="text-align: center; padding: 0.75rem;">@UiHelpers.FormatNumber(_subscription?.PlanLimits?.Enterprise.TranslationChars ?? 500000)</td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--rz-base-300);">
                        <td style="padding: 0.75rem;">Other Providers/month</td>
                        <td style="text-align: center; padding: 0.75rem;">@UiHelpers.FormatNumber(_subscription?.PlanLimits?.Free.OtherChars ?? 25000)</td>
                        <td style="text-align: center; padding: 0.75rem;">@UiHelpers.FormatNumber(_subscription?.PlanLimits?.Team.OtherChars ?? 250000)</td>
                        <td style="text-align: center; padding: 0.75rem;">@UiHelpers.FormatNumber(_subscription?.PlanLimits?.Enterprise.OtherChars ?? 2500000)</td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--rz-base-300);">
                        <td style="padding: 0.75rem;">Projects</td>
                        <td style="text-align: center; padding: 0.75rem;">@FormatLimit(_subscription?.PlanLimits?.Free.MaxProjects ?? 3)</td>
                        <td style="text-align: center; padding: 0.75rem;">@FormatLimit(_subscription?.PlanLimits?.Team.MaxProjects ?? int.MaxValue)</td>
                        <td style="text-align: center; padding: 0.75rem;">@FormatLimit(_subscription?.PlanLimits?.Enterprise.MaxProjects ?? int.MaxValue)</td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--rz-base-300);">
                        <td style="padding: 0.75rem;">API Keys (BYOK)</td>
                        <td style="text-align: center; padding: 0.75rem;">@FormatLimit(_subscription?.PlanLimits?.Free.MaxApiKeys ?? 3)</td>
                        <td style="text-align: center; padding: 0.75rem;">@FormatLimit(_subscription?.PlanLimits?.Team.MaxApiKeys ?? 10)</td>
                        <td style="text-align: center; padding: 0.75rem;">@FormatLimit(_subscription?.PlanLimits?.Enterprise.MaxApiKeys ?? int.MaxValue)</td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--rz-base-300);">
                        <td style="padding: 0.75rem;">API Access</td>
                        <td style="text-align: center; padding: 0.75rem;"><RadzenIcon Icon="check" Style="color: var(--rz-success);" /></td>
                        <td style="text-align: center; padding: 0.75rem;"><RadzenIcon Icon="check" Style="color: var(--rz-success);" /></td>
                        <td style="text-align: center; padding: 0.75rem;"><RadzenIcon Icon="check" Style="color: var(--rz-success);" /></td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--rz-base-300);">
                        <td style="padding: 0.75rem;">Priority Support</td>
                        <td style="text-align: center; padding: 0.75rem;"><RadzenIcon Icon="close" Style="color: var(--rz-text-secondary-color);" /></td>
                        <td style="text-align: center; padding: 0.75rem;"><RadzenIcon Icon="check" Style="color: var(--rz-success);" /></td>
                        <td style="text-align: center; padding: 0.75rem;"><RadzenIcon Icon="check" Style="color: var(--rz-success);" /></td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--rz-base-300);">
                        <td style="padding: 0.75rem;">SSO/SAML</td>
                        <td style="text-align: center; padding: 0.75rem;"><RadzenIcon Icon="close" Style="color: var(--rz-text-secondary-color);" /></td>
                        <td style="text-align: center; padding: 0.75rem;"><RadzenIcon Icon="close" Style="color: var(--rz-text-secondary-color);" /></td>
                        <td style="text-align: center; padding: 0.75rem;"><RadzenIcon Icon="check" Style="color: var(--rz-success);" /></td>
                    </tr>
                    <tr>
                        <td style="padding: 0.75rem;"><strong>Price</strong></td>
                        <td style="text-align: center; padding: 0.75rem;"><strong>Free</strong></td>
                        <td style="text-align: center; padding: 0.75rem;"><strong>$@(_subscription?.PlanLimits?.Team.Price ?? 9)/month</strong></td>
                        <td style="text-align: center; padding: 0.75rem;"><strong>$@(_subscription?.PlanLimits?.Enterprise.Price ?? 29)/month</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </RadzenCard>
}

@code {
    [Parameter]
    public int OrganizationId { get; set; }

    private OrganizationDto? _organization;
    private SubscriptionDto? _subscription;
    private OrganizationUsageDto? _usageStats;
    private List<OrgMemberUsageDto>? _memberUsage;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            var orgTask = OrganizationService.GetOrganizationAsync(OrganizationId);
            var subscriptionTask = BillingService.GetSubscriptionAsync();
            var usageTask = UsageService.GetOrganizationStatsAsync(OrganizationId);
            var memberUsageTask = UsageService.GetOrgMemberUsageAsync(OrganizationId);

            await Task.WhenAll(orgTask, subscriptionTask, usageTask, memberUsageTask);

            _organization = await orgTask;
            _subscription = await subscriptionTask;
            _usageStats = await usageTask;
            _memberUsage = await memberUsageTask;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load billing info: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ShowUpgradeDialog(string plan = "team")
    {
        var result = await DialogService.OpenAsync<UpgradePlanDialog>("Upgrade Plan",
            new Dictionary<string, object>
            {
                { "OrganizationId", OrganizationId },
                { "SelectedPlan", plan },
                { "Subscription", _subscription }
            },
            new Radzen.DialogOptions { Width = "500px" });

        if (result == true)
        {
            await LoadDataAsync();
        }
    }

    private static string GetPlanDescription(string plan) => plan.ToLower() switch
    {
        "free" => "Perfect for individuals and small teams getting started",
        "team" => "For growing teams with higher volume translation needs",
        "enterprise" => "Full-featured plan with unlimited resources and dedicated support",
        _ => "Standard plan"
    };

    private static string FormatLimit(int limit) => limit >= int.MaxValue - 1
        ? "Unlimited"
        : limit <= 0
            ? "N/A"
            : $"Up to {limit:N0}";
}
