@page "/organizations/{OrganizationId:int}/billing"
@attribute [Authorize]
@using LrmCloud.Shared.Constants
@using LrmCloud.Shared.DTOs.Organizations
@using LrmCloud.Shared.DTOs.Billing
@using LrmCloud.Shared.DTOs.Usage
@using LrmCloud.Web.Services
@using LrmCloud.Web.Components
@using LrmCloud.Web.Helpers
@inject OrganizationService OrganizationService
@inject BillingService BillingService
@inject UsageService UsageService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ISnackbar Snackbar

<PageTitle>Billing - @(_organization?.Name ?? "Organization") - LRM Cloud</PageTitle>

@if (_isLoading)
{
    <MudStack>
        <MudSkeleton Width="300px" Height="40px" />
        <MudGrid>
            @for (int i = 0; i < 3; i++)
            {
                <MudItem xs="12" sm="4">
                    <LoadingSkeleton Type="LoadingSkeletonType.Card" />
                </MudItem>
            }
        </MudGrid>
    </MudStack>
}
else if (_organization == null)
{
    <MudAlert Severity="Severity.Error">
        Organization not found or you don't have access to it.
        <MudButton Variant="Variant.Text" Color="Color.Primary" Href="organizations">Back to Organizations</MudButton>
    </MudAlert>
}
else if (!OrganizationRole.IsAdminOrOwner(_organization.UserRole))
{
    <MudAlert Severity="Severity.Warning">
        You don't have permission to access billing information.
        <MudButton Variant="Variant.Text" Color="Color.Primary" Href="@($"organizations/{OrganizationId}")">Back to Organization</MudButton>
    </MudAlert>
}
else
{
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                       OnClick="@(() => Navigation.NavigateTo($"organizations/{OrganizationId}"))"
                       Size="Size.Small" />
        <MudBreadcrumbs Items="_breadcrumbs" />
    </MudStack>

    <MudText Typo="Typo.h5" Class="mb-4">Billing & Usage</MudText>

        <!-- Shared Quota Info -->
        <MudAlert Severity="Severity.Info" Class="mb-4">
            <MudText Typo="Typo.body2">
                Organization usage counts against the owner's plan quota. All translation activity (LRM and BYOK) within organization projects is billed to the organization owner.
            </MudText>
        </MudAlert>

        <!-- Current Plan Card -->
        <MudCard Class="mb-6">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.CreditCard" />
                        <MudText Typo="Typo.h6">Current Plan</MudText>
                    </MudStack>
                </CardHeaderContent>
                <CardHeaderActions>
                    <MudChip T="string" Color="@UiHelpers.GetPlanColor(_organization.Plan)" Size="Size.Medium">
                        @_organization.Plan.ToUpperInvariant()
                    </MudChip>
                </CardHeaderActions>
            </MudCardHeader>
            <MudCardContent>
                <MudGrid>
                    <MudItem xs="12" md="8">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle1">@GetPlanDescription(_organization.Plan)</MudText>
                            <MudStack Row="true" Spacing="4">
                                <div>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Members</MudText>
                                    <MudText Typo="Typo.body1">@_organization.MemberCount / @FormatLimit(_usageStats?.MaxMembers ?? 0)</MudText>
                                </div>
                                <div>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Projects</MudText>
                                    <MudText Typo="Typo.body1">Unlimited</MudText>
                                </div>
                                <div>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">LRM Translation</MudText>
                                    <MudText Typo="Typo.body1">@UiHelpers.FormatNumber(_usageStats?.LrmCharsLimit ?? 0)/month</MudText>
                                </div>
                            </MudStack>
                        </MudStack>
                    </MudItem>
                    <MudItem xs="12" md="4" Class="d-flex align-center justify-end">
                        @if (_organization.Plan.ToLower() != "enterprise")
                        {
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Upgrade"
                                       OnClick="@(() => ShowUpgradeDialog(_organization.Plan.ToLower() == "team" ? "enterprise" : "team"))">
                                Upgrade Plan
                            </MudButton>
                        }
                    </MudItem>
                </MudGrid>
            </MudCardContent>
        </MudCard>

        <!-- Usage Statistics -->
        <MudCard Class="mb-6">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Analytics" />
                        <MudText Typo="Typo.h6">This Month's Usage</MudText>
                    </MudStack>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudGrid>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid var(--mud-palette-lines-default);">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">LRM TRANSLATION</MudText>
                                <MudText Typo="Typo.h5">@UiHelpers.FormatNumber(_usageStats?.LrmCharsUsed ?? 0)</MudText>
                                <MudProgressLinear Value="@UiHelpers.GetUsagePercentage(_usageStats?.LrmCharsUsed ?? 0, _usageStats?.LrmCharsLimit ?? 1)"
                                                   Color="@UiHelpers.GetUsageColor(_usageStats?.LrmCharsUsed ?? 0, _usageStats?.LrmCharsLimit ?? 1)"
                                                   Class="mt-2" />
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    of @UiHelpers.FormatNumber(_usageStats?.LrmCharsLimit ?? 0) limit
                                </MudText>
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid var(--mud-palette-lines-default);">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">BYOK PROVIDERS</MudText>
                                <MudText Typo="Typo.h5">@UiHelpers.FormatNumber(_usageStats?.OtherCharsUsed ?? 0)</MudText>
                                <MudProgressLinear Value="@UiHelpers.GetUsagePercentage(_usageStats?.OtherCharsUsed ?? 0, _usageStats?.OtherCharsLimit ?? 1)"
                                                   Color="@UiHelpers.GetUsageColor(_usageStats?.OtherCharsUsed ?? 0, _usageStats?.OtherCharsLimit ?? 1)"
                                                   Class="mt-2" />
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    of @UiHelpers.FormatNumber(_usageStats?.OtherCharsLimit ?? 0) limit
                                </MudText>
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid var(--mud-palette-lines-default);">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">PROJECTS</MudText>
                                <MudText Typo="Typo.h5">@(_usageStats?.ProjectCount ?? 0)</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                                    In this organization
                                </MudText>
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid var(--mud-palette-lines-default);">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">TEAM MEMBERS</MudText>
                                <MudText Typo="Typo.h5">@(_usageStats?.MemberCount ?? 0) / @(_usageStats?.MaxMembers == int.MaxValue ? "âˆž" : _usageStats?.MaxMembers.ToString() ?? "0")</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                                    Active members
                                </MudText>
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid var(--mud-palette-lines-default);">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">BILLING CYCLE</MudText>
                                <MudText Typo="Typo.h5">@(_usageStats?.DaysRemaining ?? 0) days</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                                    Until reset
                                </MudText>
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </MudCardContent>
        </MudCard>

        <!-- Member Usage Breakdown (for admins/owners) -->
        @if (_memberUsage != null && _memberUsage.Any())
        {
            <MudCard Class="mb-6">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.People" />
                            <MudText Typo="Typo.h6">Usage by Member</MudText>
                        </MudStack>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudSimpleTable Dense="true" Hover="true" Elevation="0">
                        <thead>
                            <tr>
                                <th>Member</th>
                                <th style="text-align: right">LRM Chars</th>
                                <th style="text-align: right">BYOK Chars</th>
                                <th style="text-align: right">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var member in _memberUsage)
                            {
                                <tr>
                                    <td>
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                            <MudAvatar Size="Size.Small" Color="@UiHelpers.GetHashColor(member.UserName)">
                                                @UiHelpers.GetInitials(member.UserName)
                                            </MudAvatar>
                                            <MudStack Spacing="0">
                                                <MudText Typo="Typo.body2">@member.UserName</MudText>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">@member.Email</MudText>
                                            </MudStack>
                                        </MudStack>
                                    </td>
                                    <td style="text-align: right">@UiHelpers.FormatNumber(member.LrmCharsUsed)</td>
                                    <td style="text-align: right">@UiHelpers.FormatNumber(member.ByokCharsUsed)</td>
                                    <td style="text-align: right"><strong>@UiHelpers.FormatNumber(member.TotalCharsUsed)</strong></td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                </MudCardContent>
            </MudCard>
        }

        <!-- Plan Comparison -->
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Compare" />
                        <MudText Typo="Typo.h6">Compare Plans</MudText>
                    </MudStack>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudSimpleTable Dense="true" Hover="true" Class="rounded-lg">
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>
                                <MudStack AlignItems="AlignItems.Center">
                                    <MudText>Free</MudText>
                                    @if (_organization.Plan.ToLower() == "free")
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Primary">Current</MudChip>
                                    }
                                </MudStack>
                            </th>
                            <th>
                                <MudStack AlignItems="AlignItems.Center">
                                    <MudText>Team</MudText>
                                    @if (_organization.Plan.ToLower() == "team")
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Secondary">Current</MudChip>
                                    }
                                </MudStack>
                            </th>
                            <th>
                                <MudStack AlignItems="AlignItems.Center">
                                    <MudText>Enterprise</MudText>
                                    @if (_organization.Plan.ToLower() == "enterprise")
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Primary">Current</MudChip>
                                    }
                                </MudStack>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Team Members</td>
                            <td><MudIcon Icon="@Icons.Material.Filled.Close" Color="Color.Default" Size="Size.Small" Title="Organizations require Team plan" /></td>
                            <td>@FormatLimit(_subscription?.PlanLimits?.Team.MaxTeamMembers ?? 10)</td>
                            <td>@FormatLimit(_subscription?.PlanLimits?.Enterprise.MaxTeamMembers ?? int.MaxValue)</td>
                        </tr>
                        <tr>
                            <td>LRM Translation/month</td>
                            <td>@UiHelpers.FormatNumber(_subscription?.PlanLimits?.Free.TranslationChars ?? 5000)</td>
                            <td>@UiHelpers.FormatNumber(_subscription?.PlanLimits?.Team.TranslationChars ?? 50000)</td>
                            <td>@UiHelpers.FormatNumber(_subscription?.PlanLimits?.Enterprise.TranslationChars ?? 500000)</td>
                        </tr>
                        <tr>
                            <td>Other Providers/month</td>
                            <td>@UiHelpers.FormatNumber(_subscription?.PlanLimits?.Free.OtherChars ?? 25000)</td>
                            <td>@UiHelpers.FormatNumber(_subscription?.PlanLimits?.Team.OtherChars ?? 250000)</td>
                            <td>@UiHelpers.FormatNumber(_subscription?.PlanLimits?.Enterprise.OtherChars ?? 2500000)</td>
                        </tr>
                        <tr>
                            <td>Projects</td>
                            <td>@FormatLimit(_subscription?.PlanLimits?.Free.MaxProjects ?? 3)</td>
                            <td>@FormatLimit(_subscription?.PlanLimits?.Team.MaxProjects ?? int.MaxValue)</td>
                            <td>@FormatLimit(_subscription?.PlanLimits?.Enterprise.MaxProjects ?? int.MaxValue)</td>
                        </tr>
                        <tr>
                            <td>API Keys (BYOK)</td>
                            <td>@FormatLimit(_subscription?.PlanLimits?.Free.MaxApiKeys ?? 3)</td>
                            <td>@FormatLimit(_subscription?.PlanLimits?.Team.MaxApiKeys ?? 10)</td>
                            <td>@FormatLimit(_subscription?.PlanLimits?.Enterprise.MaxApiKeys ?? int.MaxValue)</td>
                        </tr>
                        <tr>
                            <td>API Access</td>
                            <td><MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" /></td>
                            <td><MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" /></td>
                            <td><MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" /></td>
                        </tr>
                        <tr>
                            <td>Priority Support</td>
                            <td><MudIcon Icon="@Icons.Material.Filled.Close" Color="Color.Default" Size="Size.Small" /></td>
                            <td><MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" /></td>
                            <td><MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" /></td>
                        </tr>
                        <tr>
                            <td>SSO/SAML</td>
                            <td><MudIcon Icon="@Icons.Material.Filled.Close" Color="Color.Default" Size="Size.Small" /></td>
                            <td><MudIcon Icon="@Icons.Material.Filled.Close" Color="Color.Default" Size="Size.Small" /></td>
                            <td><MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" Size="Size.Small" /></td>
                        </tr>
                        <tr>
                            <td><strong>Price</strong></td>
                            <td><strong>Free</strong></td>
                            <td><strong>$@(_subscription?.PlanLimits?.Team.Price ?? 9)/month</strong></td>
                            <td><strong>$@(_subscription?.PlanLimits?.Enterprise.Price ?? 29)/month</strong></td>
                        </tr>
                    </tbody>
                </MudSimpleTable>
            </MudCardContent>
        </MudCard>
}

<!-- Upgrade Dialog -->
<MudDialog @bind-Visible="_upgradeDialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.Upgrade" Color="Color.Primary" />
            <MudText Typo="Typo.h6">Upgrade to @(_selectedPlan?.ToUpperInvariant())</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        @if (_subscription?.BillingEnabled == true)
        {
            <MudText Typo="Typo.body1" Class="mb-3">
                You'll be redirected to our secure payment page powered by Stripe.
            </MudText>
            <MudAlert Severity="Severity.Info" Class="mb-3">
                @if (_selectedPlan == "team")
                {
                    <MudText>Team plan: $@(_subscription?.PlanLimits?.Team.Price ?? 9)/month with @UiHelpers.FormatNumber(_subscription?.PlanLimits?.Team.TranslationChars ?? 50000) LRM translation characters and @FormatLimit(_subscription?.PlanLimits?.Team.MaxTeamMembers ?? 10) team members.</MudText>
                }
                else if (_selectedPlan == "enterprise")
                {
                    <MudText>Enterprise plan: $@(_subscription?.PlanLimits?.Enterprise.Price ?? 29)/month with @UiHelpers.FormatNumber(_subscription?.PlanLimits?.Enterprise.TranslationChars ?? 500000) LRM translation characters and @FormatLimit(_subscription?.PlanLimits?.Enterprise.MaxTeamMembers ?? int.MaxValue).ToLower() team members.</MudText>
                }
            </MudAlert>
        }
        else
        {
            <MudAlert Severity="Severity.Info" Class="mb-4">
                Billing integration coming soon! Contact us to upgrade your plan.
            </MudAlert>
            <MudText Typo="Typo.body1">
                For now, please contact our sales team to upgrade your organization's plan.
            </MudText>
            <MudStack Class="mt-4" Spacing="2">
                <MudTextField Value="@("sales@lrmcloud.com")" Label="Email" ReadOnly="true" Variant="Variant.Outlined" />
            </MudStack>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@CloseUpgradeDialog">Cancel</MudButton>
        @if (_subscription?.BillingEnabled == true)
        {
            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                       OnClick="@StartCheckout" Disabled="@_isProcessing">
                @if (_isProcessing)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                }
                Proceed to Payment
            </MudButton>
        }
        else
        {
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="mailto:sales@lrmcloud.com?subject=LRM Cloud Plan Upgrade">
                Contact Sales
            </MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [Parameter]
    public int OrganizationId { get; set; }

    private OrganizationDto? _organization;
    private SubscriptionDto? _subscription;
    private OrganizationUsageDto? _usageStats;
    private List<OrgMemberUsageDto>? _memberUsage;
    private bool _isLoading = true;
    private bool _isProcessing;
    private bool _upgradeDialogVisible;
    private string? _selectedPlan;
    private List<BreadcrumbItem> _breadcrumbs = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            var orgTask = OrganizationService.GetOrganizationAsync(OrganizationId);
            var subscriptionTask = BillingService.GetSubscriptionAsync();
            var usageTask = UsageService.GetOrganizationStatsAsync(OrganizationId);
            var memberUsageTask = UsageService.GetOrgMemberUsageAsync(OrganizationId);

            await Task.WhenAll(orgTask, subscriptionTask, usageTask, memberUsageTask);

            _organization = await orgTask;
            _subscription = await subscriptionTask;
            _usageStats = await usageTask;
            _memberUsage = await memberUsageTask;

            if (_organization != null)
            {
                _breadcrumbs = new List<BreadcrumbItem>
                {
                    new("Organizations", "organizations"),
                    new(_organization.Name, $"organizations/{OrganizationId}"),
                    new("Billing", null, disabled: true)
                };
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load billing info: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ShowUpgradeDialog(string plan = "team")
    {
        _selectedPlan = plan;
        _upgradeDialogVisible = true;
    }

    private void CloseUpgradeDialog()
    {
        _upgradeDialogVisible = false;
        _selectedPlan = null;
    }

    private async Task StartCheckout()
    {
        if (string.IsNullOrEmpty(_selectedPlan)) return;

        _isProcessing = true;
        try
        {
            var baseUrl = Navigation.BaseUri.TrimEnd('/');
            var result = await BillingService.CreateCheckoutAsync(
                _selectedPlan,
                $"{baseUrl}/organizations/{OrganizationId}/billing?success=true",
                $"{baseUrl}/organizations/{OrganizationId}/billing?canceled=true"
            );

            if (result?.SessionUrl != null)
            {
                await JS.InvokeVoidAsync("open", result.SessionUrl, "_self");
            }
            else
            {
                Snackbar.Add("Failed to create checkout session", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isProcessing = false;
            CloseUpgradeDialog();
        }
    }

    private static string GetPlanDescription(string plan) => plan.ToLower() switch
    {
        "free" => "Perfect for individuals and small teams getting started",
        "team" => "For growing teams with higher volume translation needs",
        "enterprise" => "Full-featured plan with unlimited resources and dedicated support",
        _ => "Standard plan"
    };

    /// <summary>
    /// Formats a limit value, showing "Unlimited" for int.MaxValue or "Up to X" for finite values.
    /// </summary>
    private static string FormatLimit(int limit) => limit >= int.MaxValue - 1
        ? "Unlimited"
        : limit <= 0
            ? "N/A"
            : $"Up to {limit:N0}";
}
