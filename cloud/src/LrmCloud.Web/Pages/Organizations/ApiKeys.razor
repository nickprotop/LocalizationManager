@page "/organizations/{OrganizationId:int}/api-keys"
@using LrmCloud.Shared.DTOs.Organizations
@using LrmCloud.Shared.DTOs.Translation
@using LrmCloud.Web.Services
@using LrmCloud.Web.Components
@inject OrganizationService OrganizationService
@inject TranslationService TranslationService
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService
@attribute [Authorize]

<PageTitle>Translation API Keys - LRM Cloud</PageTitle>

@if (_loading)
{
    <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Style="height: 4px;" />
}
else if (_organization == null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" Shade="Shade.Lighter" AllowClose="false">Organization not found.</RadzenAlert>
}
else
{
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-2">
        <RadzenButton Variant="Radzen.Variant.Text" Icon="arrow_back" Click="@(() => Navigation.NavigateTo($"organizations/{OrganizationId}"))" Size="ButtonSize.Small" />
        <RadzenBreadCrumb>
            <RadzenBreadCrumbItem Path="organizations" Text="Organizations" />
            <RadzenBreadCrumbItem Path="@($"organizations/{OrganizationId}")" Text="@_organization.Name" />
            <RadzenBreadCrumbItem Text="API Keys" />
        </RadzenBreadCrumb>
    </RadzenStack>

    <RadzenStack class="rz-mb-4">
        <RadzenText TextStyle="TextStyle.H4">Translation API Keys</RadzenText>
        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
            Configure translation provider API keys for @_organization.Name
        </RadzenText>
    </RadzenStack>

    @if (!_canManageKeys)
    {
        <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false" class="rz-mb-4">
            You need Admin or Owner permissions to manage API keys.
        </RadzenAlert>
    }

    <RadzenCard class="rz-mb-4">
        <RadzenText TextStyle="TextStyle.H6" class="rz-mb-2">Key Hierarchy</RadzenText>
        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary rz-mb-4">
            For organization projects, API keys are resolved in order: Project â†’ Organization.
            User's personal API keys are not used for organization projects to ensure consistent billing.
        </RadzenText>
        <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false">
            Keys configured here will be used by all projects in this organization unless overridden at the project level.
        </RadzenAlert>
    </RadzenCard>

    <RadzenCard class="rz-mb-4">
        <RadzenText TextStyle="TextStyle.H6" class="rz-mb-4">Available Providers</RadzenText>

        @if (_loadingProviders)
        {
            <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Style="height: 4px;" />
        }
        else
        {
            <RadzenRow Gap="1rem">
                @foreach (var provider in _providers)
                {
                    <RadzenColumn Size="12" SizeMD="6" SizeLG="4">
                        <RadzenCard Style="height: 100%; border: 1px solid var(--rz-base);">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-3">
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                                    <RadzenIcon Icon="@GetProviderIcon(provider.Name)" />
                                    <RadzenText TextStyle="TextStyle.Subtitle1">@provider.DisplayName</RadzenText>
                                </RadzenStack>
                                @if (provider.IsConfigured && provider.ApiKeySource == "organization")
                                {
                                    <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Configured" />
                                }
                                else if (provider.IsConfigured)
                                {
                                    <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@(provider.ApiKeySource ?? "Inherited")" />
                                }
                            </RadzenStack>

                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary rz-mb-2">
                                @(provider.Description ?? GetProviderDescription(provider.Name))
                            </RadzenText>

                            @if (provider.IsAiProvider)
                            {
                                <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Variant="Radzen.Variant.Outlined" Text="AI Provider" class="rz-mb-3" />
                            }

                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" class="rz-mt-3">
                                @if (_canManageKeys)
                                {
                                    @if (provider.IsConfigured && provider.ApiKeySource == "organization")
                                    {
                                        <RadzenButton Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Primary" Variant="Radzen.Variant.Outlined"
                                                      Text="Update" Click="@(() => OpenSetKeyDialog(provider))" />
                                        <RadzenButton Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger" Variant="Radzen.Variant.Outlined"
                                                      Text="Remove" Click="@(() => ConfirmRemoveKey(provider))" />
                                    }
                                    else
                                    {
                                        <RadzenButton Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Primary" Variant="Radzen.Variant.Outlined"
                                                      Text="Configure" Click="@(() => OpenSetKeyDialog(provider))" />
                                    }
                                }
                                else
                                {
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">View only</RadzenText>
                                }
                            </RadzenStack>
                        </RadzenCard>
                    </RadzenColumn>
                }
            </RadzenRow>
        }
    </RadzenCard>

    <RadzenCard>
        <RadzenText TextStyle="TextStyle.H6" class="rz-mb-2">Getting API Keys</RadzenText>
        <RadzenText TextStyle="TextStyle.Body2" class="rz-mb-4">
            Each translation provider requires an API key from their service. Here are the links to get started:
        </RadzenText>
        <RadzenStack Gap="0.5rem">
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                <RadzenIcon Icon="link" Style="font-size: 1rem;" />
                <RadzenLink Path="https://cloud.google.com/translate" Target="_blank" Text="Google Cloud Translation" />
            </RadzenStack>
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                <RadzenIcon Icon="link" Style="font-size: 1rem;" />
                <RadzenLink Path="https://www.deepl.com/pro-api" Target="_blank" Text="DeepL API" />
            </RadzenStack>
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                <RadzenIcon Icon="link" Style="font-size: 1rem;" />
                <RadzenLink Path="https://platform.openai.com/api-keys" Target="_blank" Text="OpenAI" />
            </RadzenStack>
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                <RadzenIcon Icon="link" Style="font-size: 1rem;" />
                <RadzenLink Path="https://console.anthropic.com/" Target="_blank" Text="Anthropic (Claude)" />
            </RadzenStack>
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                <RadzenIcon Icon="link" Style="font-size: 1rem;" />
                <RadzenLink Path="https://azure.microsoft.com/products/ai-services/translator" Target="_blank" Text="Azure Translator" />
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>
}

@code {
    [Parameter]
    public int OrganizationId { get; set; }

    private OrganizationDto? _organization;
    private List<TranslationProviderDto> _providers = new();
    private bool _loading = true;
    private bool _loadingProviders;
    private bool _canManageKeys;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrganization();
        await LoadProviders();
    }

    private async Task LoadOrganization()
    {
        _loading = true;
        try
        {
            _organization = await OrganizationService.GetOrganizationAsync(OrganizationId);
            if (_organization != null)
            {
                _canManageKeys = _organization.UserRole is "owner" or "admin";
            }
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadProviders()
    {
        _loadingProviders = true;
        try
        {
            _providers = await TranslationService.GetProvidersAsync(organizationId: OrganizationId);
        }
        finally
        {
            _loadingProviders = false;
        }
    }

    private async Task OpenSetKeyDialog(TranslationProviderDto provider)
    {
        var result = await DialogService.OpenAsync<ConfigureProviderDialog>(
            $"Configure {provider.DisplayName}",
            new Dictionary<string, object>
            {
                { "Provider", provider },
                { "Level", "organization" },
                { "EntityId", OrganizationId }
            },
            new Radzen.DialogOptions { Width = "550px" });

        if (result == true)
        {
            await LoadProviders();
        }
    }

    private async Task ConfirmRemoveKey(TranslationProviderDto provider)
    {
        var confirmed = await DialogService.Confirm(
            $"Are you sure you want to remove the {provider.DisplayName} API key? Projects in this organization will fall back to project-level overrides if configured.",
            "Remove API Key?",
            new ConfirmOptions { OkButtonText = "Remove", CancelButtonText = "Cancel" });

        if (confirmed == true)
        {
            var result = await TranslationService.RemoveOrganizationApiKeyAsync(OrganizationId, provider.Name);

            if (result.IsSuccess)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", $"{provider.DisplayName} API key removed");
                await LoadProviders();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", result.ErrorMessage ?? "Failed to remove API key");
            }
        }
    }

    private static string GetProviderIcon(string provider) => provider.ToLowerInvariant() switch
    {
        "google" => "translate",
        "deepl" => "translate",
        "openai" => "psychology",
        "claude" => "psychology",
        "azuretranslator" => "cloud",
        "azureopenai" => "cloud",
        "ollama" => "computer",
        "libretranslate" => "public",
        "mymemory" => "memory",
        _ => "api"
    };

    private static string GetProviderDescription(string provider) => provider.ToLowerInvariant() switch
    {
        "google" => "Google Cloud Translation API with neural machine translation.",
        "deepl" => "High-quality neural translation, especially for European languages.",
        "openai" => "GPT-4 based translation with context awareness.",
        "claude" => "Anthropic's Claude for nuanced, context-aware translation.",
        "azuretranslator" => "Microsoft Azure Cognitive Services Translator.",
        "azureopenai" => "Azure-hosted OpenAI models for enterprise use.",
        "ollama" => "Self-hosted open-source LLMs for private translation.",
        "libretranslate" => "Self-hosted open-source translation API.",
        "mymemory" => "Free translation memory with community contributions.",
        _ => "Translation provider."
    };
}
