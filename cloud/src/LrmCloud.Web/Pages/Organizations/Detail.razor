@page "/organizations/{OrganizationId:int}"
@attribute [Authorize]
@using LrmCloud.Shared.Constants
@using LrmCloud.Shared.DTOs.Organizations
@using LrmCloud.Web.Services
@using LrmCloud.Web.Components
@using LrmCloud.Web.Models
@inject OrganizationService OrganizationService
@inject ProjectService ProjectService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>@(_organization?.Name ?? "Organization") - LRM Cloud</PageTitle>

@if (_isLoading)
{
    <MudStack>
        <MudSkeleton Width="300px" Height="40px" />
        <MudGrid>
            @for (int i = 0; i < 4; i++)
            {
                <MudItem xs="12" sm="6" md="3">
                    <LoadingSkeleton Type="LoadingSkeletonType.Card" />
                </MudItem>
            }
        </MudGrid>
    </MudStack>
}
else if (_organization == null)
{
    <MudAlert Severity="Severity.Error">
        Organization not found or you don't have access to it.
        <MudButton Variant="Variant.Text" Color="Color.Primary" Href="organizations">Back to Organizations</MudButton>
    </MudAlert>
}
else
{
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                       OnClick="@(() => Navigation.NavigateTo("organizations"))"
                       Size="Size.Small" />
        <MudBreadcrumbs Items="_breadcrumbs" />
    </MudStack>

    <!-- Organization Header -->
    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                <MudAvatar Color="@GetOrgColor(_organization.Name)" Size="Size.Large" Style="font-size: 1.5rem;">
                    @GetOrgInitials(_organization.Name)
                </MudAvatar>
                <MudStack Spacing="0">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudText Typo="Typo.h5">@_organization.Name</MudText>
                        <MudChip T="string" Size="Size.Small" Color="@GetRoleColor(_organization.UserRole)">
                            @_organization.UserRole
                        </MudChip>
                    </MudStack>
                    @if (!string.IsNullOrEmpty(_organization.Description))
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">@_organization.Description</MudText>
                    }
                </MudStack>
            </MudStack>

            <MudStack Row="true" Spacing="2">
                <MudButton Variant="Variant.Outlined"
                           StartIcon="@Icons.Material.Filled.People"
                           Href="@($"/organizations/{OrganizationId}/members")">
                    Members (@_organization.MemberCount)
                </MudButton>
                @if (OrganizationRole.IsAdminOrOwner(_organization.UserRole))
                {
                    <MudButton Variant="Variant.Outlined"
                               StartIcon="@Icons.Material.Filled.Key"
                               Href="@($"/organizations/{OrganizationId}/api-keys")">
                        API Keys
                    </MudButton>
                    <MudButton Variant="Variant.Outlined"
                               StartIcon="@Icons.Material.Filled.CreditCard"
                               Href="@($"/organizations/{OrganizationId}/billing")">
                        Billing
                    </MudButton>
                    <MudButton Variant="Variant.Outlined"
                               StartIcon="@Icons.Material.Filled.Settings"
                               Href="@($"/organizations/{OrganizationId}/settings")">
                        Settings
                    </MudButton>
                }
                @if (_organization.UserRole != OrganizationRole.Owner)
                {
                    <MudMenu Icon="@Icons.Material.Filled.MoreVert"
                             Color="Color.Default"
                             AnchorOrigin="Origin.BottomRight"
                             TransformOrigin="Origin.TopRight">
                        <MudMenuItem Icon="@Icons.Material.Filled.ExitToApp"
                                     IconColor="Color.Error"
                                     OnClick="@ShowLeaveConfirmation">
                            Leave Organization
                        </MudMenuItem>
                    </MudMenu>
                }
            </MudStack>
        </MudStack>
    </MudPaper>

    <!-- Quick Stats -->
    <MudGrid Class="mb-4">
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="2" Class="pa-4">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">PLAN</MudText>
                        <MudText Typo="Typo.h6">@_organization.Plan.ToUpperInvariant()</MudText>
                    </MudStack>
                    <MudIcon Icon="@Icons.Material.Filled.CreditCard" Size="Size.Large" Color="Color.Secondary" Style="opacity: 0.5;" />
                </MudStack>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="2" Class="pa-4">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">MEMBERS</MudText>
                        <MudText Typo="Typo.h6">@_organization.MemberCount</MudText>
                    </MudStack>
                    <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Large" Color="Color.Secondary" Style="opacity: 0.5;" />
                </MudStack>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="2" Class="pa-4">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">PROJECTS</MudText>
                        <MudText Typo="Typo.h6">@_orgProjects.Count</MudText>
                    </MudStack>
                    <MudIcon Icon="@Icons.Material.Filled.Folder" Size="Size.Large" Color="Color.Secondary" Style="opacity: 0.5;" />
                </MudStack>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="2" Class="pa-4">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">CREATED</MudText>
                        <MudText Typo="Typo.h6">@_organization.CreatedAt.ToString("MMM yyyy")</MudText>
                    </MudStack>
                    <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Size="Size.Large" Color="Color.Secondary" Style="opacity: 0.5;" />
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <!-- Organization Projects -->
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudText Typo="Typo.h6">Projects</MudText>
        @if (OrganizationRole.IsAdminOrOwner(_organization.UserRole) || _organization.UserRole == OrganizationRole.Member)
        {
            <MudButton Variant="Variant.Outlined"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Add"
                       Href="projects">
                View All Projects
            </MudButton>
        }
    </MudStack>

    @if (!_orgProjects.Any())
    {
        <EmptyState Icon="@Icons.Material.Filled.FolderOpen"
                    Title="No projects yet"
                    Description="This organization doesn't have any projects. Create a project and assign it to this organization."
                    Elevation="1" />
    }
    else
    {
        <MudGrid>
            @foreach (var project in _orgProjects.Take(6))
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="2" Class="cursor-pointer" @onclick="@(() => Navigation.NavigateTo($"/projects/{project.Id}"))">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.subtitle1">@project.Name</MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                <MudChip T="string" Size="Size.Small" Color="@GetFormatColor(project.Format)">@project.Format</MudChip>
                            </CardHeaderActions>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.caption">@project.KeyCount keys</MudText>
                                <MudText Typo="Typo.caption">@project.CompletionPercentage.ToString("F0")% complete</MudText>
                            </MudStack>
                            <MudProgressLinear Value="@project.CompletionPercentage"
                                               Color="@GetCompletionColor(project.CompletionPercentage)"
                                               Class="mt-2" />
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>

        @if (_orgProjects.Count > 6)
        {
            <MudStack Row="true" Justify="Justify.Center" Class="mt-4">
                <MudButton Variant="Variant.Text" Color="Color.Primary" Href="projects">
                    View all @_orgProjects.Count projects
                </MudButton>
            </MudStack>
        }
    }
}

<!-- Leave Organization Confirmation Dialog -->
<MudDialog @bind-Visible="_leaveDialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Warning" />
            <MudText Typo="Typo.h6">Leave Organization</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudText Typo="Typo.body1">
            Are you sure you want to leave <strong>@_organization?.Name</strong>?
        </MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
            You will lose access to all organization projects and resources. To rejoin, you'll need to be invited again.
        </MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@CloseLeaveDialog" Disabled="@_isLeaving">Cancel</MudButton>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Error"
                   OnClick="@ConfirmLeaveOrganization"
                   Disabled="@_isLeaving">
            @if (_isLeaving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Leave Organization
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter]
    public int OrganizationId { get; set; }

    private OrganizationDto? _organization;
    private List<LrmCloud.Shared.DTOs.Projects.ProjectDto> _orgProjects = new();
    private bool _isLoading = true;
    private bool _leaveDialogVisible;
    private bool _isLeaving;
    private List<BreadcrumbItem> _breadcrumbs = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            _organization = await OrganizationService.GetOrganizationAsync(OrganizationId);
            if (_organization != null)
            {
                // Load organization projects
                var allProjects = await ProjectService.GetProjectsAsync();
                _orgProjects = allProjects.Where(p => p.OrganizationId == OrganizationId).ToList();

                _breadcrumbs = new List<BreadcrumbItem>
                {
                    new("Organizations", "/organizations"),
                    new(_organization.Name, null, disabled: true)
                };
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load organization: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private static string GetOrgInitials(string name)
    {
        var words = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (words.Length >= 2)
            return $"{words[0][0]}{words[1][0]}".ToUpper();
        return name.Length >= 2 ? name[..2].ToUpper() : name.ToUpper();
    }

    private static Color GetOrgColor(string name)
    {
        var hash = name.GetHashCode();
        var colors = new[] { Color.Primary, Color.Secondary, Color.Info, Color.Success, Color.Warning };
        return colors[Math.Abs(hash) % colors.Length];
    }

    private static Color GetRoleColor(string role) => role switch
    {
        OrganizationRole.Owner => Color.Error,
        OrganizationRole.Admin => Color.Warning,
        OrganizationRole.Member => Color.Primary,
        OrganizationRole.Viewer => Color.Default,
        _ => Color.Default
    };

    private static Color GetFormatColor(string format) => format.ToLower() switch
    {
        "resx" => Color.Primary,
        "json" => Color.Info,
        "i18next" => Color.Secondary,
        _ => Color.Default
    };

    private static Color GetCompletionColor(double percentage) => percentage switch
    {
        >= 90 => Color.Success,
        >= 50 => Color.Warning,
        _ => Color.Error
    };

    private void ShowLeaveConfirmation()
    {
        _leaveDialogVisible = true;
    }

    private void CloseLeaveDialog()
    {
        _leaveDialogVisible = false;
    }

    private async Task ConfirmLeaveOrganization()
    {
        _isLeaving = true;
        try
        {
            var (success, error) = await OrganizationService.LeaveOrganizationAsync(OrganizationId);

            if (success)
            {
                Snackbar.Add($"You have left {_organization?.Name}", Severity.Info);
                Navigation.NavigateTo("organizations");
            }
            else
            {
                Snackbar.Add(error ?? "Failed to leave organization", Severity.Error);
            }
        }
        finally
        {
            _isLeaving = false;
            _leaveDialogVisible = false;
        }
    }
}
