@page "/organizations/{OrganizationId:int}"
@attribute [Authorize]
@using LrmCloud.Shared.Constants
@using LrmCloud.Shared.DTOs.Organizations
@using LrmCloud.Web.Services
@using LrmCloud.Web.Components
@using LrmCloud.Web.Models
@using LrmCloud.Web.Helpers
@inject OrganizationService OrganizationService
@inject ProjectService ProjectService
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService

<PageTitle>@(_organization?.Name ?? "Organization") - LRM Cloud</PageTitle>

@if (_isLoading)
{
    <RadzenStack Gap="1rem">
        <div style="background: var(--rz-base-light); width: 300px; height: 40px; border-radius: 4px;"></div>
        <RadzenRow Gap="1rem">
            @for (int i = 0; i < 4; i++)
            {
                <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
                    <LoadingSkeleton Type="LoadingSkeletonType.Card" />
                </RadzenColumn>
            }
        </RadzenRow>
    </RadzenStack>
}
else if (_organization == null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" Shade="Shade.Lighter" AllowClose="false">
        Organization not found or you don't have access to it.
        <RadzenLink Path="organizations" Text="Back to Organizations" class="rz-ms-2" />
    </RadzenAlert>
}
else
{
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-2">
        <RadzenButton Variant="Radzen.Variant.Text" Icon="arrow_back" Click="@(() => Navigation.NavigateTo("organizations"))" Size="ButtonSize.Small" />
        <RadzenBreadCrumb>
            <RadzenBreadCrumbItem Path="organizations" Text="Organizations" />
            <RadzenBreadCrumbItem Text="@_organization.Name" />
        </RadzenBreadCrumb>
    </RadzenStack>

    <!-- Organization Header -->
    <RadzenCard class="rz-mb-4">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" Gap="1rem" Wrap="FlexWrap.Wrap">
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.75rem">
                <div style="width: 56px; height: 56px; border-radius: 50%; background: var(--rz-primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.5rem;">
                    @UiHelpers.GetInitials(_organization.Name)
                </div>
                <RadzenStack Gap="0.25rem">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.H5">@_organization.Name</RadzenText>
                        <RadzenBadge BadgeStyle="@UiHelpers.GetRoleBadgeStyle(_organization.UserRole)" Text="@_organization.UserRole" />
                    </RadzenStack>
                    @if (!string.IsNullOrEmpty(_organization.Description))
                    {
                        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">@_organization.Description</RadzenText>
                    }
                </RadzenStack>
            </RadzenStack>

            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" Wrap="FlexWrap.Wrap">
                <RadzenButton Variant="Radzen.Variant.Outlined" Icon="people" Text="@($"Members ({_organization.MemberCount})")" Click="@(() => Navigation.NavigateTo($"organizations/{OrganizationId}/members"))" />
                @if (OrganizationRole.IsAdminOrOwner(_organization.UserRole))
                {
                    <RadzenButton Variant="Radzen.Variant.Outlined" Icon="key" Text="API Keys" Click="@(() => Navigation.NavigateTo($"organizations/{OrganizationId}/api-keys"))" />
                    <RadzenButton Variant="Radzen.Variant.Outlined" Icon="credit_card" Text="Billing" Click="@(() => Navigation.NavigateTo($"organizations/{OrganizationId}/billing"))" />
                    <RadzenButton Variant="Radzen.Variant.Outlined" Icon="settings" Text="Settings" Click="@(() => Navigation.NavigateTo($"organizations/{OrganizationId}/settings"))" />
                }
                @if (_organization.UserRole != OrganizationRole.Owner)
                {
                    <RadzenSplitButton Icon="more_vert" Click="@ShowLeaveConfirmation">
                        <ChildContent>
                            <RadzenSplitButtonItem Text="Leave Organization" Icon="exit_to_app" />
                        </ChildContent>
                    </RadzenSplitButton>
                }
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>

    <!-- Quick Stats -->
    <RadzenRow Gap="1rem" class="rz-mb-4">
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">PLAN</RadzenText>
                        <RadzenText TextStyle="TextStyle.H6">@_organization.Plan.ToUpperInvariant()</RadzenText>
                    </RadzenStack>
                    <RadzenIcon Icon="credit_card" Style="font-size: 2.5rem; opacity: 0.3; color: var(--rz-text-secondary-color);" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">MEMBERS</RadzenText>
                        <RadzenText TextStyle="TextStyle.H6">@_organization.MemberCount</RadzenText>
                    </RadzenStack>
                    <RadzenIcon Icon="people" Style="font-size: 2.5rem; opacity: 0.3; color: var(--rz-text-secondary-color);" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">PROJECTS</RadzenText>
                        <RadzenText TextStyle="TextStyle.H6">@_orgProjects.Count</RadzenText>
                    </RadzenStack>
                    <RadzenIcon Icon="folder" Style="font-size: 2.5rem; opacity: 0.3; color: var(--rz-text-secondary-color);" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                    <RadzenStack Gap="0.25rem">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">CREATED</RadzenText>
                        <RadzenText TextStyle="TextStyle.H6">@_organization.CreatedAt.ToString("MMM yyyy")</RadzenText>
                    </RadzenStack>
                    <RadzenIcon Icon="calendar_month" Style="font-size: 2.5rem; opacity: 0.3; color: var(--rz-text-secondary-color);" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <!-- Organization Projects -->
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-4">
        <RadzenText TextStyle="TextStyle.H6">Projects</RadzenText>
        @if (OrganizationRole.IsAdminOrOwner(_organization.UserRole) || _organization.UserRole == OrganizationRole.Member)
        {
            <RadzenButton Variant="Radzen.Variant.Outlined" Size="ButtonSize.Small" Icon="add" Text="View All Projects" Click="@(() => Navigation.NavigateTo("projects"))" />
        }
    </RadzenStack>

    @if (!_orgProjects.Any())
    {
        <EmptyState Icon="folder_open"
                    Title="No projects yet"
                    Description="This organization doesn't have any projects. Create a project and assign it to this organization." />
    }
    else
    {
        <RadzenRow Gap="1rem">
            @foreach (var project in _orgProjects.Take(6))
            {
                <RadzenColumn Size="12" SizeSM="6" SizeMD="4">
                    <RadzenCard Style="cursor: pointer;" @onclick="@(() => Navigation.NavigateTo($"projects/{project.Id}"))">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Start">
                            <RadzenText TextStyle="TextStyle.Subtitle1">@project.Name</RadzenText>
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.25rem" AlignItems="Radzen.AlignItems.Center">
                                <RadzenBadge BadgeStyle="@UiHelpers.GetFormatBadgeStyle(project.Format)" Text="@project.Format" />
                                @if (project.ValidationErrors > 0 || project.ValidationWarnings > 0)
                                {
                                    <span title="@UiHelpers.GetValidationTooltip(project)" style="display: flex; gap: 0.125rem;">
                                        @if (project.ValidationErrors > 0)
                                        {
                                            <RadzenIcon Icon="error" Style="color: var(--rz-danger); font-size: 1rem;" />
                                        }
                                        @if (project.ValidationWarnings > 0)
                                        {
                                            <RadzenIcon Icon="warning" Style="color: var(--rz-warning); font-size: 1rem;" />
                                        }
                                    </span>
                                }
                            </RadzenStack>
                        </RadzenStack>
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" class="rz-mt-3">
                            <RadzenText TextStyle="TextStyle.Caption">@project.KeyCount keys</RadzenText>
                            <RadzenText TextStyle="TextStyle.Caption">@project.CompletionPercentage.ToString("F0")% complete</RadzenText>
                        </RadzenStack>
                        <RadzenProgressBar Value="@project.CompletionPercentage" ShowValue="false" ProgressBarStyle="@UiHelpers.GetCompletionProgressStyle(project.CompletionPercentage)" class="rz-mt-2" Style="height: 4px;" />
                    </RadzenCard>
                </RadzenColumn>
            }
        </RadzenRow>

        @if (_orgProjects.Count > 6)
        {
            <RadzenStack JustifyContent="JustifyContent.Center" class="rz-mt-4">
                <RadzenLink Path="projects" Text="@($"View all {_orgProjects.Count} projects")" />
            </RadzenStack>
        }
    }
}

@code {
    [Parameter]
    public int OrganizationId { get; set; }

    private OrganizationDto? _organization;
    private List<LrmCloud.Shared.DTOs.Projects.ProjectDto> _orgProjects = new();
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            _organization = await OrganizationService.GetOrganizationAsync(OrganizationId);
            if (_organization != null)
            {
                var allProjects = await ProjectService.GetProjectsAsync();
                _orgProjects = allProjects.Where(p => p.OrganizationId == OrganizationId).ToList();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load organization: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ShowLeaveConfirmation()
    {
        var confirmed = await DialogService.Confirm(
            $"Are you sure you want to leave {_organization?.Name}? You will lose access to all organization projects and resources. To rejoin, you'll need to be invited again.",
            "Leave Organization",
            new ConfirmOptions { OkButtonText = "Leave Organization", CancelButtonText = "Cancel" });

        if (confirmed == true)
        {
            await ConfirmLeaveOrganization();
        }
    }

    private async Task ConfirmLeaveOrganization()
    {
        var (success, error) = await OrganizationService.LeaveOrganizationAsync(OrganizationId);

        if (success)
        {
            NotificationService.Notify(NotificationSeverity.Info, "Info", $"You have left {_organization?.Name}");
            Navigation.NavigateTo("organizations");
        }
        else
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", error ?? "Failed to leave organization");
        }
    }
}
