@page "/organizations"
@attribute [Authorize]
@using LrmCloud.Shared.Constants
@using LrmCloud.Shared.DTOs.Organizations
@using LrmCloud.Web.Services
@using LrmCloud.Web.Components
@using LrmCloud.Web.Models
@using LrmCloud.Web.Helpers
@inject OrganizationService OrganizationService
@inject LimitsService LimitsService
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService

<PageTitle>Organizations - LRM Cloud</PageTitle>

<RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-4">
    <RadzenText TextStyle="TextStyle.H4">Organizations</RadzenText>
    <RadzenButton Variant="Radzen.Variant.Filled" Icon="add" Text="New Organization" Click="@OpenCreateDialog" Disabled="@(!_canCreateOrg)" title="@_limitMessage" />
</RadzenStack>

@* Pending Invitations Section *@
@if (_pendingInvitations.Any())
{
    <RadzenText TextStyle="TextStyle.H6" class="rz-mb-3">Pending Invitations</RadzenText>
    <RadzenStack Gap="0.5rem" class="rz-mb-6">
        @foreach (var invitation in _pendingInvitations)
        {
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" Gap="1rem" Wrap="FlexWrap.Wrap">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.75rem">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--rz-primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                            @UiHelpers.GetInitials(invitation.OrganizationName)
                        </div>
                        <div>
                            <RadzenText TextStyle="TextStyle.Subtitle1">
                                <strong>@invitation.OrganizationName</strong> invited you as
                                <RadzenBadge BadgeStyle="@UiHelpers.GetRoleBadgeStyle(invitation.Role)" Text="@invitation.Role" class="rz-mx-1" />
                            </RadzenText>
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
                                @if (!string.IsNullOrEmpty(invitation.InvitedByName))
                                {
                                    <span>Invited by @invitation.InvitedByName</span>
                                }
                                <span class="rz-mx-2">Â·</span>
                                <span>Expires @GetExpiryText(invitation.ExpiresAt)</span>
                            </RadzenText>
                        </div>
                    </RadzenStack>
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
                        <RadzenButton Variant="Radzen.Variant.Outlined" Size="ButtonSize.Small" Text="Decline" Click="@(() => DeclineInvitation(invitation))" Disabled="@_isProcessingInvitation" />
                        <RadzenButton ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" Text="Accept" Click="@(() => AcceptInvitation(invitation))" Disabled="@_isProcessingInvitation" IsBusy="@(_processingInvitationId == int.Parse(invitation.Token))" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        }
    </RadzenStack>

    <RadzenText TextStyle="TextStyle.H6" class="rz-mb-3">Your Organizations</RadzenText>
}

@if (_isLoading)
{
    <RadzenRow Gap="1rem">
        @for (int i = 0; i < 3; i++)
        {
            <RadzenColumn Size="12" SizeSM="6" SizeMD="4">
                <LoadingSkeleton Type="LoadingSkeletonType.Card" />
            </RadzenColumn>
        }
    </RadzenRow>
}
else if (!_organizations.Any())
{
    <EmptyState Icon="business"
                Title="No organizations yet"
                Description="@(_canCreateOrg ? "Organizations let you collaborate with your team on translation projects. Create one to get started." : _limitMessage ?? "Organizations are not available on your current plan.")"
                ShowAction="@_canCreateOrg"
                ActionText="Create Organization"
                ActionIcon="add"
                OnActionClick="@OpenCreateDialog" />
}
else
{
    <RadzenRow Gap="1rem">
        @foreach (var org in _organizations)
        {
            <RadzenColumn Size="12" SizeSM="6" SizeMD="4">
                <RadzenCard Style="cursor: pointer;" @onclick="@(() => NavigateToOrg(org.Id))">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Start" Gap="0.75rem">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: var(--rz-primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.25rem;">
                            @UiHelpers.GetInitials(org.Name)
                        </div>
                        <RadzenStack Gap="0.25rem" Style="flex: 1; min-width: 0;">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                                <RadzenText TextStyle="TextStyle.H6" Style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">@org.Name</RadzenText>
                                <RadzenBadge BadgeStyle="@UiHelpers.GetRoleBadgeStyle(org.UserRole)" Text="@org.UserRole" />
                            </RadzenStack>
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">@org.Slug</RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                    @if (!string.IsNullOrEmpty(org.Description))
                    {
                        <RadzenText TextStyle="TextStyle.Body2" class="rz-my-3" Style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            @org.Description
                        </RadzenText>
                    }
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mt-3">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                            <RadzenIcon Icon="people" Style="font-size: 1rem; color: var(--rz-text-secondary-color);" />
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">@org.MemberCount members</RadzenText>
                        </RadzenStack>
                        <RadzenBadge BadgeStyle="@UiHelpers.GetPlanBadgeStyle(org.Plan)" Text="@org.Plan" Variant="Radzen.Variant.Outlined" />
                    </RadzenStack>
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" class="rz-mt-3">
                        <RadzenButton Variant="Radzen.Variant.Text" Text="Members" Click="@(() => NavigateToMembers(org.Id))" @onclick:stopPropagation="true" />
                        @if (OrganizationRole.IsAdminOrOwner(org.UserRole))
                        {
                            <RadzenButton Variant="Radzen.Variant.Text" ButtonStyle="ButtonStyle.Secondary" Text="Settings" Click="@(() => NavigateToSettings(org.Id))" @onclick:stopPropagation="true" />
                        }
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
        }
    </RadzenRow>
}

@code {
    private List<OrganizationDto> _organizations = new();
    private List<PendingInvitationDto> _pendingInvitations = new();
    private bool _isLoading = true;
    private bool _isCreating;
    private bool _isProcessingInvitation;
    private int? _processingInvitationId;
    private bool _canCreateOrg = true;
    private string? _limitMessage;

    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(LoadDataAsync(), CheckLimitsAsync());
    }

    private async Task CheckLimitsAsync()
    {
        var (canCreate, reason) = await LimitsService.CanCreateOrganizationAsync();
        _canCreateOrg = canCreate;
        _limitMessage = reason;
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            var orgsTask = OrganizationService.GetOrganizationsAsync();
            var invitationsTask = OrganizationService.GetPendingInvitationsAsync();

            await Task.WhenAll(orgsTask, invitationsTask);

            _organizations = orgsTask.Result;
            _pendingInvitations = invitationsTask.Result;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load data: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task AcceptInvitation(PendingInvitationDto invitation)
    {
        if (!int.TryParse(invitation.Token, out var invitationId)) return;

        _isProcessingInvitation = true;
        _processingInvitationId = invitationId;

        try
        {
            var (success, error) = await OrganizationService.AcceptInvitationByIdAsync(invitationId);

            if (success)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", $"You've joined {invitation.OrganizationName}!");
                _pendingInvitations.Remove(invitation);
                _organizations = await OrganizationService.GetOrganizationsAsync();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", error ?? "Failed to accept invitation");
            }
        }
        finally
        {
            _isProcessingInvitation = false;
            _processingInvitationId = null;
        }
    }

    private async Task DeclineInvitation(PendingInvitationDto invitation)
    {
        if (!int.TryParse(invitation.Token, out var invitationId)) return;

        _isProcessingInvitation = true;
        _processingInvitationId = invitationId;

        try
        {
            var (success, error) = await OrganizationService.DeclineInvitationByIdAsync(invitationId);

            if (success)
            {
                NotificationService.Notify(NotificationSeverity.Info, "Info", "Invitation declined");
                _pendingInvitations.Remove(invitation);
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", error ?? "Failed to decline invitation");
            }
        }
        finally
        {
            _isProcessingInvitation = false;
            _processingInvitationId = null;
        }
    }

    private static string GetExpiryText(DateTime expiresAt)
    {
        var remaining = expiresAt - DateTime.UtcNow;
        if (remaining.TotalDays >= 1)
            return $"in {(int)remaining.TotalDays} day{((int)remaining.TotalDays != 1 ? "s" : "")}";
        if (remaining.TotalHours >= 1)
            return $"in {(int)remaining.TotalHours} hour{((int)remaining.TotalHours != 1 ? "s" : "")}";
        return "soon";
    }

    private async Task OpenCreateDialog()
    {
        var result = await DialogService.OpenAsync<CreateOrganizationDialog>("Create Organization",
            options: new Radzen.DialogOptions { Width = "500px" });

        if (result is OrganizationDto org)
        {
            _organizations.Insert(0, org);
            NotificationService.Notify(NotificationSeverity.Success, "Success", "Organization created successfully");
        }
    }

    private void NavigateToOrg(int id)
    {
        Navigation.NavigateTo($"organizations/{id}");
    }

    private void NavigateToMembers(int id)
    {
        Navigation.NavigateTo($"organizations/{id}/members");
    }

    private void NavigateToSettings(int id)
    {
        Navigation.NavigateTo($"organizations/{id}/settings");
    }
}
