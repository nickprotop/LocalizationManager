@page "/projects"
@attribute [Authorize]
@using LrmCloud.Web.Helpers
@inject ProjectService ProjectService
@inject LimitsService LimitsService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Projects - LRM Cloud</PageTitle>

<MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
    <MudText Typo="Typo.h4">Projects</MudText>
    <MudTooltip Text="@_limitMessage" Disabled="@_canCreateProject">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="@OpenCreateDialog" Disabled="@(!_canCreateProject)">
            New Project
        </MudButton>
    </MudTooltip>
</MudStack>

<MudStack Row="true" Class="mb-4" Spacing="2">
    <MudTextField @bind-Value="_searchText"
                  Placeholder="Search projects..."
                  Variant="Variant.Outlined"
                  Adornment="Adornment.Start"
                  AdornmentIcon="@Icons.Material.Filled.Search"
                  Immediate="true"
                  DebounceInterval="300"
                  Class="flex-grow-1" />
    <MudSelect @bind-Value="_formatFilter"
               Label="Format"
               Variant="Variant.Outlined"
               Style="min-width: 150px;">
        <MudSelectItem Value="@("")">All Formats</MudSelectItem>
        <MudSelectItem Value="@("resx")">.resx</MudSelectItem>
        <MudSelectItem Value="@("json")">JSON</MudSelectItem>
        <MudSelectItem Value="@("i18next")">i18next</MudSelectItem>
    </MudSelect>
</MudStack>

@if (_isLoading)
{
    <MudGrid>
        @for (int i = 0; i < 6; i++)
        {
            <MudItem xs="12" sm="6" md="4">
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="180px" />
            </MudItem>
        }
    </MudGrid>
}
else if (!FilteredProjects.Any())
{
    <MudPaper Class="pa-4" Elevation="2">
        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Class="py-8">
            @if (_projects.Count == 0)
            {
                <MudIcon Icon="@Icons.Material.Filled.FolderOpen" Size="Size.Large" Color="Color.Secondary" />
                <MudText Typo="Typo.subtitle1" Color="Color.Secondary">No projects yet</MudText>
                <MudTooltip Text="@_limitMessage" Disabled="@_canCreateProject">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="@OpenCreateDialog" Class="mt-2" Disabled="@(!_canCreateProject)">
                        Create Your First Project
                    </MudButton>
                </MudTooltip>
            }
            else
            {
                <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Secondary" />
                <MudText Typo="Typo.subtitle1" Color="Color.Secondary">No projects match your search</MudText>
                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="ClearFilters" Class="mt-2">
                    Clear Filters
                </MudButton>
            }
        </MudStack>
    </MudPaper>
}
else
{
    <MudGrid>
        @foreach (var project in FilteredProjects)
        {
            <MudItem xs="12" sm="6" md="4">
                <MudCard Elevation="2" Class="cursor-pointer" @onclick="@(() => NavigateToProject(project.Id))">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">@project.Name</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                @(project.OrganizationName ?? "Personal")
                            </MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudChip T="string" Size="Size.Small" Color="@UiHelpers.GetFormatColor(project.Format)">@project.Format</MudChip>
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (!string.IsNullOrEmpty(project.Description))
                        {
                            <MudText Typo="Typo.body2" Class="mb-2" Style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                @project.Description
                            </MudText>
                        }
                        <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mt-2">
                            <MudText Typo="Typo.caption">@project.KeyCount keys</MudText>
                            <MudText Typo="Typo.caption">@project.CompletionPercentage.ToString("F0")% complete</MudText>
                        </MudStack>
                        <MudProgressLinear Value="@project.CompletionPercentage" Color="@UiHelpers.GetCompletionColor(project.CompletionPercentage)" Class="mt-2" />
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => NavigateToEditor(project.Id))" ClickPropagation="false">
                            Edit
                        </MudButton>
                        <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="@(() => OpenEditDialog(project))" ClickPropagation="false">
                            Settings
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
    </MudGrid>
}

<CreateProjectDialog @ref="_createDialog" OnProjectCreated="OnProjectCreated" />
<EditProjectDialog @ref="_editDialog" OnProjectUpdated="OnProjectUpdated" OnProjectDeleted="OnProjectDeleted" />

@code {
    private List<ProjectDto> _projects = new();
    private bool _isLoading = true;
    private string _searchText = string.Empty;
    private string _formatFilter = string.Empty;
    private CreateProjectDialog? _createDialog;
    private EditProjectDialog? _editDialog;
    private bool _canCreateProject = true;
    private string? _limitMessage;

    private IEnumerable<ProjectDto> FilteredProjects => _projects
        .Where(p => string.IsNullOrEmpty(_searchText) ||
                    p.Name.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                    (p.Description?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false))
        .Where(p => string.IsNullOrEmpty(_formatFilter) || p.Format == _formatFilter)
        .OrderByDescending(p => p.UpdatedAt);

    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(LoadProjectsAsync(), CheckLimitsAsync());
    }

    private async Task CheckLimitsAsync()
    {
        var (canCreate, reason) = await LimitsService.CanCreateProjectAsync();
        _canCreateProject = canCreate;
        _limitMessage = reason;
    }

    private async Task LoadProjectsAsync()
    {
        _isLoading = true;
        try
        {
            _projects = await ProjectService.GetProjectsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading projects: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ClearFilters()
    {
        _searchText = string.Empty;
        _formatFilter = string.Empty;
    }

    private void OpenCreateDialog()
    {
        _createDialog?.Open();
    }

    private void OpenEditDialog(ProjectDto project)
    {
        _editDialog?.Open(project);
    }

    private async Task OnProjectCreated(ProjectDto project)
    {
        _projects.Insert(0, project);
        LimitsService.InvalidateCache();
        await CheckLimitsAsync();
        StateHasChanged();
    }

    private async Task OnProjectUpdated(ProjectDto project)
    {
        var index = _projects.FindIndex(p => p.Id == project.Id);
        if (index >= 0)
        {
            _projects[index] = project;
            StateHasChanged();
        }
    }

    private async Task OnProjectDeleted(int projectId)
    {
        _projects.RemoveAll(p => p.Id == projectId);
        LimitsService.InvalidateCache();
        await CheckLimitsAsync();
        StateHasChanged();
    }

    private void NavigateToProject(int projectId)
    {
        Navigation.NavigateTo($"projects/{projectId}");
    }

    private void NavigateToEditor(int projectId)
    {
        Navigation.NavigateTo($"projects/{projectId}/editor");
    }
}
