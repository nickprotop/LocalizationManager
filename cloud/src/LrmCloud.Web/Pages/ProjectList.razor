@page "/projects"
@attribute [Authorize]
@using LrmCloud.Web.Helpers
@inject ProjectService ProjectService
@inject LimitsService LimitsService
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService

<PageTitle>Projects - LRM Cloud</PageTitle>

<RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-4">
    <RadzenText TextStyle="TextStyle.H4">Projects</RadzenText>
    <RadzenButton Variant="Radzen.Variant.Filled" Icon="add" Text="New Project" Click="@OpenCreateDialog" Disabled="@(!_canCreateProject)" title="@_limitMessage" />
</RadzenStack>

<RadzenStack Orientation="Radzen.Orientation.Horizontal" class="rz-mb-4" Gap="0.5rem">
    <RadzenTextBox @bind-Value="_searchText" Placeholder="Search projects..." Style="flex: 1;" Change="@(_ => StateHasChanged())" />
    <RadzenDropDown @bind-Value="_formatFilter" Data="@_formatOptions" TextProperty="Text" ValueProperty="Value" Style="min-width: 150px;" Placeholder="All Formats" AllowClear="true" Change="@(_ => StateHasChanged())" />
</RadzenStack>

@if (_isLoading)
{
    <RadzenRow Gap="1rem">
        @for (int i = 0; i < 6; i++)
        {
            <RadzenColumn Size="12" SizeSM="6" SizeMD="4">
                <RadzenCard Style="height: 180px;">
                    <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Small" />
                </RadzenCard>
            </RadzenColumn>
        }
    </RadzenRow>
}
else if (!FilteredProjects.Any())
{
    <RadzenCard>
        <RadzenStack AlignItems="Radzen.AlignItems.Center" JustifyContent="JustifyContent.Center" class="rz-py-8">
            @if (_projects.Count == 0)
            {
                <RadzenIcon Icon="folder_open" Style="font-size: 3rem; color: var(--rz-text-secondary-color);" />
                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-color-secondary">No projects yet</RadzenText>
                <RadzenButton Variant="Radzen.Variant.Filled" Icon="add" Text="Create Your First Project" Click="@OpenCreateDialog" class="rz-mt-2" Disabled="@(!_canCreateProject)" title="@_limitMessage" />
            }
            else
            {
                <RadzenIcon Icon="search_off" Style="font-size: 3rem; color: var(--rz-text-secondary-color);" />
                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-color-secondary">No projects match your search</RadzenText>
                <RadzenButton Variant="Radzen.Variant.Text" Text="Clear Filters" Click="ClearFilters" class="rz-mt-2" />
            }
        </RadzenStack>
    </RadzenCard>
}
else
{
    <RadzenRow Gap="1rem">
        @foreach (var project in FilteredProjects)
        {
            <RadzenColumn Size="12" SizeSM="6" SizeMD="4">
                <RadzenCard Style="cursor: pointer;" @onclick="@(() => NavigateToProject(project.Id))">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Start">
                        <div>
                            <RadzenText TextStyle="TextStyle.H6">@project.Name</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
                                @(project.OrganizationName ?? "Personal")
                            </RadzenText>
                        </div>
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.25rem" AlignItems="Radzen.AlignItems.Center">
                            <RadzenBadge BadgeStyle="@UiHelpers.GetFormatBadgeStyle(project.Format)" Text="@project.Format" />
                            @if (project.ValidationErrors > 0 || project.ValidationWarnings > 0)
                            {
                                <span title="@UiHelpers.GetValidationTooltip(project)" style="display: flex; gap: 0.125rem;">
                                    @if (project.ValidationErrors > 0)
                                    {
                                        <RadzenIcon Icon="error" Style="color: var(--rz-danger); font-size: 1rem;" />
                                    }
                                    @if (project.ValidationWarnings > 0)
                                    {
                                        <RadzenIcon Icon="warning" Style="color: var(--rz-warning); font-size: 1rem;" />
                                    }
                                </span>
                            }
                        </RadzenStack>
                    </RadzenStack>
                    @if (!string.IsNullOrEmpty(project.Description))
                    {
                        <RadzenText TextStyle="TextStyle.Body2" class="rz-mb-2" Style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            @project.Description
                        </RadzenText>
                    }
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" class="rz-mt-2">
                        <RadzenText TextStyle="TextStyle.Caption">@project.KeyCount keys</RadzenText>
                        <RadzenText TextStyle="TextStyle.Caption">@project.CompletionPercentage.ToString("F0")% complete</RadzenText>
                    </RadzenStack>
                    <RadzenProgressBar Value="@project.CompletionPercentage" ShowValue="false" ProgressBarStyle="@UiHelpers.GetCompletionProgressStyle(project.CompletionPercentage)" class="rz-mt-2" Style="height: 4px;" />
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" class="rz-mt-3">
                        <RadzenButton Variant="Radzen.Variant.Text" Text="Edit" Click="@(() => NavigateToEditor(project.Id))" @onclick:stopPropagation="true" />
                        <RadzenButton Variant="Radzen.Variant.Text" ButtonStyle="ButtonStyle.Secondary" Text="Settings" Click="@(() => NavigateToSettings(project.Id))" @onclick:stopPropagation="true" />
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
        }
    </RadzenRow>
}

@code {
    private List<ProjectDto> _projects = new();
    private bool _isLoading = true;
    private string _searchText = string.Empty;
    private string? _formatFilter;
    private bool _canCreateProject = true;
    private string? _limitMessage;

    private readonly List<object> _formatOptions = new()
    {
        new { Value = "resx", Text = ".resx" },
        new { Value = "json", Text = "JSON" },
        new { Value = "i18next", Text = "i18next" },
        new { Value = "android", Text = "Android" },
        new { Value = "ios", Text = "iOS" }
    };

    private IEnumerable<ProjectDto> FilteredProjects => _projects
        .Where(p => string.IsNullOrEmpty(_searchText) ||
                    p.Name.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                    (p.Description?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false))
        .Where(p => string.IsNullOrEmpty(_formatFilter) || p.Format == _formatFilter)
        .OrderByDescending(p => p.UpdatedAt);

    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(LoadProjectsAsync(), CheckLimitsAsync());
    }

    private async Task CheckLimitsAsync()
    {
        var (canCreate, reason) = await LimitsService.CanCreateProjectAsync();
        _canCreateProject = canCreate;
        _limitMessage = reason;
    }

    private async Task LoadProjectsAsync()
    {
        _isLoading = true;
        try
        {
            _projects = await ProjectService.GetProjectsAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error loading projects: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ClearFilters()
    {
        _searchText = string.Empty;
        _formatFilter = null;
    }

    private async Task OpenCreateDialog()
    {
        var result = await DialogService.OpenAsync<CreateProjectDialog>("Create Project",
            null,
            new Radzen.DialogOptions { Width = "500px" });

        if (result is ProjectDto project)
        {
            await OnProjectCreated(project);
        }
    }

    private void NavigateToSettings(int projectId)
    {
        Navigation.NavigateTo($"projects/{projectId}/settings");
    }

    private async Task OnProjectCreated(ProjectDto project)
    {
        _projects.Insert(0, project);
        LimitsService.InvalidateCache();
        await CheckLimitsAsync();
        StateHasChanged();
    }

    private void NavigateToProject(int projectId)
    {
        Navigation.NavigateTo($"projects/{projectId}");
    }

    private void NavigateToEditor(int projectId)
    {
        Navigation.NavigateTo($"projects/{projectId}/editor");
    }
}
