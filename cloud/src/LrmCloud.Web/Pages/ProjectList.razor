@page "/projects"
@attribute [Authorize]
@using LrmCloud.Web.Helpers
@using LrmCloud.Web.Components
@inject ProjectService ProjectService
@inject LimitsService LimitsService
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService

<PageTitle>Projects - LRM Cloud</PageTitle>

<RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" Wrap="FlexWrap.Wrap" Gap="0.5rem" class="rz-mb-4">
    <RadzenText TextStyle="TextStyle.H4" Style="margin: 0;">Projects</RadzenText>
    <RadzenButton Variant="Radzen.Variant.Filled" Icon="add" Text="New Project" Click="@OpenCreateDialog" Disabled="@(!_canCreateProject)" title="@_limitMessage" />
</RadzenStack>

<RadzenStack Orientation="Radzen.Orientation.Horizontal" Wrap="FlexWrap.Wrap" class="rz-mb-4" Gap="0.5rem">
    <RadzenTextBox @bind-Value="_searchText" Placeholder="Search projects..." Style="flex: 1; min-width: 200px;" Change="@(_ => StateHasChanged())" />
    <RadzenDropDown @bind-Value="_formatFilter" Data="@_formatOptions" TextProperty="Text" ValueProperty="Value" Style="min-width: 150px;" Placeholder="All Formats" AllowClear="true" Change="@(_ => StateHasChanged())" />
</RadzenStack>

@if (_isLoading)
{
    <RadzenRow Gap="1rem" class="lrm-stagger">
        @for (int i = 0; i < 6; i++)
        {
            <RadzenColumn Size="12" SizeSM="6" SizeMD="4">
                <div class="project-card" style="cursor: default;">
                    <div class="project-card-header">
                        <div style="flex: 1;">
                            <div class="lrm-skeleton" style="width: 120px; height: 22px; margin-bottom: 4px;"></div>
                            <div class="lrm-skeleton" style="width: 80px; height: 16px;"></div>
                        </div>
                        <div class="lrm-skeleton" style="width: 50px; height: 20px;"></div>
                    </div>
                    <div class="lrm-skeleton" style="width: 100%; height: 16px; margin: 12px 0;"></div>
                    <div class="lrm-skeleton" style="width: 100%; height: 4px; margin-bottom: 16px;"></div>
                    <div style="display: flex; gap: 8px;">
                        <div class="lrm-skeleton" style="width: 50px; height: 32px;"></div>
                        <div class="lrm-skeleton" style="width: 70px; height: 32px;"></div>
                    </div>
                </div>
            </RadzenColumn>
        }
    </RadzenRow>
}
else if (!FilteredProjects.Any())
{
    <div class="empty-state lrm-animate-fade-in-up">
        @if (_projects.Count == 0)
        {
            <RadzenIcon Icon="folder_open" Style="font-size: 4rem; color: var(--lrm-text-muted);" />
            <h3 style="margin: 1rem 0 0.5rem; color: var(--lrm-text-primary);">No projects yet</h3>
            <p style="color: var(--lrm-text-secondary); margin-bottom: 1.5rem;">Create your first project to start managing translations</p>
            <RadzenButton Variant="Radzen.Variant.Filled" Icon="add" Text="Create Your First Project" Click="@OpenCreateDialog" Disabled="@(!_canCreateProject)" title="@_limitMessage" />
        }
        else
        {
            <RadzenIcon Icon="search_off" Style="font-size: 4rem; color: var(--lrm-text-muted);" />
            <h3 style="margin: 1rem 0 0.5rem; color: var(--lrm-text-primary);">No projects match your search</h3>
            <p style="color: var(--lrm-text-secondary); margin-bottom: 1.5rem;">Try adjusting your filters</p>
            <RadzenButton Variant="Radzen.Variant.Text" Text="Clear Filters" Click="ClearFilters" />
        }
    </div>
}
else
{
    <RadzenRow Gap="1rem" class="lrm-stagger">
        @foreach (var project in FilteredProjects)
        {
            <RadzenColumn Size="12" SizeSM="6" SizeMD="4">
                <ProjectCard Project="project" />
            </RadzenColumn>
        }
    </RadzenRow>
}

@code {
    private List<ProjectDto> _projects = new();
    private bool _isLoading = true;
    private string _searchText = string.Empty;
    private string? _formatFilter;
    private bool _canCreateProject = true;
    private string? _limitMessage;

    private readonly List<object> _formatOptions = new()
    {
        new { Value = "resx", Text = ".resx" },
        new { Value = "json", Text = "JSON" },
        new { Value = "i18next", Text = "i18next" },
        new { Value = "android", Text = "Android" },
        new { Value = "ios", Text = "iOS" }
    };

    private IEnumerable<ProjectDto> FilteredProjects => _projects
        .Where(p => string.IsNullOrEmpty(_searchText) ||
                    p.Name.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                    (p.Description?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false))
        .Where(p => string.IsNullOrEmpty(_formatFilter) || p.Format == _formatFilter)
        .OrderByDescending(p => p.UpdatedAt);

    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(LoadProjectsAsync(), CheckLimitsAsync());
    }

    private async Task CheckLimitsAsync()
    {
        var (canCreate, reason) = await LimitsService.CanCreateProjectAsync();
        _canCreateProject = canCreate;
        _limitMessage = reason;
    }

    private async Task LoadProjectsAsync()
    {
        _isLoading = true;
        try
        {
            _projects = await ProjectService.GetProjectsAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error loading projects: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void ClearFilters()
    {
        _searchText = string.Empty;
        _formatFilter = null;
    }

    private async Task OpenCreateDialog()
    {
        var result = await DialogService.OpenAsync<CreateProjectDialog>("Create Project",
            null,
            new Radzen.DialogOptions { Width = "500px" });

        if (result is ProjectDto project)
        {
            await OnProjectCreated(project);
        }
    }

    private async Task OnProjectCreated(ProjectDto project)
    {
        _projects.Insert(0, project);
        LimitsService.InvalidateCache();
        await CheckLimitsAsync();
        StateHasChanged();
    }

}
