@page "/admin/analytics"
@using LrmCloud.Shared.DTOs.Admin
@using LrmCloud.Web.Services
@using LrmCloud.Web.Helpers
@inject AdminService AdminService
@inject NavigationManager Navigation
@attribute [Authorize]

<PageTitle>Analytics - LRM Cloud</PageTitle>

<RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-2">
    <RadzenIcon Icon="trending_up" />
    <RadzenText TextStyle="TextStyle.H4">Analytics</RadzenText>
</RadzenStack>
<RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary rz-mb-4">
    Revenue, user growth, and usage trends.
</RadzenText>

@if (_isLoading)
{
    <RadzenProgressBar Value="100" Mode="ProgressBarMode.Indeterminate" ShowValue="false" />
}
else
{
    <RadzenTabs @bind-SelectedIndex="_selectedTab" RenderMode="TabRenderMode.Client">
        <Tabs>
            @* Revenue Tab *@
            <RadzenTabsItem Text="Revenue" Icon="attach_money">
                @if (_revenue != null)
                {
                    <RadzenRow Gap="1rem" class="rz-p-4 rz-mb-4">
                        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
                            <RadzenCard>
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Current MRR</RadzenText>
                                <RadzenText TextStyle="TextStyle.H4" Style="color: var(--rz-success);">$@_revenue.CurrentMrr.ToString("N2")</RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
                            <RadzenCard>
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Previous MRR</RadzenText>
                                <RadzenText TextStyle="TextStyle.H4">$@_revenue.PreviousMrr.ToString("N2")</RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
                            <RadzenCard>
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Growth</RadzenText>
                                <RadzenText TextStyle="TextStyle.H4" Style="@(GetGrowthStyle(_revenue.MrrGrowthPercent))">
                                    @(_revenue.MrrGrowthPercent >= 0 ? "+" : "")@_revenue.MrrGrowthPercent.ToString("N1")%
                                </RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
                            <RadzenCard>
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Paid Users</RadzenText>
                                <RadzenText TextStyle="TextStyle.H4">@_revenue.MrrHistory.LastOrDefault()?.PaidUsers.ToString("N0")</RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                    </RadzenRow>

                    @* Revenue by Plan *@
                    <RadzenCard class="rz-mb-4">
                        <RadzenText TextStyle="TextStyle.H6" class="rz-mb-3">Revenue by Plan</RadzenText>
                        @if (_revenue.RevenueByPlan.Any())
                        {
                            <RadzenDataGrid TItem="KeyValuePair<string, decimal>" Data="@_revenue.RevenueByPlan.ToList()"
                                            Density="Density.Compact" AllowSorting="false">
                                <Columns>
                                    <RadzenDataGridColumn TItem="KeyValuePair<string, decimal>" Title="Plan">
                                        <Template Context="kv">
                                            <RadzenBadge BadgeStyle="@GetPlanBadgeStyle(kv.Key)" Text="@kv.Key.ToUpper()" />
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="KeyValuePair<string, decimal>" Title="Monthly Revenue">
                                        <Template Context="kv">$@kv.Value.ToString("N2")</Template>
                                    </RadzenDataGridColumn>
                                </Columns>
                            </RadzenDataGrid>
                        }
                        else
                        {
                            <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false">No paid subscriptions yet</RadzenAlert>
                        }
                    </RadzenCard>

                    @* MRR History *@
                    <RadzenCard>
                        <RadzenText TextStyle="TextStyle.H6" class="rz-mb-3">MRR History (12 Months)</RadzenText>
                        @if (_revenue.MrrHistory.Any())
                        {
                            <RadzenDataGrid TItem="MrrDataPoint" Data="@_revenue.MrrHistory" Density="Density.Compact" AllowSorting="false">
                                <Columns>
                                    <RadzenDataGridColumn TItem="MrrDataPoint" Title="Month">
                                        <Template Context="entry">@entry.Month.ToString("MMM yyyy")</Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="MrrDataPoint" Title="MRR">
                                        <Template Context="entry">$@entry.Mrr.ToString("N2")</Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="MrrDataPoint" Property="PaidUsers" Title="Paid Users" />
                                </Columns>
                            </RadzenDataGrid>
                        }
                        else
                        {
                            <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false">No historical data available</RadzenAlert>
                        }
                    </RadzenCard>
                }
                else
                {
                    <RadzenAlert AlertStyle="AlertStyle.Warning" Shade="Shade.Lighter" AllowClose="false">Failed to load revenue data</RadzenAlert>
                }
            </RadzenTabsItem>

            @* Users Tab *@
            <RadzenTabsItem Text="Users" Icon="people">
                @if (_users != null)
                {
                    <RadzenRow Gap="1rem" class="rz-p-4 rz-mb-4">
                        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
                            <RadzenCard>
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Total Users</RadzenText>
                                <RadzenText TextStyle="TextStyle.H4">@_users.TotalUsers.ToString("N0")</RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
                            <RadzenCard>
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">New This Month</RadzenText>
                                <RadzenText TextStyle="TextStyle.H4" Style="color: var(--rz-success);">+@_users.NewUsersThisMonth.ToString("N0")</RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
                            <RadzenCard>
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Growth Rate</RadzenText>
                                <RadzenText TextStyle="TextStyle.H4" Style="@(GetGrowthStyle(_users.GrowthRate))">
                                    @(_users.GrowthRate >= 0 ? "+" : "")@_users.GrowthRate.ToString("N1")%
                                </RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
                            <RadzenCard>
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Churn Rate</RadzenText>
                                <RadzenText TextStyle="TextStyle.H4" Style="@(GetChurnStyle(_users.ChurnRate))">
                                    @_users.ChurnRate.ToString("N1")%
                                </RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                    </RadzenRow>

                    @* User Growth History *@
                    <RadzenCard class="rz-mb-4">
                        <RadzenText TextStyle="TextStyle.H6" class="rz-mb-3">User Growth (12 Months)</RadzenText>
                        @if (_users.GrowthHistory.Any())
                        {
                            <RadzenDataGrid TItem="UserGrowthDataPoint" Data="@_users.GrowthHistory" Density="Density.Compact" AllowSorting="false">
                                <Columns>
                                    <RadzenDataGridColumn TItem="UserGrowthDataPoint" Title="Month">
                                        <Template Context="entry">@entry.Month.ToString("MMM yyyy")</Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="UserGrowthDataPoint" Property="NewUsers" Title="New Users" />
                                    <RadzenDataGridColumn TItem="UserGrowthDataPoint" Property="ActiveUsers" Title="Active Users" />
                                    <RadzenDataGridColumn TItem="UserGrowthDataPoint" Property="TotalUsers" Title="Total Users" />
                                </Columns>
                            </RadzenDataGrid>
                        }
                        else
                        {
                            <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false">No historical data available</RadzenAlert>
                        }
                    </RadzenCard>

                    @* Conversion Funnel *@
                    <RadzenCard>
                        <RadzenText TextStyle="TextStyle.H6" class="rz-mb-3">Plan Distribution</RadzenText>
                        @if (_users.ConversionFunnel.Any())
                        {
                            <RadzenDataGrid TItem="ConversionDataPoint" Data="@_users.ConversionFunnel" Density="Density.Compact" AllowSorting="false">
                                <Columns>
                                    <RadzenDataGridColumn TItem="ConversionDataPoint" Title="From Plan">
                                        <Template Context="entry">
                                            <RadzenBadge BadgeStyle="@GetPlanBadgeStyle(entry.FromPlan)" Text="@entry.FromPlan.ToUpper()" />
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="ConversionDataPoint" Title="To Plan">
                                        <Template Context="entry">
                                            <RadzenBadge BadgeStyle="@GetPlanBadgeStyle(entry.ToPlan)" Text="@entry.ToPlan.ToUpper()" />
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="ConversionDataPoint" Property="Count" Title="Count" />
                                    <RadzenDataGridColumn TItem="ConversionDataPoint" Title="Rate">
                                        <Template Context="entry">@entry.Rate.ToString("N1")%</Template>
                                    </RadzenDataGridColumn>
                                </Columns>
                            </RadzenDataGrid>
                        }
                        else
                        {
                            <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false">No conversion data available</RadzenAlert>
                        }
                    </RadzenCard>
                }
                else
                {
                    <RadzenAlert AlertStyle="AlertStyle.Warning" Shade="Shade.Lighter" AllowClose="false">Failed to load user data</RadzenAlert>
                }
            </RadzenTabsItem>

            @* Usage Tab *@
            <RadzenTabsItem Text="Usage" Icon="data_usage">
                @if (_usage != null)
                {
                    <RadzenRow Gap="1rem" class="rz-p-4 rz-mb-4">
                        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
                            <RadzenCard>
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Total Chars (30 days)</RadzenText>
                                <RadzenText TextStyle="TextStyle.H4">@UiHelpers.FormatNumber(_usage.TotalCharsThisMonth)</RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
                            <RadzenCard>
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">LRM Chars</RadzenText>
                                <RadzenText TextStyle="TextStyle.H4" Style="color: var(--rz-primary);">@UiHelpers.FormatNumber(_usage.TotalLrmChars)</RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
                            <RadzenCard>
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">BYOK Chars</RadzenText>
                                <RadzenText TextStyle="TextStyle.H4" Style="color: var(--rz-info);">@UiHelpers.FormatNumber(_usage.TotalByokChars)</RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
                            <RadzenCard>
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Growth</RadzenText>
                                <RadzenText TextStyle="TextStyle.H4" Style="@(GetGrowthStyle(_usage.GrowthPercent))">
                                    @(_usage.GrowthPercent >= 0 ? "+" : "")@_usage.GrowthPercent.ToString("N1")%
                                </RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                    </RadzenRow>

                    @* Usage by Provider *@
                    <RadzenCard class="rz-mb-4">
                        <RadzenText TextStyle="TextStyle.H6" class="rz-mb-3">Usage by Provider</RadzenText>
                        @if (_usage.UsageByProvider.Any())
                        {
                            var totalProviderChars = _usage.UsageByProvider.Values.Sum();
                            <RadzenDataGrid TItem="KeyValuePair<string, long>" Data="@_usage.UsageByProvider.OrderByDescending(x => x.Value).ToList()"
                                            Density="Density.Compact" AllowSorting="false">
                                <Columns>
                                    <RadzenDataGridColumn TItem="KeyValuePair<string, long>" Title="Provider">
                                        <Template Context="kv">@kv.Key</Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="KeyValuePair<string, long>" Title="Characters">
                                        <Template Context="kv">@UiHelpers.FormatNumber(kv.Value)</Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="KeyValuePair<string, long>" Title="%">
                                        <Template Context="kv">
                                            @((totalProviderChars > 0 ? kv.Value * 100.0 / totalProviderChars : 0).ToString("N1"))%
                                        </Template>
                                    </RadzenDataGridColumn>
                                </Columns>
                            </RadzenDataGrid>
                        }
                        else
                        {
                            <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false">No usage data available</RadzenAlert>
                        }
                    </RadzenCard>

                    @* Daily Usage *@
                    <RadzenCard>
                        <RadzenText TextStyle="TextStyle.H6" class="rz-mb-3">Daily Usage (30 Days)</RadzenText>
                        @if (_usage.DailyTrends.Any())
                        {
                            <RadzenDataGrid TItem="UsageTrendDataPoint" Data="@_usage.DailyTrends.TakeLast(10).ToList()"
                                            Density="Density.Compact" AllowSorting="false">
                                <Columns>
                                    <RadzenDataGridColumn TItem="UsageTrendDataPoint" Title="Date">
                                        <Template Context="entry">@entry.Date.ToString("MMM dd")</Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="UsageTrendDataPoint" Title="LRM Chars">
                                        <Template Context="entry">@UiHelpers.FormatNumber(entry.LrmChars)</Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="UsageTrendDataPoint" Title="BYOK Chars">
                                        <Template Context="entry">@UiHelpers.FormatNumber(entry.ByokChars)</Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="UsageTrendDataPoint" Title="Total">
                                        <Template Context="entry">@UiHelpers.FormatNumber(entry.LrmChars + entry.ByokChars)</Template>
                                    </RadzenDataGridColumn>
                                </Columns>
                            </RadzenDataGrid>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary rz-mt-2">Showing last 10 days</RadzenText>
                        }
                        else
                        {
                            <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false">No daily usage data available</RadzenAlert>
                        }
                    </RadzenCard>
                }
                else
                {
                    <RadzenAlert AlertStyle="AlertStyle.Warning" Shade="Shade.Lighter" AllowClose="false">Failed to load usage data</RadzenAlert>
                }
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>
}

@code {
    private bool _isLoading = true;
    private int _selectedTab;
    private RevenueAnalyticsDto? _revenue;
    private UserAnalyticsDto? _users;
    private UsageAnalyticsDto? _usage;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            var revenueTask = AdminService.GetRevenueAnalyticsAsync(12);
            var usersTask = AdminService.GetUserAnalyticsAsync(12);
            var usageTask = AdminService.GetUsageAnalyticsAsync(30);

            await Task.WhenAll(revenueTask, usersTask, usageTask);

            _revenue = await revenueTask;
            _users = await usersTask;
            _usage = await usageTask;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private static BadgeStyle GetPlanBadgeStyle(string plan) => plan.ToLower() switch
    {
        "enterprise" => BadgeStyle.Success,
        "team" => BadgeStyle.Primary,
        _ => BadgeStyle.Light
    };

    private static string GetGrowthStyle(decimal value) =>
        $"color: {(value >= 0 ? "var(--rz-success)" : "var(--rz-danger)")}";

    private static string GetChurnStyle(decimal value) =>
        $"color: {(value > 5 ? "var(--rz-danger)" : "inherit")}";
}
