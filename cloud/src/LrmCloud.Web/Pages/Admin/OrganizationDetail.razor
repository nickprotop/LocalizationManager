@page "/admin/organizations/{Id:int}"
@using LrmCloud.Shared.DTOs.Admin
@using LrmCloud.Web.Services
@inject AdminService AdminService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@attribute [Authorize]

<PageTitle>@(_org?.Name ?? "Organization") - LRM Cloud Admin</PageTitle>

@* Back Button *@
<MudButton Variant="Variant.Text" Color="Color.Primary" StartIcon="@Icons.Material.Filled.ArrowBack"
           OnClick="@(() => Navigation.NavigateTo("admin/organizations"))" Class="mb-2">
    Back to Organizations
</MudButton>

@if (_isLoading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
}
else if (_org == null)
{
    <MudAlert Severity="Severity.Error">Organization not found.</MudAlert>
}
else
{
    @* Header *@
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <div class="d-flex justify-space-between align-center">
            <div class="d-flex align-center">
                <MudAvatar Size="Size.Large" Class="mr-4" Color="Color.Primary">
                    @_org.Name[0].ToString().ToUpper()
                </MudAvatar>
                <div>
                    <MudText Typo="Typo.h5">@_org.Name</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">@_org.Slug</MudText>
                    @if (!string.IsNullOrEmpty(_org.Description))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">@_org.Description</MudText>
                    }
                </div>
            </div>
            <div class="d-flex gap-2">
                <MudChip T="string" Color="@GetPlanColor(_org.Plan)" Size="Size.Medium">@_org.Plan.ToUpper()</MudChip>
            </div>
        </div>
    </MudPaper>

    @* Stats Cards *@
    <MudGrid Class="mb-4">
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Members</MudText>
                <MudText Typo="Typo.h4">@_org.MemberCount</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Projects</MudText>
                <MudText Typo="Typo.h4">@_org.ProjectCount</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Translation Usage</MudText>
                <MudText Typo="Typo.h4">@FormatNumber(_org.TranslationCharsUsed)</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">of @FormatNumber(_org.TranslationCharsLimit)</MudText>
                <MudProgressLinear Value="@GetUsagePercent()" Color="@GetUsageColor()" Class="mt-2" />
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Created</MudText>
                <MudText Typo="Typo.h6">@_org.CreatedAt.ToString("MMM d, yyyy")</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Updated: @_org.UpdatedAt.ToString("MMM d, yyyy")</MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    @* Tabs *@
    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
        @* Overview Tab *@
        <MudTabPanel Text="Overview" Icon="@Icons.Material.Filled.Info">
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudCard Elevation="0">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">Organization Details</MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudSimpleTable Dense="true">
                                <tbody>
                                    <tr><td><strong>ID</strong></td><td>@_org.Id</td></tr>
                                    <tr><td><strong>Name</strong></td><td>@_org.Name</td></tr>
                                    <tr><td><strong>Slug</strong></td><td>@_org.Slug</td></tr>
                                    <tr><td><strong>Plan</strong></td><td>@_org.Plan</td></tr>
                                    <tr><td><strong>Owner</strong></td><td>@(_org.OwnerEmail ?? "N/A")</td></tr>
                                    <tr><td><strong>Payment Provider</strong></td><td>@(_org.PaymentProvider ?? "None")</td></tr>
                                    <tr><td><strong>Customer ID</strong></td><td>@(_org.PaymentCustomerId ?? "N/A")</td></tr>
                                </tbody>
                            </MudSimpleTable>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudCard Elevation="0">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">Admin Actions</MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <div class="d-flex flex-column gap-2">
                                <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Edit"
                                           OnClick="ShowEditDialog">Edit Organization</MudButton>
                                <MudButton Variant="Variant.Outlined" Color="Color.Warning" StartIcon="@Icons.Material.Filled.RestartAlt"
                                           OnClick="ResetUsageAsync">Reset Usage</MudButton>
                                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.SwapHoriz"
                                           OnClick="ShowTransferOwnershipDialog">Transfer Ownership</MudButton>
                            </div>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            </MudGrid>
        </MudTabPanel>

        @* Members Tab *@
        <MudTabPanel Text="Members" Icon="@Icons.Material.Filled.People" BadgeData="@_org.MemberCount" BadgeColor="Color.Primary">
            <MudTable Items="@_org.Members" Dense="true" Hover="true">
                <HeaderContent>
                    <MudTh>User</MudTh>
                    <MudTh>Role</MudTh>
                    <MudTh>Joined</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="User">
                        <div class="d-flex align-center">
                            <MudAvatar Size="Size.Small" Class="mr-2">
                                @if (!string.IsNullOrEmpty(context.AvatarUrl))
                                {
                                    <MudImage Src="@context.AvatarUrl" />
                                }
                                else
                                {
                                    @context.Email[0].ToString().ToUpper()
                                }
                            </MudAvatar>
                            <div>
                                <MudText Typo="Typo.body2">
                                    @(context.DisplayName ?? context.Username)
                                    @if (context.IsOwner)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.Star" Size="Size.Small" Color="Color.Warning" Class="ml-1" />
                                    }
                                </MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Email</MudText>
                            </div>
                        </div>
                    </MudTd>
                    <MudTd DataLabel="Role">
                        <MudChip T="string" Size="Size.Small" Color="@GetRoleColor(context.Role)">@context.Role.ToUpper()</MudChip>
                    </MudTd>
                    <MudTd DataLabel="Joined">
                        <MudText Typo="Typo.body2">@context.JoinedAt.ToString("MMM d, yyyy")</MudText>
                    </MudTd>
                    <MudTd DataLabel="Actions">
                        <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" Color="Color.Primary"
                                       OnClick="@(() => Navigation.NavigateTo($"admin/users/{context.UserId}"))" />
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudTabPanel>

        @* Projects Tab *@
        <MudTabPanel Text="Projects" Icon="@Icons.Material.Filled.Folder" BadgeData="@_org.ProjectCount" BadgeColor="Color.Info">
            @if (_org.Projects.Count == 0)
            {
                <MudAlert Severity="Severity.Info">No projects in this organization.</MudAlert>
            }
            else
            {
                <MudTable Items="@_org.Projects" Dense="true" Hover="true">
                    <HeaderContent>
                        <MudTh>Project</MudTh>
                        <MudTh>Created</MudTh>
                        <MudTh>Updated</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Project">
                            <div>
                                <MudText Typo="Typo.body2">@context.Name</MudText>
                                @if (!string.IsNullOrEmpty(context.Description))
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Description</MudText>
                                }
                            </div>
                        </MudTd>
                        <MudTd DataLabel="Created">
                            <MudText Typo="Typo.body2">@context.CreatedAt.ToString("MMM d, yyyy")</MudText>
                        </MudTd>
                        <MudTd DataLabel="Updated">
                            <MudText Typo="Typo.body2">@context.UpdatedAt.ToString("MMM d, yyyy")</MudText>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
        </MudTabPanel>
    </MudTabs>
}

@* Edit Organization Dialog *@
<MudDialog @bind-Visible="_showEditDialog">
    <DialogContent>
        <MudText Typo="Typo.h6" Class="mb-4">Edit Organization</MudText>
        <MudTextField @bind-Value="_editName" Label="Name" Variant="Variant.Outlined" Class="mb-3" />
        <MudSelect T="string" @bind-Value="_editPlan" Label="Plan" Variant="Variant.Outlined" Class="mb-3">
            <MudSelectItem Value="@("team")">Team</MudSelectItem>
            <MudSelectItem Value="@("enterprise")">Enterprise</MudSelectItem>
        </MudSelect>
        <MudNumericField T="int" @bind-Value="_editCharsLimit" Label="Translation Chars Limit" Variant="Variant.Outlined" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _showEditDialog = false)">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="SaveEditAsync" Disabled="@_isSaving">
            @if (_isSaving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Save
        </MudButton>
    </DialogActions>
</MudDialog>

@* Transfer Ownership Dialog *@
<MudDialog @bind-Visible="_showTransferDialog">
    <DialogContent>
        <MudText Typo="Typo.h6" Class="mb-4">Transfer Ownership</MudText>
        <MudText Typo="Typo.body2" Class="mb-4">Select a member to become the new owner:</MudText>
        <MudSelect T="int?" @bind-Value="_selectedNewOwnerId" Label="New Owner" Variant="Variant.Outlined">
            @if (_org != null)
            {
                @foreach (var member in _org.Members.Where(m => !m.IsOwner))
                {
                    <MudSelectItem Value="@((int?)member.UserId)">@member.Email (@member.Role)</MudSelectItem>
                }
            }
        </MudSelect>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _showTransferDialog = false)">Cancel</MudButton>
        <MudButton Color="Color.Warning" Variant="Variant.Filled" OnClick="TransferOwnershipAsync" Disabled="@(_selectedNewOwnerId == null || _isSaving)">
            @if (_isSaving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Transfer
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter]
    public int Id { get; set; }

    private bool _isLoading = true;
    private bool _isSaving = false;
    private AdminOrganizationDetailDto? _org;

    // Edit dialog state
    private bool _showEditDialog = false;
    private string? _editName;
    private string? _editPlan;
    private int _editCharsLimit;

    // Transfer dialog state
    private bool _showTransferDialog = false;
    private int? _selectedNewOwnerId;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrganizationAsync();
    }

    private async Task LoadOrganizationAsync()
    {
        _isLoading = true;
        try
        {
            _org = await AdminService.GetOrganizationAsync(Id);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private static Color GetPlanColor(string plan) => plan.ToLower() switch
    {
        "enterprise" => Color.Success,
        "team" => Color.Primary,
        _ => Color.Default
    };

    private static Color GetRoleColor(string role) => role.ToLower() switch
    {
        "owner" => Color.Warning,
        "admin" => Color.Primary,
        _ => Color.Default
    };

    private double GetUsagePercent()
    {
        if (_org == null || _org.TranslationCharsLimit == 0) return 0;
        return Math.Min(100, (double)_org.TranslationCharsUsed / _org.TranslationCharsLimit * 100);
    }

    private Color GetUsageColor()
    {
        var percent = GetUsagePercent();
        if (percent >= 90) return Color.Error;
        if (percent >= 75) return Color.Warning;
        return Color.Success;
    }

    private static string FormatNumber(int num) => num.ToString("N0");

    // Edit dialog methods
    private void ShowEditDialog()
    {
        if (_org == null) return;
        _editName = _org.Name;
        _editPlan = _org.Plan;
        _editCharsLimit = _org.TranslationCharsLimit;
        _showEditDialog = true;
    }

    private async Task SaveEditAsync()
    {
        if (_org == null) return;

        _isSaving = true;
        try
        {
            var dto = new AdminUpdateOrganizationDto
            {
                Name = _editName,
                Plan = _editPlan,
                TranslationCharsLimit = _editCharsLimit
            };

            var (success, error, updatedOrg) = await AdminService.UpdateOrganizationAsync(Id, dto);
            if (success && updatedOrg != null)
            {
                _org = updatedOrg;
                _showEditDialog = false;
                Snackbar.Add("Organization updated successfully", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Error: {error}", Severity.Error);
            }
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task ResetUsageAsync()
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Reset Usage",
            $"Are you sure you want to reset the translation usage for {_org?.Name}?",
            yesText: "Reset", cancelText: "Cancel");

        if (confirmed != true || _org == null) return;

        _isSaving = true;
        try
        {
            var dto = new AdminUpdateOrganizationDto { ResetUsage = true };
            var (success, error, updatedOrg) = await AdminService.UpdateOrganizationAsync(Id, dto);
            if (success && updatedOrg != null)
            {
                _org = updatedOrg;
                Snackbar.Add("Usage reset successfully", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Error: {error}", Severity.Error);
            }
        }
        finally
        {
            _isSaving = false;
        }
    }

    // Transfer ownership methods
    private void ShowTransferOwnershipDialog()
    {
        _selectedNewOwnerId = null;
        _showTransferDialog = true;
    }

    private async Task TransferOwnershipAsync()
    {
        if (_selectedNewOwnerId == null || _org == null) return;

        _isSaving = true;
        try
        {
            var (success, error, updatedOrg) = await AdminService.TransferOrganizationOwnershipAsync(Id, _selectedNewOwnerId.Value);
            if (success && updatedOrg != null)
            {
                _org = updatedOrg;
                _showTransferDialog = false;
                Snackbar.Add("Ownership transferred successfully", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Error: {error}", Severity.Error);
            }
        }
        finally
        {
            _isSaving = false;
        }
    }
}
