@page "/admin/organizations/{Id:int}"
@using LrmCloud.Shared.DTOs.Admin
@using LrmCloud.Web.Services
@using LrmCloud.Web.Helpers
@inject AdminService AdminService
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService
@attribute [Authorize]

<PageTitle>@(_org?.Name ?? "Organization") - LRM Cloud Admin</PageTitle>

@* Back Button *@
<RadzenButton Variant="Radzen.Variant.Text" Icon="arrow_back" Text="Back to Organizations"
              Click="@(() => Navigation.NavigateTo("admin/organizations"))" class="rz-mb-2" />

@if (_isLoading)
{
    <RadzenProgressBar Value="100" Mode="ProgressBarMode.Indeterminate" ShowValue="false" />
}
else if (_org == null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" AllowClose="false">Organization not found.</RadzenAlert>
}
else
{
    @* Header *@
    <RadzenCard class="rz-mb-4">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="1rem">
                <div style="width: 64px; height: 64px; border-radius: 50%; background: var(--rz-primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold;">
                    @_org.Name[0].ToString().ToUpper()
                </div>
                <RadzenStack Gap="0">
                    <RadzenText TextStyle="TextStyle.H5">@_org.Name</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">@_org.Slug</RadzenText>
                    @if (!string.IsNullOrEmpty(_org.Description))
                    {
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary rz-mt-1">@_org.Description</RadzenText>
                    }
                </RadzenStack>
            </RadzenStack>
            <RadzenBadge BadgeStyle="@GetPlanBadgeStyle(_org.Plan)" Text="@_org.Plan.ToUpper()" />
        </RadzenStack>
    </RadzenCard>

    @* Stats Cards *@
    <RadzenRow Gap="1rem" class="rz-mb-4">
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Members</RadzenText>
                <RadzenText TextStyle="TextStyle.H4">@_org.MemberCount</RadzenText>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Projects</RadzenText>
                <RadzenText TextStyle="TextStyle.H4">@_org.ProjectCount</RadzenText>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Translation Usage</RadzenText>
                <RadzenText TextStyle="TextStyle.H4">@FormatNumber(_org.TranslationCharsUsed)</RadzenText>
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">of @FormatNumber(_org.TranslationCharsLimit)</RadzenText>
                <RadzenProgressBar Value="@GetUsagePercent()" ProgressBarStyle="@GetUsageProgressStyle()"
                                   ShowValue="false" Style="height: 6px;" class="rz-mt-2" />
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Created</RadzenText>
                <RadzenText TextStyle="TextStyle.H6">@_org.CreatedAt.ToString("MMM d, yyyy")</RadzenText>
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Updated: @_org.UpdatedAt.ToString("MMM d, yyyy")</RadzenText>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    @* Tabs *@
    <RadzenTabs @bind-SelectedIndex="_selectedTab" RenderMode="TabRenderMode.Client">
        <Tabs>
            @* Overview Tab *@
            <RadzenTabsItem Text="Overview" Icon="info">
                <RadzenRow Gap="1rem" class="rz-p-4">
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenCard>
                            <RadzenText TextStyle="TextStyle.H6" class="rz-mb-3">Organization Details</RadzenText>
                            <RadzenDataGrid TItem="KeyValuePair<string, string>" Data="@GetOrgDetails()" Density="Density.Compact"
                                            AllowSorting="false" AllowPaging="false">
                                <Columns>
                                    <RadzenDataGridColumn TItem="KeyValuePair<string, string>" Property="Key" Title="Field" Width="150px">
                                        <Template Context="kv"><strong>@kv.Key</strong></Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="KeyValuePair<string, string>" Property="Value" Title="Value" />
                                </Columns>
                            </RadzenDataGrid>
                        </RadzenCard>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenCard>
                            <RadzenText TextStyle="TextStyle.H6" class="rz-mb-3">Admin Actions</RadzenText>
                            <RadzenStack Gap="0.5rem">
                                <RadzenButton Variant="Radzen.Variant.Outlined" Icon="edit"
                                              Text="Edit Organization" Click="ShowEditDialog" Style="width: 100%;" />
                                <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Warning" Icon="restart_alt"
                                              Text="Reset Usage" Click="ResetUsageAsync" Style="width: 100%;" />
                                <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Secondary" Icon="swap_horiz"
                                              Text="Transfer Ownership" Click="ShowTransferOwnershipDialog" Style="width: 100%;" />
                            </RadzenStack>
                        </RadzenCard>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenTabsItem>

            @* Members Tab *@
            <RadzenTabsItem Text="@($"Members ({_org.MemberCount})")" Icon="people">
                <div class="rz-p-4">
                    <RadzenDataGrid TItem="AdminOrgMemberDto" Data="@_org.Members" Density="Density.Compact" AllowSorting="false">
                        <Columns>
                            <RadzenDataGridColumn TItem="AdminOrgMemberDto" Title="User">
                                <Template Context="member">
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                                        @if (!string.IsNullOrEmpty(member.AvatarUrl))
                                        {
                                            <RadzenImage Path="@member.AvatarUrl" Style="width: 32px; height: 32px; border-radius: 50%;" />
                                        }
                                        else
                                        {
                                            <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--rz-primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                                @member.Email[0].ToString().ToUpper()
                                            </div>
                                        }
                                        <RadzenStack Gap="0">
                                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                                                <RadzenText TextStyle="TextStyle.Body2">@(member.DisplayName ?? member.Username)</RadzenText>
                                                @if (member.IsOwner)
                                                {
                                                    <RadzenIcon Icon="star" Style="font-size: 1rem; color: var(--rz-warning);" />
                                                }
                                            </RadzenStack>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">@member.Email</RadzenText>
                                        </RadzenStack>
                                    </RadzenStack>
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="AdminOrgMemberDto" Title="Role" Width="120px">
                                <Template Context="member">
                                    <RadzenBadge BadgeStyle="@GetRoleBadgeStyle(member.Role)" Text="@member.Role.ToUpper()" />
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="AdminOrgMemberDto" Title="Joined" Width="120px">
                                <Template Context="member">
                                    <RadzenText TextStyle="TextStyle.Body2">@member.JoinedAt.ToString("MMM d, yyyy")</RadzenText>
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="AdminOrgMemberDto" Title="Actions" Width="80px" TextAlign="TextAlign.Center">
                                <Template Context="member">
                                    <RadzenButton Icon="visibility" Variant="Radzen.Variant.Text" Size="ButtonSize.Small"
                                                  Click="@(() => Navigation.NavigateTo($"admin/users/{member.UserId}"))" />
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                </div>
            </RadzenTabsItem>

            @* Projects Tab *@
            <RadzenTabsItem Text="@($"Projects ({_org.ProjectCount})")" Icon="folder">
                <div class="rz-p-4">
                    @if (_org.Projects.Count == 0)
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false">No projects in this organization.</RadzenAlert>
                    }
                    else
                    {
                        <RadzenDataGrid TItem="AdminOrgProjectDto" Data="@_org.Projects" Density="Density.Compact" AllowSorting="false">
                            <Columns>
                                <RadzenDataGridColumn TItem="AdminOrgProjectDto" Title="Project">
                                    <Template Context="project">
                                        <RadzenStack Gap="0">
                                            <RadzenText TextStyle="TextStyle.Body2">@project.Name</RadzenText>
                                            @if (!string.IsNullOrEmpty(project.Description))
                                            {
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">@project.Description</RadzenText>
                                            }
                                        </RadzenStack>
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="AdminOrgProjectDto" Title="Created" Width="120px">
                                    <Template Context="project">
                                        <RadzenText TextStyle="TextStyle.Body2">@project.CreatedAt.ToString("MMM d, yyyy")</RadzenText>
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="AdminOrgProjectDto" Title="Updated" Width="120px">
                                    <Template Context="project">
                                        <RadzenText TextStyle="TextStyle.Body2">@project.UpdatedAt.ToString("MMM d, yyyy")</RadzenText>
                                    </Template>
                                </RadzenDataGridColumn>
                            </Columns>
                        </RadzenDataGrid>
                    }
                </div>
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private bool _isLoading = true;
    private bool _isSaving = false;
    private AdminOrganizationDetailDto? _org;
    private int _selectedTab;

    // Edit dialog state
    private string? _editName;
    private string? _editPlan;
    private int _editCharsLimit;

    // Transfer dialog state
    private int? _selectedNewOwnerId;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrganizationAsync();
    }

    private async Task LoadOrganizationAsync()
    {
        _isLoading = true;
        try
        {
            _org = await AdminService.GetOrganizationAsync(Id);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private List<KeyValuePair<string, string>> GetOrgDetails()
    {
        if (_org == null) return new();
        return new List<KeyValuePair<string, string>>
        {
            new("ID", _org.Id.ToString()),
            new("Name", _org.Name),
            new("Slug", _org.Slug),
            new("Plan", _org.Plan),
            new("Owner", _org.OwnerEmail ?? "N/A"),
            new("Payment Provider", _org.PaymentProvider ?? "None"),
            new("Customer ID", _org.PaymentCustomerId ?? "N/A")
        };
    }

    private static BadgeStyle GetPlanBadgeStyle(string plan) => plan.ToLower() switch
    {
        "enterprise" => BadgeStyle.Success,
        "team" => BadgeStyle.Primary,
        _ => BadgeStyle.Light
    };

    private static BadgeStyle GetRoleBadgeStyle(string role) => role.ToLower() switch
    {
        "owner" => BadgeStyle.Warning,
        "admin" => BadgeStyle.Primary,
        _ => BadgeStyle.Light
    };

    private double GetUsagePercent()
    {
        if (_org == null || _org.TranslationCharsLimit == 0) return 0;
        return Math.Min(100, (double)_org.TranslationCharsUsed / _org.TranslationCharsLimit * 100);
    }

    private ProgressBarStyle GetUsageProgressStyle()
    {
        var percent = GetUsagePercent();
        if (percent >= 90) return ProgressBarStyle.Danger;
        if (percent >= 75) return ProgressBarStyle.Warning;
        return ProgressBarStyle.Success;
    }

    private static string FormatNumber(int num) => num.ToString("N0");

    // Edit dialog methods
    private async Task ShowEditDialog()
    {
        if (_org == null) return;
        _editName = _org.Name;
        _editPlan = _org.Plan;
        _editCharsLimit = _org.TranslationCharsLimit;

        var result = await DialogService.OpenAsync("Edit Organization", ds =>
            @<RadzenStack Gap="1rem">
                <RadzenFormField Text="Name" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenTextBox @bind-Value="_editName" Style="width: 100%;" />
                    </ChildContent>
                </RadzenFormField>
                <RadzenFormField Text="Plan" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenDropDown @bind-Value="_editPlan" Style="width: 100%;"
                                        Data="@(new[] { "team", "enterprise" })" />
                    </ChildContent>
                </RadzenFormField>
                <RadzenFormField Text="Translation Chars Limit" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenNumeric @bind-Value="_editCharsLimit" Style="width: 100%;" />
                    </ChildContent>
                </RadzenFormField>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem">
                    <RadzenButton Variant="Radzen.Variant.Text" Text="Cancel" Click="@(() => ds.Close(false))" />
                    <RadzenButton ButtonStyle="ButtonStyle.Primary" Text="Save" Click="@(() => ds.Close(true))" />
                </RadzenStack>
            </RadzenStack>,
            new Radzen.DialogOptions { Width = "500px" });

        if (result is true)
        {
            await SaveEditAsync();
        }
    }

    private async Task SaveEditAsync()
    {
        if (_org == null) return;

        _isSaving = true;
        try
        {
            var dto = new AdminUpdateOrganizationDto
            {
                Name = _editName,
                Plan = _editPlan,
                TranslationCharsLimit = _editCharsLimit
            };

            var (success, error, updatedOrg) = await AdminService.UpdateOrganizationAsync(Id, dto);
            if (success && updatedOrg != null)
            {
                _org = updatedOrg;
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Organization updated successfully");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", error);
            }
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task ResetUsageAsync()
    {
        var confirmed = await DialogService.Confirm(
            $"Are you sure you want to reset the translation usage for {_org?.Name}?",
            "Reset Usage",
            new ConfirmOptions { OkButtonText = "Reset", CancelButtonText = "Cancel" });

        if (confirmed != true || _org == null) return;

        _isSaving = true;
        try
        {
            var dto = new AdminUpdateOrganizationDto { ResetUsage = true };
            var (success, error, updatedOrg) = await AdminService.UpdateOrganizationAsync(Id, dto);
            if (success && updatedOrg != null)
            {
                _org = updatedOrg;
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Usage reset successfully");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", error);
            }
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task ShowTransferOwnershipDialog()
    {
        if (_org == null) return;
        _selectedNewOwnerId = null;

        var nonOwnerMembers = _org.Members.Where(m => !m.IsOwner).ToList();
        if (!nonOwnerMembers.Any())
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Warning", "No other members to transfer ownership to");
            return;
        }

        var result = await DialogService.OpenAsync("Transfer Ownership", ds =>
            @<RadzenStack Gap="1rem">
                <RadzenText>Select a member to become the new owner:</RadzenText>
                <RadzenFormField Text="New Owner" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenDropDown @bind-Value="_selectedNewOwnerId" Style="width: 100%;"
                                        Data="@nonOwnerMembers"
                                        TextProperty="Email" ValueProperty="UserId" />
                    </ChildContent>
                </RadzenFormField>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem">
                    <RadzenButton Variant="Radzen.Variant.Text" Text="Cancel" Click="@(() => ds.Close(false))" />
                    <RadzenButton ButtonStyle="ButtonStyle.Warning" Text="Transfer"
                                  Click="@(() => ds.Close(true))" Disabled="@(_selectedNewOwnerId == null)" />
                </RadzenStack>
            </RadzenStack>,
            new Radzen.DialogOptions { Width = "500px" });

        if (result is true && _selectedNewOwnerId.HasValue)
        {
            await TransferOwnershipAsync();
        }
    }

    private async Task TransferOwnershipAsync()
    {
        if (_selectedNewOwnerId == null || _org == null) return;

        _isSaving = true;
        try
        {
            var (success, error, updatedOrg) = await AdminService.TransferOrganizationOwnershipAsync(Id, _selectedNewOwnerId.Value);
            if (success && updatedOrg != null)
            {
                _org = updatedOrg;
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Ownership transferred successfully");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", error);
            }
        }
        finally
        {
            _isSaving = false;
        }
    }
}
