@page "/admin/users"
@using LrmCloud.Shared.DTOs.Admin
@using LrmCloud.Web.Services
@inject AdminService AdminService
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService
@attribute [Authorize]

<PageTitle>User Management - LRM Cloud Admin</PageTitle>

<RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-2">
    <RadzenIcon Icon="people" />
    <RadzenText TextStyle="TextStyle.H4">User Management</RadzenText>
</RadzenStack>
<RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary rz-mb-4">
    View and manage all users, their plans, and usage limits.
</RadzenText>

@* Search and Filters *@
<RadzenCard class="rz-mb-4">
    <RadzenRow Gap="1rem" AlignItems="Radzen.AlignItems.End">
        <RadzenColumn Size="12" SizeMD="5">
            <RadzenFormField Text="Search" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                <ChildContent>
                    <RadzenTextBox @bind-Value="_search" Placeholder="Search by email or username..."
                                   @oninput="OnSearchInput" Style="width: 100%;" />
                </ChildContent>
            </RadzenFormField>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="3">
            <RadzenFormField Text="Plan" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                <ChildContent>
                    <RadzenDropDown @bind-Value="_planFilter" Data="@_planOptions" TextProperty="Text" ValueProperty="Value"
                                    AllowClear="true" Placeholder="All Plans" Style="width: 100%;"
                                    Change="@OnPlanFilterChanged" />
                </ChildContent>
            </RadzenFormField>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="4">
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
                <RadzenButton Variant="Radzen.Variant.Outlined" Icon="refresh" Text="Refresh" Click="LoadUsersAsync" />
                @if (_selectedUserIds.Count > 0)
                {
                    <RadzenSplitButton Text="@($"Bulk Actions ({_selectedUserIds.Count})")" ButtonStyle="ButtonStyle.Secondary"
                                       Click="@(() => { })">
                        <ChildContent>
                            <RadzenSplitButtonItem Text="Change Plan" Icon="upgrade" Click="BulkChangePlanAsync" />
                            <RadzenSplitButtonItem Text="Verify Emails" Icon="mark_email_read" Click="BulkVerifyEmailsAsync" />
                            <RadzenSplitButtonItem Text="Reset Usage" Icon="restart_alt" Click="BulkResetUsageAsync" />
                        </ChildContent>
                    </RadzenSplitButton>
                }
            </RadzenStack>
        </RadzenColumn>
    </RadzenRow>
</RadzenCard>

@if (_isLoading)
{
    <RadzenProgressBar Value="100" Mode="ProgressBarMode.Indeterminate" ShowValue="false" />
}
else if (_users == null || _users.Count == 0)
{
    <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false">No users found.</RadzenAlert>
}
else
{
    <RadzenDataGrid @ref="_grid" TItem="AdminUserDto" Data="@_users" Density="Density.Compact"
                    AllowSorting="false" SelectionMode="DataGridSelectionMode.Multiple"
                    @bind-Value="@_selectedUsers">
        <Columns>
            <RadzenDataGridColumn TItem="AdminUserDto" Width="40px" Sortable="false" Filterable="false">
                <HeaderTemplate>
                    <RadzenCheckBox TValue="bool" Value="@(_selectedUsers.Count == _users.Count && _users.Count > 0)"
                                    Change="@SelectAllUsers" />
                </HeaderTemplate>
                <Template Context="user">
                    <RadzenCheckBox TValue="bool" Value="@_selectedUsers.Contains(user)"
                                    Change="@(v => ToggleUserSelection(user, v))" />
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="AdminUserDto" Title="User">
                <Template Context="user">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                        @if (!string.IsNullOrEmpty(user.AvatarUrl))
                        {
                            <RadzenImage Path="@user.AvatarUrl" Style="width: 32px; height: 32px; border-radius: 50%;" />
                        }
                        else
                        {
                            <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--rz-primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                @user.Email[0].ToString().ToUpper()
                            </div>
                        }
                        <RadzenStack Gap="0">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                                <RadzenText TextStyle="TextStyle.Body2">@(user.DisplayName ?? user.Username)</RadzenText>
                                @if (user.IsSuperAdmin)
                                {
                                    <RadzenIcon Icon="star" Style="font-size: 1rem; color: var(--rz-warning);" />
                                }
                            </RadzenStack>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">@user.Email</RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="AdminUserDto" Title="Auth" Width="100px">
                <Template Context="user">
                    <RadzenBadge BadgeStyle="@(user.AuthType == "github" ? BadgeStyle.Dark : BadgeStyle.Light)" Text="@user.AuthType" />
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="AdminUserDto" Title="Plan" Width="100px">
                <Template Context="user">
                    <RadzenBadge BadgeStyle="@GetPlanBadgeStyle(user.Plan)" Text="@user.Plan.ToUpper()" />
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="AdminUserDto" Title="Status" Width="100px">
                <Template Context="user">
                    @if (user.EmailVerified)
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Verified" />
                    }
                    else
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Warning" Text="Unverified" />
                    }
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="AdminUserDto" Title="Created" Width="120px">
                <Template Context="user">
                    <RadzenText TextStyle="TextStyle.Body2">@user.CreatedAt.ToString("MMM d, yyyy")</RadzenText>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="AdminUserDto" Title="Last Login" Width="120px">
                <Template Context="user">
                    <RadzenText TextStyle="TextStyle.Body2">@(user.LastLoginAt?.ToString("MMM d, yyyy") ?? "-")</RadzenText>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="AdminUserDto" Title="Actions" Width="80px" TextAlign="TextAlign.Center">
                <Template Context="user">
                    <RadzenButton Icon="visibility" Variant="Radzen.Variant.Text" Size="ButtonSize.Small"
                                  Click="@(() => ViewUser(user.Id))" />
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>

    @* Pagination Info *@
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mt-2">
        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
            Showing @_users.Count of @_totalCount users (Page @_page)
            @if (_selectedUserIds.Count > 0)
            {
                <text> â€¢ @_selectedUserIds.Count selected</text>
            }
        </RadzenText>
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
            <RadzenButton Variant="Radzen.Variant.Outlined" Size="ButtonSize.Small" Text="Previous"
                          Disabled="@(_page <= 1)" Click="PreviousPage" />
            <RadzenButton Variant="Radzen.Variant.Outlined" Size="ButtonSize.Small" Text="Next"
                          Disabled="@(_users.Count < _pageSize)" Click="NextPage" />
        </RadzenStack>
    </RadzenStack>
}

@code {
    private bool _isLoading = true;
    private bool _isBulkActionLoading = false;
    private List<AdminUserDto>? _users;
    private int _totalCount;
    private string _search = "";
    private string? _planFilter;
    private int _page = 1;
    private int _pageSize = 20;
    private RadzenDataGrid<AdminUserDto>? _grid;

    private readonly List<object> _planOptions = new()
    {
        new { Value = "free", Text = "Free" },
        new { Value = "team", Text = "Team" },
        new { Value = "enterprise", Text = "Enterprise" }
    };

    // Selection state
    private IList<AdminUserDto> _selectedUsers = new List<AdminUserDto>();
    private List<int> _selectedUserIds => _selectedUsers.Select(u => u.Id).ToList();

    protected override async Task OnInitializedAsync()
    {
        await LoadUsersAsync();
    }

    private async Task LoadUsersAsync()
    {
        _isLoading = true;
        try
        {
            var (users, totalCount) = await AdminService.GetUsersAsync(_search, _planFilter, _page, _pageSize);
            _users = users;
            _totalCount = totalCount;
            _selectedUsers = new List<AdminUserDto>();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private System.Timers.Timer? _debounceTimer;

    private void OnSearchInput(ChangeEventArgs e)
    {
        _search = e.Value?.ToString() ?? "";
        _debounceTimer?.Stop();
        _debounceTimer?.Dispose();
        _debounceTimer = new System.Timers.Timer(300);
        _debounceTimer.Elapsed += async (s, e) =>
        {
            _debounceTimer?.Stop();
            await InvokeAsync(async () =>
            {
                _page = 1;
                await LoadUsersAsync();
                StateHasChanged();
            });
        };
        _debounceTimer.Start();
    }

    private async Task OnPlanFilterChanged(object value)
    {
        _planFilter = value?.ToString();
        _page = 1;
        await LoadUsersAsync();
    }

    private async Task PreviousPage()
    {
        if (_page > 1)
        {
            _page--;
            await LoadUsersAsync();
        }
    }

    private async Task NextPage()
    {
        if (_users?.Count == _pageSize)
        {
            _page++;
            await LoadUsersAsync();
        }
    }

    private void ViewUser(int userId)
    {
        Navigation.NavigateTo($"admin/users/{userId}");
    }

    private static BadgeStyle GetPlanBadgeStyle(string plan) => plan.ToLower() switch
    {
        "enterprise" => BadgeStyle.Success,
        "team" => BadgeStyle.Primary,
        _ => BadgeStyle.Light
    };

    private void SelectAllUsers(bool selectAll)
    {
        if (selectAll && _users != null)
        {
            _selectedUsers = new List<AdminUserDto>(_users);
        }
        else
        {
            _selectedUsers = new List<AdminUserDto>();
        }
    }

    private void ToggleUserSelection(AdminUserDto user, bool selected)
    {
        var list = _selectedUsers.ToList();
        if (selected)
        {
            if (!list.Contains(user)) list.Add(user);
        }
        else
        {
            list.Remove(user);
        }
        _selectedUsers = list;
    }

    private async Task BulkChangePlanAsync()
    {
        string newPlan = "team";

        var result = await DialogService.OpenAsync("Change Plan", ds =>
            @<RadzenStack Gap="1rem">
                <RadzenText>Change Plan for @_selectedUserIds.Count Users</RadzenText>
                <RadzenFormField Text="New Plan" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenDropDown @bind-Value="newPlan" Style="width: 100%;"
                                        Data="@(new[] { new { Value = "free", Text = "Free" }, new { Value = "team", Text = "Team ($9/mo)" }, new { Value = "enterprise", Text = "Enterprise ($29/mo)" } })"
                                        TextProperty="Text" ValueProperty="Value" />
                    </ChildContent>
                </RadzenFormField>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem">
                    <RadzenButton Variant="Radzen.Variant.Text" Text="Cancel" Click="@(() => ds.Close(null))" />
                    <RadzenButton ButtonStyle="ButtonStyle.Primary" Text="Change Plan" Click="@(() => ds.Close(newPlan))" />
                </RadzenStack>
            </RadzenStack>,
            new Radzen.DialogOptions { Width = "400px" });

        if (result is string plan && !string.IsNullOrEmpty(plan))
        {
            _isBulkActionLoading = true;
            try
            {
                var (success, error, bulkResult) = await AdminService.BulkChangePlanAsync(_selectedUserIds, plan);
                if (success && bulkResult != null)
                {
                    NotificationService.Notify(NotificationSeverity.Success, "Success",
                        $"Plan changed for {bulkResult.SuccessCount} users. {bulkResult.FailureCount} failed.");
                    _selectedUsers = new List<AdminUserDto>();
                    await LoadUsersAsync();
                }
                else
                {
                    NotificationService.Notify(NotificationSeverity.Error, "Error", error);
                }
            }
            finally
            {
                _isBulkActionLoading = false;
            }
        }
    }

    private async Task BulkVerifyEmailsAsync()
    {
        var confirmed = await DialogService.Confirm(
            $"Are you sure you want to verify emails for {_selectedUserIds.Count} users?",
            "Verify Emails",
            new ConfirmOptions { OkButtonText = "Verify", CancelButtonText = "Cancel" });

        if (confirmed != true) return;

        _isBulkActionLoading = true;
        try
        {
            var (success, error, result) = await AdminService.BulkVerifyEmailsAsync(_selectedUserIds);
            if (success && result != null)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success",
                    $"Verified {result.SuccessCount} users. {result.FailureCount} failed.");
                _selectedUsers = new List<AdminUserDto>();
                await LoadUsersAsync();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", error);
            }
        }
        finally
        {
            _isBulkActionLoading = false;
        }
    }

    private async Task BulkResetUsageAsync()
    {
        var confirmed = await DialogService.Confirm(
            $"Are you sure you want to reset usage counters for {_selectedUserIds.Count} users? This will set their translation characters to 0.",
            "Reset Usage",
            new ConfirmOptions { OkButtonText = "Reset", CancelButtonText = "Cancel" });

        if (confirmed != true) return;

        _isBulkActionLoading = true;
        try
        {
            var (success, error, result) = await AdminService.BulkResetUsageAsync(_selectedUserIds);
            if (success && result != null)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success",
                    $"Reset usage for {result.SuccessCount} users. {result.FailureCount} failed.");
                _selectedUsers = new List<AdminUserDto>();
                await LoadUsersAsync();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", error);
            }
        }
        finally
        {
            _isBulkActionLoading = false;
        }
    }
}
