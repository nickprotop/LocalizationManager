@page "/admin/health"
@using LrmCloud.Shared.DTOs.Admin
@using LrmCloud.Web.Services
@inject AdminService AdminService
@attribute [Authorize]

<PageTitle>System Health - LRM Cloud Admin</PageTitle>

<RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-4">
    <RadzenStack Gap="0">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
            <RadzenIcon Icon="health_and_safety" />
            <RadzenText TextStyle="TextStyle.H4">System Health</RadzenText>
        </RadzenStack>
        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
            Real-time status of all system services.
        </RadzenText>
    </RadzenStack>
    <RadzenButton Variant="Radzen.Variant.Outlined" Icon="refresh" Text="Refresh" Click="LoadHealthAsync" />
</RadzenStack>

@if (_isLoading)
{
    <RadzenProgressBar Value="100" Mode="ProgressBarMode.Indeterminate" ShowValue="false" />
}
else if (_health == null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" AllowClose="false">Failed to load system health status.</RadzenAlert>
}
else
{
    @* Overall Status Banner *@
    <RadzenAlert AlertStyle="@(_health.IsHealthy ? AlertStyle.Success : AlertStyle.Danger)" Shade="Shade.Lighter" AllowClose="false" class="rz-mb-4">
        <RadzenText TextStyle="TextStyle.Subtitle1">
            System is @(_health.IsHealthy ? "Healthy" : "Unhealthy")
        </RadzenText>
    </RadzenAlert>

    <RadzenRow Gap="1rem">
        @* Database *@
        <RadzenColumn Size="12" SizeSM="6" SizeMD="4">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-3">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="storage" Style="@($"color: {(_health.Database.IsHealthy ? "var(--rz-success)" : "var(--rz-danger)")};")" />
                        <RadzenText TextStyle="TextStyle.H6">Database</RadzenText>
                    </RadzenStack>
                    <RadzenBadge BadgeStyle="@(_health.Database.IsHealthy ? BadgeStyle.Success : BadgeStyle.Danger)"
                                 Text="@(_health.Database.IsHealthy ? "Healthy" : "Error")" />
                </RadzenStack>
                <hr class="rz-mb-3" />
                <RadzenRow>
                    <RadzenColumn Size="6">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Status</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2">@(_health.Database.IsHealthy ? "Connected" : "Disconnected")</RadzenText>
                    </RadzenColumn>
                    <RadzenColumn Size="6">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Latency</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2">@(_health.Database.LatencyMs.HasValue ? $"{_health.Database.LatencyMs}ms" : "-")</RadzenText>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenCard>
        </RadzenColumn>

        @* Redis *@
        <RadzenColumn Size="12" SizeSM="6" SizeMD="4">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-3">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="memory" Style="@($"color: {(_health.Redis.IsHealthy ? "var(--rz-success)" : "var(--rz-danger)")};")" />
                        <RadzenText TextStyle="TextStyle.H6">Redis</RadzenText>
                    </RadzenStack>
                    <RadzenBadge BadgeStyle="@(_health.Redis.IsHealthy ? BadgeStyle.Success : BadgeStyle.Danger)"
                                 Text="@(_health.Redis.IsHealthy ? "Healthy" : "Error")" />
                </RadzenStack>
                <hr class="rz-mb-3" />
                <RadzenRow>
                    <RadzenColumn Size="6">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Status</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2">@(_health.Redis.IsHealthy ? "Connected" : "Disconnected")</RadzenText>
                    </RadzenColumn>
                    <RadzenColumn Size="6">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Latency</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2">@(_health.Redis.LatencyMs.HasValue ? $"{_health.Redis.LatencyMs}ms" : "-")</RadzenText>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenCard>
        </RadzenColumn>

        @* MinIO *@
        <RadzenColumn Size="12" SizeSM="6" SizeMD="4">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-3">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="cloud_queue" Style="@($"color: {(_health.MinIO.IsHealthy ? "var(--rz-success)" : "var(--rz-danger)")};")" />
                        <RadzenText TextStyle="TextStyle.H6">MinIO Storage</RadzenText>
                    </RadzenStack>
                    <RadzenBadge BadgeStyle="@(_health.MinIO.IsHealthy ? BadgeStyle.Success : BadgeStyle.Danger)"
                                 Text="@(_health.MinIO.IsHealthy ? "Healthy" : "Error")" />
                </RadzenStack>
                <hr class="rz-mb-3" />
                <RadzenRow>
                    <RadzenColumn Size="6">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Status</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2">@(_health.MinIO.IsHealthy ? "Connected" : "Disconnected")</RadzenText>
                    </RadzenColumn>
                    <RadzenColumn Size="6">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Latency</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2">@(_health.MinIO.LatencyMs.HasValue ? $"{_health.MinIO.LatencyMs}ms" : "-")</RadzenText>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenCard>
        </RadzenColumn>

        @* PayPal *@
        @if (_health.PayPal != null)
        {
            <RadzenColumn Size="12" SizeSM="6" SizeMD="4">
                <RadzenCard>
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-3">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                            <RadzenIcon Icon="payment" Style="@($"color: {(_health.PayPal.IsHealthy ? "var(--rz-success)" : "var(--rz-danger)")};")" />
                            <RadzenText TextStyle="TextStyle.H6">PayPal</RadzenText>
                        </RadzenStack>
                        <RadzenBadge BadgeStyle="@(_health.PayPal.IsHealthy ? BadgeStyle.Success : BadgeStyle.Danger)"
                                     Text="@(_health.PayPal.IsHealthy ? "Healthy" : "Error")" />
                    </RadzenStack>
                    <hr class="rz-mb-3" />
                    <RadzenRow>
                        <RadzenColumn Size="6">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Status</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body2">@(_health.PayPal.IsHealthy ? "Connected" : "Disconnected")</RadzenText>
                        </RadzenColumn>
                        <RadzenColumn Size="6">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Latency</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body2">@(_health.PayPal.LatencyMs.HasValue ? $"{_health.PayPal.LatencyMs}ms" : "-")</RadzenText>
                        </RadzenColumn>
                    </RadzenRow>
                </RadzenCard>
            </RadzenColumn>
        }

        @* Stripe *@
        @if (_health.Stripe != null)
        {
            <RadzenColumn Size="12" SizeSM="6" SizeMD="4">
                <RadzenCard>
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-3">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                            <RadzenIcon Icon="credit_card" Style="@($"color: {(_health.Stripe.IsHealthy ? "var(--rz-success)" : "var(--rz-danger)")};")" />
                            <RadzenText TextStyle="TextStyle.H6">Stripe</RadzenText>
                        </RadzenStack>
                        <RadzenBadge BadgeStyle="@(_health.Stripe.IsHealthy ? BadgeStyle.Success : BadgeStyle.Danger)"
                                     Text="@(_health.Stripe.IsHealthy ? "Healthy" : "Error")" />
                    </RadzenStack>
                    <hr class="rz-mb-3" />
                    <RadzenRow>
                        <RadzenColumn Size="6">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Status</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body2">@(_health.Stripe.IsHealthy ? "Connected" : "Disconnected")</RadzenText>
                        </RadzenColumn>
                        <RadzenColumn Size="6">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Latency</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body2">@(_health.Stripe.LatencyMs.HasValue ? $"{_health.Stripe.LatencyMs}ms" : "-")</RadzenText>
                        </RadzenColumn>
                    </RadzenRow>
                </RadzenCard>
            </RadzenColumn>
        }
    </RadzenRow>

    @* Server Info *@
    <RadzenCard class="rz-mt-4">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-4">
            <RadzenIcon Icon="info" />
            <RadzenText TextStyle="TextStyle.H6">Server Information</RadzenText>
        </RadzenStack>
        <RadzenRow>
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Server Time (UTC)</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1">@_health.ServerTime.ToString("yyyy-MM-dd HH:mm:ss")</RadzenText>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Uptime</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1">@FormatUptime(_health.Uptime)</RadzenText>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeMD="4">
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Last Check</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1">@DateTime.Now.ToString("HH:mm:ss")</RadzenText>
            </RadzenColumn>
        </RadzenRow>
    </RadzenCard>
}

@code {
    private bool _isLoading = true;
    private SystemHealthDto? _health;

    protected override async Task OnInitializedAsync()
    {
        await LoadHealthAsync();
    }

    private async Task LoadHealthAsync()
    {
        _isLoading = true;
        try
        {
            _health = await AdminService.GetHealthAsync();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private static string FormatUptime(TimeSpan uptime)
    {
        if (uptime.TotalDays >= 1)
            return $"{(int)uptime.TotalDays}d {uptime.Hours}h {uptime.Minutes}m";
        if (uptime.TotalHours >= 1)
            return $"{(int)uptime.TotalHours}h {uptime.Minutes}m";
        return $"{uptime.Minutes}m {uptime.Seconds}s";
    }
}
