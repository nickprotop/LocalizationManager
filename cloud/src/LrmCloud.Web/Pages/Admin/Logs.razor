@page "/admin/logs"
@using LrmCloud.Shared.DTOs.Admin
@using LrmCloud.Web.Services
@inject AdminService AdminService
@attribute [Authorize]

<PageTitle>Logs - LRM Cloud Admin</PageTitle>

<RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-2">
    <RadzenIcon Icon="article" />
    <RadzenText TextStyle="TextStyle.H4">Application Logs</RadzenText>
</RadzenStack>
<RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary rz-mb-4">
    View and filter application logs for debugging and monitoring.
</RadzenText>

@* Filters *@
<RadzenCard class="rz-mb-4">
    <RadzenRow Gap="1rem" AlignItems="Radzen.AlignItems.End">
        <RadzenColumn Size="12" SizeMD="3">
            <RadzenFormField Text="Log Level" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                <ChildContent>
                    <RadzenDropDown @bind-Value="_levelFilter" AllowClear="true" Placeholder="All Levels" Style="width: 100%;"
                                    Data="@_levelOptions" TextProperty="Text" ValueProperty="Value" />
                </ChildContent>
            </RadzenFormField>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="5">
            <RadzenFormField Text="Search" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                <ChildContent>
                    <RadzenTextBox @bind-Value="_search" Placeholder="Search in log messages..." Style="width: 100%;" />
                </ChildContent>
            </RadzenFormField>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="2">
            <RadzenFormField Text="From Date" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                <ChildContent>
                    <RadzenDatePicker @bind-Value="_fromDate" DateFormat="yyyy-MM-dd" Style="width: 100%;" />
                </ChildContent>
            </RadzenFormField>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="2">
            <RadzenFormField Text="To Date" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                <ChildContent>
                    <RadzenDatePicker @bind-Value="_toDate" DateFormat="yyyy-MM-dd" Style="width: 100%;" />
                </ChildContent>
            </RadzenFormField>
        </RadzenColumn>
    </RadzenRow>
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" class="rz-mt-2">
        <RadzenButton ButtonStyle="ButtonStyle.Primary" Icon="search" Text="Search" Click="LoadLogsAsync" />
    </RadzenStack>
</RadzenCard>

@if (_isLoading)
{
    <RadzenProgressBar Value="100" Mode="ProgressBarMode.Indeterminate" ShowValue="false" />
}
else if (_logs == null || _logs.Count == 0)
{
    <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false">No logs found matching the criteria.</RadzenAlert>
}
else
{
    <RadzenCard Style="max-height: calc(100vh - 400px); overflow: auto;">
        <RadzenDataGrid TItem="LogEntryDto" Data="@_logs" Density="Density.Compact" AllowSorting="false">
            <Columns>
                <RadzenDataGridColumn TItem="LogEntryDto" Title="Timestamp" Width="180px">
                    <Template Context="log">
                        <RadzenText TextStyle="TextStyle.Caption" Style="font-family: monospace;">
                            @log.Timestamp.ToString("yyyy-MM-dd HH:mm:ss.fff")
                        </RadzenText>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="LogEntryDto" Title="Level" Width="80px">
                    <Template Context="log">
                        <RadzenBadge BadgeStyle="@GetLevelBadgeStyle(log.Level)" Text="@log.Level" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="LogEntryDto" Title="Message">
                    <Template Context="log">
                        <RadzenText TextStyle="TextStyle.Body2" Style="font-family: monospace; word-break: break-word;">
                            @log.Message
                        </RadzenText>
                        @if (!string.IsNullOrEmpty(log.Exception))
                        {
                            <details style="margin-top: 0.5rem;">
                                <summary style="cursor: pointer; color: var(--rz-danger);">Exception Details</summary>
                                <pre style="font-size: 0.75rem; overflow: auto; white-space: pre-wrap; margin: 0.5rem 0 0 0; padding: 0.5rem; background: var(--rz-base-lighter); border-radius: 4px; max-height: 200px;">@log.Exception</pre>
                            </details>
                        }
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    </RadzenCard>

    @* Pagination *@
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mt-2">
        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
            Showing @_logs.Count logs (Page @_page)
        </RadzenText>
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
            <RadzenButton Variant="Radzen.Variant.Outlined" Size="ButtonSize.Small" Text="Previous"
                          Disabled="@(_page <= 1)" Click="PreviousPage" />
            <RadzenButton Variant="Radzen.Variant.Outlined" Size="ButtonSize.Small" Text="Next"
                          Disabled="@(_logs.Count < _pageSize)" Click="NextPage" />
        </RadzenStack>
    </RadzenStack>
}

@code {
    private bool _isLoading = true;
    private List<LogEntryDto>? _logs;
    private string? _levelFilter;
    private string _search = "";
    private DateTime? _fromDate;
    private DateTime? _toDate;
    private int _page = 1;
    private int _pageSize = 100;

    private readonly List<object> _levelOptions = new()
    {
        new { Value = "INF", Text = "Info" },
        new { Value = "WRN", Text = "Warning" },
        new { Value = "ERR", Text = "Error" }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadLogsAsync();
    }

    private async Task LoadLogsAsync()
    {
        _isLoading = true;
        try
        {
            _logs = await AdminService.GetLogsAsync(
                _levelFilter,
                string.IsNullOrWhiteSpace(_search) ? null : _search,
                _fromDate,
                _toDate?.AddDays(1), // Include the entire end day
                _page,
                _pageSize);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task PreviousPage()
    {
        if (_page > 1)
        {
            _page--;
            await LoadLogsAsync();
        }
    }

    private async Task NextPage()
    {
        if (_logs?.Count == _pageSize)
        {
            _page++;
            await LoadLogsAsync();
        }
    }

    private static BadgeStyle GetLevelBadgeStyle(string level) => level.ToUpper() switch
    {
        "ERR" or "ERROR" or "FTL" or "FATAL" => BadgeStyle.Danger,
        "WRN" or "WARNING" or "WARN" => BadgeStyle.Warning,
        "INF" or "INFO" => BadgeStyle.Info,
        "DBG" or "DEBUG" => BadgeStyle.Light,
        "VRB" or "VERBOSE" => BadgeStyle.Secondary,
        _ => BadgeStyle.Light
    };
}
