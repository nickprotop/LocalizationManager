@page "/admin/users/{UserId:int}"
@using LrmCloud.Shared.DTOs.Admin
@using LrmCloud.Web.Services
@using LrmCloud.Web.Helpers
@inject AdminService AdminService
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService
@attribute [Authorize]

<PageTitle>User Details - LRM Cloud Admin</PageTitle>

<RadzenBreadCrumb class="rz-mb-4">
    <RadzenBreadCrumbItem Path="admin" Text="Admin" />
    <RadzenBreadCrumbItem Path="admin/users" Text="Users" />
    <RadzenBreadCrumbItem Text="User Details" />
</RadzenBreadCrumb>

@if (_isLoading)
{
    <RadzenProgressBar Value="100" Mode="ProgressBarMode.Indeterminate" ShowValue="false" />
}
else if (_user == null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" AllowClose="false">User not found.</RadzenAlert>
}
else
{
    <RadzenRow Gap="1rem">
        @* User Profile Card *@
        <RadzenColumn Size="12" SizeMD="4">
            <RadzenCard>
                <RadzenStack AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                    @if (!string.IsNullOrEmpty(_user.AvatarUrl))
                    {
                        <RadzenImage Path="@_user.AvatarUrl" Style="width: 80px; height: 80px; border-radius: 50%;" />
                    }
                    else
                    {
                        <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--rz-primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold;">
                            @_user.Email[0].ToString().ToUpper()
                        </div>
                    }
                    <RadzenText TextStyle="TextStyle.H5">@(_user.DisplayName ?? _user.Username)</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">@_user.Email</RadzenText>
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.25rem" class="rz-mt-2">
                        <RadzenBadge BadgeStyle="@GetPlanBadgeStyle(_user.Plan)" Text="@_user.Plan.ToUpper()" />
                        @if (_user.IsSuperAdmin)
                        {
                            <RadzenBadge BadgeStyle="BadgeStyle.Warning" Text="Superadmin" />
                        }
                        @if (_user.EmailVerified)
                        {
                            <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Verified" />
                        }
                    </RadzenStack>
                </RadzenStack>
                <hr class="rz-my-4" />
                <RadzenStack Gap="0.5rem">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="@GetAuthTypeIcon(_user.AuthType)" Style="font-size: 1rem;" />
                        <RadzenText>Auth: @_user.AuthType</RadzenText>
                    </RadzenStack>
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="date_range" Style="font-size: 1rem;" />
                        <RadzenText>Joined: @_user.CreatedAt.ToString("MMM d, yyyy")</RadzenText>
                    </RadzenStack>
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="login" Style="font-size: 1rem;" />
                        <RadzenText>Last Login: @(_user.LastLoginAt?.ToString("MMM d, yyyy HH:mm") ?? "Never")</RadzenText>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>

        @* Details & Settings *@
        <RadzenColumn Size="12" SizeMD="8">
            <RadzenTabs @bind-SelectedIndex="_selectedTab" RenderMode="TabRenderMode.Client" class="rz-mb-4">
                <Tabs>
                    @* Subscription & Billing Tab *@
                    <RadzenTabsItem Text="Subscription" Icon="credit_card">
                        <RadzenStack Gap="1rem" class="rz-p-4">
                            <RadzenText TextStyle="TextStyle.H6">Subscription Details</RadzenText>
                            <RadzenRow Gap="1rem">
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenFormField Text="Plan" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                                        <ChildContent>
                                            <RadzenDropDown @bind-Value="_editPlan" Style="width: 100%;"
                                                            Data="@(new[] { "free", "team", "enterprise" })" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">User's subscription plan</RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenFormField Text="Subscription Status" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                                        <ChildContent>
                                            <RadzenDropDown @bind-Value="_editSubscriptionStatus" Style="width: 100%;"
                                                            Data="@(new[] { "none", "active", "canceled", "past_due" })" />
                                        </ChildContent>
                                    </RadzenFormField>
                                </RadzenColumn>
                            </RadzenRow>
                            @if (!string.IsNullOrEmpty(_user.PaymentProvider))
                            {
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
                                    Payment Provider: @_user.PaymentProvider
                                    @if (!string.IsNullOrEmpty(_user.PaymentCustomerId))
                                    {
                                        <text> (Customer: @_user.PaymentCustomerId)</text>
                                    }
                                </RadzenText>
                            }
                            @if (_user.SubscriptionCurrentPeriodEnd.HasValue)
                            {
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                                    <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
                                        Current Period Ends: @_user.SubscriptionCurrentPeriodEnd.Value.ToString("MMM d, yyyy")
                                    </RadzenText>
                                    @if (_user.CancelAtPeriodEnd)
                                    {
                                        <RadzenBadge BadgeStyle="BadgeStyle.Warning" Text="Cancels at end" />
                                    }
                                </RadzenStack>
                            }
                        </RadzenStack>
                    </RadzenTabsItem>

                    @* Usage & Limits Tab *@
                    <RadzenTabsItem Text="Usage" Icon="data_usage">
                        <RadzenStack Gap="1rem" class="rz-p-4">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                                <RadzenText TextStyle="TextStyle.H6">Usage & Limits</RadzenText>
                                <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Warning" Size="ButtonSize.Small"
                                              Icon="refresh" Text="Reset Usage" Click="ResetUsageAsync" />
                            </RadzenStack>
                            <RadzenRow Gap="1rem">
                                @* LRM Translation *@
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-2">LRM Translation</RadzenText>
                                    <RadzenProgressBar Value="@GetUsagePercent(_user.TranslationCharsUsed, _user.TranslationCharsLimit)"
                                                       ProgressBarStyle="@GetUsageProgressStyle(_user.TranslationCharsUsed, _user.TranslationCharsLimit)"
                                                       ShowValue="false" Style="height: 8px;" class="rz-mb-1" />
                                    <RadzenText TextStyle="TextStyle.Caption">
                                        @_user.TranslationCharsUsed.ToString("N0") / @_user.TranslationCharsLimit.ToString("N0") chars
                                    </RadzenText>
                                    <RadzenFormField Text="Limit Override" Variant="Radzen.Variant.Outlined" Style="width: 100%;" class="rz-mt-2">
                                        <ChildContent>
                                            <RadzenNumeric @bind-Value="_editTranslationLimit" Style="width: 100%;" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Set custom limit (0 = use plan default)</RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                </RadzenColumn>
                                @* Other Providers *@
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-2">Other Providers</RadzenText>
                                    <RadzenProgressBar Value="@GetUsagePercent(_user.OtherCharsUsed, _user.OtherCharsLimit)"
                                                       ProgressBarStyle="@GetUsageProgressStyle(_user.OtherCharsUsed, _user.OtherCharsLimit)"
                                                       ShowValue="false" Style="height: 8px;" class="rz-mb-1" />
                                    <RadzenText TextStyle="TextStyle.Caption">
                                        @_user.OtherCharsUsed.ToString("N0") / @_user.OtherCharsLimit.ToString("N0") chars
                                    </RadzenText>
                                    <RadzenFormField Text="Limit Override" Variant="Radzen.Variant.Outlined" Style="width: 100%;" class="rz-mt-2">
                                        <ChildContent>
                                            <RadzenNumeric @bind-Value="_editOtherLimit" Style="width: 100%;" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Set custom limit (0 = use plan default)</RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                </RadzenColumn>
                            </RadzenRow>
                            @if (_user.TranslationCharsResetAt.HasValue)
                            {
                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                    Usage resets: @_user.TranslationCharsResetAt.Value.ToString("MMM d, yyyy")
                                </RadzenText>
                            }
                        </RadzenStack>
                    </RadzenTabsItem>

                    @* Security Tab *@
                    <RadzenTabsItem Text="Security" Icon="security">
                        <RadzenStack Gap="1rem" class="rz-p-4">
                            <RadzenText TextStyle="TextStyle.H6">Security Settings</RadzenText>
                            <RadzenRow Gap="1rem">
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                                        <RadzenText>Superadmin Access</RadzenText>
                                        <RadzenSwitch @bind-Value="_editIsSuperAdmin" />
                                    </RadzenStack>
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                        Grant full administrative access to the system
                                    </RadzenText>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                                        <RadzenText>Email Verified</RadzenText>
                                        <RadzenSwitch @bind-Value="_editEmailVerified" />
                                    </RadzenStack>
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                        Mark user's email as verified
                                    </RadzenText>
                                </RadzenColumn>
                            </RadzenRow>
                            <hr />
                            <RadzenText TextStyle="TextStyle.Subtitle2">Login Security</RadzenText>
                            <RadzenStack Gap="0.5rem">
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                                    <RadzenIcon Icon="warning" Style="font-size: 1rem;" />
                                    <RadzenText>Failed Login Attempts: @_user.FailedLoginAttempts</RadzenText>
                                </RadzenStack>
                                @if (_user.LockedUntil.HasValue && _user.LockedUntil > DateTime.UtcNow)
                                {
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                                        <RadzenIcon Icon="lock" Style="font-size: 1rem;" />
                                        <RadzenText>Locked Until: @_user.LockedUntil.Value.ToString("MMM d, yyyy HH:mm")</RadzenText>
                                    </RadzenStack>
                                }
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenTabsItem>

                    @* Stats Tab *@
                    <RadzenTabsItem Text="Stats" Icon="bar_chart">
                        <RadzenStack Gap="1rem" class="rz-p-4">
                            <RadzenText TextStyle="TextStyle.H6">Account Statistics</RadzenText>
                            <RadzenRow>
                                <RadzenColumn Size="6" SizeMD="3">
                                    <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Projects</RadzenText>
                                    <RadzenText TextStyle="TextStyle.H4">@_user.ProjectCount</RadzenText>
                                </RadzenColumn>
                                <RadzenColumn Size="6" SizeMD="3">
                                    <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Organizations</RadzenText>
                                    <RadzenText TextStyle="TextStyle.H4">@_user.OrganizationCount</RadzenText>
                                </RadzenColumn>
                            </RadzenRow>
                        </RadzenStack>
                    </RadzenTabsItem>
                </Tabs>
            </RadzenTabs>

            @* Action Buttons *@
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenButton Variant="Radzen.Variant.Outlined" Text="Cancel"
                                  Click="@(() => Navigation.NavigateTo("admin/users"))" />
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
                        @if (_user.DeletedAt == null)
                        {
                            <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Danger"
                                          Icon="delete" Text="Delete User" Click="DeleteUserAsync" />
                        }
                        <RadzenButton ButtonStyle="ButtonStyle.Primary" Icon="save"
                                      Text="@(_isSaving ? "Saving..." : "Save Changes")"
                                      Click="SaveChangesAsync" Disabled="_isSaving" IsBusy="_isSaving" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>
}

@code {
    [Parameter]
    public int UserId { get; set; }

    private bool _isLoading = true;
    private bool _isSaving;
    private AdminUserDetailDto? _user;
    private int _selectedTab;

    // Edit fields
    private string _editPlan = "free";
    private string _editSubscriptionStatus = "none";
    private int _editTranslationLimit;
    private long _editOtherLimit;
    private bool _editIsSuperAdmin;
    private bool _editEmailVerified;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserAsync();
    }

    private async Task LoadUserAsync()
    {
        _isLoading = true;
        try
        {
            _user = await AdminService.GetUserAsync(UserId);
            if (_user != null)
            {
                _editPlan = _user.Plan;
                _editSubscriptionStatus = _user.SubscriptionStatus ?? "none";
                _editTranslationLimit = _user.TranslationCharsLimit;
                _editOtherLimit = _user.OtherCharsLimit;
                _editIsSuperAdmin = _user.IsSuperAdmin;
                _editEmailVerified = _user.EmailVerified;
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SaveChangesAsync()
    {
        _isSaving = true;
        try
        {
            var dto = new AdminUpdateUserDto
            {
                Plan = _editPlan,
                SubscriptionStatus = _editSubscriptionStatus,
                TranslationCharsLimit = _editTranslationLimit,
                OtherCharsLimit = _editOtherLimit,
                IsSuperAdmin = _editIsSuperAdmin,
                EmailVerified = _editEmailVerified
            };

            var (success, error, updatedUser) = await AdminService.UpdateUserAsync(UserId, dto);
            if (success && updatedUser != null)
            {
                _user = updatedUser;
                NotificationService.Notify(NotificationSeverity.Success, "Success", "User updated successfully");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to update user: {error}");
            }
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task ResetUsageAsync()
    {
        var confirmed = await DialogService.Confirm(
            "Are you sure you want to reset this user's usage counters? This action cannot be undone.",
            "Reset Usage",
            new ConfirmOptions { OkButtonText = "Reset", CancelButtonText = "Cancel" });

        if (confirmed == true)
        {
            var (success, error, updatedUser) = await AdminService.ResetUserUsageAsync(UserId);
            if (success && updatedUser != null)
            {
                _user = updatedUser;
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Usage counters reset successfully");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to reset usage: {error}");
            }
        }
    }

    private async Task DeleteUserAsync()
    {
        var confirmed = await DialogService.Confirm(
            "Are you sure you want to delete this user? This action will soft-delete the user.",
            "Delete User",
            new ConfirmOptions { OkButtonText = "Delete", CancelButtonText = "Cancel" });

        if (confirmed == true)
        {
            var (success, error) = await AdminService.DeleteUserAsync(UserId);
            if (success)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Deleted", "User deleted successfully");
                Navigation.NavigateTo("admin/users");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to delete user: {error}");
            }
        }
    }

    private static BadgeStyle GetPlanBadgeStyle(string plan) => plan.ToLower() switch
    {
        "enterprise" => BadgeStyle.Success,
        "team" => BadgeStyle.Primary,
        _ => BadgeStyle.Light
    };

    private static string GetAuthTypeIcon(string authType) => authType.ToLower() switch
    {
        "github" => "code",
        _ => "email"
    };

    private static double GetUsagePercent(long used, long limit) =>
        limit > 0 ? Math.Min(100, used * 100.0 / limit) : 0;

    private static ProgressBarStyle GetUsageProgressStyle(long used, long limit)
    {
        var percent = GetUsagePercent(used, limit);
        return percent switch
        {
            >= 90 => ProgressBarStyle.Danger,
            >= 75 => ProgressBarStyle.Warning,
            _ => ProgressBarStyle.Primary
        };
    }
}
