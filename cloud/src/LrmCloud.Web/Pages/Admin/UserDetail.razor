@page "/admin/users/{UserId:int}"
@using LrmCloud.Shared.DTOs.Admin
@using LrmCloud.Web.Services
@inject AdminService AdminService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@attribute [Authorize]

<PageTitle>User Details - LRM Cloud Admin</PageTitle>

<MudBreadcrumbs Items="_breadcrumbs" Class="mb-4" />

@if (_isLoading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
}
else if (_user == null)
{
    <MudAlert Severity="Severity.Error">User not found.</MudAlert>
}
else
{
    <MudGrid>
        @* User Profile Card *@
        <MudItem xs="12" md="4">
            <MudPaper Class="pa-4" Elevation="2">
                <div class="d-flex flex-column align-center">
                    <MudAvatar Size="Size.Large" Class="mb-2" Style="width: 80px; height: 80px;">
                        @if (!string.IsNullOrEmpty(_user.AvatarUrl))
                        {
                            <MudImage Src="@_user.AvatarUrl" />
                        }
                        else
                        {
                            @_user.Email[0].ToString().ToUpper()
                        }
                    </MudAvatar>
                    <MudText Typo="Typo.h5">@(_user.DisplayName ?? _user.Username)</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">@_user.Email</MudText>
                    <div class="mt-2 d-flex gap-1">
                        <MudChip T="string" Size="Size.Small" Color="@GetPlanColor(_user.Plan)">@_user.Plan.ToUpper()</MudChip>
                        @if (_user.IsSuperAdmin)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning" Icon="@Icons.Material.Filled.Star">Superadmin</MudChip>
                        }
                        @if (_user.EmailVerified)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Success">Verified</MudChip>
                        }
                    </div>
                </div>
                <MudDivider Class="my-4" />
                <MudList T="string" Dense="true">
                    <MudListItem T="string" Icon="@GetAuthTypeIcon(_user.AuthType)">
                        Auth: @_user.AuthType
                    </MudListItem>
                    <MudListItem T="string" Icon="@Icons.Material.Filled.DateRange">
                        Joined: @_user.CreatedAt.ToString("MMM d, yyyy")
                    </MudListItem>
                    <MudListItem T="string" Icon="@Icons.Material.Filled.Login">
                        Last Login: @(_user.LastLoginAt?.ToString("MMM d, yyyy HH:mm") ?? "Never")
                    </MudListItem>
                </MudList>
            </MudPaper>
        </MudItem>

        @* Details & Settings *@
        <MudItem xs="12" md="8">
            <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" Class="mb-4">
                @* Subscription & Billing Tab *@
                <MudTabPanel Text="Subscription" Icon="@Icons.Material.Filled.CreditCard">
                    <MudPaper Class="pa-4" Elevation="0">
                        <MudText Typo="Typo.h6" Class="mb-4">Subscription Details</MudText>
                        <MudGrid>
                            <MudItem xs="12" md="6">
                                <MudSelect T="string" @bind-Value="_editPlan" Label="Plan" HelperText="User's subscription plan">
                                    <MudSelectItem Value="@("free")">Free</MudSelectItem>
                                    <MudSelectItem Value="@("team")">Team</MudSelectItem>
                                    <MudSelectItem Value="@("enterprise")">Enterprise</MudSelectItem>
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudSelect T="string" @bind-Value="_editSubscriptionStatus" Label="Subscription Status">
                                    <MudSelectItem Value="@("none")">None</MudSelectItem>
                                    <MudSelectItem Value="@("active")">Active</MudSelectItem>
                                    <MudSelectItem Value="@("canceled")">Canceled</MudSelectItem>
                                    <MudSelectItem Value="@("past_due")">Past Due</MudSelectItem>
                                </MudSelect>
                            </MudItem>
                        </MudGrid>
                        @if (!string.IsNullOrEmpty(_user.PaymentProvider))
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-4">
                                Payment Provider: @_user.PaymentProvider
                                @if (!string.IsNullOrEmpty(_user.PaymentCustomerId))
                                {
                                    <text> (Customer: @_user.PaymentCustomerId)</text>
                                }
                            </MudText>
                        }
                        @if (_user.SubscriptionCurrentPeriodEnd.HasValue)
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Current Period Ends: @_user.SubscriptionCurrentPeriodEnd.Value.ToString("MMM d, yyyy")
                                @if (_user.CancelAtPeriodEnd)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Warning" Class="ml-2">Cancels at end</MudChip>
                                }
                            </MudText>
                        }
                    </MudPaper>
                </MudTabPanel>

                @* Usage & Limits Tab *@
                <MudTabPanel Text="Usage" Icon="@Icons.Material.Filled.DataUsage">
                    <MudPaper Class="pa-4" Elevation="0">
                        <div class="d-flex justify-space-between align-center mb-4">
                            <MudText Typo="Typo.h6">Usage & Limits</MudText>
                            <MudButton Variant="Variant.Outlined" Color="Color.Warning" Size="Size.Small"
                                       StartIcon="@Icons.Material.Filled.Refresh" OnClick="ResetUsageAsync">
                                Reset Usage
                            </MudButton>
                        </div>
                        <MudGrid>
                            @* LRM Translation *@
                            <MudItem xs="12" md="6">
                                <MudText Typo="Typo.subtitle2" Class="mb-2">LRM Translation</MudText>
                                <MudProgressLinear Value="@GetUsagePercent(_user.TranslationCharsUsed, _user.TranslationCharsLimit)"
                                                  Color="@GetUsageColor(_user.TranslationCharsUsed, _user.TranslationCharsLimit)"
                                                  Size="Size.Medium" Rounded="true" Class="mb-1" />
                                <MudText Typo="Typo.caption">
                                    @_user.TranslationCharsUsed.ToString("N0") / @_user.TranslationCharsLimit.ToString("N0") chars
                                </MudText>
                                <MudNumericField T="int" @bind-Value="_editTranslationLimit" Label="Limit Override" Class="mt-2"
                                                HelperText="Set custom limit (0 = use plan default)" />
                            </MudItem>
                            @* Other Providers *@
                            <MudItem xs="12" md="6">
                                <MudText Typo="Typo.subtitle2" Class="mb-2">Other Providers</MudText>
                                <MudProgressLinear Value="@GetUsagePercent(_user.OtherCharsUsed, _user.OtherCharsLimit)"
                                                  Color="@GetUsageColor(_user.OtherCharsUsed, _user.OtherCharsLimit)"
                                                  Size="Size.Medium" Rounded="true" Class="mb-1" />
                                <MudText Typo="Typo.caption">
                                    @_user.OtherCharsUsed.ToString("N0") / @_user.OtherCharsLimit.ToString("N0") chars
                                </MudText>
                                <MudNumericField T="long" @bind-Value="_editOtherLimit" Label="Limit Override" Class="mt-2"
                                                HelperText="Set custom limit (0 = use plan default)" />
                            </MudItem>
                        </MudGrid>
                        @if (_user.TranslationCharsResetAt.HasValue)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
                                Usage resets: @_user.TranslationCharsResetAt.Value.ToString("MMM d, yyyy")
                            </MudText>
                        }
                    </MudPaper>
                </MudTabPanel>

                @* Security Tab *@
                <MudTabPanel Text="Security" Icon="@Icons.Material.Filled.Security">
                    <MudPaper Class="pa-4" Elevation="0">
                        <MudText Typo="Typo.h6" Class="mb-4">Security Settings</MudText>
                        <MudGrid>
                            <MudItem xs="12" md="6">
                                <MudSwitch T="bool" @bind-Value="_editIsSuperAdmin" Color="Color.Warning" Label="Superadmin Access" />
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    Grant full administrative access to the system
                                </MudText>
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudSwitch T="bool" @bind-Value="_editEmailVerified" Color="Color.Success" Label="Email Verified" />
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    Mark user's email as verified
                                </MudText>
                            </MudItem>
                        </MudGrid>
                        <MudDivider Class="my-4" />
                        <MudText Typo="Typo.subtitle2" Class="mb-2">Login Security</MudText>
                        <MudList T="string" Dense="true">
                            <MudListItem T="string" Icon="@Icons.Material.Filled.Warning">
                                Failed Login Attempts: @_user.FailedLoginAttempts
                            </MudListItem>
                            @if (_user.LockedUntil.HasValue && _user.LockedUntil > DateTime.UtcNow)
                            {
                                <MudListItem T="string" Icon="@Icons.Material.Filled.Lock">
                                    Locked Until: @_user.LockedUntil.Value.ToString("MMM d, yyyy HH:mm")
                                </MudListItem>
                            }
                        </MudList>
                    </MudPaper>
                </MudTabPanel>

                @* Stats Tab *@
                <MudTabPanel Text="Stats" Icon="@Icons.Material.Filled.BarChart">
                    <MudPaper Class="pa-4" Elevation="0">
                        <MudText Typo="Typo.h6" Class="mb-4">Account Statistics</MudText>
                        <MudGrid>
                            <MudItem xs="6" md="3">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Projects</MudText>
                                <MudText Typo="Typo.h4">@_user.ProjectCount</MudText>
                            </MudItem>
                            <MudItem xs="6" md="3">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Organizations</MudText>
                                <MudText Typo="Typo.h4">@_user.OrganizationCount</MudText>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                </MudTabPanel>
            </MudTabs>

            @* Action Buttons *@
            <MudPaper Class="pa-4" Elevation="2">
                <div class="d-flex justify-space-between">
                    <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="@(() => Navigation.NavigateTo("admin/users"))">
                        Cancel
                    </MudButton>
                    <div class="d-flex gap-2">
                        @if (_user.DeletedAt == null)
                        {
                            <MudButton Variant="Variant.Outlined" Color="Color.Error" StartIcon="@Icons.Material.Filled.Delete"
                                       OnClick="DeleteUserAsync">
                                Delete User
                            </MudButton>
                        }
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save"
                                   OnClick="SaveChangesAsync" Disabled="@_isSaving">
                            @if (_isSaving)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            }
                            Save Changes
                        </MudButton>
                    </div>
                </div>
            </MudPaper>
        </MudItem>
    </MudGrid>
}

@code {
    [Parameter]
    public int UserId { get; set; }

    private bool _isLoading = true;
    private bool _isSaving;
    private AdminUserDetailDto? _user;

    // Edit fields
    private string _editPlan = "free";
    private string _editSubscriptionStatus = "none";
    private int _editTranslationLimit;
    private long _editOtherLimit;
    private bool _editIsSuperAdmin;
    private bool _editEmailVerified;

    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Admin", href: "admin"),
        new BreadcrumbItem("Users", href: "admin/users"),
        new BreadcrumbItem("User Details", href: null, disabled: true)
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadUserAsync();
    }

    private async Task LoadUserAsync()
    {
        _isLoading = true;
        try
        {
            _user = await AdminService.GetUserAsync(UserId);
            if (_user != null)
            {
                _editPlan = _user.Plan;
                _editSubscriptionStatus = _user.SubscriptionStatus ?? "none";
                _editTranslationLimit = _user.TranslationCharsLimit;
                _editOtherLimit = _user.OtherCharsLimit;
                _editIsSuperAdmin = _user.IsSuperAdmin;
                _editEmailVerified = _user.EmailVerified;
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task SaveChangesAsync()
    {
        _isSaving = true;
        try
        {
            var dto = new AdminUpdateUserDto
            {
                Plan = _editPlan,
                SubscriptionStatus = _editSubscriptionStatus,
                TranslationCharsLimit = _editTranslationLimit,
                OtherCharsLimit = _editOtherLimit,
                IsSuperAdmin = _editIsSuperAdmin,
                EmailVerified = _editEmailVerified
            };

            var (success, error, updatedUser) = await AdminService.UpdateUserAsync(UserId, dto);
            if (success && updatedUser != null)
            {
                _user = updatedUser;
                Snackbar.Add("User updated successfully", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Failed to update user: {error}", Severity.Error);
            }
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task ResetUsageAsync()
    {
        var result = await DialogService.ShowMessageBox(
            "Reset Usage",
            "Are you sure you want to reset this user's usage counters? This action cannot be undone.",
            yesText: "Reset", cancelText: "Cancel");

        if (result == true)
        {
            var (success, error, updatedUser) = await AdminService.ResetUserUsageAsync(UserId);
            if (success && updatedUser != null)
            {
                _user = updatedUser;
                Snackbar.Add("Usage counters reset successfully", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Failed to reset usage: {error}", Severity.Error);
            }
        }
    }

    private async Task DeleteUserAsync()
    {
        var result = await DialogService.ShowMessageBox(
            "Delete User",
            "Are you sure you want to delete this user? This action will soft-delete the user.",
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            var (success, error) = await AdminService.DeleteUserAsync(UserId);
            if (success)
            {
                Snackbar.Add("User deleted successfully", Severity.Success);
                Navigation.NavigateTo("admin/users");
            }
            else
            {
                Snackbar.Add($"Failed to delete user: {error}", Severity.Error);
            }
        }
    }

    private static Color GetPlanColor(string plan) => plan.ToLower() switch
    {
        "enterprise" => Color.Success,
        "team" => Color.Primary,
        _ => Color.Default
    };

    private static string GetAuthTypeIcon(string authType) => authType.ToLower() switch
    {
        "github" => Icons.Custom.Brands.GitHub,
        _ => Icons.Material.Filled.Email
    };

    private static double GetUsagePercent(long used, long limit) =>
        limit > 0 ? Math.Min(100, used * 100.0 / limit) : 0;

    private static Color GetUsageColor(long used, long limit)
    {
        var percent = GetUsagePercent(used, limit);
        return percent switch
        {
            >= 90 => Color.Error,
            >= 75 => Color.Warning,
            _ => Color.Primary
        };
    }
}
