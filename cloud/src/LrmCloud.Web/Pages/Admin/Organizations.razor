@page "/admin/organizations"
@using LrmCloud.Shared.DTOs.Admin
@using LrmCloud.Web.Services
@inject AdminService AdminService
@inject NavigationManager Navigation
@attribute [Authorize]

<PageTitle>Organizations - LRM Cloud Admin</PageTitle>

<RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-2">
    <RadzenIcon Icon="business" />
    <RadzenText TextStyle="TextStyle.H4">Organizations</RadzenText>
</RadzenStack>
<RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary rz-mb-4">
    View all organizations and their details.
</RadzenText>

@* Search *@
<RadzenCard class="rz-mb-4">
    <RadzenRow Gap="1rem" AlignItems="Radzen.AlignItems.End">
        <RadzenColumn Size="12" SizeMD="10">
            <RadzenFormField Text="Search" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                <ChildContent>
                    <RadzenTextBox @bind-Value="_search" Placeholder="Search by name or slug..."
                                   @oninput="OnSearchInput" Style="width: 100%;" />
                </ChildContent>
            </RadzenFormField>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="2">
            <RadzenButton Variant="Radzen.Variant.Outlined" Icon="refresh" Text="Refresh"
                          Click="LoadOrganizationsAsync" />
        </RadzenColumn>
    </RadzenRow>
</RadzenCard>

@if (_isLoading)
{
    <RadzenProgressBar Value="100" Mode="ProgressBarMode.Indeterminate" ShowValue="false" />
}
else if (_orgs == null || _orgs.Count == 0)
{
    <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false">No organizations found.</RadzenAlert>
}
else
{
    <RadzenDataGrid TItem="AdminOrganizationDto" Data="@_orgs" Density="Density.Compact" AllowSorting="false">
        <Columns>
            <RadzenDataGridColumn TItem="AdminOrganizationDto" Title="Organization">
                <Template Context="org">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                        <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--rz-primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                            @org.Name[0].ToString().ToUpper()
                        </div>
                        <RadzenStack Gap="0">
                            <RadzenText TextStyle="TextStyle.Body2">@org.Name</RadzenText>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">@org.Slug</RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="AdminOrganizationDto" Title="Owner">
                <Template Context="org">
                    <RadzenText TextStyle="TextStyle.Body2">@org.OwnerEmail</RadzenText>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="AdminOrganizationDto" Title="Members" Width="100px">
                <Template Context="org">
                    <RadzenBadge BadgeStyle="BadgeStyle.Primary" Text="@org.MemberCount.ToString()" />
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="AdminOrganizationDto" Title="Projects" Width="100px">
                <Template Context="org">
                    <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@org.ProjectCount.ToString()" />
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="AdminOrganizationDto" Title="Created" Width="120px">
                <Template Context="org">
                    <RadzenText TextStyle="TextStyle.Body2">@org.CreatedAt.ToString("MMM d, yyyy")</RadzenText>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="AdminOrganizationDto" Title="Actions" Width="80px" TextAlign="TextAlign.Center">
                <Template Context="org">
                    <RadzenButton Icon="visibility" Variant="Radzen.Variant.Text" Size="ButtonSize.Small"
                                  Click="@(() => ViewOrganization(org.Id))" />
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>

    @* Pagination Info *@
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mt-2">
        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
            Showing @_orgs.Count of @_totalCount organizations (Page @_page)
        </RadzenText>
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
            <RadzenButton Variant="Radzen.Variant.Outlined" Size="ButtonSize.Small" Text="Previous"
                          Disabled="@(_page <= 1)" Click="PreviousPage" />
            <RadzenButton Variant="Radzen.Variant.Outlined" Size="ButtonSize.Small" Text="Next"
                          Disabled="@(_orgs.Count < _pageSize)" Click="NextPage" />
        </RadzenStack>
    </RadzenStack>
}

@code {
    private bool _isLoading = true;
    private List<AdminOrganizationDto>? _orgs;
    private int _totalCount;
    private string _search = "";
    private int _page = 1;
    private int _pageSize = 20;

    private System.Timers.Timer? _debounceTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrganizationsAsync();
    }

    private async Task LoadOrganizationsAsync()
    {
        _isLoading = true;
        try
        {
            var (orgs, totalCount) = await AdminService.GetOrganizationsAsync(_search, _page, _pageSize);
            _orgs = orgs;
            _totalCount = totalCount;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        _search = e.Value?.ToString() ?? "";
        _debounceTimer?.Stop();
        _debounceTimer?.Dispose();
        _debounceTimer = new System.Timers.Timer(300);
        _debounceTimer.Elapsed += async (s, ev) =>
        {
            _debounceTimer?.Stop();
            await InvokeAsync(async () =>
            {
                _page = 1;
                await LoadOrganizationsAsync();
                StateHasChanged();
            });
        };
        _debounceTimer.Start();
    }

    private async Task PreviousPage()
    {
        if (_page > 1)
        {
            _page--;
            await LoadOrganizationsAsync();
        }
    }

    private async Task NextPage()
    {
        if (_orgs?.Count == _pageSize)
        {
            _page++;
            await LoadOrganizationsAsync();
        }
    }

    private void ViewOrganization(int orgId)
    {
        Navigation.NavigateTo($"admin/organizations/{orgId}");
    }
}
