@page "/admin"
@using LrmCloud.Shared.DTOs.Admin
@using LrmCloud.Web.Services
@using LrmCloud.Web.Helpers
@inject AdminService AdminService
@inject NavigationManager Navigation
@attribute [Authorize]

<PageTitle>Admin Dashboard - LRM Cloud</PageTitle>

<RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-2">
    <RadzenIcon Icon="admin_panel_settings" />
    <RadzenText TextStyle="TextStyle.H4">Admin Dashboard</RadzenText>
</RadzenStack>
<RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary rz-mb-4">
    System-wide statistics, health monitoring, and user management.
</RadzenText>

@if (_isLoading)
{
    <RadzenProgressBar Value="100" Mode="ProgressBarMode.Indeterminate" ShowValue="false" />
}
else
{
    @* Stats Cards - Row 1 *@
    <RadzenRow Gap="1rem" class="rz-mb-4">
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.75rem">
                    <RadzenIcon Icon="people" Style="font-size: 2rem; color: var(--rz-primary);" />
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.H4">@(_stats?.TotalUsers.ToString("N0") ?? "-")</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Total Users</RadzenText>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.75rem">
                    <RadzenIcon Icon="credit_card" Style="font-size: 2rem; color: var(--rz-success);" />
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.H4">@(_stats?.PaidUsers.ToString("N0") ?? "-")</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Active Subscribers</RadzenText>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.75rem">
                    <RadzenIcon Icon="folder" Style="font-size: 2rem; color: var(--rz-info);" />
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.H4">@(_stats?.TotalProjects.ToString("N0") ?? "-")</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Projects</RadzenText>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.75rem">
                    <RadzenIcon Icon="business" Style="font-size: 2rem; color: var(--rz-warning);" />
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.H4">@(_stats?.TotalOrganizations.ToString("N0") ?? "-")</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Organizations</RadzenText>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    @* Stats Cards - Row 2 (MRR) *@
    <RadzenRow Gap="1rem" class="rz-mb-4">
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard Style="cursor: pointer;" @onclick="@(() => Navigation.NavigateTo("admin/analytics"))">
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.75rem">
                    <RadzenIcon Icon="attach_money" Style="font-size: 2rem; color: var(--rz-success);" />
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.H4">$@(_revenue?.CurrentMrr.ToString("N0") ?? "-")</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Monthly Revenue</RadzenText>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard Style="cursor: pointer;" @onclick="@(() => Navigation.NavigateTo("admin/analytics"))">
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.75rem">
                    <RadzenIcon Icon="trending_up" Style="@($"font-size: 2rem; color: {(_userAnalytics?.GrowthRate >= 0 ? "var(--rz-success)" : "var(--rz-danger)")};")" />
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.H4">@((_userAnalytics?.NewUsersThisMonth ?? 0) > 0 ? "+" : "")@(_userAnalytics?.NewUsersThisMonth.ToString("N0") ?? "-")</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">New Users (Month)</RadzenText>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.75rem">
                    <RadzenIcon Icon="translate" Style="font-size: 2rem; color: var(--rz-primary);" />
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.H4">@UiHelpers.FormatNumber(_stats?.TotalTranslationCharsUsed ?? 0)</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">LRM Chars Used</RadzenText>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.75rem">
                    <RadzenIcon Icon="key" Style="font-size: 2rem; color: var(--rz-info);" />
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.H4">@UiHelpers.FormatNumber(_stats?.TotalOtherCharsUsed ?? 0)</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">BYOK Chars Used</RadzenText>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <RadzenRow Gap="1rem">
        @* System Health *@
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-4">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="health_and_safety" />
                        <RadzenText TextStyle="TextStyle.H6">System Health</RadzenText>
                    </RadzenStack>
                    @if (_health != null)
                    {
                        <RadzenBadge BadgeStyle="@(_health.IsHealthy ? BadgeStyle.Success : BadgeStyle.Danger)"
                                     Text="@(_health.IsHealthy ? "Healthy" : "Unhealthy")" />
                    }
                </RadzenStack>
                @if (_health != null)
                {
                    <RadzenDataGrid TItem="HealthItem" Data="@GetHealthItems()" Density="Density.Compact" AllowSorting="false">
                        <Columns>
                            <RadzenDataGridColumn TItem="HealthItem" Title="Service">
                                <Template Context="item">
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                                        <RadzenIcon Icon="@item.Icon" Style="font-size: 1rem;" />
                                        <RadzenText>@item.Name</RadzenText>
                                    </RadzenStack>
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="HealthItem" Title="Status" Width="80px">
                                <Template Context="item">
                                    <RadzenBadge BadgeStyle="@(item.IsHealthy ? BadgeStyle.Success : BadgeStyle.Danger)"
                                                 Text="@(item.IsHealthy ? "OK" : "Error")" />
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="HealthItem" Title="Latency" Width="80px">
                                <Template Context="item">
                                    @(item.LatencyMs.HasValue ? $"{item.LatencyMs}ms" : "-")
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary rz-mt-2">
                        Server Time: @_health.ServerTime.ToString("yyyy-MM-dd HH:mm:ss") UTC
                    </RadzenText>
                }
                else
                {
                    <RadzenAlert AlertStyle="AlertStyle.Warning" Shade="Shade.Lighter" AllowClose="false">Failed to load health status</RadzenAlert>
                }
            </RadzenCard>
        </RadzenColumn>

        @* Users by Plan *@
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-4">
                    <RadzenIcon Icon="pie_chart" />
                    <RadzenText TextStyle="TextStyle.H6">Users by Plan</RadzenText>
                </RadzenStack>
                @if (_stats?.UsersByPlan != null)
                {
                    <RadzenDataGrid TItem="PlanStat" Data="@GetPlanStats()" Density="Density.Compact" AllowSorting="false">
                        <Columns>
                            <RadzenDataGridColumn TItem="PlanStat" Title="Plan">
                                <Template Context="item">
                                    <RadzenBadge BadgeStyle="@GetPlanBadgeStyle(item.Plan)" Text="@item.Plan.ToUpper()" />
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="PlanStat" Property="Count" Title="Users" Width="80px" />
                            <RadzenDataGridColumn TItem="PlanStat" Title="%" Width="80px">
                                <Template Context="item">@item.Percent.ToString("F1")%</Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                }
                else
                {
                    <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false">No data available</RadzenAlert>
                }
            </RadzenCard>
        </RadzenColumn>

        @* Usage Summary *@
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-4">
                    <RadzenIcon Icon="data_usage" />
                    <RadzenText TextStyle="TextStyle.H6">Total Usage</RadzenText>
                </RadzenStack>
                @if (_stats != null)
                {
                    <RadzenRow>
                        <RadzenColumn Size="6">
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">LRM Translation Chars</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5">@UiHelpers.FormatBytes(_stats.TotalTranslationCharsUsed)</RadzenText>
                        </RadzenColumn>
                        <RadzenColumn Size="6">
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Other Provider Chars</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5">@UiHelpers.FormatBytes(_stats.TotalOtherCharsUsed)</RadzenText>
                        </RadzenColumn>
                        <RadzenColumn Size="6">
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Database Size</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5">@UiHelpers.FormatBytes(_stats.DatabaseSizeBytes)</RadzenText>
                        </RadzenColumn>
                        <RadzenColumn Size="6">
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Storage Size</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5">@UiHelpers.FormatBytes(_stats.StorageSizeBytes)</RadzenText>
                        </RadzenColumn>
                    </RadzenRow>
                }
            </RadzenCard>
        </RadzenColumn>

        @* Users by Auth Type *@
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-4">
                    <RadzenIcon Icon="security" />
                    <RadzenText TextStyle="TextStyle.H6">Users by Auth Type</RadzenText>
                </RadzenStack>
                @if (_stats?.UsersByAuthType != null)
                {
                    <RadzenDataGrid TItem="AuthTypeStat" Data="@GetAuthTypeStats()" Density="Density.Compact" AllowSorting="false">
                        <Columns>
                            <RadzenDataGridColumn TItem="AuthTypeStat" Title="Auth Type">
                                <Template Context="item">
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                                        <RadzenIcon Icon="@item.Icon" Style="font-size: 1rem;" />
                                        <RadzenText>@item.AuthType</RadzenText>
                                    </RadzenStack>
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="AuthTypeStat" Property="Count" Title="Users" Width="80px" />
                            <RadzenDataGridColumn TItem="AuthTypeStat" Title="%" Width="80px">
                                <Template Context="item">@item.Percent.ToString("F1")%</Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                }
                else
                {
                    <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false">No data available</RadzenAlert>
                }
            </RadzenCard>
        </RadzenColumn>

        @* Quick Actions *@
        <RadzenColumn Size="12">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-4">
                    <RadzenIcon Icon="flash_on" />
                    <RadzenText TextStyle="TextStyle.H6">Quick Actions</RadzenText>
                </RadzenStack>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" Style="flex-wrap: wrap;">
                    <RadzenButton ButtonStyle="ButtonStyle.Success" Icon="trending_up" Text="Analytics"
                                  Click="@(() => Navigation.NavigateTo("admin/analytics"))" />
                    <RadzenButton ButtonStyle="ButtonStyle.Primary" Icon="people" Text="Manage Users"
                                  Click="@(() => Navigation.NavigateTo("admin/users"))" />
                    <RadzenButton ButtonStyle="ButtonStyle.Info" Icon="business" Text="View Organizations"
                                  Click="@(() => Navigation.NavigateTo("admin/organizations"))" />
                    <RadzenButton ButtonStyle="ButtonStyle.Warning" Icon="health_and_safety" Text="System Health"
                                  Click="@(() => Navigation.NavigateTo("admin/health"))" />
                    <RadzenButton ButtonStyle="ButtonStyle.Secondary" Icon="article" Text="View Logs"
                                  Click="@(() => Navigation.NavigateTo("admin/logs"))" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>
}

@code {
    private bool _isLoading = true;
    private AdminStatsDto? _stats;
    private SystemHealthDto? _health;
    private RevenueAnalyticsDto? _revenue;
    private UserAnalyticsDto? _userAnalytics;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            var statsTask = AdminService.GetStatsAsync();
            var healthTask = AdminService.GetHealthAsync();
            var revenueTask = AdminService.GetRevenueAnalyticsAsync(1);
            var userAnalyticsTask = AdminService.GetUserAnalyticsAsync(1);

            await Task.WhenAll(statsTask, healthTask, revenueTask, userAnalyticsTask);

            _stats = await statsTask;
            _health = await healthTask;
            _revenue = await revenueTask;
            _userAnalytics = await userAnalyticsTask;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private static BadgeStyle GetPlanBadgeStyle(string plan) => plan.ToLower() switch
    {
        "enterprise" => BadgeStyle.Success,
        "team" => BadgeStyle.Primary,
        _ => BadgeStyle.Light
    };

    private record HealthItem(string Name, string Icon, bool IsHealthy, long? LatencyMs);
    private record PlanStat(string Plan, int Count, double Percent);
    private record AuthTypeStat(string AuthType, string Icon, int Count, double Percent);

    private List<HealthItem> GetHealthItems()
    {
        if (_health == null) return new();
        var items = new List<HealthItem>
        {
            new("Database", "storage", _health.Database.IsHealthy, _health.Database.LatencyMs),
            new("Redis", "memory", _health.Redis.IsHealthy, _health.Redis.LatencyMs),
            new("MinIO", "cloud_queue", _health.MinIO.IsHealthy, _health.MinIO.LatencyMs)
        };
        if (_health.PayPal != null)
            items.Add(new("PayPal", "payment", _health.PayPal.IsHealthy, _health.PayPal.LatencyMs));
        if (_health.Stripe != null)
            items.Add(new("Stripe", "credit_card", _health.Stripe.IsHealthy, _health.Stripe.LatencyMs));
        return items;
    }

    private List<PlanStat> GetPlanStats()
    {
        if (_stats?.UsersByPlan == null) return new();
        return _stats.UsersByPlan.Select(kv => new PlanStat(
            kv.Key,
            kv.Value,
            _stats.TotalUsers > 0 ? kv.Value * 100.0 / _stats.TotalUsers : 0
        )).ToList();
    }

    private List<AuthTypeStat> GetAuthTypeStats()
    {
        if (_stats?.UsersByAuthType == null) return new();
        return _stats.UsersByAuthType.Select(kv => new AuthTypeStat(
            kv.Key,
            kv.Key.ToLower() == "github" ? "code" : "email",
            kv.Value,
            _stats.TotalUsers > 0 ? kv.Value * 100.0 / _stats.TotalUsers : 0
        )).ToList();
    }
}
