@page "/"
@attribute [Authorize]
@using LrmCloud.Shared.DTOs.Usage
@using LrmCloud.Shared.DTOs.GitHub
@using LrmCloud.Web.Helpers
@using LrmCloud.Web.Components
@inject ProjectService ProjectService
@inject UsageService UsageService
@inject GitHubIntegrationService GitHubService
@inject OrganizationContextService OrgContext
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService
@implements IDisposable

<PageTitle>Dashboard - LRM Cloud</PageTitle>

<RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-4">
    <RadzenText TextStyle="TextStyle.H4" Style="margin: 0;">Dashboard</RadzenText>
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Filter:</RadzenText>
        <OrgSelector />
    </RadzenStack>
</RadzenStack>

@if (_isLoading)
{
    <RadzenRow Gap="1rem">
        @for (int i = 0; i < 4; i++)
        {
            <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
                <RadzenCard Style="height: 100px;">
                    <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Small" />
                </RadzenCard>
            </RadzenColumn>
        }
    </RadzenRow>
}
else
{
    <RadzenRow Gap="1rem">
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                    <div>
                        <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-color-secondary">Projects</RadzenText>
                        <RadzenText TextStyle="TextStyle.H4">@_stats.ProjectCount</RadzenText>
                    </div>
                    <RadzenIcon Icon="folder" Style="font-size: 2rem; color: var(--rz-primary);" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                    <div>
                        <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-color-secondary">Total Keys</RadzenText>
                        <RadzenText TextStyle="TextStyle.H4">@_stats.TotalKeys</RadzenText>
                    </div>
                    <RadzenIcon Icon="key" Style="font-size: 2rem; color: var(--rz-info);" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                    <div>
                        <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-color-secondary">Avg. Completion</RadzenText>
                        <RadzenText TextStyle="TextStyle.H4">@(_stats.AverageCompletion.ToString("F0"))%</RadzenText>
                    </div>
                    <RadzenIcon Icon="translate" Style="font-size: 2rem; color: var(--rz-success);" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                    <div>
                        <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-color-secondary">LRM Usage</RadzenText>
                        <RadzenText TextStyle="TextStyle.H4">@FormatLrmUsage()</RadzenText>
                        @if (_usageStats?.ByokCharsUsed > 0)
                        {
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                + @UiHelpers.FormatCharacters(_usageStats.ByokCharsUsed) other
                            </RadzenText>
                        }
                    </div>
                    <RadzenIcon Icon="star" Style="font-size: 2rem; color: var(--rz-warning);" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard Style="cursor: pointer;" @onclick="NavigateToGitHubSettings">
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                    <div>
                        <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-color-secondary">GitHub</RadzenText>
                        @if (_gitHubStatus?.Connected == true)
                        {
                            <RadzenText TextStyle="TextStyle.H6">@@@_gitHubStatus.GitHubLogin</RadzenText>
                        }
                        else
                        {
                            <RadzenText TextStyle="TextStyle.Body1" class="rz-color-secondary">Not Connected</RadzenText>
                        }
                    </div>
                    <RadzenIcon Icon="@(_gitHubStatus?.Connected == true ? "check_circle" : "link_off")"
                               Style="@($"font-size: 2rem; color: var(--rz-{(_gitHubStatus?.Connected == true ? "success" : "secondary")});")" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>
}

<RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mt-6 rz-mb-4">
    <RadzenText TextStyle="TextStyle.H5">Recent Projects</RadzenText>
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
        <RadzenButton Variant="Radzen.Variant.Outlined" Icon="upload" Text="Import" Click="@OpenImportDialog" />
        <RadzenButton Variant="Radzen.Variant.Filled" Icon="add" Text="New Project" Click="@OpenCreateDialog" />
    </RadzenStack>
</RadzenStack>

@if (_isLoading)
{
    <RadzenRow Gap="1rem">
        @for (int i = 0; i < 3; i++)
        {
            <RadzenColumn Size="12" SizeSM="6" SizeMD="4">
                <RadzenCard Style="height: 180px;">
                    <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Small" />
                </RadzenCard>
            </RadzenColumn>
        }
    </RadzenRow>
}
else if (_filteredProjects.Count == 0)
{
    <RadzenCard>
        <RadzenStack AlignItems="Radzen.AlignItems.Center" JustifyContent="JustifyContent.Center" class="rz-py-8">
            <RadzenIcon Icon="folder_open" Style="font-size: 3rem; color: var(--rz-text-secondary-color);" />
            <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-color-secondary">No projects yet</RadzenText>
            <RadzenButton Variant="Radzen.Variant.Filled" Icon="add" Text="Create Your First Project" Click="@OpenCreateDialog" class="rz-mt-2" />
        </RadzenStack>
    </RadzenCard>
}
else
{
    <RadzenRow Gap="1rem">
        @foreach (var project in _filteredProjects.Take(6))
        {
            <RadzenColumn Size="12" SizeSM="6" SizeMD="4">
                <RadzenCard Style="cursor: pointer;" @onclick="@(() => NavigateToProject(project.Id))">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Start">
                        <div>
                            <RadzenText TextStyle="TextStyle.H6">@project.Name</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
                                @(project.OrganizationName ?? "Personal")
                            </RadzenText>
                        </div>
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.25rem" AlignItems="Radzen.AlignItems.Center">
                            <RadzenBadge BadgeStyle="@UiHelpers.GetFormatBadgeStyle(project.Format)" Text="@project.Format" />
                            @if (!string.IsNullOrEmpty(project.GitHubRepo))
                            {
                                <span @onclick="() => NavigateToGitHub(project.Id)" @onclick:stopPropagation="true">
                                    <RadzenBadge BadgeStyle="BadgeStyle.Dark"
                                                 Style="cursor: pointer;"
                                                 Title="@project.GitHubRepo">
                                        <RadzenIcon Icon="@UiHelpers.GetGitHubStatusIcon(project.SyncStatus)" Style="font-size: 0.875rem;" />
                                    </RadzenBadge>
                                </span>
                            }
                            @if (project.ValidationErrors > 0 || project.ValidationWarnings > 0)
                            {
                                <span title="@UiHelpers.GetValidationTooltip(project)" style="display: flex; gap: 0.125rem;">
                                    @if (project.ValidationErrors > 0)
                                    {
                                        <RadzenIcon Icon="error" Style="color: var(--rz-danger); font-size: 1rem;" />
                                    }
                                    @if (project.ValidationWarnings > 0)
                                    {
                                        <RadzenIcon Icon="warning" Style="color: var(--rz-warning); font-size: 1rem;" />
                                    }
                                </span>
                            }
                        </RadzenStack>
                    </RadzenStack>
                    @if (!string.IsNullOrEmpty(project.Description))
                    {
                        <RadzenText TextStyle="TextStyle.Body2" class="rz-mb-2" Style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            @project.Description
                        </RadzenText>
                    }
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" class="rz-mt-2">
                        <RadzenText TextStyle="TextStyle.Caption">@project.KeyCount keys</RadzenText>
                        <RadzenText TextStyle="TextStyle.Caption">@project.CompletionPercentage.ToString("F0")% complete</RadzenText>
                    </RadzenStack>
                    <RadzenProgressBar Value="@project.CompletionPercentage" ShowValue="false" ProgressBarStyle="@UiHelpers.GetCompletionProgressStyle(project.CompletionPercentage)" class="rz-mt-2" Style="height: 4px;" />
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" class="rz-mt-3">
                        <RadzenButton Variant="Radzen.Variant.Text" Text="Edit" Click="@(() => NavigateToEditor(project.Id))" @onclick:stopPropagation="true" />
                        <RadzenButton Variant="Radzen.Variant.Text" ButtonStyle="ButtonStyle.Secondary" Text="Settings" Click="@(() => NavigateToSettings(project.Id))" @onclick:stopPropagation="true" />
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
        }
    </RadzenRow>

    @if (_filteredProjects.Count > 6)
    {
        <RadzenStack JustifyContent="JustifyContent.Center" class="rz-mt-4">
            <RadzenLink Path="projects" Text="@($"View All Projects ({_filteredProjects.Count})")" />
        </RadzenStack>
    }
}


@code {
    private List<ProjectDto> _projects = new();
    private List<ProjectDto> _filteredProjects = new();
    private DashboardStats _stats = new();
    private UsageStatsDto? _usageStats;
    private UserGitHubStatus? _gitHubStatus;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await OrgContext.InitializeAsync();
        OrgContext.OnOrganizationChanged += OnOrgContextChanged;
        await LoadDataAsync();
    }

    private async void OnOrgContextChanged()
    {
        FilterProjects();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            _projects = await ProjectService.GetProjectsAsync();
            FilterProjects();
            _stats = await ProjectService.GetDashboardStatsAsync();
            _usageStats = await UsageService.GetStatsAsync();
            _gitHubStatus = await GitHubService.GetUserGitHubStatusAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error loading dashboard: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void FilterProjects()
    {
        var selectedOrgId = OrgContext.SelectedOrganizationId;
        if (selectedOrgId.HasValue)
        {
            _filteredProjects = _projects.Where(p => p.OrganizationId == selectedOrgId.Value).ToList();
        }
        else
        {
            _filteredProjects = _projects.ToList();
        }
    }

    public void Dispose()
    {
        OrgContext.OnOrganizationChanged -= OnOrgContextChanged;
    }

    private async Task OpenCreateDialog()
    {
        var result = await DialogService.OpenAsync<CreateProjectDialog>("Create Project",
            null,
            new Radzen.DialogOptions { Width = "500px" });

        if (result is ProjectDto project)
        {
            await OnProjectCreated(project);
        }
    }

    private void NavigateToSettings(int projectId)
    {
        Navigation.NavigateTo($"projects/{projectId}/settings");
    }

    private async Task OpenImportDialog()
    {
        var parameters = new Dictionary<string, object>
        {
            { "OrganizationId", OrgContext.SelectedOrganizationId }
        };

        var result = await DialogService.OpenAsync<ImportProjectDialog>("Import Project",
            parameters,
            new Radzen.DialogOptions { Width = "600px" });

        if (result is ProjectDto project)
        {
            await OnProjectCreated(project);
        }
    }

    private async Task OnProjectCreated(ProjectDto project)
    {
        _projects.Insert(0, project);
        FilterProjects();
        _stats.ProjectCount++;
        _stats.TotalKeys += project.KeyCount;
        StateHasChanged();
    }

    private void NavigateToProject(int projectId)
    {
        Navigation.NavigateTo($"projects/{projectId}");
    }

    private void NavigateToEditor(int projectId)
    {
        Navigation.NavigateTo($"projects/{projectId}/editor");
    }

    private void NavigateToGitHub(int projectId)
    {
        Navigation.NavigateTo($"projects/{projectId}/github");
    }

    private void NavigateToGitHubSettings()
    {
        Navigation.NavigateTo("settings/profile");
    }

    private string FormatLrmUsage()
    {
        if (_usageStats == null)
            return "0 / 10K";

        var used = _usageStats.TranslationCharsUsed;
        var limit = _usageStats.TranslationCharsLimit;

        if (used >= 1000)
            return $"{used / 1000}K / {limit / 1000}K";
        return $"{used} / {limit / 1000}K";
    }
}
