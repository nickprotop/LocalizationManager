@page "/"
@attribute [Authorize]
@using LrmCloud.Shared.DTOs.Usage
@using LrmCloud.Shared.DTOs.GitHub
@using LrmCloud.Web.Helpers
@using LrmCloud.Web.Components
@inject ProjectService ProjectService
@inject UsageService UsageService
@inject GitHubIntegrationService GitHubService
@inject OrganizationContextService OrgContext
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService
@implements IDisposable

<PageTitle>Dashboard - LRM Cloud</PageTitle>

<RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-4">
    <RadzenText TextStyle="TextStyle.H4" Style="margin: 0;">Dashboard</RadzenText>
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Filter:</RadzenText>
        <OrgSelector />
    </RadzenStack>
</RadzenStack>

@if (_isLoading)
{
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Wrap="FlexWrap.Wrap" Gap="1rem" class="lrm-stagger">
        @for (int i = 0; i < 5; i++)
        {
            <div class="stat-card" style="flex: 1 1 180px; min-width: 180px; max-width: 280px;">
                <div class="lrm-skeleton" style="width: 48px; height: 48px; border-radius: var(--lrm-radius-md);"></div>
                <div class="stat-card-content">
                    <div class="lrm-skeleton" style="width: 60px; height: 28px; margin-bottom: 4px;"></div>
                    <div class="lrm-skeleton" style="width: 80px; height: 16px;"></div>
                </div>
            </div>
        }
    </RadzenStack>
}
else
{
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Wrap="FlexWrap.Wrap" Gap="1rem" class="lrm-stagger">
        <StatCard Icon="folder"
                  Value="@_stats.ProjectCount.ToString()"
                  Label="Projects"
                  Variant="StatCard.StatCardVariant.Primary"
                  Style="width: 220px;" />
        <StatCard Icon="key"
                  Value="@_stats.TotalKeys.ToString()"
                  Label="Total Keys"
                  Variant="StatCard.StatCardVariant.Info"
                  Style="width: 220px;" />
        <StatCard Icon="translate"
                  Value="@($"{_stats.AverageCompletion:F0}%")"
                  Label="Avg. Completion"
                  Variant="StatCard.StatCardVariant.Success"
                  Style="width: 220px;" />
        <StatCard Icon="star"
                  Value="@FormatLrmUsage()"
                  Label="LRM Usage"
                  Variant="StatCard.StatCardVariant.Warning"
                  Style="width: 220px;">
            @if (_usageStats?.ByokCharsUsed > 0)
            {
                <span>+ @UiHelpers.FormatCharacters(_usageStats.ByokCharsUsed) other</span>
            }
        </StatCard>
        <StatCard Icon="@(_gitHubStatus?.Connected == true ? "check_circle" : "link_off")"
                  Value="@(_gitHubStatus?.Connected == true ? $"@{_gitHubStatus.GitHubLogin}" : "Not Connected")"
                  Label="GitHub"
                  Variant="@(_gitHubStatus?.Connected == true ? StatCard.StatCardVariant.Success : StatCard.StatCardVariant.Primary)"
                  Style="width: 220px; cursor: pointer;"
                  OnClick="@(() => NavigateToGitHubSettings())" />
    </RadzenStack>
}

<RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mt-6 rz-mb-4">
    <RadzenText TextStyle="TextStyle.H5">Recent Projects</RadzenText>
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
        <RadzenButton Variant="Radzen.Variant.Outlined" Icon="upload" Text="Import" Click="@OpenImportDialog" />
        <RadzenButton Variant="Radzen.Variant.Filled" Icon="add" Text="New Project" Click="@OpenCreateDialog" />
    </RadzenStack>
</RadzenStack>

@if (_isLoading)
{
    <RadzenRow Gap="1rem" class="lrm-stagger">
        @for (int i = 0; i < 3; i++)
        {
            <RadzenColumn Size="12" SizeSM="6" SizeMD="4">
                <div class="project-card" style="cursor: default;">
                    <div class="project-card-header">
                        <div style="flex: 1;">
                            <div class="lrm-skeleton" style="width: 120px; height: 22px; margin-bottom: 4px;"></div>
                            <div class="lrm-skeleton" style="width: 80px; height: 16px;"></div>
                        </div>
                        <div class="lrm-skeleton" style="width: 50px; height: 20px;"></div>
                    </div>
                    <div class="lrm-skeleton" style="width: 100%; height: 16px; margin: 12px 0;"></div>
                    <div class="lrm-skeleton" style="width: 100%; height: 4px; margin-bottom: 16px;"></div>
                    <div style="display: flex; gap: 8px;">
                        <div class="lrm-skeleton" style="width: 50px; height: 32px;"></div>
                        <div class="lrm-skeleton" style="width: 70px; height: 32px;"></div>
                    </div>
                </div>
            </RadzenColumn>
        }
    </RadzenRow>
}
else if (_filteredProjects.Count == 0)
{
    <div class="empty-state lrm-animate-fade-in-up">
        <RadzenIcon Icon="folder_open" Style="font-size: 4rem; color: var(--lrm-text-muted);" />
        <h3 style="margin: 1rem 0 0.5rem; color: var(--lrm-text-primary);">No projects yet</h3>
        <p style="color: var(--lrm-text-secondary); margin-bottom: 1.5rem;">Create your first project to start managing translations</p>
        <RadzenButton Variant="Radzen.Variant.Filled" Icon="add" Text="Create Your First Project" Click="@OpenCreateDialog" />
    </div>
}
else
{
    <RadzenRow Gap="1rem" class="lrm-stagger">
        @foreach (var project in _filteredProjects.Take(6))
        {
            <RadzenColumn Size="12" SizeSM="6" SizeMD="4">
                <ProjectCard Project="project" />
            </RadzenColumn>
        }
    </RadzenRow>

    @if (_filteredProjects.Count > 6)
    {
        <div style="text-align: center; margin-top: 1.5rem;">
            <RadzenLink Path="projects" Style="font-weight: 500;">
                View All Projects (@_filteredProjects.Count)
            </RadzenLink>
        </div>
    }
}


@code {
    private List<ProjectDto> _projects = new();
    private List<ProjectDto> _filteredProjects = new();
    private DashboardStats _stats = new();
    private UsageStatsDto? _usageStats;
    private UserGitHubStatus? _gitHubStatus;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await OrgContext.InitializeAsync();
        OrgContext.OnOrganizationChanged += OnOrgContextChanged;
        await LoadDataAsync();
    }

    private async void OnOrgContextChanged()
    {
        FilterProjects();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            _projects = await ProjectService.GetProjectsAsync();
            FilterProjects();
            _stats = await ProjectService.GetDashboardStatsAsync();
            _usageStats = await UsageService.GetStatsAsync();
            _gitHubStatus = await GitHubService.GetUserGitHubStatusAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error loading dashboard: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void FilterProjects()
    {
        var selectedOrgId = OrgContext.SelectedOrganizationId;
        if (selectedOrgId.HasValue)
        {
            _filteredProjects = _projects.Where(p => p.OrganizationId == selectedOrgId.Value).ToList();
        }
        else
        {
            _filteredProjects = _projects.ToList();
        }
    }

    public void Dispose()
    {
        OrgContext.OnOrganizationChanged -= OnOrgContextChanged;
    }

    private async Task OpenCreateDialog()
    {
        var result = await DialogService.OpenAsync<CreateProjectDialog>("Create Project",
            null,
            new Radzen.DialogOptions { Width = "500px" });

        if (result is ProjectDto project)
        {
            await OnProjectCreated(project);
        }
    }

    private async Task OpenImportDialog()
    {
        var parameters = new Dictionary<string, object>
        {
            { "OrganizationId", OrgContext.SelectedOrganizationId }
        };

        var result = await DialogService.OpenAsync<ImportProjectDialog>("Import Project",
            parameters,
            new Radzen.DialogOptions { Width = "600px" });

        if (result is ProjectDto project)
        {
            await OnProjectCreated(project);
        }
    }

    private async Task OnProjectCreated(ProjectDto project)
    {
        _projects.Insert(0, project);
        FilterProjects();
        _stats.ProjectCount++;
        _stats.TotalKeys += project.KeyCount;
        StateHasChanged();
    }

    private void NavigateToGitHubSettings()
    {
        Navigation.NavigateTo("settings/profile");
    }

    private string FormatLrmUsage()
    {
        if (_usageStats == null)
            return "0 / 10K";

        var used = _usageStats.TranslationCharsUsed;
        var limit = _usageStats.TranslationCharsLimit;

        if (used >= 1000)
            return $"{used / 1000}K / {limit / 1000}K";
        return $"{used} / {limit / 1000}K";
    }
}
