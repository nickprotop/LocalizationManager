@page "/"
@attribute [Authorize]
@using LrmCloud.Shared.DTOs.Usage
@using LrmCloud.Web.Helpers
@inject ProjectService ProjectService
@inject UsageService UsageService
@inject OrganizationContextService OrgContext
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@implements IDisposable

<PageTitle>Dashboard - LRM Cloud</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">Dashboard</MudText>

@if (_isLoading)
{
    <MudGrid>
        @for (int i = 0; i < 4; i++)
        {
            <MudItem xs="12" sm="6" md="3">
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="100px" />
            </MudItem>
        }
    </MudGrid>
}
else
{
    <MudGrid>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Projects</MudText>
                        <MudText Typo="Typo.h4">@_stats.ProjectCount</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.Folder" Color="Color.Primary" Size="Size.Large" />
                </MudStack>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Total Keys</MudText>
                        <MudText Typo="Typo.h4">@_stats.TotalKeys</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.Key" Color="Color.Info" Size="Size.Large" />
                </MudStack>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Avg. Completion</MudText>
                        <MudText Typo="Typo.h4">@(_stats.AverageCompletion.ToString("F0"))%</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.Translate" Color="Color.Success" Size="Size.Large" />
                </MudStack>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">LRM Usage</MudText>
                        <MudText Typo="Typo.h4">@FormatLrmUsage()</MudText>
                        @if (_usageStats?.ByokCharsUsed > 0)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                + @UiHelpers.FormatCharacters(_usageStats.ByokCharsUsed) other
                            </MudText>
                        }
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.Star" Color="Color.Warning" Size="Size.Large" />
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>
}

<MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mt-6 mb-4">
    <MudText Typo="Typo.h5">Recent Projects</MudText>
    <MudStack Row="true" Spacing="2">
        <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Upload" OnClick="@OpenImportDialog">
            Import
        </MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="@OpenCreateDialog">
            New Project
        </MudButton>
    </MudStack>
</MudStack>

@if (_isLoading)
{
    <MudGrid>
        @for (int i = 0; i < 3; i++)
        {
            <MudItem xs="12" sm="6" md="4">
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="180px" />
            </MudItem>
        }
    </MudGrid>
}
else if (_filteredProjects.Count == 0)
{
    <MudPaper Class="pa-4" Elevation="2">
        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Class="py-8">
            <MudIcon Icon="@Icons.Material.Filled.FolderOpen" Size="Size.Large" Color="Color.Secondary" />
            <MudText Typo="Typo.subtitle1" Color="Color.Secondary">No projects yet</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="@OpenCreateDialog" Class="mt-2">
                Create Your First Project
            </MudButton>
        </MudStack>
    </MudPaper>
}
else
{
    <MudGrid>
        @foreach (var project in _filteredProjects.Take(6))
        {
            <MudItem xs="12" sm="6" md="4">
                <MudCard Elevation="2" Class="cursor-pointer" @onclick="@(() => NavigateToProject(project.Id))">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">@project.Name</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                @(project.OrganizationName ?? "Personal")
                            </MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudChip T="string" Size="Size.Small" Color="@UiHelpers.GetFormatColor(project.Format)">@project.Format</MudChip>
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (!string.IsNullOrEmpty(project.Description))
                        {
                            <MudText Typo="Typo.body2" Class="mb-2" Style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                @project.Description
                            </MudText>
                        }
                        <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mt-2">
                            <MudText Typo="Typo.caption">@project.KeyCount keys</MudText>
                            <MudText Typo="Typo.caption">@project.CompletionPercentage.ToString("F0")% complete</MudText>
                        </MudStack>
                        <MudProgressLinear Value="@project.CompletionPercentage" Color="@UiHelpers.GetCompletionColor(project.CompletionPercentage)" Class="mt-2" />
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => NavigateToEditor(project.Id))" ClickPropagation="false">
                            Edit
                        </MudButton>
                        <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="@(() => NavigateToSettings(project.Id))" ClickPropagation="false">
                            Settings
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
    </MudGrid>

    @if (_filteredProjects.Count > 6)
    {
        <MudStack Row="true" Justify="Justify.Center" Class="mt-4">
            <MudButton Variant="Variant.Text" Color="Color.Primary" Href="projects">
                View All Projects (@_filteredProjects.Count)
            </MudButton>
        </MudStack>
    }
}

<CreateProjectDialog @ref="_createDialog" OnProjectCreated="OnProjectCreated" />
<ImportProjectDialog @ref="_importDialog" OnProjectImported="OnProjectCreated" OrganizationId="@OrgContext.SelectedOrganizationId" />

@code {
    private List<ProjectDto> _projects = new();
    private List<ProjectDto> _filteredProjects = new();
    private DashboardStats _stats = new();
    private UsageStatsDto? _usageStats;
    private bool _isLoading = true;
    private CreateProjectDialog? _createDialog;
    private ImportProjectDialog? _importDialog;

    protected override async Task OnInitializedAsync()
    {
        await OrgContext.InitializeAsync();
        OrgContext.OnOrganizationChanged += OnOrgContextChanged;
        await LoadDataAsync();
    }

    private async void OnOrgContextChanged()
    {
        FilterProjects();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            _projects = await ProjectService.GetProjectsAsync();
            FilterProjects();
            _stats = await ProjectService.GetDashboardStatsAsync();
            _usageStats = await UsageService.GetStatsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading dashboard: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void FilterProjects()
    {
        var selectedOrgId = OrgContext.SelectedOrganizationId;
        if (selectedOrgId.HasValue)
        {
            // Show only projects from the selected organization
            _filteredProjects = _projects.Where(p => p.OrganizationId == selectedOrgId.Value).ToList();
        }
        else
        {
            // Personal context: show personal projects (no org) and all org projects
            _filteredProjects = _projects.ToList();
        }
    }

    public void Dispose()
    {
        OrgContext.OnOrganizationChanged -= OnOrgContextChanged;
    }

    private void OpenCreateDialog()
    {
        _createDialog?.Open();
    }

    private void NavigateToSettings(int projectId)
    {
        Navigation.NavigateTo($"projects/{projectId}/settings");
    }

    private void OpenImportDialog()
    {
        _importDialog?.Open();
    }

    private async Task OnProjectCreated(ProjectDto project)
    {
        _projects.Insert(0, project);
        FilterProjects();
        _stats.ProjectCount++;
        _stats.TotalKeys += project.KeyCount;
        StateHasChanged();
    }

    private void NavigateToProject(int projectId)
    {
        Navigation.NavigateTo($"projects/{projectId}");
    }

    private void NavigateToEditor(int projectId)
    {
        Navigation.NavigateTo($"projects/{projectId}/editor");
    }

    private string FormatLrmUsage()
    {
        if (_usageStats == null)
            return "0 / 10K";

        var used = _usageStats.TranslationCharsUsed;
        var limit = _usageStats.TranslationCharsLimit;

        if (used >= 1000)
            return $"{used / 1000}K / {limit / 1000}K";
        return $"{used} / {limit / 1000}K";
    }

}
