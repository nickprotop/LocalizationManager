@page "/projects/{ProjectId:int}"
@attribute [Authorize]
@using LrmCloud.Web.Components
@using LrmCloud.Web.Helpers
@using LrmCloud.Shared.DTOs.Translation
@using LrmCloud.Shared.DTOs.Resources
@inject ProjectService ProjectService
@inject ResourceService ResourceService
@inject TranslationService TranslationService
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService
@inject IJSRuntime JS

<PageTitle>@(_project?.Name ?? "Project") - LRM Cloud</PageTitle>

@if (_isLoading)
{
    <RadzenStack Gap="1rem">
        <RadzenSkeleton Style="height: 120px; width: 100%;" />
        <RadzenSkeleton Style="height: 200px; width: 100%;" />
    </RadzenStack>
}
else if (_project == null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" AllowClose="false">
        Project not found or you don't have access to it.
        <RadzenButton Variant="Radzen.Variant.Text" ButtonStyle="ButtonStyle.Primary" Text="Go to Dashboard" Click="@(() => Navigation.NavigateTo(""))" />
    </RadzenAlert>
}
else
{
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-4">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
            <RadzenButton Icon="arrow_back" Variant="Radzen.Variant.Text" Click="@(() => Navigation.NavigateTo(""))" Size="ButtonSize.Small" />
            <RadzenText TextStyle="TextStyle.H4">@_project.Name</RadzenText>
            <RadzenBadge BadgeStyle="@UiHelpers.GetFormatBadgeStyle(_project.Format)" Text="@_project.Format" />
        </RadzenStack>

        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
            <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Secondary" Icon="settings"
                          Text="Settings" Click="@(() => Navigation.NavigateTo($"projects/{ProjectId}/settings"))" />
            <RadzenButton Variant="Radzen.Variant.Filled" ButtonStyle="ButtonStyle.Primary" Icon="edit"
                          Text="Open Editor" Click="@(() => Navigation.NavigateTo($"projects/{ProjectId}/editor"))" />
        </RadzenStack>
    </RadzenStack>

    @if (!string.IsNullOrEmpty(_project.Description))
    {
        <RadzenText TextStyle="TextStyle.Body1" class="rz-color-secondary rz-mb-4">@_project.Description</RadzenText>
    }

    <RadzenRow Gap="1rem" class="rz-mb-4">
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Keys</RadzenText>
                        <RadzenText TextStyle="TextStyle.H4">@(_stats?.TotalKeys ?? _project.KeyCount)</RadzenText>
                    </RadzenStack>
                    <RadzenIcon Icon="key" Style="font-size: 2rem; color: var(--rz-primary);" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Languages</RadzenText>
                        <RadzenText TextStyle="TextStyle.H4">@(_stats?.Languages.Count ?? 0)</RadzenText>
                    </RadzenStack>
                    <RadzenIcon Icon="language" Style="font-size: 2rem; color: var(--rz-info);" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Completion</RadzenText>
                        <RadzenText TextStyle="TextStyle.H4">@(_stats?.OverallCompletion.ToString("F0") ?? _project.CompletionPercentage.ToString("F0"))%</RadzenText>
                    </RadzenStack>
                    <RadzenIcon Icon="check_circle" Style="@($"font-size: 2rem; color: {GetCompletionColor(_stats?.OverallCompletion ?? _project.CompletionPercentage)};")" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Last Updated</RadzenText>
                        <RadzenText TextStyle="TextStyle.H6">@_project.UpdatedAt.ToString("MMM dd")</RadzenText>
                    </RadzenStack>
                    <RadzenIcon Icon="schedule" Style="font-size: 2rem;" class="rz-color-secondary" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    @if (_stats != null && _stats.Languages.Any())
    {
        <RadzenText TextStyle="TextStyle.H6" class="rz-mt-6 rz-mb-3">Language Progress</RadzenText>
        <RadzenCard>
            <RadzenStack Gap="1rem">
                @foreach (var lang in _stats.Languages.OrderByDescending(l => l.Value.CompletionPercentage))
                {
                    <RadzenStack Gap="0.25rem">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                                <RadzenText>@lang.Key.ToUpperInvariant()</RadzenText>
                                @if (lang.Key == _project.DefaultLanguage)
                                {
                                    <RadzenBadge BadgeStyle="BadgeStyle.Primary" Variant="Radzen.Variant.Outlined" Text="Default" />
                                }
                            </RadzenStack>
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
                                @lang.Value.TranslatedCount / @_stats.TotalKeys translated
                            </RadzenText>
                        </RadzenStack>
                        <RadzenProgressBar Value="@lang.Value.CompletionPercentage" Max="100"
                                           ProgressBarStyle="@UiHelpers.GetCompletionProgressStyle(lang.Value.CompletionPercentage)"
                                           ShowValue="false" Style="height: 8px;" />
                    </RadzenStack>
                }
            </RadzenStack>
        </RadzenCard>
    }

    @* Validation Summary Card *@
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mt-6 rz-mb-3">
        <RadzenText TextStyle="TextStyle.H6">Validation Status</RadzenText>
        @if (_validation != null)
        {
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                @if (_validation.IsCached && _validation.ValidatedAt.HasValue)
                {
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                        Updated @GetRelativeTime(_validation.ValidatedAt.Value)
                    </RadzenText>
                }
                <RadzenButton Icon="refresh" Variant="Radzen.Variant.Text" Size="ButtonSize.Small"
                              Click="@RefreshValidation" Disabled="@_isValidating"
                              title="Refresh validation" />
            </RadzenStack>
        }
    </RadzenStack>
    <RadzenCard>
        @if (_isValidating)
        {
            <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Style="height: 4px;" />
        }
        else if (_validation == null)
        {
            <RadzenAlert AlertStyle="AlertStyle.Warning" AllowClose="false" Shade="Shade.Lighter">
                Unable to load validation results.
            </RadzenAlert>
        }
        else if (_validation.Summary.TotalIssues == 0)
        {
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                <RadzenIcon Icon="check_circle" Style="font-size: 1.5rem; color: var(--rz-success);" />
                <RadzenText TextStyle="TextStyle.Body1">All validations passed. No issues found.</RadzenText>
            </RadzenStack>
        }
        else
        {
            <RadzenStack Gap="1rem">
                @* Summary row *@
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" Wrap="FlexWrap.Wrap">
                    @if (_validation.Summary.Errors > 0)
                    {
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                            <RadzenIcon Icon="error" Style="color: var(--rz-danger);" />
                            <RadzenText><strong>@_validation.Summary.Errors</strong> errors</RadzenText>
                        </RadzenStack>
                    }
                    @if (_validation.Summary.Warnings > 0)
                    {
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                            <RadzenIcon Icon="warning" Style="color: var(--rz-warning);" />
                            <RadzenText><strong>@_validation.Summary.Warnings</strong> warnings</RadzenText>
                        </RadzenStack>
                    }
                    @if (_validation.Summary.Info > 0)
                    {
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                            <RadzenIcon Icon="info" Style="color: var(--rz-info);" />
                            <RadzenText><strong>@_validation.Summary.Info</strong> info</RadzenText>
                        </RadzenStack>
                    }
                </RadzenStack>

                @* Category breakdown *@
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" Wrap="FlexWrap.Wrap">
                    @if (_validation.Summary.DuplicateKeys > 0)
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Danger" Variant="Radzen.Variant.Outlined"
                                     Text="@($"{_validation.Summary.DuplicateKeys} duplicate{(_validation.Summary.DuplicateKeys != 1 ? "s" : "")}")" />
                    }
                    @if (_validation.Summary.MissingTranslations > 0)
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Warning" Variant="Radzen.Variant.Outlined"
                                     Text="@($"{_validation.Summary.MissingTranslations} missing")" />
                    }
                    @if (_validation.Summary.EmptyValues > 0)
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Warning" Variant="Radzen.Variant.Outlined"
                                     Text="@($"{_validation.Summary.EmptyValues} empty")" />
                    }
                    @if (_validation.Summary.PlaceholderMismatches > 0)
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Warning" Variant="Radzen.Variant.Outlined"
                                     Text="@($"{_validation.Summary.PlaceholderMismatches} placeholder{(_validation.Summary.PlaceholderMismatches != 1 ? "s" : "")}")" />
                    }
                    @if (_validation.Summary.PendingReview > 0)
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Info" Variant="Radzen.Variant.Outlined"
                                     Text="@($"{_validation.Summary.PendingReview} pending review")" />
                    }
                </RadzenStack>

                @* View details link *@
                <RadzenButton Variant="Radzen.Variant.Text" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small"
                              Icon="open_in_new" Text="View Full Report"
                              Click="@(() => Navigation.NavigateTo($"projects/{ProjectId}/validation"))" />
            </RadzenStack>
        }
    </RadzenCard>

    <RadzenText TextStyle="TextStyle.H6" class="rz-mt-6 rz-mb-3">Project Details</RadzenText>
    <RadzenCard>
        <RadzenRow Gap="1rem">
            <RadzenColumn Size="12" SizeSM="6">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Project ID (Slug)</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1">@_project.Slug</RadzenText>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeSM="6">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Format</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1">@_project.Format</RadzenText>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeSM="6">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Default Language</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1">@_project.DefaultLanguage</RadzenText>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeSM="6">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Localization Path</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1">@_project.LocalizationPath</RadzenText>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeSM="6">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Organization</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1">@(_project.OrganizationName ?? "Personal")</RadzenText>
            </RadzenColumn>
            @if (!string.IsNullOrEmpty(_project.GitHubRepo))
            {
                <RadzenColumn Size="12" SizeSM="6">
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">GitHub Repository</RadzenText>
                    <RadzenLink Path="@($"https://github.com/{_project.GitHubRepo}")" Target="_blank" Text="@_project.GitHubRepo" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeSM="6">
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Default Branch</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body1">@(_project.GitHubDefaultBranch ?? "main")</RadzenText>
                </RadzenColumn>
            }
            <RadzenColumn Size="12" SizeSM="6">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Created</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1">@_project.CreatedAt.ToString("MMMM dd, yyyy")</RadzenText>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeSM="6">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Last Synced</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1">@(_project.LastSyncedAt?.ToString("MMMM dd, yyyy HH:mm") ?? "Never")</RadzenText>
            </RadzenColumn>
        </RadzenRow>
    </RadzenCard>

    <RadzenText TextStyle="TextStyle.H6" class="rz-mt-6 rz-mb-3">Quick Actions</RadzenText>
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" Wrap="FlexWrap.Wrap">
        <RadzenButton Variant="Radzen.Variant.Outlined" Icon="edit" Text="Open Editor"
                      Click="@(() => Navigation.NavigateTo($"projects/{ProjectId}/editor"))" />
        <RadzenButton Variant="Radzen.Variant.Outlined" Icon="history" Text="View Snapshots"
                      Click="@(() => Navigation.NavigateTo($"projects/{ProjectId}/snapshots"))" />
        <RadzenButton Variant="Radzen.Variant.Outlined" Icon="restore" Text="Sync History"
                      Click="@(() => Navigation.NavigateTo($"projects/{ProjectId}/history"))" />
        <RadzenButton Variant="Radzen.Variant.Outlined" Icon="book" Text="Glossary"
                      Click="@(() => Navigation.NavigateTo($"projects/{ProjectId}/glossary"))" />
        <RadzenButton Variant="Radzen.Variant.Outlined" Icon="verified" Text="Validation"
                      Click="@(() => Navigation.NavigateTo($"projects/{ProjectId}/validation"))" />
        <RadzenButton Variant="Radzen.Variant.Outlined" Icon="translate" Text="Translate All Missing"
                      Click="@OpenTranslateDialog" />
        <RadzenButton Variant="Radzen.Variant.Outlined" Icon="file_download" Text="Export"
                      Click="@ExportProject" />
        <RadzenButton Variant="Radzen.Variant.Outlined" Icon="content_copy" Text="CLI Sync Command"
                      Click="@CopySyncCommand" />
    </RadzenStack>
}

@code {
    [Parameter]
    public int ProjectId { get; set; }

    private ProjectDto? _project;
    private ProjectStatsDto? _stats;
    private ValidationResultDto? _validation;
    private bool _isLoading = true;
    private bool _isValidating = false;

    // Export dialog state
    private string _exportFormat = "json";

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            _project = await ProjectService.GetProjectAsync(ProjectId);
            if (_project != null)
            {
                // Load stats and validation in parallel
                var statsTask = ResourceService.GetProjectStatsAsync(ProjectId);
                var validationTask = ResourceService.ValidateProjectAsync(ProjectId);
                await Task.WhenAll(statsTask, validationTask);
                _stats = await statsTask;
                _validation = await validationTask;
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error loading project: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task RefreshValidation()
    {
        _isValidating = true;
        try
        {
            _validation = await ResourceService.ValidateProjectAsync(ProjectId, forceRefresh: true);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Validation failed: {ex.Message}");
        }
        finally
        {
            _isValidating = false;
        }
    }

    private static string GetCompletionColor(double percentage) => percentage switch
    {
        >= 90 => "var(--rz-success)",
        >= 50 => "var(--rz-warning)",
        _ => "var(--rz-danger)"
    };

    // =========================================================================
    // Translate All
    // =========================================================================

    private async Task OpenTranslateDialog()
    {
        if (_project == null || _stats == null) return;

        var availableLanguages = _stats.Languages.Keys.ToList();

        var result = await DialogService.OpenAsync<TranslateDialog>("Translate All Missing",
            new Dictionary<string, object>
            {
                { "ProjectId", ProjectId },
                { "SourceLanguage", _project.DefaultLanguage },
                { "AvailableLanguages", availableLanguages },
                { "KeysToTranslate", new List<string>() }, // Empty = translate all
                { "SaveToDatabase", true }
            },
            new Radzen.DialogOptions { Width = "600px" });

        if (result is TranslateResponseDto translationResult && translationResult.Success)
        {
            // Refresh stats after translation
            _stats = await ResourceService.GetProjectStatsAsync(ProjectId);
        }
    }

    // =========================================================================
    // Export
    // =========================================================================

    private async Task ExportProject()
    {
        _exportFormat = "json";

        var result = await DialogService.OpenAsync("Export Project", ds =>
            @<RadzenStack Gap="1rem">
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
                    Export your localization resources in various formats.
                </RadzenText>

                <RadzenRadioButtonList @bind-Value="_exportFormat" TValue="string" Orientation="Radzen.Orientation.Vertical">
                    <Items>
                        <RadzenRadioButtonListItem Text="JSON (all languages in one file)" Value="@("json")" />
                        <RadzenRadioButtonListItem Text="CSV (spreadsheet compatible)" Value="@("csv")" />
                        <RadzenRadioButtonListItem Text="@($"Native format ({_project?.Format} files)")" Value="@("native")" />
                    </Items>
                </RadzenRadioButtonList>

                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem" class="rz-mt-4">
                    <RadzenButton Variant="Radzen.Variant.Text" Text="Cancel" Click="@(() => ds.Close(false))" />
                    <RadzenButton ButtonStyle="ButtonStyle.Primary" Icon="download" Text="Download"
                                  Click="@(() => ds.Close(true))"
                                  Disabled="@(string.IsNullOrEmpty(_exportFormat))" />
                </RadzenStack>
            </RadzenStack>,
            new Radzen.DialogOptions { Width = "400px" });

        if (result == true)
        {
            await ExecuteExport();
        }
    }

    private async Task ExecuteExport()
    {
        if (_project == null)
            return;

        // For now, show a message about using CLI
        // In the future, this could download files directly
        NotificationService.Notify(NotificationSeverity.Info, "Export",
            $"Export to {_exportFormat.ToUpper()} format - Use CLI: lrm cloud sync --project {ProjectId} --export {_exportFormat}");
    }

    // =========================================================================
    // CLI Command
    // =========================================================================

    private async Task CopySyncCommand()
    {
        var command = $"lrm cloud sync --project {ProjectId}";
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", command);
            NotificationService.Notify(NotificationSeverity.Success, "Copied", "CLI command copied to clipboard!");
        }
        catch
        {
            NotificationService.Notify(NotificationSeverity.Info, "CLI Command", command);
        }
    }

    private static string GetRelativeTime(DateTime dateTime)
    {
        var diff = DateTime.UtcNow - dateTime;
        if (diff.TotalSeconds < 60)
            return "just now";
        if (diff.TotalMinutes < 60)
            return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours < 24)
            return $"{(int)diff.TotalHours}h ago";
        if (diff.TotalDays < 7)
            return $"{(int)diff.TotalDays}d ago";
        return dateTime.ToString("MMM dd");
    }
}
