@page "/projects/{ProjectId:int}"
@attribute [Authorize]
@using LrmCloud.Web.Helpers
@using LrmCloud.Shared.DTOs.Translation
@inject ProjectService ProjectService
@inject ResourceService ResourceService
@inject TranslationService TranslationService
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService
@inject IJSRuntime JS

<PageTitle>@(_project?.Name ?? "Project") - LRM Cloud</PageTitle>

@if (_isLoading)
{
    <RadzenStack Gap="1rem">
        <RadzenSkeleton Style="height: 120px; width: 100%;" />
        <RadzenSkeleton Style="height: 200px; width: 100%;" />
    </RadzenStack>
}
else if (_project == null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" AllowClose="false">
        Project not found or you don't have access to it.
        <RadzenButton Variant="Radzen.Variant.Text" ButtonStyle="ButtonStyle.Primary" Text="Go to Dashboard" Click="@(() => Navigation.NavigateTo(""))" />
    </RadzenAlert>
}
else
{
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-4">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
            <RadzenButton Icon="arrow_back" Variant="Radzen.Variant.Text" Click="@(() => Navigation.NavigateTo(""))" Size="ButtonSize.Small" />
            <RadzenText TextStyle="TextStyle.H4">@_project.Name</RadzenText>
            <RadzenBadge BadgeStyle="@UiHelpers.GetFormatBadgeStyle(_project.Format)" Text="@_project.Format" />
        </RadzenStack>

        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
            <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Secondary" Icon="settings"
                          Text="Settings" Click="@(() => Navigation.NavigateTo($"projects/{ProjectId}/settings"))" />
            <RadzenButton Variant="Radzen.Variant.Filled" ButtonStyle="ButtonStyle.Primary" Icon="edit"
                          Text="Open Editor" Click="@(() => Navigation.NavigateTo($"projects/{ProjectId}/editor"))" />
        </RadzenStack>
    </RadzenStack>

    @if (!string.IsNullOrEmpty(_project.Description))
    {
        <RadzenText TextStyle="TextStyle.Body1" class="rz-color-secondary rz-mb-4">@_project.Description</RadzenText>
    }

    <RadzenRow Gap="1rem" class="rz-mb-4">
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Keys</RadzenText>
                        <RadzenText TextStyle="TextStyle.H4">@(_stats?.TotalKeys ?? _project.KeyCount)</RadzenText>
                    </RadzenStack>
                    <RadzenIcon Icon="key" Style="font-size: 2rem; color: var(--rz-primary);" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Languages</RadzenText>
                        <RadzenText TextStyle="TextStyle.H4">@(_stats?.Languages.Count ?? 0)</RadzenText>
                    </RadzenStack>
                    <RadzenIcon Icon="language" Style="font-size: 2rem; color: var(--rz-info);" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Completion</RadzenText>
                        <RadzenText TextStyle="TextStyle.H4">@(_stats?.OverallCompletion.ToString("F0") ?? _project.CompletionPercentage.ToString("F0"))%</RadzenText>
                    </RadzenStack>
                    <RadzenIcon Icon="check_circle" Style="@($"font-size: 2rem; color: {GetCompletionColor(_stats?.OverallCompletion ?? _project.CompletionPercentage)};")" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Last Updated</RadzenText>
                        <RadzenText TextStyle="TextStyle.H6">@_project.UpdatedAt.ToString("MMM dd")</RadzenText>
                    </RadzenStack>
                    <RadzenIcon Icon="schedule" Style="font-size: 2rem;" class="rz-color-secondary" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    @if (_stats != null && _stats.Languages.Any())
    {
        <RadzenText TextStyle="TextStyle.H6" class="rz-mt-6 rz-mb-3">Language Progress</RadzenText>
        <RadzenCard>
            <RadzenStack Gap="1rem">
                @foreach (var lang in _stats.Languages.OrderByDescending(l => l.Value.CompletionPercentage))
                {
                    <RadzenStack Gap="0.25rem">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                                <RadzenText>@lang.Key.ToUpperInvariant()</RadzenText>
                                @if (lang.Key == _project.DefaultLanguage)
                                {
                                    <RadzenBadge BadgeStyle="BadgeStyle.Primary" Variant="Radzen.Variant.Outlined" Text="Default" />
                                }
                            </RadzenStack>
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
                                @lang.Value.TranslatedCount / @_stats.TotalKeys translated
                            </RadzenText>
                        </RadzenStack>
                        <RadzenProgressBar Value="@lang.Value.CompletionPercentage" Max="100"
                                           ProgressBarStyle="@UiHelpers.GetCompletionProgressStyle(lang.Value.CompletionPercentage)"
                                           ShowValue="false" Style="height: 8px;" />
                    </RadzenStack>
                }
            </RadzenStack>
        </RadzenCard>
    }

    <RadzenText TextStyle="TextStyle.H6" class="rz-mt-6 rz-mb-3">Project Details</RadzenText>
    <RadzenCard>
        <RadzenRow Gap="1rem">
            <RadzenColumn Size="12" SizeSM="6">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Project ID (Slug)</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1">@_project.Slug</RadzenText>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeSM="6">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Format</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1">@_project.Format</RadzenText>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeSM="6">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Default Language</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1">@_project.DefaultLanguage</RadzenText>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeSM="6">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Localization Path</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1">@_project.LocalizationPath</RadzenText>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeSM="6">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Organization</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1">@(_project.OrganizationName ?? "Personal")</RadzenText>
            </RadzenColumn>
            @if (!string.IsNullOrEmpty(_project.GitHubRepo))
            {
                <RadzenColumn Size="12" SizeSM="6">
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">GitHub Repository</RadzenText>
                    <RadzenLink Path="@($"https://github.com/{_project.GitHubRepo}")" Target="_blank" Text="@_project.GitHubRepo" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeSM="6">
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Default Branch</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body1">@(_project.GitHubDefaultBranch ?? "main")</RadzenText>
                </RadzenColumn>
            }
            <RadzenColumn Size="12" SizeSM="6">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Created</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1">@_project.CreatedAt.ToString("MMMM dd, yyyy")</RadzenText>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeSM="6">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Last Synced</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1">@(_project.LastSyncedAt?.ToString("MMMM dd, yyyy HH:mm") ?? "Never")</RadzenText>
            </RadzenColumn>
        </RadzenRow>
    </RadzenCard>

    <RadzenText TextStyle="TextStyle.H6" class="rz-mt-6 rz-mb-3">Quick Actions</RadzenText>
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" Wrap="FlexWrap.Wrap">
        <RadzenButton Variant="Radzen.Variant.Outlined" Icon="edit" Text="Open Editor"
                      Click="@(() => Navigation.NavigateTo($"projects/{ProjectId}/editor"))" />
        <RadzenButton Variant="Radzen.Variant.Outlined" Icon="history" Text="View Snapshots"
                      Click="@(() => Navigation.NavigateTo($"projects/{ProjectId}/snapshots"))" />
        <RadzenButton Variant="Radzen.Variant.Outlined" Icon="restore" Text="Sync History"
                      Click="@(() => Navigation.NavigateTo($"projects/{ProjectId}/history"))" />
        <RadzenButton Variant="Radzen.Variant.Outlined" Icon="book" Text="Glossary"
                      Click="@(() => Navigation.NavigateTo($"projects/{ProjectId}/glossary"))" />
        <RadzenButton Variant="Radzen.Variant.Outlined" Icon="translate" Text="Translate All Missing"
                      Click="@OpenTranslateDialog" Disabled="@_isTranslating" IsBusy="@_isTranslating" />
        <RadzenButton Variant="Radzen.Variant.Outlined" Icon="file_download" Text="Export"
                      Click="@ExportProject" />
        <RadzenButton Variant="Radzen.Variant.Outlined" Icon="content_copy" Text="CLI Sync Command"
                      Click="@CopySyncCommand" />
    </RadzenStack>
}

@code {
    [Parameter]
    public int ProjectId { get; set; }

    private ProjectDto? _project;
    private ProjectStatsDto? _stats;
    private bool _isLoading = true;

    // Translate dialog state
    private bool _isTranslating;
    private List<TranslationProviderDto> _availableProviders = new();
    private string? _selectedProvider;
    private HashSet<string> _selectedLanguages = new();

    // Export dialog state
    private string _exportFormat = "json";

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            _project = await ProjectService.GetProjectAsync(ProjectId);
            if (_project != null)
            {
                _stats = await ResourceService.GetProjectStatsAsync(ProjectId);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error loading project: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private static string GetCompletionColor(double percentage) => percentage switch
    {
        >= 90 => "var(--rz-success)",
        >= 50 => "var(--rz-warning)",
        _ => "var(--rz-danger)"
    };

    // =========================================================================
    // Translate All
    // =========================================================================

    private async Task OpenTranslateDialog()
    {
        // Load available providers
        _availableProviders = await TranslationService.GetProvidersAsync(projectId: ProjectId);
        _selectedProvider = _availableProviders.FirstOrDefault(p => p.IsConfigured)?.Name
                          ?? _availableProviders.FirstOrDefault()?.Name;

        // Pre-select languages with missing translations
        _selectedLanguages = _stats?.Languages
            .Where(l => l.Key != _project?.DefaultLanguage && l.Value.CompletionPercentage < 100)
            .Select(l => l.Key)
            .ToHashSet() ?? new HashSet<string>();

        var result = await DialogService.OpenAsync("Translate All Missing", ds =>
            @<RadzenStack Gap="1rem">
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
                    This will translate all missing translations from the default language (@_project?.DefaultLanguage) to the selected target languages.
                </RadzenText>

                <RadzenFormField Text="Translation Provider" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <RadzenDropDown @bind-Value="_selectedProvider" Data="@_availableProviders" TextProperty="DisplayName" ValueProperty="Name" Style="width: 100%;">
                        <Template Context="provider">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                                <span>@provider.DisplayName</span>
                                @if (provider.IsConfigured)
                                {
                                    <RadzenIcon Icon="check" Style="color: var(--rz-success); font-size: 1rem;" />
                                }
                            </RadzenStack>
                        </Template>
                    </RadzenDropDown>
                </RadzenFormField>

                <RadzenText TextStyle="TextStyle.Subtitle2">Target Languages</RadzenText>
                @if (_stats?.Languages != null)
                {
                    <RadzenStack Gap="0.5rem">
                        @foreach (var lang in _stats.Languages.Where(l => l.Key != _project?.DefaultLanguage))
                        {
                            <RadzenCheckBox TValue="bool" Value="@_selectedLanguages.Contains(lang.Key)"
                                            Change="@((bool value) => ToggleLanguage(lang.Key, value))">
                                <Template Context="cb">
                                    @lang.Key.ToUpperInvariant() (@((100 - lang.Value.CompletionPercentage).ToString("F0"))% missing)
                                </Template>
                            </RadzenCheckBox>
                        }
                    </RadzenStack>
                }

                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem" class="rz-mt-4">
                    <RadzenButton Variant="Radzen.Variant.Text" Text="Cancel" Click="@(() => ds.Close(false))" />
                    <RadzenButton ButtonStyle="ButtonStyle.Primary" Text="Translate"
                                  Click="@(() => ds.Close(true))"
                                  Disabled="@(!_selectedLanguages.Any() || string.IsNullOrEmpty(_selectedProvider))"
                                  IsBusy="@_isTranslating" />
                </RadzenStack>
            </RadzenStack>,
            new Radzen.DialogOptions { Width = "500px" });

        if (result == true)
        {
            await ExecuteTranslateAll();
        }
    }

    private void ToggleLanguage(string langCode, bool selected)
    {
        if (selected)
            _selectedLanguages.Add(langCode);
        else
            _selectedLanguages.Remove(langCode);
    }

    private async Task ExecuteTranslateAll()
    {
        if (_project == null || !_selectedLanguages.Any() || string.IsNullOrEmpty(_selectedProvider))
            return;

        _isTranslating = true;
        try
        {
            var request = new TranslateRequestDto
            {
                TargetLanguages = _selectedLanguages.ToList(),
                Provider = _selectedProvider,
                OnlyMissing = true,
                SaveToDatabase = true
            };

            var result = await TranslationService.TranslateKeysAsync(ProjectId, request);

            if (result.Success)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", $"Successfully translated {result.TranslatedCount} items!");

                // Refresh stats
                _stats = await ResourceService.GetProjectStatsAsync(ProjectId);
            }
            else
            {
                var errorMsg = result.Errors?.FirstOrDefault() ?? "Translation failed";
                NotificationService.Notify(NotificationSeverity.Error, "Error", errorMsg);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Translation error: {ex.Message}");
        }
        finally
        {
            _isTranslating = false;
        }
    }

    // =========================================================================
    // Export
    // =========================================================================

    private async Task ExportProject()
    {
        _exportFormat = "json";

        var result = await DialogService.OpenAsync("Export Project", ds =>
            @<RadzenStack Gap="1rem">
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
                    Export your localization resources in various formats.
                </RadzenText>

                <RadzenRadioButtonList @bind-Value="_exportFormat" TValue="string" Orientation="Radzen.Orientation.Vertical">
                    <Items>
                        <RadzenRadioButtonListItem Text="JSON (all languages in one file)" Value="@("json")" />
                        <RadzenRadioButtonListItem Text="CSV (spreadsheet compatible)" Value="@("csv")" />
                        <RadzenRadioButtonListItem Text="@($"Native format ({_project?.Format} files)")" Value="@("native")" />
                    </Items>
                </RadzenRadioButtonList>

                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem" class="rz-mt-4">
                    <RadzenButton Variant="Radzen.Variant.Text" Text="Cancel" Click="@(() => ds.Close(false))" />
                    <RadzenButton ButtonStyle="ButtonStyle.Primary" Icon="download" Text="Download"
                                  Click="@(() => ds.Close(true))"
                                  Disabled="@(string.IsNullOrEmpty(_exportFormat))" />
                </RadzenStack>
            </RadzenStack>,
            new Radzen.DialogOptions { Width = "400px" });

        if (result == true)
        {
            await ExecuteExport();
        }
    }

    private async Task ExecuteExport()
    {
        if (_project == null)
            return;

        // For now, show a message about using CLI
        // In the future, this could download files directly
        NotificationService.Notify(NotificationSeverity.Info, "Export",
            $"Export to {_exportFormat.ToUpper()} format - Use CLI: lrm cloud sync --project {ProjectId} --export {_exportFormat}");
    }

    // =========================================================================
    // CLI Command
    // =========================================================================

    private async Task CopySyncCommand()
    {
        var command = $"lrm cloud sync --project {ProjectId}";
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", command);
            NotificationService.Notify(NotificationSeverity.Success, "Copied", "CLI command copied to clipboard!");
        }
        catch
        {
            NotificationService.Notify(NotificationSeverity.Info, "CLI Command", command);
        }
    }
}
