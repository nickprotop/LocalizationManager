@page "/projects/{ProjectId:int}"
@attribute [Authorize]
@using LrmCloud.Web.Helpers
@using LrmCloud.Shared.DTOs.Translation
@inject ProjectService ProjectService
@inject ResourceService ResourceService
@inject TranslationService TranslationService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IJSRuntime JS

<PageTitle>@(_project?.Name ?? "Project") - LRM Cloud</PageTitle>

@if (_isLoading)
{
    <MudStack Spacing="4">
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="120px" />
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="200px" />
    </MudStack>
}
else if (_project == null)
{
    <MudAlert Severity="Severity.Error">
        Project not found or you don't have access to it.
        <MudButton Variant="Variant.Text" Color="Color.Primary" Href="">Go to Dashboard</MudButton>
    </MudAlert>
}
else
{
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                           OnClick="@(() => Navigation.NavigateTo(""))"
                           Size="Size.Small" />
            <MudText Typo="Typo.h4">@_project.Name</MudText>
            <MudChip T="string" Size="Size.Small" Color="@UiHelpers.GetFormatColor(_project.Format)">@_project.Format</MudChip>
        </MudStack>

        <MudStack Row="true" Spacing="2">
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Secondary"
                       StartIcon="@Icons.Material.Filled.Settings"
                       OnClick="@(() => Navigation.NavigateTo($"projects/{ProjectId}/settings"))">
                Settings
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Edit"
                       OnClick="@(() => Navigation.NavigateTo($"projects/{ProjectId}/editor"))">
                Open Editor
            </MudButton>
        </MudStack>
    </MudStack>

    @if (!string.IsNullOrEmpty(_project.Description))
    {
        <MudText Typo="Typo.body1" Class="mb-4" Color="Color.Secondary">@_project.Description</MudText>
    }

    <MudGrid>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Keys</MudText>
                        <MudText Typo="Typo.h4">@(_stats?.TotalKeys ?? _project.KeyCount)</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.Key" Color="Color.Primary" Size="Size.Large" />
                </MudStack>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Languages</MudText>
                        <MudText Typo="Typo.h4">@(_stats?.Languages.Count ?? 0)</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.Language" Color="Color.Info" Size="Size.Large" />
                </MudStack>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Completion</MudText>
                        <MudText Typo="Typo.h4">@(_stats?.OverallCompletion.ToString("F0") ?? _project.CompletionPercentage.ToString("F0"))%</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="@UiHelpers.GetCompletionColor(_stats?.OverallCompletion ?? _project.CompletionPercentage)" Size="Size.Large" />
                </MudStack>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <div>
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Last Updated</MudText>
                        <MudText Typo="Typo.h6">@_project.UpdatedAt.ToString("MMM dd")</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.Schedule" Color="Color.Secondary" Size="Size.Large" />
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>

    @if (_stats != null && _stats.Languages.Any())
    {
        <MudText Typo="Typo.h6" Class="mt-6 mb-3">Language Progress</MudText>
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Spacing="3">
                @foreach (var lang in _stats.Languages.OrderByDescending(l => l.Value.CompletionPercentage))
                {
                    <div>
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudText Typo="Typo.body1">@lang.Key.ToUpperInvariant()</MudText>
                                @if (lang.Key == _project.DefaultLanguage)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined">Default</MudChip>
                                }
                            </MudStack>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                @lang.Value.TranslatedCount / @_stats.TotalKeys translated
                            </MudText>
                        </MudStack>
                        <MudProgressLinear Value="@lang.Value.CompletionPercentage"
                                           Color="@UiHelpers.GetCompletionColor(lang.Value.CompletionPercentage)"
                                           Class="mt-1" />
                    </div>
                }
            </MudStack>
        </MudPaper>
    }

    <MudText Typo="Typo.h6" Class="mt-6 mb-3">Project Details</MudText>
    <MudPaper Class="pa-4" Elevation="2">
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Format</MudText>
                <MudText Typo="Typo.body1">@_project.Format</MudText>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Default Language</MudText>
                <MudText Typo="Typo.body1">@_project.DefaultLanguage</MudText>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Localization Path</MudText>
                <MudText Typo="Typo.body1">@_project.LocalizationPath</MudText>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Organization</MudText>
                <MudText Typo="Typo.body1">@(_project.OrganizationName ?? "Personal")</MudText>
            </MudItem>
            @if (!string.IsNullOrEmpty(_project.GitHubRepo))
            {
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">GitHub Repository</MudText>
                    <MudLink Href="@($"https://github.com/{_project.GitHubRepo}")" Target="_blank">
                        @_project.GitHubRepo
                    </MudLink>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Default Branch</MudText>
                    <MudText Typo="Typo.body1">@(_project.GitHubDefaultBranch ?? "main")</MudText>
                </MudItem>
            }
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Created</MudText>
                <MudText Typo="Typo.body1">@_project.CreatedAt.ToString("MMMM dd, yyyy")</MudText>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Last Synced</MudText>
                <MudText Typo="Typo.body1">@(_project.LastSyncedAt?.ToString("MMMM dd, yyyy HH:mm") ?? "Never")</MudText>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudText Typo="Typo.h6" Class="mt-6 mb-3">Quick Actions</MudText>
    <MudStack Row="true" Spacing="2" Class="flex-wrap">
        <MudButton Variant="Variant.Outlined"
                   StartIcon="@Icons.Material.Filled.Edit"
                   OnClick="@(() => Navigation.NavigateTo($"projects/{ProjectId}/editor"))">
            Open Editor
        </MudButton>
        <MudButton Variant="Variant.Outlined"
                   StartIcon="@Icons.Material.Filled.History"
                   OnClick="@(() => Navigation.NavigateTo($"projects/{ProjectId}/snapshots"))">
            View Snapshots
        </MudButton>
        <MudButton Variant="Variant.Outlined"
                   StartIcon="@Icons.Material.Filled.Translate"
                   OnClick="@OpenTranslateDialog"
                   Disabled="@_isTranslating">
            @if (_isTranslating)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Translate All Missing
        </MudButton>
        <MudButton Variant="Variant.Outlined"
                   StartIcon="@Icons.Material.Filled.FileDownload"
                   OnClick="@ExportProject">
            Export
        </MudButton>
        <MudButton Variant="Variant.Outlined"
                   StartIcon="@Icons.Material.Filled.ContentCopy"
                   OnClick="@CopySyncCommand">
            CLI Sync Command
        </MudButton>
    </MudStack>
}

@* Translate All Dialog *@
<MudDialog @bind-Visible="_translateDialogVisible" Options="@(new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Translate" Class="mr-2" />
            Translate All Missing
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                This will translate all missing translations from the default language (@_project?.DefaultLanguage) to the selected target languages.
            </MudText>

            <MudSelect T="string" Label="Translation Provider" @bind-Value="_selectedProvider"
                       Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                @foreach (var provider in _availableProviders)
                {
                    <MudSelectItem Value="@provider.Name">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <span>@provider.DisplayName</span>
                            @if (provider.IsConfigured)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="Color.Success" />
                            }
                        </MudStack>
                    </MudSelectItem>
                }
            </MudSelect>

            <MudText Typo="Typo.subtitle2">Target Languages</MudText>
            @if (_stats?.Languages != null)
            {
                <MudStack Spacing="1">
                    @foreach (var lang in _stats.Languages.Where(l => l.Key != _project?.DefaultLanguage))
                    {
                        <MudCheckBox T="bool" Label="@($"{lang.Key.ToUpperInvariant()} ({100 - lang.Value.CompletionPercentage:F0}% missing)")"
                                     Checked="@_selectedLanguages.Contains(lang.Key)"
                                     CheckedChanged="@((bool value) => ToggleLanguage(lang.Key, value))"
                                     Color="Color.Primary" />
                    }
                </MudStack>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@CloseTranslateDialog" Variant="Variant.Text">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="@ExecuteTranslateAll"
                   Disabled="@(!_selectedLanguages.Any() || string.IsNullOrEmpty(_selectedProvider) || _isTranslating)">
            @if (_isTranslating)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Translate
        </MudButton>
    </DialogActions>
</MudDialog>

@* Export Dialog *@
<MudDialog @bind-Visible="_exportDialogVisible" Options="@(new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.FileDownload" Class="mr-2" />
            Export Project
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Export your localization resources in various formats.
            </MudText>

            <MudRadioGroup T="string" @bind-Value="_exportFormat">
                <MudRadio Value="@("json")" Color="Color.Primary">JSON (all languages in one file)</MudRadio>
                <MudRadio Value="@("csv")" Color="Color.Primary">CSV (spreadsheet compatible)</MudRadio>
                <MudRadio Value="@("native")" Color="Color.Primary">Native format (@_project?.Format files)</MudRadio>
            </MudRadioGroup>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@CloseExportDialog" Variant="Variant.Text">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="@ExecuteExport"
                   Disabled="@(string.IsNullOrEmpty(_exportFormat))">
            <MudIcon Icon="@Icons.Material.Filled.Download" Class="mr-1" />
            Download
        </MudButton>
    </DialogActions>
</MudDialog>


@code {
    [Parameter]
    public int ProjectId { get; set; }

    private ProjectDto? _project;
    private ProjectStatsDto? _stats;
    private bool _isLoading = true;

    // Translate dialog state
    private bool _translateDialogVisible;
    private bool _isTranslating;
    private List<TranslationProviderDto> _availableProviders = new();
    private string? _selectedProvider;
    private HashSet<string> _selectedLanguages = new();

    // Export dialog state
    private bool _exportDialogVisible;
    private string _exportFormat = "json";

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            _project = await ProjectService.GetProjectAsync(ProjectId);
            if (_project != null)
            {
                _stats = await ResourceService.GetProjectStatsAsync(ProjectId);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading project: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    // =========================================================================
    // Translate All
    // =========================================================================

    private async Task OpenTranslateDialog()
    {
        // Load available providers
        _availableProviders = await TranslationService.GetProvidersAsync(projectId: ProjectId);
        _selectedProvider = _availableProviders.FirstOrDefault(p => p.IsConfigured)?.Name
                          ?? _availableProviders.FirstOrDefault()?.Name;

        // Pre-select languages with missing translations
        _selectedLanguages = _stats?.Languages
            .Where(l => l.Key != _project?.DefaultLanguage && l.Value.CompletionPercentage < 100)
            .Select(l => l.Key)
            .ToHashSet() ?? new HashSet<string>();

        _translateDialogVisible = true;
    }

    private void CloseTranslateDialog()
    {
        _translateDialogVisible = false;
    }

    private void ToggleLanguage(string langCode, bool selected)
    {
        if (selected)
            _selectedLanguages.Add(langCode);
        else
            _selectedLanguages.Remove(langCode);
    }

    private async Task ExecuteTranslateAll()
    {
        if (_project == null || !_selectedLanguages.Any() || string.IsNullOrEmpty(_selectedProvider))
            return;

        _isTranslating = true;
        try
        {
            var request = new TranslateRequestDto
            {
                TargetLanguages = _selectedLanguages.ToList(),
                Provider = _selectedProvider,
                OnlyMissing = true,
                SaveToDatabase = true
            };

            var result = await TranslationService.TranslateKeysAsync(ProjectId, request);

            if (result.Success)
            {
                Snackbar.Add($"Successfully translated {result.TranslatedCount} items!", Severity.Success);
                _translateDialogVisible = false;

                // Refresh stats
                _stats = await ResourceService.GetProjectStatsAsync(ProjectId);
            }
            else
            {
                var errorMsg = result.Errors?.FirstOrDefault() ?? "Translation failed";
                Snackbar.Add(errorMsg, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Translation error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isTranslating = false;
        }
    }

    // =========================================================================
    // Export
    // =========================================================================

    private void ExportProject()
    {
        _exportFormat = "json";
        _exportDialogVisible = true;
    }

    private void CloseExportDialog()
    {
        _exportDialogVisible = false;
    }

    private async Task ExecuteExport()
    {
        if (_project == null)
            return;

        // For now, show a message about using CLI
        // In the future, this could download files directly
        Snackbar.Add($"Export to {_exportFormat.ToUpper()} format - Use CLI: lrm cloud sync --project {ProjectId} --export {_exportFormat}", Severity.Info);
        _exportDialogVisible = false;
    }

    // =========================================================================
    // CLI Command
    // =========================================================================

    private async Task CopySyncCommand()
    {
        var command = $"lrm cloud sync --project {ProjectId}";
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", command);
            Snackbar.Add("CLI command copied to clipboard!", Severity.Success);
        }
        catch
        {
            Snackbar.Add($"CLI command: {command}", Severity.Info);
        }
    }
}
