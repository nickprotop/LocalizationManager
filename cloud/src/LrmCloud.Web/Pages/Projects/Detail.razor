@page "/projects/{ProjectId:int}"
@page "/projects/{ProjectId:int}/{Tab}"
@attribute [Authorize]
@using LrmCloud.Web.Components
@using LrmCloud.Web.Helpers
@using LrmCloud.Web.Pages.Projects.Tabs
@using LrmCloud.Shared.DTOs.Translation
@using LrmCloud.Shared.DTOs.Resources
@inject ProjectService ProjectService
@inject ResourceService ResourceService
@inject TranslationService TranslationService
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService
@inject Radzen.ContextMenuService _contextMenuService
@inject IJSRuntime JS

<PageTitle>@(_project?.Name ?? "Project") - LRM Cloud</PageTitle>

@if (_isLoading)
{
    <RadzenStack Gap="1rem">
        <RadzenSkeleton Style="height: 120px; width: 100%;" />
        <RadzenSkeleton Style="height: 200px; width: 100%;" />
    </RadzenStack>
}
else if (_project == null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" AllowClose="false">
        Project not found or you don't have access to it.
        <RadzenButton Variant="Radzen.Variant.Text" ButtonStyle="ButtonStyle.Primary" Text="Go to Dashboard" Click="@(() => Navigation.NavigateTo(""))" />
    </RadzenAlert>
}
else
{
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" Wrap="FlexWrap.Wrap" Gap="0.5rem" class="rz-mb-4">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Wrap="FlexWrap.Wrap" Gap="0.5rem">
            <RadzenButton Icon="arrow_back" Variant="Radzen.Variant.Text" Click="@(() => Navigation.NavigateTo(""))" Size="ButtonSize.Small" />
            <RadzenText TextStyle="TextStyle.H4" Style="margin: 0;">@_project.Name</RadzenText>
            @if (!string.IsNullOrEmpty(_project.GitHubRepo))
            {
                <RadzenBadge BadgeStyle="BadgeStyle.Dark"
                             Style="cursor: pointer;"
                             Title="@_project.GitHubRepo"
                             Click="@(() => SelectTab("github"))">
                    <RadzenIcon Icon="@UiHelpers.GetGitHubStatusIcon(_project.SyncStatus)" Style="font-size: 0.875rem;" /> GitHub
                </RadzenBadge>
            }
        </RadzenStack>

        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
            <RadzenButton Variant="Radzen.Variant.Outlined" Icon="download"
                          Text="Export" Click="@OpenExportDialog" />
            <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Secondary" Icon="settings"
                          Text="Settings" Click="@(() => Navigation.NavigateTo($"projects/{ProjectId}/settings"))" />
        </RadzenStack>
    </RadzenStack>

    @if (!string.IsNullOrEmpty(_project.Description))
    {
        <RadzenText TextStyle="TextStyle.Body1" class="rz-color-secondary rz-mb-4">@_project.Description</RadzenText>
    }

    <RadzenRow Gap="1rem" class="rz-mb-4">
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Keys</RadzenText>
                        <RadzenText TextStyle="TextStyle.H4">@(_stats?.TotalKeys ?? _project.KeyCount)</RadzenText>
                    </RadzenStack>
                    <RadzenIcon Icon="key" Style="font-size: 2rem; color: var(--rz-primary);" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Languages</RadzenText>
                        <RadzenText TextStyle="TextStyle.H4">@(_stats?.Languages.Count ?? 0)</RadzenText>
                    </RadzenStack>
                    <RadzenIcon Icon="language" Style="font-size: 2rem; color: var(--rz-info);" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Completion</RadzenText>
                        <RadzenText TextStyle="TextStyle.H4">@(_stats?.OverallCompletion.ToString("F0") ?? _project.CompletionPercentage.ToString("F0"))%</RadzenText>
                    </RadzenStack>
                    <RadzenIcon Icon="check_circle" Style="@($"font-size: 2rem; color: {GetCompletionColor(_stats?.OverallCompletion ?? _project.CompletionPercentage)};")" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Last Updated</RadzenText>
                        <RadzenText TextStyle="TextStyle.H6">@_project.UpdatedAt.ToString("MMM dd")</RadzenText>
                    </RadzenStack>
                    <RadzenIcon Icon="schedule" Style="font-size: 2rem;" class="rz-color-secondary" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    @* Actions *@
    <RadzenCard class="rz-mb-4">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" Wrap="FlexWrap.Wrap" Gap="0.5rem">
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" Wrap="FlexWrap.Wrap" AlignItems="Radzen.AlignItems.Center">
                <RadzenButton Variant="Radzen.Variant.Filled" ButtonStyle="ButtonStyle.Primary" Icon="edit"
                              Text="Open Editor" Click="@(() => Navigation.NavigateTo($"projects/{ProjectId}/editor"))" />
                <span class="toolbar-divider"></span>
                <RadzenButton Icon="dashboard" Text="Overview"
                              Variant="@GetButtonVariant("overview")"
                              ButtonStyle="@GetButtonStyle("overview")"
                              class="@GetButtonClass("overview")"
                              Click="@(() => SelectTab("overview"))" />
                <RadzenButton Icon="code" Text="GitHub Sync"
                              Variant="@GetButtonVariant("github")"
                              ButtonStyle="@GetButtonStyle("github")"
                              class="@GetButtonClass("github")"
                              Click="@(() => SelectTab("github"))" />
                <RadzenButton Icon="history" Text="Snapshots"
                              Variant="@GetButtonVariant("snapshots")"
                              ButtonStyle="@GetButtonStyle("snapshots")"
                              class="@GetButtonClass("snapshots")"
                              Click="@(() => SelectTab("snapshots"))" />
                <RadzenButton Icon="restore" Text="History"
                              Variant="@GetButtonVariant("history")"
                              ButtonStyle="@GetButtonStyle("history")"
                              class="@GetButtonClass("history")"
                              Click="@(() => SelectTab("history"))" />
                <RadzenButton Icon="book" Text="Glossary"
                              Variant="@GetButtonVariant("glossary")"
                              ButtonStyle="@GetButtonStyle("glossary")"
                              class="@GetButtonClass("glossary")"
                              Click="@(() => SelectTab("glossary"))" />
                <RadzenButton Icon="verified" Text="Validation"
                              Variant="@GetButtonVariant("validation")"
                              ButtonStyle="@GetButtonStyle("validation")"
                              class="@GetButtonClass("validation")"
                              Click="@(() => SelectTab("validation"))" />
            </RadzenStack>
            <RadzenButton Text="Actions" Icon="expand_more" Variant="Radzen.Variant.Text"
                          ButtonStyle="ButtonStyle.Secondary"
                          Click="@(args => _contextMenuService.Open(args, _actionMenuItems, OnActionMenuClick))" />
        </RadzenStack>
    </RadzenCard>

    @* Tab Content *@
    <div>
        @switch (_activeTab)
        {
            case "overview":
                <OverviewTab ProjectId="ProjectId" Project="_project" Stats="_stats" Validation="_validation"
                             OnViewValidation="@(() => SelectTab("validation"))" />
                break;
            case "github":
                <GitHubTab ProjectId="ProjectId" />
                break;
            case "snapshots":
                <SnapshotsTab ProjectId="ProjectId" />
                break;
            case "history":
                <HistoryTab ProjectId="ProjectId" />
                break;
            case "glossary":
                <GlossaryTab ProjectId="ProjectId" />
                break;
            case "validation":
                <ValidationTab ProjectId="ProjectId" />
                break;
            default:
                <OverviewTab ProjectId="ProjectId" Project="_project" Stats="_stats" Validation="_validation"
                             OnViewValidation="@(() => SelectTab("validation"))" />
                break;
        }
    </div>
}

@code {
    [Parameter]
    public int ProjectId { get; set; }

    [Parameter]
    public string? Tab { get; set; }

    private ProjectDto? _project;
    private ProjectStatsDto? _stats;
    private ValidationResultDto? _validation;
    private bool _isLoading = true;
    private string _activeTab = "overview";


    // Actions context menu
    private readonly List<ContextMenuItem> _actionMenuItems = new()
    {
        new ContextMenuItem { Text = "Translate Missing", Value = "translate", Icon = "translate" },
        new ContextMenuItem { Text = "Export", Value = "export", Icon = "file_download" }
    };

    private void OnActionMenuClick(MenuItemEventArgs args)
    {
        _contextMenuService.Close();
        switch (args.Value?.ToString())
        {
            case "translate":
                InvokeAsync(OpenTranslateDialog);
                break;
            case "export":
                InvokeAsync(ExportProject);
                break;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    protected override void OnParametersSet()
    {
        // Map URL tab to active tab
        _activeTab = Tab?.ToLower() switch
        {
            "github" => "github",
            "snapshots" => "snapshots",
            "history" => "history",
            "glossary" => "glossary",
            "validation" => "validation",
            _ => "overview"
        };
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            _project = await ProjectService.GetProjectAsync(ProjectId);
            if (_project != null)
            {
                // Load stats and validation in parallel
                var statsTask = ResourceService.GetProjectStatsAsync(ProjectId);
                var validationTask = ResourceService.ValidateProjectAsync(ProjectId);
                await Task.WhenAll(statsTask, validationTask);
                _stats = await statsTask;
                _validation = await validationTask;
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error loading project: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void SelectTab(string tab)
    {
        _activeTab = tab;
        // Update URL without full navigation
        var url = tab == "overview" ? $"projects/{ProjectId}" : $"projects/{ProjectId}/{tab}";
        Navigation.NavigateTo(url, replace: true);
    }

    private Radzen.Variant GetButtonVariant(string tab) =>
        _activeTab == tab ? Radzen.Variant.Flat : Radzen.Variant.Text;

    private ButtonStyle GetButtonStyle(string tab) =>
        _activeTab == tab ? ButtonStyle.Light : ButtonStyle.Secondary;

    private string GetButtonClass(string tab) =>
        _activeTab == tab ? "tab-button-selected" : "";

    private static string GetCompletionColor(double percentage) => percentage switch
    {
        >= 90 => "var(--rz-success)",
        >= 50 => "var(--rz-warning)",
        _ => "var(--rz-danger)"
    };

    // =========================================================================
    // Translate All
    // =========================================================================

    private async Task OpenTranslateDialog()
    {
        if (_project == null || _stats == null) return;

        var availableLanguages = _stats.Languages.Keys.ToList();

        var result = await DialogService.OpenAsync<TranslateDialog>("Translate All Missing",
            new Dictionary<string, object>
            {
                { "ProjectId", ProjectId },
                { "SourceLanguage", _project.DefaultLanguage },
                { "AvailableLanguages", availableLanguages },
                { "KeysToTranslate", new List<string>() }, // Empty = translate all
                { "SaveToDatabase", true }
            },
            new Radzen.DialogOptions { Width = "600px" });

        if (result is TranslateResponseDto translationResult && translationResult.Success)
        {
            // Refresh stats after translation
            _stats = await ResourceService.GetProjectStatsAsync(ProjectId);
        }
    }

    // =========================================================================
    // Export
    // =========================================================================

    private async Task ExportProject()
    {
        await OpenExportDialog();
    }

    private async Task OpenExportDialog()
    {
        if (_project == null || _stats == null)
            return;

        // Build language options from stats (Dictionary<string, LanguageStats>)
        var languages = _stats.Languages
            .Select(kvp => new ExportProjectDialog.LanguageOption
            {
                Value = kvp.Key,
                Text = $"{kvp.Key} ({kvp.Value.TranslatedCount}/{_stats.TotalKeys})"
            })
            .ToList();

        await DialogService.OpenAsync<ExportProjectDialog>("Export Project",
            new Dictionary<string, object>
            {
                { "ProjectId", ProjectId },
                { "Languages", languages }
            },
            new Radzen.DialogOptions { Width = "450px" });
    }
}
