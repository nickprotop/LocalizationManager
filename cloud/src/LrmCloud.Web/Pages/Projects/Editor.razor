@page "/projects/{ProjectId:int}/editor"
@attribute [Authorize]
@inject ProjectService ProjectService
@inject ResourceService ResourceService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@inject IDialogService DialogService
@implements IAsyncDisposable
@using LrmCloud.Web.Models
@using LrmCloud.Web.Components
@using LrmCloud.Shared.DTOs.Resources
@using MudBlazor

<PageTitle>@(_project?.Name ?? "Editor") - LRM Cloud</PageTitle>

@if (_isLoading)
{
    <MudStack>
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="50px" />
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="calc(100vh - 250px)" />
    </MudStack>
}
else if (_project == null)
{
    <MudAlert Severity="Severity.Error">
        Project not found or you don't have access to it.
        <MudButton Variant="Variant.Text" Color="Color.Primary" Href="">Go to Dashboard</MudButton>
    </MudAlert>
}
else
{
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                           OnClick="@(() => Navigation.NavigateTo($"projects/{ProjectId}"))"
                           Size="Size.Small" />
            <MudText Typo="Typo.h5">@_project.Name</MudText>
            <MudChip T="string" Size="Size.Small" Color="@GetFormatColor(_project.Format)">@_project.Format</MudChip>
        </MudStack>

        <MudStack Row="true" Spacing="2">
            @if (_hasUnsavedChanges)
            {
                <MudChip T="string" Color="Color.Warning" Size="Size.Small">Unsaved changes</MudChip>
            }
            <MudButton Variant="Variant.Outlined"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Refresh"
                       OnClick="@RefreshData"
                       Disabled="_isRefreshing">
                @if (_isRefreshing)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                }
                Refresh
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Save"
                       OnClick="@SaveChanges"
                       Disabled="@(!_hasUnsavedChanges || _isSaving)">
                @if (_isSaving)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                }
                Save
            </MudButton>
        </MudStack>
    </MudStack>

    @if (_stats != null)
    {
        <MudStack Row="true" Class="mb-4" Spacing="2">
            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">
                @_stats.TotalKeys keys
            </MudChip>
            @foreach (var lang in _stats.Languages)
            {
                <MudTooltip Text="@($"{lang.Value.TranslatedCount}/{_stats.TotalKeys} translated")">
                    <MudChip T="string" Size="Size.Small"
                             Color="@GetCompletionColor(lang.Value.CompletionPercentage)"
                             Variant="Variant.Outlined">
                        @lang.Key: @lang.Value.CompletionPercentage.ToString("F0")%
                    </MudChip>
                </MudTooltip>
            }
        </MudStack>
    }

    <TranslationGrid @ref="_translationGrid"
                     ServerDataFunc="@LoadServerData"
                     Languages="@_languages"
                     DefaultLanguage="@_project.DefaultLanguage"
                     OnRowSelected="@OnRowSelected"
                     OnAddKeyClicked="@OpenAddKeyDialog"
                     OnTranslateClicked="@OnTranslateSelected"
                     OnDeleteClicked="@OnDeleteSelected"
                     OnCellChanged="@OnCellChanged"
                     OnSearchTextChanged="@OnSearchTextChanged" />

    <MudDrawer @bind-Open="_drawerOpen"
               Anchor="Anchor.Right"
               Elevation="1"
               Variant="DrawerVariant.Temporary"
               Width="400px">
        <MudDrawerHeader>
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="width: 100%;">
                <MudText Typo="Typo.h6">Edit Key</MudText>
                <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="@CloseDrawer" Size="Size.Small" />
            </MudStack>
        </MudDrawerHeader>
        <MudDrawerContainer Class="pa-4">
            @if (_selectedRow != null)
            {
                <KeyDetailDrawer Row="@_selectedRow"
                                 Languages="@_languages"
                                 DefaultLanguage="@_project.DefaultLanguage"
                                 OnSave="@SaveKeyDetails"
                                 OnTranslate="@TranslateKey"
                                 OnDelete="@DeleteKey"
                                 IsSaving="_isSavingKey" />
            }
        </MudDrawerContainer>
    </MudDrawer>
}

<AddKeyDialog @ref="_addKeyDialog" OnKeyAdded="@OnKeyAdded" ProjectId="@ProjectId" />
<ConfirmDeleteDialog @ref="_deleteDialog" OnConfirmed="@OnDeleteConfirmed" />

@code {
    [Parameter]
    public int ProjectId { get; set; }

    private ProjectDto? _project;
    private ProjectStatsDto? _stats;
    private List<string> _languages = new();
    private bool _isLoading = true;
    private bool _isRefreshing;
    private bool _isSaving;
    private bool _isSavingKey;
    private bool _hasUnsavedChanges;
    private bool _drawerOpen;
    private TranslationGridRow? _selectedRow;
    private AddKeyDialog? _addKeyDialog;
    private ConfirmDeleteDialog? _deleteDialog;
    private IEnumerable<TranslationGridRow>? _pendingDeleteRows;
    private TranslationGrid? _translationGrid;
    private string _searchText = string.Empty;
    private Dictionary<string, TranslationGridRow> _editedRows = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            _project = await ProjectService.GetProjectAsync(ProjectId);
            if (_project != null)
            {
                _stats = await ResourceService.GetProjectStatsAsync(ProjectId);
                _languages = _stats?.Languages.Keys.ToList() ?? new List<string> { _project.DefaultLanguage };

                // Ensure default language is first
                if (_languages.Contains(_project.DefaultLanguage))
                {
                    _languages.Remove(_project.DefaultLanguage);
                    _languages.Insert(0, _project.DefaultLanguage);
                }
                // Grid will load data via ServerData callback
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading project: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    /// <summary>
    /// Server-side data loading callback for the grid.
    /// </summary>
    private async Task<GridData<TranslationGridRow>> LoadServerData(GridState<TranslationGridRow> state)
    {
        try
        {
            // Get sort info
            var sortDef = state.SortDefinitions.FirstOrDefault();
            var sortBy = sortDef?.SortBy;
            var sortDesc = sortDef?.Descending ?? false;

            // Call paginated API
            var result = await ResourceService.GetResourceKeysPagedAsync(
                ProjectId,
                state.Page + 1,  // MudDataGrid uses 0-indexed pages
                state.PageSize,
                _searchText,
                sortBy,
                sortDesc);

            // Map API results to grid rows
            var rows = new List<TranslationGridRow>();
            foreach (var detail in result.Items)
            {
                // Check if we have a cached edited row
                if (_editedRows.TryGetValue(detail.KeyName, out var editedRow))
                {
                    rows.Add(editedRow);
                    continue;
                }

                var row = new TranslationGridRow
                {
                    KeyId = detail.Id,
                    KeyName = detail.KeyName,
                    KeyPath = detail.KeyPath,
                    IsPlural = detail.IsPlural,
                    Comment = detail.Comment,
                    Version = detail.Version,
                    UpdatedAt = detail.UpdatedAt
                };

                foreach (var translation in detail.Translations)
                {
                    row.Translations[translation.LanguageCode] = new TranslationCell
                    {
                        TranslationId = translation.Id,
                        LanguageCode = translation.LanguageCode,
                        Value = translation.Value,
                        OriginalValue = translation.Value,
                        PluralForm = translation.PluralForm,
                        Status = translation.Status,
                        Version = translation.Version
                    };
                }

                // Ensure all languages have an entry
                foreach (var lang in _languages)
                {
                    if (!row.Translations.ContainsKey(lang))
                    {
                        row.Translations[lang] = new TranslationCell
                        {
                            LanguageCode = lang,
                            Value = null,
                            OriginalValue = null
                        };
                    }
                }

                rows.Add(row);
            }

            return new GridData<TranslationGridRow>
            {
                Items = rows,
                TotalItems = result.TotalCount
            };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
            return new GridData<TranslationGridRow> { Items = new List<TranslationGridRow>(), TotalItems = 0 };
        }
    }

    private void OnSearchTextChanged(string search)
    {
        _searchText = search;
    }

    private async Task RefreshData()
    {
        if (_hasUnsavedChanges)
        {
            Snackbar.Add("Please save or discard your changes before refreshing", Severity.Warning);
            return;
        }

        _isRefreshing = true;
        try
        {
            _stats = await ResourceService.GetProjectStatsAsync(ProjectId);
            _editedRows.Clear();
            if (_translationGrid != null)
            {
                await _translationGrid.ReloadAsync();
            }
            Snackbar.Add("Data refreshed", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error refreshing: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isRefreshing = false;
        }
    }

    private async Task SaveChanges()
    {
        _isSaving = true;
        var savedCount = 0;
        var errorCount = 0;

        try
        {
            foreach (var row in _editedRows.Values)
            {
                foreach (var (langCode, cell) in row.Translations.Where(t => t.Value.IsDirty))
                {
                    var request = new UpdateTranslationRequest
                    {
                        Value = cell.Value ?? "",
                        PluralForm = cell.PluralForm,
                        Status = "translated"
                    };

                    var result = await ResourceService.UpdateTranslationAsync(
                        ProjectId, row.KeyName, langCode, request);

                    if (result.IsSuccess)
                    {
                        cell.IsDirty = false;
                        cell.OriginalValue = cell.Value;
                        savedCount++;
                    }
                    else
                    {
                        errorCount++;
                    }
                }
            }

            // Remove rows that have no more dirty changes
            var keysToRemove = _editedRows
                .Where(kv => !kv.Value.Translations.Values.Any(t => t.IsDirty))
                .Select(kv => kv.Key)
                .ToList();
            foreach (var key in keysToRemove)
            {
                _editedRows.Remove(key);
            }

            _hasUnsavedChanges = _editedRows.Any(kv => kv.Value.Translations.Values.Any(t => t.IsDirty));

            if (errorCount > 0)
                Snackbar.Add($"Saved {savedCount} translations, {errorCount} failed", Severity.Warning);
            else if (savedCount > 0)
                Snackbar.Add($"Saved {savedCount} translations", Severity.Success);

            // Refresh stats
            _stats = await ResourceService.GetProjectStatsAsync(ProjectId);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private void OnRowSelected(TranslationGridRow row)
    {
        _selectedRow = row;
        _drawerOpen = true;
    }

    private void CloseDrawer()
    {
        _drawerOpen = false;
        _selectedRow = null;
    }

    private void OnCellChanged((TranslationGridRow Row, string LanguageCode, string Value) args)
    {
        // Track the edited row
        if (!_editedRows.ContainsKey(args.Row.KeyName))
        {
            _editedRows[args.Row.KeyName] = args.Row;
        }
        _hasUnsavedChanges = true;
    }

    private void OpenAddKeyDialog()
    {
        _addKeyDialog?.Open();
    }

    private async Task OnKeyAdded(ResourceKeyDto key)
    {
        await RefreshData();
    }

    private async Task OnTranslateSelected(IEnumerable<TranslationGridRow> rows)
    {
        if (_project == null) return;

        var parameters = new DialogParameters
        {
            { nameof(TranslateDialog.ProjectId), ProjectId },
            { nameof(TranslateDialog.SourceLanguage), _project.DefaultLanguage },
            { nameof(TranslateDialog.AvailableLanguages), _languages },
            { nameof(TranslateDialog.KeysToTranslate), rows.Select(r => r.KeyName).ToList() }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true,
            BackdropClick = false
        };

        var dialog = await DialogService.ShowAsync<TranslateDialog>("Translate", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            // Refresh data after translation
            await RefreshData();
        }
    }

    private void OnDeleteSelected(IEnumerable<TranslationGridRow> rows)
    {
        _pendingDeleteRows = rows;
        _deleteDialog?.Open(
            "Delete Keys",
            $"Are you sure you want to delete {rows.Count()} key(s)? This action cannot be undone.",
            rows.Select(r => r.KeyName).ToList());
    }

    private async Task OnDeleteConfirmed()
    {
        if (_pendingDeleteRows == null) return;

        var deleted = 0;
        var failed = 0;

        foreach (var row in _pendingDeleteRows)
        {
            var result = await ResourceService.DeleteResourceKeyAsync(ProjectId, row.KeyName);
            if (result.IsSuccess)
                deleted++;
            else
                failed++;
        }

        if (failed > 0)
            Snackbar.Add($"Deleted {deleted} keys, {failed} failed", Severity.Warning);
        else
            Snackbar.Add($"Deleted {deleted} keys", Severity.Success);

        _pendingDeleteRows = null;
        await RefreshData();
    }

    private async Task SaveKeyDetails(TranslationGridRow row)
    {
        _isSavingKey = true;
        try
        {
            foreach (var (langCode, cell) in row.Translations.Where(t => t.Value.IsDirty))
            {
                var request = new UpdateTranslationRequest
                {
                    Value = cell.Value ?? "",
                    PluralForm = cell.PluralForm,
                    Status = "translated"
                };

                var result = await ResourceService.UpdateTranslationAsync(
                    ProjectId, row.KeyName, langCode, request);

                if (result.IsSuccess)
                {
                    cell.IsDirty = false;
                    cell.OriginalValue = cell.Value;
                }
            }

            // Remove from edited rows if no more dirty changes
            if (!row.Translations.Values.Any(t => t.IsDirty))
            {
                _editedRows.Remove(row.KeyName);
            }

            Snackbar.Add("Translations saved", Severity.Success);
            _hasUnsavedChanges = _editedRows.Any(kv => kv.Value.Translations.Values.Any(t => t.IsDirty));
            _stats = await ResourceService.GetProjectStatsAsync(ProjectId);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSavingKey = false;
        }
    }

    private async Task TranslateKey(TranslationGridRow row)
    {
        await OnTranslateSelected(new[] { row });
    }

    private async Task DeleteKey(TranslationGridRow row)
    {
        _pendingDeleteRows = new[] { row };
        _deleteDialog?.Open(
            "Delete Key",
            $"Are you sure you want to delete '{row.KeyName}'? This action cannot be undone.",
            new List<string> { row.KeyName });
    }

    private static Color GetFormatColor(string format) => format.ToLower() switch
    {
        "resx" => Color.Primary,
        "json" => Color.Info,
        "i18next" => Color.Secondary,
        _ => Color.Default
    };

    private static Color GetCompletionColor(double percentage) => percentage switch
    {
        >= 90 => Color.Success,
        >= 50 => Color.Warning,
        _ => Color.Error
    };

    // ============================================================
    // Keyboard Shortcuts
    // ============================================================

    private DotNetObjectReference<Editor>? _dotNetRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("lrmKeyboard.init", _dotNetRef);
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_dotNetRef != null)
        {
            await JS.InvokeVoidAsync("lrmKeyboard.dispose");
            _dotNetRef.Dispose();
        }
    }

    [JSInvokable]
    public async Task OnKeyboardSave()
    {
        if (_hasUnsavedChanges && !_isSaving)
        {
            await SaveChanges();
            StateHasChanged();
        }
    }

    [JSInvokable]
    public async Task OnKeyboardSearch()
    {
        // Focus the search input in the grid
        await JS.InvokeVoidAsync("lrmKeyboard.focusElement", ".translation-grid input[type='text']");
    }

    [JSInvokable]
    public void OnKeyboardEscape()
    {
        if (_drawerOpen)
        {
            CloseDrawer();
            StateHasChanged();
        }
    }

    [JSInvokable]
    public void OnKeyboardDelete()
    {
        // This would require getting selected items from the grid
        // For now, just show a message
        Snackbar.Add("Select rows and click Delete to remove keys", Severity.Info);
    }
}
