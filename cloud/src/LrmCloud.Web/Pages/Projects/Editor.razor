@page "/projects/{ProjectId:int}/editor"
@attribute [Authorize]
@inject ProjectService ProjectService
@inject ResourceService ResourceService
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject IJSRuntime JS
@inject Radzen.DialogService DialogService
@inject ReviewWorkflowService WorkflowService
@implements IAsyncDisposable
@using LrmCloud.Web.Models
@using LrmCloud.Web.Components
@using LrmCloud.Web.Helpers
@using LrmCloud.Shared.DTOs.Resources
@using LrmCloud.Shared.DTOs.Translation
@using LrmCloud.Shared.DTOs.Reviews

<PageTitle>@(_project?.Name ?? "Editor") - LRM Cloud</PageTitle>

@if (_isLoading)
{
    <RadzenStack Gap="1rem">
        <RadzenSkeleton Style="height: 50px;" />
        <RadzenSkeleton Style="height: calc(100vh - 250px);" />
    </RadzenStack>
}
else if (_project == null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" AllowClose="false">
        Project not found or you don't have access to it.
        <RadzenButton Variant="Radzen.Variant.Text" ButtonStyle="ButtonStyle.Primary" Text="Go to Dashboard"
                      Click="@(() => Navigation.NavigateTo(""))" />
    </RadzenAlert>
}
else
{
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-4">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
            <RadzenButton Icon="arrow_back" Variant="Radzen.Variant.Text" Size="ButtonSize.Small"
                          Click="@(() => Navigation.NavigateTo($"projects/{ProjectId}"))" />
            <RadzenText TextStyle="TextStyle.H5">@_project.Name</RadzenText>
            <RadzenBadge BadgeStyle="@UiHelpers.GetFormatBadgeStyle(_project.Format)" Text="@_project.Format" />
        </RadzenStack>

        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
            @if (_hasUnsavedChanges)
            {
                <RadzenBadge BadgeStyle="BadgeStyle.Warning" Text="Unsaved changes" />
            }
            <RadzenButton Variant="Radzen.Variant.Outlined" Size="ButtonSize.Small"
                          Icon="refresh" Text="@(_isRefreshing ? "Refreshing..." : "Refresh")"
                          Click="@RefreshData" Disabled="_isRefreshing" IsBusy="_isRefreshing" />
            <RadzenButton ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small"
                          Icon="save" Text="@(_isSaving ? "Saving..." : "Save")"
                          Click="@OpenSaveDialog"
                          Disabled="@(!_hasUnsavedChanges || _isSaving)" IsBusy="_isSaving" />
        </RadzenStack>
    </RadzenStack>

    @if (_stats != null)
    {
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" class="rz-mb-4" Gap="0.5rem" Style="flex-wrap: wrap;">
            <RadzenBadge Variant="Radzen.Variant.Outlined" Text="@($"{_stats.TotalKeys} keys")" />
            @foreach (var lang in _stats.Languages)
            {
                <span title="@($"{lang.Value.TranslatedCount}/{_stats.TotalKeys} translated")">
                    <RadzenBadge Variant="Radzen.Variant.Outlined"
                                 BadgeStyle="@GetCompletionBadgeStyle(lang.Value.CompletionPercentage)"
                                 Text="@($"{lang.Key}: {lang.Value.CompletionPercentage:F0}%")" />
                </span>
            }
        </RadzenStack>
    }

    <div style="display: flex; gap: 1rem;">
        <div style="@(_drawerOpen ? "flex: 1; min-width: 0;" : "flex: 1;")">
            <TranslationGrid @ref="_translationGrid"
                             ServerDataFunc="@LoadServerData"
                             Languages="@_languages"
                             DefaultLanguage="@_project.DefaultLanguage"
                             OnRowSelected="@OnRowSelected"
                             OnAddKeyClicked="@OpenAddKeyDialog"
                             OnTranslateClicked="@OnTranslateSelected"
                             OnDeleteClicked="@OnDeleteSelected"
                             OnCellChanged="@OnCellChanged"
                             OnSearchTextChanged="@OnSearchTextChanged"
                             WorkflowEnabled="@_workflowEnabled"
                             CanReview="@_canReview"
                             CanApprove="@_canApprove"
                             OnReviewClicked="@OnReviewSelected"
                             OnApproveClicked="@OnApproveSelected" />
        </div>

        @if (_drawerOpen && _selectedRow != null)
        {
            <RadzenCard Style="width: 400px; height: fit-content; flex-shrink: 0; position: sticky; top: 1rem;">
                <RadzenStack Gap="1rem">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                        <RadzenText TextStyle="TextStyle.H6">Key Preview</RadzenText>
                        <RadzenButton Icon="close" Variant="Radzen.Variant.Text" Size="ButtonSize.Small" Click="@CloseDrawer" />
                    </RadzenStack>
                    <KeyDetailDrawer Row="@_selectedRow"
                                     Languages="@_languages"
                                     DefaultLanguage="@_project.DefaultLanguage"
                                     OnEdit="@OpenKeyEditorDialog"
                                     OnTranslate="@TranslateKey"
                                     OnDelete="@DeleteKey" />
                </RadzenStack>
            </RadzenCard>
        }
    </div>
}


@code {
    [Parameter]
    public int ProjectId { get; set; }

    private ProjectDto? _project;
    private ProjectStatsDto? _stats;
    private List<string> _languages = new();
    private bool _isLoading = true;
    private bool _isRefreshing;
    private bool _isSaving;
    private bool _hasUnsavedChanges;
    private bool _drawerOpen;
    private TranslationGridRow? _selectedRow;
    private TranslationGrid? _translationGrid;
    private string _searchText = string.Empty;
    private Dictionary<string, TranslationGridRow> _editedRows = new();

    // Save dialog
    private string _saveMessage = "";
    private int _pendingSaveCount;

    // Workflow
    private bool _workflowEnabled;
    private bool _canReview;
    private bool _canApprove;

    private bool SupportsPluralKeys => _project?.Format?.ToLowerInvariant() switch
    {
        "json" => true,
        "i18next" => true,
        "resx" => false,
        _ => false
    };

    private static BadgeStyle GetCompletionBadgeStyle(double percentage) => percentage switch
    {
        >= 90 => BadgeStyle.Success,
        >= 50 => BadgeStyle.Warning,
        _ => BadgeStyle.Danger
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            _project = await ProjectService.GetProjectAsync(ProjectId);
            if (_project != null)
            {
                _stats = await ResourceService.GetProjectStatsAsync(ProjectId);
                _languages = _stats?.Languages.Keys.ToList() ?? new List<string> { _project.DefaultLanguage };

                if (_languages.Contains(_project.DefaultLanguage))
                {
                    _languages.Remove(_project.DefaultLanguage);
                    _languages.Insert(0, _project.DefaultLanguage);
                }

                await LoadWorkflowAsync();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error loading project: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadWorkflowAsync()
    {
        try
        {
            var settings = await WorkflowService.GetWorkflowSettingsAsync(ProjectId);
            if (settings != null)
            {
                _workflowEnabled = settings.ReviewWorkflowEnabled;

                if (_workflowEnabled)
                {
                    _canReview = await WorkflowService.CanReviewAsync(ProjectId);
                    _canApprove = await WorkflowService.CanApproveAsync(ProjectId);
                }
            }
        }
        catch
        {
            _workflowEnabled = false;
        }
    }

    private async Task<Models.GridData<TranslationGridRow>> LoadServerData(Models.GridState<TranslationGridRow> state)
    {
        try
        {
            var sortDef = state.SortDefinitions.FirstOrDefault();
            var sortBy = sortDef?.SortBy;
            var sortDesc = sortDef?.Descending ?? false;

            var result = await ResourceService.GetResourceKeysPagedAsync(
                ProjectId,
                state.Page + 1,
                state.PageSize,
                _searchText,
                sortBy,
                sortDesc);

            var rows = new List<TranslationGridRow>();
            foreach (var detail in result.Items)
            {
                if (_editedRows.TryGetValue(detail.KeyName, out var editedRow))
                {
                    rows.Add(editedRow);
                    continue;
                }

                var row = new TranslationGridRow
                {
                    KeyId = detail.Id,
                    KeyName = detail.KeyName,
                    KeyPath = detail.KeyPath,
                    IsPlural = detail.IsPlural,
                    Comment = detail.Comment,
                    Version = detail.Version,
                    UpdatedAt = detail.UpdatedAt,
                    OriginalComment = detail.Comment,
                    OriginalIsPlural = detail.IsPlural
                };

                foreach (var translation in detail.Translations)
                {
                    var key = detail.IsPlural
                        ? TranslationGridRow.GetKey(translation.LanguageCode, translation.PluralForm)
                        : translation.LanguageCode;

                    row.Translations[key] = new TranslationCell
                    {
                        TranslationId = translation.Id,
                        LanguageCode = translation.LanguageCode,
                        Value = translation.Value,
                        OriginalValue = translation.Value,
                        PluralForm = translation.PluralForm,
                        Status = translation.Status,
                        Version = translation.Version
                    };
                }

                foreach (var lang in _languages)
                {
                    if (detail.IsPlural)
                    {
                        foreach (var pluralForm in PluralForms.Common)
                        {
                            var key = TranslationGridRow.GetKey(lang, pluralForm);
                            if (!row.Translations.ContainsKey(key))
                            {
                                row.Translations[key] = new TranslationCell
                                {
                                    LanguageCode = lang,
                                    PluralForm = pluralForm,
                                    Value = null,
                                    OriginalValue = null
                                };
                            }
                        }
                    }
                    else
                    {
                        if (!row.Translations.ContainsKey(lang))
                        {
                            row.Translations[lang] = new TranslationCell
                            {
                                LanguageCode = lang,
                                Value = null,
                                OriginalValue = null
                            };
                        }
                    }
                }

                rows.Add(row);
            }

            return new Models.GridData<TranslationGridRow>
            {
                Items = rows,
                TotalItems = result.TotalCount
            };
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error loading data: {ex.Message}");
            return new Models.GridData<TranslationGridRow> { Items = new List<TranslationGridRow>(), TotalItems = 0 };
        }
    }

    private void OnSearchTextChanged(string search)
    {
        _searchText = search;
    }

    private async Task RefreshData()
    {
        if (_hasUnsavedChanges)
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Warning", "Please save or discard your changes before refreshing");
            return;
        }

        _isRefreshing = true;
        try
        {
            _stats = await ResourceService.GetProjectStatsAsync(ProjectId);
            _editedRows.Clear();
            if (_translationGrid != null)
            {
                await _translationGrid.ReloadAsync();
            }
            NotificationService.Notify(NotificationSeverity.Success, "Success", "Data refreshed");
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error refreshing: {ex.Message}");
        }
        finally
        {
            _isRefreshing = false;
        }
    }

    private async Task OpenSaveDialog()
    {
        _pendingSaveCount = _editedRows.Values
            .SelectMany(r => r.Translations.Values)
            .Count(t => t.IsDirty);

        var languagesChanged = _editedRows.Values
            .SelectMany(r => r.Translations.Where(t => t.Value.IsDirty))
            .Select(t => t.Key)
            .Distinct()
            .ToList();

        if (languagesChanged.Count == 1)
        {
            _saveMessage = $"Updated {_pendingSaveCount} translations in {languagesChanged[0]}";
        }
        else if (languagesChanged.Count > 1)
        {
            _saveMessage = $"Updated {_pendingSaveCount} translations in {languagesChanged.Count} languages";
        }
        else
        {
            _saveMessage = "Updated via web editor";
        }

        var result = await DialogService.OpenAsync("Save Changes", ds =>
            @<RadzenStack Gap="1rem">
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" AlignItems="Radzen.AlignItems.Center">
                    <RadzenIcon Icon="save" />
                    <RadzenText>@_pendingSaveCount translation(s) will be saved.</RadzenText>
                </RadzenStack>
                <RadzenFormField Text="Message (optional)" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenTextArea @bind-Value="_saveMessage" Rows="2" Style="width: 100%;"
                                        Placeholder="e.g., Updated French translations" />
                    </ChildContent>
                    <Helper>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">This message will be recorded in sync history</RadzenText>
                    </Helper>
                </RadzenFormField>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem">
                    <RadzenButton Variant="Radzen.Variant.Text" Text="Cancel" Click="@(() => ds.Close(false))" />
                    <RadzenButton ButtonStyle="ButtonStyle.Primary" Text="Save Changes" Click="@(() => ds.Close(true))" />
                </RadzenStack>
            </RadzenStack>,
            new Radzen.DialogOptions { Width = "500px" });

        if (result is true)
        {
            await SaveChanges();
        }
    }

    private async Task SaveChanges()
    {
        _isSaving = true;

        try
        {
            var request = new BatchSaveRequest
            {
                Message = _saveMessage
            };

            foreach (var row in _editedRows.Values)
            {
                if (row.IsKeyMetadataDirty && row.Comment != row.OriginalComment)
                {
                    request.KeyChanges.Add(new KeyChangeDto
                    {
                        KeyName = row.KeyName,
                        Comment = row.Comment
                    });
                }

                foreach (var (langKey, cell) in row.Translations.Where(t => t.Value.IsDirty))
                {
                    request.TranslationChanges.Add(new TranslationChangeDto
                    {
                        KeyName = row.KeyName,
                        LanguageCode = cell.LanguageCode,
                        Value = cell.Value ?? "",
                        PluralForm = cell.PluralForm,
                        Status = "translated"
                    });
                }
            }

            var result = await ResourceService.BatchSaveAsync(ProjectId, request);

            if (result.IsSuccess && result.Data != null)
            {
                var response = result.Data;

                foreach (var row in _editedRows.Values)
                {
                    if (row.Comment != row.OriginalComment)
                    {
                        row.OriginalComment = row.Comment;
                    }

                    foreach (var cell in row.Translations.Values.Where(t => t.IsDirty))
                    {
                        cell.IsDirty = false;
                        cell.OriginalValue = cell.Value;
                    }
                }

                var keysToRemove = _editedRows
                    .Where(kv => !kv.Value.Translations.Values.Any(t => t.IsDirty) && !kv.Value.IsKeyMetadataDirty)
                    .Select(kv => kv.Key)
                    .ToList();
                foreach (var key in keysToRemove)
                {
                    _editedRows.Remove(key);
                }

                _hasUnsavedChanges = _editedRows.Any(kv =>
                    kv.Value.Translations.Values.Any(t => t.IsDirty) || kv.Value.IsKeyMetadataDirty);

                var message = $"Saved {response.TranslationsModified} translations";
                if (response.KeysModified > 0)
                {
                    message += $", {response.KeysModified} keys updated";
                }
                if (!string.IsNullOrEmpty(response.HistoryId))
                {
                    message += $" (history: {response.HistoryId})";
                }
                NotificationService.Notify(NotificationSeverity.Success, "Saved", message);

                _stats = await ResourceService.GetProjectStatsAsync(ProjectId);
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error saving: {result.ErrorMessage}");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error saving: {ex.Message}");
        }
        finally
        {
            _isSaving = false;
        }
    }

    private void OnRowSelected(TranslationGridRow row)
    {
        _selectedRow = row;
        _drawerOpen = true;
    }

    private void CloseDrawer()
    {
        _drawerOpen = false;
        _selectedRow = null;
    }

    private void OnCellChanged((TranslationGridRow Row, string LanguageCode, string Value) args)
    {
        if (!_editedRows.ContainsKey(args.Row.KeyName))
        {
            _editedRows[args.Row.KeyName] = args.Row;
        }
        _hasUnsavedChanges = true;
    }

    private async Task OpenAddKeyDialog()
    {
        var result = await DialogService.OpenAsync<AddKeyDialog>("Add Key",
            new Dictionary<string, object> { { "ProjectId", ProjectId } },
            new Radzen.DialogOptions { Width = "500px" });

        if (result is ResourceKeyDto key)
        {
            await RefreshData();
        }
    }

    private async Task OnTranslateSelected(IEnumerable<TranslationGridRow> rows)
    {
        if (_project == null) return;

        var rowList = rows.ToList();
        var sourceTexts = BuildSourceTextsFromRows(rowList, _project.DefaultLanguage);
        var keyMetadata = BuildKeyMetadataFromRows(rowList);

        var result = await DialogService.OpenAsync<TranslateDialog>("Translate",
            new Dictionary<string, object>
            {
                { "ProjectId", ProjectId },
                { "SourceLanguage", _project.DefaultLanguage },
                { "AvailableLanguages", _languages },
                { "KeysToTranslate", rowList.Select(r => r.KeyName).ToList() },
                { "SourceTexts", sourceTexts },
                { "KeyMetadata", keyMetadata }
            },
            new Radzen.DialogOptions { Width = "700px" });

        if (result is TranslateResponseDto translationResult)
        {
            ApplyTranslationsToUI(rowList, translationResult);
        }
    }

    private void ApplyTranslationsToUI(List<TranslationGridRow> rows, TranslateResponseDto translationResult)
    {
        var rowsByKey = rows.ToDictionary(r => r.KeyName);
        var appliedCount = 0;

        foreach (var translationRes in translationResult.Results.Where(r => r.Success))
        {
            if (!rowsByKey.TryGetValue(translationRes.Key, out var row))
            {
                continue;
            }

            var cellKey = string.IsNullOrEmpty(translationRes.PluralForm)
                ? translationRes.TargetLanguage
                : TranslationGridRow.GetKey(translationRes.TargetLanguage, translationRes.PluralForm);

            if (!row.Translations.TryGetValue(cellKey, out var cell))
            {
                cell = new TranslationCell
                {
                    LanguageCode = translationRes.TargetLanguage,
                    PluralForm = translationRes.PluralForm,
                    Value = null,
                    OriginalValue = null
                };
                row.Translations[cellKey] = cell;
            }

            cell.Value = translationRes.TranslatedText;
            cell.IsDirty = true;

            if (!_editedRows.ContainsKey(row.KeyName))
            {
                _editedRows[row.KeyName] = row;
            }

            appliedCount++;
        }

        if (appliedCount > 0)
        {
            _hasUnsavedChanges = true;
            NotificationService.Notify(NotificationSeverity.Info, "Applied", $"Applied {appliedCount} translations. Click Save to persist changes.");
            StateHasChanged();
        }
    }

    private async Task OnDeleteSelected(IEnumerable<TranslationGridRow> rows)
    {
        var rowList = rows.ToList();
        var result = await DialogService.OpenAsync<ConfirmDeleteDialog>("Delete Keys",
            new Dictionary<string, object>
            {
                { "Message", $"Are you sure you want to delete {rowList.Count} key(s)? This action cannot be undone." },
                { "Items", rowList.Select(r => r.KeyName).ToList() }
            },
            new Radzen.DialogOptions { Width = "500px" });

        if (result is true)
        {
            await PerformDelete(rowList);
        }
    }

    private async Task PerformDelete(IEnumerable<TranslationGridRow> rows)
    {
        var deleted = 0;
        var failed = 0;

        foreach (var row in rows)
        {
            var result = await ResourceService.DeleteResourceKeyAsync(ProjectId, row.KeyName);
            if (result.IsSuccess)
                deleted++;
            else
                failed++;
        }

        if (failed > 0)
            NotificationService.Notify(NotificationSeverity.Warning, "Partial Success", $"Deleted {deleted} keys, {failed} failed");
        else
            NotificationService.Notify(NotificationSeverity.Success, "Deleted", $"Deleted {deleted} keys");

        await RefreshData();
    }

    private async Task OpenKeyEditorDialog(TranslationGridRow row)
    {
        if (_project == null) return;

        var editingRow = row.Clone();

        var result = await DialogService.OpenAsync<KeyEditorDialog>("Edit Key",
            new Dictionary<string, object>
            {
                { "Row", editingRow },
                { "Languages", _languages },
                { "DefaultLanguage", _project.DefaultLanguage },
                { "ProjectFormat", _project.Format },
                { "SupportsPluralKeys", SupportsPluralKeys },
                { "OnTranslate", EventCallback.Factory.Create<TranslationGridRow>(this, TranslateKeyInDialog) }
            },
            new Radzen.DialogOptions { Width = "1000px", Height = "90vh" });

        if (result is TranslationGridRow editedRow)
        {
            row.ApplyFrom(editedRow);

            if (!_editedRows.ContainsKey(row.KeyName))
            {
                _editedRows[row.KeyName] = row;
            }

            _hasUnsavedChanges = true;
            _drawerOpen = false;
            _selectedRow = null;

            NotificationService.Notify(NotificationSeverity.Info, "Staged", "Changes staged. Click Save to persist.");
            StateHasChanged();
        }
    }

    private async Task TranslateKeyInDialog(TranslationGridRow dialogRow)
    {
        if (_project == null) return;

        var rowList = new List<TranslationGridRow> { dialogRow };
        var sourceTexts = BuildSourceTextsFromRows(rowList, _project.DefaultLanguage);
        var keyMetadata = BuildKeyMetadataFromRows(rowList);

        var result = await DialogService.OpenAsync<TranslateDialog>("Translate",
            new Dictionary<string, object>
            {
                { "ProjectId", ProjectId },
                { "SourceLanguage", _project.DefaultLanguage },
                { "AvailableLanguages", _languages },
                { "KeysToTranslate", new List<string> { dialogRow.KeyName } },
                { "SourceTexts", sourceTexts },
                { "KeyMetadata", keyMetadata }
            },
            new Radzen.DialogOptions { Width = "700px" });

        if (result is TranslateResponseDto translationResult)
        {
            ApplyTranslationsToRow(dialogRow, translationResult);
        }
    }

    private void ApplyTranslationsToRow(TranslationGridRow row, TranslateResponseDto translationResult)
    {
        var appliedCount = 0;

        foreach (var translationRes in translationResult.Results.Where(r => r.Success && r.Key == row.KeyName))
        {
            var cellKey = string.IsNullOrEmpty(translationRes.PluralForm)
                ? translationRes.TargetLanguage
                : TranslationGridRow.GetKey(translationRes.TargetLanguage, translationRes.PluralForm);

            if (!row.Translations.TryGetValue(cellKey, out var cell))
            {
                cell = new TranslationCell
                {
                    LanguageCode = translationRes.TargetLanguage,
                    PluralForm = translationRes.PluralForm,
                    Value = null,
                    OriginalValue = null
                };
                row.Translations[cellKey] = cell;
            }

            cell.Value = translationRes.TranslatedText;
            cell.IsDirty = true;
            appliedCount++;
        }

        if (appliedCount > 0)
        {
            NotificationService.Notify(NotificationSeverity.Success, "Applied", $"Applied {appliedCount} translation(s)");
        }
    }

    private async Task TranslateKey(TranslationGridRow row)
    {
        if (_project == null) return;

        var rowList = new List<TranslationGridRow> { row };
        var sourceTexts = BuildSourceTextsFromRows(rowList, _project.DefaultLanguage);
        var keyMetadata = BuildKeyMetadataFromRows(rowList);

        var result = await DialogService.OpenAsync<TranslateDialog>("Translate",
            new Dictionary<string, object>
            {
                { "ProjectId", ProjectId },
                { "SourceLanguage", _project.DefaultLanguage },
                { "AvailableLanguages", _languages },
                { "KeysToTranslate", new List<string> { row.KeyName } },
                { "SourceTexts", sourceTexts },
                { "KeyMetadata", keyMetadata }
            },
            new Radzen.DialogOptions { Width = "700px" });

        if (result is TranslateResponseDto translationResult)
        {
            ApplyTranslationsToUI(rowList, translationResult);
        }
    }

    private Dictionary<string, string> BuildSourceTextsFromRows(List<TranslationGridRow> rows, string defaultLanguage)
    {
        var sourceTexts = new Dictionary<string, string>();

        foreach (var row in rows)
        {
            if (row.IsPlural)
            {
                foreach (var pluralForm in PluralForms.All)
                {
                    var cell = row.GetCell(defaultLanguage, pluralForm);
                    if (cell != null && !string.IsNullOrEmpty(cell.Value))
                    {
                        sourceTexts[$"{row.KeyName}:{pluralForm}"] = cell.Value;
                    }
                }
            }
            else
            {
                var cell = row.Translations.GetValueOrDefault(defaultLanguage);
                if (cell != null && !string.IsNullOrEmpty(cell.Value))
                {
                    sourceTexts[row.KeyName] = cell.Value;
                }
            }
        }

        return sourceTexts;
    }

    private Dictionary<string, KeyTranslationMetadata> BuildKeyMetadataFromRows(List<TranslationGridRow> rows)
    {
        var metadata = new Dictionary<string, KeyTranslationMetadata>();

        foreach (var row in rows)
        {
            metadata[row.KeyName] = new KeyTranslationMetadata
            {
                IsPlural = row.IsPlural
            };
        }

        return metadata;
    }

    private async Task DeleteKey(TranslationGridRow row)
    {
        var result = await DialogService.OpenAsync<ConfirmDeleteDialog>("Delete Key",
            new Dictionary<string, object>
            {
                { "Message", $"Are you sure you want to delete '{row.KeyName}'? This action cannot be undone." },
                { "Items", new List<string> { row.KeyName } }
            },
            new Radzen.DialogOptions { Width = "500px" });

        if (result is true)
        {
            await PerformDelete(new[] { row });
        }
    }

    private async Task OnReviewSelected(IEnumerable<TranslationGridRow> rows)
    {
        if (_project == null || !_workflowEnabled || !_canReview) return;

        var translationIds = rows
            .SelectMany(r => r.Translations.Values)
            .Where(t => t.TranslationId.HasValue && t.Status == "translated")
            .Select(t => t.TranslationId!.Value)
            .ToList();

        if (!translationIds.Any())
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Warning", "No translations eligible for review (must be in 'translated' status)");
            return;
        }

        try
        {
            var request = new ReviewTranslationsRequest
            {
                TranslationIds = translationIds
            };

            var result = await WorkflowService.ReviewTranslationsAsync(ProjectId, request);
            if (result != null)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Reviewed",
                    $"Reviewed {result.ProcessedCount} translation(s){(result.SkippedCount > 0 ? $", {result.SkippedCount} skipped" : "")}");

                if (_translationGrid != null)
                {
                    await _translationGrid.ReloadAsync();
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error reviewing translations: {ex.Message}");
        }
    }

    private async Task OnApproveSelected(IEnumerable<TranslationGridRow> rows)
    {
        if (_project == null || !_workflowEnabled || !_canApprove) return;

        var translationIds = rows
            .SelectMany(r => r.Translations.Values)
            .Where(t => t.TranslationId.HasValue && (t.Status == "reviewed" || t.Status == "translated"))
            .Select(t => t.TranslationId!.Value)
            .ToList();

        if (!translationIds.Any())
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Warning", "No translations eligible for approval (must be in 'translated' or 'reviewed' status)");
            return;
        }

        try
        {
            var request = new ApproveTranslationsRequest
            {
                TranslationIds = translationIds
            };

            var result = await WorkflowService.ApproveTranslationsAsync(ProjectId, request);
            if (result != null)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Approved",
                    $"Approved {result.ProcessedCount} translation(s){(result.SkippedCount > 0 ? $", {result.SkippedCount} skipped" : "")}");

                if (_translationGrid != null)
                {
                    await _translationGrid.ReloadAsync();
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error approving translations: {ex.Message}");
        }
    }

    // Keyboard Shortcuts
    private DotNetObjectReference<Editor>? _dotNetRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("lrmKeyboard.init", _dotNetRef);
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_dotNetRef != null)
        {
            await JS.InvokeVoidAsync("lrmKeyboard.dispose");
            _dotNetRef.Dispose();
        }
    }

    [JSInvokable]
    public async Task OnKeyboardSave()
    {
        if (_hasUnsavedChanges && !_isSaving)
        {
            await SaveChanges();
            StateHasChanged();
        }
    }

    [JSInvokable]
    public async Task OnKeyboardSearch()
    {
        await JS.InvokeVoidAsync("lrmKeyboard.focusElement", ".translation-grid input[type='text']");
    }

    [JSInvokable]
    public void OnKeyboardEscape()
    {
        if (_drawerOpen)
        {
            CloseDrawer();
            StateHasChanged();
        }
    }

    [JSInvokable]
    public void OnKeyboardDelete()
    {
        NotificationService.Notify(NotificationSeverity.Info, "Tip", "Select rows and click Delete to remove keys");
    }
}
