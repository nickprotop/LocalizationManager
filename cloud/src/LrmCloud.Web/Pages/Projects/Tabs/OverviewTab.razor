@using LrmCloud.Web.Helpers
@using LrmCloud.Shared.DTOs.Resources
@inject ResourceService ResourceService
@inject NavigationManager Navigation
@inject NotificationService NotificationService

@if (_project != null && _stats != null)
{
    @if (_stats.Languages.Any())
    {
        <RadzenText TextStyle="TextStyle.H6" class="rz-mb-3">Language Progress</RadzenText>
        <RadzenCard class="rz-mb-4">
            <RadzenStack Gap="1rem">
                @foreach (var lang in _stats.Languages.OrderByDescending(l => l.Value.CompletionPercentage))
                {
                    <RadzenStack Gap="0.25rem">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                                <RadzenText>@lang.Key.ToUpperInvariant()</RadzenText>
                                @if (lang.Key == _project.DefaultLanguage)
                                {
                                    <RadzenBadge BadgeStyle="BadgeStyle.Primary" Variant="Radzen.Variant.Outlined" Text="Default" />
                                }
                            </RadzenStack>
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
                                @lang.Value.TranslatedCount / @_stats.TotalKeys translated
                            </RadzenText>
                        </RadzenStack>
                        <RadzenProgressBar Value="@lang.Value.CompletionPercentage" Max="100"
                                           ProgressBarStyle="@UiHelpers.GetCompletionProgressStyle(lang.Value.CompletionPercentage)"
                                           ShowValue="false" Style="height: 8px;" />
                    </RadzenStack>
                }
            </RadzenStack>
        </RadzenCard>
    }

    @* Validation Summary Card *@
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-3">
        <RadzenText TextStyle="TextStyle.H6">Validation Status</RadzenText>
        @if (_validation != null)
        {
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                @if (_validation.IsCached && _validation.ValidatedAt.HasValue)
                {
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                        Updated @GetRelativeTime(_validation.ValidatedAt.Value)
                    </RadzenText>
                }
                <RadzenButton Icon="refresh" Variant="Radzen.Variant.Text" Size="ButtonSize.Small"
                              Click="@RefreshValidation" Disabled="@_isValidating"
                              title="Refresh validation" />
            </RadzenStack>
        }
    </RadzenStack>
    <RadzenCard class="rz-mb-4">
        @if (_isValidating)
        {
            <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Style="height: 4px;" />
        }
        else if (_validation == null)
        {
            <RadzenAlert AlertStyle="AlertStyle.Warning" AllowClose="false" Shade="Shade.Lighter">
                Unable to load validation results.
            </RadzenAlert>
        }
        else if (_validation.Summary.TotalIssues == 0)
        {
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                <RadzenIcon Icon="check_circle" Style="font-size: 1.5rem; color: var(--rz-success);" />
                <RadzenText TextStyle="TextStyle.Body1">All validations passed. No issues found.</RadzenText>
            </RadzenStack>
        }
        else
        {
            <RadzenStack Gap="1rem">
                @* Summary row *@
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" Wrap="FlexWrap.Wrap">
                    @if (_validation.Summary.Errors > 0)
                    {
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                            <RadzenIcon Icon="error" Style="color: var(--rz-danger);" />
                            <RadzenText><strong>@_validation.Summary.Errors</strong> errors</RadzenText>
                        </RadzenStack>
                    }
                    @if (_validation.Summary.Warnings > 0)
                    {
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                            <RadzenIcon Icon="warning" Style="color: var(--rz-warning);" />
                            <RadzenText><strong>@_validation.Summary.Warnings</strong> warnings</RadzenText>
                        </RadzenStack>
                    }
                    @if (_validation.Summary.Info > 0)
                    {
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                            <RadzenIcon Icon="info" Style="color: var(--rz-info);" />
                            <RadzenText><strong>@_validation.Summary.Info</strong> info</RadzenText>
                        </RadzenStack>
                    }
                </RadzenStack>

                @* Category breakdown *@
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" Wrap="FlexWrap.Wrap">
                    @if (_validation.Summary.DuplicateKeys > 0)
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Danger" Variant="Radzen.Variant.Outlined"
                                     Text="@($"{_validation.Summary.DuplicateKeys} duplicate{(_validation.Summary.DuplicateKeys != 1 ? "s" : "")}")" />
                    }
                    @if (_validation.Summary.MissingTranslations > 0)
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Warning" Variant="Radzen.Variant.Outlined"
                                     Text="@($"{_validation.Summary.MissingTranslations} missing")" />
                    }
                    @if (_validation.Summary.EmptyValues > 0)
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Warning" Variant="Radzen.Variant.Outlined"
                                     Text="@($"{_validation.Summary.EmptyValues} empty")" />
                    }
                    @if (_validation.Summary.PlaceholderMismatches > 0)
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Warning" Variant="Radzen.Variant.Outlined"
                                     Text="@($"{_validation.Summary.PlaceholderMismatches} placeholder{(_validation.Summary.PlaceholderMismatches != 1 ? "s" : "")}")" />
                    }
                    @if (_validation.Summary.PendingReview > 0)
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Info" Variant="Radzen.Variant.Outlined"
                                     Text="@($"{_validation.Summary.PendingReview} pending review")" />
                    }
                </RadzenStack>

                @* View details link *@
                <RadzenButton Variant="Radzen.Variant.Text" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small"
                              Icon="open_in_new" Text="View Full Report"
                              Click="@(() => OnViewValidation.InvokeAsync())" />
            </RadzenStack>
        }
    </RadzenCard>

    <RadzenText TextStyle="TextStyle.H6" class="rz-mb-3">Project Details</RadzenText>
    <RadzenCard>
        <RadzenRow Gap="1rem">
            <RadzenColumn Size="12" SizeSM="6">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Project ID (Slug)</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1">@_project.Slug</RadzenText>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeSM="6">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Default Language</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1">@_project.DefaultLanguage</RadzenText>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeSM="6">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Organization</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1">@(_project.OrganizationName ?? "Personal")</RadzenText>
            </RadzenColumn>
            @if (!string.IsNullOrEmpty(_project.GitHubRepo))
            {
                <RadzenColumn Size="12" SizeSM="6">
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">GitHub</RadzenText>
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" AlignItems="Radzen.AlignItems.Center">
                        <RadzenIcon Icon="@UiHelpers.GetGitHubStatusIcon(_project.SyncStatus)"
                                   Style="@UiHelpers.GetGitHubStatusColor(_project.SyncStatus)" />
                        <RadzenText>@_project.GitHubRepo</RadzenText>
                    </RadzenStack>
                    @if (_project.LastSyncedAt.HasValue)
                    {
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                            Last synced @UiHelpers.GetRelativeTime(_project.LastSyncedAt.Value)
                        </RadzenText>
                    }
                </RadzenColumn>
                <RadzenColumn Size="12" SizeSM="6">
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Default Branch</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body1">@(_project.GitHubDefaultBranch ?? "main")</RadzenText>
                </RadzenColumn>
            }
            <RadzenColumn Size="12" SizeSM="6">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Created</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1">@_project.CreatedAt.ToString("MMMM dd, yyyy")</RadzenText>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeSM="6">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Last Synced</RadzenText>
                <RadzenText TextStyle="TextStyle.Body1">@(_project.LastSyncedAt?.ToString("MMMM dd, yyyy HH:mm") ?? "Never")</RadzenText>
            </RadzenColumn>
        </RadzenRow>
    </RadzenCard>
}
else
{
    <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
}

@code {
    [Parameter] public int ProjectId { get; set; }
    [Parameter] public ProjectDto? Project { get; set; }
    [Parameter] public ProjectStatsDto? Stats { get; set; }
    [Parameter] public ValidationResultDto? Validation { get; set; }
    [Parameter] public EventCallback OnViewValidation { get; set; }

    private ProjectDto? _project;
    private ProjectStatsDto? _stats;
    private ValidationResultDto? _validation;
    private bool _isValidating = false;

    protected override void OnParametersSet()
    {
        _project = Project;
        _stats = Stats;
        _validation = Validation;
    }

    private async Task RefreshValidation()
    {
        _isValidating = true;
        try
        {
            _validation = await ResourceService.ValidateProjectAsync(ProjectId, forceRefresh: true);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Validation failed: {ex.Message}");
        }
        finally
        {
            _isValidating = false;
        }
    }

    private static string GetRelativeTime(DateTime dateTime)
    {
        var diff = DateTime.UtcNow - dateTime;
        if (diff.TotalSeconds < 60)
            return "just now";
        if (diff.TotalMinutes < 60)
            return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours < 24)
            return $"{(int)diff.TotalHours}h ago";
        if (diff.TotalDays < 7)
            return $"{(int)diff.TotalDays}d ago";
        return dateTime.ToString("MMM dd");
    }
}
