@page "/projects/{ProjectId:int}/settings"
@attribute [Authorize]
@using LrmCloud.Shared.DTOs.Projects
@using LrmCloud.Shared.DTOs.Resources
@using LrmCloud.Shared.DTOs.Translation
@using LrmCloud.Shared.DTOs.Organizations
@using LrmCloud.Shared.DTOs.Reviews
@using LrmCloud.Web.Helpers
@inject ProjectService ProjectService
@inject ReviewWorkflowService WorkflowService
@inject ResourceService ResourceService
@inject TranslationService TranslationService
@inject OrganizationService OrganizationService
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService

<PageTitle>Settings - @(_project?.Name ?? "Project") - LRM Cloud</PageTitle>

@if (_isLoading)
{
    <RadzenStack Gap="1rem">
        <RadzenSkeleton Style="height: 60px;" />
        <RadzenSkeleton Style="height: 400px;" />
    </RadzenStack>
}
else if (_project == null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" AllowClose="false">
        Project not found or you don't have access to it.
        <RadzenButton Variant="Radzen.Variant.Text" ButtonStyle="ButtonStyle.Primary" Text="Go to Dashboard" Click="@(() => Navigation.NavigateTo(""))" />
    </RadzenAlert>
}
else
{
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-4">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
            <RadzenButton Icon="arrow_back" Variant="Radzen.Variant.Text" Size="ButtonSize.Small"
                          Click="@(() => Navigation.NavigateTo($"projects/{ProjectId}"))" />
            <RadzenText TextStyle="TextStyle.H4">Project Settings</RadzenText>
            <RadzenText TextStyle="TextStyle.H6" class="rz-color-secondary">@_project.Name</RadzenText>
        </RadzenStack>

        <RadzenButton ButtonStyle="ButtonStyle.Primary" Icon="save" Text="@(_isSubmitting ? "Saving..." : "Save Changes")"
                      Click="@HandleSubmit" Disabled="_isSubmitting" IsBusy="_isSubmitting" />
    </RadzenStack>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Shade="Shade.Lighter" AllowClose="true" class="rz-mb-4">@_errorMessage</RadzenAlert>
    }

    <RadzenTabs @bind-SelectedIndex="_activeTabIndex" RenderMode="TabRenderMode.Server">
        <Tabs>
            <RadzenTabsItem Text="General" Icon="settings">
                <RadzenTemplateForm TItem="UpdateProjectRequest" Data="_model" Submit="HandleSubmit">
                    <RadzenRow Gap="1rem">
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenStack Gap="1rem">
                                <RadzenFormField Text="Project Name" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                                    <ChildContent>
                                        <RadzenTextBox @bind-Value="_model.Name" Name="Name" Disabled="_isSubmitting" Style="width: 100%;" />
                                    </ChildContent>
                                    <Helper>
                                        <RadzenRequiredValidator Component="Name" Text="Project name is required" />
                                    </Helper>
                                </RadzenFormField>

                                <RadzenFormField Text="Description" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                                    <ChildContent>
                                        <RadzenTextArea @bind-Value="_model.Description" Rows="3" Disabled="_isSubmitting" Style="width: 100%;" />
                                    </ChildContent>
                                </RadzenFormField>

                                <RadzenFormField Text="Format" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                                    <ChildContent>
                                        <RadzenTextBox Value="@GetFormatDisplayName(_model.Format)" Disabled="true" ReadOnly="true" Style="width: 100%;" />
                                    </ChildContent>
                                    <Helper>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Format cannot be changed after project creation</RadzenText>
                                    </Helper>
                                </RadzenFormField>

                                <RadzenFormField Text="Default Language" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                                    <ChildContent>
                                        <RadzenTextBox Value="@_model.DefaultLanguage" Disabled="true" ReadOnly="true" Style="width: 100%;" />
                                    </ChildContent>
                                    <Helper>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Default language cannot be changed after project creation</RadzenText>
                                    </Helper>
                                </RadzenFormField>

                                <hr />

                                <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-2">Project Ownership</RadzenText>
                                <RadzenFormField Text="Organization" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                                    <ChildContent>
                                        <RadzenDropDown @bind-Value="_selectedOrganizationId" Data="@GetOrganizationOptions()"
                                                        TextProperty="Name" ValueProperty="Id"
                                                        Disabled="@(_isSubmitting || _loadingOrganizations)" Style="width: 100%;"
                                                        Placeholder="Personal Project" AllowClear="true" />
                                    </ChildContent>
                                    <Helper>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Assign this project to an organization or keep as personal</RadzenText>
                                    </Helper>
                                </RadzenFormField>
                            </RadzenStack>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenCard>
                                <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-2">Project Info</RadzenText>
                                <RadzenStack Gap="0.5rem">
                                    <div>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Created</RadzenText>
                                        <RadzenText>@_project.CreatedAt.ToString("MMMM dd, yyyy")</RadzenText>
                                    </div>
                                    <div>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Last Updated</RadzenText>
                                        <RadzenText>@_project.UpdatedAt.ToString("MMMM dd, yyyy HH:mm")</RadzenText>
                                    </div>
                                    <div>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Current Organization</RadzenText>
                                        <RadzenText>@(_project.OrganizationName ?? "Personal")</RadzenText>
                                    </div>
                                </RadzenStack>
                            </RadzenCard>
                        </RadzenColumn>
                    </RadzenRow>
                </RadzenTemplateForm>
            </RadzenTabsItem>

            <RadzenTabsItem Text="Languages" Icon="language">
                @if (_loadingLanguages)
                {
                    <RadzenProgressBar Value="100" Mode="ProgressBarMode.Indeterminate" ShowValue="false" />
                }
                else
                {
                    <RadzenStack Gap="1rem">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                            <RadzenText TextStyle="TextStyle.Subtitle1">Project Languages</RadzenText>
                            <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small"
                                          Icon="add" Text="Add Language" Click="OpenAddLanguageDialog" />
                        </RadzenStack>

                        @if (_languages.Count == 0)
                        {
                            <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false">
                                No languages in this project yet. Add resource keys first, then add languages.
                            </RadzenAlert>
                        }
                        else
                        {
                            <RadzenDataGrid TItem="ProjectLanguageDto" Data="@_languages" Density="Density.Compact" AllowSorting="false">
                                <Columns>
                                    <RadzenDataGridColumn TItem="ProjectLanguageDto" Title="Language">
                                        <Template Context="lang">
                                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                                                <RadzenText>@lang.LanguageCode</RadzenText>
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">(@lang.DisplayName)</RadzenText>
                                                @if (lang.IsDefault)
                                                {
                                                    <RadzenBadge BadgeStyle="BadgeStyle.Primary" Text="Default" />
                                                }
                                            </RadzenStack>
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="ProjectLanguageDto" Title="Completion" Width="180px">
                                        <Template Context="lang">
                                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                                                <RadzenProgressBar Value="@lang.CompletionPercentage" Max="100"
                                                                   ProgressBarStyle="@UiHelpers.GetCompletionProgressStyle(lang.CompletionPercentage)"
                                                                   Style="width: 100px; height: 6px;" ShowValue="false" />
                                                <RadzenText TextStyle="TextStyle.Caption">@lang.CompletionPercentage%</RadzenText>
                                            </RadzenStack>
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="ProjectLanguageDto" Title="Last Updated" Width="160px">
                                        <Template Context="lang">
                                            @if (lang.LastUpdated.HasValue)
                                            {
                                                @lang.LastUpdated.Value.ToString("g")
                                            }
                                            else
                                            {
                                                <RadzenText class="rz-color-secondary">Never</RadzenText>
                                            }
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="ProjectLanguageDto" Title="Actions" Width="80px" TextAlign="TextAlign.Center">
                                        <Template Context="lang">
                                            @if (!lang.IsDefault)
                                            {
                                                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Variant="Radzen.Variant.Text"
                                                              Size="ButtonSize.Small" Click="@(() => ConfirmRemoveLanguage(lang))" />
                                            }
                                        </Template>
                                    </RadzenDataGridColumn>
                                </Columns>
                            </RadzenDataGrid>
                        }
                    </RadzenStack>
                }
            </RadzenTabsItem>

            <RadzenTabsItem Text="GitHub" Icon="code">
                <RadzenRow Gap="1rem">
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenStack Gap="1rem">
                            <RadzenFormField Text="GitHub Repository" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                                <ChildContent>
                                    <RadzenTextBox @bind-Value="_model.GitHubRepo" Disabled="_isSubmitting" Style="width: 100%;" />
                                </ChildContent>
                                <Helper>
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">e.g., owner/repo</RadzenText>
                                </Helper>
                            </RadzenFormField>

                            <RadzenFormField Text="Default Branch" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                                <ChildContent>
                                    <RadzenTextBox @bind-Value="_model.GitHubDefaultBranch" Disabled="_isSubmitting" Style="width: 100%;" />
                                </ChildContent>
                                <Helper>
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">e.g., main</RadzenText>
                                </Helper>
                            </RadzenFormField>
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false">
                            Link a GitHub repository to enable automatic sync with your source code.
                        </RadzenAlert>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenTabsItem>

            <RadzenTabsItem Text="Translation" Icon="translate">
                @if (_loadingProviders)
                {
                    <RadzenProgressBar Value="100" Mode="ProgressBarMode.Indeterminate" ShowValue="false" />
                }
                else
                {
                    <RadzenStack Gap="1rem">
                        <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false" Size="AlertSize.Small">
                            <strong>Key Hierarchy:</strong> Project keys override Organization and User-level keys.
                            @if (_project?.OrganizationId != null)
                            {
                                <span> Keys configured here will only be used for this project.</span>
                            }
                        </RadzenAlert>

                        @if (!_translationProviders.Any())
                        {
                            <RadzenAlert AlertStyle="AlertStyle.Warning" Shade="Shade.Lighter" AllowClose="false">
                                No translation providers available. Configure your API keys in Settings.
                            </RadzenAlert>
                        }
                        else
                        {
                            <RadzenRow Gap="1rem">
                                @foreach (var provider in _translationProviders)
                                {
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenCard Style="border: 1px solid var(--rz-base-400);">
                                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                                                    <RadzenIcon Icon="@GetProviderIcon(provider.Name)" />
                                                    <RadzenStack Gap="0">
                                                        <RadzenText TextStyle="TextStyle.Subtitle2">@provider.DisplayName</RadzenText>
                                                        @if (provider.IsConfigured)
                                                        {
                                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                                Using: @GetKeySourceLabel(provider.ApiKeySource)
                                                            </RadzenText>
                                                        }
                                                    </RadzenStack>
                                                </RadzenStack>
                                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                                                    @if (provider.IsConfigured)
                                                    {
                                                        <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Configured" />
                                                    }
                                                    @if (provider.ApiKeySource == "project")
                                                    {
                                                        <RadzenButton Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Primary" Variant="Radzen.Variant.Text"
                                                                      Text="Update" Click="@(() => OpenSetProviderKeyDialog(provider))" />
                                                        <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Variant="Radzen.Variant.Text"
                                                                      Size="ButtonSize.Small" Click="@(() => ConfirmRemoveProviderKey(provider))" />
                                                    }
                                                    else
                                                    {
                                                        <RadzenButton Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Primary" Variant="Radzen.Variant.Outlined"
                                                                      Text="Override" Click="@(() => OpenSetProviderKeyDialog(provider))" />
                                                    }
                                                </RadzenStack>
                                            </RadzenStack>
                                        </RadzenCard>
                                    </RadzenColumn>
                                }
                            </RadzenRow>
                        }
                    </RadzenStack>
                }
            </RadzenTabsItem>

            <RadzenTabsItem Text="Workflow" Icon="rate_review">
                @if (_loadingWorkflow)
                {
                    <RadzenProgressBar Value="100" Mode="ProgressBarMode.Indeterminate" ShowValue="false" />
                }
                else if (_workflowSettings == null)
                {
                    <RadzenAlert AlertStyle="AlertStyle.Warning" Shade="Shade.Lighter" AllowClose="false">
                        Could not load workflow settings. Please try refreshing the page.
                    </RadzenAlert>
                }
                else
                {
                    <RadzenStack Gap="1rem">
                        <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false" Size="AlertSize.Small">
                            <strong>Review Workflow:</strong> Enable to require translations to be reviewed and approved before export.
                            This is useful for teams that need quality assurance.
                        </RadzenAlert>

                        @* Enable/Disable Workflow *@
                        <RadzenCard Style="border: 1px solid var(--rz-base-400);">
                            <RadzenStack Gap="0.5rem">
                                <RadzenText TextStyle="TextStyle.Subtitle1">Workflow Settings</RadzenText>
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                                    <RadzenText>Enable Review Workflow</RadzenText>
                                    <RadzenSwitch @bind-Value="_workflowSettings.ReviewWorkflowEnabled" />
                                </RadzenStack>

                                @if (_workflowSettings.ReviewWorkflowEnabled)
                                {
                                    <hr />
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                                        <RadzenText>Require Review Before Export</RadzenText>
                                        <RadzenSwitch @bind-Value="_workflowSettings.RequireReviewBeforeExport" Disabled="@(!_workflowSettings.ReviewWorkflowEnabled)" />
                                    </RadzenStack>
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                                        <RadzenText>Require Approval Before Export</RadzenText>
                                        <RadzenSwitch @bind-Value="_workflowSettings.RequireApprovalBeforeExport" Disabled="@(!_workflowSettings.ReviewWorkflowEnabled)" />
                                    </RadzenStack>
                                    @if (_project?.OrganizationId != null)
                                    {
                                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                                            <RadzenText>Inherit Organization Reviewers</RadzenText>
                                            <RadzenSwitch @bind-Value="_workflowSettings.InheritOrganizationReviewers" Disabled="@(!_workflowSettings.ReviewWorkflowEnabled)" />
                                        </RadzenStack>
                                    }
                                }

                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" class="rz-mt-2">
                                    <RadzenButton ButtonStyle="ButtonStyle.Primary" Text="Save Workflow Settings"
                                                  Click="SaveWorkflowSettings" Disabled="_savingWorkflow" IsBusy="_savingWorkflow" />
                                </RadzenStack>
                            </RadzenStack>
                        </RadzenCard>

                        @* Status Statistics *@
                        @if (_workflowSettings.ReviewWorkflowEnabled && _workflowSettings.Stats != null)
                        {
                            <RadzenCard Style="border: 1px solid var(--rz-base-400);">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-mb-3">Translation Status Overview</RadzenText>
                                <RadzenRow>
                                    <RadzenColumn Size="6" SizeSM="3">
                                        <RadzenStack AlignItems="Radzen.AlignItems.Center">
                                            <RadzenText TextStyle="TextStyle.H4">@_workflowSettings.Stats.PendingCount</RadzenText>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Pending</RadzenText>
                                        </RadzenStack>
                                    </RadzenColumn>
                                    <RadzenColumn Size="6" SizeSM="3">
                                        <RadzenStack AlignItems="Radzen.AlignItems.Center">
                                            <RadzenText TextStyle="TextStyle.H4" Style="color: var(--rz-info);">@_workflowSettings.Stats.TranslatedCount</RadzenText>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Translated</RadzenText>
                                        </RadzenStack>
                                    </RadzenColumn>
                                    <RadzenColumn Size="6" SizeSM="3">
                                        <RadzenStack AlignItems="Radzen.AlignItems.Center">
                                            <RadzenText TextStyle="TextStyle.H4" Style="color: var(--rz-warning);">@_workflowSettings.Stats.ReviewedCount</RadzenText>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Reviewed</RadzenText>
                                        </RadzenStack>
                                    </RadzenColumn>
                                    <RadzenColumn Size="6" SizeSM="3">
                                        <RadzenStack AlignItems="Radzen.AlignItems.Center">
                                            <RadzenText TextStyle="TextStyle.H4" Style="color: var(--rz-success);">@_workflowSettings.Stats.ApprovedCount</RadzenText>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Approved</RadzenText>
                                        </RadzenStack>
                                    </RadzenColumn>
                                </RadzenRow>
                            </RadzenCard>
                        }

                        @* Reviewers Management *@
                        @if (_workflowSettings.ReviewWorkflowEnabled)
                        {
                            <RadzenCard Style="border: 1px solid var(--rz-base-400);">
                                <RadzenStack Gap="1rem">
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                                        <RadzenText TextStyle="TextStyle.Subtitle1">Project Reviewers</RadzenText>
                                        <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small"
                                                      Icon="person_add" Text="Add Reviewer" Click="OpenAddReviewerDialog" />
                                    </RadzenStack>

                                    @if (_workflowSettings.Reviewers?.Any() == true || _workflowSettings.InheritedReviewers?.Any() == true)
                                    {
                                        <RadzenDataGrid TItem="ReviewerDto" Data="@GetAllReviewers()" Density="Density.Compact" AllowSorting="false">
                                            <Columns>
                                                <RadzenDataGridColumn TItem="ReviewerDto" Title="User">
                                                    <Template Context="reviewer">
                                                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                                                            @if (!string.IsNullOrEmpty(reviewer.AvatarUrl))
                                                            {
                                                                <RadzenImage Path="@reviewer.AvatarUrl" Style="width: 24px; height: 24px; border-radius: 50%;" />
                                                            }
                                                            else
                                                            {
                                                                <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--rz-primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                                                                    @(reviewer.Username?.FirstOrDefault().ToString().ToUpper() ?? "?")
                                                                </div>
                                                            }
                                                            <RadzenStack Gap="0">
                                                                <RadzenText TextStyle="TextStyle.Body2">@(reviewer.DisplayName ?? reviewer.Username)</RadzenText>
                                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">@@@reviewer.Username</RadzenText>
                                                            </RadzenStack>
                                                        </RadzenStack>
                                                    </Template>
                                                </RadzenDataGridColumn>
                                                <RadzenDataGridColumn TItem="ReviewerDto" Title="Role" Width="120px">
                                                    <Template Context="reviewer">
                                                        <RadzenBadge BadgeStyle="@(reviewer.Role == "approver" ? BadgeStyle.Success : BadgeStyle.Info)"
                                                                     Text="@(reviewer.Role == "approver" ? "Approver" : "Reviewer")" />
                                                    </Template>
                                                </RadzenDataGridColumn>
                                                <RadzenDataGridColumn TItem="ReviewerDto" Title="Languages">
                                                    <Template Context="reviewer">
                                                        @if (reviewer.LanguageCodes?.Any() == true)
                                                        {
                                                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.25rem" Style="flex-wrap: wrap;">
                                                                @foreach (var lang in reviewer.LanguageCodes.Take(3))
                                                                {
                                                                    <RadzenBadge Variant="Radzen.Variant.Outlined" Text="@lang" />
                                                                }
                                                                @if (reviewer.LanguageCodes.Length > 3)
                                                                {
                                                                    <RadzenText TextStyle="TextStyle.Caption">+@(reviewer.LanguageCodes.Length - 3) more</RadzenText>
                                                                }
                                                            </RadzenStack>
                                                        }
                                                        else
                                                        {
                                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">All languages</RadzenText>
                                                        }
                                                    </Template>
                                                </RadzenDataGridColumn>
                                                <RadzenDataGridColumn TItem="ReviewerDto" Title="Source" Width="120px">
                                                    <Template Context="reviewer">
                                                        @if (reviewer.IsInherited)
                                                        {
                                                            <RadzenBadge Variant="Radzen.Variant.Outlined" BadgeStyle="BadgeStyle.Secondary" Text="Organization" />
                                                        }
                                                        else
                                                        {
                                                            <RadzenBadge Variant="Radzen.Variant.Outlined" Text="Project" />
                                                        }
                                                    </Template>
                                                </RadzenDataGridColumn>
                                                <RadzenDataGridColumn TItem="ReviewerDto" Title="Actions" Width="80px" TextAlign="TextAlign.Center">
                                                    <Template Context="reviewer">
                                                        @if (!reviewer.IsInherited)
                                                        {
                                                            <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Variant="Radzen.Variant.Text"
                                                                          Size="ButtonSize.Small" Click="@(() => ConfirmRemoveReviewer(reviewer))" />
                                                        }
                                                    </Template>
                                                </RadzenDataGridColumn>
                                            </Columns>
                                        </RadzenDataGrid>
                                    }
                                    else
                                    {
                                        <RadzenAlert AlertStyle="AlertStyle.Info" Shade="Shade.Lighter" AllowClose="false" Size="AlertSize.Small">
                                            No reviewers assigned. Project owners and organization admins can always review and approve.
                                        </RadzenAlert>
                                    }
                                </RadzenStack>
                            </RadzenCard>
                        }
                    </RadzenStack>
                }
            </RadzenTabsItem>

            <RadzenTabsItem Text="Danger Zone" Icon="warning">
                <RadzenCard Variant="Radzen.Variant.Text" Style="border: 2px solid var(--rz-danger);">
                    <RadzenStack Gap="1rem">
                        <RadzenText TextStyle="TextStyle.H6" Style="color: var(--rz-danger);">Danger Zone</RadzenText>
                        <RadzenAlert AlertStyle="AlertStyle.Warning" Shade="Shade.Lighter" AllowClose="false">
                            <RadzenText TextStyle="TextStyle.Body2">
                                Deleting this project will permanently remove all localization keys and translations.
                                This action cannot be undone.
                            </RadzenText>
                        </RadzenAlert>

                        @if (!_showDeleteConfirm)
                        {
                            <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Danger"
                                          Icon="delete" Text="Delete Project"
                                          Click="@(() => _showDeleteConfirm = true)" Disabled="_isSubmitting" />
                        }
                        else
                        {
                            <RadzenCard Variant="Radzen.Variant.Text" Style="background-color: var(--rz-danger-lighter);">
                                <RadzenStack Gap="0.5rem">
                                    <RadzenText TextStyle="TextStyle.Body2">
                                        Type <strong>@_project.Name</strong> to confirm deletion:
                                    </RadzenText>
                                    <RadzenTextBox @bind-Value="_deleteConfirmText" Placeholder="@_project.Name"
                                                   Disabled="_isDeleting" Style="width: 100%;" />
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
                                        <RadzenButton Variant="Radzen.Variant.Text" Text="Cancel"
                                                      Click="@(() => { _showDeleteConfirm = false; _deleteConfirmText = string.Empty; })"
                                                      Disabled="_isDeleting" />
                                        <RadzenButton ButtonStyle="ButtonStyle.Danger"
                                                      Text="@(_isDeleting ? "Deleting..." : "Delete Forever")"
                                                      Click="HandleDelete"
                                                      Disabled="@(_deleteConfirmText != _project.Name || _isDeleting)"
                                                      IsBusy="_isDeleting" />
                                    </RadzenStack>
                                </RadzenStack>
                            </RadzenCard>
                        }
                    </RadzenStack>
                </RadzenCard>
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>
}

@code {
    [Parameter]
    public int ProjectId { get; set; }

    private ProjectDto? _project;
    private bool _isLoading = true;
    private bool _isSubmitting;
    private bool _isDeleting;
    private bool _showDeleteConfirm;
    private string _deleteConfirmText = string.Empty;
    private string? _errorMessage;
    private UpdateProjectRequest _model = new();
    private int _activeTabIndex;

    // Organization assignment
    private List<OrganizationDto> _organizations = new();
    private bool _loadingOrganizations;
    private int? _selectedOrganizationId;
    private int? _originalOrganizationId;

    // Languages
    private List<ProjectLanguageDto> _languages = new();
    private bool _loadingLanguages;
    private bool _languagesLoaded;

    // Translation providers
    private List<TranslationProviderDto> _translationProviders = new();
    private bool _loadingProviders;
    private bool _providersLoaded;

    // Provider key management
    private TranslationProviderDto? _selectedProvider;

    // Workflow
    private ReviewWorkflowSettingsDto? _workflowSettings;
    private bool _loadingWorkflow;
    private bool _workflowLoaded;
    private bool _savingWorkflow;

    protected override async Task OnInitializedAsync()
    {
        await LoadProjectAsync();

        if (_project != null)
        {
            // Load all tab data in parallel after project is loaded
            await Task.WhenAll(
                LoadOrganizationsAsync(),
                LoadLanguages(),
                LoadTranslationProviders(),
                LoadWorkflowSettings()
            );
        }
    }

    private async Task LoadProjectAsync()
    {
        _isLoading = true;
        try
        {
            _project = await ProjectService.GetProjectAsync(ProjectId);
            if (_project != null)
            {
                _model = new UpdateProjectRequest
                {
                    Name = _project.Name,
                    Description = _project.Description,
                    Format = _project.Format,
                    DefaultLanguage = _project.DefaultLanguage,
                    LocalizationPath = _project.LocalizationPath,
                    GitHubRepo = _project.GitHubRepo,
                    GitHubDefaultBranch = _project.GitHubDefaultBranch
                };
                _selectedOrganizationId = _project.OrganizationId;
                _originalOrganizationId = _project.OrganizationId;
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error loading project: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadOrganizationsAsync()
    {
        _loadingOrganizations = true;
        try
        {
            _organizations = await OrganizationService.GetOrganizationsAsync();
        }
        catch
        {
            // Ignore errors - user may not have organizations
        }
        finally
        {
            _loadingOrganizations = false;
        }
    }

    private IEnumerable<object> GetOrganizationOptions()
    {
        return _organizations
            .Where(o => o.UserRole is "owner" or "admin")
            .Select(o => new { o.Id, o.Name });
    }

    private async Task HandleSubmit()
    {
        if (_project == null) return;

        _isSubmitting = true;
        _errorMessage = null;

        try
        {
            // Check if organization assignment changed
            if (_selectedOrganizationId != _originalOrganizationId)
            {
                _model.OrganizationId = _selectedOrganizationId;
                _model.UpdateOrganization = true;
            }

            var result = await ProjectService.UpdateProjectAsync(_project.Id, _model);

            if (result.IsSuccess && result.Data != null)
            {
                _project = result.Data;
                _originalOrganizationId = _selectedOrganizationId;
                _model.UpdateOrganization = false;
                NotificationService.Notify(NotificationSeverity.Success, "Success", $"Project '{result.Data.Name}' updated successfully!");
            }
            else
            {
                _errorMessage = result.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private async Task HandleDelete()
    {
        if (_project == null || _deleteConfirmText != _project.Name) return;

        _isDeleting = true;

        try
        {
            var result = await ProjectService.DeleteProjectAsync(_project.Id);

            if (result.IsSuccess)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Deleted", $"Project '{_project.Name}' deleted.");
                Navigation.NavigateTo("");
            }
            else
            {
                _errorMessage = result.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isDeleting = false;
        }
    }

    private async Task LoadLanguages()
    {
        if (_project == null || _languagesLoaded) return;

        _loadingLanguages = true;
        try
        {
            _languages = await ResourceService.GetProjectLanguagesAsync(_project.Id);
            _languagesLoaded = true;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load languages: {ex.Message}");
        }
        finally
        {
            _loadingLanguages = false;
        }
    }

    private async Task OpenAddLanguageDialog()
    {
        var newLanguageCode = "";
        var result = await DialogService.OpenAsync("Add Language", ds =>
            @<RadzenStack Gap="1rem">
                <RadzenFormField Text="Language Code" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenTextBox @bind-Value="newLanguageCode" Placeholder="e.g., fr, de, es" Style="width: 100%;" />
                    </ChildContent>
                    <Helper>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Use ISO 639-1 codes (en, fr, de) or with region (en-US, pt-BR)</RadzenText>
                    </Helper>
                </RadzenFormField>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem">
                    <RadzenButton Variant="Radzen.Variant.Text" Text="Cancel" Click="@(() => ds.Close(null))" />
                    <RadzenButton ButtonStyle="ButtonStyle.Primary" Text="Add" Click="@(() => ds.Close(newLanguageCode))"
                                  Disabled="@string.IsNullOrWhiteSpace(newLanguageCode)" />
                </RadzenStack>
            </RadzenStack>,
            new Radzen.DialogOptions { Width = "400px" });

        if (result is string languageCode && !string.IsNullOrWhiteSpace(languageCode))
        {
            await AddLanguage(languageCode);
        }
    }

    private async Task AddLanguage(string languageCode)
    {
        if (_project == null) return;

        try
        {
            var request = new AddLanguageRequest { LanguageCode = languageCode.Trim().ToLowerInvariant() };
            var result = await ResourceService.AddLanguageAsync(_project.Id, request);

            if (result.IsSuccess && result.Data != null)
            {
                _languages.Add(result.Data);
                _languages = _languages.OrderBy(l => !l.IsDefault).ThenBy(l => l.LanguageCode).ToList();
                NotificationService.Notify(NotificationSeverity.Success, "Success", $"Language '{result.Data.DisplayName}' added");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", result.ErrorMessage ?? "Failed to add language");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
    }

    private async Task ConfirmRemoveLanguage(ProjectLanguageDto language)
    {
        var confirmed = await DialogService.Confirm(
            $"Are you sure you want to remove {language.DisplayName} ({language.LanguageCode})?\n\nThis will permanently delete all translations for this language.",
            "Remove Language?",
            new ConfirmOptions { OkButtonText = "Remove", CancelButtonText = "Cancel" });

        if (confirmed == true)
        {
            await RemoveLanguage(language);
        }
    }

    private async Task RemoveLanguage(ProjectLanguageDto language)
    {
        if (_project == null) return;

        try
        {
            var result = await ResourceService.RemoveLanguageAsync(_project.Id, language.LanguageCode);

            if (result.IsSuccess)
            {
                _languages.RemoveAll(l => l.LanguageCode == language.LanguageCode);
                NotificationService.Notify(NotificationSeverity.Success, "Success", $"Language '{language.DisplayName}' removed");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", result.ErrorMessage ?? "Failed to remove language");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
    }

    // Translation provider methods
    private async Task LoadTranslationProviders()
    {
        if (_project == null || _providersLoaded) return;

        _loadingProviders = true;
        try
        {
            _translationProviders = await TranslationService.GetProvidersAsync(projectId: _project.Id);
            _providersLoaded = true;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load translation providers: {ex.Message}");
        }
        finally
        {
            _loadingProviders = false;
        }
    }

    private async Task OpenSetProviderKeyDialog(TranslationProviderDto provider)
    {
        if (_project == null) return;

        var result = await DialogService.OpenAsync<ConfigureProviderDialog>($"Configure {provider.DisplayName}",
            new Dictionary<string, object>
            {
                { "Provider", provider },
                { "Level", "project" },
                { "EntityId", _project.Id }
            },
            new Radzen.DialogOptions { Width = "500px" });

        if (result is true)
        {
            _providersLoaded = false;
            await LoadTranslationProviders();
        }
    }

    private async Task ConfirmRemoveProviderKey(TranslationProviderDto provider)
    {
        var confirmed = await DialogService.Confirm(
            $"Remove the {provider.DisplayName} API key override for this project?\n\nThe project will fall back to organization or user-level keys.",
            "Remove API Key?",
            new ConfirmOptions { OkButtonText = "Remove", CancelButtonText = "Cancel" });

        if (confirmed == true)
        {
            await RemoveProviderKey(provider);
        }
    }

    private async Task RemoveProviderKey(TranslationProviderDto provider)
    {
        if (_project == null) return;

        try
        {
            var result = await TranslationService.RemoveProjectApiKeyAsync(_project.Id, provider.Name);

            if (result.IsSuccess)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", $"{provider.DisplayName} API key removed");
                _providersLoaded = false;
                await LoadTranslationProviders();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", result.ErrorMessage ?? "Failed to remove API key");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
    }

    private static string GetProviderIcon(string provider) => provider.ToLowerInvariant() switch
    {
        "google" => "g_translate",
        "deepl" => "translate",
        "openai" => "psychology",
        "claude" => "auto_awesome",
        "azuretranslator" => "cloud",
        "azureopenai" => "cloud",
        "ollama" => "computer",
        "libretranslate" => "public",
        "mymemory" => "memory",
        _ => "api"
    };

    private static string GetKeySourceLabel(string? source) => source switch
    {
        "project" => "Project key",
        "organization" => "Organization key",
        "user" => "User key",
        "lrm" => "LRM managed",
        _ => "Unknown"
    };

    private static string GetFormatDisplayName(string? format) => format?.ToLowerInvariant() switch
    {
        "resx" => ".resx (C#/.NET)",
        "json" => "JSON Localization",
        "i18next" => "i18next (JS/React)",
        "android" => "Android strings.xml",
        "ios" => "iOS .strings/.stringsdict",
        _ => format ?? "Unknown"
    };

    // Workflow methods
    private async Task LoadWorkflowSettings()
    {
        if (_project == null || _workflowLoaded) return;

        _loadingWorkflow = true;
        try
        {
            _workflowSettings = await WorkflowService.GetWorkflowSettingsAsync(_project.Id);
            _workflowLoaded = true;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load workflow settings: {ex.Message}");
        }
        finally
        {
            _loadingWorkflow = false;
        }
    }

    private async Task SaveWorkflowSettings()
    {
        if (_project == null || _workflowSettings == null) return;

        _savingWorkflow = true;
        try
        {
            var request = new UpdateWorkflowSettingsRequest
            {
                ReviewWorkflowEnabled = _workflowSettings.ReviewWorkflowEnabled,
                RequireReviewBeforeExport = _workflowSettings.RequireReviewBeforeExport,
                RequireApprovalBeforeExport = _workflowSettings.RequireApprovalBeforeExport,
                InheritOrganizationReviewers = _workflowSettings.InheritOrganizationReviewers
            };

            var result = await WorkflowService.UpdateWorkflowSettingsAsync(_project.Id, request);
            if (result != null)
            {
                _workflowSettings = result;
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Workflow settings saved");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to save workflow settings");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to save workflow settings: {ex.Message}");
        }
        finally
        {
            _savingWorkflow = false;
        }
    }

    private IEnumerable<ReviewerDto> GetAllReviewers()
    {
        var reviewers = new List<ReviewerDto>();
        if (_workflowSettings?.Reviewers != null)
            reviewers.AddRange(_workflowSettings.Reviewers);
        if (_workflowSettings?.InheritedReviewers != null)
            reviewers.AddRange(_workflowSettings.InheritedReviewers);
        return reviewers.OrderBy(r => r.IsInherited).ThenBy(r => r.Username);
    }

    private async Task OpenAddReviewerDialog()
    {
        int newReviewerUserId = 0;
        string newReviewerRole = "reviewer";
        string newReviewerLanguages = "";

        var result = await DialogService.OpenAsync("Add Reviewer", ds =>
            @<RadzenStack Gap="1rem">
                <RadzenFormField Text="User ID" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenNumeric @bind-Value="newReviewerUserId" Style="width: 100%;" />
                    </ChildContent>
                    <Helper>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Enter the user ID of the reviewer to add</RadzenText>
                    </Helper>
                </RadzenFormField>
                <RadzenFormField Text="Role" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenDropDown @bind-Value="newReviewerRole" Style="width: 100%;"
                                        Data="@(new[] { new { Value = "reviewer", Text = "Reviewer (can mark as reviewed)" }, new { Value = "approver", Text = "Approver (can review and approve)" } })"
                                        TextProperty="Text" ValueProperty="Value" />
                    </ChildContent>
                </RadzenFormField>
                <RadzenFormField Text="Languages (optional)" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <ChildContent>
                        <RadzenTextBox @bind-Value="newReviewerLanguages" Style="width: 100%;" />
                    </ChildContent>
                    <Helper>
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Comma-separated language codes (e.g., fr, de, es). Leave empty for all languages.</RadzenText>
                    </Helper>
                </RadzenFormField>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem">
                    <RadzenButton Variant="Radzen.Variant.Text" Text="Cancel" Click="@(() => ds.Close(null))" />
                    <RadzenButton ButtonStyle="ButtonStyle.Primary" Text="Add"
                                  Click="@(() => ds.Close(new { UserId = newReviewerUserId, Role = newReviewerRole, Languages = newReviewerLanguages }))"
                                  Disabled="@(newReviewerUserId <= 0)" />
                </RadzenStack>
            </RadzenStack>,
            new Radzen.DialogOptions { Width = "500px" });

        if (result != null)
        {
            await AddReviewer((int)result.UserId, (string)result.Role, (string)result.Languages);
        }
    }

    private async Task AddReviewer(int userId, string role, string languages)
    {
        if (_project == null || userId <= 0) return;

        try
        {
            var request = new AddReviewerRequest
            {
                UserId = userId,
                Role = role,
                LanguageCodes = string.IsNullOrWhiteSpace(languages)
                    ? null
                    : languages.Split(',', StringSplitOptions.RemoveEmptyEntries)
                        .Select(l => l.Trim().ToLowerInvariant())
                        .ToArray()
            };

            var result = await WorkflowService.AddProjectReviewerAsync(_project.Id, request);
            if (result != null)
            {
                _workflowSettings?.Reviewers?.Add(result);
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Reviewer added");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to add reviewer");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to add reviewer: {ex.Message}");
        }
    }

    private async Task ConfirmRemoveReviewer(ReviewerDto reviewer)
    {
        var confirmed = await DialogService.Confirm(
            $"Remove {reviewer.DisplayName ?? reviewer.Username} as a reviewer?",
            "Remove Reviewer?",
            new ConfirmOptions { OkButtonText = "Remove", CancelButtonText = "Cancel" });

        if (confirmed == true)
        {
            await RemoveReviewer(reviewer);
        }
    }

    private async Task RemoveReviewer(ReviewerDto reviewer)
    {
        if (_project == null) return;

        try
        {
            var result = await WorkflowService.RemoveProjectReviewerAsync(_project.Id, reviewer.UserId);
            if (result)
            {
                _workflowSettings?.Reviewers?.RemoveAll(r => r.UserId == reviewer.UserId);
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Reviewer removed");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to remove reviewer");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to remove reviewer: {ex.Message}");
        }
    }
}
