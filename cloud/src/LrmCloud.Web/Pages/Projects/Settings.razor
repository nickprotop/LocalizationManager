@page "/projects/{ProjectId:int}/settings"
@attribute [Authorize]
@using LrmCloud.Shared.DTOs.Projects
@using LrmCloud.Shared.DTOs.Resources
@using LrmCloud.Shared.DTOs.Translation
@using LrmCloud.Shared.DTOs.Organizations
@using LrmCloud.Shared.DTOs.Reviews
@using LrmCloud.Web.Helpers
@inject ProjectService ProjectService
@inject ReviewWorkflowService WorkflowService
@inject ResourceService ResourceService
@inject TranslationService TranslationService
@inject OrganizationService OrganizationService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Settings - @(_project?.Name ?? "Project") - LRM Cloud</PageTitle>

@if (_isLoading)
{
    <MudStack Spacing="4">
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="60px" />
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="400px" />
    </MudStack>
}
else if (_project == null)
{
    <MudAlert Severity="Severity.Error">
        Project not found or you don't have access to it.
        <MudButton Variant="Variant.Text" Color="Color.Primary" Href="">Go to Dashboard</MudButton>
    </MudAlert>
}
else
{
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                           OnClick="@(() => Navigation.NavigateTo($"projects/{ProjectId}"))"
                           Size="Size.Small" />
            <MudText Typo="Typo.h4">Project Settings</MudText>
            <MudText Typo="Typo.h6" Color="Color.Secondary">@_project.Name</MudText>
        </MudStack>

        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Save"
                   OnClick="@HandleSubmit"
                   Disabled="_isSubmitting">
            @if (_isSubmitting)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                <MudText Class="ms-2">Saving...</MudText>
            }
            else
            {
                <MudText>Save Changes</MudText>
            }
        </MudButton>
    </MudStack>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4" Variant="Variant.Filled">@_errorMessage</MudAlert>
    }

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4" @bind-ActivePanelIndex="_activeTabIndex">
        <MudTabPanel Text="General" Icon="@Icons.Material.Filled.Settings">
            <EditForm Model="_model" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudStack Spacing="3">
                            <MudTextField @bind-Value="_model.Name"
                                          Label="Project Name"
                                          Variant="Variant.Outlined"
                                          For="@(() => _model.Name)"
                                          Disabled="_isSubmitting"
                                          Required="true" />

                            <MudTextField @bind-Value="_model.Description"
                                          Label="Description"
                                          Variant="Variant.Outlined"
                                          Lines="3"
                                          For="@(() => _model.Description)"
                                          Disabled="_isSubmitting" />

                            <MudSelect @bind-Value="_model.Format"
                                       Label="Format"
                                       Variant="Variant.Outlined"
                                       For="@(() => _model.Format)"
                                       Disabled="_isSubmitting"
                                       Required="true">
                                <MudSelectItem Value="@("resx")">.resx (C#/.NET)</MudSelectItem>
                                <MudSelectItem Value="@("json")">JSON Localization</MudSelectItem>
                                <MudSelectItem Value="@("i18next")">i18next (JS/React)</MudSelectItem>
                            </MudSelect>

                            <MudTextField @bind-Value="_model.DefaultLanguage"
                                          Label="Default Language"
                                          Variant="Variant.Outlined"
                                          For="@(() => _model.DefaultLanguage)"
                                          Disabled="_isSubmitting"
                                          HelperText="e.g., en, en-US" />

                            <MudTextField @bind-Value="_model.LocalizationPath"
                                          Label="Localization Path"
                                          Variant="Variant.Outlined"
                                          For="@(() => _model.LocalizationPath)"
                                          Disabled="_isSubmitting"
                                          HelperText="Relative path to localization files" />

                            <MudDivider Class="my-2" />

                            <MudText Typo="Typo.subtitle2" Class="mb-2">Project Ownership</MudText>
                            <MudSelect @bind-Value="_selectedOrganizationId"
                                       Label="Organization"
                                       Variant="Variant.Outlined"
                                       Disabled="_isSubmitting || _loadingOrganizations"
                                       HelperText="Assign this project to an organization or keep as personal">
                                <MudSelectItem Value="@((int?)null)">Personal Project</MudSelectItem>
                                @foreach (var org in _organizations.Where(o => o.UserRole is "owner" or "admin"))
                                {
                                    <MudSelectItem Value="@((int?)org.Id)">@org.Name</MudSelectItem>
                                }
                            </MudSelect>
                        </MudStack>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudPaper Class="pa-4" Elevation="0" Style="background: var(--mud-palette-background-gray);">
                            <MudText Typo="Typo.subtitle2" Class="mb-2">Project Info</MudText>
                            <MudStack Spacing="2">
                                <div>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Created</MudText>
                                    <MudText>@_project.CreatedAt.ToString("MMMM dd, yyyy")</MudText>
                                </div>
                                <div>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Last Updated</MudText>
                                    <MudText>@_project.UpdatedAt.ToString("MMMM dd, yyyy HH:mm")</MudText>
                                </div>
                                <div>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Current Organization</MudText>
                                    <MudText>@(_project.OrganizationName ?? "Personal")</MudText>
                                </div>
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </EditForm>
        </MudTabPanel>

        <MudTabPanel Text="Languages" Icon="@Icons.Material.Filled.Language" OnClick="LoadLanguages">
            @if (_loadingLanguages)
            {
                <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
            }
            else
            {
                <MudStack Spacing="3">
                    <div class="d-flex justify-space-between align-center">
                        <MudText Typo="Typo.subtitle1">Project Languages</MudText>
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                                   StartIcon="@Icons.Material.Filled.Add" OnClick="OpenAddLanguageDialog">
                            Add Language
                        </MudButton>
                    </div>

                    @if (_languages.Count == 0)
                    {
                        <MudAlert Severity="Severity.Info">
                            No languages in this project yet. Add resource keys first, then add languages.
                        </MudAlert>
                    }
                    else
                    {
                        <MudTable Items="@_languages" Dense="true" Hover="true" Elevation="0">
                            <HeaderContent>
                                <MudTh>Language</MudTh>
                                <MudTh>Completion</MudTh>
                                <MudTh>Last Updated</MudTh>
                                <MudTh Style="width: 80px">Actions</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Language">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        <MudText>@context.LanguageCode</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">(@context.DisplayName)</MudText>
                                        @if (context.IsDefault)
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Primary">Default</MudChip>
                                        }
                                    </MudStack>
                                </MudTd>
                                <MudTd DataLabel="Completion">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudProgressLinear Value="@context.CompletionPercentage" Color="@UiHelpers.GetCompletionColor(context.CompletionPercentage)"
                                                           Style="width: 100px;" Size="Size.Small" Rounded="true" />
                                        <MudText Typo="Typo.caption">@context.CompletionPercentage%</MudText>
                                    </MudStack>
                                </MudTd>
                                <MudTd DataLabel="Last Updated">
                                    @if (context.LastUpdated.HasValue)
                                    {
                                        @context.LastUpdated.Value.ToString("g")
                                    }
                                    else
                                    {
                                        <MudText Color="Color.Secondary">Never</MudText>
                                    }
                                </MudTd>
                                <MudTd DataLabel="Actions">
                                    @if (!context.IsDefault)
                                    {
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                                       OnClick="@(() => ConfirmRemoveLanguage(context))" />
                                    }
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    }
                </MudStack>
            }
        </MudTabPanel>

        <MudTabPanel Text="GitHub" Icon="@Icons.Custom.Brands.GitHub">
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudStack Spacing="3">
                        <MudTextField @bind-Value="_model.GitHubRepo"
                                      Label="GitHub Repository"
                                      Variant="Variant.Outlined"
                                      For="@(() => _model.GitHubRepo)"
                                      Disabled="_isSubmitting"
                                      HelperText="e.g., owner/repo" />

                        <MudTextField @bind-Value="_model.GitHubDefaultBranch"
                                      Label="Default Branch"
                                      Variant="Variant.Outlined"
                                      For="@(() => _model.GitHubDefaultBranch)"
                                      Disabled="_isSubmitting"
                                      HelperText="e.g., main" />
                    </MudStack>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudAlert Severity="Severity.Info">
                        Link a GitHub repository to enable automatic sync with your source code.
                    </MudAlert>
                </MudItem>
            </MudGrid>
        </MudTabPanel>

        <MudTabPanel Text="Translation" Icon="@Icons.Material.Filled.Translate" OnClick="LoadTranslationProviders">
            @if (_loadingProviders)
            {
                <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
            }
            else
            {
                <MudStack Spacing="3">
                    <MudAlert Severity="Severity.Info" Dense="true" Class="mb-2">
                        <strong>Key Hierarchy:</strong> Project keys override Organization and User-level keys.
                        @if (_project?.OrganizationId != null)
                        {
                            <span>Keys configured here will only be used for this project.</span>
                        }
                    </MudAlert>

                    @if (!_translationProviders.Any())
                    {
                        <MudAlert Severity="Severity.Warning">
                            No translation providers available. Configure your API keys in Settings.
                        </MudAlert>
                    }
                    else
                    {
                        <MudGrid>
                            @foreach (var provider in _translationProviders)
                            {
                                <MudItem xs="12" md="6">
                                    <MudPaper Elevation="1" Class="pa-3">
                                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                <MudIcon Icon="@GetProviderIcon(provider.Name)" />
                                                <MudStack Spacing="0">
                                                    <MudText Typo="Typo.subtitle2">@provider.DisplayName</MudText>
                                                    @if (provider.IsConfigured)
                                                    {
                                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                            Using: @GetKeySourceLabel(provider.ApiKeySource)
                                                        </MudText>
                                                    }
                                                </MudStack>
                                            </MudStack>
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                @if (provider.IsConfigured)
                                                {
                                                    <MudChip T="string" Size="Size.Small" Color="Color.Success">Configured</MudChip>
                                                }
                                                @if (provider.ApiKeySource == "project")
                                                {
                                                    <MudButton Size="Size.Small" Color="Color.Primary"
                                                               OnClick="@(() => OpenSetProviderKeyDialog(provider))">
                                                        Update
                                                    </MudButton>
                                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                                                   OnClick="@(() => ConfirmRemoveProviderKey(provider))" />
                                                }
                                                else
                                                {
                                                    <MudButton Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined"
                                                               OnClick="@(() => OpenSetProviderKeyDialog(provider))">
                                                        Override
                                                    </MudButton>
                                                }
                                            </MudStack>
                                        </MudStack>
                                    </MudPaper>
                                </MudItem>
                            }
                        </MudGrid>
                    }
                </MudStack>
            }
        </MudTabPanel>

        <MudTabPanel Text="Workflow" Icon="@Icons.Material.Filled.RateReview" OnClick="LoadWorkflowSettings">
            @if (_loadingWorkflow)
            {
                <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
            }
            else if (_workflowSettings != null)
            {
                <MudStack Spacing="4">
                    <MudAlert Severity="Severity.Info" Dense="true">
                        <strong>Review Workflow:</strong> Enable to require translations to be reviewed and approved before export.
                        This is useful for teams that need quality assurance.
                    </MudAlert>

                    @* Enable/Disable Workflow *@
                    <MudPaper Elevation="1" Class="pa-4">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle1">Workflow Settings</MudText>
                            <MudSwitch @bind-Value="_workflowSettings.ReviewWorkflowEnabled"
                                       Color="Color.Primary"
                                       Label="Enable Review Workflow"
                                       LabelPosition="LabelPosition.Start" />

                            @if (_workflowSettings.ReviewWorkflowEnabled)
                            {
                                <MudDivider Class="my-2" />
                                <MudSwitch @bind-Value="_workflowSettings.RequireReviewBeforeExport"
                                           Color="Color.Primary"
                                           Label="Require Review Before Export"
                                           LabelPosition="LabelPosition.Start"
                                           Disabled="!_workflowSettings.ReviewWorkflowEnabled" />
                                <MudSwitch @bind-Value="_workflowSettings.RequireApprovalBeforeExport"
                                           Color="Color.Primary"
                                           Label="Require Approval Before Export"
                                           LabelPosition="LabelPosition.Start"
                                           Disabled="!_workflowSettings.ReviewWorkflowEnabled" />
                                @if (_project?.OrganizationId != null)
                                {
                                    <MudSwitch @bind-Value="_workflowSettings.InheritOrganizationReviewers"
                                               Color="Color.Primary"
                                               Label="Inherit Organization Reviewers"
                                               LabelPosition="LabelPosition.Start"
                                               Disabled="!_workflowSettings.ReviewWorkflowEnabled" />
                                }
                            }

                            <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-2">
                                <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                           OnClick="SaveWorkflowSettings" Disabled="_savingWorkflow">
                                    @if (_savingWorkflow)
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                    }
                                    Save Workflow Settings
                                </MudButton>
                            </MudStack>
                        </MudStack>
                    </MudPaper>

                    @* Status Statistics *@
                    @if (_workflowSettings.ReviewWorkflowEnabled && _workflowSettings.Stats != null)
                    {
                        <MudPaper Elevation="1" Class="pa-4">
                            <MudText Typo="Typo.subtitle1" Class="mb-3">Translation Status Overview</MudText>
                            <MudGrid>
                                <MudItem xs="6" sm="3">
                                    <MudStack AlignItems="AlignItems.Center">
                                        <MudText Typo="Typo.h4" Color="Color.Default">@_workflowSettings.Stats.PendingCount</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Pending</MudText>
                                    </MudStack>
                                </MudItem>
                                <MudItem xs="6" sm="3">
                                    <MudStack AlignItems="AlignItems.Center">
                                        <MudText Typo="Typo.h4" Color="Color.Info">@_workflowSettings.Stats.TranslatedCount</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Translated</MudText>
                                    </MudStack>
                                </MudItem>
                                <MudItem xs="6" sm="3">
                                    <MudStack AlignItems="AlignItems.Center">
                                        <MudText Typo="Typo.h4" Color="Color.Warning">@_workflowSettings.Stats.ReviewedCount</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Reviewed</MudText>
                                    </MudStack>
                                </MudItem>
                                <MudItem xs="6" sm="3">
                                    <MudStack AlignItems="AlignItems.Center">
                                        <MudText Typo="Typo.h4" Color="Color.Success">@_workflowSettings.Stats.ApprovedCount</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Approved</MudText>
                                    </MudStack>
                                </MudItem>
                            </MudGrid>
                        </MudPaper>
                    }

                    @* Reviewers Management *@
                    @if (_workflowSettings.ReviewWorkflowEnabled)
                    {
                        <MudPaper Elevation="1" Class="pa-4">
                            <MudStack Spacing="3">
                                <div class="d-flex justify-space-between align-center">
                                    <MudText Typo="Typo.subtitle1">Project Reviewers</MudText>
                                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                                               StartIcon="@Icons.Material.Filled.PersonAdd" OnClick="OpenAddReviewerDialog">
                                        Add Reviewer
                                    </MudButton>
                                </div>

                                @if (_workflowSettings.Reviewers?.Any() == true || _workflowSettings.InheritedReviewers?.Any() == true)
                                {
                                    <MudTable Items="@GetAllReviewers()" Dense="true" Hover="true" Elevation="0">
                                        <HeaderContent>
                                            <MudTh>User</MudTh>
                                            <MudTh>Role</MudTh>
                                            <MudTh>Languages</MudTh>
                                            <MudTh>Source</MudTh>
                                            <MudTh Style="width: 80px">Actions</MudTh>
                                        </HeaderContent>
                                        <RowTemplate>
                                            <MudTd DataLabel="User">
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                    @if (!string.IsNullOrEmpty(context.AvatarUrl))
                                                    {
                                                        <MudAvatar Size="Size.Small">
                                                            <MudImage Src="@context.AvatarUrl" />
                                                        </MudAvatar>
                                                    }
                                                    else
                                                    {
                                                        <MudAvatar Size="Size.Small" Color="Color.Primary">
                                                            @(context.Username?.FirstOrDefault().ToString().ToUpper() ?? "?")
                                                        </MudAvatar>
                                                    }
                                                    <MudStack Spacing="0">
                                                        <MudText Typo="Typo.body2">@(context.DisplayName ?? context.Username)</MudText>
                                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@@@context.Username</MudText>
                                                    </MudStack>
                                                </MudStack>
                                            </MudTd>
                                            <MudTd DataLabel="Role">
                                                <MudChip T="string" Size="Size.Small"
                                                         Color="@(context.Role == "approver" ? Color.Success : Color.Info)">
                                                    @(context.Role == "approver" ? "Approver" : "Reviewer")
                                                </MudChip>
                                            </MudTd>
                                            <MudTd DataLabel="Languages">
                                                @if (context.LanguageCodes?.Any() == true)
                                                {
                                                    <MudStack Row="true" Spacing="1">
                                                        @foreach (var lang in context.LanguageCodes.Take(3))
                                                        {
                                                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@lang</MudChip>
                                                        }
                                                        @if (context.LanguageCodes.Length > 3)
                                                        {
                                                            <MudText Typo="Typo.caption">+@(context.LanguageCodes.Length - 3) more</MudText>
                                                        }
                                                    </MudStack>
                                                }
                                                else
                                                {
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">All languages</MudText>
                                                }
                                            </MudTd>
                                            <MudTd DataLabel="Source">
                                                @if (context.IsInherited)
                                                {
                                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Secondary">
                                                        Organization
                                                    </MudChip>
                                                }
                                                else
                                                {
                                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">
                                                        Project
                                                    </MudChip>
                                                }
                                            </MudTd>
                                            <MudTd DataLabel="Actions">
                                                @if (!context.IsInherited)
                                                {
                                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                                                   OnClick="@(() => ConfirmRemoveReviewer(context))" />
                                                }
                                            </MudTd>
                                        </RowTemplate>
                                    </MudTable>
                                }
                                else
                                {
                                    <MudAlert Severity="Severity.Info" Dense="true">
                                        No reviewers assigned. Project owners and organization admins can always review and approve.
                                    </MudAlert>
                                }
                            </MudStack>
                        </MudPaper>
                    }
                </MudStack>
            }
        </MudTabPanel>

        <MudTabPanel Text="Danger Zone" Icon="@Icons.Material.Filled.Warning" BadgeColor="Color.Error">
            <MudPaper Class="pa-4" Elevation="0" Style="border: 2px solid var(--mud-palette-error);">
                <MudStack Spacing="3">
                    <MudText Typo="Typo.h6" Color="Color.Error">Danger Zone</MudText>
                    <MudAlert Severity="Severity.Warning">
                        <MudText Typo="Typo.body2">
                            Deleting this project will permanently remove all localization keys and translations.
                            This action cannot be undone.
                        </MudText>
                    </MudAlert>

                    @if (!_showDeleteConfirm)
                    {
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Error"
                                   StartIcon="@Icons.Material.Filled.Delete"
                                   OnClick="@(() => _showDeleteConfirm = true)"
                                   Disabled="_isSubmitting">
                            Delete Project
                        </MudButton>
                    }
                    else
                    {
                        <MudPaper Class="pa-3" Elevation="0" Style="background-color: var(--mud-palette-error-lighten);">
                            <MudStack Spacing="2">
                                <MudText Typo="Typo.body2">
                                    Type <strong>@_project.Name</strong> to confirm deletion:
                                </MudText>
                                <MudTextField @bind-Value="_deleteConfirmText"
                                              Variant="Variant.Outlined"
                                              Placeholder="@_project.Name"
                                              Disabled="_isDeleting" />
                                <MudStack Row="true" Spacing="2">
                                    <MudButton Variant="Variant.Text"
                                               OnClick="@(() => { _showDeleteConfirm = false; _deleteConfirmText = string.Empty; })"
                                               Disabled="_isDeleting">
                                        Cancel
                                    </MudButton>
                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Error"
                                               OnClick="HandleDelete"
                                               Disabled="@(_deleteConfirmText != _project.Name || _isDeleting)">
                                        @if (_isDeleting)
                                        {
                                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                            <MudText Class="ms-2">Deleting...</MudText>
                                        }
                                        else
                                        {
                                            <MudText>Delete Forever</MudText>
                                        }
                                    </MudButton>
                                </MudStack>
                            </MudStack>
                        </MudPaper>
                    }
                </MudStack>
            </MudPaper>
        </MudTabPanel>
    </MudTabs>
}

@* Add Language Dialog *@
<MudDialog @bind-Visible="_addLanguageDialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.ExtraSmall, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">Add Language</MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="_newLanguageCode" Label="Language Code" Placeholder="e.g., fr, de, es"
                      HelperText="Use ISO 639-1 codes (en, fr, de) or with region (en-US, pt-BR)"
                      Variant="Variant.Outlined" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _addLanguageDialogVisible = false)">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="AddLanguage" Disabled="_addingLanguage || string.IsNullOrWhiteSpace(_newLanguageCode)">
            @if (_addingLanguage)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Add
        </MudButton>
    </DialogActions>
</MudDialog>

@* Remove Language Confirmation *@
<MudDialog @bind-Visible="_removeLanguageDialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.ExtraSmall, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">Remove Language?</MudText>
    </TitleContent>
    <DialogContent>
        <MudText>
            Are you sure you want to remove <strong>@_languageToRemove?.DisplayName</strong> (@_languageToRemove?.LanguageCode)?
        </MudText>
        <MudText Color="Color.Error" Class="mt-2">
            This will permanently delete all translations for this language.
        </MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _removeLanguageDialogVisible = false)">Cancel</MudButton>
        <MudButton Color="Color.Error" Variant="Variant.Filled" OnClick="RemoveLanguage" Disabled="_removingLanguage">
            @if (_removingLanguage)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Remove
        </MudButton>
    </DialogActions>
</MudDialog>

@* Remove Provider Key Confirmation *@
<MudDialog @bind-Visible="_removeProviderKeyDialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.ExtraSmall, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">Remove API Key?</MudText>
    </TitleContent>
    <DialogContent>
        <MudText>
            Remove the <strong>@_selectedProvider?.DisplayName</strong> API key override for this project?
        </MudText>
        <MudText Color="Color.Secondary" Class="mt-2">
            The project will fall back to organization or user-level keys.
        </MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _removeProviderKeyDialogVisible = false)">Cancel</MudButton>
        <MudButton Color="Color.Error" Variant="Variant.Filled" OnClick="RemoveProviderKey" Disabled="_removingProviderKey">
            @if (_removingProviderKey)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Remove
        </MudButton>
    </DialogActions>
</MudDialog>

@* Add Reviewer Dialog *@
<MudDialog @bind-Visible="_addReviewerDialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">Add Reviewer</MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            <MudTextField @bind-Value="_newReviewerUserId" Label="User ID" InputType="InputType.Number"
                          HelperText="Enter the user ID of the reviewer to add"
                          Variant="Variant.Outlined" />
            <MudSelect @bind-Value="_newReviewerRole" Label="Role" Variant="Variant.Outlined">
                <MudSelectItem Value="@("reviewer")">Reviewer (can mark as reviewed)</MudSelectItem>
                <MudSelectItem Value="@("approver")">Approver (can review and approve)</MudSelectItem>
            </MudSelect>
            <MudTextField @bind-Value="_newReviewerLanguages" Label="Languages (optional)"
                          HelperText="Comma-separated language codes (e.g., fr, de, es). Leave empty for all languages."
                          Variant="Variant.Outlined" />
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _addReviewerDialogVisible = false)">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="AddReviewer" Disabled="_addingReviewer || _newReviewerUserId <= 0">
            @if (_addingReviewer)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Add
        </MudButton>
    </DialogActions>
</MudDialog>

@* Remove Reviewer Confirmation *@
<MudDialog @bind-Visible="_removeReviewerDialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.ExtraSmall, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">Remove Reviewer?</MudText>
    </TitleContent>
    <DialogContent>
        <MudText>
            Remove <strong>@(_reviewerToRemove?.DisplayName ?? _reviewerToRemove?.Username)</strong> as a reviewer?
        </MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _removeReviewerDialogVisible = false)">Cancel</MudButton>
        <MudButton Color="Color.Error" Variant="Variant.Filled" OnClick="RemoveReviewer" Disabled="_removingReviewer">
            @if (_removingReviewer)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Remove
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter]
    public int ProjectId { get; set; }

    private ProjectDto? _project;
    private bool _isLoading = true;
    private bool _isSubmitting;
    private bool _isDeleting;
    private bool _showDeleteConfirm;
    private string _deleteConfirmText = string.Empty;
    private string? _errorMessage;
    private UpdateProjectRequest _model = new();
    private int _activeTabIndex;

    // Organization assignment
    private List<OrganizationDto> _organizations = new();
    private bool _loadingOrganizations;
    private int? _selectedOrganizationId;
    private int? _originalOrganizationId;

    // Languages
    private List<ProjectLanguageDto> _languages = new();
    private bool _loadingLanguages;
    private bool _languagesLoaded;

    // Add language
    private bool _addLanguageDialogVisible;
    private string _newLanguageCode = "";
    private bool _addingLanguage;

    // Remove language
    private bool _removeLanguageDialogVisible;
    private ProjectLanguageDto? _languageToRemove;
    private bool _removingLanguage;

    // Translation providers
    private List<TranslationProviderDto> _translationProviders = new();
    private bool _loadingProviders;
    private bool _providersLoaded;

    // Provider key management
    private TranslationProviderDto? _selectedProvider;

    // Remove provider key
    private bool _removeProviderKeyDialogVisible;
    private bool _removingProviderKey;

    // Workflow
    private ReviewWorkflowSettingsDto? _workflowSettings;
    private bool _loadingWorkflow;
    private bool _workflowLoaded;
    private bool _savingWorkflow;

    // Add reviewer
    private bool _addReviewerDialogVisible;
    private int _newReviewerUserId;
    private string _newReviewerRole = "reviewer";
    private string _newReviewerLanguages = "";
    private bool _addingReviewer;

    // Remove reviewer
    private bool _removeReviewerDialogVisible;
    private ReviewerDto? _reviewerToRemove;
    private bool _removingReviewer;

    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(LoadProjectAsync(), LoadOrganizationsAsync());
    }

    private async Task LoadProjectAsync()
    {
        _isLoading = true;
        try
        {
            _project = await ProjectService.GetProjectAsync(ProjectId);
            if (_project != null)
            {
                _model = new UpdateProjectRequest
                {
                    Name = _project.Name,
                    Description = _project.Description,
                    Format = _project.Format,
                    DefaultLanguage = _project.DefaultLanguage,
                    LocalizationPath = _project.LocalizationPath,
                    GitHubRepo = _project.GitHubRepo,
                    GitHubDefaultBranch = _project.GitHubDefaultBranch
                };
                _selectedOrganizationId = _project.OrganizationId;
                _originalOrganizationId = _project.OrganizationId;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading project: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadOrganizationsAsync()
    {
        _loadingOrganizations = true;
        try
        {
            _organizations = await OrganizationService.GetOrganizationsAsync();
        }
        catch
        {
            // Ignore errors - user may not have organizations
        }
        finally
        {
            _loadingOrganizations = false;
        }
    }

    private async Task HandleSubmit()
    {
        if (_project == null) return;

        _isSubmitting = true;
        _errorMessage = null;

        try
        {
            // Check if organization assignment changed
            if (_selectedOrganizationId != _originalOrganizationId)
            {
                _model.OrganizationId = _selectedOrganizationId;
                _model.UpdateOrganization = true;
            }

            var result = await ProjectService.UpdateProjectAsync(_project.Id, _model);

            if (result.IsSuccess && result.Data != null)
            {
                _project = result.Data;
                _originalOrganizationId = _selectedOrganizationId; // Update the original to reflect saved state
                _model.UpdateOrganization = false; // Reset flag
                Snackbar.Add($"Project '{result.Data.Name}' updated successfully!", Severity.Success);
            }
            else
            {
                _errorMessage = result.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isSubmitting = false;
        }
    }

    private async Task HandleDelete()
    {
        if (_project == null || _deleteConfirmText != _project.Name) return;

        _isDeleting = true;

        try
        {
            var result = await ProjectService.DeleteProjectAsync(_project.Id);

            if (result.IsSuccess)
            {
                Snackbar.Add($"Project '{_project.Name}' deleted.", Severity.Success);
                Navigation.NavigateTo("");
            }
            else
            {
                _errorMessage = result.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            _isDeleting = false;
        }
    }

    private async Task LoadLanguages()
    {
        if (_project == null || _languagesLoaded) return;

        _loadingLanguages = true;
        try
        {
            _languages = await ResourceService.GetProjectLanguagesAsync(_project.Id);
            _languagesLoaded = true;
        }
        finally
        {
            _loadingLanguages = false;
        }
    }

    private void OpenAddLanguageDialog()
    {
        _newLanguageCode = "";
        _addLanguageDialogVisible = true;
    }

    private async Task AddLanguage()
    {
        if (_project == null || string.IsNullOrWhiteSpace(_newLanguageCode)) return;

        _addingLanguage = true;
        try
        {
            var request = new AddLanguageRequest { LanguageCode = _newLanguageCode.Trim().ToLowerInvariant() };
            var result = await ResourceService.AddLanguageAsync(_project.Id, request);

            if (result.IsSuccess && result.Data != null)
            {
                _languages.Add(result.Data);
                _languages = _languages.OrderBy(l => !l.IsDefault).ThenBy(l => l.LanguageCode).ToList();
                Snackbar.Add($"Language '{result.Data.DisplayName}' added", Severity.Success);
                _addLanguageDialogVisible = false;
            }
            else
            {
                Snackbar.Add(result.ErrorMessage ?? "Failed to add language", Severity.Error);
            }
        }
        finally
        {
            _addingLanguage = false;
        }
    }

    private void ConfirmRemoveLanguage(ProjectLanguageDto language)
    {
        _languageToRemove = language;
        _removeLanguageDialogVisible = true;
    }

    private async Task RemoveLanguage()
    {
        if (_project == null || _languageToRemove == null) return;

        _removingLanguage = true;
        try
        {
            var result = await ResourceService.RemoveLanguageAsync(_project.Id, _languageToRemove.LanguageCode);

            if (result.IsSuccess)
            {
                _languages.RemoveAll(l => l.LanguageCode == _languageToRemove.LanguageCode);
                Snackbar.Add($"Language '{_languageToRemove.DisplayName}' removed", Severity.Success);
                _removeLanguageDialogVisible = false;
                _languageToRemove = null;
            }
            else
            {
                Snackbar.Add(result.ErrorMessage ?? "Failed to remove language", Severity.Error);
            }
        }
        finally
        {
            _removingLanguage = false;
        }
    }

    // Translation provider methods
    private async Task LoadTranslationProviders()
    {
        if (_project == null || _providersLoaded) return;

        _loadingProviders = true;
        try
        {
            _translationProviders = await TranslationService.GetProvidersAsync(projectId: _project.Id);
            _providersLoaded = true;
        }
        finally
        {
            _loadingProviders = false;
        }
    }

    private async Task OpenSetProviderKeyDialog(TranslationProviderDto provider)
    {
        if (_project == null) return;

        var parameters = new DialogParameters
        {
            { nameof(ConfigureProviderDialog.Provider), provider },
            { nameof(ConfigureProviderDialog.Level), "project" },
            { nameof(ConfigureProviderDialog.EntityId), _project.Id }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<ConfigureProviderDialog>($"Configure {provider.DisplayName}", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            _providersLoaded = false;
            await LoadTranslationProviders();
        }
    }

    private void ConfirmRemoveProviderKey(TranslationProviderDto provider)
    {
        _selectedProvider = provider;
        _removeProviderKeyDialogVisible = true;
    }

    private async Task RemoveProviderKey()
    {
        if (_project == null || _selectedProvider == null) return;

        _removingProviderKey = true;
        try
        {
            var result = await TranslationService.RemoveProjectApiKeyAsync(_project.Id, _selectedProvider.Name);

            if (result.IsSuccess)
            {
                Snackbar.Add($"{_selectedProvider.DisplayName} API key removed", Severity.Success);
                _removeProviderKeyDialogVisible = false;
                _providersLoaded = false;
                await LoadTranslationProviders();
            }
            else
            {
                Snackbar.Add(result.ErrorMessage ?? "Failed to remove API key", Severity.Error);
            }
        }
        finally
        {
            _removingProviderKey = false;
        }
    }

    private static string GetProviderIcon(string provider) => provider.ToLowerInvariant() switch
    {
        "google" => Icons.Material.Filled.Translate,
        "deepl" => Icons.Material.Filled.Translate,
        "openai" => Icons.Material.Filled.Psychology,
        "claude" => Icons.Material.Filled.Psychology,
        "azuretranslator" => Icons.Material.Filled.Cloud,
        "azureopenai" => Icons.Material.Filled.Cloud,
        "ollama" => Icons.Material.Filled.Computer,
        "libretranslate" => Icons.Material.Filled.Public,
        "mymemory" => Icons.Material.Filled.Memory,
        _ => Icons.Material.Filled.Api
    };

    private static string GetKeySourceLabel(string? source) => source switch
    {
        "project" => "Project key",
        "organization" => "Organization key",
        "user" => "User key",
        "lrm" => "LRM managed",
        _ => "Unknown"
    };

    // Workflow methods
    private async Task LoadWorkflowSettings()
    {
        if (_project == null || _workflowLoaded) return;

        _loadingWorkflow = true;
        try
        {
            _workflowSettings = await WorkflowService.GetWorkflowSettingsAsync(_project.Id);
            _workflowLoaded = true;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load workflow settings: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loadingWorkflow = false;
        }
    }

    private async Task SaveWorkflowSettings()
    {
        if (_project == null || _workflowSettings == null) return;

        _savingWorkflow = true;
        try
        {
            var request = new UpdateWorkflowSettingsRequest
            {
                ReviewWorkflowEnabled = _workflowSettings.ReviewWorkflowEnabled,
                RequireReviewBeforeExport = _workflowSettings.RequireReviewBeforeExport,
                RequireApprovalBeforeExport = _workflowSettings.RequireApprovalBeforeExport,
                InheritOrganizationReviewers = _workflowSettings.InheritOrganizationReviewers
            };

            var result = await WorkflowService.UpdateWorkflowSettingsAsync(_project.Id, request);
            if (result != null)
            {
                _workflowSettings = result;
                Snackbar.Add("Workflow settings saved", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to save workflow settings", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to save workflow settings: {ex.Message}", Severity.Error);
        }
        finally
        {
            _savingWorkflow = false;
        }
    }

    private IEnumerable<ReviewerDto> GetAllReviewers()
    {
        var reviewers = new List<ReviewerDto>();
        if (_workflowSettings?.Reviewers != null)
            reviewers.AddRange(_workflowSettings.Reviewers);
        if (_workflowSettings?.InheritedReviewers != null)
            reviewers.AddRange(_workflowSettings.InheritedReviewers);
        return reviewers.OrderBy(r => r.IsInherited).ThenBy(r => r.Username);
    }

    private void OpenAddReviewerDialog()
    {
        _newReviewerUserId = 0;
        _newReviewerRole = "reviewer";
        _newReviewerLanguages = "";
        _addReviewerDialogVisible = true;
    }

    private async Task AddReviewer()
    {
        if (_project == null || _newReviewerUserId <= 0) return;

        _addingReviewer = true;
        try
        {
            var request = new AddReviewerRequest
            {
                UserId = _newReviewerUserId,
                Role = _newReviewerRole,
                LanguageCodes = string.IsNullOrWhiteSpace(_newReviewerLanguages)
                    ? null
                    : _newReviewerLanguages.Split(',', StringSplitOptions.RemoveEmptyEntries)
                        .Select(l => l.Trim().ToLowerInvariant())
                        .ToArray()
            };

            var result = await WorkflowService.AddProjectReviewerAsync(_project.Id, request);
            if (result != null)
            {
                _workflowSettings?.Reviewers?.Add(result);
                Snackbar.Add($"Reviewer added", Severity.Success);
                _addReviewerDialogVisible = false;
            }
            else
            {
                Snackbar.Add("Failed to add reviewer", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to add reviewer: {ex.Message}", Severity.Error);
        }
        finally
        {
            _addingReviewer = false;
        }
    }

    private void ConfirmRemoveReviewer(ReviewerDto reviewer)
    {
        _reviewerToRemove = reviewer;
        _removeReviewerDialogVisible = true;
    }

    private async Task RemoveReviewer()
    {
        if (_project == null || _reviewerToRemove == null) return;

        _removingReviewer = true;
        try
        {
            var result = await WorkflowService.RemoveProjectReviewerAsync(_project.Id, _reviewerToRemove.UserId);
            if (result)
            {
                _workflowSettings?.Reviewers?.RemoveAll(r => r.UserId == _reviewerToRemove.UserId);
                Snackbar.Add("Reviewer removed", Severity.Success);
                _removeReviewerDialogVisible = false;
                _reviewerToRemove = null;
            }
            else
            {
                Snackbar.Add("Failed to remove reviewer", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to remove reviewer: {ex.Message}", Severity.Error);
        }
        finally
        {
            _removingReviewer = false;
        }
    }
}
