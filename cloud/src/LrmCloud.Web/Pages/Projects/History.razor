@page "/projects/{ProjectId:int}/history"
@attribute [Authorize]
@using LrmCloud.Shared.DTOs.Sync
@using LrmCloud.Shared.DTOs.Projects
@inject SyncHistoryService HistoryService
@inject ProjectService ProjectService
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService

<PageTitle>Sync History - @(_project?.Name ?? "Project") - LRM Cloud</PageTitle>

@if (_isLoading)
{
    <RadzenStack Gap="1rem">
        <RadzenSkeleton Style="height: 60px; width: 100%;" />
        <RadzenSkeleton Style="height: 400px; width: 100%;" />
    </RadzenStack>
}
else if (_project == null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" AllowClose="false">
        Project not found or you don't have access to it.
        <RadzenButton Variant="Radzen.Variant.Text" ButtonStyle="ButtonStyle.Primary" Text="Go to Dashboard" Click="@(() => Navigation.NavigateTo(""))" />
    </RadzenAlert>
}
else
{
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-4">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
            <RadzenButton Icon="arrow_back" Variant="Radzen.Variant.Text" Click="@(() => Navigation.NavigateTo($"projects/{ProjectId}"))" Size="ButtonSize.Small" />
            <RadzenText TextStyle="TextStyle.H4">Sync History</RadzenText>
            <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@_project.Name" />
        </RadzenStack>

        <RadzenButton Variant="Radzen.Variant.Outlined" ButtonStyle="ButtonStyle.Secondary" Icon="refresh"
                      Text="Refresh" Click="@LoadDataAsync" Disabled="@_isLoading" />
    </RadzenStack>

    <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary rz-mb-4">
        View push and revert operations. Click on an entry to see detailed changes, or revert to undo a push.
    </RadzenText>

    @if (_historyResponse == null || _historyResponse.Items.Count == 0)
    {
        <RadzenCard Style="padding: 3rem;">
            <RadzenStack AlignItems="Radzen.AlignItems.Center" JustifyContent="JustifyContent.Center" Gap="1rem">
                <RadzenIcon Icon="history" Style="font-size: 3rem;" class="rz-color-secondary" />
                <RadzenText TextStyle="TextStyle.H6" class="rz-color-secondary">No sync history yet</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="text-align: center;">
                    Push changes from the CLI to start building history.<br/>
                    Use <code>lrm cloud push</code> to sync your local changes.
                </RadzenText>
            </RadzenStack>
        </RadzenCard>
    }
    else
    {
        <RadzenStack Gap="1rem">
            @foreach (var entry in _historyResponse.Items)
            {
                <RadzenCard Style="@($"border-left: 4px solid {GetOperationTypeColorValue(entry.OperationType, entry.Status)};")">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Start">
                        <RadzenStack Gap="0.5rem">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" Wrap="FlexWrap.Wrap">
                                <RadzenIcon Icon="@GetOperationIcon(entry.OperationType)" Style="@($"color: {GetOperationTypeColorValue(entry.OperationType, entry.Status)};")" />
                                <RadzenText TextStyle="TextStyle.Subtitle1" Style="font-family: monospace;">@entry.HistoryId</RadzenText>
                                <RadzenBadge BadgeStyle="@GetOperationTypeBadgeStyle(entry.OperationType, entry.Status)"
                                             Variant="Radzen.Variant.Outlined" Text="@GetOperationDisplayName(entry.OperationType)" />
                                @if (entry.Status == "reverted")
                                {
                                    <RadzenBadge BadgeStyle="BadgeStyle.Warning" Variant="Radzen.Variant.Text" Text="reverted" />
                                }
                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                    @entry.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy HH:mm")
                                </RadzenText>
                            </RadzenStack>

                            @if (!string.IsNullOrEmpty(entry.Message))
                            {
                                <RadzenText TextStyle="TextStyle.Body2">@entry.Message</RadzenText>
                            }

                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" Wrap="FlexWrap.Wrap">
                                @if (entry.EntriesAdded > 0)
                                {
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                                        <RadzenIcon Icon="add" Style="font-size: 1rem; color: var(--rz-success);" />
                                        <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-success);">@entry.EntriesAdded added</RadzenText>
                                    </RadzenStack>
                                }
                                @if (entry.EntriesModified > 0)
                                {
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                                        <RadzenIcon Icon="edit" Style="font-size: 1rem; color: var(--rz-warning);" />
                                        <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-warning);">@entry.EntriesModified modified</RadzenText>
                                    </RadzenStack>
                                }
                                @if (entry.EntriesDeleted > 0)
                                {
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                                        <RadzenIcon Icon="remove" Style="font-size: 1rem; color: var(--rz-danger);" />
                                        <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-danger);">@entry.EntriesDeleted deleted</RadzenText>
                                    </RadzenStack>
                                }
                                @if (!string.IsNullOrEmpty(entry.UserName) || !string.IsNullOrEmpty(entry.UserEmail))
                                {
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                                        <RadzenIcon Icon="person" Style="font-size: 1rem;" class="rz-color-secondary" />
                                        <RadzenText TextStyle="TextStyle.Caption">@(entry.UserName ?? entry.UserEmail)</RadzenText>
                                    </RadzenStack>
                                }
                            </RadzenStack>
                        </RadzenStack>
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.25rem">
                            <RadzenButton Icon="visibility" Variant="Radzen.Variant.Text" Size="ButtonSize.Small"
                                          Click="@(() => ViewDetailAsync(entry))" title="View details" />
                            @if (CanRevert(entry.OperationType, entry.Status))
                            {
                                <RadzenButton Icon="undo" Variant="Radzen.Variant.Text" Size="ButtonSize.Small"
                                              ButtonStyle="ButtonStyle.Warning" Click="@(() => OpenRevertDialog(entry))" title="Revert this change" />
                            }
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>
            }
        </RadzenStack>

        @if (_historyResponse.HasMore)
        {
            <RadzenStack AlignItems="Radzen.AlignItems.Center" class="rz-mt-4">
                <RadzenButton Variant="Radzen.Variant.Outlined" Text="Load More"
                              Click="@LoadMoreAsync" Disabled="@_isLoadingMore" IsBusy="@_isLoadingMore" />
            </RadzenStack>
        }
    }
}

@code {
    [Parameter]
    public int ProjectId { get; set; }

    private ProjectDto? _project;
    private SyncHistoryListResponse? _historyResponse;
    private bool _isLoading = true;
    private bool _isLoadingMore;
    private int _currentPage = 1;
    private const int PageSize = 20;

    // View details dialog
    private SyncHistoryDto? _viewEntry;
    private SyncHistoryDetailDto? _viewDetail;
    private bool _isLoadingDetail;

    // Revert dialog
    private SyncHistoryDto? _revertEntry;
    private string _revertMessage = "";
    private bool _isReverting;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        _currentPage = 1;
        try
        {
            _project = await ProjectService.GetProjectAsync(ProjectId);
            if (_project != null)
            {
                _historyResponse = await HistoryService.GetHistoryAsync(ProjectId, _currentPage, PageSize);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error loading history: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadMoreAsync()
    {
        if (_historyResponse == null || !_historyResponse.HasMore)
            return;

        _isLoadingMore = true;
        try
        {
            _currentPage++;
            var moreHistory = await HistoryService.GetHistoryAsync(ProjectId, _currentPage, PageSize);
            if (moreHistory != null)
            {
                _historyResponse.Items.AddRange(moreHistory.Items);
                _historyResponse.HasMore = moreHistory.HasMore;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error loading more history: {ex.Message}");
        }
        finally
        {
            _isLoadingMore = false;
        }
    }

    // View Details Dialog
    private async Task ViewDetailAsync(SyncHistoryDto entry)
    {
        _viewEntry = entry;
        _viewDetail = null;
        _isLoadingDetail = true;

        try
        {
            _viewDetail = await HistoryService.GetHistoryDetailAsync(ProjectId, entry.HistoryId);
            if (_viewDetail == null)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load history details");
                return;
            }

            var result = await DialogService.OpenAsync($"{GetOperationDisplayName(entry.OperationType)} Details", ds =>
                @<RadzenStack Gap="1rem">
                    <RadzenRow Gap="1rem">
                        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Operation</RadzenText>
                            <RadzenBadge BadgeStyle="@GetOperationTypeBadgeStyle(_viewDetail.OperationType, _viewDetail.Status)"
                                         Text="@GetOperationDisplayName(_viewDetail.OperationType)" />
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Status</RadzenText>
                            <RadzenBadge BadgeStyle="@(_viewDetail.Status == "reverted" ? BadgeStyle.Warning : BadgeStyle.Success)"
                                         Text="@_viewDetail.Status" />
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Date</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body1">@_viewDetail.CreatedAt.ToLocalTime().ToString("g")</RadzenText>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Author</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body1">@(_viewDetail.UserName ?? _viewDetail.UserEmail ?? "Unknown")</RadzenText>
                        </RadzenColumn>
                    </RadzenRow>

                    @if (!string.IsNullOrEmpty(_viewDetail.Message))
                    {
                        <div>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Message</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body1">@_viewDetail.Message</RadzenText>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(_viewDetail.RevertedFromId))
                    {
                        <div>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Reverted From</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body1" Style="font-family: monospace;">@_viewDetail.RevertedFromId</RadzenText>
                        </div>
                    }

                    <RadzenRow Gap="1rem">
                        <RadzenColumn Size="4">
                            <RadzenCard Style="border-left: 3px solid var(--rz-success); text-align: center;">
                                <RadzenText TextStyle="TextStyle.H5" Style="color: var(--rz-success);">@_viewDetail.EntriesAdded</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption">Added</RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                        <RadzenColumn Size="4">
                            <RadzenCard Style="border-left: 3px solid var(--rz-warning); text-align: center;">
                                <RadzenText TextStyle="TextStyle.H5" Style="color: var(--rz-warning);">@_viewDetail.EntriesModified</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption">Modified</RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                        <RadzenColumn Size="4">
                            <RadzenCard Style="border-left: 3px solid var(--rz-danger); text-align: center;">
                                <RadzenText TextStyle="TextStyle.H5" Style="color: var(--rz-danger);">@_viewDetail.EntriesDeleted</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption">Deleted</RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                    </RadzenRow>

                    @if (_viewDetail.Changes.Any())
                    {
                        <hr />
                        <RadzenText TextStyle="TextStyle.Subtitle2">
                            <RadzenIcon Icon="difference" Style="font-size: 1rem;" />
                            Changes (@_viewDetail.Changes.Count)
                        </RadzenText>

                        <div style="max-height: 400px; overflow-y: auto;">
                            <RadzenDataGrid TItem="SyncChangeDto" Data="@_viewDetail.Changes.Take(100)"
                                            Density="Density.Compact" AllowSorting="false" AllowPaging="false">
                                <Columns>
                                    <RadzenDataGridColumn TItem="SyncChangeDto" Title="Type" Width="80px">
                                        <Template Context="change">
                                            <RadzenBadge BadgeStyle="@GetChangeTypeBadgeStyle(change.ChangeType)"
                                                         Variant="Radzen.Variant.Text" Text="@change.ChangeType" />
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="SyncChangeDto" Property="Key" Title="Key" Width="200px">
                                        <Template Context="change">
                                            <span style="font-family: monospace; word-break: break-all;">@change.Key</span>
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="SyncChangeDto" Property="Lang" Title="Lang" Width="80px">
                                        <Template Context="change">
                                            <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@change.Lang" />
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="SyncChangeDto" Title="Before">
                                        <Template Context="change">
                                            @if (string.IsNullOrEmpty(change.BeforeValue))
                                            {
                                                <span class="rz-color-secondary" style="font-style: italic;">-</span>
                                            }
                                            else
                                            {
                                                <span title="@change.BeforeValue" style="color: var(--rz-danger);">@TruncateValue(change.BeforeValue)</span>
                                            }
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="SyncChangeDto" Title="After">
                                        <Template Context="change">
                                            @if (string.IsNullOrEmpty(change.AfterValue))
                                            {
                                                <span class="rz-color-secondary" style="font-style: italic;">-</span>
                                            }
                                            else
                                            {
                                                <span title="@change.AfterValue" style="color: var(--rz-success);">@TruncateValue(change.AfterValue)</span>
                                            }
                                        </Template>
                                    </RadzenDataGridColumn>
                                </Columns>
                            </RadzenDataGrid>
                            @if (_viewDetail.Changes.Count > 100)
                            {
                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="text-align: center;">
                                    Showing first 100 of @_viewDetail.Changes.Count changes
                                </RadzenText>
                            }
                        </div>
                    }

                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem" class="rz-mt-4">
                        <RadzenButton Variant="Radzen.Variant.Text" Text="Close" Click="@(() => ds.Close(false))" />
                        @if (CanRevert(_viewDetail.OperationType, _viewDetail.Status))
                        {
                            <RadzenButton Variant="Radzen.Variant.Filled" ButtonStyle="ButtonStyle.Warning"
                                          Icon="undo" Text="Revert This Change"
                                          Click="@(() => ds.Close("revert"))" />
                        }
                    </RadzenStack>
                </RadzenStack>,
                new Radzen.DialogOptions { Width = "800px" });

            if (result as string == "revert")
            {
                OpenRevertDialog(entry);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error loading details: {ex.Message}");
        }
        finally
        {
            _isLoadingDetail = false;
        }
    }

    // Revert Dialog
    private async Task OpenRevertDialog(SyncHistoryDto entry)
    {
        _revertEntry = entry;
        _revertMessage = "";

        var result = await DialogService.OpenAsync("Revert Push", ds =>
            @<RadzenStack Gap="1rem">
                <RadzenAlert AlertStyle="AlertStyle.Warning" AllowClose="false">
                    This will undo all changes from push <strong style="font-family: monospace;">@_revertEntry.HistoryId</strong>.
                </RadzenAlert>

                @if (_revertEntry.EntriesAdded > 0)
                {
                    <RadzenText TextStyle="TextStyle.Body2">
                        <RadzenIcon Icon="remove" Style="font-size: 1rem; color: var(--rz-danger);" />
                        <strong>@_revertEntry.EntriesAdded</strong> added entries will be <span style="color: var(--rz-danger);">removed</span>
                    </RadzenText>
                }
                @if (_revertEntry.EntriesModified > 0)
                {
                    <RadzenText TextStyle="TextStyle.Body2">
                        <RadzenIcon Icon="undo" Style="font-size: 1rem; color: var(--rz-warning);" />
                        <strong>@_revertEntry.EntriesModified</strong> modified entries will be <span style="color: var(--rz-warning);">restored to previous values</span>
                    </RadzenText>
                }
                @if (_revertEntry.EntriesDeleted > 0)
                {
                    <RadzenText TextStyle="TextStyle.Body2">
                        <RadzenIcon Icon="add" Style="font-size: 1rem; color: var(--rz-success);" />
                        <strong>@_revertEntry.EntriesDeleted</strong> deleted entries will be <span style="color: var(--rz-success);">restored</span>
                    </RadzenText>
                }

                <RadzenFormField Text="Revert message (optional)" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <RadzenTextBox @bind-Value="_revertMessage" Placeholder="e.g., Rolling back broken translations" Style="width: 100%;" />
                </RadzenFormField>

                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem" class="rz-mt-4">
                    <RadzenButton Variant="Radzen.Variant.Text" Text="Cancel" Click="@(() => ds.Close(false))" />
                    <RadzenButton Variant="Radzen.Variant.Filled" ButtonStyle="ButtonStyle.Warning" Text="Revert"
                                  Click="@(() => ds.Close(true))" Disabled="@_isReverting" IsBusy="@_isReverting" />
                </RadzenStack>
            </RadzenStack>,
            new Radzen.DialogOptions { Width = "500px" });

        if (result == true)
        {
            await RevertAsync();
        }
    }

    private async Task RevertAsync()
    {
        if (_revertEntry == null)
            return;

        _isReverting = true;
        try
        {
            var result = await HistoryService.RevertAsync(
                ProjectId,
                _revertEntry.HistoryId,
                string.IsNullOrWhiteSpace(_revertMessage) ? null : _revertMessage);

            if (result.IsSuccess && result.Data != null)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success",
                    $"Successfully reverted push {_revertEntry.HistoryId}. {result.Data.EntriesRestored} entries restored.");

                // Mark the reverted entry as reverted in the local list
                var entry = _historyResponse?.Items.FirstOrDefault(e => e.HistoryId == _revertEntry.HistoryId);
                if (entry != null)
                {
                    entry.Status = "reverted";
                }

                // Add the new revert entry to the top of the list
                if (result.Data.History != null && _historyResponse != null)
                {
                    _historyResponse.Items.Insert(0, result.Data.History);
                }

                StateHasChanged();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", result.ErrorMessage ?? "Failed to revert");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error reverting: {ex.Message}");
        }
        finally
        {
            _isReverting = false;
        }
    }

    // Helper methods
    private static string GetOperationTypeColorValue(string operationType, string status)
    {
        if (status == "reverted")
            return "var(--rz-warning)";

        return operationType.ToLower() switch
        {
            "push" => "var(--rz-primary)",
            "web-edit" => "var(--rz-info)",
            "revert" => "var(--rz-warning)",
            _ => "var(--rz-base-600)"
        };
    }

    private static BadgeStyle GetOperationTypeBadgeStyle(string operationType, string status)
    {
        if (status == "reverted")
            return BadgeStyle.Warning;

        return operationType.ToLower() switch
        {
            "push" => BadgeStyle.Primary,
            "web-edit" => BadgeStyle.Info,
            "revert" => BadgeStyle.Warning,
            _ => BadgeStyle.Light
        };
    }

    private static string GetOperationIcon(string operationType) => operationType.ToLower() switch
    {
        "push" => "cloud_upload",
        "web-edit" => "edit",
        "revert" => "undo",
        _ => "history"
    };

    private static string GetOperationDisplayName(string operationType) => operationType.ToLower() switch
    {
        "push" => "Push",
        "web-edit" => "Web Edit",
        "revert" => "Revert",
        _ => operationType
    };

    private static bool CanRevert(string operationType, string status)
    {
        if (status == "reverted")
            return false;

        // Both CLI push and web-edit can be reverted
        return operationType.ToLower() is "push" or "web-edit";
    }

    private static BadgeStyle GetChangeTypeBadgeStyle(string changeType) => changeType.ToLower() switch
    {
        "added" => BadgeStyle.Success,
        "deleted" => BadgeStyle.Danger,
        "modified" => BadgeStyle.Warning,
        _ => BadgeStyle.Light
    };

    private static string TruncateValue(string value, int maxLength = 50)
    {
        if (string.IsNullOrEmpty(value))
            return value;

        return value.Length <= maxLength ? value : value.Substring(0, maxLength) + "...";
    }
}
