@page "/projects/{ProjectId:int}/glossary"
@using LrmCloud.Shared.DTOs.Glossary
@using LrmCloud.Shared.DTOs.Projects
@using LrmCloud.Web.Services
@inject GlossaryService GlossaryService
@inject ProjectService ProjectService
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService
@attribute [Authorize]

<PageTitle>Glossary - LRM Cloud</PageTitle>

<RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" class="rz-mb-2">
    <RadzenButton Icon="arrow_back" Variant="Radzen.Variant.Text" Click="@(() => Navigation.NavigateTo($"projects/{ProjectId}"))" Size="ButtonSize.Small" />
    <RadzenBreadCrumb>
        <RadzenBreadCrumbItem Path="" Text="Projects" />
        <RadzenBreadCrumbItem Path="@($"projects/{ProjectId}")" Text="@_projectName" />
        <RadzenBreadCrumbItem Text="Glossary" />
    </RadzenBreadCrumb>
</RadzenStack>

<RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-4">
    <RadzenStack Gap="0">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
            <RadzenIcon Icon="book" Style="vertical-align: middle;" />
            <RadzenText TextStyle="TextStyle.H4">Project Glossary</RadzenText>
        </RadzenStack>
        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
            Define terms that should be translated consistently. Project terms override organization terms.
        </RadzenText>
    </RadzenStack>
    <RadzenButton Variant="Radzen.Variant.Filled" ButtonStyle="ButtonStyle.Primary" Icon="add" Text="Add Term" Click="@OpenAddDialog" />
</RadzenStack>

@if (_isLoading)
{
    <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
}
else if (_glossary == null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" AllowClose="false">Failed to load glossary.</RadzenAlert>
}
else
{
    @if (_project?.OrganizationId != null)
    {
        <RadzenCard class="rz-mb-4">
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                <RadzenStack Gap="0.25rem">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                        <RadzenSwitch @bind-Value="_inheritOrgGlossary" Change="@OnInheritanceChanged" Disabled="@_isSavingInheritance" />
                        <RadzenText TextStyle="TextStyle.Body1">Inherit organization glossary</RadzenText>
                    </RadzenStack>
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary" Style="margin-left: 3rem;">
                        @if (_inheritOrgGlossary)
                        {
                            <span>Organization glossary terms are included. Project terms override organization terms if both exist.</span>
                        }
                        else
                        {
                            <span>Only project-specific glossary terms are used.</span>
                        }
                    </RadzenText>
                </RadzenStack>
                @if (_isSavingInheritance)
                {
                    <RadzenProgressBarCircular ShowValue="false" Size="ProgressBarCircularSize.Small" Mode="ProgressBarMode.Indeterminate" />
                }
            </RadzenStack>
        </RadzenCard>
    }

    <RadzenRow Gap="1rem">
        <RadzenColumn Size="12" SizeMD="4">
            <RadzenCard>
                <RadzenStack Gap="0.5rem">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenText>Total Terms</RadzenText>
                        <RadzenText TextStyle="TextStyle.H6">@_glossary.TotalCount</RadzenText>
                    </RadzenStack>
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenText>Project Terms</RadzenText>
                        <RadzenText TextStyle="TextStyle.H6">@_glossary.ProjectTermsCount</RadzenText>
                    </RadzenStack>
                    @if (_glossary.InheritedTermsCount > 0)
                    {
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                                <RadzenIcon Icon="business" Style="font-size: 1rem;" />
                                <RadzenText>Inherited (Org)</RadzenText>
                            </RadzenStack>
                            <RadzenText TextStyle="TextStyle.H6" Style="color: var(--rz-info);">@_glossary.InheritedTermsCount</RadzenText>
                        </RadzenStack>
                    }
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>

        <RadzenColumn Size="12" SizeMD="8">
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" AlignItems="Radzen.AlignItems.Center">
                    <RadzenTextBox @bind-Value="_searchTerm" Placeholder="Search terms..." Style="max-width: 300px;" />
                    <RadzenDropDown @bind-Value="_scopeFilter" Data="@_scopeOptions" TextProperty="Text" ValueProperty="Value" Style="max-width: 150px;" />
                    @if (_glossary.Languages.Count > 0)
                    {
                        <RadzenDropDown @bind-Value="_languageFilter" Data="@GetLanguageOptions()" TextProperty="Text" ValueProperty="Value" Style="max-width: 150px;" />
                    }
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>

        <RadzenColumn Size="12">
            <RadzenCard>
                @if (FilteredTerms.Count == 0)
                {
                    <RadzenAlert AlertStyle="AlertStyle.Info" AllowClose="false">
                        @if (_glossary.TotalCount == 0)
                        {
                            <span>No glossary terms defined yet. Click "Add Term" to create one.</span>
                        }
                        else
                        {
                            <span>No terms match your filters.</span>
                        }
                    </RadzenAlert>
                }
                else
                {
                    <RadzenDataGrid TItem="GlossaryTermDto" Data="@FilteredTerms" Density="Density.Compact" AllowSorting="false" AllowPaging="false">
                        <Columns>
                            <RadzenDataGridColumn TItem="GlossaryTermDto" Title="Term">
                                <Template Context="term">
                                    <RadzenStack Gap="0">
                                        <RadzenText TextStyle="TextStyle.Body1" Style="font-weight: 500;">@term.SourceTerm</RadzenText>
                                        @if (!string.IsNullOrEmpty(term.Description))
                                        {
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">@term.Description</RadzenText>
                                        }
                                    </RadzenStack>
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="GlossaryTermDto" Title="Source" Width="80px">
                                <Template Context="term">
                                    <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="@term.SourceLanguage.ToUpperInvariant()" />
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="GlossaryTermDto" Title="Translations">
                                <Template Context="term">
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.25rem" Wrap="FlexWrap.Wrap">
                                        @foreach (var (lang, translation) in term.Translations.Take(3))
                                        {
                                            <span title="@translation">
                                                <RadzenBadge BadgeStyle="BadgeStyle.Light" Variant="Radzen.Variant.Outlined"
                                                             Text="@($"{lang.ToUpperInvariant()}: {TruncateText(translation, 20)}")" />
                                            </span>
                                        }
                                        @if (term.Translations.Count > 3)
                                        {
                                            <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@($"+{term.Translations.Count - 3}")" />
                                        }
                                    </RadzenStack>
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="GlossaryTermDto" Title="Scope" Width="100px">
                                <Template Context="term">
                                    @if (term.Scope == "organization")
                                    {
                                        <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="Org" />
                                    }
                                    else
                                    {
                                        <RadzenBadge BadgeStyle="BadgeStyle.Light" Text="Project" />
                                    }
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="GlossaryTermDto" Title="Actions" Width="120px">
                                <Template Context="term">
                                    @if (term.Scope == "project")
                                    {
                                        <RadzenButton Icon="edit" Variant="Radzen.Variant.Text" Size="ButtonSize.Small" Click="@(() => OpenEditDialog(term))" />
                                        <RadzenButton Icon="delete" Variant="Radzen.Variant.Text" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger" Click="@(() => ConfirmDelete(term))" />
                                    }
                                    else
                                    {
                                        <span title="Organization terms can only be edited in organization settings">
                                            <RadzenIcon Icon="lock" Style="font-size: 1rem;" class="rz-color-secondary" />
                                        </span>
                                    }
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                }
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <RadzenAlert AlertStyle="AlertStyle.Info" AllowClose="false" Density="Density.Compact" class="rz-mt-4">
        Glossary terms are automatically applied when translating. The translation provider will use these terms consistently.
    </RadzenAlert>
}

@code {
    [Parameter] public int ProjectId { get; set; }

    private ProjectDto? _project;
    private GlossaryListResponse? _glossary;
    private bool _isLoading = true;
    private string _searchTerm = "";
    private string _scopeFilter = "all";
    private string _languageFilter = "";

    // Inheritance toggle
    private bool _inheritOrgGlossary = true;
    private bool _isSavingInheritance;

    // Dialog state
    private GlossaryTermDto? _editingTerm;
    private string _formSourceTerm = "";
    private string _formSourceLanguage = "en";
    private string _formDescription = "";
    private bool _formCaseSensitive;
    private Dictionary<string, string> _formTranslations = new();
    private List<string> _availableLanguages = new() { "en", "fr", "de", "es", "it", "el", "pt", "nl", "pl", "ru", "ja", "zh", "ko" };

    private string _projectName = "";

    private List<(string Value, string Text)> _scopeOptions = new()
    {
        ("all", "All"),
        ("project", "Project Only"),
        ("organization", "Organization Only")
    };

    private List<GlossaryTermDto> FilteredTerms => _glossary?.Terms
        .Where(t => string.IsNullOrEmpty(_searchTerm) ||
                    t.SourceTerm.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    t.Description?.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) == true ||
                    t.Translations.Values.Any(v => v.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase)))
        .Where(t => _scopeFilter == "all" || t.Scope == _scopeFilter)
        .Where(t => string.IsNullOrEmpty(_languageFilter) ||
                    t.SourceLanguage == _languageFilter ||
                    t.Translations.ContainsKey(_languageFilter))
        .ToList() ?? new();

    private List<(string Value, string Text)> GetLanguageOptions()
    {
        var options = new List<(string Value, string Text)> { ("", "All Languages") };
        if (_glossary != null)
        {
            options.AddRange(_glossary.Languages.Select(l => (l, l.ToUpperInvariant())));
        }
        return options;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadProjectInfoAsync();
        await LoadGlossaryAsync();
    }

    private async Task LoadProjectInfoAsync()
    {
        _project = await ProjectService.GetProjectAsync(ProjectId);
        if (_project != null)
        {
            _projectName = _project.Name;
            _inheritOrgGlossary = _project.InheritOrganizationGlossary;
        }
    }

    private async Task OnInheritanceChanged()
    {
        _isSavingInheritance = true;
        try
        {
            var request = new UpdateProjectRequest
            {
                InheritOrganizationGlossary = _inheritOrgGlossary
            };

            var result = await ProjectService.UpdateProjectAsync(ProjectId, request);
            if (result.IsSuccess)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", _inheritOrgGlossary ? "Organization glossary enabled" : "Organization glossary disabled");
                await LoadGlossaryAsync();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", result.ErrorMessage ?? "Failed to update setting");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
        finally
        {
            _isSavingInheritance = false;
        }
    }

    private async Task LoadGlossaryAsync()
    {
        _isLoading = true;
        try
        {
            _glossary = await GlossaryService.GetProjectGlossaryAsync(ProjectId);

            if (_glossary?.Languages.Count > 0)
            {
                _availableLanguages = _glossary.Languages
                    .Union(_availableLanguages)
                    .Distinct()
                    .OrderBy(l => l)
                    .ToList();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error loading glossary: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OpenAddDialog()
    {
        _editingTerm = null;
        _formSourceTerm = "";
        _formSourceLanguage = "en";
        _formDescription = "";
        _formCaseSensitive = false;
        _formTranslations = new Dictionary<string, string>();
        foreach (var lang in _availableLanguages.Where(l => l != "en"))
        {
            _formTranslations[lang] = "";
        }

        await ShowTermDialog("Add Glossary Term");
    }

    private async Task OpenEditDialog(GlossaryTermDto term)
    {
        _editingTerm = term;
        _formSourceTerm = term.SourceTerm;
        _formSourceLanguage = term.SourceLanguage;
        _formDescription = term.Description ?? "";
        _formCaseSensitive = term.CaseSensitive;
        _formTranslations = new Dictionary<string, string>(term.Translations);

        foreach (var lang in _availableLanguages.Where(l => l != term.SourceLanguage))
        {
            if (!_formTranslations.ContainsKey(lang))
                _formTranslations[lang] = "";
        }

        await ShowTermDialog("Edit Glossary Term");
    }

    private async Task ShowTermDialog(string title)
    {
        var result = await DialogService.OpenAsync(title, ds =>
            @<RadzenStack Gap="1rem">
                <RadzenFormField Text="Source Term" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <RadzenTextBox @bind-Value="_formSourceTerm" Placeholder="e.g., Dashboard" Style="width: 100%;" />
                </RadzenFormField>

                <RadzenFormField Text="Source Language" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <RadzenDropDown @bind-Value="_formSourceLanguage" Data="@_availableLanguages" Style="width: 100%;">
                        <Template Context="lang">@lang.ToUpperInvariant()</Template>
                    </RadzenDropDown>
                </RadzenFormField>

                <RadzenFormField Text="Description (optional)" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <RadzenTextArea @bind-Value="_formDescription" Rows="2" Placeholder="Context or usage notes" Style="width: 100%;" />
                </RadzenFormField>

                <RadzenCheckBox @bind-Value="_formCaseSensitive" TValue="bool">
                    <Template>Case-sensitive matching</Template>
                </RadzenCheckBox>

                <hr />

                <RadzenText TextStyle="TextStyle.Subtitle1">Translations</RadzenText>
                @foreach (var lang in _availableLanguages.Where(l => l != _formSourceLanguage))
                {
                    <RadzenFormField Text="@($"Translation ({lang.ToUpperInvariant()})")" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                        <RadzenTextBox Value="@GetTranslation(lang)" ValueChanged="@(v => SetTranslation(lang, v))" Placeholder="@($"Enter translation in {lang.ToUpperInvariant()}")" Style="width: 100%;" />
                    </RadzenFormField>
                }

                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem" class="rz-mt-4">
                    <RadzenButton Variant="Radzen.Variant.Text" Text="Cancel" Click="@(() => ds.Close(false))" />
                    <RadzenButton Variant="Radzen.Variant.Filled" ButtonStyle="ButtonStyle.Primary"
                                  Text="@(_editingTerm == null ? "Add" : "Save")"
                                  Click="@(() => ds.Close(true))"
                                  Disabled="@(string.IsNullOrWhiteSpace(_formSourceTerm) || string.IsNullOrWhiteSpace(_formSourceLanguage))" />
                </RadzenStack>
            </RadzenStack>,
            new Radzen.DialogOptions { Width = "500px" });

        if (result == true)
        {
            await SaveTerm();
        }
    }

    private string GetTranslation(string lang) => _formTranslations.TryGetValue(lang, out var val) ? val : "";

    private void SetTranslation(string lang, string value) => _formTranslations[lang] = value;

    private async Task SaveTerm()
    {
        if (string.IsNullOrWhiteSpace(_formSourceTerm) || string.IsNullOrWhiteSpace(_formSourceLanguage))
            return;

        try
        {
            var translations = _formTranslations
                .Where(kv => !string.IsNullOrWhiteSpace(kv.Value))
                .ToDictionary(kv => kv.Key, kv => kv.Value);

            if (_editingTerm == null)
            {
                var request = new CreateGlossaryTermRequest
                {
                    SourceTerm = _formSourceTerm,
                    SourceLanguage = _formSourceLanguage,
                    Description = string.IsNullOrWhiteSpace(_formDescription) ? null : _formDescription,
                    CaseSensitive = _formCaseSensitive,
                    Translations = translations
                };

                await GlossaryService.CreateProjectTermAsync(ProjectId, request);
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Term added successfully");
            }
            else
            {
                var request = new UpdateGlossaryTermRequest
                {
                    SourceTerm = _formSourceTerm,
                    SourceLanguage = _formSourceLanguage,
                    Description = string.IsNullOrWhiteSpace(_formDescription) ? null : _formDescription,
                    CaseSensitive = _formCaseSensitive,
                    Translations = translations
                };

                await GlossaryService.UpdateProjectTermAsync(ProjectId, _editingTerm.Id, request);
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Term updated successfully");
            }

            await LoadGlossaryAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
    }

    private async Task ConfirmDelete(GlossaryTermDto term)
    {
        var confirmed = await DialogService.Confirm(
            $"Are you sure you want to delete the term \"{term.SourceTerm}\"?",
            "Delete Term",
            new ConfirmOptions { OkButtonText = "Delete", CancelButtonText = "Cancel" });

        if (confirmed == true)
        {
            try
            {
                await GlossaryService.DeleteProjectTermAsync(ProjectId, term.Id);
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Term deleted");
                await LoadGlossaryAsync();
            }
            catch (Exception ex)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
            }
        }
    }

    private static string TruncateText(string text, int maxLength)
    {
        if (string.IsNullOrEmpty(text) || text.Length <= maxLength)
            return text;
        return text[..maxLength] + "...";
    }
}
