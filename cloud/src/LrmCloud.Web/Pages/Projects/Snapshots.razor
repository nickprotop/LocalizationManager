@page "/projects/{ProjectId:int}/snapshots"
@attribute [Authorize]
@using LrmCloud.Shared.DTOs.Snapshots
@using LrmCloud.Shared.DTOs.Projects
@inject SnapshotService SnapshotService
@inject ProjectService ProjectService
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject Radzen.DialogService DialogService

<PageTitle>Snapshots - @(_project?.Name ?? "Project") - LRM Cloud</PageTitle>

@if (_isLoading)
{
    <RadzenStack Gap="1rem">
        <RadzenSkeleton Style="height: 60px; width: 100%;" />
        <RadzenSkeleton Style="height: 400px; width: 100%;" />
    </RadzenStack>
}
else if (_project == null)
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" AllowClose="false">
        Project not found or you don't have access to it.
        <RadzenButton Variant="Radzen.Variant.Text" ButtonStyle="ButtonStyle.Primary" Text="Go to Dashboard" Click="@(() => Navigation.NavigateTo(""))" />
    </RadzenAlert>
}
else
{
    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" class="rz-mb-4">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
            <RadzenButton Icon="arrow_back" Variant="Radzen.Variant.Text" Click="@(() => Navigation.NavigateTo($"projects/{ProjectId}"))" Size="ButtonSize.Small" />
            <RadzenText TextStyle="TextStyle.H4">Snapshots</RadzenText>
            <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@_project.Name" />
        </RadzenStack>

        <RadzenButton Variant="Radzen.Variant.Filled" ButtonStyle="ButtonStyle.Primary" Icon="add_circle"
                      Text="Create Snapshot" Click="@OpenCreateDialog" Disabled="@_isCreating" IsBusy="@_isCreating" />
    </RadzenStack>

    <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary rz-mb-4">
        Snapshots are point-in-time backups of your project's translations. Use them to track changes and restore to previous states.
    </RadzenText>

    @if (_snapshots.Count == 0)
    {
        <RadzenCard Style="padding: 3rem;">
            <RadzenStack AlignItems="Radzen.AlignItems.Center" JustifyContent="JustifyContent.Center" Gap="1rem">
                <RadzenIcon Icon="history" Style="font-size: 3rem;" class="rz-color-secondary" />
                <RadzenText TextStyle="TextStyle.H6" class="rz-color-secondary">No snapshots yet</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="text-align: center;">
                    Snapshots are created automatically when you push changes from the CLI.<br/>
                    You can also create manual snapshots using the button above.
                </RadzenText>
            </RadzenStack>
        </RadzenCard>
    }
    else
    {
        <RadzenStack Gap="1rem">
            @foreach (var snapshot in _snapshots)
            {
                <RadzenCard Style="@($"border-left: 4px solid {GetSnapshotTypeColorValue(snapshot.SnapshotType)};")">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Start">
                        <RadzenStack Gap="0.5rem">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" Wrap="FlexWrap.Wrap">
                                <RadzenText TextStyle="TextStyle.Subtitle1" Style="font-family: monospace;">@snapshot.SnapshotId</RadzenText>
                                <RadzenBadge BadgeStyle="@GetSnapshotTypeBadgeStyle(snapshot.SnapshotType)" Variant="Radzen.Variant.Outlined" Text="@snapshot.SnapshotType" />
                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                    @snapshot.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy HH:mm")
                                </RadzenText>
                            </RadzenStack>

                            @if (!string.IsNullOrEmpty(snapshot.Description))
                            {
                                <RadzenText TextStyle="TextStyle.Body2">@snapshot.Description</RadzenText>
                            }

                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" Wrap="FlexWrap.Wrap">
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                                    <RadzenIcon Icon="description" Style="font-size: 1rem;" class="rz-color-secondary" />
                                    <RadzenText TextStyle="TextStyle.Caption">@snapshot.FileCount files</RadzenText>
                                </RadzenStack>
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                                    <RadzenIcon Icon="key" Style="font-size: 1rem;" class="rz-color-secondary" />
                                    <RadzenText TextStyle="TextStyle.Caption">@snapshot.KeyCount keys</RadzenText>
                                </RadzenStack>
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                                    <RadzenIcon Icon="translate" Style="font-size: 1rem;" class="rz-color-secondary" />
                                    <RadzenText TextStyle="TextStyle.Caption">@snapshot.TranslationCount translations</RadzenText>
                                </RadzenStack>
                                @if (!string.IsNullOrEmpty(snapshot.CreatedByUsername))
                                {
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                                        <RadzenIcon Icon="person" Style="font-size: 1rem;" class="rz-color-secondary" />
                                        <RadzenText TextStyle="TextStyle.Caption">@snapshot.CreatedByUsername</RadzenText>
                                    </RadzenStack>
                                }
                            </RadzenStack>
                        </RadzenStack>

                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.25rem">
                            <RadzenButton Icon="visibility" Variant="Radzen.Variant.Text" Size="ButtonSize.Small"
                                          Click="@(() => ViewSnapshotAsync(snapshot))" title="View details" />
                            <RadzenButton Icon="compare" Variant="Radzen.Variant.Text" Size="ButtonSize.Small"
                                          ButtonStyle="ButtonStyle.Info" Click="@(() => OpenCompareDialog(snapshot))"
                                          Disabled="@(_snapshots.Count < 2)" title="Compare with another snapshot" />
                            <RadzenButton Icon="restore" Variant="Radzen.Variant.Text" Size="ButtonSize.Small"
                                          ButtonStyle="ButtonStyle.Warning" Click="@(() => OpenRestoreDialog(snapshot))" title="Restore to this snapshot" />
                            <RadzenButton Icon="delete" Variant="Radzen.Variant.Text" Size="ButtonSize.Small"
                                          ButtonStyle="ButtonStyle.Danger" Click="@(() => OpenDeleteDialog(snapshot))" title="Delete snapshot" />
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>
            }
        </RadzenStack>
    }
}

@code {
    [Parameter]
    public int ProjectId { get; set; }

    private ProjectDto? _project;
    private List<SnapshotDto> _snapshots = new();
    private bool _isLoading = true;

    // Create dialog
    private string _createDescription = "";
    private bool _isCreating;

    // View dialog
    private SnapshotDto? _viewSnapshot;
    private SnapshotDetailDto? _viewSnapshotDetail;

    // Restore dialog
    private SnapshotDto? _restoreSnapshot;
    private bool _restoreCreateBackup = true;
    private string _restoreMessage = "";
    private bool _isRestoring;
    private bool _hasUnsnapshotedChanges;
    private DateTime? _lastChangeAt;

    // Delete dialog
    private SnapshotDto? _deleteSnapshot;
    private bool _isDeleting;

    // Compare dialog
    private SnapshotDto? _compareFromSnapshot;
    private SnapshotDto? _compareToSnapshot;
    private SnapshotDiffDto? _compareDiff;
    private bool _isComparing;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            _project = await ProjectService.GetProjectAsync(ProjectId);
            if (_project != null)
            {
                _snapshots = await SnapshotService.GetSnapshotsAsync(ProjectId);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error loading snapshots: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    // Create dialog
    private async Task OpenCreateDialog()
    {
        _createDescription = "";

        var result = await DialogService.OpenAsync("Create Manual Snapshot", ds =>
            @<RadzenStack Gap="1rem">
                <RadzenFormField Text="Description (optional)" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <RadzenTextArea @bind-Value="_createDescription" Rows="3" Placeholder="e.g., Before major refactoring" Style="width: 100%;" />
                </RadzenFormField>

                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem" class="rz-mt-4">
                    <RadzenButton Variant="Radzen.Variant.Text" Text="Cancel" Click="@(() => ds.Close(false))" />
                    <RadzenButton Variant="Radzen.Variant.Filled" ButtonStyle="ButtonStyle.Primary" Text="Create Snapshot"
                                  Click="@(() => ds.Close(true))" Disabled="@_isCreating" IsBusy="@_isCreating" />
                </RadzenStack>
            </RadzenStack>,
            new Radzen.DialogOptions { Width = "500px" });

        if (result == true)
        {
            await CreateSnapshotAsync();
        }
    }

    private async Task CreateSnapshotAsync()
    {
        _isCreating = true;
        try
        {
            var result = await SnapshotService.CreateSnapshotAsync(ProjectId, string.IsNullOrWhiteSpace(_createDescription) ? null : _createDescription);
            if (result.IsSuccess && result.Data != null)
            {
                _snapshots.Insert(0, result.Data);
                NotificationService.Notify(NotificationSeverity.Success, "Success", $"Snapshot {result.Data.SnapshotId} created successfully");
                StateHasChanged();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", result.ErrorMessage ?? "Failed to create snapshot");
            }
        }
        finally
        {
            _isCreating = false;
        }
    }

    // View dialog
    private async Task ViewSnapshotAsync(SnapshotDto snapshot)
    {
        _viewSnapshot = snapshot;
        _viewSnapshotDetail = null;

        try
        {
            _viewSnapshotDetail = await SnapshotService.GetSnapshotAsync(ProjectId, snapshot.SnapshotId);

            await DialogService.OpenAsync("Snapshot Details", ds =>
                @<RadzenStack Gap="1rem">
                    <RadzenRow Gap="1rem">
                        <RadzenColumn Size="12" SizeSM="6">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Snapshot ID</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body1" Style="font-family: monospace;">@_viewSnapshot.SnapshotId</RadzenText>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeSM="6">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Type</RadzenText>
                            <RadzenBadge BadgeStyle="@GetSnapshotTypeBadgeStyle(_viewSnapshot.SnapshotType)" Text="@_viewSnapshot.SnapshotType" />
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeSM="6">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Created</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body1">@_viewSnapshot.CreatedAt.ToLocalTime().ToString("g")</RadzenText>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeSM="6">
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Created By</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body1">@(_viewSnapshot.CreatedByUsername ?? "System")</RadzenText>
                        </RadzenColumn>
                    </RadzenRow>

                    @if (!string.IsNullOrEmpty(_viewSnapshot.Description))
                    {
                        <div>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Description</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body1">@_viewSnapshot.Description</RadzenText>
                        </div>
                    }

                    <RadzenRow Gap="1rem">
                        <RadzenColumn Size="4">
                            <RadzenCard Style="text-align: center;">
                                <RadzenText TextStyle="TextStyle.H5">@_viewSnapshot.FileCount</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption">Files</RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                        <RadzenColumn Size="4">
                            <RadzenCard Style="text-align: center;">
                                <RadzenText TextStyle="TextStyle.H5">@_viewSnapshot.KeyCount</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption">Keys</RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                        <RadzenColumn Size="4">
                            <RadzenCard Style="text-align: center;">
                                <RadzenText TextStyle="TextStyle.H5">@_viewSnapshot.TranslationCount</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption">Translations</RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                    </RadzenRow>

                    @if (_viewSnapshotDetail?.Files?.Any() == true)
                    {
                        <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mt-4 rz-mb-2">Files in Snapshot</RadzenText>
                        <div style="max-height: 200px; overflow-y: auto;">
                            <RadzenDataGrid TItem="SnapshotFileDto" Data="@_viewSnapshotDetail.Files" Density="Density.Compact" AllowSorting="false" AllowPaging="false">
                                <Columns>
                                    <RadzenDataGridColumn TItem="SnapshotFileDto" Property="Path" Title="Path" />
                                    <RadzenDataGridColumn TItem="SnapshotFileDto" Property="LanguageCode" Title="Language" Width="100px">
                                        <Template Context="file">
                                            @if (!string.IsNullOrEmpty(file.LanguageCode))
                                            {
                                                <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@file.LanguageCode" />
                                            }
                                        </Template>
                                    </RadzenDataGridColumn>
                                </Columns>
                            </RadzenDataGrid>
                        </div>
                    }

                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem" class="rz-mt-4">
                        <RadzenButton Variant="Radzen.Variant.Text" Text="Close" Click="@(() => ds.Close())" />
                    </RadzenStack>
                </RadzenStack>,
                new Radzen.DialogOptions { Width = "600px" });
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error loading snapshot details: {ex.Message}");
        }
    }

    // Restore dialog
    private async Task OpenRestoreDialog(SnapshotDto snapshot)
    {
        _restoreSnapshot = snapshot;
        _restoreCreateBackup = true;
        _restoreMessage = "";
        _hasUnsnapshotedChanges = false;
        _lastChangeAt = null;

        // Check for unsnapshot-ed changes
        var unsnapshotedChanges = await SnapshotService.CheckUnsnapshotedChangesAsync(ProjectId);
        if (unsnapshotedChanges != null)
        {
            _hasUnsnapshotedChanges = unsnapshotedChanges.HasUnsnapshotedChanges;
            _lastChangeAt = unsnapshotedChanges.LastChangeAt;
        }

        var result = await DialogService.OpenAsync("Restore Snapshot", ds =>
            @<RadzenStack Gap="1rem">
                @if (_hasUnsnapshotedChanges)
                {
                    <RadzenAlert AlertStyle="AlertStyle.Danger" AllowClose="false">
                        <strong>Warning:</strong> There are unsaved changes since the last snapshot
                        @if (_lastChangeAt.HasValue)
                        {
                            <span> (last change: @_lastChangeAt.Value.ToLocalTime().ToString("g"))</span>
                        }
                        that may be lost if you restore without creating a backup.
                    </RadzenAlert>
                }

                <RadzenAlert AlertStyle="AlertStyle.Warning" AllowClose="false">
                    This will replace your current project state with the snapshot from <strong>@_restoreSnapshot?.CreatedAt.ToLocalTime().ToString("g")</strong>.
                </RadzenAlert>

                <RadzenCheckBox @bind-Value="_restoreCreateBackup" TValue="bool">
                    <Template>Create backup of current state before restoring</Template>
                </RadzenCheckBox>

                <RadzenFormField Text="Restore message (optional)" Variant="Radzen.Variant.Outlined" Style="width: 100%;">
                    <RadzenTextBox @bind-Value="_restoreMessage" Placeholder="e.g., Rolling back breaking changes" Style="width: 100%;" />
                </RadzenFormField>

                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem" class="rz-mt-4">
                    <RadzenButton Variant="Radzen.Variant.Text" Text="Cancel" Click="@(() => ds.Close(false))" />
                    <RadzenButton Variant="Radzen.Variant.Filled" ButtonStyle="ButtonStyle.Warning" Text="Restore"
                                  Click="@(() => ds.Close(true))" Disabled="@_isRestoring" IsBusy="@_isRestoring" />
                </RadzenStack>
            </RadzenStack>,
            new Radzen.DialogOptions { Width = "500px" });

        if (result == true)
        {
            await RestoreSnapshotAsync();
        }
    }

    private async Task RestoreSnapshotAsync()
    {
        if (_restoreSnapshot == null) return;

        _isRestoring = true;
        try
        {
            var result = await SnapshotService.RestoreSnapshotAsync(
                ProjectId,
                _restoreSnapshot.SnapshotId,
                _restoreCreateBackup,
                string.IsNullOrWhiteSpace(_restoreMessage) ? null : _restoreMessage);

            if (result.IsSuccess)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", $"Project restored to snapshot {_restoreSnapshot.SnapshotId}");
                await LoadDataAsync();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", result.ErrorMessage ?? "Failed to restore snapshot");
            }
        }
        finally
        {
            _isRestoring = false;
        }
    }

    // Delete dialog
    private async Task OpenDeleteDialog(SnapshotDto snapshot)
    {
        _deleteSnapshot = snapshot;

        var confirmed = await DialogService.Confirm(
            $"Are you sure you want to delete snapshot {snapshot.SnapshotId}? This action cannot be undone.",
            "Delete Snapshot?",
            new ConfirmOptions { OkButtonText = "Delete", CancelButtonText = "Cancel" });

        if (confirmed == true)
        {
            await DeleteSnapshotAsync();
        }
    }

    private async Task DeleteSnapshotAsync()
    {
        if (_deleteSnapshot == null) return;

        _isDeleting = true;
        try
        {
            var result = await SnapshotService.DeleteSnapshotAsync(ProjectId, _deleteSnapshot.SnapshotId);
            if (result.IsSuccess)
            {
                _snapshots.Remove(_deleteSnapshot);
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Snapshot deleted successfully");
                StateHasChanged();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", result.ErrorMessage ?? "Failed to delete snapshot");
            }
        }
        finally
        {
            _isDeleting = false;
        }
    }

    // Compare dialog
    private async Task OpenCompareDialog(SnapshotDto snapshot)
    {
        _compareFromSnapshot = snapshot;
        _compareToSnapshot = null;
        _compareDiff = null;

        var result = await DialogService.OpenAsync("Compare Snapshots", ds =>
            @<RadzenStack Gap="1rem">
                <RadzenRow Gap="1rem">
                    <RadzenColumn Size="12" SizeMD="5">
                        <RadzenCard>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">From (Base)</RadzenText>
                            <RadzenText TextStyle="TextStyle.Subtitle1" Style="font-family: monospace;">@_compareFromSnapshot.SnapshotId</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body2" class="text-truncate">@(_compareFromSnapshot.Description ?? "No description")</RadzenText>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">@_compareFromSnapshot.CreatedAt.ToLocalTime().ToString("g")</RadzenText>
                        </RadzenCard>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="2" Style="display: flex; align-items: center; justify-content: center;">
                        <RadzenIcon Icon="arrow_forward" Style="font-size: 2rem;" class="rz-color-secondary" />
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="5">
                        <RadzenCard>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">To (Compare)</RadzenText>
                            @if (_compareToSnapshot == null)
                            {
                                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary" Style="font-style: italic;">Select a snapshot below</RadzenText>
                            }
                            else
                            {
                                <RadzenText TextStyle="TextStyle.Subtitle1" Style="font-family: monospace;">@_compareToSnapshot.SnapshotId</RadzenText>
                                <RadzenText TextStyle="TextStyle.Body2" class="text-truncate">@(_compareToSnapshot.Description ?? "No description")</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">@_compareToSnapshot.CreatedAt.ToLocalTime().ToString("g")</RadzenText>
                            }
                        </RadzenCard>
                    </RadzenColumn>
                </RadzenRow>

                <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mt-4 rz-mb-2">Select snapshot to compare with:</RadzenText>
                <div style="max-height: 200px; overflow-y: auto;">
                    <RadzenDataGrid TItem="SnapshotDto"
                                    Data="@_snapshots.Where(s => s.SnapshotId != _compareFromSnapshot.SnapshotId)"
                                    Density="Density.Compact" AllowSorting="false" AllowPaging="false"
                                    SelectionMode="DataGridSelectionMode.Single" @bind-Value="@_compareToSnapshotList">
                        <Columns>
                            <RadzenDataGridColumn TItem="SnapshotDto" Property="SnapshotId" Title="ID" Width="150px">
                                <Template Context="s">
                                    <span style="font-family: monospace;">@s.SnapshotId</span>
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="SnapshotDto" Property="SnapshotType" Title="Type" Width="100px">
                                <Template Context="s">
                                    <RadzenBadge BadgeStyle="@GetSnapshotTypeBadgeStyle(s.SnapshotType)" Variant="Radzen.Variant.Outlined" Text="@s.SnapshotType" />
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="SnapshotDto" Property="CreatedAt" Title="Created">
                                <Template Context="s">@s.CreatedAt.ToLocalTime().ToString("g")</Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                </div>

                @if (_compareDiff != null)
                {
                    <hr />
                    <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mb-2">
                        <RadzenIcon Icon="difference" Style="font-size: 1rem;" />
                        Comparison Results
                    </RadzenText>

                    <RadzenRow Gap="1rem">
                        <RadzenColumn Size="4">
                            <RadzenCard Style="border-left: 3px solid var(--rz-success); text-align: center;">
                                <RadzenText TextStyle="TextStyle.H5" Style="color: var(--rz-success);">@_compareDiff.KeysAdded</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption">Keys Added</RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                        <RadzenColumn Size="4">
                            <RadzenCard Style="border-left: 3px solid var(--rz-danger); text-align: center;">
                                <RadzenText TextStyle="TextStyle.H5" Style="color: var(--rz-danger);">@_compareDiff.KeysRemoved</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption">Keys Removed</RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                        <RadzenColumn Size="4">
                            <RadzenCard Style="border-left: 3px solid var(--rz-warning); text-align: center;">
                                <RadzenText TextStyle="TextStyle.H5" Style="color: var(--rz-warning);">@_compareDiff.KeysModified</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption">Keys Modified</RadzenText>
                            </RadzenCard>
                        </RadzenColumn>
                    </RadzenRow>

                    @if (_compareDiff.Files?.Any() == true)
                    {
                        <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mt-4 rz-mb-2">Changed Files</RadzenText>
                        <div style="max-height: 150px; overflow-y: auto;">
                            <RadzenDataGrid TItem="SnapshotDiffFileDto" Data="@_compareDiff.Files" Density="Density.Compact" AllowSorting="false" AllowPaging="false">
                                <Columns>
                                    <RadzenDataGridColumn TItem="SnapshotDiffFileDto" Title="Change" Width="80px">
                                        <Template Context="file">
                                            <RadzenBadge BadgeStyle="@GetChangeTypeBadgeStyle(file.ChangeType)" Variant="Radzen.Variant.Text" Text="@file.ChangeType" />
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="SnapshotDiffFileDto" Property="Path" Title="Path" />
                                </Columns>
                            </RadzenDataGrid>
                        </div>
                    }
                }
                else if (_isComparing)
                {
                    <RadzenStack AlignItems="Radzen.AlignItems.Center" class="rz-mt-4">
                        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Comparing snapshots...</RadzenText>
                    </RadzenStack>
                }

                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem" class="rz-mt-4">
                    <RadzenButton Variant="Radzen.Variant.Text" Text="Close" Click="@(() => ds.Close())" />
                    <RadzenButton Variant="Radzen.Variant.Filled" ButtonStyle="ButtonStyle.Info" Text="Compare"
                                  Click="@CompareSnapshotsAsync" Disabled="@(_compareToSnapshot == null || _isComparing)" IsBusy="@_isComparing" />
                </RadzenStack>
            </RadzenStack>,
            new Radzen.DialogOptions { Width = "700px" });
    }

    private IList<SnapshotDto>? _compareToSnapshotList
    {
        get => _compareToSnapshot != null ? new List<SnapshotDto> { _compareToSnapshot } : null;
        set => _compareToSnapshot = value?.FirstOrDefault();
    }

    private async Task CompareSnapshotsAsync()
    {
        if (_compareFromSnapshot == null || _compareToSnapshot == null) return;

        _isComparing = true;
        _compareDiff = null;
        try
        {
            _compareDiff = await SnapshotService.DiffSnapshotsAsync(
                ProjectId,
                _compareFromSnapshot.SnapshotId,
                _compareToSnapshot.SnapshotId);

            if (_compareDiff == null)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to compare snapshots");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Error comparing snapshots: {ex.Message}");
        }
        finally
        {
            _isComparing = false;
            StateHasChanged();
        }
    }

    private static string GetSnapshotTypeColorValue(string type) => type.ToLower() switch
    {
        "push" => "var(--rz-primary)",
        "manual" => "var(--rz-info)",
        "restore" => "var(--rz-warning)",
        "auto" => "var(--rz-secondary)",
        _ => "var(--rz-base-600)"
    };

    private static BadgeStyle GetSnapshotTypeBadgeStyle(string type) => type.ToLower() switch
    {
        "push" => BadgeStyle.Primary,
        "manual" => BadgeStyle.Info,
        "restore" => BadgeStyle.Warning,
        "auto" => BadgeStyle.Secondary,
        _ => BadgeStyle.Light
    };

    private static BadgeStyle GetChangeTypeBadgeStyle(string changeType) => changeType.ToLower() switch
    {
        "added" => BadgeStyle.Success,
        "removed" => BadgeStyle.Danger,
        "modified" => BadgeStyle.Warning,
        _ => BadgeStyle.Light
    };
}
