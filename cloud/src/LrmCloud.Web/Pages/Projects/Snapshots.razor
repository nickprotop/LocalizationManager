@page "/projects/{ProjectId:int}/snapshots"
@attribute [Authorize]
@using LrmCloud.Shared.DTOs.Snapshots
@using LrmCloud.Shared.DTOs.Projects
@inject SnapshotService SnapshotService
@inject ProjectService ProjectService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Snapshots - @(_project?.Name ?? "Project") - LRM Cloud</PageTitle>

@if (_isLoading)
{
    <MudStack Spacing="4">
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="60px" />
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="400px" />
    </MudStack>
}
else if (_project == null)
{
    <MudAlert Severity="Severity.Error">
        Project not found or you don't have access to it.
        <MudButton Variant="Variant.Text" Color="Color.Primary" Href="/app">Go to Dashboard</MudButton>
    </MudAlert>
}
else
{
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                           OnClick="@(() => Navigation.NavigateTo($"/app/projects/{ProjectId}"))"
                           Size="Size.Small" />
            <MudText Typo="Typo.h4">Snapshots</MudText>
            <MudChip T="string" Size="Size.Small" Color="Color.Info">@_project.Name</MudChip>
        </MudStack>

        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.AddCircle"
                   OnClick="@OpenCreateDialog"
                   Disabled="@_isCreating">
            @if (_isCreating)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Creating...</span>
            }
            else
            {
                <span>Create Snapshot</span>
            }
        </MudButton>
    </MudStack>

    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
        Snapshots are point-in-time backups of your project's translations. Use them to track changes and restore to previous states.
    </MudText>

    @if (_snapshots.Count == 0)
    {
        <MudPaper Class="pa-6" Elevation="2">
            <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Spacing="3">
                <MudIcon Icon="@Icons.Material.Filled.History" Size="Size.Large" Color="Color.Secondary" />
                <MudText Typo="Typo.h6" Color="Color.Secondary">No snapshots yet</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center">
                    Snapshots are created automatically when you push changes from the CLI.<br/>
                    You can also create manual snapshots using the button above.
                </MudText>
            </MudStack>
        </MudPaper>
    }
    else
    {
        <MudTimeline TimelinePosition="TimelinePosition.Start">
            @foreach (var snapshot in _snapshots)
            {
                <MudTimelineItem Color="@GetSnapshotTypeColor(snapshot.SnapshotType)" Size="Size.Medium">
                    <ItemOpposite>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            @snapshot.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy")
                        </MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            @snapshot.CreatedAt.ToLocalTime().ToString("HH:mm")
                        </MudText>
                    </ItemOpposite>
                    <ItemContent>
                        <MudPaper Class="pa-4" Elevation="2">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                                <div>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
                                        <MudText Typo="Typo.subtitle1" Style="font-family: monospace;">
                                            @snapshot.SnapshotId
                                        </MudText>
                                        <MudChip T="string" Size="Size.Small" Color="@GetSnapshotTypeColor(snapshot.SnapshotType)" Variant="Variant.Outlined">
                                            @snapshot.SnapshotType
                                        </MudChip>
                                    </MudStack>
                                    @if (!string.IsNullOrEmpty(snapshot.Description))
                                    {
                                        <MudText Typo="Typo.body2" Class="mb-2">@snapshot.Description</MudText>
                                    }
                                    <MudStack Row="true" Spacing="3">
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                            <MudIcon Icon="@Icons.Material.Filled.InsertDriveFile" Size="Size.Small" Color="Color.Secondary" />
                                            <MudText Typo="Typo.caption">@snapshot.FileCount files</MudText>
                                        </MudStack>
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                            <MudIcon Icon="@Icons.Material.Filled.Key" Size="Size.Small" Color="Color.Secondary" />
                                            <MudText Typo="Typo.caption">@snapshot.KeyCount keys</MudText>
                                        </MudStack>
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                            <MudIcon Icon="@Icons.Material.Filled.Translate" Size="Size.Small" Color="Color.Secondary" />
                                            <MudText Typo="Typo.caption">@snapshot.TranslationCount translations</MudText>
                                        </MudStack>
                                        @if (!string.IsNullOrEmpty(snapshot.CreatedByUsername))
                                        {
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Color="Color.Secondary" />
                                                <MudText Typo="Typo.caption">@snapshot.CreatedByUsername</MudText>
                                            </MudStack>
                                        }
                                    </MudStack>
                                </div>
                                <MudStack Row="true" Spacing="1">
                                    <MudTooltip Text="View details">
                                        <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                                       Size="Size.Small"
                                                       OnClick="@(() => ViewSnapshotAsync(snapshot))" />
                                    </MudTooltip>
                                    <MudTooltip Text="Compare with another snapshot">
                                        <MudIconButton Icon="@Icons.Material.Filled.Compare"
                                                       Size="Size.Small"
                                                       Color="Color.Info"
                                                       OnClick="@(() => OpenCompareDialog(snapshot))"
                                                       Disabled="@(_snapshots.Count < 2)" />
                                    </MudTooltip>
                                    <MudTooltip Text="Restore to this snapshot">
                                        <MudIconButton Icon="@Icons.Material.Filled.Restore"
                                                       Size="Size.Small"
                                                       Color="Color.Warning"
                                                       OnClick="@(() => OpenRestoreDialog(snapshot))" />
                                    </MudTooltip>
                                    <MudTooltip Text="Delete snapshot">
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                       Size="Size.Small"
                                                       Color="Color.Error"
                                                       OnClick="@(() => OpenDeleteDialog(snapshot))" />
                                    </MudTooltip>
                                </MudStack>
                            </MudStack>
                        </MudPaper>
                    </ItemContent>
                </MudTimelineItem>
            }
        </MudTimeline>
    }
}

@* Create Snapshot Dialog *@
<MudDialog @bind-Visible="_createDialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">Create Manual Snapshot</MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="_createDescription"
                      Label="Description (optional)"
                      Placeholder="e.g., Before major refactoring"
                      HelperText="A brief description of this snapshot"
                      Lines="2"
                      Class="mb-3" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseCreateDialog">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateSnapshotAsync" Disabled="_isCreating">
            @if (_isCreating)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Create Snapshot
        </MudButton>
    </DialogActions>
</MudDialog>

@* View Snapshot Dialog *@
<MudDialog @bind-Visible="_viewDialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">Snapshot Details</MudText>
    </TitleContent>
    <DialogContent>
        @if (_viewSnapshot != null)
        {
            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Snapshot ID</MudText>
                    <MudText Typo="Typo.body1" Style="font-family: monospace;">@_viewSnapshot.SnapshotId</MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Type</MudText>
                    <MudChip T="string" Size="Size.Small" Color="@GetSnapshotTypeColor(_viewSnapshot.SnapshotType)">@_viewSnapshot.SnapshotType</MudChip>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Created</MudText>
                    <MudText Typo="Typo.body1">@_viewSnapshot.CreatedAt.ToLocalTime().ToString("g")</MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Created By</MudText>
                    <MudText Typo="Typo.body1">@(_viewSnapshot.CreatedByUsername ?? "System")</MudText>
                </MudItem>
                @if (!string.IsNullOrEmpty(_viewSnapshot.Description))
                {
                    <MudItem xs="12">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Description</MudText>
                        <MudText Typo="Typo.body1">@_viewSnapshot.Description</MudText>
                    </MudItem>
                }
                <MudItem xs="4">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Files</MudText>
                    <MudText Typo="Typo.body1">@_viewSnapshot.FileCount</MudText>
                </MudItem>
                <MudItem xs="4">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Keys</MudText>
                    <MudText Typo="Typo.body1">@_viewSnapshot.KeyCount</MudText>
                </MudItem>
                <MudItem xs="4">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Translations</MudText>
                    <MudText Typo="Typo.body1">@_viewSnapshot.TranslationCount</MudText>
                </MudItem>
            </MudGrid>

            @if (_viewSnapshotDetail?.Files?.Any() == true)
            {
                <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">Files in Snapshot</MudText>
                <MudPaper Class="pa-3" Elevation="0" Style="background-color: var(--mud-palette-surface); max-height: 200px; overflow-y: auto;">
                    <MudList T="string" Dense="true">
                        @foreach (var file in _viewSnapshotDetail.Files)
                        {
                            <MudListItem T="string" Icon="@Icons.Material.Filled.Description">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.body2">@file.Path</MudText>
                                    @if (!string.IsNullOrEmpty(file.LanguageCode))
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Info">@file.LanguageCode</MudChip>
                                    }
                                </MudStack>
                            </MudListItem>
                        }
                    </MudList>
                </MudPaper>
            }
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseViewDialog">Close</MudButton>
    </DialogActions>
</MudDialog>

@* Restore Snapshot Dialog *@
<MudDialog @bind-Visible="_restoreDialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Warning" Class="mr-2" />
            Restore Snapshot
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (_hasUnsnapshotedChanges)
        {
            <MudAlert Severity="Severity.Error" Class="mb-4" Icon="@Icons.Material.Filled.ErrorOutline">
                <strong>Warning:</strong> There are unsaved changes since the last snapshot
                @if (_lastChangeAt.HasValue)
                {
                    <span> (last change: @_lastChangeAt.Value.ToLocalTime().ToString("g"))</span>
                }
                that may be lost if you restore without creating a backup.
            </MudAlert>
        }

        <MudAlert Severity="Severity.Warning" Class="mb-4">
            This will replace your current project state with the snapshot from <strong>@_restoreSnapshot?.CreatedAt.ToLocalTime().ToString("g")</strong>.
        </MudAlert>

        <MudCheckBox @bind-Value="_restoreCreateBackup" Label="Create backup of current state before restoring" />

        <MudTextField @bind-Value="_restoreMessage"
                      Label="Restore message (optional)"
                      Placeholder="e.g., Rolling back breaking changes"
                      Class="mt-3" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseRestoreDialog">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Warning" OnClick="RestoreSnapshotAsync" Disabled="_isRestoring">
            @if (_isRestoring)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Restore
        </MudButton>
    </DialogActions>
</MudDialog>

@* Delete Snapshot Dialog *@
<MudDialog @bind-Visible="_deleteDialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.ExtraSmall, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">Delete Snapshot?</MudText>
    </TitleContent>
    <DialogContent>
        <MudText>
            Are you sure you want to delete snapshot <strong>@_deleteSnapshot?.SnapshotId</strong>?
        </MudText>
        <MudText Color="Color.Secondary" Class="mt-2">
            This action cannot be undone.
        </MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseDeleteDialog">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="DeleteSnapshotAsync" Disabled="_isDeleting">
            @if (_isDeleting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Delete
        </MudButton>
    </DialogActions>
</MudDialog>

@* Compare Snapshots Dialog *@
<MudDialog @bind-Visible="_compareDialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Compare" Class="mr-2" />
            Compare Snapshots
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (_compareFromSnapshot != null)
        {
            <MudGrid>
                <MudItem xs="12" sm="5">
                    <MudPaper Class="pa-3" Elevation="1">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">From (Base)</MudText>
                        <MudText Typo="Typo.subtitle1" Style="font-family: monospace;">@_compareFromSnapshot.SnapshotId</MudText>
                        <MudText Typo="Typo.body2" Class="text-truncate">@(_compareFromSnapshot.Description ?? "No description")</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@_compareFromSnapshot.CreatedAt.ToLocalTime().ToString("g")</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="2" Class="d-flex align-center justify-center">
                    <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Large" Color="Color.Secondary" />
                </MudItem>
                <MudItem xs="12" sm="5">
                    <MudPaper Class="pa-3" Elevation="1">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">To (Compare)</MudText>
                        @if (_compareToSnapshot == null)
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="font-italic">Select a snapshot below</MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.subtitle1" Style="font-family: monospace;">@_compareToSnapshot.SnapshotId</MudText>
                            <MudText Typo="Typo.body2" Class="text-truncate">@(_compareToSnapshot.Description ?? "No description")</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@_compareToSnapshot.CreatedAt.ToLocalTime().ToString("g")</MudText>
                        }
                    </MudPaper>
                </MudItem>
            </MudGrid>

            <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">Select snapshot to compare with:</MudText>
            <MudPaper Class="pa-2" Elevation="0" Style="background-color: var(--mud-palette-surface); max-height: 200px; overflow-y: auto;">
                <MudList T="SnapshotDto" Dense="true" @bind-SelectedValue="_compareToSnapshot">
                    @foreach (var snapshot in _snapshots.Where(s => s.SnapshotId != _compareFromSnapshot.SnapshotId))
                    {
                        <MudListItem T="SnapshotDto" Value="@snapshot" OnClick="@(() => SelectCompareToSnapshot(snapshot))">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="width: 100%;">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudText Typo="Typo.body2" Style="font-family: monospace;">@snapshot.SnapshotId</MudText>
                                    <MudChip T="string" Size="Size.Small" Color="@GetSnapshotTypeColor(snapshot.SnapshotType)" Variant="Variant.Outlined">@snapshot.SnapshotType</MudChip>
                                </MudStack>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@snapshot.CreatedAt.ToLocalTime().ToString("g")</MudText>
                            </MudStack>
                        </MudListItem>
                    }
                </MudList>
            </MudPaper>

            @if (_compareDiff != null)
            {
                <MudDivider Class="my-4" />
                <MudText Typo="Typo.subtitle2" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.Difference" Size="Size.Small" Class="mr-1" />
                    Comparison Results
                </MudText>

                <MudGrid>
                    <MudItem xs="4">
                        <MudPaper Class="pa-3 text-center" Elevation="1" Style="border-left: 3px solid var(--mud-palette-success);">
                            <MudText Typo="Typo.h5" Color="Color.Success">@_compareDiff.KeysAdded</MudText>
                            <MudText Typo="Typo.caption">Keys Added</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="4">
                        <MudPaper Class="pa-3 text-center" Elevation="1" Style="border-left: 3px solid var(--mud-palette-error);">
                            <MudText Typo="Typo.h5" Color="Color.Error">@_compareDiff.KeysRemoved</MudText>
                            <MudText Typo="Typo.caption">Keys Removed</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="4">
                        <MudPaper Class="pa-3 text-center" Elevation="1" Style="border-left: 3px solid var(--mud-palette-warning);">
                            <MudText Typo="Typo.h5" Color="Color.Warning">@_compareDiff.KeysModified</MudText>
                            <MudText Typo="Typo.caption">Keys Modified</MudText>
                        </MudPaper>
                    </MudItem>
                </MudGrid>

                @if (_compareDiff.Files?.Any() == true)
                {
                    <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">Changed Files</MudText>
                    <MudPaper Class="pa-2" Elevation="0" Style="background-color: var(--mud-palette-surface); max-height: 150px; overflow-y: auto;">
                        <MudList T="string" Dense="true">
                            @foreach (var file in _compareDiff.Files)
                            {
                                <MudListItem T="string">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="width: 100%;">
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                            <MudIcon Icon="@GetChangeTypeIcon(file.ChangeType)" Size="Size.Small" Color="@GetChangeTypeColor(file.ChangeType)" />
                                            <MudText Typo="Typo.body2">@file.Path</MudText>
                                        </MudStack>
                                        <MudChip T="string" Size="Size.Small" Color="@GetChangeTypeColor(file.ChangeType)" Variant="Variant.Text">@file.ChangeType</MudChip>
                                    </MudStack>
                                </MudListItem>
                            }
                        </MudList>
                    </MudPaper>
                }
            }
            else if (_isComparing)
            {
                <MudStack AlignItems="AlignItems.Center" Class="mt-4">
                    <MudProgressCircular Indeterminate="true" />
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Comparing snapshots...</MudText>
                </MudStack>
            }
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseCompareDialog">Close</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Info" OnClick="CompareSnapshotsAsync" Disabled="@(_compareToSnapshot == null || _isComparing)">
            @if (_isComparing)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Compare
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter]
    public int ProjectId { get; set; }

    private ProjectDto? _project;
    private List<SnapshotDto> _snapshots = new();
    private bool _isLoading = true;

    // Create dialog
    private bool _createDialogVisible;
    private string _createDescription = "";
    private bool _isCreating;

    // View dialog
    private bool _viewDialogVisible;
    private SnapshotDto? _viewSnapshot;
    private SnapshotDetailDto? _viewSnapshotDetail;

    // Restore dialog
    private bool _restoreDialogVisible;
    private SnapshotDto? _restoreSnapshot;
    private bool _restoreCreateBackup = true;
    private string _restoreMessage = "";
    private bool _isRestoring;
    private bool _hasUnsnapshotedChanges;
    private DateTime? _lastChangeAt;

    // Delete dialog
    private bool _deleteDialogVisible;
    private SnapshotDto? _deleteSnapshot;
    private bool _isDeleting;

    // Compare dialog
    private bool _compareDialogVisible;
    private SnapshotDto? _compareFromSnapshot;
    private SnapshotDto? _compareToSnapshot;
    private SnapshotDiffDto? _compareDiff;
    private bool _isComparing;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        try
        {
            _project = await ProjectService.GetProjectAsync(ProjectId);
            if (_project != null)
            {
                _snapshots = await SnapshotService.GetSnapshotsAsync(ProjectId);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading snapshots: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    // Create dialog methods
    private void OpenCreateDialog()
    {
        _createDescription = "";
        _createDialogVisible = true;
    }

    private void CloseCreateDialog()
    {
        _createDialogVisible = false;
    }

    private async Task CreateSnapshotAsync()
    {
        _isCreating = true;
        try
        {
            var result = await SnapshotService.CreateSnapshotAsync(ProjectId, string.IsNullOrWhiteSpace(_createDescription) ? null : _createDescription);
            if (result.IsSuccess && result.Data != null)
            {
                _snapshots.Insert(0, result.Data);
                Snackbar.Add($"Snapshot {result.Data.SnapshotId} created successfully", Severity.Success);
                _createDialogVisible = false;
                StateHasChanged();
            }
            else
            {
                Snackbar.Add(result.ErrorMessage ?? "Failed to create snapshot", Severity.Error);
            }
        }
        finally
        {
            _isCreating = false;
        }
    }

    // View dialog methods
    private async Task ViewSnapshotAsync(SnapshotDto snapshot)
    {
        _viewSnapshot = snapshot;
        _viewSnapshotDetail = null;
        _viewDialogVisible = true;

        try
        {
            _viewSnapshotDetail = await SnapshotService.GetSnapshotAsync(ProjectId, snapshot.SnapshotId);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading snapshot details: {ex.Message}", Severity.Error);
        }
    }

    private void CloseViewDialog()
    {
        _viewDialogVisible = false;
        _viewSnapshot = null;
        _viewSnapshotDetail = null;
    }

    // Restore dialog methods
    private async Task OpenRestoreDialog(SnapshotDto snapshot)
    {
        _restoreSnapshot = snapshot;
        _restoreCreateBackup = true;
        _restoreMessage = "";
        _hasUnsnapshotedChanges = false;
        _lastChangeAt = null;

        // Check for unsnapshot-ed changes
        var unsnapshotedChanges = await SnapshotService.CheckUnsnapshotedChangesAsync(ProjectId);
        if (unsnapshotedChanges != null)
        {
            _hasUnsnapshotedChanges = unsnapshotedChanges.HasUnsnapshotedChanges;
            _lastChangeAt = unsnapshotedChanges.LastChangeAt;
        }

        _restoreDialogVisible = true;
    }

    private void CloseRestoreDialog()
    {
        _restoreDialogVisible = false;
        _restoreSnapshot = null;
    }

    private async Task RestoreSnapshotAsync()
    {
        if (_restoreSnapshot == null) return;

        _isRestoring = true;
        try
        {
            var result = await SnapshotService.RestoreSnapshotAsync(
                ProjectId,
                _restoreSnapshot.SnapshotId,
                _restoreCreateBackup,
                string.IsNullOrWhiteSpace(_restoreMessage) ? null : _restoreMessage);

            if (result.IsSuccess)
            {
                Snackbar.Add($"Project restored to snapshot {_restoreSnapshot.SnapshotId}", Severity.Success);
                _restoreDialogVisible = false;
                await LoadDataAsync(); // Reload to show new restore snapshot
            }
            else
            {
                Snackbar.Add(result.ErrorMessage ?? "Failed to restore snapshot", Severity.Error);
            }
        }
        finally
        {
            _isRestoring = false;
        }
    }

    // Delete dialog methods
    private void OpenDeleteDialog(SnapshotDto snapshot)
    {
        _deleteSnapshot = snapshot;
        _deleteDialogVisible = true;
    }

    private void CloseDeleteDialog()
    {
        _deleteDialogVisible = false;
        _deleteSnapshot = null;
    }

    private async Task DeleteSnapshotAsync()
    {
        if (_deleteSnapshot == null) return;

        _isDeleting = true;
        try
        {
            var result = await SnapshotService.DeleteSnapshotAsync(ProjectId, _deleteSnapshot.SnapshotId);
            if (result.IsSuccess)
            {
                _snapshots.Remove(_deleteSnapshot);
                Snackbar.Add("Snapshot deleted successfully", Severity.Success);
                _deleteDialogVisible = false;
                StateHasChanged();
            }
            else
            {
                Snackbar.Add(result.ErrorMessage ?? "Failed to delete snapshot", Severity.Error);
            }
        }
        finally
        {
            _isDeleting = false;
        }
    }

    // Compare dialog methods
    private void OpenCompareDialog(SnapshotDto snapshot)
    {
        _compareFromSnapshot = snapshot;
        _compareToSnapshot = null;
        _compareDiff = null;
        _compareDialogVisible = true;
    }

    private void CloseCompareDialog()
    {
        _compareDialogVisible = false;
        _compareFromSnapshot = null;
        _compareToSnapshot = null;
        _compareDiff = null;
    }

    private void SelectCompareToSnapshot(SnapshotDto snapshot)
    {
        _compareToSnapshot = snapshot;
        _compareDiff = null; // Reset diff when selection changes
        StateHasChanged();
    }

    private async Task CompareSnapshotsAsync()
    {
        if (_compareFromSnapshot == null || _compareToSnapshot == null) return;

        _isComparing = true;
        _compareDiff = null;
        try
        {
            _compareDiff = await SnapshotService.DiffSnapshotsAsync(
                ProjectId,
                _compareFromSnapshot.SnapshotId,
                _compareToSnapshot.SnapshotId);

            if (_compareDiff == null)
            {
                Snackbar.Add("Failed to compare snapshots", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error comparing snapshots: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isComparing = false;
            StateHasChanged();
        }
    }

    private static Color GetSnapshotTypeColor(string type) => type.ToLower() switch
    {
        "push" => Color.Primary,
        "manual" => Color.Info,
        "restore" => Color.Warning,
        "auto" => Color.Secondary,
        _ => Color.Default
    };

    private static Color GetChangeTypeColor(string changeType) => changeType.ToLower() switch
    {
        "added" => Color.Success,
        "removed" => Color.Error,
        "modified" => Color.Warning,
        _ => Color.Default
    };

    private static string GetChangeTypeIcon(string changeType) => changeType.ToLower() switch
    {
        "added" => Icons.Material.Filled.Add,
        "removed" => Icons.Material.Filled.Remove,
        "modified" => Icons.Material.Filled.Edit,
        _ => Icons.Material.Filled.QuestionMark
    };
}
