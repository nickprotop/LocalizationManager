@inherits LayoutComponentBase
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject LrmThemeService ThemeService
@inject Radzen.ThemeService RadzenThemeService
@using LrmCloud.Web.Components

<HeadContent>
    <RadzenTheme Theme="@RadzenThemeService.Theme" />
</HeadContent>

<RadzenLayout>
    <RadzenHeader>
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" Style="padding: 0 1rem; height: 100%;">
            <RadzenSidebarToggle Click="@(() => _sidebarExpanded = !_sidebarExpanded)" />
            <RadzenLink Path="" Style="text-decoration: none; color: inherit;">
                <RadzenText Text="LRM Cloud" TextStyle="TextStyle.H6" Style="margin: 0;" class="rz-display-none rz-display-sm-inline" />
                <RadzenText Text="LRM" TextStyle="TextStyle.H6" Style="margin: 0;" class="rz-display-sm-none" />
            </RadzenLink>
            <div style="flex: 1;"></div>
            <AuthorizeView>
                <Authorized Context="authContext">
                    <RadzenAppearanceToggle />
                    <RadzenProfileMenu Click="@OnProfileMenuClick">
                        <Template>
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                                <RadzenIcon Icon="account_circle" />
                                <span class="rz-display-none rz-display-md-inline">@(authContext.User.Identity?.Name ?? "User")</span>
                            </RadzenStack>
                        </Template>
                        <ChildContent>
                            <RadzenProfileMenuItem Text="Dashboard" Path="" Icon="dashboard" />
                            <RadzenProfileMenuItem Text="Profile" Path="settings/profile" Icon="person" />
                            <RadzenProfileMenuItem Text="API Keys" Path="settings/api-keys" Icon="key" />
                            <RadzenProfileMenuItem Text="Usage" Path="settings/usage" Icon="analytics" />
                            <RadzenProfileMenuItem Text="Billing" Path="settings/billing" Icon="credit_card" />
                            <RadzenStack Gap="0.25rem" Style="padding: 0.5rem 1rem; min-width: 180px;">
                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Theme</RadzenText>
                                <RadzenDropDown TValue="string"
                                                Value="@RadzenThemeService.Theme"
                                                Data="@LrmThemeService.AvailableThemes"
                                                Change="@OnThemeDropdownChanged">
                                    <Template Context="themeName">
                                        @GetThemeDisplayName(themeName)
                                    </Template>
                                </RadzenDropDown>
                            </RadzenStack>
                            <RadzenProfileMenuItem Text="Logout" Icon="logout" Value="logout" />
                        </ChildContent>
                    </RadzenProfileMenu>
                </Authorized>
                <NotAuthorized>
                    <RadzenButton Text="Login" Variant="Radzen.Variant.Text" Click="@(() => Navigation.NavigateTo("login"))" />
                </NotAuthorized>
            </AuthorizeView>
        </RadzenStack>
    </RadzenHeader>

    <RadzenSidebar @bind-Expanded="@_sidebarExpanded"
                   Style="width: 250px;"
                   Responsive="true">
        <RadzenPanelMenu>
            <RadzenPanelMenuItem Text="Dashboard" Path="" Icon="dashboard" />
            <RadzenPanelMenuItem Text="Projects" Path="projects" Icon="folder" />
            <RadzenPanelMenuItem Text="Organizations" Path="organizations" Icon="business" />
            <RadzenPanelMenuItem Text="Settings" Icon="settings">
                <RadzenPanelMenuItem Text="Profile" Path="settings/profile" Icon="person" />
                <RadzenPanelMenuItem Text="CLI API Keys" Path="settings/api-keys" Icon="key" />
                <RadzenPanelMenuItem Text="Translation Providers" Path="settings/translation" Icon="translate" />
                <RadzenPanelMenuItem Text="Translation Memory" Path="settings/translation-memory" Icon="memory" />
                <RadzenPanelMenuItem Text="Organization Glossary" Path="settings/glossary" Icon="book" />
                <RadzenPanelMenuItem Text="Usage" Path="settings/usage" Icon="analytics" />
                <RadzenPanelMenuItem Text="Billing" Path="settings/billing" Icon="credit_card" />
            </RadzenPanelMenuItem>
            <AuthorizeView>
                <Authorized>
                    @if (context.User.FindFirst("is_superadmin")?.Value == "true")
                    {
                        <RadzenPanelMenuItem Text="Admin" Icon="admin_panel_settings">
                            <RadzenPanelMenuItem Text="Dashboard" Path="admin" Icon="dashboard" />
                            <RadzenPanelMenuItem Text="Analytics" Path="admin/analytics" Icon="trending_up" />
                            <RadzenPanelMenuItem Text="Users" Path="admin/users" Icon="people" />
                            <RadzenPanelMenuItem Text="Organizations" Path="admin/organizations" Icon="business" />
                            <RadzenPanelMenuItem Text="System Health" Path="admin/health" Icon="health_and_safety" />
                            <RadzenPanelMenuItem Text="Logs" Path="admin/logs" Icon="article" />
                            <RadzenPanelMenuItem Text="Communications" Path="admin/communications" Icon="mail" />
                        </RadzenPanelMenuItem>
                    }
                </Authorized>
            </AuthorizeView>
        </RadzenPanelMenu>
        <div style="flex: 1;"></div>
        <RadzenPanelMenu Style="margin-bottom: 1rem;">
            <RadzenPanelMenuItem Text="Help & Support" Path="support" Icon="help_outline" />
        </RadzenPanelMenu>
    </RadzenSidebar>

    <RadzenBody>
        <RadzenComponents />
        <OfflineBanner />
        <UpdateAvailableBanner />
        <RadzenRow Style="padding: 1rem; max-width: 1600px; margin: 0 auto;">
            <RadzenColumn Size="12">
                <GlobalErrorBoundary>
                    @Body
                </GlobalErrorBoundary>
            </RadzenColumn>
        </RadzenRow>
    </RadzenBody>
</RadzenLayout>

@code {
    private bool _sidebarExpanded = true;

    protected override void OnInitialized()
    {
        RadzenThemeService.ThemeChanged += OnRadzenThemeChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ThemeService.InitializeAsync();
            await InvokeAsync(StateHasChanged);
        }
    }

    private void OnRadzenThemeChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task OnThemeDropdownChanged(object value)
    {
        if (value is string theme)
        {
            await ThemeService.SetThemeAsync(theme);
        }
    }

    private static string GetThemeDisplayName(string themeName)
    {
        return LrmThemeService.ThemeDisplayNames.TryGetValue(themeName, out var displayName)
            ? displayName
            : themeName;
    }

    private async Task OnProfileMenuClick(RadzenProfileMenuItem item)
    {
        if (item.Value == "logout")
        {
            await AuthService.LogoutAsync();
            Navigation.NavigateTo("login", forceLoad: true);
        }
    }

    public void Dispose()
    {
        RadzenThemeService.ThemeChanged -= OnRadzenThemeChanged;
    }
}
