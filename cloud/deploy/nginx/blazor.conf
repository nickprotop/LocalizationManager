# LRM Cloud Web - Internal nginx configuration for Blazor WASM
# This config runs INSIDE the web container (lrmcloud-web)
# External requests are proxied here by the main nginx container
#
# Note: This container only serves static files (Blazor WASM assets)
# API calls are routed to lrmcloud-api by the main nginx proxy

server {
    listen 80;
    server_name _;

    root /usr/share/nginx/html;
    index index.html;

    # Logging (mounted to host via docker-compose volume)
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Gzip compression for Blazor assets
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript
               application/xml application/xml+rss text/javascript application/wasm
               application/octet-stream;

    # Service worker - must NOT be cached (enables update detection)
    location = /service-worker.js {
        expires -1;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }

    # index.html - should not be cached (SPA entry point)
    location = /index.html {
        expires -1;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }

    # Blazor framework files (long cache, immutable hashes)
    location /_framework/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # WASM files need correct MIME type
    location ~* \.wasm$ {
        types { application/wasm wasm; }
        default_type application/wasm;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # DLL files (Blazor assemblies)
    location ~* \.dll$ {
        default_type application/octet-stream;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Static assets (images, fonts, etc.)
    location ~* \.(ico|css|js|gif|jpeg|jpg|png|woff|woff2|ttf|svg|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # SPA fallback - all routes return index.html for client-side routing
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Health check endpoint (simple file-based check)
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
