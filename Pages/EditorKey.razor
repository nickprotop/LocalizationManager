@page "/editor/key/{KeyName}"
@using LocalizationManager.Services
@using LocalizationManager.Models.Api
@using Microsoft.JSInterop
@inject ResourceApiClient ResourceApi
@inject TranslationApiClient TranslationApi
@inject ScanApiClient ScanApi
@inject ScanCacheService ScanCache
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Edit Key - Localization Manager</PageTitle>

<div class="lrm-page">
    <h1 class="lrm-page-title">
        <a href="/editor" class="lrm-back-link">← Editor</a>
        Edit Key
    </h1>

    @if (isLoading)
    {
        <div class="lrm-card">
            <p>Loading key details...</p>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="lrm-card lrm-error">
            <h3>Error</h3>
            <p>@errorMessage</p>
            <div class="lrm-actions">
                <button class="lrm-button" @onclick="@(() => Navigation.NavigateTo("/editor"))">Back to Editor</button>
            </div>
        </div>
    }
    else if (keyDetails != null)
    {
        <div class="lrm-card">
            <div class="lrm-modal-header" style="border: none; padding: 0; margin-bottom: 1rem;">
                <h2 style="margin: 0;">
                    <code>@KeyName</code>
                    @if (keyDetails.HasDuplicates)
                    {
                        <span class="lrm-badge lrm-badge-warning">◆ @keyDetails.OccurrenceCount occurrences</span>
                    }
                </h2>
                <div class="lrm-inline-actions">
                    <button class="lrm-button lrm-button-primary"
                            @onclick="OpenTranslateDialog"
                            title="Translate this key">
                        Translate
                    </button>
                </div>
            </div>

            @if (successMessage != null)
            {
                <div class="lrm-success p-sm mb-md">@successMessage</div>
            }

            @if (hasUnsavedTranslations)
            {
                <div class="lrm-warning p-sm mb-md">
                    Translations applied. Click "Save Changes" to save them.
                </div>
            }

            @if (keyDetails.HasDuplicates && keyDetails.Occurrences != null)
            {
                <div class="lrm-form-group">
                    <label class="lrm-label">Editing Occurrence</label>
                    <select class="lrm-select" @bind="selectedOccurrence" @bind:after="OnOccurrenceChanged">
                        @for (int i = 0; i < keyDetails.OccurrenceCount; i++)
                        {
                            <option value="@(i + 1)">Occurrence @(i + 1)</option>
                        }
                    </select>
                </div>
            }

            <!-- Language Values -->
            <div class="lrm-form">
                @foreach (var kvp in GetValuesForSelectedOccurrence())
                {
                    var langCode = kvp.Key;
                    var resourceValue = kvp.Value;
                    var isEmpty = string.IsNullOrWhiteSpace(resourceValue.Value) &&
                                  !(resourceValue.IsPlural && resourceValue.PluralForms?.Any() == true);
                    var isDefault = langCode == defaultLanguageCode;

                    <div class="lrm-form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <label class="lrm-label" style="margin-bottom: 0;">
                                @langCode
                                @if (isDefault)
                                {
                                    <span class="lrm-badge lrm-badge-info">Source</span>
                                }
                                @if (resourceValue.IsPlural)
                                {
                                    <span class="lrm-badge lrm-badge-success">Plural</span>
                                }
                                @if (isEmpty && !isDefault)
                                {
                                    <span class="lrm-badge lrm-badge-warning">Empty</span>
                                }
                            </label>
                        </div>

                        @if (resourceValue.IsPlural)
                        {
                            <!-- Plural Form Fields -->
                            <div class="lrm-plural-forms" style="background: var(--bg-secondary); padding: 0.5rem; border-radius: 4px;">
                                @foreach (var form in new[] { "one", "other", "zero" })
                                {
                                    var formValue = GetPluralFormValue(langCode, form);
                                    <div class="lrm-form-group" style="margin-bottom: 0.5rem;">
                                        <label class="lrm-label lrm-text-muted" style="font-size: 0.85rem;">@form</label>
                                        <input type="text"
                                               class="lrm-input"
                                               placeholder="@($"Enter {form} form (e.g., {{0}} item{(form == "other" ? "s" : "")})")"
                                               value="@formValue"
                                               @oninput="e => SetPluralFormValue(langCode, form, e.Value?.ToString() ?? string.Empty)" />
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <!-- Simple Value Field -->
                            <textarea class="lrm-textarea"
                                      rows="2"
                                      @bind="editedValues[langCode].Value"
                                      @bind:event="oninput"></textarea>
                        }

                        @if (!string.IsNullOrWhiteSpace(resourceValue.Comment) || (editingComments.ContainsKey(langCode) && editingComments[langCode]))
                        {
                            <div class="mt-sm">
                                <label class="lrm-label lrm-text-muted">Comment</label>
                                <input type="text"
                                       class="lrm-input"
                                       placeholder="Enter comment for translators"
                                       @bind="editedValues[langCode].Comment"
                                       @bind:event="oninput" />
                            </div>
                        }

                        <label class="lrm-checkbox-label mt-sm">
                            <input type="checkbox"
                                   checked="@(editingComments.ContainsKey(langCode) && editingComments[langCode] || !string.IsNullOrWhiteSpace(resourceValue.Comment))"
                                   @onchange="e => ToggleComment(langCode, (bool)e.Value!)" />
                            Show comment field
                        </label>
                    </div>
                }

                <div class="lrm-actions">
                    <button class="lrm-button lrm-button-primary"
                            @onclick="SaveChanges"
                            disabled="@isSaving">
                        @if (isSaving)
                        {
                            <text>Saving...</text>
                        }
                        else
                        {
                            <text>Save Changes</text>
                        }
                    </button>
                    <button class="lrm-button" @onclick="@(() => Navigation.NavigateTo("/editor"))">Cancel</button>
                    @if (supportsPluralFormat)
                    {
                        @if (IsCurrentKeyPlural())
                        {
                            <button class="lrm-button" @onclick="ConvertToSimple" title="Convert this plural key to a simple key">
                                Convert to Simple
                            </button>
                        }
                        else
                        {
                            <button class="lrm-button" @onclick="ConvertToPlural" title="Convert this simple key to a plural key">
                                Convert to Plural
                            </button>
                        }
                    }
                    <button class="lrm-button lrm-button-danger" @onclick="DeleteKey">Delete Key</button>
                </div>
            </div>
        </div>

        <!-- Code References Section -->
        <div class="lrm-card">
            <h3>Code References</h3>
            @if (isLoadingReferences)
            {
                <p class="lrm-text-muted">Scanning code for references...</p>
            }
            else if (codeReferences != null)
            {
                @if (codeReferences.Count == 0)
                {
                    <p class="lrm-text-muted">
                        <span class="lrm-status-icon lrm-status-unused">∅</span>
                        No references found in source code. This key may be unused.
                    </p>
                }
                else
                {
                    <p class="text-success">Found @codeReferences.Count reference(s) in source code:</p>
                    <table class="lrm-table">
                        <thead>
                            <tr>
                                <th>File</th>
                                <th>Line</th>
                                <th>Pattern</th>
                                <th>Confidence</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var reference in codeReferences)
                            {
                                <tr>
                                    <td><code title="@reference.File">@GetFileName(reference.File)</code></td>
                                    <td>@reference.Line</td>
                                    <td><code>@reference.Pattern</code></td>
                                    <td>
                                        @if (reference.Confidence == "High")
                                        {
                                            <span class="lrm-badge lrm-badge-success">@reference.Confidence</span>
                                        }
                                        else if (reference.Confidence == "Medium")
                                        {
                                            <span class="lrm-badge lrm-badge-warning">@reference.Confidence</span>
                                        }
                                        else
                                        {
                                            <span class="lrm-badge lrm-badge-info">@reference.Confidence</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                @if (ScanCache.ScanTimestamp.HasValue)
                {
                    <p class="lrm-text-muted mt-sm">
                        Last scan: @ScanCache.ScanTimestamp.Value.ToString("HH:mm:ss")
                    </p>
                }
            }
            else
            {
                <p class="lrm-text-muted">
                    No code scan cache available. Run a code scan to see where this key is used.
                </p>
            }
            <button class="lrm-button mt-sm" @onclick="RunCodeScan" disabled="@isScanning">
                @if (isScanning)
                {
                    <text>Scanning...</text>
                }
                else if (codeReferences != null)
                {
                    <text>Re-scan Code</text>
                }
                else
                {
                    <text>Scan Code</text>
                }
            </button>
        </div>
    }

    <!-- Translate Dialog -->
    @if (showTranslateDialog)
    {
        <div class="lrm-modal-overlay" @onclick="CloseTranslateDialog">
            <div class="lrm-modal" style="max-width: 600px;" @onclick:stopPropagation="true">
                <div class="lrm-modal-header">
                    <h3 class="lrm-modal-title">Translate Key</h3>
                    <button class="lrm-modal-close" @onclick="CloseTranslateDialog">x</button>
                </div>

                <!-- Translation Context -->
                <div class="mb-md">
                    <div><strong>Key:</strong> <code>@KeyName</code></div>
                    <div><strong>Source Text:</strong> @(GetSourceValue() ?? "(empty)")</div>
                </div>

                @if (translateError != null)
                {
                    <div class="lrm-error p-sm mb-md">@translateError</div>
                }

                @if (translateSuccess != null)
                {
                    <div class="lrm-success p-sm mb-md">@translateSuccess</div>
                }
                else
                {
                    <!-- Provider Selection -->
                    <div class="lrm-form-group">
                        <label class="lrm-label">Translation Provider</label>
                        <select class="lrm-select" @bind="selectedProvider">
                            @if (availableProviders != null)
                            {
                                @foreach (var provider in availableProviders)
                                {
                                    <option value="@provider.Name">@provider.DisplayName</option>
                                }
                            }
                        </select>
                    </div>

                    <!-- Target Languages -->
                    <div class="lrm-form-group">
                        <label class="lrm-label">Target Languages</label>
                        <div class="lrm-filter-group">
                            @foreach (var langCode in editedValues.Keys.Where(k => k != defaultLanguageCode))
                            {
                                var isEmpty = string.IsNullOrWhiteSpace(editedValues[langCode].Value);
                                <label class="lrm-checkbox-label">
                                    <input type="checkbox"
                                           checked="@translateTargetLanguages.Contains(langCode)"
                                           @onchange="e => ToggleTranslateLanguage(langCode, (bool)e.Value!)" />
                                    @langCode
                                    @if (isEmpty)
                                    {
                                        <span class="lrm-badge lrm-badge-warning" style="font-size: 0.7rem;">empty</span>
                                    }
                                </label>
                            }
                        </div>
                    </div>

                    <!-- Options -->
                    <div class="lrm-form-group">
                        <label class="lrm-checkbox-label">
                            <input type="checkbox" @bind="translateOnlyMissing" />
                            Only translate empty values
                        </label>
                    </div>

                    <!-- Progress -->
                    @if (isTranslating)
                    {
                        <div class="lrm-progress-bar">
                            <div class="lrm-progress-fill" style="width: 100%;"></div>
                        </div>
                        <p class="lrm-text-muted">Translating...</p>
                    }
                }

                <div class="lrm-modal-footer">
                    <button class="lrm-button" @onclick="CloseTranslateDialog">
                        @(translateSuccess != null ? "Close" : "Cancel")
                    </button>
                    @if (translateSuccess == null)
                    {
                        <button class="lrm-button lrm-button-primary"
                                @onclick="ExecuteTranslation"
                                disabled="@(isTranslating || !translateTargetLanguages.Any() || string.IsNullOrWhiteSpace(GetSourceValue()))">
                            @(isTranslating ? "Translating..." : "Translate")
                        </button>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public string KeyName { get; set; } = string.Empty;

    private ResourceKeyDetails? keyDetails;
    private Dictionary<string, ResourceValue> editedValues = new();
    private Dictionary<string, bool> editingComments = new();
    private List<CodeReference>? codeReferences;
    private List<TranslationProviderInfo>? availableProviders;
    private int selectedOccurrence = 1;
    private bool isLoading = true;
    private bool isSaving = false;
    private bool isLoadingReferences = false;
    private bool isScanning = false;
    private string? errorMessage;
    private string? successMessage;
    private string? defaultLanguageCode;
    private bool hasUnsavedTranslations = false;
    private bool supportsPluralFormat = false;  // True when using JSON backend

    // Translate dialog state
    private bool showTranslateDialog = false;
    private string selectedProvider = "google";
    private HashSet<string> translateTargetLanguages = new();
    private bool translateOnlyMissing = true;
    private bool isTranslating = false;
    private string? translateError;
    private string? translateSuccess;

    protected override async Task OnInitializedAsync()
    {
        await LoadKeyDetails();
        await LoadProviders();
        LoadReferencesFromCache();
    }

    private void LoadReferencesFromCache()
    {
        // Try to load references from cache
        if (ScanCache.TryGetReferences(KeyName, out var cached))
        {
            codeReferences = cached ?? new List<CodeReference>();
        }
        else
        {
            codeReferences = null; // Will show "Scan Code" prompt
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!isLoading)
        {
            await LoadKeyDetails();
        }
    }

    private async Task LoadProviders()
    {
        try
        {
            var providers = await TranslationApi.GetProvidersAsync();
            availableProviders = providers?.Providers;
        }
        catch { /* Ignore provider loading errors */ }
    }

    private async Task LoadKeyDetails()
    {
        isLoading = true;
        errorMessage = null;
        successMessage = null;
        hasUnsavedTranslations = false;

        try
        {
            keyDetails = await ResourceApi.GetKeyAsync(KeyName);
            if (keyDetails != null)
            {
                InitializeEditedValues();

                // Find default language and detect plural support
                var languages = await ResourceApi.GetResourceFilesAsync();
                defaultLanguageCode = languages?.FirstOrDefault(l => l.IsDefault)?.Code ?? "default";

                // Check if using JSON backend (supports plurals)
                supportsPluralFormat = languages?.Any(l =>
                    l.FilePath?.EndsWith(".json", StringComparison.OrdinalIgnoreCase) == true) ?? false;

                // Initialize translate target languages (all non-default)
                translateTargetLanguages = editedValues.Keys
                    .Where(k => k != defaultLanguageCode)
                    .ToHashSet();

                // Load references from cache
                LoadReferencesFromCache();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load key details: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void InitializeEditedValues()
    {
        if (keyDetails == null) return;

        Dictionary<string, ResourceValue> sourceValues;

        if (keyDetails.HasDuplicates && keyDetails.Occurrences != null && selectedOccurrence > 0 && selectedOccurrence <= keyDetails.Occurrences.Count)
        {
            sourceValues = keyDetails.Occurrences[selectedOccurrence - 1].Values;
        }
        else
        {
            sourceValues = keyDetails.Values;
        }

        // Create deep copy of values for editing (including plural forms)
        editedValues = sourceValues.ToDictionary(
            kvp => kvp.Key,
            kvp => new ResourceValue
            {
                Value = kvp.Value.Value,
                Comment = kvp.Value.Comment,
                IsPlural = kvp.Value.IsPlural,
                PluralForms = kvp.Value.PluralForms != null
                    ? new Dictionary<string, string>(kvp.Value.PluralForms)
                    : null
            });

        // Initialize comment editing state
        editingComments = editedValues.ToDictionary(
            kvp => kvp.Key,
            kvp => !string.IsNullOrWhiteSpace(kvp.Value.Comment));
    }

    private string GetPluralFormValue(string langCode, string form)
    {
        if (editedValues.TryGetValue(langCode, out var val) && val.PluralForms != null)
        {
            return val.PluralForms.GetValueOrDefault(form, string.Empty);
        }
        return string.Empty;
    }

    private void SetPluralFormValue(string langCode, string form, string value)
    {
        if (editedValues.TryGetValue(langCode, out var resourceValue))
        {
            resourceValue.PluralForms ??= new Dictionary<string, string>();
            if (string.IsNullOrEmpty(value))
            {
                resourceValue.PluralForms.Remove(form);
            }
            else
            {
                resourceValue.PluralForms[form] = value;
            }
            // Keep Value in sync with 'other' form
            resourceValue.Value = resourceValue.PluralForms.GetValueOrDefault("other")
                ?? resourceValue.PluralForms.Values.FirstOrDefault();
        }
    }

    private void OnOccurrenceChanged()
    {
        InitializeEditedValues();
        hasUnsavedTranslations = false;
    }

    private Dictionary<string, ResourceValue> GetValuesForSelectedOccurrence()
    {
        return editedValues;
    }

    private string? GetSourceValue()
    {
        if (defaultLanguageCode != null && editedValues.TryGetValue(defaultLanguageCode, out var val))
        {
            return val.Value;
        }
        return editedValues.Values.FirstOrDefault()?.Value;
    }

    private void ToggleComment(string languageCode, bool enabled)
    {
        editingComments[languageCode] = enabled;
        if (!enabled && editedValues.ContainsKey(languageCode))
        {
            editedValues[languageCode].Comment = null;
        }
    }

    private async Task SaveChanges()
    {
        isSaving = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            var request = new UpdateKeyRequest
            {
                // Pass full ResourceValue objects with Value, Comment, and plural forms per language
                Values = editedValues.ToDictionary(
                    kvp => kvp.Key,
                    kvp => new ResourceValue
                    {
                        Value = kvp.Value.Value ?? string.Empty,
                        Comment = kvp.Value.Comment,
                        IsPlural = kvp.Value.IsPlural,
                        PluralForms = kvp.Value.PluralForms
                    }),
                Occurrence = keyDetails?.HasDuplicates == true ? selectedOccurrence : null
            };

            var result = await ResourceApi.UpdateKeyAsync(KeyName, request);
            if (result?.Success == true)
            {
                successMessage = result.Message ?? "Key updated successfully";
                hasUnsavedTranslations = false;
                await LoadKeyDetails();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to save changes: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    // Translate Dialog Methods
    private void OpenTranslateDialog()
    {
        translateError = null;
        translateSuccess = null;
        showTranslateDialog = true;
    }

    private void CloseTranslateDialog()
    {
        showTranslateDialog = false;
        translateError = null;
        translateSuccess = null;
    }

    private void ToggleTranslateLanguage(string langCode, bool selected)
    {
        if (selected)
        {
            translateTargetLanguages.Add(langCode);
        }
        else
        {
            translateTargetLanguages.Remove(langCode);
        }
    }

    private async Task ExecuteTranslation()
    {
        isTranslating = true;
        translateError = null;

        try
        {
            // Filter target languages based on "only missing" option
            var targets = translateTargetLanguages.ToList();
            if (translateOnlyMissing)
            {
                targets = targets.Where(lang =>
                    !editedValues.ContainsKey(lang) ||
                    string.IsNullOrWhiteSpace(editedValues[lang].Value))
                    .ToList();
            }

            if (!targets.Any())
            {
                translateSuccess = "No languages need translation (all have values).";
                return;
            }

            var request = new TranslateRequest
            {
                Keys = new List<string> { KeyName },
                Provider = selectedProvider,
                TargetLanguages = targets,
                OnlyMissing = false // We already filtered
            };

            var result = await TranslationApi.TranslateAsync(request);
            if (result?.Success == true && result.Results?.Any() == true)
            {
                // Apply translations to local edited values (not saved yet!)
                int applied = 0;
                foreach (var translation in result.Results.Where(r => r.Success))
                {
                    if (editedValues.ContainsKey(translation.Language))
                    {
                        editedValues[translation.Language].Value = translation.TranslatedValue;
                        applied++;
                    }
                }

                if (applied > 0)
                {
                    translateSuccess = $"Applied {applied} translation(s). Click 'Save Changes' to save.";
                    hasUnsavedTranslations = true;
                }
                else
                {
                    translateError = "No translations were applied.";
                }
            }
            else
            {
                translateError = result?.Errors?.FirstOrDefault()?.Error ?? "Translation failed. Check provider settings.";
            }
        }
        catch (Exception ex)
        {
            translateError = $"Translation failed: {ex.Message}";
        }
        finally
        {
            isTranslating = false;
        }
    }

    private async Task RunCodeScan()
    {
        isScanning = true;
        errorMessage = null;

        try
        {
            // Run a full scan to populate the cache
            var scanResult = await ScanApi.ScanAsync();
            if (scanResult != null)
            {
                // Update the cache
                ScanCache.CacheScanResult(scanResult);

                // Now load references for this key from the new cache
                LoadReferencesFromCache();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to scan code: {ex.Message}";
        }
        finally
        {
            isScanning = false;
        }
    }

    private async Task DeleteKey()
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete the key '{KeyName}'?"))
        {
            return;
        }

        errorMessage = null;

        try
        {
            var occurrence = keyDetails?.HasDuplicates == true ? selectedOccurrence : (int?)null;
            var result = await ResourceApi.DeleteKeyAsync(KeyName, occurrence);
            if (result?.Success == true)
            {
                Navigation.NavigateTo("/editor");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to delete key: {ex.Message}";
        }
    }

    private string GetFileName(string filePath)
    {
        if (string.IsNullOrEmpty(filePath)) return filePath;

        var lastSlash = filePath.LastIndexOfAny(new[] { '/', '\\' });
        return lastSlash >= 0 ? filePath.Substring(lastSlash + 1) : filePath;
    }

    /// <summary>
    /// Checks if the current key (in any language) is a plural key
    /// </summary>
    private bool IsCurrentKeyPlural()
    {
        return editedValues.Values.Any(v => v.IsPlural);
    }

    /// <summary>
    /// Convert a simple key to a plural key - copies current value to "other" form
    /// </summary>
    private void ConvertToPlural()
    {
        foreach (var langCode in editedValues.Keys.ToList())
        {
            var resourceValue = editedValues[langCode];
            if (!resourceValue.IsPlural)
            {
                var currentValue = resourceValue.Value ?? string.Empty;
                resourceValue.IsPlural = true;
                resourceValue.PluralForms = new Dictionary<string, string>
                {
                    ["other"] = currentValue  // Copy current value to "other" form
                };
                // Value is kept in sync with "other" form
            }
        }

        successMessage = "Converted to plural key. Add plural form values and click 'Save Changes' to save.";
        hasUnsavedTranslations = true;
        StateHasChanged();
    }

    /// <summary>
    /// Convert a plural key to a simple key - copies "other" form (or first available) to value
    /// </summary>
    private void ConvertToSimple()
    {
        foreach (var langCode in editedValues.Keys.ToList())
        {
            var resourceValue = editedValues[langCode];
            if (resourceValue.IsPlural)
            {
                // Get the "other" form value, or the first available plural form
                var simpleValue = resourceValue.PluralForms?.GetValueOrDefault("other")
                    ?? resourceValue.PluralForms?.Values.FirstOrDefault()
                    ?? resourceValue.Value
                    ?? string.Empty;

                resourceValue.IsPlural = false;
                resourceValue.Value = simpleValue;
                resourceValue.PluralForms = null;
            }
        }

        successMessage = "Converted to simple key. Click 'Save Changes' to save.";
        hasUnsavedTranslations = true;
        StateHasChanged();
    }
}
