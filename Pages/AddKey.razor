@page "/editor/add"
@using LocalizationManager.Services
@using LocalizationManager.Models.Api
@inject ResourceApiClient ResourceApi
@inject NavigationManager Navigation

<PageTitle>Add Key - Localization Manager</PageTitle>

<div class="lrm-page">
    <h1 class="lrm-page-title">
        <a href="/editor" class="lrm-back-link">‚Üê Editor</a>
        Add New Key
    </h1>

    @if (errorMessage != null)
    {
        <div class="lrm-card lrm-error">
            <h3>Error</h3>
            <p>@errorMessage</p>
        </div>
    }

    @if (successMessage != null)
    {
        <div class="lrm-card lrm-success">
            <p>@successMessage</p>
            <div class="lrm-actions">
                <a href="/editor/key/@Uri.EscapeDataString(newKeyName)" class="lrm-button lrm-button-primary">Edit Key</a>
                <button class="lrm-button" @onclick="ResetForm">Add Another</button>
                <a href="/editor" class="lrm-button">Back to Editor</a>
            </div>
        </div>
    }
    else
    {
        <div class="lrm-card">
            <div class="lrm-form">
                <div class="lrm-form-group">
                    <label class="lrm-label">Key Name *</label>
                    <input type="text"
                           class="lrm-input"
                           placeholder="Enter key name (e.g., Button_Save, ErrorMessage_Required)"
                           @bind="newKeyName"
                           @bind:event="oninput" />
                    <small class="lrm-text-muted">The key name must be unique across all resource files.</small>
                </div>

                @if (languages != null)
                {
                    <h3>Values by Language</h3>
                    @foreach (var lang in languages)
                    {
                        var langCode = lang.Code ?? "default";
                        <div class="lrm-form-group">
                            <label class="lrm-label">
                                @langCode
                                @if (lang.IsDefault)
                                {
                                    <span class="lrm-badge lrm-badge-info">Default</span>
                                }
                            </label>
                            <input type="text"
                                   class="lrm-input"
                                   placeholder="Enter value for @langCode"
                                   @bind="values[langCode]"
                                   @bind:event="oninput" />
                        </div>
                    }
                }

                <div class="lrm-form-group">
                    <label class="lrm-label">Comment (Optional)</label>
                    <input type="text"
                           class="lrm-input"
                           placeholder="Add a comment to help translators"
                           @bind="comment" />
                </div>

                <div class="lrm-actions">
                    <button class="lrm-button lrm-button-primary"
                            @onclick="AddNewKey"
                            disabled="@(isAdding || string.IsNullOrWhiteSpace(newKeyName))">
                        @if (isAdding)
                        {
                            <text>Adding...</text>
                        }
                        else
                        {
                            <text>Add Key</text>
                        }
                    </button>
                    <a href="/editor" class="lrm-button">Cancel</a>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<ResourceFileInfo>? languages;
    private Dictionary<string, string> values = new();
    private string newKeyName = "";
    private string comment = "";
    private bool isAdding = false;
    private string? errorMessage;
    private string? successMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            languages = await ResourceApi.GetResourceFilesAsync();
            if (languages != null)
            {
                foreach (var lang in languages)
                {
                    values[lang.Code ?? "default"] = "";
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load languages: {ex.Message}";
        }
    }

    private async Task AddNewKey()
    {
        if (string.IsNullOrWhiteSpace(newKeyName))
        {
            errorMessage = "Key name is required.";
            return;
        }

        isAdding = true;
        errorMessage = null;

        try
        {
            var request = new AddKeyRequest
            {
                Key = newKeyName.Trim(),
                Values = values.Where(kvp => !string.IsNullOrEmpty(kvp.Value))
                               .ToDictionary(kvp => kvp.Key, kvp => kvp.Value),
                Comment = string.IsNullOrWhiteSpace(comment) ? null : comment.Trim()
            };

            var result = await ResourceApi.AddKeyAsync(request);
            if (result?.Success == true)
            {
                successMessage = result.Message ?? $"Key '{newKeyName}' added successfully!";
            }
            else
            {
                errorMessage = "Failed to add key. Please try again.";
            }
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Failed to add key: {ex.Message}";
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isAdding = false;
        }
    }

    private void ResetForm()
    {
        newKeyName = "";
        comment = "";
        successMessage = null;
        errorMessage = null;

        if (languages != null)
        {
            foreach (var lang in languages)
            {
                values[lang.Code ?? "default"] = "";
            }
        }
    }
}
