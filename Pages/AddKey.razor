@page "/editor/add"
@using LocalizationManager.Services
@using LocalizationManager.Models.Api
@inject ResourceApiClient ResourceApi
@inject NavigationManager Navigation

<PageTitle>Add Key - Localization Manager</PageTitle>

<div class="lrm-page">
    <h1 class="lrm-page-title">
        <a href="/editor" class="lrm-back-link">‚Üê Editor</a>
        Add New Key
    </h1>

    @if (errorMessage != null)
    {
        <div class="lrm-card lrm-error">
            <h3>Error</h3>
            <p>@errorMessage</p>
        </div>
    }

    @if (successMessage != null)
    {
        <div class="lrm-card lrm-success">
            <p>@successMessage</p>
            <div class="lrm-actions">
                <a href="/editor/key/@Uri.EscapeDataString(newKeyName)" class="lrm-button lrm-button-primary">Edit Key</a>
                <button class="lrm-button" @onclick="ResetForm">Add Another</button>
                <a href="/editor" class="lrm-button">Back to Editor</a>
            </div>
        </div>
    }
    else
    {
        <div class="lrm-card">
            <div class="lrm-form">
                <div class="lrm-form-group">
                    <label class="lrm-label">Key Name *</label>
                    <input type="text"
                           class="lrm-input"
                           placeholder="Enter key name (e.g., Button_Save, ErrorMessage_Required)"
                           @bind="newKeyName"
                           @bind:event="oninput" />
                    <small class="lrm-text-muted">The key name must be unique across all resource files.</small>
                </div>

                @if (supportsPlurals)
                {
                    <div class="lrm-form-group">
                        <label class="lrm-checkbox-label">
                            <input type="checkbox" @bind="isPlural" />
                            <span>This is a plural key</span>
                        </label>
                        <small class="lrm-text-muted">Plural keys have different values for different quantities (one, other, zero, etc.)</small>
                    </div>
                }

                @if (languages != null)
                {
                    <h3>Values by Language</h3>
                    @foreach (var lang in languages)
                    {
                        var langCode = lang.Code ?? "default";
                        var currentLangCode = langCode; // Capture for closure
                        <div class="lrm-form-group" @key="langCode">
                            <label class="lrm-label">
                                @langCode
                                @if (lang.IsDefault)
                                {
                                    <span class="lrm-badge lrm-badge-info">Default</span>
                                }
                            </label>
                            @if (isPlural)
                            {
                                <div class="lrm-plural-forms">
                                    @foreach (var form in pluralFormNames)
                                    {
                                        var currentForm = form; // Capture for closure
                                        var formKey = $"{currentLangCode}:{currentForm}";
                                        <div class="lrm-plural-form-row" @key="formKey">
                                            <label class="lrm-plural-label">@form</label>
                                            <input type="text"
                                                   class="lrm-input lrm-input-plural"
                                                   placeholder="@GetPluralPlaceholder(form)"
                                                   value="@GetPluralValue(currentLangCode, currentForm)"
                                                   @oninput="e => SetPluralValue(currentLangCode, currentForm, e.Value?.ToString() ?? string.Empty)" />
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <input type="text"
                                       class="lrm-input"
                                       placeholder="Enter value for @langCode"
                                       value="@GetSimpleValue(currentLangCode)"
                                       @oninput="e => SetSimpleValue(currentLangCode, e.Value?.ToString() ?? string.Empty)" />
                            }
                        </div>
                    }
                }

                <div class="lrm-form-group">
                    <label class="lrm-label">Comment (Optional)</label>
                    <input type="text"
                           class="lrm-input"
                           placeholder="Add a comment to help translators"
                           @bind="comment" />
                </div>

                <div class="lrm-actions">
                    <button class="lrm-button lrm-button-primary"
                            @onclick="AddNewKey"
                            disabled="@(isAdding || string.IsNullOrWhiteSpace(newKeyName))">
                        @if (isAdding)
                        {
                            <text>Adding...</text>
                        }
                        else
                        {
                            <text>Add Key</text>
                        }
                    </button>
                    <a href="/editor" class="lrm-button">Cancel</a>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<ResourceFileInfo>? languages;
    private Dictionary<string, string> values = new();
    private Dictionary<string, string> pluralValues = new();
    private string newKeyName = "";
    private string comment = "";
    private bool isAdding = false;
    private bool isPlural = false;
    private bool supportsPlurals = false;
    private string? errorMessage;
    private string? successMessage;

    private static readonly string[] pluralFormNames = { "one", "other", "zero", "few", "many" };

    private string GetSimpleValue(string langCode) => values.GetValueOrDefault(langCode, "");
    private void SetSimpleValue(string langCode, string value) => values[langCode] = value;

    private string GetPluralValue(string langCode, string form) => pluralValues.GetValueOrDefault($"{langCode}:{form}", "");
    private void SetPluralValue(string langCode, string form, string value) => pluralValues[$"{langCode}:{form}"] = value;

    private static string GetPluralPlaceholder(string form) => form switch
    {
        "other" => "Required - e.g. '{0} items'",
        "one" => "Optional - e.g. '1 item'",
        "zero" => "Optional - e.g. 'No items'",
        _ => $"Optional - e.g. '{form} form'"
    };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            languages = await ResourceApi.GetResourceFilesAsync();
            if (languages != null)
            {
                // Check if using JSON backend (supports plurals)
                supportsPlurals = languages.Any(l => l.FilePath?.EndsWith(".json", StringComparison.OrdinalIgnoreCase) == true);

                foreach (var lang in languages)
                {
                    var langCode = lang.Code ?? "default";
                    values[langCode] = "";
                    // Initialize plural form values
                    foreach (var form in pluralFormNames)
                    {
                        pluralValues[$"{langCode}:{form}"] = "";
                    }
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load languages: {ex.Message}";
        }
    }

    private async Task AddNewKey()
    {
        if (string.IsNullOrWhiteSpace(newKeyName))
        {
            errorMessage = "Key name is required.";
            return;
        }

        isAdding = true;
        errorMessage = null;

        try
        {
            var request = new AddKeyRequest
            {
                Key = newKeyName.Trim(),
                Comment = string.IsNullOrWhiteSpace(comment) ? null : comment.Trim(),
                IsPlural = isPlural
            };

            if (isPlural)
            {
                // Build plural values dictionary: { "default": { "one": "...", "other": "..." }, ... }
                var pluralValuesPerLang = new Dictionary<string, Dictionary<string, string>>();
                if (languages != null)
                {
                    foreach (var lang in languages)
                    {
                        var langCode = lang.Code ?? "default";
                        var langPluralForms = new Dictionary<string, string>();
                        foreach (var form in pluralFormNames)
                        {
                            var formKey = $"{langCode}:{form}";
                            if (pluralValues.TryGetValue(formKey, out var value) && !string.IsNullOrEmpty(value))
                            {
                                langPluralForms[form] = value;
                            }
                        }
                        if (langPluralForms.Count > 0)
                        {
                            pluralValuesPerLang[langCode] = langPluralForms;
                        }
                    }
                }
                request.PluralValues = pluralValuesPerLang;
            }
            else
            {
                request.Values = values.Where(kvp => !string.IsNullOrEmpty(kvp.Value))
                                       .ToDictionary(kvp => kvp.Key, kvp => kvp.Value);
            }

            var result = await ResourceApi.AddKeyAsync(request);
            if (result?.Success == true)
            {
                successMessage = result.Message ?? $"Key '{newKeyName}' added successfully!";
            }
            else
            {
                errorMessage = "Failed to add key. Please try again.";
            }
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Failed to add key: {ex.Message}";
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isAdding = false;
        }
    }

    private void ResetForm()
    {
        newKeyName = "";
        comment = "";
        isPlural = false;
        successMessage = null;
        errorMessage = null;

        if (languages != null)
        {
            foreach (var lang in languages)
            {
                var langCode = lang.Code ?? "default";
                values[langCode] = "";
                foreach (var form in pluralFormNames)
                {
                    pluralValues[$"{langCode}:{form}"] = "";
                }
            }
        }
    }
}
