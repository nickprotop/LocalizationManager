@page "/export"
@using LocalizationManager.Services
@using Microsoft.JSInterop
@inject ExportApiClient ExportApi
@inject IJSRuntime JSRuntime

<PageTitle>Export - Localization Manager</PageTitle>

<div class="lrm-page">
    <h1 class="lrm-page-title">Export Resources</h1>

    <div class="lrm-card">
        <h2>Export to JSON</h2>
        <p>Export all resources to JSON format for backup or integration purposes.</p>

        <div class="lrm-form">
            <div class="lrm-form-group">
                <label class="lrm-checkbox-label">
                    <input type="checkbox" @bind="includeCommentsJson" />
                    Include comments in export
                </label>
            </div>

            <div class="lrm-actions">
                <button class="lrm-button lrm-button-primary"
                        @onclick="ExportToJson"
                        disabled="@isExportingJson">
                    @if (isExportingJson)
                    {
                        <text>Exporting...</text>
                    }
                    else
                    {
                        <text>Export to JSON</text>
                    }
                </button>
            </div>
        </div>
    </div>

    <div class="lrm-card">
        <h2>Export to CSV</h2>
        <p>Export all resources to CSV format for editing in spreadsheet applications.</p>

        <div class="lrm-form">
            <div class="lrm-form-group">
                <label class="lrm-checkbox-label">
                    <input type="checkbox" @bind="includeCommentsCsv" />
                    Include comments in export
                </label>
            </div>

            <div class="lrm-actions">
                <button class="lrm-button lrm-button-primary"
                        @onclick="ExportToCsv"
                        disabled="@isExportingCsv">
                    @if (isExportingCsv)
                    {
                        <text>Exporting...</text>
                    }
                    else
                    {
                        <text>Export to CSV</text>
                    }
                </button>
            </div>
        </div>
    </div>

    @if (errorMessage != null)
    {
        <div class="lrm-card lrm-error">
            <h3>Error</h3>
            <p>@errorMessage</p>
        </div>
    }

    @if (successMessage != null)
    {
        <div class="lrm-card lrm-success">
            <p>@successMessage</p>
        </div>
    }

    @if (!string.IsNullOrEmpty(exportedData))
    {
        <div class="lrm-card">
            <h3>Exported Data</h3>
            <details class="lrm-details">
                <summary>View exported content</summary>
                <pre class="lrm-code">@exportedData</pre>
            </details>
            <div class="lrm-actions">
                <button class="lrm-button" @onclick="CopyToClipboard">Copy to Clipboard</button>
                <button class="lrm-button" @onclick="DownloadFile">Download File</button>
            </div>
        </div>
    }
</div>

@code {
    private bool includeCommentsJson = false;
    private bool includeCommentsCsv = false;
    private bool isExportingJson = false;
    private bool isExportingCsv = false;
    private string? errorMessage;
    private string? successMessage;
    private string? exportedData;
    private string exportedFormat = string.Empty;

    private async Task ExportToJson()
    {
        isExportingJson = true;
        errorMessage = null;
        successMessage = null;
        exportedData = null;

        try
        {
            exportedData = await ExportApi.ExportToJsonAsync(includeCommentsJson);
            exportedFormat = "json";
            successMessage = "Resources exported to JSON successfully";
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to export to JSON: {ex.Message}";
        }
        finally
        {
            isExportingJson = false;
        }
    }

    private async Task ExportToCsv()
    {
        isExportingCsv = true;
        errorMessage = null;
        successMessage = null;
        exportedData = null;

        try
        {
            exportedData = await ExportApi.ExportToCsvAsync(includeCommentsCsv);
            exportedFormat = "csv";
            successMessage = "Resources exported to CSV successfully";
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to export to CSV: {ex.Message}";
        }
        finally
        {
            isExportingCsv = false;
        }
    }

    private async Task CopyToClipboard()
    {
        if (string.IsNullOrEmpty(exportedData)) return;

        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", exportedData);
            successMessage = "Copied to clipboard!";
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to copy to clipboard: {ex.Message}";
        }
    }

    private async Task DownloadFile()
    {
        if (string.IsNullOrEmpty(exportedData)) return;

        try
        {
            var fileName = $"resources-{DateTime.Now:yyyyMMdd-HHmmss}.{exportedFormat}";
            var bytes = System.Text.Encoding.UTF8.GetBytes(exportedData);
            var base64 = Convert.ToBase64String(bytes);
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, base64);
            successMessage = $"Downloaded as {fileName}";
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to download file: {ex.Message}";
        }
    }
}
