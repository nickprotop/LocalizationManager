@page "/editor/merge-duplicates"
@using LocalizationManager.Services
@using LocalizationManager.Models.Api
@inject MergeDuplicatesApiClient MergeApi
@inject ResourceApiClient ResourceApi
@inject NavigationManager Navigation

<PageTitle>Merge Duplicates - Localization Manager</PageTitle>

<div class="lrm-page">
    <h1 class="lrm-page-title">
        <a href="/editor" class="lrm-back-link">← Editor</a>
        Merge Duplicate Keys
    </h1>

    @if (errorMessage != null)
    {
        <div class="lrm-card lrm-error">
            <h3>Error</h3>
            <p>@errorMessage</p>
        </div>
    }

    @if (successMessage != null)
    {
        <div class="lrm-card lrm-success">
            <p>@successMessage</p>
            <div class="lrm-actions">
                <button class="lrm-button lrm-button-primary" @onclick="LoadDuplicates">Refresh</button>
                <a href="/editor" class="lrm-button">Back to Editor</a>
            </div>
        </div>
    }

    @if (isLoading)
    {
        <div class="lrm-card">
            <p>Loading duplicates...</p>
        </div>
    }
    else if (duplicates == null || duplicates.Count == 0)
    {
        <div class="lrm-card lrm-success">
            <h3>No Duplicates Found</h3>
            <p>All keys in your resource files are unique. Great job!</p>
            <div class="lrm-actions">
                <a href="/editor" class="lrm-button">Back to Editor</a>
            </div>
        </div>
    }
    else
    {
        <div class="lrm-card">
            <div class="lrm-editor-toolbar">
                <div>
                    <strong>@duplicates.Count</strong> duplicate key(s) found
                </div>
                <div class="lrm-actions" style="margin: 0;">
                    <button class="lrm-button lrm-button-danger"
                            @onclick="MergeAllDuplicates"
                            disabled="@isMerging">
                        @if (isMerging)
                        {
                            <text>Merging...</text>
                        }
                        else
                        {
                            <text>Merge All (Keep First)</text>
                        }
                    </button>
                </div>
            </div>
        </div>

        @foreach (var dup in duplicates)
        {
            <div class="lrm-card">
                <div class="lrm-modal-header" style="border: none; padding: 0; margin-bottom: 1rem;">
                    <h3 class="lrm-modal-title" style="margin: 0;">
                        <span class="lrm-status-icon lrm-status-duplicate">◆</span>
                        @dup.Key
                    </h3>
                    <div class="lrm-inline-actions">
                        <span class="lrm-badge lrm-badge-warning">@dup.OccurrenceCount occurrences</span>
                        <button class="lrm-button-small lrm-button-primary"
                                @onclick="() => MergeSingleKey(dup.Key)"
                                disabled="@isMerging">
                            Merge (Keep First)
                        </button>
                    </div>
                </div>

                @if (expandedKeys.Contains(dup.Key))
                {
                    <div class="mb-md">
                        <button class="lrm-button-small" @onclick="() => ToggleExpand(dup.Key)">
                            Hide Details
                        </button>
                    </div>

                    @foreach (var langValues in dup.ValuesByLanguage)
                    {
                        <div class="mb-md">
                            <strong>@langValues.Key:</strong>
                            @if (langValues.Value.Count > 1)
                            {
                                <div class="mt-sm">
                                    @for (int i = 0; i < langValues.Value.Count; i++)
                                    {
                                        var index = i + 1;
                                        var value = langValues.Value[i];
                                        var isFirst = i == 0;
                                        <div class="lrm-merge-option @(isFirst ? "selected" : "")">
                                            <div class="lrm-merge-meta">
                                                Occurrence @index
                                                @if (isFirst)
                                                {
                                                    <span class="lrm-badge lrm-badge-success">Will Keep</span>
                                                }
                                                else
                                                {
                                                    <span class="lrm-badge lrm-badge-error">Will Remove</span>
                                                }
                                            </div>
                                            <div class="lrm-merge-value">
                                                @if (string.IsNullOrEmpty(value))
                                                {
                                                    <span class="lrm-cell-empty">(empty)</span>
                                                }
                                                else
                                                {
                                                    @value
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <span class="lrm-text-muted"> @(langValues.Value.FirstOrDefault() ?? "(empty)")</span>
                            }
                        </div>
                    }
                }
                else
                {
                    <div>
                        <button class="lrm-button-small" @onclick="() => ToggleExpand(dup.Key)">
                            Show Details
                        </button>
                        <span class="lrm-text-muted ml-md">
                            Languages: @string.Join(", ", dup.ValuesByLanguage.Keys)
                        </span>
                    </div>
                }
            </div>
        }
    }
</div>

@code {
    private List<DuplicateKeyInfo>? duplicates;
    private HashSet<string> expandedKeys = new();
    private bool isLoading = true;
    private bool isMerging = false;
    private string? errorMessage;
    private string? successMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadDuplicates();
    }

    private async Task LoadDuplicates()
    {
        isLoading = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            var response = await MergeApi.ListDuplicatesAsync();
            duplicates = response?.DuplicateKeys ?? new List<DuplicateKeyInfo>();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load duplicates: {ex.Message}";
            duplicates = new List<DuplicateKeyInfo>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ToggleExpand(string key)
    {
        if (expandedKeys.Contains(key))
        {
            expandedKeys.Remove(key);
        }
        else
        {
            expandedKeys.Add(key);
        }
    }

    private async Task MergeSingleKey(string key)
    {
        isMerging = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            var result = await MergeApi.MergeKeyAsync(key);
            if (result?.Success == true)
            {
                successMessage = result.Message ?? $"Successfully merged '{key}'";
                await LoadDuplicates();
            }
            else
            {
                errorMessage = "Merge operation failed.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to merge key: {ex.Message}";
        }
        finally
        {
            isMerging = false;
        }
    }

    private async Task MergeAllDuplicates()
    {
        if (duplicates == null || duplicates.Count == 0) return;

        isMerging = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            var result = await MergeApi.MergeAllAsync();
            if (result?.Success == true)
            {
                successMessage = result.Message ?? $"Successfully merged {result.MergedCount} duplicate key(s)";
                await LoadDuplicates();
            }
            else
            {
                errorMessage = "Merge operation failed.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to merge duplicates: {ex.Message}";
        }
        finally
        {
            isMerging = false;
        }
    }
}
